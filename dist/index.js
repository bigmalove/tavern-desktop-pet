import{createPinia as e,defineStore as t,storeToRefs as o}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var r={0:(e,t,o)=>{var n=o(407);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('078f2c0f',n,!1,{ssrId:!0})},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var o='',n=void 0!==t[5];return t[4]&&(o+='@supports ('.concat(t[4],') {')),t[2]&&(o+='@media '.concat(t[2],' {')),n&&(o+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),o+=e(t),n&&(o+='}'),t[2]&&(o+='}'),t[4]&&(o+='}'),o}).join('')},t.i=function(e,o,n,r,a){'string'==typeof e&&(e=[[null,e,void 0]]);var i={};if(n)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(i[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&i[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=a),o&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=o):d[2]=o),r&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=r):d[4]=''.concat(r)),t.push(d))}},t}},89:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.node-row[data-v-3a6a95ba]{display:flex;align-items:center;padding:5px 8px;cursor:pointer;border-bottom:1px solid hsla(0,0%,100%,.08);font-size:12px;gap:4px;-webkit-user-select:none;user-select:none;transition:background .14s}.node-row[data-v-3a6a95ba]:hover{background:rgba(255,225,0,.12)}.node-row.is-model .node-name[data-v-3a6a95ba]{color:#00dac2;font-weight:600}.node-row.is-selected[data-v-3a6a95ba]{background:rgba(255,225,0,.2)}.expand-icon[data-v-3a6a95ba]{width:14px;font-size:8px;color:#8d8d8d;transition:transform .2s;flex-shrink:0;text-align:center}.expand-icon.expanded[data-v-3a6a95ba]{transform:rotate(90deg)}.expand-icon.placeholder[data-v-3a6a95ba]{visibility:hidden}.node-icon[data-v-3a6a95ba]{font-size:13px;flex-shrink:0;line-height:1}.node-name[data-v-3a6a95ba]{color:#f1f1f1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.node-spinner[data-v-3a6a95ba]{display:inline-block;width:10px;height:10px;border:1.5px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin-3a6a95ba .8s linear infinite;flex-shrink:0;margin-left:4px}@keyframes spin-3a6a95ba{to{transform:rotate(360deg)}}.empty-hint[data-v-3a6a95ba]{font-size:11px;color:#8d8d8d;padding:4px 8px}.child-error[data-v-3a6a95ba]{font-size:11px;color:#ffb5af;padding:4px 8px}.child-error .retry-link[data-v-3a6a95ba]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.child-error .retry-link[data-v-3a6a95ba]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.child-error .retry-link[data-v-3a6a95ba]:disabled{opacity:.45;cursor:not-allowed}.child-error .retry-link[data-v-3a6a95ba]{height:22px;min-width:56px;padding:0 8px;margin-left:6px;font-size:10px;border-color:rgba(0,218,194,.55);color:#c5fff9;cursor:pointer}.child-error .retry-link[data-v-3a6a95ba]:hover{background:#00dac2;border-color:#00dac2;color:#000}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/TreeNode.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,2BAAU,YAAa,CAAA,kBAAmB,CAAA,eAAgB,CAAA,cAAe,CAAA,2CAA4C,CAAA,cAAe,CAAA,OAAQ,CAAA,wBAAiB,CAAjB,gBAAiB,CAAA,0BAA2B,CAAA,iCAAgB,8BAA+B,CAAA,+CAA8B,aAAc,CAAA,eAAgB,CAAA,uCAAsB,6BAA8B,CAAA,8BAAa,UAAW,CAAA,aAAc,CAAA,aAAc,CAAA,wBAAyB,CAAA,aAAc,CAAA,iBAAkB,CAAA,uCAAsB,uBAAwB,CAAA,0CAAyB,iBAAkB,CAAA,4BAAW,cAAe,CAAA,aAAc,CAAA,aAAc,CAAA,4BAAW,aAAc,CAAA,eAAgB,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,MAAO,CAAA,+BAAc,oBAAqB,CAAA,UAAW,CAAA,WAAY,CAAA,0BAA2B,CAAA,wBAAyB,CAAA,iBAAkB,CAAA,2CAAmC,CAAA,aAAc,CAAA,eAAgB,CAAA,yBAAgB,GAAG,wBAAyB,CAAC,CAAA,6BAAY,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,8BAAa,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,0CAAyB,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,+DAA8C,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,mDAAkC,WAAY,CAAA,kBAAmB,CAAA,0CAAyB,WAAY,CAAA,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,cAAe,CAAA,gCAAiC,CAAA,aAAc,CAAA,cAAe,CAAA,gDAA+B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.node-row{display:flex;align-items:center;padding:5px 8px;cursor:pointer;border-bottom:1px solid hsla(0,0%,100%,.08);font-size:12px;gap:4px;user-select:none;transition:background .14s}.node-row:hover{background:rgba(255,225,0,.12)}.node-row.is-model .node-name{color:#00dac2;font-weight:600}.node-row.is-selected{background:rgba(255,225,0,.2)}.expand-icon{width:14px;font-size:8px;color:#8d8d8d;transition:transform .2s;flex-shrink:0;text-align:center}.expand-icon.expanded{transform:rotate(90deg)}.expand-icon.placeholder{visibility:hidden}.node-icon{font-size:13px;flex-shrink:0;line-height:1}.node-name{color:#f1f1f1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.node-spinner{display:inline-block;width:10px;height:10px;border:1.5px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;margin-left:4px}@keyframes spin{to{transform:rotate(360deg)}}.empty-hint{font-size:11px;color:#8d8d8d;padding:4px 8px}.child-error{font-size:11px;color:#ffb5af;padding:4px 8px}.child-error .retry-link{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.child-error .retry-link:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.child-error .retry-link:disabled{opacity:.45;cursor:not-allowed}.child-error .retry-link{height:22px;min-width:56px;padding:0 8px;margin-left:6px;font-size:10px;border-color:rgba(0,218,194,.55);color:#c5fff9;cursor:pointer}.child-error .retry-link:hover{background:#00dac2;border-color:#00dac2;color:#000}'],sourceRoot:''}]);const s=i},235:(e,t)=>{t.A=(e,t)=>{const o=e.__vccOpts||e;for(const[e,n]of t)o[e]=n;return o}},292:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.model-browser[data-v-7ee23a0a]{display:flex;flex-direction:column;height:100%;max-height:60vh;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.browser-header[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:space-between;padding:8px 0 10px;margin-bottom:10px;border-bottom:1px solid rgba(255,225,0,.35)}.browser-header .browser-title[data-v-7ee23a0a]{font-size:14px;font-family:"Oswald","Teko","Segoe UI",sans-serif;letter-spacing:.08em;color:#ffe100}.browser-header .browser-hint[data-v-7ee23a0a]{font-size:10px;color:#8d8d8d;letter-spacing:.08em}.search-box[data-v-7ee23a0a]{margin-bottom:10px}.search-box input[data-v-7ee23a0a]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.search-box input[data-v-7ee23a0a]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.search-box input[data-v-7ee23a0a]::placeholder{color:#8d8d8d}.search-box input[data-v-7ee23a0a]{color:#fff}.error-bar[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.4);margin-bottom:10px;font-size:12px;color:#ffc9c5}.error-bar .retry-btn[data-v-7ee23a0a]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.error-bar .retry-btn[data-v-7ee23a0a]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.error-bar .retry-btn[data-v-7ee23a0a]:disabled{opacity:.45;cursor:not-allowed}.error-bar .retry-btn[data-v-7ee23a0a]{min-width:72px;height:26px;padding:0 8px;font-size:11px;border-color:rgba(255,59,48,.6);color:#ffc9c5}.error-bar .retry-btn[data-v-7ee23a0a]:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.tree-container[data-v-7ee23a0a]{flex:1;overflow-y:auto;min-height:150px;padding:4px 0 6px;border:1px solid hsla(0,0%,100%,.12);background:rgba(0,0,0,.3)}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar{width:7px;height:7px}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-thumb{background:#555}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.tree-container[data-v-7ee23a0a]:empty{border-style:dashed}.loading-state[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:center;padding:24px;color:#8d8d8d;font-size:13px;gap:8px}.spinner[data-v-7ee23a0a]{display:inline-block;width:14px;height:14px;border:2px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin-7ee23a0a .8s linear infinite}@keyframes spin-7ee23a0a{to{transform:rotate(360deg)}}.empty-state[data-v-7ee23a0a]{text-align:center;padding:24px;color:#8d8d8d;font-size:13px}.browser-footer[data-v-7ee23a0a]{border-top:1px solid hsla(0,0%,100%,.16);padding-top:12px;margin-top:10px}.browser-footer .selected-info[data-v-7ee23a0a]{font-size:12px;color:#d5d5d5;margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.browser-footer .selected-info .selected-path[data-v-7ee23a0a]{color:#ffe100;font-weight:600}.browser-footer .selected-info .no-selection[data-v-7ee23a0a]{color:#8d8d8d}.browser-footer .footer-actions[data-v-7ee23a0a]{display:flex;justify-content:flex-end;gap:8px}.btn[data-v-7ee23a0a]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn[data-v-7ee23a0a]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn[data-v-7ee23a0a]:disabled{opacity:.45;cursor:not-allowed}.btn[data-v-7ee23a0a]{min-width:90px;height:32px;padding:0 14px;font-size:12px}.btn[data-v-7ee23a0a]:disabled{opacity:.4;cursor:not-allowed}.btn.btn-primary[data-v-7ee23a0a]{background:#ffe100;color:#000;border-color:#ffe100}.btn.btn-primary[data-v-7ee23a0a]:hover:not(:disabled){background:#fff26e;border-color:#fff26e}.btn.btn-secondary[data-v-7ee23a0a]{background:rgba(0,218,194,.08);border-color:rgba(0,218,194,.55);color:#c5fff9}.btn.btn-secondary[data-v-7ee23a0a]:hover{background:#00dac2;border-color:#00dac2;color:#000}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/ModelBrowser.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,gCAAe,YAAa,CAAA,qBAAsB,CAAA,WAAY,CAAA,eAAgB,CAAA,UAAW,CAAA,gFAAiF,CAAA,iCAAgB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,kBAAmB,CAAA,kBAAmB,CAAA,2CAA4C,CAAA,gDAA+B,cAAe,CAAA,iDAAkD,CAAA,oBAAqB,CAAA,aAAc,CAAA,+CAA8B,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,kBAAmB,CAAA,mCAAkB,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,yCAAwB,oBAAqB,CAAA,8BAA+B,CAAA,gDAA+B,aAAc,CAAA,mCAAkB,UAAW,CAAA,4BAAW,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,OAAQ,CAAA,gBAAiB,CAAA,8BAA+B,CAAA,mCAAoC,CAAA,kBAAmB,CAAA,cAAe,CAAA,aAAc,CAAA,uCAAsB,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,4DAA2C,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,gDAA+B,WAAY,CAAA,kBAAmB,CAAA,uCAAsB,cAAe,CAAA,WAAY,CAAA,aAAc,CAAA,cAAe,CAAA,+BAAgC,CAAA,aAAc,CAAA,6CAA4B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,iCAAgB,MAAO,CAAA,eAAgB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,oCAAqC,CAAA,yBAA0B,CAAA,oDAAmC,SAAU,CAAA,UAAW,CAAA,0DAAyC,8BAA+B,CAAA,0DAAyC,eAAgB,CAAA,gEAA+C,kBAAmB,CAAA,uCAAsB,mBAAoB,CAAA,gCAAe,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,aAAc,CAAA,cAAe,CAAA,OAAQ,CAAA,0BAAS,oBAAqB,CAAA,UAAW,CAAA,WAAY,CAAA,wBAAyB,CAAA,wBAAyB,CAAA,iBAAkB,CAAA,2CAAmC,CAAA,yBAAgB,GAAG,wBAAyB,CAAC,CAAA,8BAAa,iBAAkB,CAAA,YAAa,CAAA,aAAc,CAAA,cAAe,CAAA,iCAAgB,wCAAyC,CAAA,gBAAiB,CAAA,eAAgB,CAAA,gDAA+B,cAAe,CAAA,aAAc,CAAA,iBAAkB,CAAA,eAAgB,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,+DAA8C,aAAc,CAAA,eAAgB,CAAA,8DAA6C,aAAc,CAAA,iDAAgC,YAAa,CAAA,wBAAyB,CAAA,OAAQ,CAAA,sBAAK,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,+BAAc,WAAY,CAAA,kBAAmB,CAAA,sBAAK,cAAe,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,+BAAc,UAAW,CAAA,kBAAmB,CAAA,kCAAiB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,uDAAsC,kBAAmB,CAAA,oBAAqB,CAAA,oCAAmB,8BAA+B,CAAA,gCAAiC,CAAA,aAAc,CAAA,0CAAyB,kBAAmB,CAAA,oBAAqB,CAAA,UAAW',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.model-browser{display:flex;flex-direction:column;height:100%;max-height:60vh;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.browser-header{display:flex;align-items:center;justify-content:space-between;padding:8px 0 10px;margin-bottom:10px;border-bottom:1px solid rgba(255,225,0,.35)}.browser-header .browser-title{font-size:14px;font-family:"Oswald","Teko","Segoe UI",sans-serif;letter-spacing:.08em;color:#ffe100}.browser-header .browser-hint{font-size:10px;color:#8d8d8d;letter-spacing:.08em}.search-box{margin-bottom:10px}.search-box input{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.search-box input:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.search-box input::placeholder{color:#8d8d8d}.search-box input{color:#fff}.error-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.4);margin-bottom:10px;font-size:12px;color:#ffc9c5}.error-bar .retry-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.error-bar .retry-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.error-bar .retry-btn:disabled{opacity:.45;cursor:not-allowed}.error-bar .retry-btn{min-width:72px;height:26px;padding:0 8px;font-size:11px;border-color:rgba(255,59,48,.6);color:#ffc9c5}.error-bar .retry-btn:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.tree-container{flex:1;overflow-y:auto;min-height:150px;padding:4px 0 6px;border:1px solid hsla(0,0%,100%,.12);background:rgba(0,0,0,.3)}.tree-container::-webkit-scrollbar{width:7px;height:7px}.tree-container::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.tree-container::-webkit-scrollbar-thumb{background:#555}.tree-container::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.tree-container:empty{border-style:dashed}.loading-state{display:flex;align-items:center;justify-content:center;padding:24px;color:#8d8d8d;font-size:13px;gap:8px}.spinner{display:inline-block;width:14px;height:14px;border:2px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.empty-state{text-align:center;padding:24px;color:#8d8d8d;font-size:13px}.browser-footer{border-top:1px solid hsla(0,0%,100%,.16);padding-top:12px;margin-top:10px}.browser-footer .selected-info{font-size:12px;color:#d5d5d5;margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.browser-footer .selected-info .selected-path{color:#ffe100;font-weight:600}.browser-footer .selected-info .no-selection{color:#8d8d8d}.browser-footer .footer-actions{display:flex;justify-content:flex-end;gap:8px}.btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn:disabled{opacity:.45;cursor:not-allowed}.btn{min-width:90px;height:32px;padding:0 14px;font-size:12px}.btn:disabled{opacity:.4;cursor:not-allowed}.btn.btn-primary{background:#ffe100;color:#000;border-color:#ffe100}.btn.btn-primary:hover:not(:disabled){background:#fff26e;border-color:#fff26e}.btn.btn-secondary{background:rgba(0,218,194,.08);border-color:rgba(0,218,194,.55);color:#c5fff9}.btn.btn-secondary:hover{background:#00dac2;border-color:#00dac2;color:#000}'],sourceRoot:''}]);const s=i},355:(e,t,o)=>{var n=o(292);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('db518fdc',n,!1,{ssrId:!0})},407:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.menu-overlay[data-v-ff4f8948]{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center}.menu-cluster[data-v-ff4f8948]{position:fixed;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 16px);pointer-events:auto}.menu-cluster.is-left[data-v-ff4f8948]{flex-direction:row-reverse}.menu-panel[data-v-ff4f8948]{width:164px;padding:8px;background:#181818;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.menu-panel[data-v-ff4f8948]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.menu-panel[data-v-ff4f8948]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:20px 20px}.panel-top[data-v-ff4f8948]{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 8px;border-bottom:1px solid rgba(255,225,0,.35)}.panel-title[data-v-ff4f8948]{font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#ffe100;font-size:12px;letter-spacing:.12em}.icon-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.icon-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.icon-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.icon-btn[data-v-ff4f8948]{width:28px;height:24px;padding:0;font-size:16px;line-height:1}.command-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.command-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.command-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.command-btn[data-v-ff4f8948]{width:100%;min-height:52px;padding:8px 10px;margin-bottom:8px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx main" "idx sub";-moz-column-gap:8px;column-gap:8px;row-gap:2px}.command-btn[data-v-ff4f8948]:last-child{margin-bottom:0}.command-btn.active[data-v-ff4f8948]{background:#ffe100;color:#000;border-color:#ffe100}.command-btn.danger[data-v-ff4f8948]{border-color:rgba(255,59,48,.45);color:#ffc9c5}.command-btn.danger[data-v-ff4f8948]:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.command-index[data-v-ff4f8948]{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:16px;color:#00dac2}.command-main[data-v-ff4f8948]{grid-area:main;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;line-height:1}.command-sub[data-v-ff4f8948]{grid-area:sub;font-size:10px;color:#8d8d8d;text-transform:none}.chat-drawer[data-v-ff4f8948]{width:min(320px,100vw - 36px);max-height:min(68vh,420px);padding:12px;background:#262626;color:#fff;overflow:auto;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.chat-drawer[data-v-ff4f8948]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#00dac2;z-index:2}.chat-drawer[data-v-ff4f8948]{background-image:linear-gradient(rgba(255,255,255,0.024) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.024) 1px,transparent 1px);background-size:20px 20px}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar{width:7px;height:7px}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-thumb{background:#555}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.drawer-head[data-v-ff4f8948]{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,218,194,.38)}.drawer-title[data-v-ff4f8948]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;letter-spacing:.12em;color:#00dac2}.drawer-close[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.drawer-close[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.drawer-close[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.drawer-close[data-v-ff4f8948]{width:26px;height:24px;padding:0;font-size:16px;line-height:1}.chat-input[data-v-ff4f8948]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.chat-input[data-v-ff4f8948]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.chat-input[data-v-ff4f8948]::placeholder{color:#8d8d8d}.chat-input[data-v-ff4f8948]{min-height:96px;resize:vertical;color:#fff}.drawer-actions[data-v-ff4f8948]{display:flex;justify-content:flex-end;margin-top:10px}.send-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.send-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.send-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.send-btn[data-v-ff4f8948]{min-width:96px;height:34px}.drawer-hint[data-v-ff4f8948]{margin-top:8px;font-size:11px;color:#8d8d8d}.drawer-enter-active[data-v-ff4f8948],.drawer-leave-active[data-v-ff4f8948]{transition:opacity .16s ease,transform .16s ease}.drawer-enter-from[data-v-ff4f8948],.drawer-leave-to[data-v-ff4f8948]{opacity:0;transform:translateX(-8px)}.menu-cluster.is-left .drawer-enter-from[data-v-ff4f8948],.menu-cluster.is-left .drawer-leave-to[data-v-ff4f8948]{transform:translateX(8px)}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/FunctionMenu.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,+BAAc,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,+BAAc,cAAe,CAAA,YAAa,CAAA,kBAAmB,CAAA,QAAS,CAAA,4BAA6B,CAAA,mBAAoB,CAAA,uCAAsB,0BAA2B,CAAA,6BAAY,WAAY,CAAA,WAAY,CAAA,kBAAmB,CAAA,UAAW,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,qCAAoB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,6BAAY,8IAAwJ,CAAA,yBAA0B,CAAA,4BAAW,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,iBAAkB,CAAA,mBAAoB,CAAA,2CAA4C,CAAA,8BAAa,iDAAkD,CAAA,aAAc,CAAA,cAAe,CAAA,oBAAqB,CAAA,2BAAU,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,gDAA+B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,oCAAmB,WAAY,CAAA,kBAAmB,CAAA,2BAAU,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,8BAAa,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,mDAAkC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,uCAAsB,WAAY,CAAA,kBAAmB,CAAA,8BAAa,UAAW,CAAA,eAAgB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,eAAgB,CAAA,YAAa,CAAA,8BAA+B,CAAA,wCAAyC,CAAA,mBAAe,CAAf,cAAe,CAAA,WAAY,CAAA,yCAAwB,eAAgB,CAAA,qCAAoB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,gCAAiC,CAAA,aAAc,CAAA,2CAA0B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,gCAAe,aAAc,CAAA,iBAAkB,CAAA,iDAAkD,CAAA,cAAe,CAAA,aAAc,CAAA,+BAAc,cAAe,CAAA,iDAAkD,CAAA,cAAe,CAAA,aAAc,CAAA,8BAAa,aAAc,CAAA,cAAe,CAAA,aAAc,CAAA,mBAAoB,CAAA,8BAAa,6BAA8B,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,UAAW,CAAA,aAAc,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,sCAAqB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,8BAAa,gJAA0J,CAAA,yBAA0B,CAAA,iDAAgC,SAAU,CAAA,UAAW,CAAA,uDAAsC,8BAA+B,CAAA,uDAAsC,eAAgB,CAAA,6DAA4C,kBAAmB,CAAA,8BAAa,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,kBAAmB,CAAA,kBAAmB,CAAA,2CAA4C,CAAA,+BAAc,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,aAAc,CAAA,+BAAc,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,oDAAmC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,wCAAuB,WAAY,CAAA,kBAAmB,CAAA,+BAAc,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,6BAAY,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,mCAAkB,oBAAqB,CAAA,8BAA+B,CAAA,0CAAyB,aAAc,CAAA,6BAAY,eAAgB,CAAA,eAAgB,CAAA,UAAW,CAAA,iCAAgB,YAAa,CAAA,wBAAyB,CAAA,eAAgB,CAAA,2BAAU,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,gDAA+B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,oCAAmB,WAAY,CAAA,kBAAmB,CAAA,2BAAU,cAAe,CAAA,WAAY,CAAA,8BAAa,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,4EAA0C,gDAAiD,CAAA,sEAAoC,SAAU,CAAA,0BAA2B,CAAA,kHAAgF,yBAA0B',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.menu-overlay{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center}.menu-cluster{position:fixed;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 16px);pointer-events:auto}.menu-cluster.is-left{flex-direction:row-reverse}.menu-panel{width:164px;padding:8px;background:#181818;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.menu-panel::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.menu-panel{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:20px 20px}.panel-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 8px;border-bottom:1px solid rgba(255,225,0,.35)}.panel-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#ffe100;font-size:12px;letter-spacing:.12em}.icon-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.icon-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.icon-btn:disabled{opacity:.45;cursor:not-allowed}.icon-btn{width:28px;height:24px;padding:0;font-size:16px;line-height:1}.command-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.command-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.command-btn:disabled{opacity:.45;cursor:not-allowed}.command-btn{width:100%;min-height:52px;padding:8px 10px;margin-bottom:8px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx main" "idx sub";column-gap:8px;row-gap:2px}.command-btn:last-child{margin-bottom:0}.command-btn.active{background:#ffe100;color:#000;border-color:#ffe100}.command-btn.danger{border-color:rgba(255,59,48,.45);color:#ffc9c5}.command-btn.danger:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.command-index{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:16px;color:#00dac2}.command-main{grid-area:main;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;line-height:1}.command-sub{grid-area:sub;font-size:10px;color:#8d8d8d;text-transform:none}.chat-drawer{width:min(320px,100vw - 36px);max-height:min(68vh,420px);padding:12px;background:#262626;color:#fff;overflow:auto;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.chat-drawer::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#00dac2;z-index:2}.chat-drawer{background-image:linear-gradient(rgba(255, 255, 255, 0.024) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.024) 1px, transparent 1px);background-size:20px 20px}.chat-drawer::-webkit-scrollbar{width:7px;height:7px}.chat-drawer::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.chat-drawer::-webkit-scrollbar-thumb{background:#555}.chat-drawer::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.drawer-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,218,194,.38)}.drawer-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;letter-spacing:.12em;color:#00dac2}.drawer-close{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.drawer-close:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.drawer-close:disabled{opacity:.45;cursor:not-allowed}.drawer-close{width:26px;height:24px;padding:0;font-size:16px;line-height:1}.chat-input{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.chat-input:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.chat-input::placeholder{color:#8d8d8d}.chat-input{min-height:96px;resize:vertical;color:#fff}.drawer-actions{display:flex;justify-content:flex-end;margin-top:10px}.send-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.send-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.send-btn:disabled{opacity:.45;cursor:not-allowed}.send-btn{min-width:96px;height:34px}.drawer-hint{margin-top:8px;font-size:11px;color:#8d8d8d}.drawer-enter-active,.drawer-leave-active{transition:opacity .16s ease,transform .16s ease}.drawer-enter-from,.drawer-leave-to{opacity:0;transform:translateX(-8px)}.menu-cluster.is-left .drawer-enter-from,.menu-cluster.is-left .drawer-leave-to{transform:translateX(8px)}'],sourceRoot:''}]);const s=i},409:(e,t,o)=>{var n=o(608);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('be1b4460',n,!1,{ssrId:!0})},424:(e,t,o)=>{function n(e,t){for(var o=[],n={},r=0;r<t.length;r++){var a=t[r],i=a[0],s={id:e+':'+r,css:a[1],media:a[2],sourceMap:a[3]};n[i]?n[i].parts.push(s):o.push(n[i]={id:i,parts:[s]})}return o}o.d(t,{A:()=>m});var r='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!r)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var a={},i=r&&(document.head||document.getElementsByTagName('head')[0]),s=null,l=0,c=!1,d=function(){},A=null,u='data-vue-ssr-id',p='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(e,t,o,r){c=o,A=r||{};var i=n(e,t);return h(i),function(t){for(var o=[],r=0;r<i.length;r++){var s=i[r];(l=a[s.id]).refs--,o.push(l)}t?h(i=n(e,t)):i=[];for(r=0;r<o.length;r++){var l;if(0===(l=o[r]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete a[l.id]}}}}function h(e){for(var t=0;t<e.length;t++){var o=e[t],n=a[o.id];if(n){n.refs++;for(var r=0;r<n.parts.length;r++)n.parts[r](o.parts[r]);for(;r<o.parts.length;r++)n.parts.push(g(o.parts[r]));n.parts.length>o.parts.length&&(n.parts.length=o.parts.length)}else{var i=[];for(r=0;r<o.parts.length;r++)i.push(g(o.parts[r]));a[o.id]={id:o.id,refs:1,parts:i}}}}function f(){var e=document.createElement('style');return e.type='text/css',i.appendChild(e),e}function g(e){var t,o,n=document.querySelector('style['+u+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(p){var r=l++;n=s||(s=f()),t=x.bind(null,n,r,!1),o=x.bind(null,n,r,!0)}else n=f(),t=v.bind(null,n),o=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else o()}}var b,y=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function x(e,t,o,n){var r=o?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,r);else{var a=document.createTextNode(r),i=e.childNodes;i[t]&&e.removeChild(i[t]),i.length?e.insertBefore(a,i[t]):e.appendChild(a)}}function v(e,t){var o=t.css,n=t.media,r=t.sourceMap;if(n&&e.setAttribute('media',n),A.ssrId&&e.setAttribute(u,t.id),r&&(o+='\n/*# sourceURL='+r.sources[0]+' */',o+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+' */'),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}},608:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.settings-overlay[data-v-216a7ce1]{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.settings-panel[data-v-216a7ce1]{width:min(1080px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.settings-panel[data-v-216a7ce1]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.settings-panel[data-v-216a7ce1]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.panel-header[data-v-216a7ce1]{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 18px;border-bottom:2px solid #ffe100;background:rgba(0,0,0,.32)}.header-title[data-v-216a7ce1]{min-width:0}.header-title h3[data-v-216a7ce1]{margin:0;font-size:20px;line-height:1;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase}.header-title p[data-v-216a7ce1]{margin:4px 0 0;font-size:10px;color:#8d8d8d;letter-spacing:.14em;text-transform:uppercase}.close-btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.close-btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.close-btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.close-btn[data-v-216a7ce1]{min-width:88px;height:32px;padding:0 10px;font-size:12px}.panel-main[data-v-216a7ce1]{flex:1;min-height:0;display:grid;grid-template-columns:220px 1fr}.panel-nav[data-v-216a7ce1]{border-right:1px solid hsla(0,0%,100%,.16);padding:12px;overflow:auto}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar{width:7px;height:7px}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-thumb{background:#555}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.nav-btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.nav-btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.nav-btn[data-v-216a7ce1]{width:100%;min-height:62px;padding:10px 12px;margin-bottom:10px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx label" "idx sub";-moz-column-gap:8px;column-gap:8px;row-gap:2px}.nav-btn[data-v-216a7ce1]:last-child{margin-bottom:0}.nav-btn.active[data-v-216a7ce1]{background:#ffe100;color:#000;border-color:#ffe100}.nav-index[data-v-216a7ce1]{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#00dac2;font-size:18px}.nav-label[data-v-216a7ce1]{grid-area:label;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px;letter-spacing:.05em}.nav-sub[data-v-216a7ce1]{grid-area:sub;font-size:10px;color:#8d8d8d;letter-spacing:.06em}.panel-body[data-v-216a7ce1]{padding:14px 18px 16px;overflow:auto}.panel-body[data-v-216a7ce1]::-webkit-scrollbar{width:7px;height:7px}.panel-body[data-v-216a7ce1]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-body[data-v-216a7ce1]::-webkit-scrollbar-thumb{background:#555}.panel-body[data-v-216a7ce1]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.setting-section[data-v-216a7ce1]{max-width:740px}.setting-section h4[data-v-216a7ce1]{margin:0 0 12px;display:inline-flex;align-items:center;gap:8px;padding:4px 12px;background:#0f0f0f;border-left:4px solid #ffe100;transform:skewX(-14deg)}.setting-section h4[data-v-216a7ce1]>*{transform:skewX(14deg)}.section-index[data-v-216a7ce1]{color:#00dac2;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px}.section-label[data-v-216a7ce1]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:14px;letter-spacing:.04em}.section-sub[data-v-216a7ce1]{font-size:10px;color:#8d8d8d;letter-spacing:.06em}.form-group[data-v-216a7ce1]{margin-bottom:12px}.form-group>label[data-v-216a7ce1]{display:block;margin-bottom:5px;font-size:12px;color:#d5d5d5;line-height:1.35}.form-group>label>input[type=checkbox][data-v-216a7ce1]{margin-right:8px;accent-color:#00dac2}.form-group input[type=text][data-v-216a7ce1],.form-group input[type=password][data-v-216a7ce1],.form-group input[type=number][data-v-216a7ce1],.form-group select[data-v-216a7ce1],.form-group textarea[data-v-216a7ce1]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.form-group input[type=text][data-v-216a7ce1]:focus,.form-group input[type=password][data-v-216a7ce1]:focus,.form-group input[type=number][data-v-216a7ce1]:focus,.form-group select[data-v-216a7ce1]:focus,.form-group textarea[data-v-216a7ce1]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.form-group input[type=text][data-v-216a7ce1]::placeholder,.form-group input[type=password][data-v-216a7ce1]::placeholder,.form-group input[type=number][data-v-216a7ce1]::placeholder,.form-group select[data-v-216a7ce1]::placeholder,.form-group textarea[data-v-216a7ce1]::placeholder{color:#8d8d8d}.form-group textarea[data-v-216a7ce1]{resize:vertical;min-height:86px;font-family:"JetBrains Mono","Consolas","Courier New",monospace;color:#fff}.form-group select[data-v-216a7ce1]{color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.form-group select option[data-v-216a7ce1]{background:#101010;color:#fff}.form-group input[type=range][data-v-216a7ce1]{width:100%;-webkit-appearance:none;appearance:none;height:4px;border:none;background:#4a4a4a;border-radius:0;padding:0;margin:7px 0 4px}.form-group input[type=range][data-v-216a7ce1]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#ffe100;border:2px solid #000;transform:rotate(45deg)}.form-group input[type=range][data-v-216a7ce1]::-moz-range-thumb{width:12px;height:12px;border:2px solid #000;border-radius:0;background:#ffe100;transform:rotate(45deg)}.form-group input[type=range][data-v-216a7ce1]::-moz-range-track{height:4px;background:#4a4a4a;border:none}.form-group input[type=checkbox][data-v-216a7ce1]{accent-color:#00dac2}.form-group .hint[data-v-216a7ce1]{margin-top:4px;font-size:11px;color:#8d8d8d}.hint-error[data-v-216a7ce1]{color:#ff3b30 !important}.form-row[data-v-216a7ce1]{display:flex;gap:12px;align-items:flex-start}.form-row .half[data-v-216a7ce1]{flex:1;min-width:0}.dice-sheet-list[data-v-216a7ce1]{margin-top:6px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}.dice-sheet-item[data-v-216a7ce1]{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.04);font-size:12px;color:#e8e8e8;line-height:1.35}.dice-sheet-item input[type=checkbox][data-v-216a7ce1]{margin:0}.input-with-btn[data-v-216a7ce1]{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch}.input-with-btn .input-btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.input-with-btn .input-btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.input-with-btn .input-btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.input-with-btn .input-btn[data-v-216a7ce1]{min-width:84px;padding:0 12px;font-size:11px;white-space:nowrap}.model-list[data-v-216a7ce1]{display:flex;flex-wrap:wrap;gap:8px}.hidden-file-input[data-v-216a7ce1]{display:none}.local-model-info[data-v-216a7ce1]{margin-top:6px;padding:8px 10px;border:1px solid hsla(0,0%,100%,.16);background:hsla(0,0%,100%,.04);font-size:12px;line-height:1.45;color:#e8e8e8}.model-btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.model-btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.model-btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.model-btn[data-v-216a7ce1]{min-height:30px;padding:0 12px;font-size:12px;text-transform:none;letter-spacing:.03em}.model-btn.active[data-v-216a7ce1]{background:#ffe100;border-color:#ffe100;color:#000}.model-btn.browse-btn[data-v-216a7ce1]{border-color:rgba(0,218,194,.55);color:#b2fff6}.model-btn.browse-btn[data-v-216a7ce1]:hover{background:#00dac2;border-color:#00dac2;color:#000}.emotion-layout[data-v-216a7ce1]{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:14px;align-items:start}.emotion-configs[data-v-216a7ce1]{min-width:0}.emotion-preview-panel[data-v-216a7ce1]{position:sticky;top:10px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 12px;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:18px 18px}.emotion-preview-header[data-v-216a7ce1]{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}.emotion-preview-title[data-v-216a7ce1]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#00dac2}.emotion-preview-tag[data-v-216a7ce1]{font-size:12px;color:hsla(0,0%,100%,.78)}.emotion-preview-canvas[data-v-216a7ce1]{position:relative;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden;background:rgba(15,23,42,.95);border:1px solid hsla(0,0%,100%,.18)}.emotion-preview-interact[data-v-216a7ce1]{position:absolute;inset:0;z-index:3}.emotion-preview-empty[data-v-216a7ce1]{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;z-index:4;pointer-events:none;color:hsla(0,0%,100%,.78);font-size:12px}.emotion-preview-controls[data-v-216a7ce1]{margin-top:10px;display:flex;flex-direction:column;gap:8px}.emotion-zoom-row[data-v-216a7ce1]{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}.zoom-label[data-v-216a7ce1]{font-size:12px;color:hsla(0,0%,100%,.78)}.zoom-value[data-v-216a7ce1]{font-size:12px;color:#ffe100;font-variant-numeric:tabular-nums}.emotion-preview-actions[data-v-216a7ce1]{display:flex;gap:8px}.emotion-tag[data-v-216a7ce1]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100;text-transform:uppercase}.emotion-map-table[data-v-216a7ce1]{margin-top:4px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.22);max-height:none;overflow:visible;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:20px 20px}.emotion-map-head[data-v-216a7ce1],.emotion-map-row[data-v-216a7ce1]{display:grid;grid-template-columns:72px 22px minmax(0,1fr) minmax(0,1fr) 52px;gap:10px;align-items:center}.emotion-map-head[data-v-216a7ce1]{position:sticky;top:0;z-index:2;padding:8px 10px;font-size:10px;color:hsla(0,0%,100%,.68);letter-spacing:.03em;background:rgba(2,8,20,.92);border-bottom:1px solid hsla(0,0%,100%,.2)}.emotion-map-row[data-v-216a7ce1]{padding:10px;border-bottom:1px solid hsla(0,0%,100%,.12)}.emotion-map-row[data-v-216a7ce1]:nth-child(odd){background:hsla(0,0%,100%,.02)}.emotion-map-tag[data-v-216a7ce1]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100}.emotion-map-arrow[data-v-216a7ce1]{text-align:center;color:hsla(0,0%,100%,.78);font-size:18px;line-height:1}.emotion-map-preview-btn[data-v-216a7ce1]{min-width:0;width:44px;height:32px;padding:0;font-size:14px;line-height:1}.emotion-map-row select[data-v-216a7ce1]{width:100%;min-width:0;text-overflow:ellipsis;white-space:nowrap}.emotion-advanced-list[data-v-216a7ce1]{margin-top:10px;display:flex;flex-direction:column;gap:10px}.emotion-advanced-item[data-v-216a7ce1]{border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 2px;background-image:linear-gradient(rgba(255,255,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.025) 1px,transparent 1px);background-size:18px 18px}.emotion-advanced-title[data-v-216a7ce1]{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:hsla(0,0%,100%,.85)}.advanced-toggle[data-v-216a7ce1]{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.04);font-size:11px;color:#d5d5d5;cursor:pointer;-webkit-user-select:none;user-select:none;clip-path:polygon(0 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%)}.advanced-toggle[data-v-216a7ce1]:hover{border-color:rgba(255,225,0,.65);color:#ffe100}.advanced-toggle .toggle-icon[data-v-216a7ce1]{width:12px;text-align:center;color:#00dac2}.advanced-params[data-v-216a7ce1]{margin-top:8px;padding-top:10px;border-top:1px dashed hsla(0,0%,100%,.2)}.about-card[data-v-216a7ce1]{margin-bottom:12px;padding:10px 12px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.26);background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:18px 18px}.about-title[data-v-216a7ce1]{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:#ffe100}.about-link[data-v-216a7ce1]{color:#00dac2;word-break:break-all;text-decoration:underline}.about-list[data-v-216a7ce1]{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.5;color:#d5d5d5}.status-badge[data-v-216a7ce1]{margin-left:8px;font-size:12px}.status-success[data-v-216a7ce1]{color:#00dac2}.status-fail[data-v-216a7ce1]{color:#ff9c94}.panel-footer[data-v-216a7ce1]{display:flex;justify-content:flex-end;gap:10px;padding:12px 18px 14px;border-top:1px solid hsla(0,0%,100%,.18);background:rgba(0,0,0,.36)}.btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.btn[data-v-216a7ce1]{min-width:100px;height:34px;padding:0 14px;font-size:12px}.btn-primary[data-v-216a7ce1]{background:#ffe100;color:#000;border-color:#ffe100}.btn-secondary[data-v-216a7ce1]{background:hsla(0,0%,100%,.06);border-color:hsla(0,0%,100%,.3)}.btn-test[data-v-216a7ce1]{min-width:96px;background:rgba(0,218,194,.1);border-color:rgba(0,218,194,.6);color:#bcfff7}.btn-test[data-v-216a7ce1]:hover:not(:disabled){background:#00dac2;border-color:#00dac2;color:#000}.browser-overlay[data-v-216a7ce1]{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog[data-v-216a7ce1]{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.browser-dialog[data-v-216a7ce1]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog[data-v-216a7ce1]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.browser-dialog-header[data-v-216a7ce1]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3[data-v-216a7ce1]{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn[data-v-216a7ce1]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn[data-v-216a7ce1]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn[data-v-216a7ce1]:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn[data-v-216a7ce1]{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body[data-v-216a7ce1]{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body[data-v-216a7ce1]::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body[data-v-216a7ce1]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body[data-v-216a7ce1]::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body[data-v-216a7ce1]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.gpt-model-dialog[data-v-216a7ce1]{width:min(1240px,100vw - 24px)}.gpt-model-editor-dialog[data-v-216a7ce1]{width:min(1080px,100vw - 24px)}.gpt-model-header[data-v-216a7ce1]{align-items:flex-start}.gpt-model-header-actions[data-v-216a7ce1]{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}.gpt-model-header-actions .btn[data-v-216a7ce1]{min-width:84px;height:30px;padding:0 10px;font-size:11px}.gpt-model-body[data-v-216a7ce1]{display:flex;flex-direction:column;gap:10px}.gpt-model-tools[data-v-216a7ce1]{display:grid;grid-template-columns:minmax(0,1fr) auto auto;gap:8px;align-items:center}.gpt-model-tools input[data-v-216a7ce1]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.gpt-model-tools input[data-v-216a7ce1]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.gpt-model-tools input[data-v-216a7ce1]::placeholder{color:#8d8d8d}.gpt-model-card-list[data-v-216a7ce1]{display:flex;flex-direction:column;gap:10px}.gpt-model-card[data-v-216a7ce1]{border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.03);padding:10px 12px;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:18px 18px}.gpt-model-card-head[data-v-216a7ce1]{display:flex;align-items:center;justify-content:space-between;gap:10px}.gpt-model-card-head label[data-v-216a7ce1]{display:inline-flex;align-items:center;gap:8px;font-size:12px}.gpt-model-id[data-v-216a7ce1]{font-size:11px;color:hsla(0,0%,100%,.65);font-family:"JetBrains Mono","Consolas","Courier New",monospace;word-break:break-all}.gpt-model-card-actions[data-v-216a7ce1]{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px}.gpt-model-card-actions .btn[data-v-216a7ce1]{min-width:110px}.gpt-ref-list[data-v-216a7ce1]{display:flex;flex-direction:column;gap:10px;margin-bottom:8px}.gpt-ref-item[data-v-216a7ce1]{border:1px solid hsla(0,0%,100%,.16);background:hsla(0,0%,100%,.02);padding:10px}.gpt-ref-actions[data-v-216a7ce1]{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}.gpt-expression-map-list[data-v-216a7ce1]{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}.gpt-expression-map-row[data-v-216a7ce1]{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr) auto;gap:8px;align-items:center}.gpt-expression-map-row input[data-v-216a7ce1],.gpt-expression-map-row select[data-v-216a7ce1]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.gpt-expression-map-row input[data-v-216a7ce1]:focus,.gpt-expression-map-row select[data-v-216a7ce1]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.gpt-expression-map-row input[data-v-216a7ce1]::placeholder,.gpt-expression-map-row select[data-v-216a7ce1]::placeholder{color:#8d8d8d}.gpt-expression-map-row input[data-v-216a7ce1],.gpt-expression-map-row select[data-v-216a7ce1]{width:100%}@media (max-width:860px){.settings-overlay[data-v-216a7ce1]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.settings-panel[data-v-216a7ce1]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.settings-panel[data-v-216a7ce1]::before{width:40px}.panel-main[data-v-216a7ce1]{grid-template-columns:1fr;grid-template-rows:auto 1fr;min-height:0}.panel-nav[data-v-216a7ce1]{border-right:none;border-bottom:1px solid hsla(0,0%,100%,.16);display:flex;gap:6px;padding:8px 10px;overflow-x:auto;overflow-y:hidden}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar{width:7px;height:7px}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-thumb{background:#555}.panel-nav[data-v-216a7ce1]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn[data-v-216a7ce1]{flex:0 0 auto;width:150px;min-height:42px;padding:6px 10px;margin-bottom:0;grid-template-areas:"idx label";grid-template-columns:auto 1fr;row-gap:0;align-items:center}.panel-body[data-v-216a7ce1]{min-height:0}.nav-index[data-v-216a7ce1]{font-size:16px}.nav-label[data-v-216a7ce1]{font-size:12px}.nav-sub[data-v-216a7ce1]{display:none}.browser-overlay[data-v-216a7ce1]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog[data-v-216a7ce1]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.gpt-model-dialog[data-v-216a7ce1],.gpt-model-editor-dialog[data-v-216a7ce1]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px)}.gpt-model-tools[data-v-216a7ce1]{grid-template-columns:1fr}.gpt-expression-map-row[data-v-216a7ce1]{grid-template-columns:1fr}.emotion-layout[data-v-216a7ce1]{grid-template-columns:1fr}.emotion-preview-panel[data-v-216a7ce1]{order:-1;position:sticky;top:8px;z-index:8;margin-bottom:8px;padding:8px 10px 10px;background:rgba(0,0,0,.9)}.emotion-preview-header[data-v-216a7ce1]{margin-bottom:6px}.emotion-preview-canvas[data-v-216a7ce1]{aspect-ratio:16/9;max-height:210px}.emotion-preview-controls[data-v-216a7ce1]{margin-top:8px;gap:6px}.emotion-map-head[data-v-216a7ce1]{position:static}.emotion-preview-controls .hint[data-v-216a7ce1]{display:none}}@media (max-width:620px){.settings-overlay[data-v-216a7ce1]{align-items:stretch;padding:0}.settings-panel[data-v-216a7ce1]{width:100vw;max-height:100dvh;border-left:none;border-right:none;box-shadow:none}.panel-header[data-v-216a7ce1]{padding:10px 12px}.header-title h3[data-v-216a7ce1]{font-size:15px;letter-spacing:.06em}.header-title p[data-v-216a7ce1]{display:none}.panel-nav[data-v-216a7ce1]{padding:6px 8px}.nav-btn[data-v-216a7ce1]{width:126px;min-height:38px;padding:5px 8px}.nav-index[data-v-216a7ce1]{font-size:14px}.nav-label[data-v-216a7ce1]{font-size:11px;letter-spacing:.04em}.close-btn[data-v-216a7ce1]{min-width:66px;height:28px;padding:0 8px;font-size:11px}.panel-footer[data-v-216a7ce1]{padding:10px 12px calc(10px + env(safe-area-inset-bottom))}.panel-body[data-v-216a7ce1]{padding:8px 10px}.form-row[data-v-216a7ce1]{flex-direction:column;gap:0}.input-with-btn[data-v-216a7ce1]{grid-template-columns:1fr}.btn[data-v-216a7ce1]{min-width:86px}.emotion-preview-panel[data-v-216a7ce1]{top:6px;padding:8px}.emotion-preview-canvas[data-v-216a7ce1]{max-height:180px}.emotion-map-head[data-v-216a7ce1],.emotion-map-row[data-v-216a7ce1]{grid-template-columns:56px 16px minmax(0,1fr) minmax(0,1fr) 42px;gap:6px}.emotion-map-row[data-v-216a7ce1]{padding:8px}.emotion-map-arrow[data-v-216a7ce1]{font-size:14px}.emotion-map-preview-btn[data-v-216a7ce1]{width:38px;height:30px;font-size:12px}.browser-overlay[data-v-216a7ce1]{align-items:stretch;padding:0}.browser-dialog[data-v-216a7ce1]{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.gpt-model-dialog[data-v-216a7ce1],.gpt-model-editor-dialog[data-v-216a7ce1]{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.browser-dialog-header[data-v-216a7ce1]{padding:12px}.browser-dialog-body[data-v-216a7ce1]{padding:10px 12px 12px}.gpt-model-header-actions[data-v-216a7ce1]{width:100%;justify-content:flex-start}.gpt-model-card-actions .btn[data-v-216a7ce1]{min-width:0;flex:1 1 120px}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/SettingsPanel.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,mCAAkB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,8BAA+B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,+BAAc,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,+BAAgC,CAAA,0BAA2B,CAAA,+BAAc,WAAY,CAAA,kCAAiB,QAAS,CAAA,cAAe,CAAA,aAAc,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,iCAAgB,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,4BAAW,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iDAAgC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,WAAY,CAAA,kBAAmB,CAAA,4BAAW,cAAe,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,6BAAY,MAAO,CAAA,YAAa,CAAA,YAAa,CAAA,+BAAgC,CAAA,4BAAW,0CAA2C,CAAA,YAAa,CAAA,aAAc,CAAA,+CAA8B,SAAU,CAAA,UAAW,CAAA,qDAAoC,8BAA+B,CAAA,qDAAoC,eAAgB,CAAA,2DAA0C,kBAAmB,CAAA,0BAAS,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,+CAA8B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,mCAAkB,WAAY,CAAA,kBAAmB,CAAA,0BAAS,UAAW,CAAA,eAAgB,CAAA,iBAAkB,CAAA,kBAAmB,CAAA,eAAgB,CAAA,YAAa,CAAA,8BAA+B,CAAA,yCAA0C,CAAA,mBAAe,CAAf,cAAe,CAAA,WAAY,CAAA,qCAAoB,eAAgB,CAAA,iCAAgB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4BAAW,aAAc,CAAA,iBAAkB,CAAA,iDAAkD,CAAA,aAAc,CAAA,cAAe,CAAA,4BAAW,eAAgB,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,0BAAS,aAAc,CAAA,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,sBAAuB,CAAA,aAAc,CAAA,gDAA+B,SAAU,CAAA,UAAW,CAAA,sDAAqC,8BAA+B,CAAA,sDAAqC,eAAgB,CAAA,4DAA2C,kBAAmB,CAAA,kCAAiB,eAAgB,CAAA,qCAAoB,eAAgB,CAAA,mBAAoB,CAAA,kBAAmB,CAAA,OAAQ,CAAA,gBAAiB,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,uBAAwB,CAAA,uCAAsB,sBAAuB,CAAA,gCAAe,aAAc,CAAA,iDAAkD,CAAA,cAAe,CAAA,gCAAe,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,8BAAa,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,kBAAmB,CAAA,mCAAkB,aAAc,CAAA,iBAAkB,CAAA,cAAe,CAAA,aAAc,CAAA,gBAAiB,CAAA,wDAAuC,gBAAiB,CAAA,oBAAqB,CAAA,0NAAqI,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,wPAAmK,oBAAqB,CAAA,8BAA+B,CAAA,2RAAsM,aAAc,CAAA,sCAAqB,eAAgB,CAAA,eAAgB,CAAA,+DAAgE,CAAA,UAAW,CAAA,oCAAmB,UAAW,CAAA,gFAAiF,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,+CAA8B,UAAW,CAAA,uBAAgB,CAAhB,eAAgB,CAAA,UAAW,CAAA,WAAY,CAAA,kBAAmB,CAAA,eAAgB,CAAA,SAAU,CAAA,gBAAiB,CAAA,qEAAoD,uBAAwB,CAAA,UAAW,CAAA,WAAY,CAAA,kBAAmB,CAAA,qBAAsB,CAAA,uBAAwB,CAAA,iEAAgD,UAAW,CAAA,WAAY,CAAA,qBAAsB,CAAA,eAAgB,CAAA,kBAAmB,CAAA,uBAAwB,CAAA,iEAAgD,UAAW,CAAA,kBAAmB,CAAA,WAAY,CAAA,kDAAiC,oBAAqB,CAAA,mCAAkB,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,6BAAY,wBAAyB,CAAA,2BAAU,YAAa,CAAA,QAAS,CAAA,sBAAuB,CAAA,iCAAgB,MAAO,CAAA,WAAY,CAAA,kCAAiB,cAAe,CAAA,YAAa,CAAA,wDAA2D,CAAA,OAAQ,CAAA,kCAAiB,YAAa,CAAA,kBAAmB,CAAA,OAAQ,CAAA,eAAgB,CAAA,oCAAqC,CAAA,8BAA+B,CAAA,cAAe,CAAA,aAAc,CAAA,gBAAiB,CAAA,uDAAsC,QAAS,CAAA,iCAAgB,YAAa,CAAA,8BAA+B,CAAA,OAAQ,CAAA,mBAAoB,CAAA,4CAA2B,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iEAAgD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qDAAoC,WAAY,CAAA,kBAAmB,CAAA,4CAA2B,cAAe,CAAA,cAAe,CAAA,cAAe,CAAA,kBAAmB,CAAA,6BAAY,YAAa,CAAA,cAAe,CAAA,OAAQ,CAAA,oCAAmB,YAAa,CAAA,mCAAkB,cAAe,CAAA,gBAAiB,CAAA,oCAAqC,CAAA,8BAA+B,CAAA,cAAe,CAAA,gBAAiB,CAAA,aAAc,CAAA,4BAAW,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iDAAgC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,WAAY,CAAA,kBAAmB,CAAA,4BAAW,eAAgB,CAAA,cAAe,CAAA,cAAe,CAAA,mBAAoB,CAAA,oBAAqB,CAAA,mCAAkB,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,uCAAsB,gCAAiC,CAAA,aAAc,CAAA,6CAA4B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,iCAAgB,YAAa,CAAA,yCAA2C,CAAA,QAAS,CAAA,iBAAkB,CAAA,kCAAiB,WAAY,CAAA,wCAAuB,eAAgB,CAAA,QAAS,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,sBAAuB,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,yCAAwB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,kBAAmB,CAAA,wCAAuB,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,sCAAqB,cAAe,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,UAAW,CAAA,gBAAiB,CAAA,kBAAmB,CAAA,eAAgB,CAAA,6BAA8B,CAAA,oCAAqC,CAAA,2CAA0B,iBAAkB,CAAA,OAAQ,CAAA,SAAU,CAAA,wCAAuB,iBAAkB,CAAA,OAAQ,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,iBAAkB,CAAA,SAAU,CAAA,mBAAoB,CAAA,yBAA0B,CAAA,cAAe,CAAA,2CAA0B,eAAgB,CAAA,YAAa,CAAA,qBAAsB,CAAA,OAAQ,CAAA,mCAAkB,YAAa,CAAA,mCAAoC,CAAA,QAAS,CAAA,kBAAmB,CAAA,6BAAY,cAAe,CAAA,yBAA0B,CAAA,6BAAY,cAAe,CAAA,aAAc,CAAA,iCAAkC,CAAA,0CAAyB,YAAa,CAAA,OAAQ,CAAA,8BAAa,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,wBAAyB,CAAA,oCAAmB,cAAe,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,eAAgB,CAAA,gBAAiB,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,qEAAmC,YAAa,CAAA,gEAAmE,CAAA,QAAS,CAAA,kBAAmB,CAAA,mCAAkB,eAAgB,CAAA,KAAM,CAAA,SAAU,CAAA,gBAAiB,CAAA,cAAe,CAAA,yBAA0B,CAAA,oBAAqB,CAAA,2BAA4B,CAAA,0CAA2C,CAAA,kCAAiB,YAAa,CAAA,2CAA4C,CAAA,iDAAgC,8BAA+B,CAAA,kCAAiB,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,oCAAmB,iBAAkB,CAAA,yBAA0B,CAAA,cAAe,CAAA,aAAc,CAAA,0CAAyB,WAAY,CAAA,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,yCAAwB,UAAW,CAAA,WAAY,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,wCAAuB,eAAgB,CAAA,YAAa,CAAA,qBAAsB,CAAA,QAAS,CAAA,wCAAuB,oCAAqC,CAAA,0BAA2B,CAAA,qBAAsB,CAAA,gJAA0J,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,cAAe,CAAA,oBAAqB,CAAA,yBAA0B,CAAA,kCAAiB,mBAAoB,CAAA,kBAAmB,CAAA,OAAQ,CAAA,gBAAiB,CAAA,mCAAoC,CAAA,8BAA+B,CAAA,cAAe,CAAA,aAAc,CAAA,cAAe,CAAA,wBAAiB,CAAjB,gBAAiB,CAAA,gFAAqF,CAAA,wCAAuB,gCAAiC,CAAA,aAAc,CAAA,+CAA8B,UAAW,CAAA,iBAAkB,CAAA,aAAc,CAAA,kCAAiB,cAAe,CAAA,gBAAiB,CAAA,wCAAyC,CAAA,6BAAY,kBAAmB,CAAA,iBAAkB,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,8BAAa,iBAAkB,CAAA,cAAe,CAAA,oBAAqB,CAAA,aAAc,CAAA,6BAAY,aAAc,CAAA,oBAAqB,CAAA,yBAA0B,CAAA,6BAAY,QAAS,CAAA,iBAAkB,CAAA,YAAa,CAAA,qBAAsB,CAAA,OAAQ,CAAA,cAAe,CAAA,eAAgB,CAAA,aAAc,CAAA,+BAAc,eAAgB,CAAA,cAAe,CAAA,iCAAgB,aAAc,CAAA,8BAAa,aAAc,CAAA,+BAAc,YAAa,CAAA,wBAAyB,CAAA,QAAS,CAAA,sBAAuB,CAAA,wCAAyC,CAAA,0BAA2B,CAAA,sBAAK,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,+BAAc,WAAY,CAAA,kBAAmB,CAAA,sBAAK,eAAgB,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,8BAAa,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,gCAAe,8BAA+B,CAAA,+BAAgC,CAAA,2BAAU,cAAe,CAAA,6BAA8B,CAAA,+BAAgC,CAAA,aAAc,CAAA,gDAA+B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,kCAAiB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,yBAA0B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,6BAA8B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,wCAAuB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,2CAA4C,CAAA,0BAA2B,CAAA,2CAA0B,QAAS,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,mDAAkC,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,wEAAuD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4DAA2C,WAAY,CAAA,kBAAmB,CAAA,mDAAkC,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,aAAc,CAAA,cAAe,CAAA,sCAAqB,sBAAuB,CAAA,aAAc,CAAA,MAAO,CAAA,yDAAwC,SAAU,CAAA,UAAW,CAAA,+DAA8C,8BAA+B,CAAA,+DAA8C,eAAgB,CAAA,qEAAoD,kBAAmB,CAAA,mCAAkB,8BAA+B,CAAA,0CAAyB,8BAA+B,CAAA,mCAAkB,sBAAuB,CAAA,2CAA0B,YAAa,CAAA,OAAQ,CAAA,cAAe,CAAA,wBAAyB,CAAA,kBAAmB,CAAA,gDAA+B,cAAe,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,iCAAgB,YAAa,CAAA,qBAAsB,CAAA,QAAS,CAAA,kCAAiB,YAAa,CAAA,6CAA+C,CAAA,OAAQ,CAAA,kBAAmB,CAAA,wCAAuB,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,8CAA6B,oBAAqB,CAAA,8BAA+B,CAAA,qDAAoC,aAAc,CAAA,sCAAqB,YAAa,CAAA,qBAAsB,CAAA,QAAS,CAAA,iCAAgB,oCAAqC,CAAA,8BAA+B,CAAA,iBAAkB,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,sCAAqB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,4CAA2B,mBAAoB,CAAA,kBAAmB,CAAA,OAAQ,CAAA,cAAe,CAAA,+BAAc,cAAe,CAAA,yBAA0B,CAAA,+DAAgE,CAAA,oBAAqB,CAAA,yCAAwB,cAAe,CAAA,YAAa,CAAA,cAAe,CAAA,OAAQ,CAAA,8CAA6B,eAAgB,CAAA,+BAAc,YAAa,CAAA,qBAAsB,CAAA,QAAS,CAAA,iBAAkB,CAAA,+BAAc,oCAAqC,CAAA,8BAA+B,CAAA,YAAa,CAAA,kCAAiB,YAAa,CAAA,OAAQ,CAAA,oBAAqB,CAAA,cAAe,CAAA,0CAAyB,YAAa,CAAA,qBAAsB,CAAA,OAAQ,CAAA,iBAAkB,CAAA,yCAAwB,YAAa,CAAA,sDAAyD,CAAA,OAAQ,CAAA,kBAAmB,CAAA,+FAA6D,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,2GAAyE,oBAAqB,CAAA,8BAA+B,CAAA,yHAAuF,aAAc,CAAA,+FAA6D,UAAW,CAAA,yBAAyB,mCAAkB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAA,yCAAwB,UAAW,CAAA,6BAAY,yBAA0B,CAAA,2BAA4B,CAAA,YAAa,CAAA,4BAAW,iBAAkB,CAAA,2CAA4C,CAAA,YAAa,CAAA,OAAQ,CAAA,gBAAiB,CAAA,eAAgB,CAAA,iBAAkB,CAAA,+CAA8B,SAAU,CAAA,UAAW,CAAA,qDAAoC,8BAA+B,CAAA,qDAAoC,eAAgB,CAAA,2DAA0C,kBAAmB,CAAA,0BAAS,aAAc,CAAA,WAAY,CAAA,eAAgB,CAAA,gBAAiB,CAAA,eAAgB,CAAA,+BAAgC,CAAA,8BAA+B,CAAA,SAAU,CAAA,kBAAmB,CAAA,6BAAY,YAAa,CAAA,4BAAW,cAAe,CAAA,4BAAW,cAAe,CAAA,0BAAS,YAAa,CAAA,kCAAiB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAA,6EAA2C,UAAW,CAAA,uFAAwF,CAAA,kCAAiB,yBAA0B,CAAA,yCAAwB,yBAA0B,CAAA,iCAAgB,yBAA0B,CAAA,wCAAuB,QAAS,CAAA,eAAgB,CAAA,OAAQ,CAAA,SAAU,CAAA,iBAAkB,CAAA,qBAAsB,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,yCAAwB,iBAAkB,CAAA,gBAAiB,CAAA,2CAA0B,cAAe,CAAA,OAAQ,CAAA,mCAAkB,eAAgB,CAAA,iDAAgC,YAAa,CAAC,CAAA,yBAAyB,mCAAkB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,eAAgB,CAAA,+BAAc,iBAAkB,CAAA,kCAAiB,cAAe,CAAA,oBAAqB,CAAA,iCAAgB,YAAa,CAAA,4BAAW,eAAgB,CAAA,0BAAS,WAAY,CAAA,eAAgB,CAAA,eAAgB,CAAA,4BAAW,cAAe,CAAA,4BAAW,cAAe,CAAA,oBAAqB,CAAA,4BAAW,cAAe,CAAA,WAAY,CAAA,aAAc,CAAA,cAAe,CAAA,+BAAc,0DAA2D,CAAA,6BAAY,gBAAiB,CAAA,2BAAU,qBAAsB,CAAA,KAAM,CAAA,iCAAgB,yBAA0B,CAAA,sBAAK,cAAe,CAAA,wCAAuB,OAAQ,CAAA,WAAY,CAAA,yCAAwB,gBAAiB,CAAA,qEAAmC,gEAAmE,CAAA,OAAQ,CAAA,kCAAiB,WAAY,CAAA,oCAAmB,cAAe,CAAA,0CAAyB,UAAW,CAAA,WAAY,CAAA,cAAe,CAAA,kCAAiB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,eAAgB,CAAA,cAAe,CAAA,6EAA2C,WAAY,CAAA,iBAAkB,CAAA,eAAgB,CAAA,cAAe,CAAA,wCAAuB,YAAa,CAAA,sCAAqB,sBAAuB,CAAA,2CAA0B,UAAW,CAAA,0BAA2B,CAAA,8CAA6B,WAAY,CAAA,cAAe,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.settings-overlay{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.settings-panel{width:min(1080px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.settings-panel::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.settings-panel{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.panel-header{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 18px;border-bottom:2px solid #ffe100;background:rgba(0,0,0,.32)}.header-title{min-width:0}.header-title h3{margin:0;font-size:20px;line-height:1;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase}.header-title p{margin:4px 0 0;font-size:10px;color:#8d8d8d;letter-spacing:.14em;text-transform:uppercase}.close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.close-btn:disabled{opacity:.45;cursor:not-allowed}.close-btn{min-width:88px;height:32px;padding:0 10px;font-size:12px}.panel-main{flex:1;min-height:0;display:grid;grid-template-columns:220px 1fr}.panel-nav{border-right:1px solid hsla(0,0%,100%,.16);padding:12px;overflow:auto}.panel-nav::-webkit-scrollbar{width:7px;height:7px}.panel-nav::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav::-webkit-scrollbar-thumb{background:#555}.panel-nav::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.nav-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.nav-btn:disabled{opacity:.45;cursor:not-allowed}.nav-btn{width:100%;min-height:62px;padding:10px 12px;margin-bottom:10px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx label" "idx sub";column-gap:8px;row-gap:2px}.nav-btn:last-child{margin-bottom:0}.nav-btn.active{background:#ffe100;color:#000;border-color:#ffe100}.nav-index{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#00dac2;font-size:18px}.nav-label{grid-area:label;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px;letter-spacing:.05em}.nav-sub{grid-area:sub;font-size:10px;color:#8d8d8d;letter-spacing:.06em}.panel-body{padding:14px 18px 16px;overflow:auto}.panel-body::-webkit-scrollbar{width:7px;height:7px}.panel-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-body::-webkit-scrollbar-thumb{background:#555}.panel-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.setting-section{max-width:740px}.setting-section h4{margin:0 0 12px;display:inline-flex;align-items:center;gap:8px;padding:4px 12px;background:#0f0f0f;border-left:4px solid #ffe100;transform:skewX(-14deg)}.setting-section h4>*{transform:skewX(14deg)}.section-index{color:#00dac2;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px}.section-label{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:14px;letter-spacing:.04em}.section-sub{font-size:10px;color:#8d8d8d;letter-spacing:.06em}.form-group{margin-bottom:12px}.form-group>label{display:block;margin-bottom:5px;font-size:12px;color:#d5d5d5;line-height:1.35}.form-group>label>input[type=checkbox]{margin-right:8px;accent-color:#00dac2}.form-group input[type=text],.form-group input[type=password],.form-group input[type=number],.form-group select,.form-group textarea{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.form-group input[type=text]:focus,.form-group input[type=password]:focus,.form-group input[type=number]:focus,.form-group select:focus,.form-group textarea:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.form-group input[type=text]::placeholder,.form-group input[type=password]::placeholder,.form-group input[type=number]::placeholder,.form-group select::placeholder,.form-group textarea::placeholder{color:#8d8d8d}.form-group textarea{resize:vertical;min-height:86px;font-family:"JetBrains Mono","Consolas","Courier New",monospace;color:#fff}.form-group select{color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.form-group select option{background:#101010;color:#fff}.form-group input[type=range]{width:100%;appearance:none;height:4px;border:none;background:#4a4a4a;border-radius:0;padding:0;margin:7px 0 4px}.form-group input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#ffe100;border:2px solid #000;transform:rotate(45deg)}.form-group input[type=range]::-moz-range-thumb{width:12px;height:12px;border:2px solid #000;border-radius:0;background:#ffe100;transform:rotate(45deg)}.form-group input[type=range]::-moz-range-track{height:4px;background:#4a4a4a;border:none}.form-group input[type=checkbox]{accent-color:#00dac2}.form-group .hint{margin-top:4px;font-size:11px;color:#8d8d8d}.hint-error{color:#ff3b30 !important}.form-row{display:flex;gap:12px;align-items:flex-start}.form-row .half{flex:1;min-width:0}.dice-sheet-list{margin-top:6px;display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:8px}.dice-sheet-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.04);font-size:12px;color:#e8e8e8;line-height:1.35}.dice-sheet-item input[type=checkbox]{margin:0}.input-with-btn{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch}.input-with-btn .input-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.input-with-btn .input-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.input-with-btn .input-btn:disabled{opacity:.45;cursor:not-allowed}.input-with-btn .input-btn{min-width:84px;padding:0 12px;font-size:11px;white-space:nowrap}.model-list{display:flex;flex-wrap:wrap;gap:8px}.hidden-file-input{display:none}.local-model-info{margin-top:6px;padding:8px 10px;border:1px solid hsla(0,0%,100%,.16);background:hsla(0,0%,100%,.04);font-size:12px;line-height:1.45;color:#e8e8e8}.model-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.model-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.model-btn:disabled{opacity:.45;cursor:not-allowed}.model-btn{min-height:30px;padding:0 12px;font-size:12px;text-transform:none;letter-spacing:.03em}.model-btn.active{background:#ffe100;border-color:#ffe100;color:#000}.model-btn.browse-btn{border-color:rgba(0,218,194,.55);color:#b2fff6}.model-btn.browse-btn:hover{background:#00dac2;border-color:#00dac2;color:#000}.emotion-layout{display:grid;grid-template-columns:minmax(0, 1fr) 340px;gap:14px;align-items:start}.emotion-configs{min-width:0}.emotion-preview-panel{position:sticky;top:10px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 12px;background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:18px 18px}.emotion-preview-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}.emotion-preview-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#00dac2}.emotion-preview-tag{font-size:12px;color:hsla(0,0%,100%,.78)}.emotion-preview-canvas{position:relative;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden;background:rgba(15,23,42,.95);border:1px solid hsla(0,0%,100%,.18)}.emotion-preview-interact{position:absolute;inset:0;z-index:3}.emotion-preview-empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;z-index:4;pointer-events:none;color:hsla(0,0%,100%,.78);font-size:12px}.emotion-preview-controls{margin-top:10px;display:flex;flex-direction:column;gap:8px}.emotion-zoom-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}.zoom-label{font-size:12px;color:hsla(0,0%,100%,.78)}.zoom-value{font-size:12px;color:#ffe100;font-variant-numeric:tabular-nums}.emotion-preview-actions{display:flex;gap:8px}.emotion-tag{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100;text-transform:uppercase}.emotion-map-table{margin-top:4px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.22);max-height:none;overflow:visible;background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:20px 20px}.emotion-map-head,.emotion-map-row{display:grid;grid-template-columns:72px 22px minmax(0, 1fr) minmax(0, 1fr) 52px;gap:10px;align-items:center}.emotion-map-head{position:sticky;top:0;z-index:2;padding:8px 10px;font-size:10px;color:hsla(0,0%,100%,.68);letter-spacing:.03em;background:rgba(2,8,20,.92);border-bottom:1px solid hsla(0,0%,100%,.2)}.emotion-map-row{padding:10px;border-bottom:1px solid hsla(0,0%,100%,.12)}.emotion-map-row:nth-child(odd){background:hsla(0,0%,100%,.02)}.emotion-map-tag{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100}.emotion-map-arrow{text-align:center;color:hsla(0,0%,100%,.78);font-size:18px;line-height:1}.emotion-map-preview-btn{min-width:0;width:44px;height:32px;padding:0;font-size:14px;line-height:1}.emotion-map-row select{width:100%;min-width:0;text-overflow:ellipsis;white-space:nowrap}.emotion-advanced-list{margin-top:10px;display:flex;flex-direction:column;gap:10px}.emotion-advanced-item{border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 2px;background-image:linear-gradient(rgba(255, 255, 255, 0.025) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.025) 1px, transparent 1px);background-size:18px 18px}.emotion-advanced-title{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:hsla(0,0%,100%,.85)}.advanced-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.04);font-size:11px;color:#d5d5d5;cursor:pointer;user-select:none;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%)}.advanced-toggle:hover{border-color:rgba(255,225,0,.65);color:#ffe100}.advanced-toggle .toggle-icon{width:12px;text-align:center;color:#00dac2}.advanced-params{margin-top:8px;padding-top:10px;border-top:1px dashed hsla(0,0%,100%,.2)}.about-card{margin-bottom:12px;padding:10px 12px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.26);background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:18px 18px}.about-title{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:#ffe100}.about-link{color:#00dac2;word-break:break-all;text-decoration:underline}.about-list{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.5;color:#d5d5d5}.status-badge{margin-left:8px;font-size:12px}.status-success{color:#00dac2}.status-fail{color:#ff9c94}.panel-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 18px 14px;border-top:1px solid hsla(0,0%,100%,.18);background:rgba(0,0,0,.36)}.btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn:disabled{opacity:.45;cursor:not-allowed}.btn{min-width:100px;height:34px;padding:0 14px;font-size:12px}.btn-primary{background:#ffe100;color:#000;border-color:#ffe100}.btn-secondary{background:hsla(0,0%,100%,.06);border-color:hsla(0,0%,100%,.3)}.btn-test{min-width:96px;background:rgba(0,218,194,.1);border-color:rgba(0,218,194,.6);color:#bcfff7}.btn-test:hover:not(:disabled){background:#00dac2;border-color:#00dac2;color:#000}.browser-overlay{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.browser-dialog::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.browser-dialog-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.gpt-model-dialog{width:min(1240px,100vw - 24px)}.gpt-model-editor-dialog{width:min(1080px,100vw - 24px)}.gpt-model-header{align-items:flex-start}.gpt-model-header-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}.gpt-model-header-actions .btn{min-width:84px;height:30px;padding:0 10px;font-size:11px}.gpt-model-body{display:flex;flex-direction:column;gap:10px}.gpt-model-tools{display:grid;grid-template-columns:minmax(0, 1fr) auto auto;gap:8px;align-items:center}.gpt-model-tools input{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.gpt-model-tools input:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.gpt-model-tools input::placeholder{color:#8d8d8d}.gpt-model-card-list{display:flex;flex-direction:column;gap:10px}.gpt-model-card{border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.03);padding:10px 12px;background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:18px 18px}.gpt-model-card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}.gpt-model-card-head label{display:inline-flex;align-items:center;gap:8px;font-size:12px}.gpt-model-id{font-size:11px;color:hsla(0,0%,100%,.65);font-family:"JetBrains Mono","Consolas","Courier New",monospace;word-break:break-all}.gpt-model-card-actions{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px}.gpt-model-card-actions .btn{min-width:110px}.gpt-ref-list{display:flex;flex-direction:column;gap:10px;margin-bottom:8px}.gpt-ref-item{border:1px solid hsla(0,0%,100%,.16);background:hsla(0,0%,100%,.02);padding:10px}.gpt-ref-actions{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}.gpt-expression-map-list{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}.gpt-expression-map-row{display:grid;grid-template-columns:minmax(0, 1fr) minmax(0, 1fr) auto;gap:8px;align-items:center}.gpt-expression-map-row input,.gpt-expression-map-row select{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.gpt-expression-map-row input:focus,.gpt-expression-map-row select:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.gpt-expression-map-row input::placeholder,.gpt-expression-map-row select::placeholder{color:#8d8d8d}.gpt-expression-map-row input,.gpt-expression-map-row select{width:100%}@media(max-width: 860px){.settings-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.settings-panel{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.settings-panel::before{width:40px}.panel-main{grid-template-columns:1fr;grid-template-rows:auto 1fr;min-height:0}.panel-nav{border-right:none;border-bottom:1px solid hsla(0,0%,100%,.16);display:flex;gap:6px;padding:8px 10px;overflow-x:auto;overflow-y:hidden}.panel-nav::-webkit-scrollbar{width:7px;height:7px}.panel-nav::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav::-webkit-scrollbar-thumb{background:#555}.panel-nav::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn{flex:0 0 auto;width:150px;min-height:42px;padding:6px 10px;margin-bottom:0;grid-template-areas:"idx label";grid-template-columns:auto 1fr;row-gap:0;align-items:center}.panel-body{min-height:0}.nav-index{font-size:16px}.nav-label{font-size:12px}.nav-sub{display:none}.browser-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.gpt-model-dialog,.gpt-model-editor-dialog{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px)}.gpt-model-tools{grid-template-columns:1fr}.gpt-expression-map-row{grid-template-columns:1fr}.emotion-layout{grid-template-columns:1fr}.emotion-preview-panel{order:-1;position:sticky;top:8px;z-index:8;margin-bottom:8px;padding:8px 10px 10px;background:rgba(0,0,0,.9)}.emotion-preview-header{margin-bottom:6px}.emotion-preview-canvas{aspect-ratio:16/9;max-height:210px}.emotion-preview-controls{margin-top:8px;gap:6px}.emotion-map-head{position:static}.emotion-preview-controls .hint{display:none}}@media(max-width: 620px){.settings-overlay{align-items:stretch;padding:0}.settings-panel{width:100vw;max-height:100dvh;border-left:none;border-right:none;box-shadow:none}.panel-header{padding:10px 12px}.header-title h3{font-size:15px;letter-spacing:.06em}.header-title p{display:none}.panel-nav{padding:6px 8px}.nav-btn{width:126px;min-height:38px;padding:5px 8px}.nav-index{font-size:14px}.nav-label{font-size:11px;letter-spacing:.04em}.close-btn{min-width:66px;height:28px;padding:0 8px;font-size:11px}.panel-footer{padding:10px 12px calc(10px + env(safe-area-inset-bottom))}.panel-body{padding:8px 10px}.form-row{flex-direction:column;gap:0}.input-with-btn{grid-template-columns:1fr}.btn{min-width:86px}.emotion-preview-panel{top:6px;padding:8px}.emotion-preview-canvas{max-height:180px}.emotion-map-head,.emotion-map-row{grid-template-columns:56px 16px minmax(0, 1fr) minmax(0, 1fr) 42px;gap:6px}.emotion-map-row{padding:8px}.emotion-map-arrow{font-size:14px}.emotion-map-preview-btn{width:38px;height:30px;font-size:12px}.browser-overlay{align-items:stretch;padding:0}.browser-dialog{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.gpt-model-dialog,.gpt-model-editor-dialog{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.browser-dialog-header{padding:12px}.browser-dialog-body{padding:10px 12px 12px}.gpt-model-header-actions{width:100%;justify-content:flex-start}.gpt-model-card-actions .btn{min-width:0;flex:1 1 120px}}'],sourceRoot:''}]);const s=i},678:(e,t,o)=>{var n=o(89);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('bd0944e8',n,!1,{ssrId:!0})},735:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.chat-bubble[data-v-98097aea]{position:fixed;transform:translate(-50%,-100%);max-width:320px;min-width:80px;animation:bubble-in-98097aea .22s ease-out;z-index:10004;pointer-events:none}.bubble-content[data-v-98097aea]{position:relative;background:rgba(14,14,14,.96);color:#fff;border:1px solid #ffe100;padding:9px 26px 10px 13px;clip-path:polygon(10px 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%,0 10px);font-size:12px;line-height:1.5;word-break:break-word;box-shadow:8px 8px 0 rgba(0,0,0,.56);font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;pointer-events:auto}.bubble-content[data-v-98097aea]::after{content:"";position:absolute;right:22px;bottom:-2px;width:30px;height:3px;background:#ffe100}.bubble-text[data-v-98097aea]{white-space:pre-wrap}.cursor[data-v-98097aea]{animation:blink-98097aea .64s infinite;margin-left:1px;color:#00dac2}.bubble-close[data-v-98097aea]{position:absolute;right:6px;top:5px;width:15px;height:15px;border:1px solid hsla(0,0%,100%,.3);background:hsla(0,0%,100%,.08);color:#fff;line-height:13px;text-align:center;cursor:pointer;font-size:10px;padding:0;font-family:"Oswald","Teko","Segoe UI",sans-serif}.bubble-close[data-v-98097aea]:hover{background:#ff3b30;border-color:#ff3b30}.bubble-arrow[data-v-98097aea]{width:11px;height:11px;background:rgba(14,14,14,.96);border-left:1px solid #ffe100;border-bottom:1px solid #ffe100;transform:rotate(-45deg);margin:0 auto;margin-top:-6px}@keyframes bubble-in-98097aea{from{opacity:0;transform:translateX(-50%) translateY(8px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}@keyframes blink-98097aea{0%,50%{opacity:1}51%,100%{opacity:0}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/ChatBubble.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,8BAAa,cAAe,CAAA,+BAAiC,CAAA,eAAgB,CAAA,cAAe,CAAA,0CAAkC,CAAA,aAAc,CAAA,mBAAoB,CAAA,iCAAgB,iBAAkB,CAAA,6BAA8B,CAAA,UAAW,CAAA,wBAAyB,CAAA,0BAA2B,CAAA,4FAAkG,CAAA,cAAe,CAAA,eAAgB,CAAA,qBAAsB,CAAA,oCAAqC,CAAA,gFAAiF,CAAA,mBAAoB,CAAA,wCAAuB,UAAW,CAAA,iBAAkB,CAAA,UAAW,CAAA,WAAY,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,8BAAa,oBAAqB,CAAA,yBAAQ,sCAA8B,CAAA,eAAgB,CAAA,aAAc,CAAA,+BAAc,iBAAkB,CAAA,SAAU,CAAA,OAAQ,CAAA,UAAW,CAAA,WAAY,CAAA,mCAAoC,CAAA,8BAA+B,CAAA,UAAW,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,cAAe,CAAA,cAAe,CAAA,SAAU,CAAA,iDAAkD,CAAA,qCAAoB,kBAAmB,CAAA,oBAAqB,CAAA,+BAAc,UAAW,CAAA,WAAY,CAAA,6BAA8B,CAAA,6BAA8B,CAAA,+BAAgC,CAAA,wBAAyB,CAAA,aAAc,CAAA,eAAgB,CAAA,8BAAqB,KAAK,SAAU,CAAA,qDAAsD,CAAA,GAAG,SAAU,CAAA,iDAAkD,CAAC,CAAA,0BAAiB,OAAO,SAAU,CAAA,SAAS,SAAU,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.chat-bubble{position:fixed;transform:translate(-50%, -100%);max-width:320px;min-width:80px;animation:bubble-in .22s ease-out;z-index:10004;pointer-events:none}.bubble-content{position:relative;background:rgba(14,14,14,.96);color:#fff;border:1px solid #ffe100;padding:9px 26px 10px 13px;clip-path:polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);font-size:12px;line-height:1.5;word-break:break-word;box-shadow:8px 8px 0 rgba(0,0,0,.56);font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;pointer-events:auto}.bubble-content::after{content:"";position:absolute;right:22px;bottom:-2px;width:30px;height:3px;background:#ffe100}.bubble-text{white-space:pre-wrap}.cursor{animation:blink .64s infinite;margin-left:1px;color:#00dac2}.bubble-close{position:absolute;right:6px;top:5px;width:15px;height:15px;border:1px solid hsla(0,0%,100%,.3);background:hsla(0,0%,100%,.08);color:#fff;line-height:13px;text-align:center;cursor:pointer;font-size:10px;padding:0;font-family:"Oswald","Teko","Segoe UI",sans-serif}.bubble-close:hover{background:#ff3b30;border-color:#ff3b30}.bubble-arrow{width:11px;height:11px;background:rgba(14,14,14,.96);border-left:1px solid #ffe100;border-bottom:1px solid #ffe100;transform:rotate(-45deg);margin:0 auto;margin-top:-6px}@keyframes bubble-in{from{opacity:0;transform:translateX(-50%) translateY(8px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}'],sourceRoot:''}]);const s=i},785:(e,t,o)=>{var n=o(814);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('82b08ae2',n,!1,{ssrId:!0})},790:e=>{e.exports=function(e){var t=e[1],o=e[3];if(!o)return t;if('function'==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(o)))),r='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(n),a='/*# '.concat(r,' */');return[t].concat([a]).join('\n')}return[t].join('\n')}},814:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),r=o.n(n),a=o(54),i=o.n(a)()(r());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.browser-overlay[data-v-f0a5fb30]{position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog[data-v-f0a5fb30]{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.browser-dialog[data-v-f0a5fb30]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog[data-v-f0a5fb30]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.browser-dialog-header[data-v-f0a5fb30]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3[data-v-f0a5fb30]{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn[data-v-f0a5fb30]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn[data-v-f0a5fb30]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn[data-v-f0a5fb30]:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn[data-v-f0a5fb30]{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body[data-v-f0a5fb30]{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body[data-v-f0a5fb30]::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body[data-v-f0a5fb30]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body[data-v-f0a5fb30]::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body[data-v-f0a5fb30]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media (max-width:860px){.browser-overlay[data-v-f0a5fb30]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog[data-v-f0a5fb30]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}}@media (max-width:620px){.browser-overlay[data-v-f0a5fb30]{align-items:stretch;padding:0}.browser-dialog[data-v-f0a5fb30]{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none;border-left:none;border-right:none}.browser-dialog-header[data-v-f0a5fb30]{padding:12px}.browser-dialog-body[data-v-f0a5fb30]{padding:10px 12px 12px}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/PetContainer.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,kCAAiB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,yBAA0B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,6BAA8B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,wCAAuB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,2CAA4C,CAAA,0BAA2B,CAAA,2CAA0B,QAAS,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,mDAAkC,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,wEAAuD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4DAA2C,WAAY,CAAA,kBAAmB,CAAA,mDAAkC,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,aAAc,CAAA,cAAe,CAAA,sCAAqB,sBAAuB,CAAA,aAAc,CAAA,MAAO,CAAA,yDAAwC,SAAU,CAAA,UAAW,CAAA,+DAA8C,8BAA+B,CAAA,+DAA8C,eAAgB,CAAA,qEAAoD,kBAAmB,CAAA,yBAAyB,kCAAiB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAC,CAAA,yBAAyB,kCAAiB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,eAAgB,CAAA,cAAe,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,wCAAuB,YAAa,CAAA,sCAAqB,sBAAuB,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.browser-overlay{position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.browser-dialog::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.browser-dialog-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media(max-width: 860px){.browser-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}}@media(max-width: 620px){.browser-overlay{align-items:stretch;padding:0}.browser-dialog{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none;border-left:none;border-right:none}.browser-dialog-header{padding:12px}.browser-dialog-body{padding:10px 12px 12px}}'],sourceRoot:''}]);const s=i},908:(e,t,o)=>{var n=o(735);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('266a4174',n,!1,{ssrId:!0})}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var o=a[e]={id:e,exports:{}};return r[e](o,o.exports,i),o.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var o in t)i.o(t,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const s=Vue,l='酒馆桌面宠物',c='DesktopPetPluginDB',d='live2dModels',A='sdkCache',u='local://desktop-pet/',p='default',m=`${u}${p}`,h='__desktop_pet_empty_motion_group__',f=(Object.freeze(['https://gcore.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js','https://unpkg.com/live2dcubismcore@1.0.2/live2dcubismcore.min.js','https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js']),Object.freeze(['https://cdn.jsdelivr.net/gh/bigmalove/galgame@main/dist/live2dcubismcore.min.js','https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/live2dcubismcore.min.js']),Object.freeze(['https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.runtime.min.js','https://cdn.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.js','https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.js']),[{name:'Haru (Cubism 4)',path:'haru/haru_greeter_t03.model3.json'},{name:'Shizuku (Cubism 2)',path:'shizuku/shizuku.model.json'}]),g=['毒舌吐槽','可爱卖萌','冷静分析','傲娇','自定义'],b=[{value:'user',label:'用户发送后评论'},{value:'ai',label:'AI回复后评论'},{value:'both',label:'同时评论'}],y=['默认','微笑','生气','难过','惊讶','嘲讽','害羞','思考','大笑','搞怪'],x=[{value:'openai',label:'OpenAI (兼容)'},{value:'claude',label:'Claude'},{value:'makersuite',label:'Google Gemini'},{value:'openrouter',label:'OpenRouter'}],v='https://cdn.jsdelivr.net/gh/Eikanya/Live2d-model@master/',C='https://raw.githubusercontent.com/Eikanya/Live2d-model/master/',w='shizuku/shizuku.model.json',B=.3,S={x:-1,y:-1},k=!0,E=!0,V=!0,M='ai',T='毒舌吐槽',N='',P=!1,L=!1,D=!0,U=3,I=60,R=10,W=!1,F=!1,O=!0,j=!1,G=150,q=.9,Y=0,J=0,H=1,X=0,K=-1,Q=z;function Z(e){return!!e&&'object'==typeof e&&!Array.isArray(e)}const ee=new Set(y);function te(e){const t=String(e||'').trim();return t&&ee.has(t)?t:null}const oe={默认:['普通','normal','default','neutral','idle','base'],微笑:['开心','笑','smile','happy','joy','glad'],生气:['愤怒','angry','mad','rage'],难过:['伤心','sad','cry','sorrow','upset'],惊讶:['震惊','surprised','shock','amazed','wow'],嘲讽:['轻蔑','smirk','mock','sneer','tease','sarcastic'],害羞:['脸红','shy','blush','embarrassed','bashful'],思考:['疑惑','think','ponder','confused','wonder','curious'],大笑:['笑死','laugh','lol','haha','giggle','rofl'],搞怪:['调皮','wink','playful','silly','mischievous','fun']};function ne(e){const t=[],o=new Set;for(const n of Array.isArray(e)?e:[]){const e=String(n||'').trim();if(!e)continue;const r=e.toLowerCase();o.has(r)||(o.add(r),t.push(e))}return t}function re(){return y.map(e=>({tag:e,aliases:[...oe[e]??[]],ttsContext:'',live2dExpression:'',live2dMotion:{enabled:!0,group:'',index:0}}))}function ae(e){const t=new Map;for(const o of Array.isArray(e)?e:[]){if(!Z(o))continue;const e=te(o.tag);if(!e)continue;if(t.has(e))continue;const n=Z(o.live2dMotion)?o.live2dMotion:{},r=!1!==n.enabled,a=String(n.group||'').trim(),i=Number(n.index),s=Number.isFinite(i)?Math.max(0,Math.floor(i)):0,l={tag:e,aliases:ne(Array.isArray(o.aliases)?o.aliases.map(e=>String(e||'').trim()).filter(Boolean):[]),ttsContext:String(o.ttsContext||'').trim(),live2dExpression:String(o.live2dExpression||'').trim(),live2dMotion:{enabled:r,group:a,index:s}};t.set(e,l)}const o=re();for(const e of o)t.has(e.tag)||t.set(e.tag,e);return y.map(e=>t.get(e)).map(e=>({tag:e.tag,aliases:ne(e.aliases),ttsContext:String(e.ttsContext||'').trim(),live2dExpression:String(e.live2dExpression||'').trim(),live2dMotion:{enabled:!1!==e.live2dMotion?.enabled,group:String(e.live2dMotion?.group||'').trim(),index:Number.isFinite(e.live2dMotion?.index)?Math.max(0,Math.floor(e.live2dMotion.index)):0}}))}function ie(e,t){for(const o of Array.isArray(t)?t:[])if(o?.tag===e)return o;return null}function se(e,t){const o=String(e||'').trim();if(!o)return null;const n=te(o);if(n)return n;const r=o.toLowerCase();for(const e of Array.isArray(t)?t:[]){const t=Array.isArray(e?.aliases)?e.aliases:[];for(const o of t)if(String(o||'').trim().toLowerCase()===r){const t=te(e.tag);if(t)return t}}return null}function le(){try{const e=window.parent??window;if(e.console)return e.console}catch{}return console}function ce(...e){le().log(`[${l}]`,...e)}function de(...e){le().warn(`[${l}]`,...e)}function Ae(...e){le().error(`[${l}]`,...e)}function ue(e,t){if(!e||'object'!=typeof e)return;if(0===t.length)return;let o=e;for(let e=0;e<t.length-1;e++){const n=t[e];if(!o||'object'!=typeof o)return;o=o[n]}const n=t[t.length-1];o&&'object'==typeof o&&(Array.isArray(o)&&'number'==typeof n?o[n]=void 0:delete o[n])}function pe(e){const t=(o=e)&&'object'==typeof o&&!Array.isArray(o)?e:{};var o;const r=me.safeParse(t);if(r.success)return r.data;const a=n(t);for(const e of r.error.issues)ue(a,e.path);const i=me.safeParse(a);return i.success?(de('检测到非法设置，已自动修正为默认值',r.error.issues),i.data):(Ae('设置解析失败，已回退默认值',r.error),me.parse({}))}const me=Q.z.object({apiMode:Q.z.enum(['custom','tavern']).default('tavern'),apiConfig:Q.z.object({url:Q.z.string().default(''),apiKey:Q.z.string().default(''),model:Q.z.string().default('gpt-4o-mini'),source:Q.z.string().default('openai'),max_tokens:Q.z.number().min(1).max(4096).default(G),temperature:Q.z.number().min(0).max(2).default(q),frequency_penalty:Q.z.number().min(-2).max(2).default(Y),presence_penalty:Q.z.number().min(-2).max(2).default(J),top_p:Q.z.number().min(0).max(1).default(H),top_k:Q.z.number().min(0).max(500).default(X),usePresetSampling:Q.z.boolean().default(!1),sendWorldInfo:Q.z.boolean().default(!1)}).default({}),modelPath:Q.z.string().default(w),useCdn:Q.z.boolean().default(!0),petPosition:Q.z.object({x:Q.z.number().default(S.x),y:Q.z.number().default(S.y)}).default({}),petScale:Q.z.number().min(.1).max(3).default(B),autoMotionLoop:Q.z.boolean().default(k),doubleTapRandomMotionEnabled:Q.z.boolean().default(E),gazeFollowMouseEnabled:Q.z.boolean().default(V),commentStyle:Q.z.enum(g).default(T),commentTriggerMode:Q.z.enum(['user','ai','both']).default(M),customPrompt:Q.z.string().default(''),roleplayName:Q.z.string().default(N),roleplayIgnoreCommentStyle:Q.z.boolean().default(P),sendCharacterCardContent:Q.z.boolean().default(L),autoTrigger:Q.z.boolean().default(D),triggerInterval:Q.z.number().min(1).max(100).default(U),triggerProbability:Q.z.number().min(0).max(100).default(I),maxChatContext:Q.z.number().min(1).max(50).default(R),bubbleDuration:Q.z.number().min(-1).max(6e5).default(K),useTamakoTodaySpecial:Q.z.boolean().default(W),useDiceDatabaseReference:Q.z.boolean().default(F),diceReferenceVisibleSheets:Q.z.array(Q.z.string()).default([]),emotionCotEnabled:Q.z.boolean().default(!0),emotionCotStripFromText:Q.z.boolean().default(!0),emotionConfigs:Q.z.array(Q.z.object({tag:Q.z.enum(y).default('榛樿'),aliases:Q.z.array(Q.z.string()).default([]),ttsContext:Q.z.string().default(''),live2dExpression:Q.z.string().default(''),live2dMotion:Q.z.object({enabled:Q.z.boolean().default(!0),group:Q.z.string().default(''),index:Q.z.number().min(0).max(999).default(0)}).default({})}).default({})).default([]),ttsProvider:Q.z.enum(['littlewhitebox','gpt_sovits_v2','edge_tts_direct']).default('littlewhitebox'),ttsAutoPlay:Q.z.boolean().default(!0),phoneMessageAutoRead:Q.z.boolean().default(O),baibaiPhoneMessageAutoRead:Q.z.boolean().default(j),ttsDefaultSpeaker:Q.z.string().default(''),lipSyncManualParamsEnabled:Q.z.boolean().default(!1),lipSyncManualParamIds:Q.z.array(Q.z.string()).default([]),gptSoVits:Q.z.object({apiUrl:Q.z.string().default('http://127.0.0.1:9880'),endpoint:Q.z.string().default('/tts'),useCorsProxy:Q.z.boolean().default(!0),mediaType:Q.z.enum(['wav','ogg','raw']).default('wav'),streamingMode:Q.z.boolean().default(!0),textLang:Q.z.string().default('auto'),textSplitMethod:Q.z.string().default('cut5'),speedFactor:Q.z.number().min(.1).max(3).default(1),strictWeightSwitch:Q.z.boolean().default(!1),probeOnAudioError:Q.z.boolean().default(!1),modelSwitchMode:Q.z.enum(['none','set_model','set_weights']).default('set_weights'),setModelEndpoint:Q.z.string().default('/set_model'),rootDir:Q.z.string().default(''),importPathPrefix:Q.z.string().default(''),models:Q.z.array(Q.z.object({id:Q.z.string().default(''),name:Q.z.string().default(''),enabled:Q.z.boolean().default(!0),desc:Q.z.string().default(''),paths:Q.z.object({gptWeightsPath:Q.z.string().default(''),sovitsWeightsPath:Q.z.string().default(''),defaultRefAudioPath:Q.z.string().default('')}).default({}),params:Q.z.object({promptText:Q.z.string().default(''),promptLang:Q.z.string().default('zh'),textLang:Q.z.string().default('auto'),textSplitMethod:Q.z.string().default('cut5'),speedFactor:Q.z.number().min(.1).max(3).default(1),mediaType:Q.z.enum(['wav','ogg','raw']).default('wav'),streamingMode:Q.z.boolean().default(!0),modelSwitchMode:Q.z.enum(['none','set_model','set_weights']).default('set_weights'),setModelEndpoint:Q.z.string().default('/set_model'),strictWeightSwitch:Q.z.boolean().default(!1)}).default({}),refAudios:Q.z.array(Q.z.object({id:Q.z.string().default(''),name:Q.z.string().default(''),path:Q.z.string().default(''),promptText:Q.z.string().default(''),promptLang:Q.z.string().default('zh'),textLang:Q.z.string().default('auto')}).default({})).default([]),defaultRefId:Q.z.string().default(''),expressionRefMap:Q.z.record(Q.z.string(),Q.z.string()).default({})}).default({})).default([]),voices:Q.z.array(Q.z.object({name:Q.z.string().default(''),desc:Q.z.string().default(''),refAudioPath:Q.z.string().default(''),promptText:Q.z.string().default(''),promptLang:Q.z.string().default(''),textLang:Q.z.string().default(''),gptWeightsPath:Q.z.string().default(''),sovitsWeightsPath:Q.z.string().default(''),modelSwitchMode:Q.z.enum(['none','set_model','set_weights']).default('set_weights'),setModelEndpoint:Q.z.string().default('/set_model'),strictWeightSwitch:Q.z.boolean().default(!1)}).default({})).default([])}).default({})}).default({}),he=t('desktop-pet-settings',()=>{const e=pe(getVariables({type:'script',script_id:getScriptId()}));(e.modelPath.includes('live2d-widget-model/')||e.modelPath.includes('Live2D/Samples/'))&&(e.modelPath=w),e.emotionConfigs=ae(e.emotionConfigs);const t=Number(e.bubbleDuration);if(Number.isFinite(t)){const o=t>600?t/1e3:t;e.bubbleDuration=Math.round(Math.max(-1,Math.min(600,o)))}else e.bubbleDuration=K;const o=(0,s.ref)(e);return(0,s.watchEffect)(()=>{replaceVariables(n(o.value),{type:'script',script_id:getScriptId()})}),{settings:o,updateSettings:function(e){o.value=me.parse({...n(o.value),...e}),o.value.emotionConfigs=ae(o.value.emotionConfigs)},resetSettings:function(){const e=me.parse({});e.emotionConfigs=ae(e.emotionConfigs),o.value=e}}}),fe='speech.platform.bing.com/consumer/speech/synthesize/readaloud',ge='6A5AA1D4EAFF4E9FB37E23D68491D6F4',be=`wss://${fe}/edge/v1?TrustedClientToken=${ge}`,ye=`https://${fe}/voices/list?trustedclienttoken=${ge}`;let xe=0;const ve=[{shortName:'zh-CN-XiaoxiaoNeural',locale:'zh-CN',gender:'Female'},{shortName:'zh-CN-YunxiNeural',locale:'zh-CN',gender:'Male'},{shortName:'zh-CN-YunyangNeural',locale:'zh-CN',gender:'Male'},{shortName:'zh-CN-XiaoyiNeural',locale:'zh-CN',gender:'Female'},{shortName:'en-US-JennyNeural',locale:'en-US',gender:'Female'},{shortName:'en-US-AriaNeural',locale:'en-US',gender:'Female'},{shortName:'en-US-GuyNeural',locale:'en-US',gender:'Male'},{shortName:'ja-JP-NanamiNeural',locale:'ja-JP',gender:'Female'},{shortName:'ja-JP-KeitaNeural',locale:'ja-JP',gender:'Male'}];function Ce(e='Aborted'){try{return new DOMException(e,'AbortError')}catch{const t=new Error(e);return t.name='AbortError',t}}function we(){const e=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(e);else for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e[6]=15&e[6]|64,e[8]=63&e[8]|128,Array.from(e,e=>e.toString(16).padStart(2,'0')).join('')}function Be(e){let t='';for(let o=0;o<e.length;o++){const n=e.charCodeAt(o);t+=n>=0&&n<=8||11===n||12===n||n>=14&&n<=31?' ':e[o]}return t}function Se(e){return'string'==typeof e?e.trim():String(e.value||e.name||'').trim()}async function _e(e){const t=(new TextEncoder).encode(e),o=globalThis.crypto?.subtle;if(o?.digest)try{const e=await o.digest('SHA-256',t);return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,'0')).join('').toUpperCase()}catch{}return function(e){const t=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),o=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),n=e.length+1,r=64*Math.ceil((n+8)/64),a=new Uint8Array(r);a.set(e),a[e.length]=128;const i=8*e.length,s=Math.floor(i/4294967296),l=i>>>0;a[r-8]=s>>>24&255,a[r-7]=s>>>16&255,a[r-6]=s>>>8&255,a[r-5]=255&s,a[r-4]=l>>>24&255,a[r-3]=l>>>16&255,a[r-2]=l>>>8&255,a[r-1]=255&l;const c=new Uint32Array(64);for(let e=0;e<a.length;e+=64){for(let t=0;t<16;t++){const o=e+4*t;c[t]=(a[o]<<24|a[o+1]<<16|a[o+2]<<8|a[o+3])>>>0}for(let e=16;e<64;e++){const t=ke(c[e-15],7)^ke(c[e-15],18)^c[e-15]>>>3,o=ke(c[e-2],17)^ke(c[e-2],19)^c[e-2]>>>10;c[e]=c[e-16]+t+c[e-7]+o>>>0}let n=o[0],r=o[1],i=o[2],s=o[3],l=o[4],d=o[5],A=o[6],u=o[7];for(let e=0;e<64;e++){const o=u+(ke(l,6)^ke(l,11)^ke(l,25))+(l&d^~l&A)+t[e]+c[e]>>>0,a=n&r^n&i^r&i;u=A,A=d,d=l,l=s+o>>>0,s=i,i=r,r=n,n=o+((ke(n,2)^ke(n,13)^ke(n,22))+a>>>0)>>>0}o[0]=o[0]+n>>>0,o[1]=o[1]+r>>>0,o[2]=o[2]+i>>>0,o[3]=o[3]+s>>>0,o[4]=o[4]+l>>>0,o[5]=o[5]+d>>>0,o[6]=o[6]+A>>>0,o[7]=o[7]+u>>>0}return Array.from(o).map(e=>e.toString(16).padStart(8,'0')).join('').toUpperCase()}(t)}function ke(e,t){return(e>>>t|e<<32-t)>>>0}async function Ee(){try{let e=Date.now()/1e3+xe;e+=11644473600,e-=e%300,e*=1e7;return{security:{secMsGec:await _e(`${e.toFixed(0)}${ge}`),secMsGecVersion:'1-143.0.3537.57'},error:''}}catch(e){return{security:null,error:e instanceof Error?e.message:String(e)}}}function Ve(e){const t=String(e.ShortName||'').trim();if(!t)return null;const o=String(e.Locale||'').trim(),n=String(e.Gender||'').trim();return{name:t,value:t,source:'edge_tts_direct',resourceId:null,desc:[String(e.FriendlyName||'').trim(),o,n].filter(Boolean).join(' | ')||'EdgeTTS Direct'}}async function Me(e){const t=await fetch(e,{headers:{Accept:'*/*','Accept-Language':'en-US,en;q=0.9'}}),o=function(e){const t=e.headers.get('date')||e.headers.get('Date');if(!t)return null;const o=new Date(t).getTime();return Number.isFinite(o)?o/1e3:null}(t);if(null!==o){const e=Date.now()/1e3+xe;xe+=o-e}if(!t.ok)throw new Error(`EdgeTTS voices request failed (HTTP ${t.status})`);const n=await t.json();if(!Array.isArray(n))throw new Error('EdgeTTS voices response is not an array');return function(e){const t=new Set,o=[];for(const n of e){const e=String(n.value||n.name||'').trim().toLowerCase();e&&!t.has(e)&&(t.add(e),o.push(n))}return o.sort((e,t)=>e.name.localeCompare(t.name))}(n.map(Ve).filter(Boolean))}function Te(){return ve.map(e=>({name:e.shortName,value:e.shortName,source:'edge_tts_direct',resourceId:null,desc:`${e.locale} | ${e.gender}`}))}async function Ne(e,t,o,n,r,a){const i=Number.isFinite(n.timeoutMs)?Math.max(3e3,Number(n.timeoutMs)):25e3;return new Promise((s,l)=>{let c=!1,d=null,A=null;const u=[];let p=!1,m=!1,h=0,f='',g=!1;const b=e=>{c||(c=!0,null!==A&&window.clearTimeout(A),d&&(d.onopen=null,d.onmessage=null,d.onerror=null,d.onclose=null),n.onSocket?.(null),n.signal&&n.signal.removeEventListener('abort',x),e())},y=e=>{b(()=>l(e instanceof Error?e:new Error(String(e))))},x=()=>{try{d?.close(1e3,'abort')}catch{}y(Ce('EdgeTTS direct synthesis aborted'))};n.signal?.aborted?y(Ce('EdgeTTS direct synthesis aborted')):(n.signal&&n.signal.addEventListener('abort',x,{once:!0}),d=new WebSocket(e),d.binaryType='arraybuffer',n.onSocket?.(d),A=window.setTimeout(()=>{try{d?.close(1013,'timeout')}catch{}y(new Error(`EdgeTTS direct websocket timeout (${a})`))},i),d.onopen=()=>{m=!0;const e=function(e='utc_string'){const t=new Date;return'iso_compact'===e?t.toISOString().replace(/[-:.]/g,'').slice(0,-1):t.toUTCString().replace('GMT','GMT+0000 (Coordinated Universal Time)')}(r);d?.send(function(e){return`X-Timestamp:${e}\r\nContent-Type:application/json; charset=utf-8\r\nPath:speech.config\r\n\r\n{"context":{"synthesis":{"audio":{"metadataoptions":{"sentenceBoundaryEnabled":"false","wordBoundaryEnabled":"true"},"outputFormat":"audio-24khz-48kbitrate-mono-mp3"}}}}\r\n`}(e)),d?.send(function(e,t,o){return`X-RequestId:${e}\r\nContent-Type:application/ssml+xml\r\nX-Timestamp:${t}Z\r\nPath:ssml\r\n\r\n${o}`}(we(),e,function(e,t){const o=Se(t),n=function(e){return e.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;')}(Be(String(e||'')));return`<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='en-US'><voice name='${o}'><prosody pitch='+0Hz' rate='+0%' volume='+0%'>${n}</prosody></voice></speak>`}(t,o)))},d.onmessage=e=>{if(c)return;if('string'==typeof e.data){const t=function(e){const t=e.indexOf('\r\n\r\n'),o=t>=0?e.slice(0,t):e,n={};for(const e of o.split('\r\n')){const t=e.indexOf(':');t<=0||(n[e.slice(0,t)]=e.slice(t+1).trim())}return n}(e.data);if('turn.end'===String(t.Path||t.path||'').toLowerCase())try{d?.close(1e3,'turn.end')}catch{}return}(async()=>{const t=e.data;let o=null;if(t instanceof ArrayBuffer?o=new Uint8Array(t):ArrayBuffer.isView(t)?o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof Blob&&(o=new Uint8Array(await t.arrayBuffer())),!o||o.length<2)return;const{headers:n,payload:r}=function(e){if(e.length<2)return{headers:{},payload:new Uint8Array(0)};const t=e[0]<<8|e[1];if(t<=0||t+2>e.length)return{headers:{},payload:e.slice(2)};const o={},n=e.slice(2,t+2),r=(new TextDecoder).decode(n);for(const e of r.split('\r\n')){const t=e.indexOf(':');t<=0||(o[e.slice(0,t)]=e.slice(t+1).trim())}return{headers:o,payload:e.slice(t+2)}}(o);if('audio'!==String(n.Path||n.path||'').toLowerCase())return;const a=String(n['Content-Type']||n['content-type']||'').toLowerCase();a&&!a.startsWith('audio/')||r.length>0&&u.push(r)})().catch(y)},d.onerror=()=>{p=!0},d.onclose=e=>{if(h=e.code,f=String(e.reason||'').trim(),g=!!e.wasClean,c)return;if(n.signal?.aborted)return void y(Ce('EdgeTTS direct synthesis aborted'));if(u.length<=0)return void y(new Error(`No audio frame received from EdgeTTS direct websocket (${a}; code=${h}, clean=${g}, opened=${m}, errorEvent=${p}, reason=${f||'n/a'})`));const t=function(e){if(0===e.length)return new Uint8Array(0);if(1===e.length)return e[0];const t=e.reduce((e,t)=>e+t.length,0),o=new Uint8Array(t);let n=0;for(const t of e)o.set(t,n),n+=t.length;return o}(u),o=new Blob([t],{type:'audio/mpeg'});b(()=>s(o))})})}const Pe={LITTLEWHITEBOX:'littlewhitebox',GPT_SOVITS_V2:'gpt_sovits_v2',EDGE_TTS_DIRECT:'edge_tts_direct'};function Le(e){return String(e||'').replace(/\\/g,'/')}function De(){try{return window.parent??window}catch{return window}}function $e(){try{if('function'==typeof getScriptId){const e=String(getScriptId()??'').trim();if(e)return e}}catch{}return l}function Ue(){return`${$e()}_tts_enabled`}function Ie(){return`${$e()}_char_tts_voice`}function ze(e){const t=String(e||'').trim().toLowerCase();return'none'===t||'off'===t||'disabled'===t?'none':'set_model'===t||'model'===t?'set_model':'set_weights'}function Re(e){const t=String(e||'').trim();return t?t.startsWith('/')?t:`/${t}`:'/set_model'}function We(e,t){const o=Number(e);return Number.isFinite(o)?o:t}function Fe(e){return e&&'object'==typeof e?e:{}}function Oe(e){return Array.isArray(e)?e:[]}function je(e='model'){return`${String(e||'model').trim().replace(/[^\w\u4e00-\u9fff.-]+/g,'_').replace(/^_+|_+$/g,'').toLowerCase()||'model'}_${Date.now().toString(36)}_${Math.floor(1e6*Math.random()).toString(36)}`}function Ge(e,t=0,o={}){const n=Fe(e),r=Le(String(n.path||n.refAudioPath||n.ref_audio_path||'').trim());if(!r)return null;const a=(String(n.id||n.refId||'').trim()||`ref_${t+1}`).replace(/[^\w\u4e00-\u9fff.-]+/g,'_');return{id:a,name:String(n.name||n.label||a||`参考音频${t+1}`).trim()||`参考音频${t+1}`,path:r,promptText:String(n.promptText||n.prompt_text||o.promptText||'').trim(),promptLang:String(n.promptLang||n.prompt_lang||o.promptLang||'zh').trim()||'zh',textLang:String(n.textLang||n.text_lang||o.textLang||'auto').trim()||'auto'}}function qe(e,t,o=0){const n=Fe(e),r=Fe(n.paths),a=Fe(n.params),i=String(n.name||n.modelName||n.voice||n.speaker||'').trim();if(!i)return null;const s=String(n.id||'').trim().replace(/[^\w\u4e00-\u9fff.-]+/g,'_')||je(i||`model_${o+1}`),l={promptText:String(a.promptText||a.prompt_text||n.promptText||n.prompt_text||'').trim(),promptLang:String(a.promptLang||a.prompt_lang||n.promptLang||n.prompt_lang||'zh').trim()||'zh',textLang:String(a.textLang||a.text_lang||n.textLang||n.text_lang||t.textLang||'auto').trim()||'auto',textSplitMethod:String(a.textSplitMethod||a.text_split_method||n.textSplitMethod||n.text_split_method||t.textSplitMethod||'cut5').trim()||'cut5',speedFactor:We(a.speedFactor??a.speed_factor??n.speedFactor??n.speed_factor,We(t.speedFactor,1)),mediaType:String(a.mediaType||a.media_type||n.mediaType||n.media_type||t.mediaType||'wav').trim()||'wav',streamingMode:!!(a.streamingMode??a.streaming_mode??n.streamingMode??n.streaming_mode??t.streamingMode),modelSwitchMode:ze(a.modelSwitchMode||n.modelSwitchMode||t.modelSwitchMode||'set_weights'),setModelEndpoint:Re(a.setModelEndpoint||n.setModelEndpoint||t.setModelEndpoint||'/set_model'),strictWeightSwitch:!!(a.strictWeightSwitch??n.strictWeightSwitch??t.strictWeightSwitch)},c=Le(String(r.gptWeightsPath||r.gpt_weights_path||n.gptWeightsPath||n.gpt_weights_path||'').trim()),d=Le(String(r.sovitsWeightsPath||r.sovits_weights_path||n.sovitsWeightsPath||n.sovits_weights_path||'').trim()),A=Le(String(r.defaultRefAudioPath||n.defaultRefAudioPath||n.refAudioPath||n.ref_audio_path||'').trim()),u=[...Oe(n.refAudios),...Oe(n.references),...Oe(n.refAudioList)];A&&u.unshift({id:String(n.defaultRefId||'ref_default').trim()||'ref_default',name:'默认',path:A,promptText:l.promptText,promptLang:l.promptLang,textLang:l.textLang});const p=[],m=new Set,h=new Set;for(const[e,t]of u.entries()){const o=Ge(t,e,l);if(!o)continue;if(h.has(o.path))continue;let n=o.id||`ref_${p.length+1}`,r=2;for(;m.has(n);)n=`${o.id}_${r++}`;o.id=n,m.add(n),h.add(o.path),p.push(o)}let f=String(n.defaultRefId||'').trim();f&&!p.some(e=>e.id===f)&&(f=''),!f&&A&&(f=p.find(e=>e.path===A)?.id||''),!f&&p.length>0&&(f=p[0].id);const g=p.find(e=>e.id===f)?.path||A||p[0]?.path||'',b=Fe(n.expressionRefMap||n.expressionMap),y={};return Object.entries(b).forEach(([e,t])=>{const o=String(e||'').trim(),n=String(t||'').trim();o&&n&&p.some(e=>e.id===n)&&(y[o]=n)}),{id:s,name:i,enabled:!1!==n.enabled,desc:String(n.desc||n.description||'').trim(),paths:{gptWeightsPath:c,sovitsWeightsPath:d,defaultRefAudioPath:g},params:l,refAudios:p,defaultRefId:f,expressionRefMap:y}}function Ye(e,t){const o=[],n=new Set,r=new Set;for(const[a,i]of Oe(e).entries()){const e=qe(i,t,a);if(!e)continue;let s=e.id;for(;n.has(s);)s=je(s);e.id=s,n.add(s);const l=e.name;let c=l,d=2;for(;r.has(c);)c=`${l}_${d++}`;e.name=c,r.add(c),o.push(e)}return o}function Je(e,t){if(!e||!1===e.enabled)return null;const o=Oe(e.refAudios),n=o.find(t=>t.id===e.defaultRefId)||o.find(t=>t.path===e.paths?.defaultRefAudioPath)||o[0]||null,r=Fe(e.params),a=String(n?.promptText||r.promptText||'').trim(),i=String(n?.promptLang||r.promptLang||'zh').trim()||'zh',s=String(n?.textLang||r.textLang||t.textLang||'auto').trim()||'auto';return{name:e.name,value:e.name,source:Pe.GPT_SOVITS_V2,resourceId:null,desc:e.desc||'GPT-SoVITS',gptSoVitsModel:e,gptSoVits:{refAudioPath:String(n?.path||e.paths?.defaultRefAudioPath||'').trim(),promptText:a,promptLang:i,textLang:s,gptWeightsPath:String(e.paths?.gptWeightsPath||'').trim(),sovitsWeightsPath:String(e.paths?.sovitsWeightsPath||'').trim(),textSplitMethod:String(r.textSplitMethod||t.textSplitMethod||'cut5').trim()||'cut5',speedFactor:We(r.speedFactor,We(t.speedFactor,1)),mediaType:String(r.mediaType||t.mediaType||'wav').trim()||'wav',streamingMode:!!(r.streamingMode??t.streamingMode),modelSwitchMode:ze(r.modelSwitchMode||t.modelSwitchMode||'set_weights'),setModelEndpoint:Re(r.setModelEndpoint||t.setModelEndpoint||'/set_model'),strictWeightSwitch:!!(r.strictWeightSwitch??t.strictWeightSwitch)}}}function He(){try{return he().settings.ttsProvider||Pe.LITTLEWHITEBOX}catch{return Pe.LITTLEWHITEBOX}}function Xe(){const e={apiUrl:'http://127.0.0.1:9880',endpoint:'/tts',useCorsProxy:!0,mediaType:'wav',streamingMode:!1,textLang:'auto',textSplitMethod:'cut5',speedFactor:1,strictWeightSwitch:!1,probeOnAudioError:!1,modelSwitchMode:'set_weights',setModelEndpoint:'/set_model',rootDir:'',importPathPrefix:'',models:[],voices:[]};try{const t=he().settings.gptSoVits||{},o=Le(String(t.rootDir||t.importPathPrefix||'').trim()),n=Le(String(t.importPathPrefix||o||'').trim()),r=Object.assign(Object.assign({},e),t,{modelSwitchMode:ze(t.modelSwitchMode||e.modelSwitchMode),setModelEndpoint:Re(t.setModelEndpoint||e.setModelEndpoint),rootDir:o||n,importPathPrefix:n||o,models:Array.isArray(t.models)?t.models:e.models,voices:Array.isArray(t.voices)?t.voices:e.voices}),a=r.models.length>0?Ye(r.models,r):function(e,t){const o=[];for(const[n,r]of Oe(e).entries()){const e=Qe(r,t);e&&o.push({id:je(e.name||`model_${n+1}`),name:e.name||`模型${n+1}`,enabled:!0,desc:e.desc||'',paths:{gptWeightsPath:e.gptWeightsPath||'',sovitsWeightsPath:e.sovitsWeightsPath||'',defaultRefAudioPath:e.refAudioPath||''},params:{promptText:e.promptText||'',promptLang:e.promptLang||'zh',textLang:e.textLang||t.textLang||'auto',textSplitMethod:t.textSplitMethod||'cut5',speedFactor:We(t.speedFactor,1),mediaType:t.mediaType||'wav',streamingMode:!!t.streamingMode,modelSwitchMode:ze(t.modelSwitchMode||'set_weights'),setModelEndpoint:Re(t.setModelEndpoint||'/set_model'),strictWeightSwitch:!!t.strictWeightSwitch},refAudios:e.refAudioPath?[{id:'ref_default',name:'默认',path:e.refAudioPath,promptText:e.promptText||'',promptLang:e.promptLang||'zh',textLang:e.textLang||t.textLang||'auto'}]:[],defaultRefId:e.refAudioPath?'ref_default':'',expressionRefMap:{}})}return Ye(o,t)}(r.voices,r);return Object.assign({},r,{models:a})}catch{return e}}function Ke(e){if(!e)return null;const t=e?.gptSoVits||{},o=String(e.name||e.voice||e.speaker||t.name||'').trim();if(!o)return null;const n=Le(String(e.refAudioPath||e.ref_audio_path||e.ref_audio||e.ref||t.refAudioPath||'').trim()),r=String(e.promptText||e.prompt_text||t.promptText||'').trim(),a=String(e.promptLang||e.prompt_lang||t.promptLang||'').trim(),i=String(e.textLang||e.text_lang||t.textLang||'').trim(),s=Le(String(e.gptWeightsPath||e.gpt_weights_path||e.gptPath||e.gpt||t.gptWeightsPath||'').trim()),l=Le(String(e.sovitsWeightsPath||e.sovits_weights_path||e.sovitsPath||e.sovits||t.sovitsWeightsPath||'').trim()),c=ze(e.modelSwitchMode||e.model_switch_mode||t.modelSwitchMode||''),d=Re(e.setModelEndpoint||e.set_model_endpoint||t.setModelEndpoint||'/set_model'),A=!!(e.strictWeightSwitch??e.strict_weight_switch??t.strictWeightSwitch),u=String(e.desc||e.description||'').trim();return{name:o,value:o,source:Pe.GPT_SOVITS_V2,resourceId:null,desc:u||'GPT-SoVITS',gptSoVits:{refAudioPath:n,promptText:r,promptLang:a,textLang:i,gptWeightsPath:s,sovitsWeightsPath:l,modelSwitchMode:c,setModelEndpoint:d,strictWeightSwitch:A}}}function Qe(e,t=null){const o=Ke(e);if(!o)return null;const n=o.gptSoVits||{},r=t||Xe(),a=String(e?.desc||e?.description||'').trim();return{name:o.name,desc:a,refAudioPath:Le(String(n.refAudioPath||'').trim()),promptText:String(n.promptText||'').trim(),promptLang:String(n.promptLang||'').trim(),textLang:String(n.textLang||'').trim(),gptWeightsPath:Le(String(n.gptWeightsPath||'').trim()),sovitsWeightsPath:Le(String(n.sovitsWeightsPath||'').trim()),modelSwitchMode:ze(n.modelSwitchMode||r.modelSwitchMode),setModelEndpoint:Re(n.setModelEndpoint||r.setModelEndpoint),strictWeightSwitch:!!(n.strictWeightSwitch??r.strictWeightSwitch)}}function Ze(e,t=null){return Ye(e,t||Xe())}function et(e){const t=Qe(e);return!!String(t?.refAudioPath||'').trim()}function tt(e){for(const t of Array.isArray(e)?e:[])if(et(t))return t;return null}function ot(e){const t=String(e||''),o=t.lastIndexOf('.');return o>=0?t.slice(o+1).toLowerCase():''}function nt(e){return String(e||'').replace(/\.[^./\\]+$/,'')}function rt(e){const t=String(e||'').trim();return!!t&&(!!/^[a-zA-Z]:[\\/]/.test(t)||(!!t.startsWith('\\\\')||!!t.startsWith('/')))}function at(e,t){const o=String(e||'').trim(),n=String(t||'').trim();if(!o)return n;const r=o.includes('\\')&&!o.includes('/'),a=r?'\\':'/',i=o.replace(/[\\/]+$/,''),s=n.replace(/^[\\/]+/,'');if(!s)return i;const l=r?i.replace(/[\\/]+/g,'\\'):i.replace(/[\\/]+/g,'/'),c=r?s.replace(/[\\/]+/g,'\\'):s.replace(/[\\/]+/g,'/'),d=l.toLowerCase(),A=c.toLowerCase();if(A===d||A.startsWith(`${d}${a}`))return c;const u=l.split(/[\\/]+/).filter(Boolean),p=c.split(/[\\/]+/).filter(Boolean);if(u.length>0&&p.length>0){const e=u[u.length-1],t=p[0];if(e&&t&&e.toLowerCase()===t.toLowerCase())return u.concat(p.slice(1)).join(a)}return`${l}${a}${c}`}function it(e){const t=String(e||'');return/[\u3040-\u30ff]/.test(t)?'ja':/[\uac00-\ud7af]/.test(t)?'ko':/[a-zA-Z]/.test(t)&&!/[\u4e00-\u9fff]/.test(t)?'en':(/[\u4e00-\u9fff]/.test(t),'zh')}function st(e){let t=String(e||'').trim();return t?(t=t.replace(/^[\s\uFEFF]*(?:[\(\[][^\)\]]{1,10}[\)\]])\s*/g,''),t=t.replace(/[.!?,]+$/g,''),t=t.replace(/\.{3,}/g,'...'),t.trim()):''}function lt(e){let t=String(e||'').trim();if(!t)return'';t=t.replace(/^[A-Za-z0-9]{2,8}[_-]+/,'');const o=[/[_-]v\d+(?:proplus|pro|pp|p)?$/i,/[_-](?:v2pp|v2p|v2|v3|v4)$/i,/[_-](?:proplus|pro|pp|p)$/i,/[_-](?:gpt|sovits|so-vits|vits)$/i];for(let e=0;e<4;e++){const e=t;for(const e of o)t=t.replace(e,'');if(e===t)break;t=t.trim()}return t.trim()}function ct(e){return Array.isArray(e)&&0!==e.length&&e.slice().sort((e,t)=>Number(t?.size||0)-Number(e?.size||0))[0]||null}function dt(e){if(!Array.isArray(e)||0===e.length)return null;const t=e.map(e=>{const t=st(nt(e.name)),o=ot(e.name);return{file:e,score:1e3*('wav'===o?3:'flac'===o?2:'ogg'===o?1:0)+Math.min(200,t.length)}});return t.sort((e,t)=>t.score-e.score),t[0]?.file||null}function At(e){let t=String(nt(e)||'').toLowerCase().trim();return t?(t=t.replace(/[\s._-]+/g,''),t=t.replace(/(gpt|sovits|sovit|vits)+$/g,''),t):''}function ut(e,t){const o=Array.isArray(e)?e.slice():[],n=Array.isArray(t)?t.slice():[];if(0===o.length&&0===n.length)return[];o.sort((e,t)=>Number(t?.size||0)-Number(e?.size||0)),n.sort((e,t)=>Number(t?.size||0)-Number(e?.size||0));const r=new Map,a=new Map;o.forEach(e=>{const t=nt(e.name).toLowerCase();r.has(t)||r.set(t,e);const o=At(e.name);o&&!a.has(o)&&a.set(o,e)});const i=[],s=new Set,l=(e,t)=>{if(!e&&!t)return;const o=`${e?.name||''}::${t?.name||''}`.toLowerCase();s.has(o)||(s.add(o),i.push({gptFile:e||null,sovitsFile:t||null}))};n.forEach(e=>{const t=nt(e.name).toLowerCase(),o=r.get(t)||null;o&&l(o,e)}),n.forEach(e=>{const t=At(e.name),o=t&&a.get(t)||null;o&&l(o,e)}),0===i.length&&l(ct(o),ct(n));const c=new Set(i.map(e=>e.gptFile?.name).filter(Boolean)),d=new Set(i.map(e=>e.sovitsFile?.name).filter(Boolean));return n.forEach(e=>{d.has(e.name)||l(null,e)}),o.forEach(e=>{c.has(e.name)||l(e,null)}),i}function pt(e){const t=String(e||'').trim().toLowerCase();if(!t)return'';const o=[{tag:'开心',patterns:['happy','smile','laugh','joy','开心','高兴','喜悦','愉快','兴奋']},{tag:'生气',patterns:['angry','mad','rage','生气','愤怒','恼火']},{tag:'悲伤',patterns:['sad','cry','sob','悲伤','难过','伤心']},{tag:'惊讶',patterns:['surprise','wow','惊讶','震惊','吃惊']},{tag:'害羞',patterns:['shy','blush','害羞','脸红']},{tag:'冷静',patterns:['calm','normal','neutral','平静','冷静','默认']}];for(const e of o)if(e.patterns.some(e=>t.includes(e)))return e.tag;return''}function mt(e,t='',o={}){const n=Array.from(e||[]).filter(Boolean);if(0===n.length)return[];const r=Le(String(t||'').trim()),a=Le(String(o?.relativeRootName||'').trim()).replace(/^[\\/]+|[\\/]+$/g,''),i=e=>{let t=Le(String(e?.webkitRelativePath||e?.name||'').trim()).replace(/^[\\/]+/,'');if(!t)return'';if(!a)return t;const o=t.toLowerCase(),n=a.toLowerCase();return o===n||o.startsWith(`${n}/`)?t:`${a}/${t}`},s=new Map;for(const e of n){const t=i(e).split('/').slice(0,-1).join('/')||'__root__';s.has(t)||s.set(t,[]),s.get(t).push(e)}const l=Xe(),c=[];for(const[e,t]of s.entries()){const o=[],n=[],a=[];for(const e of t){const t=ot(e.name);'ckpt'===t?o.push(e):'pth'===t?n.push(e):['wav','mp3','flac','ogg','m4a'].includes(t)&&a.push(e)}if(0===o.length&&0===n.length&&0===a.length)continue;const s=e=>{const t=Le('string'==typeof e?.path?String(e.path):'');if(rt(t))return t;const o=i(e);if(!o)return'';return Le(at(r,o))||o},d=a.map(e=>{const t=nt(e.name);return{file:e,promptText:st(t),inferredTag:pt(t)}}).filter(e=>!!e.file),A=dt(a),u=ut(o,n),p=u.length>0?u:[{gptFile:null,sovitsFile:null}],m='__root__'!==e&&e.split('/').pop()||'',h=new Set;for(const e of p){const t=e.gptFile||null,o=e.sovitsFile||null,n=lt(nt((o||t||A||{}).name||''))||lt(m)||'新模型';let r=n,a=2;for(;h.has(r);)r=`${n}_${a++}`;h.add(r);const i=[],u={},p=A?Le(s(A)):'';d.forEach((e,t)=>{const o=Le(s(e.file));if(!o)return;const n=`ref_${t+1}`,r=nt(e.file.name)||`参考音频${t+1}`,a=String(e.promptText||'').trim(),l=a?it(a):'zh';i.push({id:n,name:r,path:o,promptText:a,promptLang:l,textLang:l}),e.inferredTag&&!u[e.inferredTag]&&(u[e.inferredTag]=n)});const f=i.find(e=>e.path===p)||i[0]||null,g=String(f?.promptText||'').trim(),b=g?it(g):'zh',y={id:je(r),name:r,enabled:!0,desc:'文件夹导入',paths:{gptWeightsPath:t?Le(s(t)):'',sovitsWeightsPath:o?Le(s(o)):'',defaultRefAudioPath:f?.path||''},params:{promptText:g,promptLang:f?.promptLang||b,textLang:f?.textLang||b,textSplitMethod:l.textSplitMethod||'cut5',speedFactor:We(l.speedFactor,1),mediaType:l.mediaType||'wav',streamingMode:!!l.streamingMode,modelSwitchMode:ze(l.modelSwitchMode||'set_weights'),setModelEndpoint:Re(l.setModelEndpoint||'/set_model'),strictWeightSwitch:!!l.strictWeightSwitch},refAudios:i,defaultRefId:f?.id||'',expressionRefMap:u};y.paths.defaultRefAudioPath&&c.push(y)}}return Ze(c,l)}function ht(){try{const e=Xe(),t=Oe(e.models);if(t.length>0)return t.map(t=>Je(t,e)).filter(Boolean);return(Array.isArray(e.voices)?e.voices:[]).map(Ke).filter(Boolean)}catch{return[]}}let ft=null,gt=0;let bt=null,yt=0;async function xt(){const e=Date.now();if(bt&&e-yt<=12e4)return bt;try{const t=await async function(){const e=await Ee(),t=e.security,o=[];t&&o.push(`${ye}&Sec-MS-GEC=${encodeURIComponent(t.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(t.secMsGecVersion)}`),o.push(ye);let n=null;for(const e of o)try{const t=await Me(e);if(t.length>0)return t;n=new Error('EdgeTTS voices response is empty')}catch(e){n=e}if(!t&&e.error){const t=n instanceof Error?n.message:String(n||'unknown');throw new Error(`EdgeTTS voices request failed. security-unavailable: ${e.error}; last: ${t}`)}throw n instanceof Error?n:new Error('EdgeTTS voices request failed')}();if(t.length>0)return bt=t,yt=e,t}catch(e){console.warn(`[${l}] EdgeTTS 直连音色拉取失败，使用本地兜底:`,e)}const t=Te();return bt=t,yt=e,t}async function vt(){const e=He();if(e===Pe.GPT_SOVITS_V2)return async function(){const e=Xe(),t=Oe(e.models);return t.length>0?t.map(t=>Je(t,e)).filter(Boolean):(Array.isArray(e.voices)?e.voices:[]).map(Ke).filter(Boolean)}();if(e===Pe.EDGE_TTS_DIRECT)return xt();const t=Date.now();if(!ft||t-gt>5e3){const e=await async function(){try{const e=await fetch('/user/files/LittleWhiteBox_TTS.json',{cache:'no-cache'});if(!e.ok)return null;const t=await e.json();return t?.volc?.mySpeakers||null}catch(e){return console.log(`[${l}] 获取 LittleWhiteBox TTS 配置失败:`,e),null}}();if(e&&e.length>0)return ft=e.map(e=>({name:e.name,value:e.value,source:e.source||(Ct(e.value)?'free':'auth'),resourceId:e.resourceId||Bt(e.value),desc:St(e.value)})),gt=t,ft}else if(ft)return ft;const o=De(),n=o?.xiaobaixTts||window?.xiaobaixTts;if(n?.getConfig){const e=n.getConfig(),t=e?.volc?.mySpeakers||[];if(t.length>0)return t.map(e=>({name:e.name,value:e.value,source:e.source||(Ct(e.value)?'free':'auth'),resourceId:e.resourceId||Bt(e.value),desc:St(e.value)}))}const r=o?.XB_TTS_VOICE_DATA||window?.XB_TTS_VOICE_DATA;return Array.isArray(r)&&r.length>0?r.slice(0,20).map(e=>({name:e.name,value:e.value,source:wt(e.value),resourceId:Bt(e.value),desc:e.scene||'预设音色'})):[{name:'桃夭',value:'female_1',source:'free',resourceId:null,desc:'温柔少女(免费)'},{name:'夜枭',value:'male_1',source:'free',resourceId:null,desc:'沉稳男声(免费)'},{name:'霜华',value:'female_2',source:'free',resourceId:null,desc:'清冷女声(免费)'},{name:'顾姐',value:'female_3',source:'free',resourceId:null,desc:'成熟御姐(免费)'},{name:'苏菲',value:'female_4',source:'free',resourceId:null,desc:'元气少女(免费)'},{name:'嘉欣',value:'female_5',source:'free',resourceId:null,desc:'甜美声线(免费)'},{name:'青梅',value:'female_6',source:'free',resourceId:null,desc:'邻家女孩(免费)'},{name:'可莉',value:'female_7',source:'free',resourceId:null,desc:'活泼萝莉(免费)'},{name:'君泽',value:'male_2',source:'free',resourceId:null,desc:'儒雅公子(免费)'},{name:'沐阳',value:'male_3',source:'free',resourceId:null,desc:'阳光少年(免费)'},{name:'梓辛',value:'male_4',source:'free',resourceId:null,desc:'磁性低音(免费)'}]}function Ct(e){return['female_1','female_2','female_3','female_4','female_5','female_6','female_7','male_1','male_2','male_3','male_4'].includes(e)}function wt(e){return Ct(e)?'free':'auth'}function Bt(e){const t=(e||'').toLowerCase();return t.startsWith('icl_')||t.startsWith('s_')?'seed-icl-2.0':t.startsWith('saturn_')||t.startsWith('uranus_')||t.includes('_saturn_')||t.includes('_uranus_')?'seed-tts-2.0':'seed-tts-1.0'}function St(e){return{female_1:'温柔少女(免费)',female_2:'清冷女声(免费)',female_3:'成熟御姐(免费)',female_4:'元气少女(免费)',female_5:'甜美声线(免费)',female_6:'邻家女孩(免费)',female_7:'活泼萝莉(免费)',male_1:'沉稳男声(免费)',male_2:'儒雅公子(免费)',male_3:'阳光少年(免费)',male_4:'磁性低音(免费)'}[e]||'自定义音色'}try{Object.defineProperty(De(),'TTS_VOICE_LIST',{get:function(){const e=He();if(e===Pe.GPT_SOVITS_V2)return ht();if(e===Pe.EDGE_TTS_DIRECT)return bt&&bt.length>0?bt:Te();if(ft)return ft;const t=De(),o=t?.xiaobaixTts||window?.xiaobaixTts;if(o?.getConfig){const e=o.getConfig(),t=e?.volc?.mySpeakers||[];if(t.length>0)return t.map(e=>({name:e.name,value:e.value,source:e.source||(Ct(e.value)?'free':'auth'),resourceId:e.resourceId||Bt(e.value),desc:St(e.value)}))}const n=t?.XB_TTS_VOICE_DATA||window?.XB_TTS_VOICE_DATA;return Array.isArray(n)&&n.length>0?n.slice(0,20).map(e=>({name:e.name,value:e.value,source:wt(e.value),resourceId:Bt(e.value),desc:e.scene||'预设音色'})):[{name:'桃夭',value:'female_1',source:'free',resourceId:null,desc:'温柔少女(免费)'},{name:'夜枭',value:'male_1',source:'free',resourceId:null,desc:'沉稳男声(免费)'},{name:'霜华',value:'female_2',source:'free',resourceId:null,desc:'清冷女声(免费)'},{name:'顾姐',value:'female_3',source:'free',resourceId:null,desc:'成熟御姐(免费)'},{name:'苏菲',value:'female_4',source:'free',resourceId:null,desc:'元气少女(免费)'},{name:'嘉欣',value:'female_5',source:'free',resourceId:null,desc:'甜美声线(免费)'},{name:'青梅',value:'female_6',source:'free',resourceId:null,desc:'邻家女孩(免费)'},{name:'可莉',value:'female_7',source:'free',resourceId:null,desc:'活泼萝莉(免费)'},{name:'君泽',value:'male_2',source:'free',resourceId:null,desc:'儒雅公子(免费)'},{name:'沐阳',value:'male_3',source:'free',resourceId:null,desc:'阳光少年(免费)'},{name:'梓辛',value:'male_4',source:'free',resourceId:null,desc:'磁性低音(免费)'}]},configurable:!0})}catch{}function _t(){try{const e=localStorage.getItem(Ue());return null===e||'true'===e}catch{return!0}}let kt=null;function Et(){return kt}function Vt(e){kt=e}function Mt(){const e=Et();return e?Promise.resolve(e):new Promise((e,t)=>{const o=indexedDB.open(c,1);o.onerror=()=>t(o.error??new Error('IndexedDB 打开失败')),o.onsuccess=()=>{const t=o.result;Vt(t);try{t.onversionchange=()=>{try{t.close()}catch{}Vt(null)}}catch{}try{console.log(`[${l}] IndexedDB 初始化成功`)}catch{}e(t)},o.onupgradeneeded=e=>{const t=o.result;!function(e,t){if(!e.objectStoreNames.contains(d)){const t=e.createObjectStore(d,{keyPath:'modelId'});return t.createIndex('uploadTime','uploadTime',{unique:!1}),void t.createIndex('runtimeType','runtimeType',{unique:!1})}if(t)try{const e=t.objectStore(d);e.indexNames.contains('uploadTime')||e.createIndex('uploadTime','uploadTime',{unique:!1}),e.indexNames.contains('runtimeType')||e.createIndex('runtimeType','runtimeType',{unique:!1})}catch{}}(t,e.target?.transaction??null),function(e){e.objectStoreNames.contains(A)||e.createObjectStore(A,{keyPath:'id'})}(t)}})}const Tt=Object.freeze({LEGACY:'legacy',CUBISM5:'cubism5'}),Nt=new Set(Object.values(Tt));function Pt(e){const t=function(e){if('number'==typeof e&&Number.isFinite(e))return Math.floor(e);if('string'!=typeof e)return null;const t=e.trim().match(/(\d+)(?:\.\d+)?/);if(!t)return null;const o=Number.parseInt(t[1],10);return Number.isFinite(o)?o:null}(e);return null==t?null:t>=5?5:t>=3?4:2===t?2:null}function Lt(e,t=null){if(!e||'object'!=typeof e)return Pt(t);const o=e,n=[o.Version,o.version,o.Meta?.Version,o.meta?.version];for(const e of n){const t=Pt(e);if(null!=t)return t}return o.FileReferences&&'object'==typeof o.FileReferences?Pt(t)??4:'string'==typeof o.model||'string'==typeof o.Model?Pt(t)??2:Pt(t)}function Dt(e,t=Tt.LEGACY){const o=String(e||'').trim().toLowerCase();return Nt.has(o)?o:t}function $t(e){const t=Pt(e);return null!=t&&t>=5?Tt.CUBISM5:Tt.LEGACY}function Ut(e=null){const t=e&&'object'==typeof e?e:{},o=Lt(t.modelJson,t.cubismVersion),n=Dt(t.runtimeType||'','')||$t(o);return{runtimeType:n,cubismVersion:o??(n===Tt.CUBISM5?5:null)}}function It(e=null){const t=e&&'object'==typeof e?e:{},o=Ut(t);return{...t,runtimeType:o.runtimeType,cubismVersion:o.cubismVersion}}function zt(e){return p}async function Rt(){Et()||await Mt();const e=Et();if(!e)throw new Error('IndexedDB 未初始化');return e}async function Wt(e){const t=await Rt(),o=function(e){const t=Dt(e?.runtimeType,Tt.LEGACY),o=Number(e?.cubismVersion),n=Number.isFinite(o)?o:null,r=Number(e?.uploadTime),a=Number.isFinite(r)&&r>0?r:Date.now(),i=Number(e?.fileSize),s=Number.isFinite(i)&&i>=0?i:0;return{...e,modelId:zt(),source:'local',fileName:String(e?.fileName||'').trim()||'uploaded-live2d.zip',runtimeType:t,cubismVersion:n,uploadTime:a,fileSize:s,moc3:e?.moc3??null,moc:e?.moc??null,physics:e?.physics??null,pose:e?.pose??null,textures:Array.isArray(e?.textures)?e.textures:[],motions:e?.motions&&'object'==typeof e.motions?e.motions:{},expressions:Array.isArray(e?.expressions)?e.expressions:[]}}(e);return new Promise((e,n)=>{try{const r=t.transaction([d],'readwrite');r.objectStore(d).put(o),r.oncomplete=()=>{try{console.log(`[${l}] 已保存本地 Live2D 模型: ${o.fileName}`)}catch{}e()},r.onerror=()=>n(r.error??new Error('保存本地模型失败'))}catch(e){n(e)}})}async function Ft(e){const t=await Rt(),o=zt();return new Promise(e=>{try{if(!t.objectStoreNames.contains(d))return void e(null);const n=t.transaction([d],'readonly'),r=n.objectStore(d).get(o);r.onsuccess=()=>{const t=r.result;e(t??null)},r.onerror=()=>e(null)}catch{e(null)}})}async function Ot(e){const t=await Ft();return!(!t||!t.modelJson)}const jt={PIXI_URL:'https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js',CUBISM4_CORE_URL:'https://cdn.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js',CUBISM4_CORE_FALLBACK_URLS:Object.freeze(['https://gcore.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js','https://unpkg.com/live2dcubismcore@1.0.2/live2dcubismcore.min.js','https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js']),CUBISM5_CORE_URL:'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',CUBISM5_CORE_FALLBACK_URLS:Object.freeze(['https://cdn.jsdelivr.net/gh/bigmalove/galgame@main/dist/live2dcubismcore.min.js','https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/live2dcubismcore.min.js']),CUBISM2_CORE_URL:'https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js',SDK_URL:'https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js',CUBISM5_RUNTIME_URL:'https://cdn.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.runtime.min.js',CUBISM5_RUNTIME_FALLBACK_URLS:Object.freeze(['https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.runtime.min.js','https://cdn.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.js','https://gcore.jsdelivr.net/gh/bigmalove/galgame@main/dist/cubism5.js']),SDK_CACHE_KEY:'live2d_sdk_v3',_READY_MARK:'__desktopPetLive2dLoaderReady_v3',_RUNTIME_KEY:'__desktopPetLive2dRuntime_v3',isLoaded:!1,loadPromise:null,legacyCoreLoaded:!1,legacyCorePromise:null,legacyCoreSource:null,cubism5CoreLoaded:!1,cubism5CorePromise:null,cubism5CoreSource:null,cubism5RuntimeLoaded:!1,cubism5RuntimePromise:null,cubism5RuntimeSource:null,legacyLive2DNamespace:null,cubism5Live2DNamespace:null,patchedResolveUrlPrototypes:new WeakSet,patchedXhrLoaderNamespaces:new WeakSet,pixiUrlResolvePatched:!1,pixiUrlResolveOriginal:null,legacyCoreObject:null,cubism5CoreObject:null,activeCoreType:null,loadedScriptUrls:new Set,_getUrlBase(e){try{const t=new URL(e,window.location.href);t.hash='',t.search='';const o=t.toString(),n=o.lastIndexOf('/');return n>=0?o.slice(0,n+1):o}catch(t){const o=this._normalizeRuntimeUrl(e),n=o.lastIndexOf('/');return n>=0?o.slice(0,n+1):o}},_ensureCubismCoreLocateFile(e,t){if(!e)return;const o=this._getUrlBase(t);if(!o)return;const n=e.Live2DCubismCore;n&&'object'==typeof n?'function'!=typeof n.locateFile&&(n.locateFile=e=>`${o}${e}`):e.Live2DCubismCore={locateFile:e=>`${o}${e}`}},_loadScriptSrc(e,t=12e3){return new Promise((o,n)=>{if(!e)return void n(new Error('Script URL is empty'));if(this.loadedScriptUrls.has(e))return void o(!0);const r=void 0!==window.parent?window.parent:window,a=r?.document||document,i=a.createElement('script');let s=!1;const l=(t,r)=>{s||(s=!0,t?(this.loadedScriptUrls.add(e),o(!0)):n(r||new Error(`Script load failed: ${e}`)))},c=setTimeout(()=>{l(!1,new Error(`Script load timeout: ${e}`))},t);i.async=!0,i.src=e,i.crossOrigin='anonymous',i.onload=()=>{clearTimeout(c),l(!0)},i.onerror=()=>{clearTimeout(c),l(!1,new Error(`Script load failed: ${e}`))},a.head.appendChild(i)})},async load(){const e=void 0!==window.parent?window.parent:window;if(this.isLoaded){if(this._getRuntime(e))return!0;this.isLoaded=!1,this.loadPromise=null}return this.getRuntime(e)?(this.isLoaded=!0,e[this._READY_MARK]=!0,!0):(this.loadPromise||(this.loadPromise=this._doLoad()),this.loadPromise)},getRuntime(e){const t=e??(void 0!==window.parent?window.parent:window),o=this._getRuntime(t);return o||this._setRuntime(t,this._detectActiveRuntimeType(t))},getPixi(e){return this.getRuntime(e)?.pixi??null},_detectActiveRuntimeType(e){const t=e?.PIXI?.live2d;return this.cubism5Live2DNamespace&&t&&t===this.cubism5Live2DNamespace&&t.Live2DModel?'cubism5':'legacy'},_getRuntime(e){const t=e?.[this._RUNTIME_KEY];if(!t||'object'!=typeof t)return null;const o=t.pixi,n=t.live2dModel;return o&&n?e?.PIXI!==o||e?.PIXI?.live2d?.Live2DModel!==n?null:t:null},_setRuntime(e,t='legacy'){const o=e?.PIXI,n=this.getRuntimeNamespace(t)||o?.live2d,r=n?.Live2DModel;if(!o||!r)return null;const a={pixi:o,live2dModel:r,pixiVersion:String(o?.VERSION||'unknown'),loadedAt:Date.now(),runtimeType:t};return e[this._RUNTIME_KEY]=a,a},_getLatestMocVersion(e){try{return Number(e?.Live2DCubismCore?.Version?.csmGetLatestMocVersion?.()||0)||0}catch(e){return 0}},async _waitForLatestMocVersion(e,t=5,o=4e3,n=50){const r=Date.now();for(;Date.now()-r<o;){const o=this._getLatestMocVersion(e);if(o>=t)return o;await new Promise(e=>setTimeout(e,n))}return this._getLatestMocVersion(e)},_isLegacyMocVersion(e){const t=Number(e||0)||0;return t>0&&t<=4},_isCubism5MocVersion:(e,t=5)=>(Number(e||0)||0)>=Math.max(5,Number(t||0)||0),_setGlobalCubismCore(e,t){if(e)if(t)e.Live2DCubismCore=t;else try{delete e.Live2DCubismCore}catch(t){e.Live2DCubismCore=void 0}},async ensureLegacyCore(){const e=void 0!==window.parent?window.parent:window,t=this._getLatestMocVersion(e);return this._isLegacyMocVersion(t)?(this.legacyCoreLoaded=!0,this.cubism5CoreLoaded=!1,this.activeCoreType='legacy',this.legacyCoreObject=e.Live2DCubismCore||this.legacyCoreObject,this.legacyCoreSource||(this.legacyCoreSource='window.Live2DCubismCore(existing)'),!0):this._isLegacyMocVersion(this._getLatestMocVersion({Live2DCubismCore:this.legacyCoreObject}))&&(this._setGlobalCubismCore(e,this.legacyCoreObject),this._isLegacyMocVersion(this._getLatestMocVersion(e)))?(this.legacyCoreLoaded=!0,this.cubism5CoreLoaded=!1,this.activeCoreType='legacy',this.legacyCoreSource||(this.legacyCoreSource='window.Live2DCubismCore(snapshot)'),!0):(this.legacyCorePromise||(this.legacyCorePromise=(async()=>{const t=e.Live2DCubismCore,o=this._getCubism4CoreUrls();if(!o.length)return console.error(`[${l}] Cubism 4 Core load failed: no core URL candidates`),this.legacyCorePromise=null,!1;let n=null;try{for(const r of o)try{const t=await fetch(r).then(e=>{if(!e.ok)throw new Error(`Cubism 4 Core load failed: ${e.status}`);return e.text()});this._setGlobalCubismCore(e,null),await this._executeScript(t,e);const o=Date.now();let n=this._getLatestMocVersion(e);for(;Date.now()-o<5e3&&!this._isLegacyMocVersion(n);)await new Promise(e=>setTimeout(e,80)),n=this._getLatestMocVersion(e);if(!this._isLegacyMocVersion(n))throw new Error(`latest moc version check failed: ${n}`);return this.legacyCoreLoaded=!0,this.legacyCoreObject=e.Live2DCubismCore||this.legacyCoreObject,this.legacyCoreSource=r,this.cubism5CoreLoaded=!1,this.activeCoreType='legacy',console.log(`[${l}] Cubism 4 Core loaded from ${r}`),!0}catch(o){this._setGlobalCubismCore(e,t),n=o,console.warn(`[${l}] Cubism 4 Core candidate failed: ${r}`,o)}if(this._setGlobalCubismCore(e,t),this._isLegacyMocVersion(this._getLatestMocVersion(e)))return this.legacyCoreLoaded=!0,this.cubism5CoreLoaded=!1,this.activeCoreType='legacy',this.legacyCoreObject=e.Live2DCubismCore||this.legacyCoreObject,this.legacyCoreSource||(this.legacyCoreSource='window.Live2DCubismCore(existing)'),console.warn(`[${l}] Cubism 4 Core candidates failed; fallback to existing core`),!0;if(console.warn(`[${l}] Cubism 4 Core load failed: all candidates failed`,{candidates:o,lastError:String(n?.message||n||'')}),n)throw this._setGlobalCubismCore(e,t),n;return!1}catch(o){return this._setGlobalCubismCore(e,t),console.error(`[${l}] Cubism 4 Core load failed:`,o),!1}finally{this.legacyCorePromise=null}})()),this.legacyCorePromise)},async ensureCubism5Core(e=5){const t=void 0!==window.parent?window.parent:window,o=Math.max(5,Number(e||0)||0),n=this._getLatestMocVersion(t)>=o,r='string'==typeof this.cubism5CoreSource&&/^https?:/i.test(this.cubism5CoreSource);return n&&r?(this.cubism5CoreLoaded=!0,this.legacyCoreLoaded=!1,this.activeCoreType='cubism5',this.cubism5CoreObject=t.Live2DCubismCore||this.cubism5CoreObject,!0):(n&&!r&&(this.cubism5CoreObject=t.Live2DCubismCore||this.cubism5CoreObject,console.warn(`[${l}] Existing Cubism Core detected without pinned source, will try configured Cubism 5 core URL candidates`)),this._isCubism5MocVersion(this._getLatestMocVersion({Live2DCubismCore:this.cubism5CoreObject}),o)&&(this._setGlobalCubismCore(t,this.cubism5CoreObject),this._isCubism5MocVersion(this._getLatestMocVersion(t),o))?(this.cubism5CoreLoaded=!0,this.legacyCoreLoaded=!1,this.activeCoreType='cubism5',this.cubism5CoreSource||(this.cubism5CoreSource='window.Live2DCubismCore(snapshot)'),!0):(this.cubism5CorePromise||(this.cubism5CorePromise=(async()=>{const e=this._getCubism5CoreUrls(t);if(!e.length)return console.error(`[${l}] Cubism 5 Core load failed: no core URL candidates`),this.cubism5CorePromise=null,!1;let n=null;const r=t.Live2DCubismCore;try{for(const a of e)try{this._setGlobalCubismCore(t,null),this._ensureCubismCoreLocateFile(t,a),await this._loadScriptSrc(a);const e=await this._waitForLatestMocVersion(t,o,8e3,80);if(e>=o)return this.cubism5CoreLoaded=!0,this.legacyCoreLoaded=!1,this.activeCoreType='cubism5',this.cubism5CoreObject=t.Live2DCubismCore||this.cubism5CoreObject,this.cubism5CoreSource=a,console.log(`[${l}] Cubism 5 Core loaded from ${a}`),!0;throw new Error(`latest moc version check failed: ${e} (required >= ${o})`)}catch(e){this._setGlobalCubismCore(t,r),n=e,console.warn(`[${l}] Cubism 5 Core candidate failed: ${a}`,e)}return this._setGlobalCubismCore(t,r),this._isCubism5MocVersion(this._getLatestMocVersion(t),o)?(this.cubism5CoreLoaded=!0,this.legacyCoreLoaded=!1,this.activeCoreType='cubism5',this.cubism5CoreObject=t.Live2DCubismCore||this.cubism5CoreObject,this.cubism5CoreSource||(this.cubism5CoreSource='window.Live2DCubismCore(existing)'),console.warn(`[${l}] Cubism 5 Core candidates failed; fallback to existing core`),!0):(this.cubism5CoreLoaded=!1,this.cubism5CoreSource=null,console.error(`[${l}] Cubism 5 Core load failed: all candidates failed`,{candidates:e,lastError:String(n?.message||n||'')}),!1)}finally{this.cubism5CorePromise=null}})()),this.cubism5CorePromise))},_normalizeRuntimeUrl:e=>'string'!=typeof e?'':e.trim(),_isDirectResourceUrl(e){const t=this._normalizeRuntimeUrl(e);return!!t&&(!!t.startsWith('//')||/^(?:blob|data|https?|file|stscript|chrome-extension|moz-extension|capacitor|app):/i.test(t))},_patchPixiUrlResolve(e){if(this.pixiUrlResolvePatched)return!0;const t=e?.PIXI?.utils,o=t?.url,n=o?.resolve;if('function'!=typeof n)return!1;const r=this;return this.pixiUrlResolveOriginal=n,o.resolve=function(e,t){return r._isDirectResourceUrl(t)?r._normalizeRuntimeUrl(t):n.call(this,e,t)},this.pixiUrlResolvePatched=!0,console.log(`[${l}] Patched PIXI.utils.url.resolve`),!0},_patchModelSettingsResolveURL(e,t='unknown'){if(!e||'object'!=typeof e)return 0;const o=['ModelSettings','Cubism2ModelSettings','Cubism4ModelSettings','Cubism5ModelSettings'];let n=0;for(const r of o){const o=e?.[r]?.prototype;if(!o||'function'!=typeof o.resolveURL)continue;if(this.patchedResolveUrlPrototypes.has(o)||o.__galgameResolveUrlPatched)continue;const a=o.resolveURL,i=this;o.resolveURL=function(e){return i._isDirectResourceUrl(e)?i._normalizeRuntimeUrl(e):a.call(this,e)};try{o.__galgameResolveUrlPatched=!0}catch(e){}this.patchedResolveUrlPrototypes.add(o),n++,console.log(`[${l}] Patched ModelSettings.resolveURL (${t}:${r})`)}return n},_patchXhrLoader(e,t='unknown'){if(!e||'object'!=typeof e)return!1;if(this.patchedXhrLoaderNamespaces.has(e))return!0;const o=e.XHRLoader,n=o?.loader;if('function'!=typeof n)return console.warn(`[${l}] XHRLoader.loader missing (${t})`,{hasNamespace:!!e,hasXHRLoader:!!o,loaderType:typeof n}),!1;const r=this;return o.loader=e=>{const t=e?.settings?e.settings.resolveURL(e.url):e?.url,o=r._normalizeRuntimeUrl(t);if(!r._isDirectResourceUrl(o))return n(e);const a=String(e?.type||'').toLowerCase();return fetch(o).then(e=>{if(!e.ok)throw new Error(`Fetch failed (${e.status}) for ${o}`);return'json'===a?e.json():'text'===a?e.text():e.arrayBuffer()}).then(t=>{if('json'!==a&&'text'!==a&&t instanceof ArrayBuffer){const e=new Uint8Array(t,0,Math.min(4,t.byteLength)),n=String.fromCharCode(...e);console.log(`[${l}] XHRLoader patched fetch arraybuffer`,{url:o.slice(0,128),byteLength:t.byteLength,signature:n})}e.result=t})},this.patchedXhrLoaderNamespaces.add(e),console.log(`[${l}] Patched XHRLoader.loader (${t})`),!0},_getCubism5RuntimeUrls(){const e=[],t=new Set,o=o=>{const n=this._normalizeRuntimeUrl(o);n&&!t.has(n)&&(t.add(n),e.push(n))};o(this.CUBISM5_RUNTIME_URL);for(const e of this.CUBISM5_RUNTIME_FALLBACK_URLS)o(e);return e},_getCubism5CoreUrls(){const e=[],t=new Set,o=o=>{const n=this._normalizeRuntimeUrl(o);n&&!t.has(n)&&(t.add(n),e.push(n))};o(this.CUBISM5_CORE_URL);for(const e of this.CUBISM5_CORE_FALLBACK_URLS)o(e);return e},_getCubism4CoreUrls(){const e=[],t=new Set,o=o=>{const n=this._normalizeRuntimeUrl(o);n&&!t.has(n)&&(t.add(n),e.push(n))};o(this.CUBISM4_CORE_URL);for(const e of this.CUBISM4_CORE_FALLBACK_URLS)o(e);return e},async ensureCubism5Runtime(){return this.cubism5RuntimeLoaded&&this.cubism5Live2DNamespace?.Live2DModel?(this.cubism5RuntimeSource||(this.cubism5RuntimeSource='window.PIXI.live2d(existing)'),!0):(this.cubism5RuntimePromise||(this.cubism5RuntimePromise=(async()=>{const e=void 0!==window.parent?window.parent:window;if(!this.isLoaded){if(!await this.load())return!1}if(!await this.ensureCubism5Core())return console.error(`[${l}] Cubism 5 runtime load aborted: core unavailable`),!1;try{const t=this._getCubism5RuntimeUrls();if(!t.length)return console.error(`[${l}] Cubism 5 runtime load failed: no runtime URL candidates`),!1;let o=null;for(const n of t)try{const t=await fetch(n).then(e=>{if(!e.ok)throw new Error(`Cubism 5 runtime load failed: ${e.status}`);return e.text()});await this._executeScript(t,e),await new Promise(e=>setTimeout(e,100));const o=e?.PIXI?.live2d;if(!o?.Live2DModel)throw new Error('Live2DModel is unavailable after Cubism 5 runtime script execution');return this._patchModelSettingsResolveURL(o,'cubism5'),this._patchXhrLoader(o,'cubism5'),this.cubism5Live2DNamespace=o,this.cubism5RuntimeLoaded=!0,this.cubism5RuntimeSource=n,this.legacyLive2DNamespace?.Live2DModel&&(e.PIXI.live2d=this.legacyLive2DNamespace),console.log(`[${l}] Cubism 5 runtime loaded from ${n}`),!0}catch(e){o=e,console.warn(`[${l}] Cubism 5 runtime candidate failed: ${n}`,e)}return console.error(`[${l}] Cubism 5 runtime load failed: all candidates failed`,{candidates:t,lastError:String(o?.message||o||'')}),!1}catch(e){return console.error(`[${l}] Cubism 5 runtime load failed:`,e),!1}finally{this.cubism5RuntimePromise=null}})()),this.cubism5RuntimePromise)},getRuntimeNamespace(e='legacy'){if('cubism5'===e&&this.cubism5Live2DNamespace?.Live2DModel)return this.cubism5Live2DNamespace;if(this.legacyLive2DNamespace?.Live2DModel)return this.legacyLive2DNamespace;const t=void 0!==window.parent?window.parent:window;return t?.PIXI?.live2d||null},activateRuntime(e='legacy'){const t=void 0!==window.parent?window.parent:window;if(!t?.PIXI)return!1;const o=this.getRuntimeNamespace(e);return!!o?.Live2DModel&&(t.PIXI.live2d=o,this._setRuntime(t,e),!0)},async _doLoad(){const e=void 0!==window.parent?window.parent:window;try{if(e.PIXI?.live2d?.Live2DModel)return console.log(`[${l}] Live2D SDK already available`),this._patchPixiUrlResolve(e),this.legacyLive2DNamespace=e.PIXI.live2d,this._patchModelSettingsResolveURL(this.legacyLive2DNamespace,'legacy-existing'),this._patchXhrLoader(this.legacyLive2DNamespace,'legacy-existing'),this.activateRuntime('legacy'),e[this._READY_MARK]=!0,this.isLoaded=!0,this.loadPromise=null,!0;if(!e.PIXI){console.log(`[${l}] 鍔犺浇 PIXI.js...`);const t=await fetch(this.PIXI_URL).then(e=>{if(!e.ok)throw new Error(`PIXI.js 鍔犺浇澶辫触: ${e.status}`);return e.text()});await this._executeScript(t,e),console.log(`[${l}] PIXI.js 鍔犺浇瀹屾垚`)}if(e.window.PIXI||(e.window.PIXI=e.PIXI),this._patchPixiUrlResolve(e),e.Live2DCubismCore){const t=this._getLatestMocVersion(e);t>=5?(this.cubism5CoreLoaded=!0,this.cubism5CoreSource=this.cubism5CoreSource||'window.Live2DCubismCore(existing)',this.cubism5CoreObject=e.Live2DCubismCore||this.cubism5CoreObject,this.activeCoreType='cubism5'):this._isLegacyMocVersion(t)&&(this.legacyCoreLoaded=!0,this.legacyCoreSource=this.legacyCoreSource||'window.Live2DCubismCore(existing)',this.legacyCoreObject=e.Live2DCubismCore||this.legacyCoreObject,this.activeCoreType='legacy')}else{console.log(`[${l}] 鍔犺浇 Cubism 4 Core...`);try{const t=await fetch(this.CUBISM4_CORE_URL).then(e=>{if(!e.ok)throw new Error(`Cubism 4 Core 鍔犺浇澶辫触: ${e.status}`);return e.text()});await this._executeScript(t,e),this.legacyCoreLoaded=!0,this.legacyCoreSource=this.CUBISM4_CORE_URL,this.legacyCoreObject=e.Live2DCubismCore||this.legacyCoreObject,this.activeCoreType='legacy',console.log(`[${l}] Cubism 4 Core 鍔犺浇瀹屾垚`)}catch(e){console.warn(`[${l}] Cubism 4 Core 鍔犺浇澶辫触锛屽皾璇曞鐢ㄦ簮...`,e)}}if(!e.Live2D){console.log(`[${l}] 鍔犺浇 Cubism 2.1 Core...`);try{const t=await fetch(this.CUBISM2_CORE_URL).then(e=>{if(!e.ok)throw new Error(`Cubism 2.1 Core 鍔犺浇澶辫触: ${e.status}`);return e.text()});await this._executeScript(t,e),console.log(`[${l}] Cubism 2.1 Core 鍔犺浇瀹屾垚`)}catch(e){console.warn(`[${l}] Cubism 2.1 Core 鍔犺浇澶辫触锛堟棫妯″瀷鍙兘涓嶅彲鐢級:`,e)}}const t=await this._getFromCache();if(t&&t.sdk)console.log(`[${l}] 浠庣紦瀛樺姞杞?pixi-live2d-display`),await this._executeScript(t.sdk,e);else{console.log(`[${l}] 浠?CDN 鍔犺浇 pixi-live2d-display...`);const t=await fetch(this.SDK_URL).then(e=>{if(!e.ok)throw new Error(`pixi-live2d-display 鍔犺浇澶辫触: ${e.status}`);return e.text()});await this._saveToCache({sdk:t}),await this._executeScript(t,e)}return await new Promise(e=>setTimeout(e,100)),this._patchPixiUrlResolve(e),e.PIXI?.live2d?.Live2DModel&&(this.legacyLive2DNamespace=e.PIXI.live2d,this._patchModelSettingsResolveURL(this.legacyLive2DNamespace,'legacy'),this._patchXhrLoader(this.legacyLive2DNamespace,'legacy')),this.activateRuntime('legacy'),this._setRuntime(e,'legacy'),this.isLoaded=!0,e[this._READY_MARK]=!0,this.loadPromise=null,console.log(`[${l}] Live2D SDK 加载完成`),!0}catch(t){return console.error(`[${l}] Live2D SDK 加载失败:`,t),e[this._READY_MARK]=!1,e[this._RUNTIME_KEY]=null,this.isLoaded=!1,this.loadPromise=null,!1}},_executeScript:(e,t)=>new Promise((o,n)=>{try{const n=t.document.createElement('script');n.textContent=e,t.document.head.appendChild(n),setTimeout(o,10)}catch(e){n(e)}}),async _getFromCache(){return new Promise(e=>{try{const t=indexedDB.open(c,1);t.onsuccess=t=>{const o=t.target.result;if(!o.objectStoreNames.contains(A))return o.close(),void e(null);const n=o.transaction(A,'readonly').objectStore(A).get(this.SDK_CACHE_KEY);n.onsuccess=()=>{o.close(),e(n.result?.data||null)},n.onerror=()=>{o.close(),e(null)}},t.onerror=()=>e(null)}catch(t){e(null)}})},async _saveToCache(e){return new Promise(t=>{try{const o=indexedDB.open(c,1);o.onsuccess=o=>{const n=o.target.result;if(!n.objectStoreNames.contains(A))return n.close(),void t();const r=n.transaction(A,'readwrite');r.objectStore(A).put({id:this.SDK_CACHE_KEY,data:e,timestamp:Date.now()}),r.oncomplete=()=>{n.close(),console.log(`[${l}] Live2D SDK 宸茬紦瀛樺埌 IndexedDB`),t()},r.onerror=()=>{n.close(),t()}},o.onerror=()=>t()}catch(e){t()}})},async clearCache(){return new Promise(e=>{try{const t=indexedDB.open(c,1);t.onsuccess=t=>{const o=t.target.result;if(!o.objectStoreNames.contains(A))return o.close(),void e();const n=o.transaction(A,'readwrite');n.objectStore(A).delete(this.SDK_CACHE_KEY),n.oncomplete=()=>{o.close(),this.isLoaded=!1,this.loadPromise=null,this.legacyCoreLoaded=!1,this.legacyCorePromise=null,this.legacyCoreSource=null,this.cubism5CoreLoaded=!1,this.cubism5CorePromise=null,this.cubism5CoreSource=null,this.cubism5RuntimeLoaded=!1,this.cubism5RuntimePromise=null,this.cubism5RuntimeSource=null,this.legacyLive2DNamespace=null,this.cubism5Live2DNamespace=null,this.patchedResolveUrlPrototypes=new WeakSet,this.patchedXhrLoaderNamespaces=new WeakSet,this.pixiUrlResolvePatched=!1,this.pixiUrlResolveOriginal=null,this.legacyCoreObject=null,this.cubism5CoreObject=null,this.activeCoreType=null,this.loadedScriptUrls=new Set,console.log(`[${l}] Live2D SDK cache cleared`),e()}},t.onerror=()=>e()}catch(t){e()}})}},Gt={longPressDelay:500,doubleClickWindow:300,moveThreshold:8};class qt{element;config;onGesture;isDraggingCheck;state='idle';startPos={x:0,y:0};longPressTimer=null;doubleClickTimer=null;longPressFired=!1;moved=!1;activePointerId=null;destroyed=!1;boundPointerDown;boundPointerMove;boundPointerUp;boundContextMenu;constructor(e,t,o,n=()=>!1){this.element=e,this.config={...Gt,moveThreshold:'ontouchstart'in window||navigator.maxTouchPoints>0?12:8,...t},this.onGesture=o,this.isDraggingCheck=n,this.boundPointerDown=this.handlePointerDown.bind(this),this.boundPointerMove=this.handlePointerMove.bind(this),this.boundPointerUp=this.handlePointerUp.bind(this),this.boundContextMenu=e=>e.preventDefault(),e.addEventListener('pointerdown',this.boundPointerDown),e.addEventListener('pointermove',this.boundPointerMove),e.addEventListener('pointerup',this.boundPointerUp),e.addEventListener('pointercancel',this.boundPointerUp),e.addEventListener('contextmenu',this.boundContextMenu)}destroy(){this.destroyed=!0,this.clearAllTimers(),this.element.removeEventListener('pointerdown',this.boundPointerDown),this.element.removeEventListener('pointermove',this.boundPointerMove),this.element.removeEventListener('pointerup',this.boundPointerUp),this.element.removeEventListener('pointercancel',this.boundPointerUp),this.element.removeEventListener('contextmenu',this.boundContextMenu)}handlePointerDown(e){this.destroyed||('touch'!==e.pointerType||!1!==e.isPrimary?null!==this.activePointerId&&e.pointerId!==this.activePointerId||(this.activePointerId=e.pointerId,this.startPos={x:e.clientX,y:e.clientY},this.longPressFired=!1,this.moved=!1,'wait-double'!==this.state&&(this.state='pending',this.clearLongPressTimer(),this.longPressTimer=window.setTimeout(()=>{'pending'!==this.state||this.moved||this.isDraggingCheck()||(this.longPressFired=!0,this.state='idle',this.onGesture({type:'long-press',clientX:this.startPos.x,clientY:this.startPos.y}))},this.config.longPressDelay))):this.resetState())}handlePointerMove(e){if(this.destroyed||'pending'!==this.state)return;if(this.activePointerId!==e.pointerId)return;const t=e.clientX-this.startPos.x,o=e.clientY-this.startPos.y;Math.sqrt(t*t+o*o)>this.config.moveThreshold&&(this.moved=!0,this.clearLongPressTimer(),this.state='idle')}handlePointerUp(e){if(!this.destroyed&&this.activePointerId===e.pointerId)if(this.activePointerId=null,this.clearLongPressTimer(),this.moved||this.isDraggingCheck())this.state='idle';else if(this.longPressFired)this.state='idle';else{if('wait-double'===this.state)return this.clearDoubleClickTimer(),this.state='idle',void this.onGesture({type:'double-tap',clientX:e.clientX,clientY:e.clientY});if('pending'===this.state&&!this.moved){this.state='wait-double';const t=e.clientX,o=e.clientY;this.doubleClickTimer=window.setTimeout(()=>{this.state='idle',this.onGesture({type:'tap',clientX:t,clientY:o})},this.config.doubleClickWindow)}}}resetState(){this.activePointerId=null,this.longPressFired=!1,this.moved=!1,this.state='idle',this.clearAllTimers()}clearLongPressTimer(){null!==this.longPressTimer&&(window.clearTimeout(this.longPressTimer),this.longPressTimer=null)}clearDoubleClickTimer(){null!==this.doubleClickTimer&&(window.clearTimeout(this.doubleClickTimer),this.doubleClickTimer=null)}clearAllTimers(){this.clearLongPressTimer(),this.clearDoubleClickTimer()}}const Yt={app:null,canvas:null,glContext:null,container:null,mountStack:[],mountMode:'floating',_pendingFloatingResize:null,loadingOverlay:null,loadingText:null,loadingBarFill:null,interactionLayer:null,gestureRecognizer:null,_dragClass:'desktop-pet-dragging',_minVisiblePx:48,_interactionPaddingPx:14,_alphaHitThreshold:10,_maxPixelScanSamples:36e4,_onPositionChange:null,_boundWindowResize:null,_interactionSyncTimer:null,_pixelReadBuffer:null,_lastClampLogAt:0,_clampPosition(e,t,o,n,r=0){const a=this._top(),i=a.innerWidth||a.document.documentElement.clientWidth||o,s=a.innerHeight||a.document.documentElement.clientHeight||n,l=Number.isFinite(o)&&o>0?o:i,c=Number.isFinite(n)&&n>0?n:s,d=Math.max(0,Math.min(r,l,i)),A=Math.max(0,Math.min(r,c,s)),u=Math.min(0,-l+d),p=Math.min(0,-c+A),m=Math.max(0,i-d),h=Math.max(0,s-A),f=Number.isFinite(e)?e:0,g=Number.isFinite(t)?t:0,b=Math.min(Math.max(f,u),m),y=Math.min(Math.max(g,p),h);return{x:b,y,clamped:b!==f||y!==g}},_shouldClampCurrentPosition(){if(!this.container)return!1;if('preview'===this.mountMode)return!1;const e='auto'===this.container.style.right||'auto'===this.container.style.bottom,t=!!this.container.style.left||!!this.container.style.top;return e||t},_getContainerRectSize(e){const t=this.container?.getBoundingClientRect?.();return{width:t?.width&&t.width>0?t.width:e.width,height:t?.height&&t.height>0?t.height:e.height}},_isRectFullyOutsideViewport(e){const t=this._top(),o=t.innerWidth||t.document.documentElement.clientWidth||0,n=t.innerHeight||t.document.documentElement.clientHeight||0;return!(o<=0||n<=0)&&(e.right<=0||e.bottom<=0||e.left>=o||e.top>=n)},_getVisibleAreaRatio(e,t,o){const n=Number.isFinite(e.width)?e.width:0,r=Number.isFinite(e.height)?e.height:0;if(n<=0||r<=0)return 1;if(t<=0||o<=0)return 1;const a=Math.max(0,e.left),i=Math.max(0,e.top),s=Math.min(t,e.right),l=Math.min(o,e.bottom),c=Math.max(0,s-a)*Math.max(0,l-i),d=n*r;return d<=0?1:Math.max(0,Math.min(1,c/d))},_clampPositionByAxis(e,t,o,n){const r=Number.isFinite(t)&&t>0?t:o,a=Number.isFinite(o)&&o>0?o:r,i=Math.max(0,Math.min(n,r,a)),s=Math.min(0,-r+i),l=Math.max(0,a-i),c=Number.isFinite(e)?e:0;return Math.min(Math.max(c,s),l)},_clampContainerToViewport(e,t){if(!this.container)return;const o=this.container.getBoundingClientRect(),n=this._getContainerRectSize(e),r=this._top(),a=r.innerWidth||r.document.documentElement.clientWidth||n.width,i=r.innerHeight||r.document.documentElement.clientHeight||n.height,s=this._shouldClampCurrentPosition(),l=this._isRectFullyOutsideViewport(o),c=this._getVisibleAreaRatio(o,a,i),d=t.includes('resize'),A=(l||d)&&c<.72;if(!s&&!l&&!A)return;const u=A?Math.min(n.width,a):Math.max(0,Math.min(this._minVisiblePx,n.width,a)),p=A?Math.min(n.height,i):Math.max(0,Math.min(this._minVisiblePx,n.height,i)),m=this._clampPositionByAxis(o.left,n.width,a,u),h=this._clampPositionByAxis(o.top,n.height,i,p);if(!(Math.abs(m-o.left)>.5||Math.abs(h-o.top)>.5))return;this.container.style.left=`${m}px`,this.container.style.top=`${h}px`,this.container.style.right='auto',this.container.style.bottom='auto';const f=Date.now();f-this._lastClampLogAt>600&&(this._lastClampLogAt=f,ce(`窗口变化触发位置修正(${t})`,{from:{x:o.left,y:o.top},to:{x:m,y:h},fullyOutside:l,visibleRatio:c,forceFullVisible:A})),this._onPositionChange?.(m,h)},_bindWindowResize(e){const t=this._top();this._unbindWindowResize(),this._boundWindowResize=()=>{this._clampContainerToViewport(e,'window-resize')};try{t.addEventListener('resize',this._boundWindowResize,{passive:!0})}catch(e){de('绑定 window.resize 监听失败',e),this._boundWindowResize=null}},_unbindWindowResize(){const e=this._top();if(this._boundWindowResize)try{e.removeEventListener('resize',this._boundWindowResize)}catch{}finally{this._boundWindowResize=null}},_top:()=>window.parent??window,_getPIXI(){const e=this._top();return jt.getPixi(e)},_measureOpaqueBoundsFromCanvas(e,t){const o=this.glContext;if(!o)return null;const n=o.drawingBufferWidth,r=o.drawingBufferHeight;if(n<=0||r<=0)return null;const a=n*r*4;this._pixelReadBuffer&&this._pixelReadBuffer.length===a||(this._pixelReadBuffer=new Uint8Array(a));const i=this._pixelReadBuffer;try{o.readPixels(0,0,n,r,o.RGBA,o.UNSIGNED_BYTE,i)}catch{return null}const s=Math.max(1,Math.floor(Math.sqrt(n*r/this._maxPixelScanSamples))),l=Math.max(0,Math.min(255,this._alphaHitThreshold));let c=n,d=r,A=-1,u=-1;for(let e=0;e<r;e+=s){const t=e*n*4;for(let o=0;o<n;o+=s){i[t+4*o+3]<=l||(o<c&&(c=o),e<d&&(d=e),o>A&&(A=o),e>u&&(u=e))}}if(A<0||u<0)return null;s>1&&(A=Math.min(n-1,A+s),u=Math.min(r-1,u+s));const p=e/n,m=t/r,h=Math.max(0,Math.floor(c*p)),f=Math.min(Math.ceil(e),Math.ceil((A+1)*p)),g=Math.max(0,Math.floor(t-(u+1)*m)),b=f-h,y=Math.min(Math.ceil(t),Math.ceil(t-d*m))-g;return b<8||y<8?null:{left:h,top:g,width:b,height:y}},_syncInteractionLayerBounds(){if(!this.container||!this.interactionLayer)return;const e=this.interactionLayer,t=this.container,o=()=>{e.style.left='0px',e.style.top='0px',e.style.width='100%',e.style.height='100%',e.style.pointerEvents='none',e.style.cursor='default'};if('preview'===this.mountMode)return void o();const n=t.getBoundingClientRect(),r=n.width>0?n.width:Number.parseFloat(String(t.style.width||'').replace('px','')),a=n.height>0?n.height:Number.parseFloat(String(t.style.height||'').replace('px',''));if(!Number.isFinite(r)||!Number.isFinite(a)||r<=0||a<=0)return;const i=(t,o,n,i)=>{const s=Math.max(0,this._interactionPaddingPx),l=Math.max(0,Math.floor(t-s)),c=Math.max(0,Math.floor(o-s)),d=Math.min(Math.ceil(r),Math.ceil(t+n+s))-l,A=Math.min(Math.ceil(a),Math.ceil(o+i+s))-c;return!(d<16||A<16)&&(e.style.left=`${l}px`,e.style.top=`${c}px`,e.style.width=`${d}px`,e.style.height=`${A}px`,e.style.pointerEvents='auto',e.style.cursor='pointer',!0)},s=this.app?.stage?.children?.[0];if(!s)return void o();const l=this._measureOpaqueBoundsFromCanvas(r,a);if(l){if(!(l.width>=.95*r&&l.height>=.95*a)&&i(l.left,l.top,l.width,l.height))return}if('function'==typeof s.getBounds)try{const e=s.getBounds(),t=Number(e?.x),o=Number(e?.y),n=Number(e?.width),l=Number(e?.height);if(Number.isFinite(t)&&Number.isFinite(o)&&Number.isFinite(n)&&Number.isFinite(l)&&n>0&&l>0){if(!(n>=.95*r&&l>=.95*a)&&i(t,o,n,l))return}}catch{}const c=Math.max(80,Math.round(.62*r)),d=Math.max(120,Math.round(.88*a));i(Math.max(0,Math.round((r-c)/2)),Math.max(0,Math.round(a-d)),c,d)||o()},_startInteractionSyncTimer(){this._stopInteractionSyncTimer(),this._syncInteractionLayerBounds(),this._interactionSyncTimer=window.setInterval(()=>{this._syncInteractionLayerBounds()},250)},_stopInteractionSyncTimer(){null!==this._interactionSyncTimer&&(window.clearInterval(this._interactionSyncTimer),this._interactionSyncTimer=null)},_enablePointerDrag(e,t){if(!this.container)return;const o=this._top(),n=this.container,r=this.interactionLayer??n,a=t.onPositionChange,i={pointerId:null,startClientX:0,startClientY:0,startLeft:0,startTop:0,dragging:!1,touchPointerIds:new Set},s=()=>{const e=n.getBoundingClientRect();return{width:e.width>0?e.width:t.width,height:e.height>0?e.height:t.height}},l=()=>{i.pointerId=null,i.dragging=!1,e.removeClass(this._dragClass)};r.addEventListener('pointerdown',e=>{if(0!==e.button)return;if('touch'===e.pointerType&&(i.touchPointerIds.add(e.pointerId),i.touchPointerIds.size>1))return void l();if(null!==i.pointerId)return;i.pointerId=e.pointerId,i.startClientX=e.clientX,i.startClientY=e.clientY;const{left:t,top:o}=(()=>{const e=n.getBoundingClientRect();return{left:e.left,top:e.top}})();i.startLeft=t,i.startTop=o;try{r.setPointerCapture(e.pointerId)}catch{}}),r.addEventListener('pointermove',t=>{if(null===i.pointerId||t.pointerId!==i.pointerId)return;if('touch'===t.pointerType&&i.touchPointerIds.size>1)return void l();const o=t.clientX-i.startClientX,r=t.clientY-i.startClientY,a=Math.sqrt(o*o+r*r);if(!i.dragging){if(a<8)return;i.dragging=!0,e.addClass(this._dragClass),n.style.left=`${i.startLeft}px`,n.style.top=`${i.startTop}px`,n.style.right='auto',n.style.bottom='auto'}const c=this._clampPosition(i.startLeft+o,i.startTop+r,s().width,s().height,this._minVisiblePx);n.style.left=`${c.x}px`,n.style.top=`${c.y}px`,n.style.right='auto',n.style.bottom='auto',t.preventDefault()},{passive:!1});const c=e=>{if('touch'===e.pointerType&&i.touchPointerIds.delete(e.pointerId),null===i.pointerId||e.pointerId!==i.pointerId)return;const t=i.dragging;if(l(),!t)return;const c=parseFloat(n.style.left||'0'),d=parseFloat(n.style.top||'0'),A=s(),u=this._clampPosition(c,d,A.width,A.height,this._minVisiblePx);n.style.left=`${u.x}px`,n.style.top=`${u.y}px`,n.style.right='auto',n.style.bottom='auto',this._onPositionChange=a??this._onPositionChange,this._onPositionChange?.(u.x,u.y);try{r.releasePointerCapture(e.pointerId)}catch{}try{o.getSelection?.()?.removeAllRanges?.()}catch{}};r.addEventListener('pointerup',c),r.addEventListener('pointercancel',c)},_ensureLoadingOverlay(){if(!this.container)return!1;const e=this.loadingOverlay;if(!!e&&!!e.ownerDocument?.documentElement?.contains(e))return!0;this.hideLoadingProgress();const t=this.container.ownerDocument,o=t.createElement('div');o.style.cssText='\n      position: absolute;\n      left: 8px;\n      right: 8px;\n      bottom: 8px;\n      padding: 8px 10px;\n      border-radius: 8px;\n      background: rgba(15, 23, 42, 0.72);\n      backdrop-filter: blur(3px);\n      pointer-events: none;\n      z-index: 5;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);\n      color: #e2e8f0;\n      font-size: 12px;\n      line-height: 1.4;\n    ';const n=t.createElement('div');n.style.cssText='margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;',n.textContent='姝ｅ湪鍔犺浇妯″瀷 (0%)';const r=t.createElement('div');r.style.cssText='width: 100%; height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.35); overflow: hidden;';const a=t.createElement('div');return a.style.cssText='height: 100%; width: 0%; border-radius: 999px; background: linear-gradient(90deg, #60a5fa, #22d3ee); transition: width 0.2s ease;',r.appendChild(a),o.appendChild(n),o.appendChild(r),this.container.appendChild(o),this.loadingOverlay=o,this.loadingText=n,this.loadingBarFill=a,!0},showLoadingProgress(e,t){if(!this._ensureLoadingOverlay())return;const o=Math.max(0,Math.min(100,Math.round(e)));this.loadingText&&(this.loadingText.textContent=`${t} (${o}%)`),this.loadingBarFill&&(this.loadingBarFill.style.width=`${o}%`)},hideLoadingProgress(){if(this.loadingOverlay)try{this.loadingOverlay.remove()}catch(e){de('Failed to remove loading progress overlay',e)}this.loadingOverlay=null,this.loadingText=null,this.loadingBarFill=null},create(e){const t=this._top(),o=this._getPIXI();if(!o)return de('PIXI 尚未就绪，无法创建舞台'),!1;this.destroy(),this._onPositionChange=e.onPositionChange??null,this._bindWindowResize({width:e.width,height:e.height});const n=t.document.getElementById('desktop-pet-stage');n&&n.remove(),this.container=t.document.createElement('div'),this.container.id='desktop-pet-stage',this.container.style.cssText=`\n      position: fixed;\n      right: 20px;\n      bottom: 20px;\n      width: ${e.width}px;\n      height: ${e.height}px;\n      overflow: hidden;\n      z-index: 10000;\n      pointer-events: none;\n      cursor: default;\n      touch-action: none;\n    `;if(Number.isFinite(e.position.x)&&Number.isFinite(e.position.y)&&!(-1===e.position.x&&-1===e.position.y)){const t=this._clampPosition(e.position.x,e.position.y,e.width,e.height,this._minVisiblePx);this.container.style.left=`${t.x}px`,this.container.style.top=`${t.y}px`,this.container.style.right='auto',this.container.style.bottom='auto',t.clamped&&(ce('检测到宠物位置超出可视区域，已自动修正',{from:e.position,to:{x:t.x,y:t.y}}),e.onPositionChange?.(t.x,t.y))}t.document.body.appendChild(this.container),this.canvas=t.document.createElement('canvas'),this.canvas.style.cssText='width: 100%; height: 100%; pointer-events: none;',this.container.appendChild(this.canvas),this.interactionLayer=t.document.createElement('div'),this.interactionLayer.className='desktop-pet-interaction-layer',this.interactionLayer.style.cssText='\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: auto;\n      cursor: pointer;\n      touch-action: none;\n      z-index: 4;\n    ',this.container.appendChild(this.interactionLayer);const r=t.devicePixelRatio||1;this.canvas.width=Math.floor(e.width*r),this.canvas.height=Math.floor(e.height*r);const a=this.canvas.getContext('webgl2',{alpha:!0,antialias:!0,stencil:!0,depth:!0,preserveDrawingBuffer:!0,premultipliedAlpha:!0})||this.canvas.getContext('webgl',{alpha:!0,antialias:!0,stencil:!0,depth:!0,preserveDrawingBuffer:!0,premultipliedAlpha:!0});if(!a)return de('WebGL is unavailable'),!1;this.glContext=a,this._pixelReadBuffer=null;try{const e=a.getContextAttributes?.();e&&!1===e.stencil&&de('Current WebGL context has no stencil buffer; mask rendering may be abnormal')}catch{}this.app=new o.Application({view:this.canvas,context:a,backgroundAlpha:0,autoStart:!0,width:e.width,height:e.height,resolution:r,autoDensity:!0,antialias:!0});const i=$(this.container),s=i.draggable;if('function'==typeof s)try{i.draggable({handle:'.desktop-pet-interaction-layer',start:(e,t)=>{i.addClass(this._dragClass);const o=this.container?.getBoundingClientRect?.();o&&(this.container.style.left=`${o.left}px`,this.container.style.top=`${o.top}px`,this.container.style.right='auto',this.container.style.bottom='auto',t?.position&&(t.position.left=o.left,t.position.top=o.top))},drag:(t,o)=>{const n=this.container?.getBoundingClientRect?.(),r=n?.width&&n.width>0?n.width:e.width,a=n?.height&&n.height>0?n.height:e.height,i=this._clampPosition(o.position.left,o.position.top,r,a,this._minVisiblePx);o.position.left=i.x,o.position.top=i.y},stop:(t,o)=>{i.removeClass(this._dragClass);const n=this.container?.getBoundingClientRect?.(),r=n?.width&&n.width>0?n.width:e.width,a=n?.height&&n.height>0?n.height:e.height,s=this._clampPosition(o.position.left,o.position.top,r,a,this._minVisiblePx);this.container.style.left=`${s.x}px`,this.container.style.top=`${s.y}px`,this.container.style.right='auto',this.container.style.bottom='auto',this._onPositionChange?.(s.x,s.y)}})}catch(t){de('Failed to initialize jQueryUI draggable, fallback to native pointer drag',t),this._enablePointerDrag(i,{width:e.width,height:e.height,onPositionChange:e.onPositionChange})}else de('jQueryUI draggable not found, fallback to native pointer drag'),this._enablePointerDrag(i,{width:e.width,height:e.height,onPositionChange:e.onPositionChange});const l=this.interactionLayer??this.container;let c=Number.isFinite(e.scale)?e.scale:1,d=!1,A=0,u=c;const p=new Map,m=t=>{const o=Math.max(.1,Math.min(3,t));Math.abs(o-c)<.002||(c=o,e.scale=o,e.onScaleChange?.(o))},h=()=>{if(p.size<2)return 0;const e=Array.from(p.values()),t=e[0],o=e[1],n=t.x-o.x,r=t.y-o.y;return Math.sqrt(n*n+r*r)},f=e=>{if('function'==typeof s)try{i.draggable(e?'enable':'disable')}catch{}},g=e=>{if('touch'===e.pointerType){if(p.delete(e.pointerId),p.size>=2){const e=h();return void(e>0&&(A=e,u=c))}A=0,u=c,d&&(d=!1,f(!0))}};return l.addEventListener('pointerdown',e=>{if('touch'!==e.pointerType)return;if(p.set(e.pointerId,{x:e.clientX,y:e.clientY}),p.size<2)return;const t=h();t<=0||(d||(d=!0,f(!1)),A=t,u=c,e.preventDefault())},{passive:!1}),l.addEventListener('pointermove',e=>{if('touch'!==e.pointerType)return;if(!p.has(e.pointerId))return;if(p.set(e.pointerId,{x:e.clientX,y:e.clientY}),!d||p.size<2)return;const t=h();if(t<=0||A<=0)return;m(u*(t/A)),e.preventDefault()},{passive:!1}),l.addEventListener('pointerup',g),l.addEventListener('pointercancel',g),l.addEventListener('wheel',e=>{e.preventDefault();const t=e.deltaY>0?-.05:.05;m(c+t)},{passive:!1}),this.gestureRecognizer=new qt(l,{},t=>{switch(t.type){case'tap':e.onTap?.(t);break;case'double-tap':e.onDoubleTap?.(t);break;case'long-press':e.onLongPress?.(t)}},()=>d||i.hasClass('ui-draggable-dragging')||i.hasClass(this._dragClass)),this._startInteractionSyncTimer(),ce('Live2D 舞台创建完成'),!0},getStage(){return this.app?.stage},isPreviewMounted(){return'preview'===this.mountMode},pushMount(e){if(!this.container||!this.app||!this.canvas)return!1;if(!e||!e.isConnected)return!1;const t=this._top(),o=this.container.getBoundingClientRect?.(),n=o?.width&&o.width>0?Math.round(o.width):Number(String(this.container.style.width||'').replace('px',''))||1,r=o?.height&&o.height>0?Math.round(o.height):Number(String(this.container.style.height||'').replace('px',''))||1;this.mountStack.push({parent:this.container.parentNode,nextSibling:this.container.nextSibling,styleText:this.container.style.cssText,width:n,height:r,onPositionChange:this._onPositionChange});try{'static'===t.getComputedStyle(e).position&&(e.style.position='relative')}catch{}this._onPositionChange=null,this._unbindWindowResize();try{e.appendChild(this.container)}catch{return!1}this.mountMode='preview',this.container.style.cssText='\n      position: absolute;\n      inset: 0;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      z-index: 1;\n      pointer-events: none;\n      cursor: default;\n      touch-action: none;\n    ',this.interactionLayer&&(this.interactionLayer.style.left='0px',this.interactionLayer.style.top='0px',this.interactionLayer.style.width='100%',this.interactionLayer.style.height='100%',this.interactionLayer.style.pointerEvents='none',this.interactionLayer.style.cursor='default');try{const e=$(this.container);'function'==typeof e.draggable&&e.draggable('disable')}catch{}return!0},popMount(){if(!this.container||!this.app||!this.canvas)return null;const e=this.mountStack.pop();if(!e)return null;try{const t=e.parent;t?e.nextSibling&&e.nextSibling.parentNode===t?t.insertBefore(this.container,e.nextSibling):t.appendChild(this.container):this._top().document.body.appendChild(this.container)}catch{}this.container.style.cssText=e.styleText,this._onPositionChange=e.onPositionChange,this.mountMode=this.mountStack.length>0?'preview':'floating',this._syncInteractionLayerBounds();try{const e=$(this.container);'function'==typeof e.draggable&&e.draggable('enable')}catch{}this._bindWindowResize({width:e.width,height:e.height});const t=this._pendingFloatingResize??{width:e.width,height:e.height};return this._pendingFloatingResize=null,this.resize(t.width,t.height),t},resizeFloating(e,t){if('preview'!==this.mountMode){if(this.container&&(this.container.style.width=`${e}px`,this.container.style.height=`${t}px`,this._clampContainerToViewport({width:e,height:t},'stage-resize'),this._syncInteractionLayerBounds()),this.app)try{this.app.renderer.resize(e,t)}catch(e){de('renderer.resize 失败',e)}}else this._pendingFloatingResize={width:e,height:t}},resizePreview(e,t){if('preview'===this.mountMode&&this.app)try{this.app.renderer.resize(e,t),this._syncInteractionLayerBounds()}catch(e){de('renderer.resize 失败',e)}},resize(e,t){this.resizeFloating(e,t)},destroy(){if(this.hideLoadingProgress(),this._unbindWindowResize(),this._stopInteractionSyncTimer(),this.mountStack=[],this.mountMode='floating',this._pendingFloatingResize=null,this.gestureRecognizer&&(this.gestureRecognizer.destroy(),this.gestureRecognizer=null),this.app){try{this.app.destroy(!0)}catch(e){de('Failed to destroy PIXI Application',e)}this.app=null}if(this.container){try{this.container.remove()}catch(e){de('舞台容器移除失败',e)}this.container=null}this.interactionLayer=null,this.canvas=null,this.glContext=null,this._pixelReadBuffer=null}},Jt={默认:{expressions:['normal','default','neutral','idle','base'],motions:['idle','normal','wait','default','stand']},微笑:{expressions:['smile','happy','joy','glad','pleased'],motions:['happy','smile','joy','weixiao','xiao','微笑']},生气:{expressions:['angry','anger','mad','rage','annoyed'],motions:['angry','rage','mad','shengqi','duqi','生气']},难过:{expressions:['sad','sorrow','cry','upset','depressed'],motions:['sad','cry','sorrow','nanguo','leiw','难过']},惊讶:{expressions:['surprised','shock','amazed','wow','astonished'],motions:['surprised','shock','amazed','jingya','jingxi','惊讶']},嘲讽:{expressions:['smirk','mock','sneer','tease','sarcastic'],motions:['mock','tease','tiaoxi','嘲讽']},害羞:{expressions:['shy','blush','embarrassed','bashful','timid'],motions:['shy','embarrassed','blush','haixiu','shame','害羞']},思考:{expressions:['think','ponder','confused','wonder','curious'],motions:['think','ponder','wonder','sikao','思考']},大笑:{expressions:['laugh','lol','haha','giggle','rofl'],motions:['laugh','giggle','haha','daxiao','oowarai','大笑']},搞怪:{expressions:['playful','wink','silly','fun','mischievous'],motions:['playful','wink','fun','gaoguai','silly','搞怪']}};function Ht(e,t,o){const n=String(o??'').trim();n&&!t.has(n)&&(t.add(n),e.push(n))}function Xt(e,t,o){const n=String(o??''),r=n.trim();if(!r&&''!==n)return;const a=r||'';t.has(a)||(t.add(a),e.push(a))}function Kt(e,t,o){const n=String(o.group??''),r=Number.isFinite(o.index)?Math.max(0,Math.floor(o.index)):0,a=String(o.name??'').trim();if(!a)return;const i=`${n}#${r}#${a.toLowerCase()}`;t.has(i)||(t.add(i),e.push({group:n,index:r,name:a}))}function Qt(e){const t=String(e??'').trim();if(!t)return'';const o=t.split('#')[0].split('?')[0],n=o.split('/').pop()||o;let r=n;try{r=decodeURIComponent(n)}catch{}return r.replace(/\.exp3\.json$/i,'').replace(/\.motion3\.json$/i,'').replace(/\.mtn$/i,'').replace(/\.json$/i,'').trim()}function Zt(e,t=''){if('string'==typeof e)return Qt(e)||e.trim();if(!e||'object'!=typeof e)return t;const o=e,n=o.Name||o.name||o.Id||o.id||'';if(String(n??'').trim())return String(n).trim();const r=Qt(o.File||o.file||o.Path||o.path||'');return r||t}function eo(e){const t=[],o=new Set,n=e=>{e&&'object'==typeof e&&(o.has(e)||(o.add(e),t.push(e)))},r=e?.internalModel?.motionManager,a=e?.internalModel?.settings;return n(a),n(a?.json),n(a?.rawSettings),n(a?.modelJson),n(r?.settings),n(r?.settings?.json),n(r?.settings?.rawSettings),n(r?.settings?.modelJson),t}function to(e){const t=String(e??'').trim().toLowerCase();return!!t&&(/\.exp3\.json($|[?#])/.test(t)||/\.exp\.json($|[?#])/.test(t)||/\.exp($|[?#])/.test(t))}function oo(e){const t=String(e??'').trim().toLowerCase();return!!t&&(/\.motion3\.json($|[?#])/.test(t)||/\.mtn($|[?#])/.test(t))}function no(e){if('string'==typeof e)return oo(e);if(!e||'object'!=typeof e)return!1;const t=e;if(oo(t.File||t.file||t.Path||t.path||''))return!0;const o=t.Sound||t.sound||'';return!('string'!=typeof o||!o.trim())}function ro(e){let t=0;for(const o of e)no(o)&&t++;return t>0?t:e.length}function ao(e,t,o){const n=String(t??''),r=n.trim();if(!r&&''!==n)return;const a=r||'',i=Number(o),s=Number.isFinite(i)&&i>0?Math.max(1,Math.floor(i)):1,l=e[a];e[a]=Number.isFinite(l)&&l>0?Math.max(l,s):s}function io(e,t,o,n){if(Array.isArray(o))return void((o,n)=>{for(let r=0;r<o.length;r++){const a=Zt(o[r],`${n}_${r+1}`);Ht(e,t,a)}})(o,n);if(!o||'object'!=typeof o)return;let r=0;for(const[a,i]of Object.entries(o)){const o=Qt(a)||String(a||'').trim()||`${n}_${r+1}`,s=Zt(i,o);Ht(e,t,s||o),r++}}function so(e){const t=[],o=new Set,n=new Set,r=(e,a='')=>{if(null==e)return;if('string'==typeof e){const n=e.trim();if(!n)return;return void((to(n)||/exp|expression/.test(a))&&Ht(t,o,Qt(n)||n))}if(Array.isArray(e)){for(let n=0;n<e.length;n++){const i=e[n],s=`${a||'expression'}_${n+1}`;if('string'!=typeof i){if(i&&'object'==typeof i){const e=Zt(i,s),n=i,r=n.File||n.file||n.Path||n.path||'';(/exp|expression/.test(a)||to(r))&&Ht(t,o,e||s)}r(i,a)}else(to(i)||/exp|expression/.test(a))&&Ht(t,o,Qt(i)||i)}return}if('object'!=typeof e)return;if(n.has(e))return;n.add(e);const i=e,s=i,l=s.File||s.file||s.Path||s.path||'';to(l)&&Ht(t,o,Zt(i,Qt(l)));for(const[e,n]of Object.entries(i)){const i=String(e||'').trim();if(!i)continue;const s=i.toLowerCase(),l=s.includes('expression')||s.includes('expr')||'exp'===s,c=l?'expression':a;if('string'==typeof n){const e=n.trim();if(!e)continue;if(to(e)||l||/exp|expression/.test(a)){const n=Qt(i)||i,r=Zt({Name:n,File:e},n);Ht(t,o,r||n)}continue}if(Array.isArray(n))(l||/exp|expression/.test(a))&&io(t,o,n,Qt(i)||'expression'),r(n,c);else if(n&&'object'==typeof n){if(l){const e=Qt(i)||i;Ht(t,o,Zt(n,e))}r(n,c)}}};return r(e,''),t}function lo(e){const t={},o=new Set,n=(e,r='',a='')=>{if(null==e)return;if(Array.isArray(e)){const o=ro(e);(''===r||r)&&o>0&&('motion'===a||e.some(e=>no(e)))&&ao(t,r,o);for(const t of e)t&&'object'==typeof t&&n(t,r,a);return}if('object'!=typeof e)return;if(o.has(e))return;o.add(e);const i=e;for(const[e,o]of Object.entries(i)){const i=String(e??''),s=i.trim()||'';if(!s&&''!==i)continue;const l=s.toLowerCase(),c=l.includes('motions')||l.includes('motion')||l.includes('anim')||l.includes('mtn'),d=c?'motion':a;if(Array.isArray(o)){const e=ro(o);e>0&&('motion'===d||o.some(e=>no(e)))&&ao(t,s,e),n(o,s,d);continue}if('string'!=typeof o){if(o&&'object'==typeof o){if(c){const e=o;for(const[o,n]of Object.entries(e)){const e=String(o??''),r=e.trim()||'';if(!r&&''!==e)continue;if(!Array.isArray(n))continue;const a=ro(n);a>0&&ao(t,r,a)}}n(o,s,d)}}else oo(o)&&r&&ao(t,r,1)}};return n(e,'',''),t}function co(e,t,o){if(!o)return;const n=(o,n)=>{const r=e=>{if('string'==typeof e)return String(e).trim().length>0;if(!e||'object'!=typeof e)return!1;const t=e;return!!String(t.File||t.file||t.Path||t.path||'').trim()||(!!String(t.Name||t.name||t.Id||t.id||'').trim()||no(e))};for(let a=0;a<n.length;a++){const i=n[a];if(!r(i))continue;const s=Zt(i,`motion_${a+1}`);Kt(e,t,{group:o,index:a,name:s})}};if(Array.isArray(o))n('',o);else if('object'==typeof o)for(const[e,t]of Object.entries(o)){const o=String(e??''),r=o.trim();if(!r&&''!==o)continue;const a=r||'';Array.isArray(t)&&n(a,t)}}function Ao(e){const t=[],o=new Set,n=e?.internalModel?.motionManager;co(t,o,n?.definitions);const r=eo(e);for(const e of r)co(t,o,e?.motions),co(t,o,e?.Motions),co(t,o,e?.FileReferences?.Motions);return t}function uo(e){const t=[],o=new Set,n=e?.internalModel?.motionManager?.expressionManager;io(t,o,n?.definitions,'definition'),io(t,o,n?.expressions,'expression');for(const e of so(n?.definitions))Ht(t,o,e);for(const e of so(n?.expressions))Ht(t,o,e);const r=eo(e);for(const e of r){io(t,o,e?.expressions,'settings_expr'),io(t,o,e?.Expressions,'settings_expr'),io(t,o,e?.FileReferences?.Expressions,'file_ref_expr');for(const n of so(e))Ht(t,o,n)}const a=e?.internalModel?.settings;if(a&&'object'==typeof a&&'function'==typeof a.getExpressionCount){let e=0;try{e=Number(a.getExpressionCount())||0}catch{}e=Math.max(0,Math.min(e,1e3));for(let n=0;n<e;n++){let e='';if('function'==typeof a.getExpressionName)try{e=String(a.getExpressionName(n)??'').trim()}catch{}if(!e&&'function'==typeof a.getExpressionFile)try{e=Qt(a.getExpressionFile(n))}catch{}Ht(t,o,e||`expression_${n+1}`)}}return t}function po(e){const t=[],o=new Set,n=e?.internalModel?.motionManager,r=e=>{if(e&&'object'==typeof e)for(const n of Object.keys(e))Xt(t,o,n)};r(n?.motionGroups),r(n?.groups),r(n?.definitions);for(const[e]of Object.entries(lo(n?.definitions)))Xt(t,o,e);const a=eo(e);for(const e of a){r(e?.motions),r(e?.Motions),r(e?.FileReferences?.Motions);for(const[n]of Object.entries(lo(e)))Xt(t,o,n)}const i=e?.internalModel?.settings;if(i&&'object'==typeof i){const e=i;if('function'==typeof e.getMotionGroupCount&&'function'==typeof e.getMotionGroupName){let n=0;try{n=Number(e.getMotionGroupCount())||0}catch{}n=Math.max(0,Math.min(n,1e3));for(let r=0;r<n;r++)try{Xt(t,o,String(e.getMotionGroupName(r)??''))}catch{}}else if('function'==typeof e.getMotionGroupNames)try{const n=e.getMotionGroupNames();if(Array.isArray(n))for(const e of n)Xt(t,o,e)}catch{}}return t}function mo(e,t,o){const n=String(o||'').trim();if(n)return n;const r=Jt[t],a=r?.expressions||[String(t||'').toLowerCase()],i=uo(e);if(!i.length)return null;for(const e of a){const t=String(e||'').toLowerCase(),o=i.find(e=>String(e||'').toLowerCase()===t);if(o)return o}for(const e of a){const t=String(e||'').toLowerCase();for(const e of i){const o=String(e||'').toLowerCase();if(o.includes(t)||t.includes(o))return e}}return null}function ho(e,t,o){if(o&&!1===o.enabled)return null;const n=String(o?.group??'').trim()===h,r=function(e){const t=String(e??'').trim();return t===h?'':t}(o?.group),a=Number(o?.index),i=Number.isFinite(a)?Math.max(0,Math.floor(a)):0;if(n||!!r||i>0){const t=Ao(e),o=po(e),n=r.toLowerCase(),a=t.find(e=>String(e.group||'').trim().toLowerCase()===n&&e.index===i);if(a)return{group:a.group,index:a.index,name:a.name};const s=o.find(e=>String(e||'').trim().toLowerCase()===n);if(void 0!==s){const e=t.find(e=>String(e.group||'').trim()===s&&e.index===i);if(e)return{group:e.group,index:e.index,name:e.name};const o=t.find(e=>String(e.group||'').trim()===s);return o?{group:o.group,index:o.index,name:o.name}:{group:s,index:i}}if(n){const e=t.find(e=>e.name.toLowerCase()===n&&e.index===i)||t.find(e=>e.name.toLowerCase()===n);if(e)return{group:e.group,index:e.index,name:e.name};const r=t.find(e=>{const t=e.name.toLowerCase();return t.includes(n)||n.includes(t)});if(r)return{group:r.group,index:r.index,name:r.name};const a=o.find(e=>{const t=String(e||'').trim().toLowerCase();return!!t&&(t.includes(n)||n.includes(t))});if(void 0!==a){const e=t.find(e=>String(e.group||'').trim()===a&&e.index===i);if(e)return{group:e.group,index:e.index,name:e.name};const o=t.find(e=>String(e.group||'').trim()===a);return o?{group:o.group,index:o.index,name:o.name}:{group:a,index:i}}}}const s=Jt[t];if(!s?.motions?.length)return null;const l=po(e);if(!l.length)return null;for(const e of s.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=l.find(e=>String(e||'').trim().toLowerCase()===t);if(o)return{group:o,index:0}}for(const e of s.motions){const t=String(e||'').toLowerCase();if(t)for(const e of l){const o=String(e||'').toLowerCase();if(o&&(o.includes(t)||t.includes(o)))return{group:e,index:0}}}const c=Ao(e);if(!c.length)return null;for(const e of s.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=c.find(e=>e.name.toLowerCase()===t);if(o)return{group:o.group,index:o.index,name:o.name}}for(const e of s.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=c.find(e=>{const o=e.name.toLowerCase();return o.includes(t)||t.includes(o)});if(o)return{group:o.group,index:o.index,name:o.name}}if(c.length>0){const e=c[0];return{group:e.group,index:e.index,name:e.name}}return l.length>0?{group:l[0],index:0}:null}const fo='__desktopPetLive2dTickerV1',go={_JSDELIVR_HOSTS:['cdn.jsdelivr.net','fastly.jsdelivr.net','testingcf.jsdelivr.net','gcore.jsdelivr.net'],_runtime:null,_runtimeType:Tt.LEGACY,_runtimeInfo:It({}),_localBlobUrls:[],_xhrBlobUrlSupport:null,_xhrBlobUrlSupportPromise:null,_hasLoggedBlobUrlDisabled:!1,model:null,isReady:!1,modelBaseWidth:null,modelBaseHeight:null,modelBaseBounds:null,_lastModelJson:null,_lastModelJsonSourceUrl:'',_autoMotionTimer:null,autoMotionLoopEnabled:!0,_mouthParamCore:null,_mouthParamIds:[],_mouthParamIndexes:[],_mouthParamRangeMins:[],_mouthParamRangeMaxs:[],_mouthParamWarned:!1,_mouthCurrentValue:0,_lipSyncActive:!1,_inModelUpdate:!1,_writeMaskCore:null,_writeMaskRestore:null,_updateHookModel:null,_updateHookRestore:null,_manualMouthParamEnabled:!1,_manualMouthParamIds:[],_manualMouthParamIdSet:new Set,_top:()=>window.parent??window,_getPIXI(){const e=jt.getPixi(this._top());return e||(this._runtime?.pixi??null)},_setRuntimeInfo(e){const t=It(e||{});return this._runtimeInfo=t,this._runtimeType=t.runtimeType,t},_registerLocalBlobUrl(e){const t=String(e||'').trim();t&&(this._localBlobUrls.includes(t)||this._localBlobUrls.push(t))},_revokeLocalBlobUrls(){if(!Array.isArray(this._localBlobUrls)||0===this._localBlobUrls.length)return void(this._localBlobUrls=[]);const e=this._top(),t=e?.URL||URL;for(const e of this._localBlobUrls)try{t.revokeObjectURL(e)}catch{}this._localBlobUrls=[]},_disableXhrBlobUrls(e){this._xhrBlobUrlSupport=!1,this._xhrBlobUrlSupportPromise=null,this._hasLoggedBlobUrlDisabled||(this._hasLoggedBlobUrlDisabled=!0,de(`检测到当前环境不支持 Live2D XHR 读取 blob URL，回退 Data URL（${e}）`))},async _supportsXhrBlobUrls(){if(!0===this._xhrBlobUrlSupport||!1===this._xhrBlobUrlSupport)return this._xhrBlobUrlSupport;if(this._xhrBlobUrlSupportPromise)return await this._xhrBlobUrlSupportPromise;this._xhrBlobUrlSupportPromise=(async()=>{try{const e=this._top(),t=e?.URL||URL,o=e?.XMLHttpRequest;if(!t?.createObjectURL||!t?.revokeObjectURL||'function'!=typeof o)return!1;const n=new Uint8Array([1,2,3,4]),r=new Blob([n],{type:'application/octet-stream'}),a=t.createObjectURL(r),i=await new Promise(e=>{let t=!1;const r=o=>{t||(t=!0,e(o))};try{const e=new o;e.open('GET',a,!0),e.responseType='arraybuffer',e.timeout=1500,e.onload=()=>{const t=e.response;r(!!t&&t.byteLength===n.byteLength)},e.onerror=()=>r(!1),e.onabort=()=>r(!1),e.ontimeout=()=>r(!1),e.send()}catch{r(!1)}});try{t.revokeObjectURL(a)}catch{}return i}catch{return!1}})().finally(()=>{this._xhrBlobUrlSupportPromise=null});const e=await this._xhrBlobUrlSupportPromise;return this._xhrBlobUrlSupport=e,e||this._disableXhrBlobUrls('xhr-probe-failed'),e},_isLocalModelPath:e=>String(e||'').trim().toLowerCase().startsWith(u.toLowerCase()),_normalizeLocalModelId:e=>p,_toArrayBuffer:e=>e?e instanceof ArrayBuffer?e:ArrayBuffer.isView(e)?e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):null:null,_normalizeMocVersion(e){const t=Number(e||0);return Number.isFinite(t)?t>=5?5:t>=1&&t<=4?4:null:null},_readMoc3HeaderVersion(e){const t=this._toArrayBuffer(e);if(!t||t.byteLength<8)return null;try{const e=new Uint8Array(t,0,4);if('MOC3'!==String.fromCharCode(...e))return null;const o=new DataView(t);return Number(o.getUint32(4,!0)||0)||null}catch{return null}},_detectCubismVersionFromMoc3Buffer(e){const t=this._toArrayBuffer(e);if(!t)return null;const o=this._top(),n=o?.Live2DCubismCore,r=n?.Moc,a=n?.Version;if('function'!=typeof r?.fromArrayBuffer||'function'!=typeof a?.csmGetMocVersion)return null;let i=null;try{if(i=r.fromArrayBuffer(t),!i)return null;const e=Number(a.csmGetMocVersion(i,t)||0)||0,o=Number(a?.csmGetLatestMocVersion?.()||0)||0,n=this._normalizeMocVersion(e);return o>0&&e>o?null:n}catch{return null}finally{try{i&&'function'==typeof i._release?i._release():i&&'function'==typeof i.release&&i.release()}catch{}}},async _detectRuntimeFromMoc3(e,t=null){const o=Ut(t||this._runtimeInfo||null),n=this._toArrayBuffer(e);if(!n)return this._setRuntimeInfo(o);const r=this._readMoc3HeaderVersion(n),a=this._normalizeMocVersion(r),i={...o,moc3Version:r??null};try{const e=r&&r>=5?r:5;await jt.ensureCubism5Core(e)}catch{}const s=this._detectCubismVersionFromMoc3Buffer(n)??a??i.cubismVersion??null;return this._setRuntimeInfo({...i,cubismVersion:s})},_isCoreParseError(e){const t=String(e?.message||e||''),o=String(e?.stack||'');return/unknown error/i.test(t)||/createcoremodel/i.test(o)||/be\.create/i.test(o)},async _ensureRuntimeDependencies(e,t){const o=this._setRuntimeInfo(e||null),n=Number(o?.moc3Version||0)||0,r=n>=5?n:5;if(o.runtimeType===Tt.CUBISM5){if(!await jt.ensureCubism5Core(r))throw new Error(`Cubism5 Core 加载失败（${t}）`);if(!await jt.ensureCubism5Runtime())throw new Error(`Cubism5 runtime 加载失败（${t}）`);return jt.activateRuntime(Tt.CUBISM5),this._setRuntimeInfo(o),o}if(n>=5){if(!await jt.ensureCubism5Core(r))throw new Error(`Cubism5 Core 加载失败（legacy+core5，${t}）`);jt.activateRuntime(Tt.LEGACY);const e=this._setRuntimeInfo({...o,runtimeType:Tt.LEGACY,cubismVersion:o.cubismVersion??5});return ce('legacy runtime + Cubism5 core 路由',{context:t,runtimeType:e.runtimeType,cubismVersion:e.cubismVersion,moc3Version:e.moc3Version??null}),e}if(!await jt.ensureLegacyCore()){const e=this._top();if((Number(e?.Live2DCubismCore?.Version?.csmGetLatestMocVersion?.()||0)||0)>=5){const e=this._setRuntimeInfo({...o,runtimeType:Tt.CUBISM5,cubismVersion:5});if(!await jt.ensureCubism5Core(r))throw new Error(`Cubism5 Core 回退加载失败（${t}）`);if(!await jt.ensureCubism5Runtime())throw new Error(`Cubism5 runtime 回退加载失败（${t}）`);return jt.activateRuntime(Tt.CUBISM5),e}throw new Error(`legacy Core 加载失败（${t}）`)}return jt.activateRuntime(Tt.LEGACY),this._setRuntimeInfo(o),o},_getLive2DModelClass(e){const t=this._top(),o=jt.getRuntimeNamespace(e)||t?.PIXI?.live2d;return o?.Live2DModel||null},_registerTickerForRuntime(e,t){if(!e||!t||'function'!=typeof e.registerTicker)return;e[fo]!==t.Ticker&&(e.registerTicker(t.Ticker),e[fo]=t.Ticker,ce('Live2D ticker 注册完成'))},_blobToDataUrl:e=>new Promise((t,o)=>{const n=new FileReader;n.onload=()=>t(String(n.result||'')),n.onerror=()=>o(n.error||new Error('Blob 转 DataURL 失败')),n.readAsDataURL(e)}),_normalizeStoredPath:e=>String(e||'').replace(/\\/g,'/').trim(),_getPathBaseName(e){const t=this._normalizeStoredPath(e),o=t.lastIndexOf('/');return o>=0?t.slice(o+1):t},_guessMimeTypeByPath(e,t='application/octet-stream'){const o=this._normalizeStoredPath(e).toLowerCase();return o.endsWith('.png')?'image/png':o.endsWith('.webp')?'image/webp':o.endsWith('.jpg')||o.endsWith('.jpeg')?'image/jpeg':o.endsWith('.json')||o.endsWith('.model3.json')||o.endsWith('.model.json')?'application/json':o.endsWith('.moc')||o.endsWith('.moc3')?'application/octet-stream':t},_findStoredTextureBlob(e,t,o=-1){const n=Array.isArray(e?.textures)?e.textures:[];if(!n.length)return null;const r=this._normalizeStoredPath(t),a=this._getPathBaseName(r),i=n.find(e=>this._normalizeStoredPath(e?.name)===r);if(i?.data instanceof Blob)return i.data;const s=n.find(e=>this._getPathBaseName(e?.name)===a);if(s?.data instanceof Blob)return s.data;const l=o>=0?n[o]:null;return l?.data instanceof Blob?l.data:null},_findStoredMotionData(e,t,o,n=-1){const r=e?.motions&&'object'==typeof e.motions?e.motions:{},a=this._normalizeStoredPath(o),i=this._getPathBaseName(a),s=String(t||''),l=Array.isArray(r?.[s])?r[s]:[],c=l.find(e=>this._normalizeStoredPath(e?.name)===a);if(c?.data instanceof ArrayBuffer)return c.data;const d=l.find(e=>this._getPathBaseName(e?.name)===i);if(d?.data instanceof ArrayBuffer)return d.data;const A=n>=0?l[n]:null;if(A?.data instanceof ArrayBuffer)return A.data;for(const e of Object.values(r)){const t=Array.isArray(e)?e:[],o=t.find(e=>this._normalizeStoredPath(e?.name)===a);if(o?.data instanceof ArrayBuffer)return o.data;const n=t.find(e=>this._getPathBaseName(e?.name)===i);if(n?.data instanceof ArrayBuffer)return n.data}return null},_findStoredExpressionData(e,t,o=-1){const n=Array.isArray(e?.expressions)?e.expressions:[];if(!n.length)return null;const r=this._normalizeStoredPath(t),a=this._getPathBaseName(r),i=n.find(e=>this._normalizeStoredPath(e?.file||e?.name)===r);if(i?.data instanceof ArrayBuffer)return i.data;const s=n.find(e=>this._getPathBaseName(e?.file||e?.name)===a);if(s?.data instanceof ArrayBuffer)return s.data;const l=o>=0?n[o]:null;return l?.data instanceof ArrayBuffer?l.data:null},_toLocalBlobUrl(e,t='application/octet-stream'){const o=this._top(),n=o?.URL||URL,r=e instanceof Blob?e:new Blob([e],{type:t}),a=n.createObjectURL(r);return this._registerLocalBlobUrl(a),a},async _toLocalDataUrl(e,t='application/octet-stream'){const o=e instanceof Blob?e:new Blob([e],{type:t});return await this._blobToDataUrl(o)},async _buildLocalModelBlobUrl(e){const t=JSON.parse(JSON.stringify(e?.modelJson||{}));this._normalizeLegacyCubism2Settings(t);const o=(e,t,o='application/octet-stream')=>{if(!e)return null;const n=e instanceof Blob&&e.type||this._guessMimeTypeByPath(t,o);return this._toLocalBlobUrl(e,n||o)};if(!!t?.FileReferences){const n=t.FileReferences;if(n&&'object'==typeof n){const t=o(e?.moc3??null,n.Moc,'application/octet-stream');t&&(n.Moc=t),Array.isArray(n.Textures)&&(n.Textures=n.Textures.map((t,n)=>{const r=this._findStoredTextureBlob(e,t,n);return o(r,t,'image/png')||t}));const r=o(e?.physics??null,n.Physics,'application/json');r&&'string'==typeof n.Physics&&(n.Physics=r);const a=o(e?.pose??null,n.Pose,'application/json');if(a&&'string'==typeof n.Pose&&(n.Pose=a),n.Motions&&'object'==typeof n.Motions||(n.Motions={}),e?.motions&&'object'==typeof e.motions)for(const[t,r]of Object.entries(e.motions)){const a=Array.isArray(r)?r:[];Array.isArray(n.Motions[t])||(n.Motions[t]=[]);const i=n.Motions[t];for(let n=0;n<a.length;n++){const r=a[n],s=i[n],l=(s&&'object'==typeof s?s.File||s.file:s)||r?.name,c=this._findStoredMotionData(e,t,l,n)??r?.data??null,d=o(c,l||r?.name,'application/json');if(d)if(s&&'object'==typeof s){'string'==typeof s.File?s.File=d:s.file=d;String(s.Name||s.name||'').trim()||(s.Name=this._getPathBaseName(l||r?.name))}else'string'==typeof s?i[n]=d:i.push({Name:this._getPathBaseName(r?.name||l||`motion_${n+1}`),File:d})}}if(Array.isArray(n.Expressions)||(n.Expressions=[]),Array.isArray(e?.expressions))for(let t=0;t<e.expressions.length;t++){const r=e.expressions[t],a=n.Expressions[t],i=(a&&'object'==typeof a?a.File||a.file:a)||r?.file||r?.name,s=this._findStoredExpressionData(e,i,t)??r?.data??null,l=o(s,i||r?.name,'application/json');if(l)if(a&&'object'==typeof a){'string'==typeof a.File?a.File=l:a.file=l;String(a.Name||a.name||'').trim()||(a.Name=this._getPathBaseName(r?.name||i))}else'string'==typeof a?n.Expressions[t]=l:n.Expressions.push({Name:this._getPathBaseName(r?.name||i||`expression_${t+1}`),File:l})}}}else{const n=t.model||t.Model,r=o(e?.moc??null,n,'application/octet-stream');r&&('string'==typeof t.model?t.model=r:'string'==typeof t.Model?t.Model=r:t.model=r);const a=t.textures||t.Textures;if(Array.isArray(a))for(let t=0;t<a.length;t++){const n=a[t],r=this._findStoredTextureBlob(e,n,t),i=o(r,n,'image/png');i&&(a[t]=i)}const i=t.physics||t.Physics,s=o(e?.physics??null,i,'application/json');s&&('string'==typeof t.physics&&(t.physics=s),'string'==typeof t.Physics&&(t.Physics=s));const l=t.pose||t.Pose,c=o(e?.pose??null,l,'application/json');c&&('string'==typeof t.pose&&(t.pose=c),'string'==typeof t.Pose&&(t.Pose=c));const d=t.motions||t.Motions;if(d&&'object'==typeof d)for(const t of Object.keys(d)){const n=d[t];if(Array.isArray(n))for(let r=0;r<n.length;r++){const a=n[r],i='string'==typeof a?a:a?.file||a?.File,s=this._findStoredMotionData(e,t,i,r),l=o(s,i,'application/octet-stream');l&&('string'==typeof a?n[r]=l:'string'==typeof a.file?a.file=l:a.File=l)}}const A=t.expressions||t.Expressions;if(Array.isArray(A))for(let t=0;t<A.length;t++){const n=A[t],r='string'==typeof n?n:n?.file||n?.File,a=this._findStoredExpressionData(e,r,t),i=o(a,r,'application/json');i&&('string'==typeof n?A[t]=i:'string'==typeof n.file?n.file=i:n.File=i)}}this._lastModelJson=JSON.parse(JSON.stringify(t));const n=new Blob([JSON.stringify(t)],{type:'application/json'});return this._toLocalBlobUrl(n,'application/json')},async _buildLocalModelDataUrl(e){const t=JSON.parse(JSON.stringify(e?.modelJson||{}));this._normalizeLegacyCubism2Settings(t);const o=async(e,t,o='application/octet-stream')=>{if(!e)return null;const n=e instanceof Blob&&e.type||this._guessMimeTypeByPath(t,o);return await this._toLocalDataUrl(e,n||o)};if(!!t?.FileReferences){const n=t.FileReferences;if(n&&'object'==typeof n){const t=await o(e?.moc3??null,n.Moc,'application/octet-stream');if(t&&(n.Moc=t),Array.isArray(n.Textures))for(let t=0;t<n.Textures.length;t++){const r=n.Textures[t],a=this._findStoredTextureBlob(e,r,t),i=await o(a,r,'image/png');i&&(n.Textures[t]=i)}const r=await o(e?.physics??null,n.Physics,'application/json');r&&'string'==typeof n.Physics&&(n.Physics=r);const a=await o(e?.pose??null,n.Pose,'application/json');if(a&&'string'==typeof n.Pose&&(n.Pose=a),n.Motions&&'object'==typeof n.Motions||(n.Motions={}),e?.motions&&'object'==typeof e.motions)for(const[t,r]of Object.entries(e.motions)){const a=Array.isArray(r)?r:[];Array.isArray(n.Motions[t])||(n.Motions[t]=[]);const i=n.Motions[t];for(let n=0;n<a.length;n++){const r=a[n],s=i[n],l=(s&&'object'==typeof s?s.File||s.file:s)||r?.name,c=this._findStoredMotionData(e,t,l,n)??r?.data??null,d=await o(c,l||r?.name,'application/json');if(d)if(s&&'object'==typeof s){'string'==typeof s.File?s.File=d:s.file=d;String(s.Name||s.name||'').trim()||(s.Name=this._getPathBaseName(l||r?.name))}else'string'==typeof s?i[n]=d:i.push({Name:this._getPathBaseName(r?.name||l||`motion_${n+1}`),File:d})}}if(Array.isArray(n.Expressions)||(n.Expressions=[]),Array.isArray(e?.expressions))for(let t=0;t<e.expressions.length;t++){const r=e.expressions[t],a=n.Expressions[t],i=(a&&'object'==typeof a?a.File||a.file:a)||r?.file||r?.name,s=this._findStoredExpressionData(e,i,t)??r?.data??null,l=await o(s,i||r?.name,'application/json');if(l)if(a&&'object'==typeof a){'string'==typeof a.File?a.File=l:a.file=l;String(a.Name||a.name||'').trim()||(a.Name=this._getPathBaseName(r?.name||i))}else'string'==typeof a?n.Expressions[t]=l:n.Expressions.push({Name:this._getPathBaseName(r?.name||i||`expression_${t+1}`),File:l})}}}else{const n=t.model||t.Model,r=await o(e?.moc??null,n,'application/octet-stream');r&&('string'==typeof t.model?t.model=r:'string'==typeof t.Model?t.Model=r:t.model=r);const a=t.textures||t.Textures;if(Array.isArray(a))for(let t=0;t<a.length;t++){const n=a[t],r=this._findStoredTextureBlob(e,n,t),i=await o(r,n,'image/png');i&&(a[t]=i)}const i=t.physics||t.Physics,s=await o(e?.physics??null,i,'application/json');s&&('string'==typeof t.physics&&(t.physics=s),'string'==typeof t.Physics&&(t.Physics=s));const l=t.pose||t.Pose,c=await o(e?.pose??null,l,'application/json');c&&('string'==typeof t.pose&&(t.pose=c),'string'==typeof t.Pose&&(t.Pose=c));const d=t.motions||t.Motions;if(d&&'object'==typeof d)for(const t of Object.keys(d)){const n=d[t];if(Array.isArray(n))for(let r=0;r<n.length;r++){const a=n[r],i='string'==typeof a?a:a?.file||a?.File,s=this._findStoredMotionData(e,t,i,r),l=await o(s,i,'application/octet-stream');l&&('string'==typeof a?n[r]=l:'string'==typeof a.file?a.file=l:a.File=l)}}const A=t.expressions||t.Expressions;if(Array.isArray(A))for(let t=0;t<A.length;t++){const n=A[t],r='string'==typeof n?n:n?.file||n?.File,a=this._findStoredExpressionData(e,r,t),i=await o(a,r,'application/json');i&&('string'==typeof n?A[t]=i:'string'==typeof n.file?n.file=i:n.File=i)}}this._lastModelJson=JSON.parse(JSON.stringify(t));const n=new Blob([JSON.stringify(t)],{type:'application/json'});return await this._blobToDataUrl(n)},_encodePathSegment(e){if('string'!=typeof e||!e)return e;let t=e;try{t=decodeURIComponent(e)}catch{return e}const o=/[A-Za-z0-9\-._~!$&'()*+,;=:@]/;let n='';for(const e of t)n+=o.test(e)?e:encodeURIComponent(e);return n},_normalizeRemoteUrl(e){const t=String(e||'').trim();if(!t)return t;try{const e=new URL(t);return e.pathname=e.pathname.split('/').map(e=>this._encodePathSegment(e)).join('/'),e.toString()}catch{return t}},_normalizeResourceRef(e){const t=String(e||'').trim();if(!t)return t;const o=t.replace(/#/g,'%23').replace(/\\/g,'/'),n=o.indexOf('?'),r=n>=0?o.slice(0,n):o,a=n>=0?o.slice(n):'';return`${r.split('/').map(e=>this._encodePathSegment(e)).join('/')}${a.replace(/#/g,'%23')}`},_getMirrorEikanyaModelUrl(e){const t=String(e||'').trim();return t?t.startsWith(v)?`${C}${t.slice(56)}`:t.startsWith(C)?`${v}${t.slice(62)}`:null:null},_expandJsDelivrHosts(e){const t=String(e||'').trim();if(!t)return[];let o;try{o=new URL(t)}catch{return[]}if(!o.hostname.toLowerCase().endsWith('jsdelivr.net'))return[];const n=[];for(const e of this._JSDELIVR_HOSTS)try{const o=new URL(t);o.hostname=e,n.push(o.toString())}catch{}return n},_convertJsDelivrGhToRawCandidates(e){const t=String(e||'').trim();if(!t)return[];let o;try{o=new URL(t)}catch{return[]}if(!o.hostname.toLowerCase().endsWith('jsdelivr.net'))return[];if(!o.pathname.startsWith('/gh/'))return[];const n=o.pathname.slice(4).split('/').filter(Boolean);if(n.length<2)return[];const r=n[0],a=n[1],i=n.slice(2).join('/');if(!r||!a||!i)return[];const[s,l]=a.split('@'),c=`${o.search||''}${o.hash||''}`;return l?[`https://raw.githubusercontent.com/${r}/${s}/${l}/${i}${c}`]:[`https://raw.githubusercontent.com/${r}/${s}/master/${i}${c}`,`https://raw.githubusercontent.com/${r}/${s}/main/${i}${c}`]},_buildModelUrlCandidates(e){const t=[],o=e=>{const o=this._normalizeRemoteUrl(e);o&&(t.includes(o)||t.push(o))};o(e);const n=this._getMirrorEikanyaModelUrl(e);n&&o(n);const r=[],a=e=>{const t=this._normalizeRemoteUrl(e);t&&(r.includes(t)||r.push(t))};for(const e of t){a(e);for(const t of this._expandJsDelivrHosts(e))a(t);for(const t of this._convertJsDelivrGhToRawCandidates(e))a(t)}return r},async _createModelWithTimeout(e,t,o=3e4){let n=null;try{const r=new Promise((e,t)=>{n=window.setTimeout(()=>{t(new Error(`模型实例化超时 (${o}ms)`))},o)});return await Promise.race([e.from(t,{autoUpdate:!1,autoInteract:!1}),r])}finally{null!==n&&window.clearTimeout(n)}},async _fetchWithTimeout(e,t,o=12e3){if('undefined'==typeof AbortController)return fetch(e,t);const n=new AbortController,r=window.setTimeout(()=>n.abort(),o);try{return await fetch(e,{...t,signal:n.signal})}catch(t){if('AbortError'===t?.name)throw new Error(`请求超时 (${o}ms): ${e}`);throw t}finally{window.clearTimeout(r)}},_toPositiveNumber(e,t){const o='number'==typeof e?e:Number(e);return Number.isFinite(o)&&o>0?o:t},_toScale(e,t=1){const o='number'==typeof e?e:Number(e);return!Number.isFinite(o)||o<=0?t:Math.min(20,Math.max(.01,o))},_readModelBaseBounds(e){if(!e||'function'!=typeof e.getLocalBounds)return null;try{const t=e.getLocalBounds();if(!t)return null;const o=Number(t.width),n=Number(t.height);if(!Number.isFinite(o)||!Number.isFinite(n)||o<=0||n<=0)return null;const r=Number.isFinite(Number(t.x))?Number(t.x):0;return{x:r,y:Number.isFinite(Number(t.y))?Number(t.y):0,width:o,height:n}}catch{return null}},_resolveModelBaseBounds(){if(this.modelBaseBounds)return this.modelBaseBounds;const e=this._readModelBaseBounds(this.model);return e?(this.modelBaseBounds=e,this.modelBaseWidth=e.width,this.modelBaseHeight=e.height,e):{x:0,y:0,width:this._toPositiveNumber(this.modelBaseWidth,500),height:this._toPositiveNumber(this.modelBaseHeight,800)}},_applyStageTransform(e,t,o){if(!this.model)return null;const n=this._toPositiveNumber(e,280),r=this._toPositiveNumber(t,360),a=this._resolveModelBaseBounds(),i=this._toPositiveNumber(a.width,500),s=this._toPositiveNumber(a.height,800),l=.9*Math.min(n/i,r/s),c=this._toScale(l*this._toScale(o,1),.3);return this.model.visible=!0,this.model.alpha=1,this.model.scale.set(c),this.model.anchor?.set?(this.model.anchor.set(.5,1),this.model.x=n/2,this.model.y=r):this.model.pivot?.set?(this.model.pivot.set(a.x+i/2,a.y+s),this.model.x=n/2,this.model.y=r):(this.model.x=n/2,this.model.y=r/2),{finalScale:c,stageWidth:n,stageHeight:r,modelWidth:i,modelHeight:s}},_normalizeLegacyCubism2Settings(e){if(!e||e.FileReferences)return;const t=e.textures||e.Textures;if(Array.isArray(t))return;if(!t||'object'!=typeof t)return;const o=Object.entries(t).filter(e=>Array.isArray(e[1])&&e[1].length>0);if(0===o.length)return;const n=[e.config?.texture,e.config?.textureId,e.config?.skin,e.config?.modelId,e.config?.defaultTexture,e.config?.defaultSkin].map(e=>null==e?'':String(e).trim()).filter(Boolean);let r=o[0];for(const e of n){const t=o.find(([t])=>t===e);if(t){r=t;break}}const a=r[1].map(e=>{const t=String(e||'').trim();return t?/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)||t.startsWith('/')||t.includes('/')?t:`textures/${t}`:t});e.textures=a,e.Textures=a,ce('检测到非标准 Cubism2 贴图结构，已自动转换',{key:r[0],textureCount:a.length})},_clearAutoMotionLoop(){null!==this._autoMotionTimer&&(window.clearInterval(this._autoMotionTimer),this._autoMotionTimer=null)},_stopCurrentMotion(e='manual'){const t=this.model;if(!t)return;let o=!1;const n=(e,t)=>{if(e&&'function'==typeof e[t])try{e[t](),o=!0}catch{}},r=t?.internalModel?.motionManager,a=t?.internalModel?.animator,i=t?.internalModel;n(t,'stopMotions'),n(r,'stopAllMotions'),n(r,'stopAllMotion'),n(r,'stopMotion'),n(r,'stop'),n(a,'stopAllMotions'),n(a,'stopAllMotion'),n(a,'stop'),n(i,'stopAllMotions'),o&&ce('已停止当前动作',{reason:e})},_refreshManualMouthParams(){let e=!1;const t=[];try{const o=he().settings;e=!!o?.lipSyncManualParamsEnabled;const n=Array.isArray(o?.lipSyncManualParamIds)?o.lipSyncManualParamIds:[],r=new Set;for(const e of n){const o=String(e||'').trim();if(!o)continue;const n=o.toLowerCase();r.has(n)||(r.add(n),t.push(o))}}catch{}this._manualMouthParamEnabled=e,this._manualMouthParamIds=t,this._manualMouthParamIdSet=new Set(t.map(e=>e.toLowerCase()))},_setLipSyncActive(e){const t=!!e;if(this._lipSyncActive!==t){if(this._lipSyncActive=t,t){this._refreshManualMouthParams();const e=this.model,t=e?.internalModel?.coreModel;e&&this._ensureLipSyncHooks(e),t&&this._installCoreWriteMask(t)}ce(`LipSync active=${t}`)}},setAutoMotionLoopEnabled(e){this.autoMotionLoopEnabled=Boolean(e),this.model?this.autoMotionLoopEnabled?this._startAutoMotionLoop():(this._clearAutoMotionLoop(),this._stopCurrentMotion('auto-motion-disabled')):this._clearAutoMotionLoop()},_pickDefaultMotionGroup(e){const t=Object.keys(e).filter(t=>e[t]>0);if(0===t.length)return null;const o=['idle','home','stand','normal','default','main','loop','wait'];for(const e of t){const t=e.toLowerCase();if(o.some(e=>t.includes(e)))return e}return t.includes('')?'':null},_startAutoMotionLoop(){if(this._clearAutoMotionLoop(),!this.model)return;const e=this.getMotionGroups(),t=this._pickDefaultMotionGroup(e),o=Object.keys(e).filter(t=>e[t]>0);if(0===o.length)return void ce('当前模型未提供动作组，将保持静态显示');const n=()=>{if(!this.model)return;const e=this.getMotionGroups();if(null!==t){const o=e[t]??0;if(o<=0)return;const n=Math.floor(Math.random()*o);return void this.playMotion(t,n)}const o=Object.keys(e).filter(t=>e[t]>0);if(0===o.length)return;const n=o[Math.floor(Math.random()*o.length)],r=e[n];if(r<=0)return;const a=Math.floor(Math.random()*r);this.playMotion(n,a)};n(),this._autoMotionTimer=window.setInterval(n,1e4),ce('已启动自动动作循环',null!==t?{mode:'preferred-group',group:t||'(empty)',intervalMs:1e4}:{mode:'random-all-groups',groupCount:o.length,intervalMs:1e4})},_stripJsonComments(e){let t='',o=!1,n='"',r=!1,a=!1,i=!1;for(let s=0;s<e.length;s++){const l=e[s],c=s+1<e.length?e[s+1]:'';a?'\n'===l&&(a=!1,t+=l):i?'*'===l&&'/'===c&&(i=!1,s++):o?(t+=l,r?r=!1:'\\'===l?r=!0:l===n&&(o=!1)):'/'!==l||'/'!==c?'/'!==l||'*'!==c?('"'!==l&&'\''!==l||(o=!0,n=l),t+=l):(i=!0,s++):(a=!0,s++)}return t},_tryParseModelJson(e){const t=String(e??'').replace(/^\uFEFF/,'').trim();if(!t)return null;try{return JSON.parse(t)}catch{}let o=this._stripJsonComments(t);o=o.replace(/,\s*([}\]])/g,'$1'),o=o.replace(/}(\s*){/g,'},$1{'),o=o.replace(/](\s*){/g,'],$1{'),o=o.replace(/([}\]0-9"'])(\s*)(?="[^"]+"\s*:)/g,'$1,$2');try{return JSON.parse(o)}catch{return null}},_buildModelJsonCandidates(e){const t=[e],o=e=>{e&&(t.includes(e)||t.push(e))};return o(e.replace(/\/model\.json(?=([?#].*)?$)/i,'/model.model.json')),o(e.replace(/\/model3\.json(?=([?#].*)?$)/i,'/model.model3.json')),t},async _fetchModelJsonCandidate(e,t){const o=t?this._getProxiedUrl(e):e,n=await this._fetchWithTimeout(o,{method:'GET',cache:'no-store'},12e3);if(!n.ok)return null;const r=await n.text(),a=this._tryParseModelJson(r);return a?{modelJson:a,sourceUrl:e,useProxy:t}:null},_getProxiedUrl(e){const t=this._top(),o=String(e||'').trim();if(!o)return o;if(o.toLowerCase().includes('/proxy?url='))return o;if('function'==typeof t.getCorsProxyUrl)try{const e=t.getCorsProxyUrl(o);if('string'==typeof e&&e)return e}catch(e){}if('function'==typeof t.enableCorsProxy)try{const e=t.enableCorsProxy(o);if('string'==typeof e&&e)return e}catch(e){}if(t.corsProxy?.getProxyUrl)try{const e=t.corsProxy.getProxyUrl(o);if('string'==typeof e&&e)return e}catch(e){}const n=t.location?.origin;return n?`${n}/proxy?url=${encodeURIComponent(o)}`:o},async init(){if(this.isReady){const e=jt.getRuntime(this._top());if(e)return this._runtime=e,!0;this.isReady=!1}if(!await jt.load())return Ae('SDK 加载失败，无法初始化 Live2DManager'),!1;let e=jt.getRuntime(this._top()),t=30;for(;!e&&t>0;)await new Promise(e=>setTimeout(e,100)),e=jt.getRuntime(this._top()),t--;if(!e?.pixi||!e?.live2dModel)return Ae('桌面宠物 Live2D runtime 未就绪'),!1;try{const t=e.pixi,o=e.live2dModel;if('function'!=typeof o?.registerTicker)throw new Error('Live2DModel.registerTicker 不可用');return o[fo]!==t.Ticker?(o.registerTicker(t.Ticker),o[fo]=t.Ticker,ce('Live2D ticker 注册完成')):ce('Live2D ticker 已注册，跳过重复注册'),this._runtime=e,this.isReady=!0,ce('Live2DManager 初始化完成'),!0}catch(e){return Ae('Live2DManager 初始化失败',e),!1}},async loadModel(e,t){let o=0;const n=(e,n)=>{t&&(o=Math.max(o,Math.round(e)),t({percent:Math.max(0,Math.min(100,o)),message:n}))},r=async(e,t,o,r,a='')=>{const i=await this._ensureRuntimeDependencies(t,o),s=this._getPIXI(),l=this._getLive2DModelClass(i.runtimeType);if(!s||!l)throw new Error(`Live2D 运行时不可用（${o}）`);this._registerTickerForRuntime(l,s),n(r,`实例化模型${a}`);const c=await this._createModelWithTimeout(l,e);n(r+10,`加载模型纹理${a}`);return{model:c,texturesReady:await this._waitForTextures(c,(e,t)=>{if(t<=0)return;const o=Math.max(0,Math.min(1,e/t));n(r+10+10*o,`加载模型纹理 ${e}/${t}${a}`)}),runtimeInfo:i}};if(n(2,'准备加载模型'),!this.isReady){n(8,'初始化 Live2D 引擎');if(!await this.init())return n(100,'Live2D 引擎初始化失败'),!1}try{ce('开始加载模型:',e),n(14,'清理旧模型'),this.destroyModel(),this._revokeLocalBlobUrls();let t=null,o=!1,a=e,i=null;if(this._isLocalModelPath(e)){n(20,'读取本地模型');this._normalizeLocalModelId(e);const s=await Ft();if(!s)throw new Error('未找到已上传的本地模型，请先上传 ZIP 模型');this._lastModelJson=JSON.parse(JSON.stringify(s.modelJson||{})),this._lastModelJsonSourceUrl=e;let l=this._setRuntimeInfo(s);s.moc3&&(l=await this._detectRuntimeFromMoc3(s.moc3,l));const c=async e=>{if(!e)return await this._buildLocalModelDataUrl(s);return await this._supportsXhrBlobUrls()?await this._buildLocalModelBlobUrl(s):await this._buildLocalModelDataUrl(s)};let d=!1;try{n(30,'构建本地模型资源');const i=await c(!0);d=String(i||'').startsWith('blob:');const s=await r(i,l,'local-model',42,' (本地)');t=s.model,o=s.texturesReady,l=s.runtimeInfo,a=e}catch(n){if(i=n,de('本地模型加载失败，尝试回退',n),d){this._disableXhrBlobUrls('local-load-failed'),this._revokeLocalBlobUrls();try{const n=await c(!1),s=await r(n,l,'local-model-data-fallback',46,' (本地 DataURL 回退)');t=s.model,o=s.texturesReady,l=s.runtimeInfo,a=`${e}#data`,i=null}catch(e){i=e}}if(!t&&this._isCoreParseError(i)&&l.runtimeType===Tt.LEGACY){de('local legacy runtime 解析失败，尝试 Cubism5 runtime 重试',i),this._revokeLocalBlobUrls();try{const n={...l,runtimeType:Tt.CUBISM5,cubismVersion:5},s=await c(!1),d=await r(s,n,'local-force-cubism5-retry',50,' (强制 Cubism5 重试)');t=d.model,o=d.texturesReady,a=`${e}#cubism5`,i=null}catch(e){i=e}}}if(!t)throw i instanceof Error?i:new Error('本地模型加载失败')}else{let s;n(20,'解析远程模型地址'),s=e.startsWith('http://')||e.startsWith('https://')?e:`https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/${e}`,s=this._normalizeRemoteUrl(s);const l=this._buildModelUrlCandidates(s);for(let e=0;e<l.length;e++){const s=l[e],c=l.length>1?` (${e+1}/${l.length})`:'',d=24+Math.floor(e/Math.max(1,l.length)*36);let A=null,u=!1,p=null;const m=async(e,t='')=>{const o=this._runtimeInfo,n=await r(e,o,`remote:${s}`,d+10,`${c}${t}`);A=n.model,u=n.texturesReady};try{e>0&&ce('主地址加载失败，尝试镜像地址:',s),n(d,`下载模型配置${c}`);const t=await this._buildRemoteModelDataUrl(s);await m(t)}catch(e){if(p=e,this._isCoreParseError(e)&&this._runtimeType===Tt.LEGACY){de('remote legacy runtime 解析失败，尝试 Cubism5 runtime 重试',e);try{const e={...this._runtimeInfo,runtimeType:Tt.CUBISM5,cubismVersion:5},t=await this._buildRemoteModelDataUrl(s),o=await r(t,e,`remote-force-cubism5:${s}`,d+12,`${c} (强制 Cubism5 重试)`);A=o.model,u=o.texturesReady,p=null}catch(e){p=e}}if(!A){de('首次实例化失败，尝试强制代理资源重试',e);try{n(d+6,`代理重试${c}`);const e=await this._buildRemoteModelDataUrl(s,!0);await m(e,' (代理)'),p=null}catch(e){if(p=e,this._isCoreParseError(e)&&this._runtimeType===Tt.LEGACY)try{const e={...this._runtimeInfo,runtimeType:Tt.CUBISM5,cubismVersion:5},t=await this._buildRemoteModelDataUrl(s,!0),o=await r(t,e,`remote-force-cubism5-proxy:${s}`,d+14,`${c} (代理强制 Cubism5 重试)`);A=o.model,u=o.texturesReady,p=null}catch(e){p=e}}}}if(A){t=A,o=u,a=s,i=null;break}i=p,de(`模型地址尝试失败 (${e+1}/${l.length})`,s,p);try{A?.destroy?.()}catch{}}if(!t)throw i instanceof Error?i:new Error('远程模型加载失败')}this.model=t;const s=this._readModelBaseBounds(t);return s?(this.modelBaseBounds=s,this.modelBaseWidth=s.width,this.modelBaseHeight=s.height):(this.modelBaseBounds=null,this.modelBaseWidth=t.width>0?t.width:500,this.modelBaseHeight=t.height>0?t.height:800),n(95,'整理模型数据'),ce('模型表情统计',this.getExpressions()),ce('模型动作组统计',this.getMotionGroups()),o||de('模型已挂载，但纹理可能未完全可用'),a!==e&&ce('模型已通过回退路径加载:',a),n(100,'模型加载完成'),ce('模型加载成功'),!0}catch(e){return n(100,'模型加载失败'),Ae('模型加载失败:',e),!1}},async _buildRemoteModelDataUrl(e,t=!1){const o=this._buildModelJsonCandidates(e);let n=null,r=e,a=!1;for(const e of o){try{const t=await this._fetchModelJsonCandidate(e,!1);if(t){n=t.modelJson,r=t.sourceUrl,a=!1;break}}catch(t){de('直连获取模型 JSON 失败，尝试代理：',e,t)}try{const t=await this._fetchModelJsonCandidate(e,!0);if(t){n=t.modelJson,r=t.sourceUrl,a=!0;break}}catch(t){de('代理获取模型 JSON 失败：',e,t)}}if(!n)throw new Error('模型 JSON 解析失败');r!==e&&ce('主模型 JSON 解析失败，已回退到:',r);const i=JSON.parse(JSON.stringify(n));this._normalizeLegacyCubism2Settings(i);const s=e=>{if('string'!=typeof e)return e;const o=e.trim();if(!o)return e;const n=this._normalizeResourceRef(o),i=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(n)?this._normalizeRemoteUrl(n):this._normalizeRemoteUrl(new URL(n,r).toString());return(a||t)&&(i.startsWith('http://')||i.startsWith('https://'))?this._getProxiedUrl(i):i};if(i?.FileReferences){const e=i.FileReferences;for(const t of Object.keys(e))'string'==typeof e[t]&&(e[t]=s(e[t]));if('string'==typeof e.Moc&&(e.Moc=s(e.Moc)),Array.isArray(e.Textures)&&(e.Textures=e.Textures.map(s)),'string'==typeof e.Physics&&(e.Physics=s(e.Physics)),'string'==typeof e.Pose&&(e.Pose=s(e.Pose)),'string'==typeof e.UserData&&(e.UserData=s(e.UserData)),e.Motions&&'object'==typeof e.Motions)for(const t of Object.keys(e.Motions)){const o=e.Motions[t];if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.File&&(e.File=s(e.File)),'string'==typeof e.Sound&&(e.Sound=s(e.Sound)))}if(Array.isArray(e.Expressions))for(const t of e.Expressions)t&&'object'==typeof t&&'string'==typeof t.File&&(t.File=s(t.File))}else{'string'==typeof i.model?i.model=s(i.model):'string'==typeof i.Model&&(i.Model=s(i.Model));const e=i.textures||i.Textures;if(Array.isArray(e))for(let t=0;t<e.length;t++)'string'==typeof e[t]&&(e[t]=s(e[t]));'string'==typeof i.physics&&(i.physics=s(i.physics)),'string'==typeof i.Physics&&(i.Physics=s(i.Physics)),'string'==typeof i.pose&&(i.pose=s(i.pose)),'string'==typeof i.Pose&&(i.Pose=s(i.Pose));const t=i.motions||i.Motions;if(t&&'object'==typeof t)for(const e of Object.keys(t)){const o=t[e];if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.file&&(e.file=s(e.file)),'string'==typeof e.File&&(e.File=s(e.File)),'string'==typeof e.sound&&(e.sound=s(e.sound)),'string'==typeof e.Sound&&(e.Sound=s(e.Sound)))}const o=i.expressions||i.Expressions;if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.file&&(e.file=s(e.file)),'string'==typeof e.File&&(e.File=s(e.File)))}let l=this._setRuntimeInfo({...this._runtimeInfo,modelJson:i});if(i?.FileReferences?.Moc){const e=String(i.FileReferences.Moc||'').trim();if(e)try{const t=await this._fetchWithTimeout(e,{method:'GET',cache:'no-store'},12e3);if(t.ok){const e=await t.arrayBuffer();l=await this._detectRuntimeFromMoc3(e,l)}else de(`远程 moc3 探测跳过（HTTP ${t.status}）`,e)}catch(e){de('远程 moc3 探测失败',e)}}else l=this._setRuntimeInfo({...l,runtimeType:Tt.LEGACY,cubismVersion:l.cubismVersion??2});ce('远程模型 runtime 路由提示',{sourceModelUrl:r,runtimeType:l.runtimeType,cubismVersion:l.cubismVersion,moc3Version:l?.moc3Version??null}),this._lastModelJson=i,this._lastModelJsonSourceUrl=r;const c=JSON.stringify(i);return`data:application/json;base64,${btoa(unescape(encodeURIComponent(c)))}`},mountToStage(e,t,o){if(!this.model)return;const n=Yt.getStage();if(!n)return;for(;n.children.length>0;)n.removeChildAt(0);const r=this._applyStageTransform(e,t,o);if(r){n.addChild(this.model);try{'autoUpdate'in this.model&&(this.model.autoUpdate=!0)}catch{}ce('模型已挂载到舞台',{stageWidth:r.stageWidth,stageHeight:r.stageHeight,scale:r.finalScale,modelWidth:r.modelWidth,modelHeight:r.modelHeight}),this.autoMotionLoopEnabled?this._startAutoMotionLoop():this._clearAutoMotionLoop()}},updateScale(e,t,o){this.model&&this._applyStageTransform(e,t,o)},_getModelBaseSize(){if(this.modelBaseBounds)return{width:this.modelBaseBounds.width,height:this.modelBaseBounds.height};if(this.modelBaseWidth&&this.modelBaseHeight)return{width:this.modelBaseWidth,height:this.modelBaseHeight};if(!this.model)return{width:500,height:800};const e=this.model.scale?.x||1,t=this.model.scale?.y||1;return{width:this.model.width>0&&0!==e?this.model.width/e:500,height:this.model.height>0&&0!==t?this.model.height/t:800}},getExpressions(){if(!this.model)return[];try{const e=uo(this.model);if(e.length>0)return e;const t=this._lastModelJson;if(t){const e=so(t);if(e.length>0)return e}return[]}catch(e){return de('获取表情列表失败',e),[]}},getMotionGroups(){const e={};if(!this.model)return e;const t=t=>{if(t&&'object'==typeof t)for(const[o,n]of Object.entries(t)){const t=String(o??''),r=t.trim();if(!r&&''!==t)continue;const a=r||'',i=Number(n),s=Number.isFinite(i)&&i>0?Math.max(1,Math.floor(i)):1,l=e[a];e[a]=Number.isFinite(l)&&l>0?Math.max(l,s):s}},o=this.model?.internalModel?.motionManager,n=o?.definitions;if(n&&'object'==typeof n)for(const[t,o]of Object.entries(n))Array.isArray(o)&&(e[t]=o.length);try{const t=po(this.model);for(const o of t)Object.prototype.hasOwnProperty.call(e,o)?(!Number.isFinite(e[o])||e[o]<=0)&&(e[o]=1):e[o]=1}catch(e){de('获取动作组列表失败',e)}try{t(lo(this.model?.internalModel?.settings)),t(lo(this.model?.internalModel?.motionManager?.settings))}catch(e){de('动作组运行时补充解析失败',e)}try{const e=this._lastModelJson;e&&t(lo(e))}catch(e){de('动作组兜底解析失败',e)}return e},getMotions(){if(!this.model)return[];try{const e=[],t=new Set,o=o=>{for(const n of Array.isArray(o)?o:[]){const o=String(n?.group??''),r=Number(n?.index),a=Number.isFinite(r)?Math.max(0,Math.floor(r)):0,i=String(n?.name??'').trim();if(!i)continue;const s=`${o}#${a}#${i.toLowerCase()}`;t.has(s)||(t.add(s),e.push({group:o,index:a,name:i}))}};o(Ao(this.model));const n=this._lastModelJson;if(n){const e=n,t=e?.FileReferences?.Motions??e?.Motions??e?.motions??null;t&&o(Ao({internalModel:{motionManager:{definitions:t},settings:n}}))}return e}catch(e){return de('获取动作列表失败',e),[]}},playExpression(e){if(this.model)try{if(e)this.model.expression(e);else{const e=this.getExpressions();if(e.length>0){const t=Math.floor(Math.random()*e.length);this.model.expression(e[t])}}}catch(e){de('播放表情失败:',e)}},playMotion(e,t){if(!this.model)return;const o=(e,t)=>{try{return void this.model.motion(e,t)}catch(o){const n=this.model?.internalModel?.motionManager;if('function'==typeof n?.startMotion)return void n.startMotion(e,t,3);if('function'==typeof n?.startRandomMotion)return void n.startRandomMotion(e,3);throw o}},n=()=>{try{const n=this.getMotions();if(!n.length)return!1;const r=n.find(o=>o.group===String(e??'')&&o.index===(t??0))||n.find(e=>'default'===String(e.group||'').trim().toLowerCase())||n[0];return!!r&&(o(r.group,r.index),!0)}catch{return!1}};try{if('string'==typeof e)o(e,t??0);else{const e=this.getMotionGroups(),t=Object.keys(e);if(t.length>0){const n=t[Math.floor(Math.random()*t.length)],r=e[n],a=Math.floor(Math.random()*r);o(n,a)}}}catch(t){if('string'==typeof e&&this.model){if(n())return}de('播放动作失败:',t)}},playRandomAnimation(){this.playExpression(),this.playMotion()},focusByClientPoint(e,t,o=!1){const n=this.model;if(n&&Number.isFinite(e)&&Number.isFinite(t)){try{if('function'==typeof n.focus)return void n.focus(e,t,o)}catch{return}try{const r=n?.internalModel?.focusController;if(!r||'function'!=typeof r.focus)return;const a=Yt.container?.getBoundingClientRect?.();if(!a||a.width<=0||a.height<=0)return;const i=(e-a.left)/a.width*2-1,s=(t-a.top)/a.height*2-1;r.focus(Math.max(-1,Math.min(1,i)),Math.max(-1,Math.min(1,-s)),o)}catch{}}},focusCenter(e=!0){const t=this.model;if(!t)return;const o=Yt.container?.getBoundingClientRect?.();if(o&&o.width>0&&o.height>0)this.focusByClientPoint(o.left+o.width/2,o.top+o.height/2,e);else try{const o=t?.internalModel?.focusController;if(!o||'function'!=typeof o.focus)return;o.focus(0,0,e)}catch{}},setMouthOpen(e,t){const o=this.model;if(!o?.internalModel?.coreModel)return!1;const n=o.internalModel.coreModel,r=Math.max(0,Math.min(1,t));this._mouthCurrentValue=r;const a=this._top(),i='[酒馆桌面宠物] LipSync参数';this._ensureLipSyncHooks(o),this._installCoreWriteMask(n);const s=(e,t)=>{let o=Number.NaN,r=Number.NaN;const a=e=>{const t=Number(e);return Number.isFinite(t)?t:Number.NaN};if(Number.isFinite(t)&&t>=0){try{'function'==typeof n.getParameterMinimumValue&&(o=a(n.getParameterMinimumValue(t)))}catch{}try{'function'==typeof n.getParameterMaximumValue&&(r=a(n.getParameterMaximumValue(t)))}catch{}}if(!Number.isFinite(o))try{'function'==typeof n.getParamMin&&(o=a(n.getParamMin(e)))}catch{}if(!Number.isFinite(r))try{'function'==typeof n.getParamMax&&(r=a(n.getParamMax(e)))}catch{}return Number.isFinite(o)||(o=0),(!Number.isFinite(r)||r<=o)&&(r=1),{min:o,max:r}},l=(e,t)=>{const{min:o,max:n}=s(e,t);return o<0&&n>0?r*n:o+(n-o)*r},c=e=>{try{if('function'==typeof n.getParameterIndex)return n.getParameterIndex(e)}catch{}try{if('function'==typeof n.getParamIndex)return n.getParamIndex(e)}catch{}return-1},d=e=>{const t=c(e),o=l(e,t);try{if('function'==typeof n.setParameterValueById)return n.setParameterValueById(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValueById)return n.addParameterValueById(e,o,1),!0}catch{}try{if('function'==typeof n.setParamFloat)return n.setParamFloat(e,o,1),!0}catch{}try{if('function'==typeof n.addParamFloat)return n.addParamFloat(e,o,1),!0}catch{}return!1},A=e=>{if(!Number.isFinite(e)||e<0)return!1;const t=(()=>{try{if('function'==typeof n.getParameterId)return String(n.getParameterId(e)||'')}catch{}return''})(),o=l(t||`__idx_${e}`,e);try{if('function'==typeof n.setParameterValueByIndex)return n.setParameterValueByIndex(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValueByIndex)return n.addParameterValueByIndex(e,o,1),!0}catch{}try{if('function'==typeof n.setParameterValue)return n.setParameterValue(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValue)return n.addParameterValue(e,o,1),!0}catch{}return!1},u=['ParamMouthOpenY','PARAM_MOUTH_OPEN_Y','ParamMouthOpen','ParamA','Param58','Param61','Param_Mouth_Open','mouth_open'];let p=!1;if(this._manualMouthParamEnabled&&this._manualMouthParamIds.length>0)for(const e of this._manualMouthParamIds){const t=c(e);d(e)&&(p=!0),A(t)&&(p=!0)}const m=new Set;for(const e of u){if(m.has(e))continue;m.add(e);const t=c(e);t>=0&&(d(e)&&(p=!0),A(t)&&(p=!0))}if(p)return!0;if(this._mouthParamCore!==n){this._mouthParamCore=n,this._mouthParamIds=[],this._mouthParamIndexes=[],this._mouthParamRangeMins=[],this._mouthParamRangeMaxs=[],this._mouthParamWarned=!1;try{if('function'==typeof n.getParameterCount&&'function'==typeof n.getParameterId){const e=Number(n.getParameterCount())||0,t=[];for(let o=0;o<e;o++){const e=String(n.getParameterId(o)||''),r=e.toLowerCase(),a=s(e,o);r.includes('mouth')||r.includes('lip')||'ParamA'===e?(this._mouthParamIds.push(e),this._mouthParamIndexes.push(o),this._mouthParamRangeMins.push(a.min),this._mouthParamRangeMaxs.push(a.max)):/^param\d+$/i.test(e)&&a.max>=8&&a.min>=-1&&t.push({id:e,idx:o,min:a.min,max:a.max})}if(0===this._mouthParamIds.length&&t.length>0){t.sort((e,t)=>t.max-e.max);const e=t.slice(0,3);for(const t of e)this._mouthParamIds.push(t.id),this._mouthParamIndexes.push(t.idx),this._mouthParamRangeMins.push(t.min),this._mouthParamRangeMaxs.push(t.max);try{a?.console?.log?.(`${i}: 使用数字参数回退`,e)}catch{}}}}catch{}}for(let e=0;e<this._mouthParamIds.length;e++){const t=this._mouthParamIds[e],o=this._mouthParamIndexes[e]??-1;d(t)&&(p=!0),A(o)&&(p=!0)}if(p)return!0;if(!this._mouthParamWarned){this._mouthParamWarned=!0;const e=`${i}: 未找到可用口型参数`;try{a?.console?.warn?.(e,{presetCandidates:u,scannedIds:this._mouthParamIds})}catch{}}return!1},_isMouthParam(e,t){if('number'==typeof e){if(this._mouthParamIndexes.includes(e))return!0;try{if('function'==typeof t?.getParameterId){const o=String(t.getParameterId(e)||'').trim();if(o)return this._isMouthParam(o,t)}}catch{}return!1}const o=String(e||'').trim().toLowerCase();return!!o&&(!!(this._manualMouthParamEnabled&&this._manualMouthParamIdSet.size>0&&this._manualMouthParamIdSet.has(o))||(!!['parammouthopeny','param_mouth_open_y','parammouthopen','parama','param58','param61','param_mouth_open','mouth_open'].includes(o)||this._mouthParamIds.some(e=>String(e||'').trim().toLowerCase()===o)))},_installCoreWriteMask(e){if(!e)return;if(this._writeMaskCore===e)return;if(this._writeMaskRestore){try{this._writeMaskRestore()}catch{}this._writeMaskCore=null,this._writeMaskRestore=null}const t=[],o=['setParameterValueById','addParameterValueById','setParamFloat','addParamFloat','setParameterValueByIndex','addParameterValueByIndex','setParameterValue','addParameterValue'],n=(e,t)=>{if(!Array.isArray(t)||0===t.length)return null;const o=t[0];return e.includes('ById')||'setParamFloat'===e||'addParamFloat'===e?'string'==typeof o?o:null:e.includes('ByIndex')?'number'==typeof o?o:null:'setParameterValue'!==e&&'addParameterValue'!==e||'number'!=typeof o&&'string'!=typeof o?null:o};for(const r of o){const o=e?.[r];'function'==typeof o&&(t.push({method:r,raw:o}),e[r]=(...t)=>{const a=n(r,t);if(!(null!==a&&this._lipSyncActive&&this._inModelUpdate&&this._isMouthParam(a,e)))return o.apply(e,t)})}this._writeMaskCore=e,this._writeMaskRestore=()=>{for(const o of t)try{e[o.method]=o.raw}catch{}}},_ensureLipSyncHooks(e){if(!e)return;if(this._updateHookModel===e)return;if(this._updateHookRestore){try{this._updateHookRestore()}catch{}this._updateHookRestore=null,this._updateHookModel=null}const t=e?.internalModel,o=t?.update;if('function'!=typeof o)return;const n=o.bind(t),r=this;t.update=function(...t){let o;r._inModelUpdate=!0;try{o=n(...t)}finally{if(r._inModelUpdate=!1,r._lipSyncActive)try{r._applyMouthValueToModel(e)}catch{}}return o},this._updateHookModel=e,this._updateHookRestore=()=>{try{t.update=o}catch{}}},_applyMouthValueToModel(e){if(!e?.internalModel?.coreModel)return!1;const t=Math.max(0,Math.min(1,this._mouthCurrentValue||0)),o=this._mouthCurrentValue;this._mouthCurrentValue=t;const n=this.setMouthOpen('__mouth_hook__',t);return this._mouthCurrentValue=o,n},_getMouthParamSource(){return this._manualMouthParamEnabled&&this._manualMouthParamIdSet.size>0?'manual':'auto'},getLipSyncDebugInfo(){this._refreshManualMouthParams();const e=this._getMouthParamSource(),t='manual'===e?this._manualMouthParamIdSet.size:this._mouthParamIds.length;return{lipSyncOverride:this._lipSyncActive?'active':'inactive',mouthParamsSource:e,mouthParamsCount:t}},destroyModel(){if(this._clearAutoMotionLoop(),this._lipSyncActive=!1,this._inModelUpdate=!1,this.model){try{this.model.parent&&this.model.parent.removeChild(this.model),this.model.destroy()}catch(e){de('模型销毁失败',e)}this.model=null}if(this._mouthParamCore=null,this._mouthParamIds=[],this._mouthParamIndexes=[],this._mouthParamRangeMins=[],this._mouthParamRangeMaxs=[],this._mouthParamWarned=!1,this._mouthCurrentValue=0,this._writeMaskRestore)try{this._writeMaskRestore()}catch{}if(this._writeMaskCore=null,this._writeMaskRestore=null,this._updateHookRestore)try{this._updateHookRestore()}catch{}this._updateHookModel=null,this._updateHookRestore=null,this._manualMouthParamEnabled=!1,this._manualMouthParamIds=[],this._manualMouthParamIdSet.clear(),this.modelBaseWidth=null,this.modelBaseHeight=null,this.modelBaseBounds=null,this._lastModelJson=null,this._lastModelJsonSourceUrl='',this._revokeLocalBlobUrls()},_waitForTextures:async(e,t)=>new Promise(o=>{let n=0;const r=()=>{if(n++,n>80){const n=e.internalModel,r=n?.textures||n?._textures||[],a=Array.isArray(r)?r:[],i=a.filter(e=>!!e?.baseTexture?.valid).length;return t?.(i,a.length),de(`纹理加载等待超时 (${i}/${a.length})，模型可能不可见`),void o(!1)}const a=e.internalModel;if(!a)return void setTimeout(r,100);const i=a.textures||a._textures||[];if(0===i.length)return t?.(1,1),void o(!0);const s=i.filter(e=>!!e&&(!e.baseTexture||e.baseTexture.valid)).length;t?.(s,i.length);i.every(e=>!!e&&(!e.baseTexture||e.baseTexture.valid))?o(!0):setTimeout(r,100)};r()})};let bo=null;function yo(){try{return window.parent??window}catch{return window}}const xo={audioContext:null,analyser:null,dataArray:null,source:null,animationFrameId:null,currentCharacterId:null,lastVolume:0,connectedAudioElements:new WeakSet,_proxyAudio:null,_proxyAudioCleanup:null,config:{fftSize:256,smoothingFactor:.5,sensitivity:2.5,minThreshold:.01},init(){if(this.audioContext)return void('suspended'===this.audioContext.state&&this.audioContext.resume().then(()=>{console.log(`[${l}] LipSync: AudioContext 已恢复`)}));const e=yo(),t=e.AudioContext||e.webkitAudioContext;t?(this.audioContext=new t,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.smoothingTimeConstant=this.config.smoothingFactor,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),console.log(`[${l}] LipSyncManager 初始化完成`)):console.warn(`[${l}] LipSync: 浏览器不支持 Web Audio API`)},_getProxiedAudioUrl(e){if(bo)return bo(e);const t=yo();if('function'==typeof t.getCorsProxyUrl)try{const o=t.getCorsProxyUrl(e);return console.log(`[${l}] LipSync: 使用 getCorsProxyUrl 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: getCorsProxyUrl 失败`,e)}if('function'==typeof t.enableCorsProxy)try{const o=t.enableCorsProxy(e);if('string'==typeof o&&o)return console.log(`[${l}] LipSync: 使用 enableCorsProxy 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: enableCorsProxy 失败`,e)}if(t.corsProxy?.getProxyUrl)try{const o=t.corsProxy.getProxyUrl(e);return console.log(`[${l}] LipSync: 使用 corsProxy.getProxyUrl 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: corsProxy.getProxyUrl 失败`,e)}if(t.location){const o=t.location.origin;return console.log(`[${l}] LipSync: 使用默认代理端点 /proxy`),`${o}/proxy?url=${encodeURIComponent(e)}`}return e},connectAudio(e){if(!e)return!1;if(this.connectedAudioElements.has(e))return this.init(),'suspended'===this.audioContext?.state&&this.audioContext.resume(),!0;if(this.init(),!this.audioContext||!this.analyser)return!1;'suspended'===this.audioContext.state&&this.audioContext.resume().catch(e=>console.warn('AudioContext resume failed:',e));try{if(this.source)try{this.source.disconnect()}catch{}const t=yo();let o=e;const n=e.src||'',r=n.includes('127.0.0.1')||n.includes('localhost'),a=n.startsWith('data:'),i=n.startsWith('blob:');let s=!1;try{const e=t.location?.origin||window.location.origin;s=new URL(n,e).origin===e}catch{}if(!(r||a||i||s)){console.log(`[${l}] LipSync: 检测到跨域音频，尝试使用代理`);const t=this._getProxiedAudioUrl(n);if(t&&t!==n){o=new Audio(t),o.crossOrigin='anonymous',console.log(`[${l}] LipSync: 创建代理音频元素`,t.substring(0,50)+'...'),o.currentTime=e.currentTime,o.volume=.001,e.paused||o.play().catch(e=>{console.warn(`[${l}] LipSync: 代理音频播放失败`,e)});const n=()=>{this._proxyAudio&&this._proxyAudio.paused&&(this._proxyAudio.currentTime=e.currentTime,this._proxyAudio.play().catch(()=>{}))},r=()=>{this._proxyAudio&&this._proxyAudio.pause()},a=()=>{this._proxyAudio&&(this._proxyAudio.currentTime=e.currentTime)};e.addEventListener('play',n),e.addEventListener('playing',n),e.addEventListener('pause',r),e.addEventListener('ended',r),e.addEventListener('seeked',a),this._proxyAudio=o,this._proxyAudioCleanup=()=>{e.removeEventListener('play',n),e.removeEventListener('playing',n),e.removeEventListener('pause',r),e.removeEventListener('ended',r),e.removeEventListener('seeked',a)}}}return console.log(`[${l}] LipSync: 连接音频源`,o.src?.substring(0,50)+'...'),this.source=this.audioContext.createMediaElementSource(o),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.connectedAudioElements.add(e),!0}catch(e){return console.warn(`[${l}] LipSync: 连接失败 (可能是跨域或已被其他 Source 连接)`,e),!1}},getVolume(){if(!this.analyser||!this.dataArray)return 0;this.analyser.getByteFrequencyData(this.dataArray);let e=0;const t=Math.floor(.75*this.dataArray.length);for(let o=0;o<t;o++)e+=this.dataArray[o];const o=e/t/255;return Math.min(1,o*this.config.sensitivity)},async startSync(e){if(this.stopSync(),this.currentCharacterId=e,go._setLipSyncActive(!0),'suspended'===this.audioContext?.state)try{await this.audioContext.resume(),console.log(`[${l}] LipSync: AudioContext 已恢复`)}catch(e){console.warn(`[${l}] LipSync: AudioContext 恢复失败`,e)}console.log(`[${l}] LipSync: 开始口型同步 - characterId=${e}, AudioContext.state=${this.audioContext?.state}`);let t=0;const o=()=>{if(!this.currentCharacterId)return;let e=this.getVolume();e<this.config.minThreshold&&(e=0),e=.4*this.lastVolume+.6*e,this.lastVolume=e,t++,t%30==0&&console.log(`[${l}] LipSync: 音量=${e.toFixed(3)}, rawData[0]=${this.dataArray?.[0]}`),go.setMouthOpen(this.currentCharacterId,e),this.animationFrameId=requestAnimationFrame(o)};o()},stopSync(){if(this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentCharacterId&&go.setMouthOpen(this.currentCharacterId,0),this.currentCharacterId=null,this.lastVolume=0,go._setLipSyncActive(!1),this._proxyAudioCleanup){try{this._proxyAudioCleanup()}catch{}this._proxyAudioCleanup=null}if(this._proxyAudio){try{this._proxyAudio.pause(),this._proxyAudio.src=''}catch{}this._proxyAudio=null}},cleanup(){if(this.stopSync(),this.source){try{this.source.disconnect()}catch{}this.source=null}}};function vo(){try{return window.parent??window}catch{return window}}function Co(){try{return he().settings}catch{return{}}}let wo=null;function Bo(e){if(wo)wo(e);else{try{const t=vo(),o=t?.toastr||window?.toastr;if(o?.info)return void o.info(e)}catch{}console.log(`[${l}]`,e)}}function So(e,t=160){const o=String(e||'');return o.length<=t?o:`${o.slice(0,t)}...`}function _o(e,t=''){if(404!==e)return!1;const o=String(t||'').toLowerCase();return o.includes('not found')||o.includes('/proxy')||o.includes('cannot get')}function ko(){return!!go.model}const Eo={enabled:!0,provider:Pe.LITTLEWHITEBOX,autoPlay:!0,isPlaying:!1,isLoading:!1,currentAudio:null,currentSegmentId:null,littleWhiteBox:null,xiaobaixTts:null,_gptSoVitsResolvedProxyRoute:'',_gptSoVitsActiveWeights:{gpt:'',sovits:''},_gptSoVitsWeightSwitchUnavailable:!1,_gptSoVitsWeightSwitchWarned:!1,_gptSoVitsProxyWarned:!1,_gptSoVitsFetchController:null,_edgeDirectFetchController:null,_edgeDirectSocket:null,_edgeDirectObjectUrl:'',_refreshProviderState(){const e=He();this.provider=e,this.autoPlay=!1!==Co()?.ttsAutoPlay;const t=vo();return e===Pe.LITTLEWHITEBOX?(this.xiaobaixTts=null,this.littleWhiteBox=null,t?.xiaobaixTts?(this.xiaobaixTts=t.xiaobaixTts,console.log(`[${l}] TTSManager: 已连接到 xiaobaixTts`)):t?.LittleWhiteBox&&(this.littleWhiteBox=t.LittleWhiteBox,console.log(`[${l}] TTSManager: 已连接到 LittleWhiteBox`)),this.xiaobaixTts||this.littleWhiteBox?(this.enabled=!0,!0):(console.warn(`[${l}] TTSManager: 未找到 xiaobaixTts/LittleWhiteBox，将禁用TTS`),this.enabled=!1,!1)):(this.enabled=!0,!0)},_onPlaybackEnded(e='unknown'){this._cleanupEdgeDirectResources(),console.log(`[${l}] TTS: 播放结束 - reason=${e}`),this.isPlaying=!1,this.isLoading=!1,this.currentAudio=null,this.currentSegmentId=null,this.hideLoadingIndicator(),xo.stopSync()},init(){this._refreshProviderState();try{const e=vo(),t=e?.jQuery||e?.$;t&&t(e).on('tts_complete tts_end',()=>{this._onPlaybackEnded('littlewhitebox_event')})}catch{}},showLoadingIndicator(){try{const e=vo();e.document.getElementById('desktop-pet-stage')?.classList.add('desktop-pet-tts-active')}catch{}},hideLoadingIndicator(){try{const e=vo();e.document.getElementById('desktop-pet-stage')?.classList.remove('desktop-pet-tts-active')}catch{}},_abortGptSoVitsFetch(e='manual'){if(this._gptSoVitsFetchController){try{this._gptSoVitsFetchController.abort(e)}catch{}this._gptSoVitsFetchController=null}},_cleanupEdgeDirectResources(){if(this._edgeDirectFetchController){try{this._edgeDirectFetchController.abort('cleanup')}catch{}this._edgeDirectFetchController=null}if(this._edgeDirectSocket){try{this._edgeDirectSocket.close(1e3,'cleanup')}catch{}this._edgeDirectSocket=null}if(this._edgeDirectObjectUrl){try{URL.revokeObjectURL(this._edgeDirectObjectUrl)}catch{}this._edgeDirectObjectUrl=''}},stop(){if(this.isPlaying||this.isLoading||this._edgeDirectSocket||this._edgeDirectFetchController||this._edgeDirectObjectUrl){this._abortGptSoVitsFetch('stop'),this._cleanupEdgeDirectResources(),console.log(`[${l}] TTS: 中止当前播放`);try{if(this.currentAudio&&'function'==typeof this.currentAudio.pause){try{this.currentAudio.pause()}catch{}try{this.currentAudio.src='','function'==typeof this.currentAudio.load&&this.currentAudio.load()}catch{}}if(this.xiaobaixTts&&this.xiaobaixTts.player){const e=this.xiaobaixTts.player;'function'==typeof e._stopCurrent&&e._stopCurrent(),'function'==typeof e.clear&&(e.clear(),console.log(`[${l}] TTS: 已清空播放队列`))}else this.xiaobaixTts&&'function'==typeof this.xiaobaixTts.stop?this.xiaobaixTts.stop():this.littleWhiteBox&&'function'==typeof this.littleWhiteBox.stop&&this.littleWhiteBox.stop()}catch(e){console.warn(`[${l}] TTS: 停止播放失败`,e)}this.isPlaying=!1,this.isLoading=!1,this.currentAudio=null,this.currentSegmentId=null,this.hideLoadingIndicator(),xo.stopSync()}},_getCurrentAudioElement(){if(this.currentAudio)return this.currentAudio;if(this.xiaobaixTts?.player?.currentAudio)return this.xiaobaixTts.player.currentAudio;if(this.xiaobaixTts?.player?.audio)return this.xiaobaixTts.player.audio;if(this.xiaobaixTts?.player?.audioElements?.length>0)return this.xiaobaixTts.player.audioElements[0];if(this.xiaobaixTts?.audio)return this.xiaobaixTts.audio;const e=vo(),t=e.document.querySelectorAll('audio');for(const e of t)if(e.src&&!e.paused)return e;const o=e.document.querySelector('audio[src]');return o||null},_getPreferredAudioElement(){return this.currentAudio?this.currentAudio:this.xiaobaixTts?.player?.currentAudio?this.xiaobaixTts.player.currentAudio:this.xiaobaixTts?.player?.audio?this.xiaobaixTts.player.audio:this.xiaobaixTts?.player?.audioElements?.length>0?this.xiaobaixTts.player.audioElements[0]:this.xiaobaixTts?.audio?this.xiaobaixTts.audio:null},_isProxyUrl(e){const t=function(e){try{return new URL(String(e||''))}catch{return null}}(e);return!!t&&/^\/proxy(\/|\?|$)/i.test(t.pathname)},_buildGptSoVitsProxyUrl(e,t){const o=String(t||'').trim();if(!o)return'';const n=encodeURIComponent(o),r=window.location?.origin||'';switch(e){case'proxy_path_relative':return`/proxy/${n}`;case'proxy_path_origin':return r?`${r}/proxy/${n}`:'';case'proxy_query_relative':return`/proxy?url=${n}`;case'proxy_query_origin':return r?`${r}/proxy?url=${n}`:'';default:return''}},_rememberProxyRoute(e,t){e&&this._gptSoVitsResolvedProxyRoute!==e&&(this._gptSoVitsResolvedProxyRoute=e,console.log(`[${l}] GPT-SoVITS 浠ｇ悊璺敱宸查攣瀹? ${e} -> ${So(t,96)}`))},_getProxiedAudioUrl(e){const t=String(e||'').trim();if(!t)return t;if(this._isProxyUrl(t))return t;const o=vo();if('function'==typeof o.getCorsProxyUrl)try{const e=o.getCorsProxyUrl(t);if('string'==typeof e&&e)return e}catch{}if('function'==typeof o.enableCorsProxy)try{const e=o.enableCorsProxy(t);if('string'==typeof e&&e)return e}catch{}if(o.corsProxy?.getProxyUrl)try{const e=o.corsProxy.getProxyUrl(t);if('string'==typeof e&&e)return e}catch{}const n=String(this._gptSoVitsResolvedProxyRoute||'').trim();if(n){const e=this._buildGptSoVitsProxyUrl(n,t);if(e)return e}return this._buildGptSoVitsProxyUrl('proxy_path_relative',t)||this._buildGptSoVitsProxyUrl('proxy_query_relative',t)||t},_buildGptSoVitsTtsUrl(e,t){const o=Xe(),n=String(o.apiUrl||'').replace(/\/$/,''),r=String(o.endpoint||'/tts').trim(),a=r.startsWith('/')?r:`/${r}`;if(!n)return'';try{const r=new URL(n+a),i=t?.gptSoVitsModel||null,s=i?.params||{},l=t?.gptSoVits||{},c=String(l.textLang||s.textLang||o.textLang||'auto').trim()||'auto',d=String(l.promptLang||s.promptLang||'zh').trim()||'zh',A=String(l.refAudioPath||'').trim(),u=String(l.promptText||s.promptText||'').trim(),p=String(l.textSplitMethod||s.textSplitMethod||o.textSplitMethod||'').trim(),m=String(l.mediaType||s.mediaType||o.mediaType||'').trim(),h=!!(l.streamingMode??s.streamingMode??o.streamingMode),f=Number(l.speedFactor??s.speedFactor??o.speedFactor);return r.searchParams.set('text',e),r.searchParams.set('text_lang',c),r.searchParams.set('ref_audio_path',A),r.searchParams.set('prompt_lang',d),r.searchParams.set('prompt_text',u),p&&r.searchParams.set('text_split_method',p),m&&r.searchParams.set('media_type',m),r.searchParams.set('streaming_mode',h?'true':'false'),Number.isFinite(f)&&f>0&&r.searchParams.set('speed_factor',String(f)),r.toString()}catch(e){return console.warn(`[${l}] GPT-SoVITS: 生成URL失败`,e),''}},async _requestGptSoVitsApi(e,t,o={},n=void 0){const r=Xe(),a=String(r.apiUrl||'').replace(/\/$/,''),i=String(t||'').trim()||'/',s=i.startsWith('/')?i:`/${i}`;if(!a)throw new Error('GPT-SoVITS API 地址为空');const l=new URL(a+s);Object.entries(o||{}).forEach(([e,t])=>{null!=t&&''!==t&&l.searchParams.set(String(e),String(t))});const c=l.toString(),d=[];if(r.useCorsProxy){const e=String(this._gptSoVitsResolvedProxyRoute||'').trim(),t=new Set,o=(e,o)=>{o&&!t.has(o)&&(t.add(o),d.push({route:e,url:o}))};e&&o(e,this._buildGptSoVitsProxyUrl(e,c)),o('proxy_path_relative',this._buildGptSoVitsProxyUrl('proxy_path_relative',c)),o('proxy_path_origin',this._buildGptSoVitsProxyUrl('proxy_path_origin',c)),o('proxy_query_relative',this._buildGptSoVitsProxyUrl('proxy_query_relative',c)),o('proxy_query_origin',this._buildGptSoVitsProxyUrl('proxy_query_origin',c)),o('direct',c)}else d.push({route:'direct',url:c});const A=[];for(const t of d){const o=new AbortController;this._gptSoVitsFetchController=o;try{const r={method:e,mode:'cors',credentials:'omit',signal:o.signal,headers:{}};void 0!==n&&(r.headers['Content-Type']='application/json',r.body=JSON.stringify(n));const a=await fetch(t.url,r),i=await a.text();if(a.ok)return'direct'!==t.route&&this._rememberProxyRoute(t.route,t.url),{text:i,status:a.status,url:t.url,route:t.route};if('direct'!==t.route&&_o(a.status,i)){A.push(`${t.route}:HTTP${a.status}(proxy-not-found)`);continue}A.push(`${t.route}:HTTP${a.status}:${So(i,120)}`)}catch(e){const o=e?.message||String(e);A.push(`${t.route}:${o}`)}finally{this._gptSoVitsFetchController===o&&(this._gptSoVitsFetchController=null)}}throw new Error(`${e} ${s} 失败 -> ${A.join(' | ')}`)},async _fetchGptSoVitsApi(e,t={}){const{text:o}=await this._requestGptSoVitsApi('GET',e,t);return o},async _postGptSoVitsApi(e,t={}){const{text:o}=await this._requestGptSoVitsApi('POST',e,{},t);return o},async _setGptSoVitsWeights(e,t){const o='gpt'===e?'gpt':'sovits',n=String(t||'').trim();if(!n)return;const r=`/set_${o}_weights`;await this._fetchGptSoVitsApi(r,{weights_path:n})},async _setGptSoVitsModelPair(e,t,o=''){const n=Xe(),r=String(o||n.setModelEndpoint||'/set_model').trim()||'/set_model';try{return void await this._postGptSoVitsApi(r,{gpt_model_path:String(e||'').trim(),sovits_model_path:String(t||'').trim()})}catch{await this._fetchGptSoVitsApi(r,{gpt_model_path:String(e||'').trim(),sovits_model_path:String(t||'').trim()})}},async _ensureGptSoVitsWeights(e){const t=Xe(),o=e?.gptSoVitsModel||null,n=e?.gptSoVits||{},r=o?.params||{},a=o?.paths||{},i=!!(n.strictWeightSwitch??r.strictWeightSwitch??t.strictWeightSwitch);let s=ze(n.modelSwitchMode||r.modelSwitchMode||t.modelSwitchMode);const c=String(n.setModelEndpoint||r.setModelEndpoint||t.setModelEndpoint||'/set_model').trim()||'/set_model',d=String(n.gptWeightsPath||a.gptWeightsPath||'').trim(),A=String(n.sovitsWeightsPath||a.sovitsWeightsPath||'').trim();if('none'===s)return!1;if(!d&&!A)return!0;if(this._gptSoVitsWeightSwitchUnavailable){if(this._gptSoVitsWeightSwitchWarned||(this._gptSoVitsWeightSwitchWarned=!0,Bo('GPT-SoVITS: 当前环境无法请求 /set_*（CORS/代理限制），已跳过自动切模型')),i)throw new Error('自动切权重已不可用（请求可能被浏览器或 CORS 拦截）');return!1}const u=[],p=async e=>{if(!('set_weights'===s&&!!d&&!!A&&!i))return!1;const t=String(e||'');if(!/404|405|not found|cannot\s+(get|post)|method not allowed/i.test(t))return!1;try{return console.warn(`[${l}] GPT-SoVITS: set_weights 接口不可用，自动回退 set_model`),await this._setGptSoVitsModelPair(d,A,c),this._gptSoVitsActiveWeights.gpt=d,this._gptSoVitsActiveWeights.sovits=A,!0}catch(e){return console.warn(`[${l}] GPT-SoVITS: set_model 回退失败`,e),!1}};if('set_model'===s&&d&&A){if(d!==this._gptSoVitsActiveWeights.gpt||A!==this._gptSoVitsActiveWeights.sovits){let e='',t=!1;try{await this._setGptSoVitsModelPair(d,A,c),this._gptSoVitsActiveWeights.gpt=d,this._gptSoVitsActiveWeights.sovits=A}catch(o){e=String(o?.message||o||'unknown error'),t=/failed to fetch/i.test(e),console.warn(`[${l}] GPT-SoVITS: set_model 切换失败`,o)}if(e&&!i){console.warn(`[${l}] GPT-SoVITS: set_model 失败，回退 set_weights 兼容模式`);try{d&&d!==this._gptSoVitsActiveWeights.gpt&&(await this._setGptSoVitsWeights('gpt',d),this._gptSoVitsActiveWeights.gpt=d),A&&A!==this._gptSoVitsActiveWeights.sovits&&(await this._setGptSoVitsWeights('sovits',A),this._gptSoVitsActiveWeights.sovits=A),e=''}catch(t){e=`${e} | fallback_set_weights: ${String(t?.message||t||'unknown error')}`}}if(e&&t&&(this._gptSoVitsWeightSwitchUnavailable=!0,console.warn(`[${l}] GPT-SoVITS: /set_model 请求被浏览器拦截，后续将跳过自动切模型`),!i))return this._gptSoVitsWeightSwitchWarned||(this._gptSoVitsWeightSwitchWarned=!0,Bo('GPT-SoVITS: 当前环境无法请求 /set_*（CORS/代理限制），已跳过自动切模型')),!1;e&&u.push(`set_model: ${e}`)}if(u.length>0){if(i)throw new Error(`权重切换失败: ${u.join(' | ')}`);Bo(`GPT-SoVITS 权重切换失败，继续使用当前模型（${u[0].length>120?`${u[0].slice(0,120)}...`:u[0]}）`)}return!0}if('set_model'!==s||d&&A||(console.warn(`[${l}] GPT-SoVITS: modelSwitchMode=set_model 但缺少双权重路径，回退 set_weights 逻辑`),s='set_weights'),'set_weights'===s){if(d&&d!==this._gptSoVitsActiveWeights.gpt)try{await this._setGptSoVitsWeights('gpt',d),this._gptSoVitsActiveWeights.gpt=d}catch(e){const t=String(e?.message||e||'unknown error');if(await p(t))return!0;u.push(`gpt: ${t}`);const o=/failed to fetch/i.test(t);if(o&&(this._gptSoVitsWeightSwitchUnavailable=!0),o){if(console.warn(`[${l}] GPT-SoVITS: /set_gpt_weights 请求被浏览器拦截，后续将跳过自动切模型`),!i)return this._gptSoVitsWeightSwitchWarned||(this._gptSoVitsWeightSwitchWarned=!0,Bo('GPT-SoVITS: 当前环境无法请求 /set_*（CORS/代理限制），已跳过自动切模型')),!1}else console.warn(`[${l}] GPT-SoVITS: 切换 gpt 权重失败`,e)}if(A&&A!==this._gptSoVitsActiveWeights.sovits)try{await this._setGptSoVitsWeights('sovits',A),this._gptSoVitsActiveWeights.sovits=A}catch(e){const t=String(e?.message||e||'unknown error');if(await p(t))return!0;u.push(`sovits: ${t}`);const o=/failed to fetch/i.test(t);if(o&&(this._gptSoVitsWeightSwitchUnavailable=!0),o){if(console.warn(`[${l}] GPT-SoVITS: /set_sovits_weights 请求被浏览器拦截，后续将跳过自动切模型`),!i)return this._gptSoVitsWeightSwitchWarned||(this._gptSoVitsWeightSwitchWarned=!0,Bo('GPT-SoVITS: 当前环境无法请求 /set_*（CORS/代理限制），已跳过自动切模型')),!1}else console.warn(`[${l}] GPT-SoVITS: 切换 sovits 权重失败`,e)}}if(u.length>0){const e=u[0],t=e.length>120?`${e.slice(0,120)}...`:e;if(i)throw new Error(`权重切换失败: ${u.join(' | ')}`);Bo(`GPT-SoVITS 权重切换失败，继续使用当前模型（${t}）`)}return!0},async _speakWithGptSoVits(e,t,o){const n=Xe(),r=o?.gptSoVits||{};if(!n.apiUrl)return Bo('GPT-SoVITS: 请先在设置中填写 API 地址'),!1;if(!String(r.refAudioPath||'').trim())return Bo('GPT-SoVITS: 当前音色缺少 refAudioPath'),!1;try{await this._ensureGptSoVitsWeights(o)}catch(e){return Bo(`GPT-SoVITS 权重切换失败：${So(String(e?.message||e||'unknown error'),120)}`),!1}const a=this._buildGptSoVitsTtsUrl(e.text,o);if(!a)return Bo('GPT-SoVITS: 无法生成请求URL'),!1;const i=n.useCorsProxy?this._getProxiedAudioUrl(a):a,s=new Audio;s.crossOrigin='anonymous',s.src=i,this.currentAudio=s,this.currentSegmentId=t;const c=()=>{this.currentAudio===s&&this._onPlaybackEnded('gpt_sovits_audio_ended')};s.addEventListener('ended',c,{once:!0}),s.addEventListener('error',e=>{console.warn(`[${l}] GPT-SoVITS: audio error`,e),!this._gptSoVitsProxyWarned&&n.useCorsProxy?(this._gptSoVitsProxyWarned=!0,Bo('GPT-SoVITS 代理失败，请检查 /proxy 路由和 CORS 设置')):Bo('GPT-SoVITS 播放失败（请检查地址/代理/CORS）'),c()},{once:!0});try{await s.play()}catch(e){return console.warn(`[${l}] GPT-SoVITS: play() 失败`,e),Bo('GPT-SoVITS 播放被浏览器拦截（需要用户交互）'),c(),!1}if(this.isPlaying=!0,ko()){const t=e.speaker||'pet';console.log(`[${l}] TTS: 检查口型同步: hasLive2D=true, speaker=${t}`),this._startLipSyncOnPlay(t)}else console.log(`[${l}] TTS: Live2D 未就绪，跳过口型同步`);return!0},async _speakWithEdgeDirect(e,t,o){if(!String(o.value||o.name||'').trim())return Bo('EdgeTTS 直连：无可用音色'),!1;this._cleanupEdgeDirectResources();const n=new AbortController;let r;this._edgeDirectFetchController=n;try{r=await async function(e,t,o={}){const n=Be(String(e||'')).trim();if(!n)throw new Error('EdgeTTS text is empty');const r=Se(t);if(!r)throw new Error('EdgeTTS voice is empty');const a=await Ee(),i=a.security,s=[];i&&(s.push({socketUrl:`${be}&Sec-MS-GEC=${encodeURIComponent(i.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(i.secMsGecVersion)}&ConnectionId=${we()}`,timestampMode:'utc_string',label:'with-sec/utc'}),s.push({socketUrl:`${be}&Sec-MS-GEC=${encodeURIComponent(i.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(i.secMsGecVersion)}&ConnectionId=${we()}`,timestampMode:'iso_compact',label:'with-sec/iso'}));const l=`${be}&ConnectionId=${we()}`;s.push({socketUrl:l,timestampMode:'utc_string',label:'plain/utc'}),s.push({socketUrl:l,timestampMode:'iso_compact',label:'plain/iso'});let c=null;const d=[];for(const e of s)try{return await Ne(e.socketUrl,n,r,o,e.timestampMode,e.label)}catch(t){c=t;const n=t instanceof Error?t.message:String(t);if(d.push(`${e.label}: ${n}`),o.signal?.aborted)throw Ce('EdgeTTS direct synthesis aborted')}if(d.length>0){const e=String(globalThis.navigator?.userAgent||''),t=/Edg\//i.test(e),o=d.every(e=>/opened=false/.test(e)),n=!t&&o,r=!i&&a.error?` security-unavailable=${a.error};`:'';throw new Error(`EdgeTTS direct synthesis failed.${r}${n?' likely-cause=ua-not-edg;':''} ${d.join(' | ')}`)}throw c instanceof Error?c:new Error('EdgeTTS direct synthesis failed')}(e.text,o,{signal:n.signal,onSocket:e=>{this._edgeDirectSocket=e}})}catch(e){if(!('AbortError'===e?.name)){const t=So(e?.message||String(e),180),o=/likely-cause=ua-not-edg/i.test(t)?'（当前浏览器不是 Edge，微软接口通常会拒绝握手；请改用 Edge 浏览器重试）':/1006|403|websocket/i.test(t)?'（可能是浏览器 CSP/网络策略拦截了 wss 连接；也可切换 Edge 浏览器复测）':'';console.warn(`[${l}] EdgeTTS 直连合成失败:`,e),Bo(`EdgeTTS 直连失败：${t}${o}`)}return!1}finally{this._edgeDirectFetchController===n&&(this._edgeDirectFetchController=null),this._edgeDirectSocket=null}if(!r||r.size<=0)return Bo('EdgeTTS 直连未返回音频数据'),!1;const a=URL.createObjectURL(r);this._edgeDirectObjectUrl=a;const i=new Audio;i.crossOrigin='anonymous',i.src=a,this.currentAudio=i,this.currentSegmentId=t;const s=()=>{this.currentAudio===i&&this._onPlaybackEnded('edge_direct_audio_ended')};i.addEventListener('ended',s,{once:!0}),i.addEventListener('error',e=>{console.warn(`[${l}] EdgeTTS 直连播放失败:`,e),Bo('EdgeTTS 直连播放失败，可切换 Edge 浏览器复测'),s()},{once:!0});try{await i.play()}catch(e){return console.warn(`[${l}] EdgeTTS 直连 play() 失败:`,e),Bo('EdgeTTS 播放被浏览器拦截，请先进行一次页面交互'),s(),!1}if(this.isPlaying=!0,ko()){const t=e.speaker||'pet';this._startLipSyncOnPlay(t)}return!0},_startLipSyncWhenModelReady(e,t=5e3){const o=Date.now(),n=()=>{ko()?this._startLipSyncOnPlay(e,t):Date.now()-o<t?setTimeout(n,120):console.warn(`[${l}] LipSync: 模型加载超时，放弃口型同步 - characterId=${e}`)};n()},async _waitForModelReadyBeforeTTS(e,t=5e3){const o=Date.now();for(;Date.now()-o<t;){if(ko())return!0;await new Promise(e=>setTimeout(e,120))}return console.warn(`[${l}] TTS: 等待模型就绪超时，仍继续请求TTS`),!1},_startLipSyncOnPlay(e,t=5e3){console.log(`[${l}] LipSync: _startLipSyncOnPlay 被调用 - characterId=${e}`);const o=Date.now();let n=!1;const r=()=>{const a=this._getPreferredAudioElement(),i=a||this._getCurrentAudioElement();if(console.log(`[${l}] LipSync: 获取音频元素 -`,i?`src=${i.src?.substring(0,50)}... paused=${i.paused} currentTime=${i.currentTime}`:'null'),!i)return void(Date.now()-o<t&&!n?setTimeout(r,100):n||console.warn(`[${l}] LipSync: 超时未找到音频元素`));if(!i.paused)return console.log(`[${l}] LipSync: 音频已在播放，立即启动口型同步`),n=!0,void this._bindLipSyncToAudio(i,e);if(!a)return void(Date.now()-o<t&&!n?setTimeout(r,100):n||(console.warn(`[${l}] LipSync: 等待播放超时，尝试强制启动`),i.src&&this._bindLipSyncToAudio(i,e)));console.log(`[${l}] LipSync: 等待音频播放...`);const s=()=>{n||(n=!0,console.log(`[${l}] LipSync: 音频开始播放，启动口型同步`),this._bindLipSyncToAudio(i,e))};i.addEventListener('playing',s,{once:!0}),i.addEventListener('play',s,{once:!0});const c=()=>{n||i.currentTime>0&&!i.paused&&(console.log(`[${l}] LipSync: timeupdate 触发，启动口型同步`),s())};i.addEventListener('timeupdate',c),setTimeout(()=>{i.removeEventListener('playing',s),i.removeEventListener('play',s),i.removeEventListener('timeupdate',c),n||(console.warn(`[${l}] LipSync: 等待播放超时，尝试强制启动`),i.src&&this._bindLipSyncToAudio(i,e))},t)};r()},_bindLipSyncToAudio(e,t){xo.connectAudio(e)&&xo.startSync(t);const o=()=>{console.log(`[${l}] LipSync: 音频结束/暂停，停止口型同步`),xo.stopSync(),e.removeEventListener('ended',o),e.removeEventListener('pause',o)};e.addEventListener('ended',o,{once:!0}),e.addEventListener('pause',o,{once:!0})},async speak(e,t){if(!e||'dialogue'!==e.type)return void(e&&'narration'===e.type&&console.log(`[${l}] TTS: 跳过旁白 - ${e.text.substring(0,30)}...`));if(!e.text)return;const o=He();if(o===this.provider&&this.enabled||this._refreshProviderState(),!this.enabled)return;const n=Co(),r=e.tts||{},a=function(e){try{return JSON.parse(localStorage.getItem(Ie())||'{}')[e]||null}catch{return null}}(e.speaker);let i=r.speaker||a||n.ttsDefaultSpeaker;i||(i=o===Pe.GPT_SOVITS_V2?e.speaker||'':'桃夭'),i||(i='桃夭');const s=r.context||'',c=await async function(e){if(!e)return null;const t=await vt();let o=t.find(t=>t.name===e);if(o)return o;if(o=t.find(t=>t.value===e),o)return o;const n=He(),r=n===Pe.GPT_SOVITS_V2&&tt(t)||t[0];return r?(console.warn(`[${l}] 未找到音色 "${e}"，使用默认: ${r.name}`),r):null}(String(i||''));if(!c)return console.error(`[${l}] TTS播放失败: 无法解析音色 "${i}" (provider=${o})`),void(o===Pe.GPT_SOVITS_V2&&Bo('GPT-SoVITS: 请先在设置中配置音色列表'));if(console.log(`[${l}] TTS播放: provider=${o}, voiceName=${i}, context=${s||'无'}, text=${e.text.substring(0,30)}...`),ko())try{const e=go.getLipSyncDebugInfo();console.log(`[${l}] TTS口型策略: lipSyncOverride=active, mouthParamsSource=${e.mouthParamsSource}, count=${e.mouthParamsCount}`)}catch{}this.isLoading=!0,this.showLoadingIndicator();try{if(await this._waitForModelReadyBeforeTTS(e.speaker),o===Pe.GPT_SOVITS_V2)return void await this._speakWithGptSoVits(e,t,c);if(o===Pe.EDGE_TTS_DIRECT)return void await this._speakWithEdgeDirect(e,t,c);const n=c.value,r=Bt(n);if(this.xiaobaixTts&&'function'==typeof this.xiaobaixTts.speak)return await this.xiaobaixTts.speak(e.text,{speaker:n,resourceId:r,contextTexts:s?[s]:[]}),this.isPlaying=!0,this.currentSegmentId=t,void(ko()&&this._startLipSyncOnPlay(e.speaker||'pet'));if(this.littleWhiteBox&&'function'==typeof this.littleWhiteBox.callGenerate)return await this.littleWhiteBox.callGenerate({message:e.text,speaker:n,resourceId:r,contextTexts:s?[s]:[]}),this.isPlaying=!0,this.currentSegmentId=t,void(ko()&&this._startLipSyncOnPlay(e.speaker||'pet'));console.warn(`[${l}] TTS: 未找到可用的 TTS 接口，请确保 LittleWhiteBox 插件已安装并启用`)}catch(e){console.error(`[${l}] TTS播放失败:`,e)}finally{this.isLoading=!1,this.hideLoadingIndicator()}}},Vo={messageCount:0,ignoreNextCount:0,_onTrigger:null,_stops:[],_lastUserSignalAt:0,_config:{autoTrigger:!0,triggerInterval:3,triggerProbability:60,commentTriggerMode:'ai'},init(e,t){this._config={...e},this._onTrigger=t,this._lastUserSignalAt=0;const o=this._bindEvent('MESSAGE_SENT',e=>{ce('检测到用户发送消息(MESSAGE_SENT)'),this._recordUserSignal('message_sent')});o&&this._stops.push(o);const n=this._bindEvent('USER_MESSAGE_RENDERED',e=>{ce('检测到用户消息渲染(USER_MESSAGE_RENDERED)'),this._recordUserSignal('user_message_rendered')});n&&this._stops.push(n);const r=this._bindEvent('GENERATION_AFTER_COMMANDS',(e,t,o)=>{o||t?.quiet_prompt||(ce('检测到用户发送消息(GENERATION_AFTER_COMMANDS)'),this._recordUserSignal('generation_after_commands'))});r&&this._stops.push(r);const a=this._bindEvent('GENERATION_STARTED',(e,t,o)=>{});a&&this._stops.push(a);const i=this._bindEvent('GENERATION_ENDED',e=>{this.ignoreNextCount>0?this.ignoreNextCount--:this._handleTriggerCount('ai')});i&&this._stops.push(i),ce(`聊天监听器初始化完成(mode=${this._config.commentTriggerMode}, interval=${this._config.triggerInterval}, prob=${this._config.triggerProbability})`)},_resolveEventName(e){try{const t=window.parent??window,o=t?.SillyTavern?.eventTypes?.[e];if(o)return String(o)}catch{}try{const t=tavern_events?.[e];if(t)return String(t)}catch{}return null},_bindEvent(e,t){const o=this._resolveEventName(e);if(!o)return de(`未找到可用事件: ${e}`),null;try{const n=window.parent??window,r=n?.SillyTavern?.eventSource;if(r&&'function'==typeof r.on)return r.on(o,t),ce(`事件监听已绑定(${e} -> ${o}, via eventSource)`),{stop:()=>{try{'function'==typeof r.off&&r.off(o,t)}catch{}}}}catch{}if('function'==typeof eventOn){const n=eventOn(o,t);return ce(`事件监听已绑定(${e} -> ${o}, via eventOn)`),n}return de(`事件系统不可用，无法监听: ${e}`),null},updateConfig(e){this._config={...e}},_shouldCountBySource(e){const t=this._config.commentTriggerMode;return'both'===t||t===e},_recordUserSignal(e){const t=Date.now();t-this._lastUserSignalAt<800?ce(`用户信号已去重(${e})`):(this._lastUserSignalAt=t,this._handleTriggerCount('user'))},_handleTriggerCount(e){this._shouldCountBySource(e)&&(this.messageCount++,ce(`消息计数(${e}): ${this.messageCount}`),this._checkAutoTrigger())},_checkAutoTrigger(){if(!this._config.autoTrigger||!this._onTrigger)return;if(this.messageCount<this._config.triggerInterval)return;const e=100*Math.random();e>this._config.triggerProbability?ce(`概率不满足(${e.toFixed(1)} > ${this._config.triggerProbability})`):(this.messageCount=0,ce('自动触发吐槽'),this._onTrigger())},manualTrigger(){this._onTrigger&&(ce('手动触发吐槽'),this._onTrigger())},resetState(){this.messageCount=0,this.ignoreNextCount=0,this._lastUserSignalAt=0,ce('聊天监听状态已重置')},markSelfGeneration(){this.ignoreNextCount++},destroy(){for(const e of this._stops)e.stop();this._stops=[],this._onTrigger=null,this.messageCount=0,this.ignoreNextCount=0,this._lastUserSignalAt=0}},Mo={毒舌吐槽:{systemPrompt:'你是一个毒舌桌面宠物，你的任务是对聊天内容进行犀利点评。\n你说话一针见血、辛辣但不恶毒，像个嘴硬但有趣的损友。\n注意：你的吐槽要幽默有梗，不要真的伤人。',responseFormat:'用1-2句话进行犀利吐槽，不超过50字。'},可爱卖萌:{systemPrompt:'你是一个超级可爱的桌面宠物，你的任务是用软萌的语气对聊天内容做出反应。\n你说话带颜文字，语气温柔可爱，像一个黏人的小动物。',responseFormat:'用1-2句话做出可爱反应，不超过50字。多用颜文字如(≧▽≦)、(｡>﹏<｡)、✧(≖ ◡ ≖✿)等。'},冷静分析:{systemPrompt:'你是一个冷静理性的桌面宠物，你的任务是对聊天内容进行客观简短的分析。\n你说话条理清晰、一针见血，像个沉稳的旁观者。',responseFormat:'用1-2句话进行简短分析，不超过50字。语气冷静客观。'},傲娇:{systemPrompt:'你是一个傲娇的桌面宠物，你的任务是对聊天内容做出口是心非的评论。\n你嘴上说着不在意，但其实很关心聊天的内容。经常用"才、才不是"、"别误会了"之类的说法。',responseFormat:'用1-2句话进行傲娇评论，不超过50字。要体现口是心非的反差。'}};function To(e,t){if('自定义'===e&&t)return{systemPrompt:t,responseFormat:'用1-2句简短的话做出评论，不超过50字。'};const o=Mo[e]??Mo['毒舌吐槽'];return{systemPrompt:o.systemPrompt,responseFormat:o.responseFormat}}function No(e){return`${e}\n\n【表情COT输出格式（必须严格遵守）】\n- 格式：桌面宠物[表情|语气]: 正文\n- 表情只能从以下列表中选择 1 个：${y.join('、')}\n- 语气可省略；如填写请用简短中文短语（例如“轻松调侃地说”）\n- 只输出一行，不要输出多余内容（不要 Markdown/多段/额外括号）`}function Po(e){const t=String(e?.roleName||'').trim();if(!t)return'';const o=['【角色视角要求】',`- 你必须以“${t}”的第一人称视角发言。`,'- 语气、态度、措辞要贴合该角色，不要跳出角色。','- 不要提及你是 AI、语言模型或桌面宠物。'],n=String(e?.characterCardContent||'').trim();return n&&(o.push('【角色卡内容（参考）】'),o.push(n)),o.join('\n')}function Lo(e){return!!String(e?.roleName||'').trim()&&!0===e?.ignoreCommentStyle}function Do(e){return e.map(e=>`${e.name}(${e.role}): ${String(e.message??'')}`).join('\n')}function $o(e){return String(e?.referenceText||'').trim()}function Uo(e){const t=$o(e);return t?`【数据库参考】\n以下内容来自数据库，请将其作为“参考信息”结合当前对话理解，不要逐字复述。\n${t}`:''}function Io(e,t){return $o(t)?`${e}\n并在回复中做到：先给一句点评，再给 1 条具体建议。`:e}const zo={isGenerating:!1,_onComment:null,_streamStop:null,_latestStreamText:'',setCallback(e){this._onComment=e},async generate(){if(this.isGenerating)return void ce('已有生成任务进行中，跳过');this.isGenerating=!0,ce('开始生成吐槽');let e=!1;try{this._onComment?.('',!1);const t=he().settings;let o=this._getChatContext(t.maxChatContext);if(t.useTamakoTodaySpecial){const e=this._getTamakoTodaySpecialContent();e?(o=[...o,{role:'system',name:'玉子市场今日特选',message:e}],ce(`已注入玉子市场“今日特选”上下文（${e.length} 字）`)):ce('已启用玉子市场兼容，但未读取到“今日特选”，回退到聊天记录')}if(0===o.length)return void ce('没有可用的聊天记录，跳过吐槽');const n=this._resolveRoleplayOptions({roleName:t.roleplayName,ignoreCommentStyle:!!t.roleplayIgnoreCommentStyle,sendCharacterCardContent:!!t.sendCharacterCardContent}),r=this._resolveDiceReferenceOptions(!!t.useDiceDatabaseReference,t.diceReferenceVisibleSheets),{system:a,user:i}=function(e,t,o,n=!1,r,a){const i=Lo(r),{systemPrompt:s,responseFormat:l}=i?{systemPrompt:'你需要严格按照角色设定进行发言。',responseFormat:'用1-2句简短的话做出评论，不超过50字。'}:To(e,t),c=Io(l,a),d=n?No(c):c,A=Po(r),u=Uo(a),p=Do(o),m=[s];return A&&m.push(A),u&&m.push(u),m.push(`回复格式要求：${d}`),{system:m.join('\n\n'),user:`以下是最近的聊天记录，请对最新内容做出评论：\n\n${p}`}}(t.commentStyle,t.customPrompt,o,!!t.emotionCotEnabled,n,r);let s;this._latestStreamText='','custom'===t.apiMode&&t.apiConfig.url?s=await this._generateCustom(a,i,t.apiConfig):(Vo.markSelfGeneration(),s=await this._generateTavern(a,i,t.apiConfig.max_tokens,t.apiConfig.temperature,!!t.apiConfig.sendWorldInfo));const l=String(s||'').trim()||String(this._latestStreamText||'').trim();l?(this._onComment?.(l,!0),e=!0):de('吐槽生成结果为空')}catch(e){Ae('吐槽生成失败:',e)}finally{e||this._onComment?.('',!0),this.isGenerating=!1}},async chat(e){const t=String(e||'').trim();if(!t)return;if(this.isGenerating)return void ce('已有生成任务进行中，跳过');this.isGenerating=!0,ce('开始手动聊天生成');let o=!1;try{this._onComment?.('',!1);const e=he().settings,n=this._getChatContext(e.maxChatContext),r=this._resolveRoleplayOptions({roleName:e.roleplayName,ignoreCommentStyle:!!e.roleplayIgnoreCommentStyle,sendCharacterCardContent:!!e.sendCharacterCardContent}),a=this._resolveDiceReferenceOptions(!!e.useDiceDatabaseReference,e.diceReferenceVisibleSheets),{system:i,user:s}=function(e,t,o,n,r=!1,a,i){const s=Lo(a),{systemPrompt:l}=s?{systemPrompt:'你需要严格按照角色设定进行发言。'}:To(e,t),c=Io(s?'用1-3句话回复用户，不超过80字。':function(e){switch(e){case'可爱卖萌':return'用1-3句话回复用户，不超过80字。多用颜文字如(≧▽≦)、(｡>﹏<｡)、✧(≖ ◡ ≖✿)等。';case'冷静分析':return'用1-3句话回复用户，不超过80字。语气冷静客观。';case'傲娇':return'用1-3句话回复用户，不超过80字。要体现口是心非的反差。';case'毒舌吐槽':return'用1-3句话回复用户，不超过80字。可以适度毒舌但不要伤人。';default:return'用1-3句话回复用户，不超过80字。'}}(e),i),d=r?No(c):c,A=Po(a),u=Uo(i),p=String(a?.roleName||'').trim(),m=Do(o),h=String(n||'').trim(),f=[l];return A&&f.push(A),u&&f.push(u),f.push(`回复格式要求：${d}`),f.push(p?'你现在需要保持该角色设定与用户聊天。':'你现在需要以桌面宠物的身份与用户聊天。'),{system:f.join('\n\n'),user:`以下是最近的聊天记录（仅供参考，不要逐字复述）：\n\n${m||'(无)'}\n\n用户对你说：\n${h}\n\n请直接回复用户：`}}(e.commentStyle,e.customPrompt,n,t,!!e.emotionCotEnabled,r,a);let l;this._latestStreamText='','custom'===e.apiMode&&e.apiConfig.url?l=await this._generateCustom(i,s,e.apiConfig):(Vo.markSelfGeneration(),l=await this._generateTavern(i,s,e.apiConfig.max_tokens,e.apiConfig.temperature,!!e.apiConfig.sendWorldInfo));const c=String(l||'').trim()||String(this._latestStreamText||'').trim();c?(this._onComment?.(c,!0),o=!0):de('手动聊天生成结果为空')}catch(e){Ae('聊天生成失败:',e)}finally{o||this._onComment?.('',!0),this.isGenerating=!1}},async _generateTavern(e,t,o,n,r){this._setupStreamListener();const a=r?['world_info_before',{role:'system',content:e},'world_info_after',{role:'user',content:t}]:[{role:'system',content:e},{role:'user',content:t}];try{return await generateRaw({should_silence:!0,should_stream:!0,ordered_prompts:a,custom_api:void 0})}finally{this._cleanupStreamListener()}},async _generateCustom(e,t,o){const n=String(o.url||'').trim(),r=String(o.apiKey||'').trim(),a=String(o.model||'').trim().replace(/^models\//,'');if(!n)throw new Error('自定义 API URL 不能为空。');if(!a)throw new Error('自定义 API 模型不能为空，请先在设置中填写或选择模型。');const i=!!o.usePresetSampling,s=!!o.sendWorldInfo,l=[{role:'system',content:e},{role:'user',content:t}],c=e=>{const t={messages:l,model:a,stream:!1,chat_completion_source:'custom',custom_prompt_post_processing:s?'strict':'none',reverse_proxy:n,custom_url:n,custom_include_headers:r?`Authorization: Bearer ${r}`:''};return i||'minimal'===e||(t.max_tokens=o.max_tokens,t.temperature=o.temperature,t.top_p=o.top_p),i||'full'!==e||(t.frequency_penalty=o.frequency_penalty,t.presence_penalty=o.presence_penalty,t.top_k=o.top_k),t},d=async e=>{const t=await fetch('/api/backends/chat-completions/generate',{method:'POST',headers:{...SillyTavern.getRequestHeaders(),'Content-Type':'application/json'},body:JSON.stringify(c(e))});if(!t.ok){const e=await t.text(),o=new Error(`API请求失败: ${t.status} ${e||t.statusText}`);throw o.status=t.status,o}const o=await t.json();if(o?.choices?.[0]?.message?.content)return String(o.choices[0].message.content).trim();if('string'==typeof o?.content)return o.content.trim();if('string'==typeof o?.text)return o.text.trim();const n='object'==typeof o?JSON.stringify(o):String(o);throw new Error(`API调用返回无效响应: ${n}`)},A=['full','safe','minimal'];let u=null;for(let e=0;e<A.length;e++){const t=A[e];try{return e>0&&de(`自定义 API 参数回退重试：${t}`),await d(t)}catch(o){u=o;const n=o?.status,r=o instanceof Error?o.message:String(o);if(!((422===n||/\b422\b/.test(r))&&e<A.length-1))throw o;de(`自定义 API 返回 422，准备继续回退参数：${t} -> ${A[e+1]}`)}}throw u instanceof Error?u:new Error(String(u))},_setupStreamListener(){this._cleanupStreamListener(),this._streamStop=eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY,e=>{this._latestStreamText=String(e||''),this._onComment?.(e,!1)})},_cleanupStreamListener(){this._streamStop&&(this._streamStop.stop(),this._streamStop=null)},_getChatContext(e){try{const t=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'unhidden'}),o=Array.isArray(t)?t:[],n=Number.isFinite(e)&&e>0?Math.floor(e):20;return o.slice(-n).map(e=>({role:e.role,name:e.name,message:e.message}))}catch(e){return de('获取聊天记录失败:',e),[]}},_resolveRoleplayOptions(e){const t=String(e.roleName||'').trim();if(!t)return;const o={roleName:t,ignoreCommentStyle:!0===e.ignoreCommentStyle};if(e.sendCharacterCardContent){const e=this._getCurrentCharacterCardContent();e?o.characterCardContent=e:ce('角色卡内容开关已开启，但未读取到可用角色卡文本')}return o},_resolveDiceReferenceOptions(e,t){if(!e)return;const o=this._normalizeDiceVisibleSheetNames(t),n=this._getDiceDatabaseReferenceContent(o);if(n)return ce(`已注入数据库参考（${n.length} 字）`),{referenceText:n};ce('数据库参考已启用，但未读取到可用数据')},_getDiceDatabaseReferenceContent(e){const t=this._getDiceDatabaseDataFromApi();if(t){const o=this._summarizeDiceDatabasePayload(t,'AutoCardUpdaterAPI.exportTableAsJson',e);if(o)return o}const o=this._getDiceDatabaseDataFromChatContext();return o?this._summarizeDiceDatabasePayload(o,'聊天楼层 TavernDB_ACU_* 字段',e):''},_getDiceDatabaseDataFromApi(){try{const e=window.parent??window,t=e?.AutoCardUpdaterAPI;return t&&'function'==typeof t.exportTableAsJson?this._normalizeDiceDatabasePayload(t.exportTableAsJson()):null}catch(e){return de('读取数据库 API 失败:',e),null}},_getDiceDatabaseDataFromChatContext(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'all'}),t=Array.isArray(e)?e:[];for(let e=t.length-1;e>=0;e--){const o=this._pickDiceDatabasePayloadFromMessage(t[e]);if(o)return o}}catch(e){de('从聊天记录回退读取数据库失败:',e)}return null},_pickDiceDatabasePayloadFromMessage(e){if(!e||'object'!=typeof e)return null;const t=[e.TavernDB_ACU_IndependentData,e.TavernDB_ACU_Data,e.TavernDB_ACU_SummaryData,e.data?.TavernDB_ACU_IndependentData,e.data?.TavernDB_ACU_Data,e.data?.TavernDB_ACU_SummaryData];for(const e of t){const t=this._normalizeDiceDatabasePayload(e);if(t)return t}const o=[e.TavernDB_ACU_IsolatedData,e.data?.TavernDB_ACU_IsolatedData];for(const e of o){const t=this._pickDiceDatabasePayloadFromIsolatedData(e);if(t)return t}return null},_pickDiceDatabasePayloadFromIsolatedData(e){const t=this._parseMaybeJsonRecord(e);if(!t)return null;const o=Object.keys(t);for(let e=o.length-1;e>=0;e--){const n=this._parseMaybeJsonRecord(t[o[e]]);if(!n)continue;const r=this._normalizeDiceDatabasePayload(n.independentData);if(r)return r}return null},_normalizeDiceDatabasePayload(e){const t=this._parseMaybeJsonRecord(e);if(!t)return null;if(this._isDiceDatabasePayload(t))return t;const o=this._parseMaybeJsonRecord(t.independentData);return o&&this._isDiceDatabasePayload(o)?o:null},_parseMaybeJsonRecord(e){if('string'==typeof e){const t=e.trim();if(!t)return null;try{return this._parseMaybeJsonRecord(JSON.parse(t))}catch{return null}}return!e||'object'!=typeof e||Array.isArray(e)?null:e},_isDiceDatabasePayload:e=>Object.keys(e).some(e=>e.startsWith('sheet_')),_summarizeDiceDatabasePayload(e,t,o){const n=new Set(o.map(e=>this._normalizeReferenceText(e)).filter(e=>!!e)),r=Object.keys(e).filter(e=>e.startsWith('sheet_')).map(t=>this._parseMaybeJsonRecord(e[t])).filter(e=>!!e).map(e=>{const t=this._normalizeReferenceText(e.name||'');return{name:t,priority:this._getDiceSheetPriority(t),text:this._buildDiceSheetSummary(e)}}).filter(e=>!!e.text).filter(e=>0===n.size||n.has(e.name)).sort((e,t)=>e.priority-t.priority||e.name.localeCompare(t.name,'zh-CN')).slice(0,8);if(0===r.length)return'';const a=[`来源：${t}`,'以下为数据库摘要（仅供参考）：'];for(const e of r){const t=`- ${e.text}`;if(`${a.join('\n')}\n${t}`.length>1800)break;a.push(t)}return a.join('\n')},_normalizeDiceVisibleSheetNames(e){if(!Array.isArray(e))return[];const t=[],o=new Set;for(const n of e){const e=this._normalizeReferenceText(n);e&&(o.has(e)||(o.add(e),t.push(e)))}return t},_getDiceSheetPriority:e=>({总结表:0,总体大纲:1,任务与事件表:2,重要人物表:3,全局数据表:4,选项表:5}[e]??99),_buildDiceSheetSummary(e){const t=this._normalizeReferenceText(e.name||'')||'未命名表',o=(Array.isArray(e.content)?e.content:[]).filter(e=>Array.isArray(e));if(0===o.length)return'';const n=(Array.isArray(o[0])?o[0]:[]).map((e,t)=>this._normalizeReferenceText(e)||`字段${t}`),r=o.slice(1).filter(e=>e.some((e,t)=>t>0&&!!this._normalizeReferenceText(e)));if(0===r.length)return`${t}: 暂无有效记录`;const a=r.slice(-2).map(e=>this._formatDiceSheetRow(n,e)).filter(e=>!!e);return 0===a.length?`${t}: 有记录`:`${t}: ${a.join(' | ')}`},_formatDiceSheetRow(e,t){const o=[];for(let n=1;n<t.length;n++){const r=this._normalizeReferenceText(t[n]);if(!r)continue;const a=e[n]||`字段${n}`;if(o.push(`${a}: ${this._truncateReferenceText(r,56)}`),o.length>=3)break}if(o.length>0)return o.join('；');const n=t.map(e=>this._normalizeReferenceText(e)).find(e=>!!e)||'';return this._truncateReferenceText(n,90)},_normalizeReferenceText:e=>String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/\s{2,}/g,' ').trim(),_truncateReferenceText:(e,t)=>e.length<=t?e:`${e.slice(0,Math.max(0,t-1))}…`,_getCurrentCharacterCardContent(){try{const e=SillyTavern?.getContext?.();if(!e)return'';const t=Array.isArray(e.characters)?e.characters:[];if(0===t.length)return'';const o=e.characterId;let n=null;if(null!=o){const e=String(o).trim(),r=Number(e);Number.isFinite(r)&&r>=0&&r<t.length&&(n=t[r])}if(!n){const o=String(e.name2||'').trim();o&&(n=t.find(e=>String(e?.name||'').trim()===o)||null)}if(n||1!==t.length||(n=t[0]),!n)return'';const r=[['角色名',n.name],['角色描述',n.description??n.data?.description],['角色性格',n.personality??n.data?.personality],['场景设定',n.scenario??n.data?.scenario],['开场白',n.first_mes??n.data?.first_mes],['示例对话',n.mes_example??n.data?.mes_example],['系统提示',n.data?.system_prompt],['历史后提示',n.data?.post_history_instructions]];return r.map(([e,t])=>{const o=this._normalizeCharacterCardField(t);return o?`${e}: ${o}`:''}).filter(e=>!!e).join('\n')}catch(e){return de('读取角色卡内容失败:',e),''}},_normalizeCharacterCardField:e=>String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim(),_getTamakoTodaySpecialContent(){try{const e=(window.parent??window).document??document,t='#tamako-market-window .tamako-content[data-content="current"]';if(e.querySelector(`${t} .tamako-empty .message`))return'';const o=e.querySelector(`${t} .tamako-plot-content`),n=this._sanitizeTamakoText(o?.innerText||o?.textContent||'');if(n)return n;const r=e.querySelector(`${t} iframe.tamako-beautifier-frame`),a=this._readTamakoPayloadFromIframe(r),i=this._extractTamakoTextFromPayload(a);if(i)return i;const s=e.querySelector(t);return this._sanitizeTamakoText(s?.innerText||s?.textContent||'')}catch(e){return de('读取玉子市场“今日特选”失败:',e),''}},_readTamakoPayloadFromIframe(e){if(!e)return null;const t=String(e.name||'').trim();if(!t.startsWith('TAMAKO_DATA:'))return null;try{return JSON.parse(t.slice(12))}catch(e){return de('解析玉子市场美化器 payload 失败:',e),null}},_extractTamakoTextFromPayload(e){if(!e||'object'!=typeof e)return'';const t=this._getTamakoCaptureTags(),o=e.tags&&'object'==typeof e.tags?e.tags:{},n=[];for(const e of t){const t=this._sanitizeTamakoText(o[e]);t&&n.push(t)}if(n.length>0)return n.join('\n\n');const r=String(e.raw||'');return r?this._extractTamakoTagText(r,t):''},_getTamakoCaptureTags(){try{const e=SillyTavern?.getContext?.(),t=e?.extensionSettings?.TamakoMarket?.captureTags;if(Array.isArray(t)){const e=t.map(e=>String(e||'').trim()).filter(e=>!!e);if(e.length>0)return e}}catch{}return['recall','scene_direction']},_extractTamakoTagText(e,t){const o=[];for(const n of t){const t=String(n||'').trim();if(!t)continue;const r=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),a=new RegExp(`<${r}(?:\\s[^>]*)?>([\\s\\S]*?)<\\/${r}>`,'gi');let i;for(;null!==(i=a.exec(e));){const e=this._sanitizeTamakoText(i[1]||'');e&&o.push(e)}}return o.join('\n\n')},_sanitizeTamakoText(e){const t=String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();return t?/^(空空如也~|等待中\.\.\.|暂无内容|正在搜寻\.\.\.|扫描中\.\.\.|请稍等\.\.\.)$/.test(t)?'':t:''},destroy(){this._cleanupStreamListener(),this._onComment=null,this._latestStreamText='',this.isGenerating=!1}},Ro=/<(think|thinking)>[\s\S]*?<\/\1>/gi,Wo=/<(think|thinking)>[\s\S]*$/gi;function Fo(e){const t=String(e||'').trim();if(!t)return{rawTag:'',context:null};const o=t.split('|'),n=(o[0]||'').trim(),r=(o[1]||'').trim();return{rawTag:(n.split(',')[0]||'').trim(),context:r||null}}function Oo(e,t){const o=function(e){return String(e||'').replace(Ro,'').replace(Wo,'')}(e);if(!t.enabled)return{cleanText:o,rawTag:null,normalizedTag:null,context:null};if(function(e){const t=String(e||'').trimStart();if(!t)return!1;if(t.startsWith('[')){const e=t.indexOf(']');return-1===e||!t.slice(e+1).trim()}const o=t.indexOf('[');if(o>0&&o<30){const e=t.indexOf(']',o+1);if(-1===e)return!0;const n=t.slice(e+1);return!/^\s*[:：]/.test(n)||!n.replace(/^\s*[:：]\s*/,'').trim()}return!1}(o))return{cleanText:'',rawTag:null,normalizedTag:null,context:null};const n=o.match(/^\s*([^\[\]\n\r]{1,40})\s*\[([^\]]+)\]\s*[:：]\s*([\s\S]*)$/);if(n){const e=n[2]||'',r=n[3]||'',{rawTag:a,context:i}=Fo(e),s=se(a,t.configs);return{cleanText:s&&t.stripFromText?r.trimStart():o,rawTag:a||null,normalizedTag:s,context:i}}const r=o.match(/^\s*\[([^\]]+)\]\s*([\s\S]*)$/);if(r){const e=r[1]||'',n=r[2]||'',{rawTag:a,context:i}=Fo(e),s=se(a,t.configs);return{cleanText:s&&t.stripFromText?n.trimStart():o,rawTag:a||null,normalizedTag:s,context:i}}return{cleanText:o,rawTag:null,normalizedTag:null,context:null}}const jo=t('desktop-pet-ui',()=>{const e=(0,s.ref)(!1);return{showSettings:e,openSettings:function(){e.value=!0},closeSettings:function(){e.value=!1}}}),Go={class:'bubble-content'},qo={class:'bubble-text'},Yo={key:1,class:'cursor'},Jo=(0,s.defineComponent)({__name:'ChatBubble',props:{text:{},isDone:{type:Boolean},autoCloseDelaySeconds:{}},emits:['hidden'],setup(e,{emit:t}){const o=e,n=t,r=(0,s.ref)(!1),a=(0,s.ref)(''),i=(0,s.ref)({}),l=['。。。','。。','。','。。'];let c=null,d=null,A=null,u=0;function p(e){const t='number'==typeof e?e:Number(e);return Number.isFinite(t)?t:null}function m(){try{const e=function(){try{return window.parent??window}catch{return window}}(),t=e.document.getElementById('desktop-pet-stage'),o=t?.getBoundingClientRect?.(),n=e.innerWidth||e.document.documentElement.clientWidth||0,r=e.innerHeight||e.document.documentElement.clientHeight||0;if(o&&o.width>0&&o.height>0){const e=function(e){const t=go.model;if(!t||'function'!=typeof t.getBounds)return null;try{const o=t.getBounds?.(),n=p(o?.x),r=p(o?.y),a=p(o?.width),i=p(o?.height);return null===n||null===r||null===a||null===i||a<=0||i<=0?null:{x:e.left+n+a/2,y:e.top+r+.2*i}}catch{return null}}(o),t=o.left+o.width/2,a=o.top+.22*o.height,s=e?.x??t,l=(e?.y??a)-12,c=Math.max(8,Math.min(s,Math.max(8,n-8))),d=Math.max(8,Math.min(l,Math.max(8,r-8)));return void(i.value={left:`${Math.round(c)}px`,top:`${Math.round(d)}px`})}i.value={left:`${Math.round(.5*n)}px`,top:`${Math.round(Math.max(8,.2*r))}px`}}catch{i.value={left:'50vw',top:'20vh'}}}function h(){f(),m(),c=setInterval(m,100)}function f(){c&&(clearInterval(c),c=null)}function g(){d&&(clearInterval(d),d=null)}function b(){A&&(clearTimeout(A),A=null)}function y(){if(b(),!o.isDone)return;if(!String(o.text||'').trim())return;const e=function(){const e='number'==typeof o.autoCloseDelaySeconds?o.autoCloseDelaySeconds:Number(o.autoCloseDelaySeconds??Number.NaN);if(!Number.isFinite(e))return-1;const t=Math.round(e);return t<0?t:1e3*t}();e<0||(A=setTimeout(()=>{A=null,x()},e))}function x(){r.value=!1,a.value='',g(),f(),b(),n('hidden')}return(0,s.watch)([()=>o.text,()=>o.isDone,()=>o.autoCloseDelaySeconds],function(){const e=String(o.text||'');return e?(r.value=!0,a.value=e,g(),h(),void y()):o.isDone?(r.value=!1,a.value='',g(),f(),void b()):(r.value=!0,d||(u=0,a.value=l[u],d=setInterval(()=>{u=(u+1)%l.length,a.value=l[u]},340)),h(),void b())},{immediate:!0}),(0,s.onUnmounted)(()=>{g(),f(),b()}),(t,o)=>r.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'chat-bubble',style:(0,s.normalizeStyle)(i.value)},[(0,s.createElementVNode)('div',Go,[e.isDone?((0,s.openBlock)(),(0,s.createElementBlock)('button',{key:0,type:'button',class:'bubble-close','aria-label':'关闭聊天气泡',onClick:x},' × ')):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('span',qo,(0,s.toDisplayString)(a.value),1),e.isDone?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('span',Yo,'|'))]),o[0]||(o[0]=(0,s.createElementVNode)('div',{class:'bubble-arrow'},null,-1))],4)):(0,s.createCommentVNode)('v-if',!0)}});i(908);var Ho=i(235);const Xo=(0,Ho.A)(Jo,[['__scopeId','data-v-98097aea']]),Ko={class:'menu-panel'},Qo={class:'command-sub'},Zo={class:'command-sub'},en={key:0,class:'chat-drawer'},tn={class:'drawer-head'},on={class:'drawer-actions'},nn=['disabled'],rn=(0,s.defineComponent)({__name:'FunctionMenu',props:{visible:{type:Boolean},x:{},y:{},placement:{},motionLoopEnabled:{type:Boolean},commentStyle:{}},emits:['close','send-chat','toggle-motion-loop','switch-model','switch-persona','close-model'],setup(e,{emit:t}){const o=e,n=t,r=(0,s.ref)(null),a=(0,s.ref)(null),i=(0,s.ref)(''),l=(0,s.ref)(!1),c=(0,s.ref)(0),d=(0,s.ref)(0);function A(){try{return window.parent??window}catch{return window}}const u=(0,s.computed)(()=>'left'===o.placement?'translate(-100%, -50%)':'translate(0, -50%)'),p=(0,s.computed)(()=>({left:`${c.value}px`,top:`${d.value}px`,transform:u.value}));function m(){const e=r.value;if(!e)return;const t=A(),o=t.innerWidth||t.document.documentElement.clientWidth||0,n=t.innerHeight||t.document.documentElement.clientHeight||0,a=e.getBoundingClientRect();o>0&&(a.left<8?c.value+=8-a.left:a.right>o-8&&(c.value-=a.right-(o-8))),n>0&&(a.top<8?d.value+=8-a.top:a.bottom>n-8&&(d.value-=a.bottom-(n-8)))}function h(){l.value=!1,n('close')}function f(){const e=i.value.trim();e&&(n('send-chat',e),i.value='')}function g(){l.value=!0,(0,s.nextTick)(()=>{m(),a.value?.focus(),a.value?.select()})}function b(e){if('Escape'===e.key)return e.preventDefault(),void h();'Enter'!==e.key||e.shiftKey||(e.preventDefault(),f())}const y=e=>{o.visible&&'Escape'===e.key&&(e.preventDefault(),h())};(0,s.watch)(()=>o.visible,async e=>{e?(c.value=Number.isFinite(o.x)?o.x:0,d.value=Number.isFinite(o.y)?o.y:0,l.value=!1,await(0,s.nextTick)(),m()):l.value=!1},{immediate:!0}),(0,s.watch)(()=>[o.x,o.y,o.placement,l.value],async()=>{o.visible&&(c.value=Number.isFinite(o.x)?o.x:0,d.value=Number.isFinite(o.y)?o.y:0,await(0,s.nextTick)(),m())});try{A().addEventListener('keydown',y)}catch{}return(0,s.onUnmounted)(()=>{try{A().removeEventListener('keydown',y)}catch{}}),(t,o)=>e.visible?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'menu-overlay',onClick:(0,s.withModifiers)(h,['self'])},[(0,s.createElementVNode)('div',{ref_key:'menuEl',ref:r,class:(0,s.normalizeClass)(['menu-cluster',[`is-${e.placement}`,{'chat-open':l.value}]]),style:(0,s.normalizeStyle)(p.value),onClick:o[6]||(o[6]=(0,s.withModifiers)(()=>{},['stop']))},[(0,s.createElementVNode)('div',Ko,[(0,s.createElementVNode)('div',{class:'panel-top'},[o[7]||(o[7]=(0,s.createElementVNode)('span',{class:'panel-title'},'TACTICAL',-1)),(0,s.createElementVNode)('button',{class:'icon-btn',type:'button',onClick:h},'×')]),(0,s.createElementVNode)('button',{class:(0,s.normalizeClass)(['command-btn',{active:l.value}]),type:'button',onClick:g},[...o[8]||(o[8]=[(0,s.createElementVNode)('span',{class:'command-index'},'01',-1),(0,s.createElementVNode)('span',{class:'command-main'},'CHAT',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'MESSAGE LINK',-1)])],2),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[0]||(o[0]=e=>t.$emit('toggle-motion-loop'))},[o[9]||(o[9]=(0,s.createElementVNode)('span',{class:'command-index'},'02',-1)),o[10]||(o[10]=(0,s.createElementVNode)('span',{class:'command-main'},'MOTION',-1)),(0,s.createElementVNode)('span',Qo,(0,s.toDisplayString)(e.motionLoopEnabled?'ON':'OFF'),1)]),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[1]||(o[1]=e=>t.$emit('switch-model'))},[...o[11]||(o[11]=[(0,s.createElementVNode)('span',{class:'command-index'},'03',-1),(0,s.createElementVNode)('span',{class:'command-main'},'MODEL',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'SWITCH',-1)])]),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[2]||(o[2]=e=>t.$emit('switch-persona'))},[o[12]||(o[12]=(0,s.createElementVNode)('span',{class:'command-index'},'04',-1)),o[13]||(o[13]=(0,s.createElementVNode)('span',{class:'command-main'},'PERSONA',-1)),(0,s.createElementVNode)('span',Zo,(0,s.toDisplayString)(e.commentStyle),1)]),(0,s.createElementVNode)('button',{class:'command-btn danger',type:'button',onClick:o[3]||(o[3]=e=>t.$emit('close-model'))},[...o[14]||(o[14]=[(0,s.createElementVNode)('span',{class:'command-index'},'05',-1),(0,s.createElementVNode)('span',{class:'command-main'},'CLOSE',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'MODEL OFF',-1)])])]),(0,s.createVNode)(s.Transition,{name:'drawer'},{default:(0,s.withCtx)(()=>[l.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',en,[(0,s.createElementVNode)('div',tn,[o[15]||(o[15]=(0,s.createElementVNode)('span',{class:'drawer-title'},'MESSAGE LINK',-1)),(0,s.createElementVNode)('button',{class:'drawer-close',type:'button',onClick:o[4]||(o[4]=e=>l.value=!1)},'×')]),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{ref_key:'inputEl',ref:a,'onUpdate:modelValue':o[5]||(o[5]=e=>i.value=e),class:'chat-input',rows:'4',placeholder:'输入内容... (Enter 发送 / Shift+Enter 换行)',onKeydown:b},null,544),[[s.vModelText,i.value]]),(0,s.createElementVNode)('div',on,[(0,s.createElementVNode)('button',{class:'send-btn',type:'button',disabled:!i.value.trim(),onClick:f},' SEND ',8,nn)]),o[16]||(o[16]=(0,s.createElementVNode)('div',{class:'drawer-hint'},'系统会读取最近聊天上下文。',-1))])):(0,s.createCommentVNode)('v-if',!0)]),_:1})],6)])):(0,s.createCommentVNode)('v-if',!0)}});i(0);const an=(0,Ho.A)(rn,[['__scopeId','data-v-ff4f8948']]),sn=new Map;function ln(e){const t=e.toLowerCase();return'model.json'===t||'model3.json'===t||t.endsWith('.model.json')||t.endsWith('.model3.json')}const cn=['.zip','.rar','.7z','.md','.txt','.png','.jpg','.jpeg','.gif','.bmp','.psd','.webp','.mp3','.wav','.ogg','.mp4','.mtn'];function dn(e){if('dir'===e.type)return!0;if(ln(e.name))return!0;const t=e.name.toLowerCase();for(const e of cn)if(t.endsWith(e))return!1;return ln(e.name)}async function An(e){const t=sn.get(e);if(t)return t;const o=`https://api.github.com/repos/Eikanya/Live2d-model/contents/${e}`;let n;try{const e=await fetch(o,{headers:{Accept:'application/vnd.github.v3+json'}});if(403===e.status){const t=e.headers.get('X-RateLimit-Remaining'),o=e.headers.get('X-RateLimit-Reset'),n=o?new Date(1e3*parseInt(o)):null;throw new un(t,n)}if(!e.ok)throw new Error(`HTTP ${e.status}`);n=await e.json()}catch(e){if(e instanceof un)throw e;const t=go._getProxiedUrl(o),r=await fetch(t,{headers:{Accept:'application/vnd.github.v3+json'}});if(403===r.status)throw new un(null,null);if(!r.ok)throw new Error(`获取目录失败: HTTP ${r.status}`);n=await r.json()}if(!Array.isArray(n))throw new Error('GitHub API 返回非数组数据');const r=n.map(e=>({name:e.name,path:e.path,type:'dir'===e.type?'dir':'file',isModel:'file'===e.type&&ln(e.name)})).filter(dn).sort((e,t)=>e.type!==t.type?'dir'===e.type?-1:1:e.name.localeCompare(t.name));return sn.set(e,r),r}class un extends Error{remaining;resetDate;constructor(e,t){super(`GitHub API 已达到请求限制，请在 ${t?t.toLocaleTimeString():'未知'} 后重试`),this.name='RateLimitError',this.remaining=e,this.resetDate=t}}const pn={class:'tree-node'},mn={key:1,class:'expand-icon placeholder'},hn={class:'node-icon'},fn=['title'],gn={key:2,class:'node-spinner'},bn=(0,s.defineComponent)({__name:'TreeNode',props:{entry:{},depth:{},searchQuery:{}},emits:['select-model'],setup(e,{emit:t}){const o=e,n=t,r=(0,s.ref)(!1),a=(0,s.ref)([]),i=(0,s.ref)(!1),l=(0,s.ref)(!1),c=(0,s.ref)(''),d=(0,s.ref)(!1),A=(0,s.computed)(()=>{if(!o.searchQuery.trim())return a.value;const e=o.searchQuery.toLowerCase();return a.value.filter(t=>t.name.toLowerCase().includes(e)||'dir'===t.type)});async function u(){i.value=!0,c.value='';try{a.value=await An(o.entry.path),l.value=!0}catch(e){c.value=e instanceof un?e.message:`加载失败: ${e.message||'网络错误'}`}finally{i.value=!1}}function p(){'dir'===o.entry.type?(r.value=!r.value,r.value&&!l.value&&u()):o.entry.isModel&&(d.value=!0,n('select-model',o.entry.path))}return(t,o)=>{const n=(0,s.resolveComponent)('TreeNode',!0);return(0,s.openBlock)(),(0,s.createElementBlock)('div',pn,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['node-row',{'is-model':e.entry.isModel,'is-selected':d.value}]),style:(0,s.normalizeStyle)({paddingLeft:16*e.depth+'px'}),onClick:p},[(0,s.createCommentVNode)(' 展开/折叠箭头（仅目录） '),'dir'===e.entry.type?((0,s.openBlock)(),(0,s.createElementBlock)('span',{key:0,class:(0,s.normalizeClass)(['expand-icon',{expanded:r.value}])},' ▶ ',2)):((0,s.openBlock)(),(0,s.createElementBlock)('span',mn)),(0,s.createCommentVNode)(' 图标 '),(0,s.createElementVNode)('span',hn,['dir'===e.entry.type?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:0},[(0,s.createTextVNode)('📁')],64)):e.entry.isModel?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createTextVNode)('⭐')],64)):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:2},[(0,s.createTextVNode)('📄')],64))]),(0,s.createCommentVNode)(' 名称 '),(0,s.createElementVNode)('span',{class:'node-name',title:e.entry.path},(0,s.toDisplayString)(e.entry.name),9,fn),(0,s.createCommentVNode)(' 加载指示器 '),i.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',gn)):(0,s.createCommentVNode)('v-if',!0)],6),(0,s.createCommentVNode)(' 子节点 '),r.value&&a.value.length>0?((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,{key:0},(0,s.renderList)(A.value,r=>((0,s.openBlock)(),(0,s.createBlock)(n,{key:r.path,entry:r,depth:e.depth+1,'search-query':e.searchQuery,onSelectModel:o[0]||(o[0]=e=>t.$emit('select-model',e))},null,8,['entry','depth','search-query']))),128)):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 子目录为空 '),r.value&&!i.value&&0===a.value.length&&l.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:1,class:'empty-hint',style:(0,s.normalizeStyle)({paddingLeft:16*(e.depth+1)+8+'px'})},' 暂无模型文件 ',4)):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 子目录加载错误 '),r.value&&c.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:2,class:'child-error',style:(0,s.normalizeStyle)({paddingLeft:16*(e.depth+1)+8+'px'})},[(0,s.createTextVNode)((0,s.toDisplayString)(c.value)+' ',1),(0,s.createElementVNode)('button',{class:'retry-link',onClick:(0,s.withModifiers)(u,['stop'])},'重试')],4)):(0,s.createCommentVNode)('v-if',!0)])}}});i(678);const yn=(0,Ho.A)(bn,[['__scopeId','data-v-3a6a95ba']]),xn={class:'model-browser'},vn={class:'search-box'},Cn={key:0,class:'error-bar'},wn={class:'tree-container'},Bn={key:0,class:'loading-state'},Sn={key:0,class:'empty-state'},_n={class:'browser-footer'},kn={key:0,class:'selected-info'},En={class:'selected-path'},Vn={key:1,class:'selected-info'},Mn={class:'footer-actions'},Tn=['disabled'],Nn=(0,s.defineComponent)({__name:'ModelBrowser',props:{useCdn:{type:Boolean}},emits:['cancel','load-model'],setup(e,{emit:t}){const o=e,n=t,r=(0,s.ref)([]),a=(0,s.ref)(!1),i=(0,s.ref)(''),l=(0,s.ref)(''),c=(0,s.ref)(''),d=(0,s.computed)(()=>{if(!c.value)return'';const e=c.value.split('/');return e[e.length-1]}),A=(0,s.computed)(()=>{if(!l.value.trim())return r.value;const e=l.value.toLowerCase();return r.value.filter(t=>t.name.toLowerCase().includes(e))});function u(e){c.value=e}function p(){if(!c.value)return;const e=function(e,t=!0){const o=e.split('/').map(e=>encodeURIComponent(e)).join('/');return`${t?v:C}${o}`}(c.value,o.useCdn);n('load-model',e)}async function m(){a.value=!0,i.value='';try{r.value=await An('')}catch(e){i.value=e instanceof un?e.message:`加载失败: ${e.message||'网络错误'}`}finally{a.value=!1}}return m(),(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',xn,[t[5]||(t[5]=(0,s.createElementVNode)('div',{class:'browser-header'},[(0,s.createElementVNode)('span',{class:'browser-title'},'在线模型库'),(0,s.createElementVNode)('span',{class:'browser-hint'},'Eikanya/Live2d-model')],-1)),(0,s.createCommentVNode)(' 搜索框 '),(0,s.createElementVNode)('div',vn,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t[0]||(t[0]=e=>l.value=e),placeholder:'搜索已加载的目录...'},null,512),[[s.vModelText,l.value]])]),(0,s.createCommentVNode)(' 错误提示 '),i.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Cn,[(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(i.value),1),(0,s.createElementVNode)('button',{class:'retry-btn',onClick:m},'重试')])):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 树形列表 '),(0,s.createElementVNode)('div',wn,[a.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Bn,[...t[2]||(t[2]=[(0,s.createElementVNode)('span',{class:'spinner'},null,-1),(0,s.createTextVNode)(' 加载中... ',-1)])])):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(A.value,e=>((0,s.openBlock)(),(0,s.createBlock)(yn,{key:e.path,entry:e,depth:0,'search-query':l.value,onSelectModel:u},null,8,['entry','search-query']))),128)),0!==r.value.length||a.value?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('div',Sn,' 该目录下暂无内容 '))],64))]),(0,s.createCommentVNode)(' 已选模型 & 操作 '),(0,s.createElementVNode)('div',_n,[c.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',kn,[t[3]||(t[3]=(0,s.createTextVNode)(' 已选: ',-1)),(0,s.createElementVNode)('span',En,(0,s.toDisplayString)(d.value),1)])):((0,s.openBlock)(),(0,s.createElementBlock)('div',Vn,[...t[4]||(t[4]=[(0,s.createElementVNode)('span',{class:'no-selection'},'请选择一个模型文件',-1)])])),(0,s.createElementVNode)('div',Mn,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',onClick:t[1]||(t[1]=t=>e.$emit('cancel'))},'取消'),(0,s.createElementVNode)('button',{class:'btn btn-primary',disabled:!c.value,onClick:p},' 确认加载 ',8,Tn)])])]))}});i(355);const Pn=(0,Ho.A)(Nn,[['__scopeId','data-v-7ee23a0a']]),Ln=Pn,Dn={JSZip:null,async _loadJSZip(){if(this.JSZip)return this.JSZip;const e=window.parent??window;return e.JSZip?(this.JSZip=e.JSZip,this.JSZip):new Promise((t,o)=>{const n=e.document.createElement('script');n.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js',n.async=!0,n.onload=()=>{if(this.JSZip=e.JSZip,this.JSZip){try{console.log(`[${l}] JSZip 加载完成`)}catch{}t(this.JSZip)}else o(new Error('JSZip 加载后未找到全局对象'))},n.onerror=()=>o(new Error('JSZip 加载失败')),e.document.head.appendChild(n)})},async uploadZip(e){const t=await this._loadJSZip(),o=await t.loadAsync(e);try{console.log(`[${l}] Live2DUploader: 开始解析 ${e.name} (${(e.size/1024/1024).toFixed(2)} MB)`)}catch{}const n=await this._findModelJson(o);if(!n)throw new Error('未找到 Live2D 模型配置（model3.json / model.json / *.model.json / model*.json）');const r=n.path.substring(0,n.path.lastIndexOf('/')+1),a=String(await n.file.async('text')).replace(/^\uFEFF/,''),i=JSON.parse(a),s=String(n.path||'').toLowerCase().endsWith('model3.json')||!!i?.FileReferences,c=!s&&('string'==typeof i?.model||'string'==typeof i?.Model||Array.isArray(i?.textures)||Array.isArray(i?.expressions)||'object'==typeof i?.motions);try{console.log(`[${l}] Live2DUploader: 模型配置解析完成，目录: ${r||'根目录'}，类型: ${s?'Cubism 3/4/5':'Cubism 2.1'}`)}catch{}let d;if(s){const t=await this._extractFile(o,r,i.FileReferences?.Moc),n=this._readMoc3HeaderVersion(t),a=await this._resolveModel3CubismVersion(i,t),s=$t(a);d={modelId:p,source:'local',fileName:String(e.name||'').trim()||'uploaded-live2d.zip',runtimeType:s,cubismVersion:a,moc3Version:n??null,modelJson:i,moc3:t,moc:null,textures:await this._extractTextures(o,r,i),motions:await this._extractMotions(o,r,i),expressions:await this._extractExpressions(o,r,i),physics:i.FileReferences?.Physics?await this._extractFileOptional(o,r,i.FileReferences.Physics):null,pose:i.FileReferences?.Pose?await this._extractFileOptional(o,r,i.FileReferences.Pose):null,uploadTime:Date.now(),fileSize:e.size}}else{if(!c)throw new Error('未识别的 Live2D 模型格式：请确保 zip 中包含标准的 model3.json / model.json');{const t=i?.model||i?.Model,n=i?.physics||i?.Physics,a=i?.pose||i?.Pose;d={modelId:p,source:'local',fileName:String(e.name||'').trim()||'uploaded-live2d.zip',runtimeType:Tt.LEGACY,cubismVersion:2,modelJson:i,moc3Version:null,moc3:null,moc:await this._extractFile(o,r,t),textures:await this._extractTexturesV2(o,r,i),motions:await this._extractMotionsV2(o,r,i),expressions:await this._extractExpressionsV2(o,r,i),physics:n?await this._extractFileOptional(o,r,n):null,pose:a?await this._extractFileOptional(o,r,a):null,uploadTime:Date.now(),fileSize:e.size}}}await Wt(d);try{console.log(`[${l}] Live2DUploader: 本地模型保存成功`,{modelId:d.modelId,runtimeType:d.runtimeType,cubismVersion:d.cubismVersion})}catch{}return d},_toArrayBuffer:e=>e?e instanceof ArrayBuffer?e:ArrayBuffer.isView(e)?e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):null:null,_normalizeMocVersion(e){const t=Number(e||0);return Number.isFinite(t)?t>=5?5:t>=1&&t<=4?4:null:null},_readMoc3HeaderVersion(e){const t=this._toArrayBuffer(e);if(!t||t.byteLength<8)return null;try{const e=new Uint8Array(t,0,4);if('MOC3'!==String.fromCharCode(...e))return null;const o=new DataView(t);return Number(o.getUint32(4,!0)||0)||null}catch{return null}},_detectCubismVersionFromMoc3Buffer(e){const t=this._toArrayBuffer(e);if(!t)return null;const o=window.parent??window,n=o?.Live2DCubismCore,r=n?.Moc,a=n?.Version;if('function'!=typeof r?.fromArrayBuffer||'function'!=typeof a?.csmGetMocVersion)return null;let i=null;try{if(i=r.fromArrayBuffer(t),!i)return null;const e=Number(a.csmGetMocVersion(i,t)||0)||0,o=Number(a?.csmGetLatestMocVersion?.()||0)||0,n=this._normalizeMocVersion(e);return o>0&&e>o?null:n}catch{return null}finally{try{i&&'function'==typeof i._release?i._release():i&&'function'==typeof i.release&&i.release()}catch{}}},async _resolveModel3CubismVersion(e,t){const o=Lt(e,4)||4,n=this._readMoc3HeaderVersion(t),r=this._normalizeMocVersion(n);if(null!=r)return r;try{const e=n&&n>=5?n:5;await jt.ensureCubism5Core(e)}catch{}return this._detectCubismVersionFromMoc3Buffer(t)??r??o},async _findModelJson(e){const t=[],o=[];if(e.forEach((e,n)=>{n?.dir||(/(^|\/)model3\.json$/i.test(e)||/\.model3\.json$/i.test(e)?t.push({path:e,file:n,priority:1}):/(^|\/)model\.json$/i.test(e)||/\.model\.json$/i.test(e)?t.push({path:e,file:n,priority:2}):/(^|\/)model[_-]?\d+\.json$/i.test(e)&&t.push({path:e,file:n,priority:3}),/\.json$/i.test(e)&&o.push({path:e,file:n}))}),t.length>0)return t.sort((e,t)=>e.priority-t.priority),t[0];let n=null,r=0;for(const e of o)try{const t=await e.file.async('text'),o=JSON.parse(t);if(!o||'object'!=typeof o)continue;let a=0;(String(e.path).split('/').pop()?.toLowerCase()??'').includes('model')&&(a+=50),o.FileReferences&&'object'==typeof o.FileReferences&&(a+=100,'string'==typeof o.FileReferences.Moc&&(a+=1e3),Array.isArray(o.FileReferences.Textures)&&(a+=200)),'string'!=typeof o.model&&'string'!=typeof o.Model||(a+=900),(Array.isArray(o.textures)||Array.isArray(o.Textures))&&(a+=200),a>r&&(n=e,r=a)}catch{}return n?{path:n.path,file:n.file,priority:99}:null},async _extractFile(e,t,o){const n=String(o||'').trim();if(!n)throw new Error('文件路径为空');const r=`${t}${n}`;let a=e.file(r);if(a||(a=e.file(n)),!a){const o=n.replace(/\\/g,'/');a=e.file(`${t}${o}`)||e.file(o)}if(!a)throw new Error(`文件不存在: ${r}`);return await a.async('arraybuffer')},async _extractFileOptional(e,t,o){try{return await this._extractFile(e,t,o)}catch{return null}},async _extractTextures(e,t,o){const n=[],r=Array.isArray(o?.FileReferences?.Textures)?o.FileReferences.Textures:[];for(const o of r){const r=String(o||'').trim();if(r)try{const o=await this._extractFile(e,t,r),a=r.toLowerCase(),i=a.endsWith('.png')?'image/png':a.endsWith('.webp')?'image/webp':'image/jpeg';n.push({name:r,data:new Blob([o],{type:i})})}catch(e){console.warn(`[${l}] Live2DUploader: 纹理提取失败: ${r}`,e)}}return n},async _extractTexturesV2(e,t,o){const n=[],r=o?.textures||o?.Textures||[];if(!Array.isArray(r))return n;for(const o of r){const r=String(o||'').trim();if(r)try{const o=await this._extractFile(e,t,r),a=r.toLowerCase(),i=a.endsWith('.png')?'image/png':a.endsWith('.webp')?'image/webp':'image/jpeg';n.push({name:r,data:new Blob([o],{type:i})})}catch(e){console.warn(`[${l}] Live2DUploader: 纹理提取失败: ${r}`,e)}}return n},async _extractMotions(e,t,o){const n={},r=o?.FileReferences?.Motions||{};for(const[o,a]of Object.entries(r))if(n[o]=[],Array.isArray(a))for(const r of a){const a='string'==typeof r?r:r?.File;if(a)try{const r=await this._extractFile(e,t,a);n[o].push({name:a,data:r})}catch(e){console.warn(`[${l}] Live2DUploader: 动作提取失败: ${a}`,e)}}if(0===Object.values(n).reduce((e,t)=>e+(Array.isArray(t)?t.length:0),0)){const o=(o=!1)=>{const n=[];return e.forEach((e,r)=>{r?.dir||(o||e.startsWith(t))&&/\.motion3\.json$/i.test(e)&&n.push(e.startsWith(t)?e.substring(t.length):e)}),n};let r=o(!1);if(0===r.length&&(r=o(!0)),r.length>0){r.sort((e,t)=>e.localeCompare(t,'zh-CN')),n.default=[];for(const o of r)try{const r=await this._extractFile(e,t,o);n.default.push({name:o,data:r})}catch(e){console.warn(`[${l}] Live2DUploader: 扫描动作提取失败: ${o}`,e)}}}return n},async _extractMotionsV2(e,t,o){const n={},r=o?.motions||o?.Motions||{};for(const[o,a]of Object.entries(r||{}))if(n[o]=[],Array.isArray(a))for(const r of a){const a='string'==typeof r?r:r?.file||r?.File;if(a)try{const r=await this._extractFile(e,t,a);n[o].push({name:a,data:r})}catch(e){console.warn(`[${l}] Live2DUploader: 动作提取失败: ${a}`,e)}}if(0===Object.values(n).reduce((e,t)=>e+(Array.isArray(t)?t.length:0),0)){const o=[];if(e.forEach((e,n)=>{n?.dir||e.startsWith(t)&&/\.mtn$/i.test(e)&&o.push(e.substring(t.length))}),o.length>0){n.default=[];for(const r of o)try{const o=await this._extractFile(e,t,r);n.default.push({name:r,data:o})}catch(e){console.warn(`[${l}] Live2DUploader: 扫描动作提取失败: ${r}`,e)}}}return n},async _extractExpressions(e,t,o){const n=[],r=o?.FileReferences?.Expressions||[];for(const o of r){const r='string'==typeof o?o:o?.File,a='object'==typeof o?o?.Name:r;if(r)try{const o=await this._extractFile(e,t,r);n.push({name:String(a||r),file:String(r),data:o})}catch(e){console.warn(`[${l}] Live2DUploader: 表情提取失败: ${r}`,e)}}if(0===n.length){const o=[];e.forEach((e,n)=>{n?.dir||e.startsWith(t)&&/\.exp3\.json$/i.test(e)&&o.push(e.substring(t.length))});for(const r of o)try{const o=await this._extractFile(e,t,r),a=r.replace(/\.exp3\.json$/i,'').split('/').pop()||r;n.push({name:a,file:r,data:o})}catch(e){console.warn(`[${l}] Live2DUploader: 扫描表情提取失败: ${r}`,e)}}return n},async _extractExpressionsV2(e,t,o){const n=[],r=o?.expressions||o?.Expressions||[];if(Array.isArray(r))for(const o of r){const r='string'==typeof o?o:o?.file||o?.File,a='string'==typeof o?o:o?.name||o?.Name||r;if(r)try{const o=await this._extractFile(e,t,r);n.push({name:String(a||r),file:String(r),data:o})}catch(e){console.warn(`[${l}] Live2DUploader: 表情提取失败: ${r}`,e)}}if(0===n.length){const o=[];e.forEach((e,n)=>{n?.dir||e.startsWith(t)&&/\.exp\.json$/i.test(e)&&o.push(e.substring(t.length))});for(const r of o)try{const o=await this._extractFile(e,t,r),a=r.replace(/\.exp\.json$/i,'').split('/').pop()||r;n.push({name:a,file:r,data:o})}catch(e){console.warn(`[${l}] Live2DUploader: 扫描表情提取失败: ${r}`,e)}}return n}},$n={class:'panel-main'},Un={class:'panel-nav'},In=['onClick'],zn={class:'nav-index'},Rn={class:'nav-label'},Wn={class:'nav-sub'},Fn={class:'panel-body'},On={class:'setting-section'},jn={class:'form-group'},Gn={class:'form-group'},qn=['value'],Yn={class:'form-group'},Jn={class:'form-group'},Hn={class:'form-group'},Xn={class:'input-with-btn'},Kn=['value'],Qn=['disabled'],Zn={key:0,class:'hint hint-error'},er={class:'form-group'},tr=['disabled'],or={key:0,class:'status-badge status-success'},nr={key:1,class:'status-badge status-fail'},rr={class:'form-group'},ar={class:'form-group'},ir={class:'form-row'},sr={class:'form-group half'},lr={class:'form-group half'},cr={class:'toggle-icon'},dr={key:0,class:'advanced-params'},Ar={class:'form-row'},ur={class:'form-group half'},pr={class:'form-group half'},mr={class:'form-row'},hr={class:'form-group half'},fr={class:'form-group half'},gr={class:'setting-section'},br={class:'form-group'},yr={class:'input-with-btn'},xr=['disabled'],vr={class:'form-group'},Cr={class:'model-list'},wr=['onClick'],Br={class:'form-group'},Sr={class:'model-list'},_r=['disabled'],kr=['disabled'],Er=['disabled'],Vr={class:'hint'},Mr={key:0,class:'hint'},Tr={key:1,class:'hint hint-error'},Nr={key:2,class:'local-model-info'},Pr={key:3,class:'hint'},Lr={class:'form-group'},Dr={class:'form-group'},$r={class:'form-group'},Ur={class:'form-group'},Ir={class:'setting-section'},zr={class:'form-group'},Rr=['value'],Wr={key:0,class:'form-group'},Fr={class:'form-group'},Or={class:'form-group'},jr=['disabled'],Gr={class:'form-group'},qr=['disabled'],Yr={class:'form-group'},Jr={class:'form-group'},Hr=['value'],Xr={class:'form-row'},Kr={class:'form-group half'},Qr={class:'form-group half'},Zr={class:'form-group'},ea={class:'form-group'},ta={class:'form-group'},oa={class:'form-group'},na={class:'form-group'},ra={class:'form-group'},aa={key:2,class:'form-group'},ia={class:'form-row'},sa={class:'form-group half'},la=['disabled'],ca={class:'form-group'},da={class:'hint'},Aa={key:0,class:'dice-sheet-list'},ua=['checked','onChange'],pa={key:1,class:'hint'},ma={class:'setting-section'},ha={class:'emotion-layout'},fa={class:'emotion-configs'},ga={class:'form-group'},ba={class:'hint'},ya={key:0,class:'form-group'},xa={class:'form-row'},va={class:'form-group half'},Ca=['disabled'],wa={class:'form-row'},Ba={class:'form-group half'},Sa={class:'form-group half'},_a={class:'form-group'},ka={class:'hint'},Ea={class:'form-group'},Va={class:'toggle-icon'},Ma={class:'emotion-map-table'},Ta={class:'emotion-map-tag'},Na=['onUpdate:modelValue'],Pa=['value'],La=['value'],Da=['value','disabled','onChange'],$a=['value'],Ua=['value'],Ia=['onClick'],za={key:1,class:'emotion-advanced-list'},Ra={class:'emotion-advanced-title'},Wa={class:'form-row'},Fa={class:'form-group half'},Oa=['value','onBlur'],ja={class:'form-group half'},Ga=['onUpdate:modelValue'],qa={class:'form-group'},Ya=['onUpdate:modelValue'],Ja={class:'emotion-preview-panel'},Ha={class:'emotion-preview-header'},Xa={class:'emotion-preview-tag'},Ka={key:0,class:'emotion-preview-empty'},Qa={class:'emotion-preview-controls'},Za={class:'emotion-zoom-row'},ei={class:'zoom-value'},ti=['title'],oi={class:'setting-section'},ni={class:'form-group'},ri={class:'form-group'},ai=['value'],ii=['value'],si=['value'],li={class:'form-group'},ci={class:'form-group'},di={class:'form-group'},Ai={class:'form-group'},ui={class:'input-with-btn'},pi=['value'],mi=['disabled'],hi={class:'hint'},fi={class:'toggle-icon'},gi={key:0,class:'advanced-params'},bi={class:'form-group'},yi={class:'form-group'},xi={key:1,class:'advanced-params'},vi={class:'form-group'},Ci={class:'form-row'},wi={class:'form-group half'},Bi={class:'form-group half'},Si={class:'form-group'},_i={class:'form-row'},ki={class:'form-group half'},Ei={class:'form-group half'},Vi={class:'form-row'},Mi={class:'form-group half'},Ti={class:'form-group half'},Ni={class:'form-row'},Pi={class:'form-group half'},Li={class:'form-group half'},Di={key:0,class:'form-group'},$i={class:'form-group'},Ui={class:'form-group'},Ii={class:'local-model-info'},zi={class:'form-row'},Ri={class:'form-group half'},Wi=['disabled'],Fi={class:'form-row'},Oi={class:'form-group half'},ji=['disabled'],Gi={class:'form-group half'},qi={key:2,class:'form-group'},Yi=['disabled'],Ji={class:'setting-section'},Hi={class:'browser-dialog-body gpt-model-body'},Xi={class:'gpt-model-tools'},Ki={key:0,class:'local-model-info'},Qi={key:1,class:'gpt-model-card-list'},Zi={class:'gpt-model-card-head'},es=['onUpdate:modelValue'],ts={class:'gpt-model-id'},os={class:'form-row'},ns={class:'form-group half'},rs=['onUpdate:modelValue'],as={class:'form-group half'},is=['onUpdate:modelValue'],ss={class:'form-row'},ls={class:'form-group half'},cs=['onUpdate:modelValue'],ds={class:'form-group half'},As=['onUpdate:modelValue'],us={class:'form-row'},ps={class:'form-group half'},ms=['onUpdate:modelValue'],hs=['value'],fs={class:'form-group half'},gs=['onUpdate:modelValue'],bs={class:'hint'},ys={class:'gpt-model-card-actions'},xs=['onClick'],vs=['onClick'],Cs=['onClick'],ws=['onClick'],Bs=['onClick'],Ss={class:'browser-dialog-header gpt-model-header'},_s={class:'browser-dialog-body gpt-model-body'},ks={class:'form-row'},Es={class:'form-group half'},Vs={class:'form-group half'},Ms={class:'form-row'},Ts={class:'form-group half'},Ns={class:'form-group half'},Ps={class:'form-row'},Ls={class:'form-group half'},Ds={class:'form-group half'},$s={class:'form-row'},Us={class:'form-group half'},Is={class:'form-group half'},zs={class:'form-row'},Rs={class:'form-group half'},Ws={class:'form-group half'},Fs={class:'form-row'},Os={class:'form-group half'},js={class:'form-group half'},Gs={class:'form-row'},qs={class:'form-group half'},Ys={class:'form-group half'},Js={class:'form-row'},Hs={class:'form-group half'},Xs={class:'form-group half'},Ks={class:'form-group'},Qs={class:'gpt-ref-list'},Zs={class:'form-row'},el={class:'form-group half'},tl=['onUpdate:modelValue'],ol={class:'form-group half'},nl=['onUpdate:modelValue'],rl={class:'form-group'},al=['onUpdate:modelValue'],il={class:'form-row'},sl={class:'form-group half'},ll=['onUpdate:modelValue'],cl={class:'form-group half'},dl=['onUpdate:modelValue'],Al={class:'form-row'},ul={class:'form-group half'},pl=['onUpdate:modelValue'],ml={class:'form-group half gpt-ref-actions'},hl=['onClick'],fl=['onClick'],gl={class:'form-group'},bl={class:'gpt-expression-map-list'},yl=['onUpdate:modelValue'],xl=['onUpdate:modelValue'],vl=['value'],Cl=['onClick'],wl={class:'browser-dialog-header'},Bl={class:'browser-dialog-body'},Sl=(0,s.defineComponent)({__name:'SettingsPanel',props:{visible:{type:Boolean}},emits:['close','model-change'],setup(e,{emit:t}){const n=e,r=t,a=[{key:'api',index:'01',label:'API 设置',en:'API CONTROL'},{key:'live2d',index:'02',label:'Live2D',en:'MODEL CONTROL'},{key:'comment',index:'03',label:'吐槽',en:'COMMENT SYSTEM'},{key:'expression',index:'04',label:'表情',en:'EMOTION COT'},{key:'tts',index:'05',label:'TTS',en:'VOICE CONTROL'},{key:'about',index:'06',label:'关于',en:'ABOUT & LICENSE'}],i=(0,s.ref)('api'),c=he(),{settings:A}=o(c);function u(e,t,o,n){const r='number'==typeof e?e:Number(e);return Number.isFinite(r)?Bt(r,o,n):t}function p(){A.value.apiConfig&&'object'==typeof A.value.apiConfig||(A.value.apiConfig={url:'',apiKey:'',model:'gpt-4o-mini',source:'openai',max_tokens:G,temperature:q,frequency_penalty:Y,presence_penalty:J,top_p:H,top_k:X,usePresetSampling:!1,sendWorldInfo:!1});const e=A.value.apiConfig;e.max_tokens=Math.round(u(e.max_tokens,G,1,4096)),e.temperature=u(e.temperature,q,0,2),e.frequency_penalty=u(e.frequency_penalty,Y,-2,2),e.presence_penalty=u(e.presence_penalty,J,-2,2),e.top_p=u(e.top_p,H,0,1),e.top_k=Math.round(u(e.top_k,X,0,500)),'string'!=typeof e.url&&(e.url=String(e.url??'')),'string'!=typeof e.apiKey&&(e.apiKey=String(e.apiKey??'')),'string'!=typeof e.model&&(e.model=String(e.model??'gpt-4o-mini')),'string'!=typeof e.source&&(e.source=String(e.source??'openai')),e.usePresetSampling=!0===e.usePresetSampling,e.sendWorldInfo=!0===e.sendWorldInfo,A.value.petScale=u(A.value.petScale,B,.1,3);const t='number'==typeof A.value.bubbleDuration?A.value.bubbleDuration:Number(A.value.bubbleDuration??Number.NaN),o=Number.isFinite(t)&&t>600?t/1e3:t;A.value.bubbleDuration=Math.round(u(o,K,-1,600))}const v=(0,s.computed)(()=>u(A.value.apiConfig?.temperature,q,0,2).toFixed(1)),C=(0,s.computed)(()=>u(A.value.apiConfig?.frequency_penalty,Y,-2,2).toFixed(1)),S=(0,s.computed)(()=>u(A.value.apiConfig?.presence_penalty,J,-2,2).toFixed(1)),k=(0,s.computed)(()=>u(A.value.apiConfig?.top_p,H,0,1).toFixed(2)),E=(0,s.computed)(()=>u(A.value.petScale,B,.1,3).toFixed(2));p();const V=f,M=g,T=b,N=x,P=(0,s.ref)(!1),L=(0,s.ref)(A.value.modelPath||''),D=(0,s.ref)(null),U=(0,s.ref)(!1),I=(0,s.ref)(!1),R=(0,s.ref)(''),W=(0,s.ref)(''),F=(0,s.ref)(null),O=(0,s.computed)(()=>U.value||I.value),j=(0,s.computed)(()=>!!F.value),Q=(0,s.ref)([]),Z=(0,s.ref)(!1);function ee(e){return String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/\s{2,}/g,' ').trim()}function te(e){const t=new Set,o=[];for(const n of e){const e=ee(n);e&&(t.has(e)||(t.add(e),o.push(e)))}return o}function oe(e){if('string'==typeof e){const t=e.trim();if(!t)return null;try{return oe(JSON.parse(t))}catch{return null}}return!e||'object'!=typeof e||Array.isArray(e)?null:e}function ae(e){return Object.keys(e).some(e=>e.startsWith('sheet_'))}function ie(e){const t=oe(e);if(!t)return[];let o=t;if(!ae(o)){const e=oe(o.independentData);if(!e||!ae(e))return[];o=e}return te(Object.keys(o).filter(e=>e.startsWith('sheet_')).map(e=>{const t=oe(o?.[e]);return t?.name??''}))}function se(e){const t=oe(e);if(!t)return null;const o=Object.keys(t);for(let e=o.length-1;e>=0;e--){const n=oe(t[o[e]]);if(!n)continue;const r=oe(n.independentData);if(r&&ae(r))return r}return null}function le(e){if(!e||'object'!=typeof e)return null;const t=[e.TavernDB_ACU_IndependentData,e.TavernDB_ACU_Data,e.TavernDB_ACU_SummaryData,e.data?.TavernDB_ACU_IndependentData,e.data?.TavernDB_ACU_Data,e.data?.TavernDB_ACU_SummaryData];for(const e of t){const t=oe(e);if(!t)continue;if(ae(t))return t;const o=oe(t.independentData);if(o&&ae(o))return o}const o=[e.TavernDB_ACU_IsolatedData,e.data?.TavernDB_ACU_IsolatedData];for(const e of o){const t=se(e);if(t)return t}return null}function ce(){return te((Array.isArray(A.value.diceReferenceVisibleSheets)?A.value.diceReferenceVisibleSheets:[]).map(e=>String(e??'')))}function de(e){A.value.diceReferenceVisibleSheets=te(e)}function Ae(e){const t=ce();return 0===t.length||t.includes(e)}const ue=(0,s.computed)(()=>{const e=Q.value.length,t=ce();return e<=0?'暂无可用表名。':0===t.length?`当前：全部可见（${e}/${e}）`:`当前：已勾选 ${t.length}/${e}`});function pe(){Z.value=!0;try{const e=function(){try{const e=window.parent??window,t=e?.AutoCardUpdaterAPI;return t&&'function'==typeof t.exportTableAsJson?ie(t.exportTableAsJson()):[]}catch{return[]}}(),t=e.length>0?[]:function(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'all'}),t=Array.isArray(e)?e:[];for(let e=t.length-1;e>=0;e--){const o=le(t[e]);if(!o)continue;const n=ie(o);if(n.length>0)return n}}catch{}return[]}(),o=ce();Q.value=te([...e,...t,...o])}finally{Z.value=!1}}function me(){de([])}function fe(){de([])}const ge=(0,s.ref)(_t()),be=(0,s.ref)([]),ye=(0,s.ref)(!1),xe=(0,s.ref)(''),ve=(0,s.ref)(''),Ce=(0,s.ref)('你好，这是一段 TTS 配音测试。'),we=((0,s.ref)(null),(0,s.ref)(null),(0,s.ref)(null),(0,s.ref)(null),(0,s.ref)(!1)),Be=(0,s.ref)(!1),Se=(0,s.ref)(''),_e=(0,s.ref)([]),ke=(0,s.ref)(null),Ee=(0,s.ref)(null),Ve=(0,s.ref)(null),Me=(0,s.ref)(''),Te=(0,s.ref)([]),Ne=(0,s.computed)(()=>'set_model'===ze(A.value.gptSoVits?.modelSwitchMode)),Le=(0,s.computed)(()=>`${A.value.ttsProvider===Pe.GPT_SOVITS_V2?'GPT-SoVITS：建议把音色 name 设为角色名。':A.value.ttsProvider===Pe.EDGE_TTS_DIRECT?'EdgeTTS（直连）：前端直连，不需要插件；失败时可切换 Edge 浏览器复测。':'LittleWhiteBox：未指定/未绑定时使用此默认音色。'}${0===be.value.length?'（当前音色列表为空）':''}`),De=(0,s.computed)(()=>{const e=Array.isArray(A.value.gptSoVits?.models)?A.value.gptSoVits.models:[],t=e.filter(e=>!1!==e?.enabled).length,o=e.reduce((e,t)=>e+(Array.isArray(t?.refAudios)?t.refAudios.length:0),0),n=String(A.value.ttsDefaultSpeaker||'').trim()||'未设置';return`模型 ${e.length} 条（启用 ${t} 条），参考音频 ${o} 条，默认音色：${n}`}),$e=(0,s.computed)(()=>{const e=Array.isArray(_e.value)?_e.value:[],t=String(Se.value||'').trim().toLowerCase();return t?e.filter(e=>[String(e?.name||''),String(e?.desc||''),String(e?.id||''),String(e?.paths?.gptWeightsPath||''),String(e?.paths?.sovitsWeightsPath||'')].join(' ').toLowerCase().includes(t)):e}),Ie=y,Re=(0,s.ref)([]),We=(0,s.ref)([]),Fe=(0,s.ref)([]),Oe=(0,s.ref)(!1),je=(0,s.computed)(()=>{const e=new Set,t=[];for(const o of Re.value){const n=String(o??'').trim();n&&(e.has(n)||(e.add(n),t.push(n)))}return t.sort((e,t)=>e.localeCompare(t))}),Ge=(0,s.computed)(()=>new Set(je.value));function qe(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.floor(t)):0}function Ye(e){const t=String(e??'').trim();return t===h?'':t}function Je(e){return String(e??'').trim()===h}function He(e){const t=!0===e.explicitEmptyGroup||Je(e.group);return{group:Ye(e.group),index:qe(e.index),name:String(e.name??'').trim(),explicitEmptyGroup:t}}function Xe(e){const t=He(e),o=!0===t.explicitEmptyGroup&&''===t.group;return t.group||0!==t.index||o?JSON.stringify({...t,group:''===t.group&&o?h:t.group}):''}function Ke(e){const t=String(e?.live2dMotion?.group??''),o=Je(t),n=Ye(t),r=qe(e?.live2dMotion?.index);if(!(o||!!n||r>0))return null;const a=Fe.value.find(e=>{const t=Ye(e?.group),o=qe(e?.index);return t===n&&o===r});if(a)return He({group:a.group,index:a.index,name:a.name});const i=n.toLowerCase();if(i){const e=Fe.value.find(e=>{const t=String(e?.name??'').trim().toLowerCase(),o=qe(e?.index);return t===i&&o===r})||Fe.value.find(e=>String(e?.name??'').trim().toLowerCase()===i);if(e)return He({group:e.group,index:e.index,name:e.name})}return He({group:n,index:r,explicitEmptyGroup:o})}function Qe(e){const t=Ke(e);return t?Xe(t):''}function et(e){const t=Ke(e);if(!t)return'';if(t.name){const e=t.group?`${t.group}#${t.index}`:`#${t.index}`;return`${t.name}（动作 ${e}）`}return`${t.group||'(空动作组)'}#${t.index}`}function ot(e,t){const o=function(e){const t=String(e||'').trim();if(!t)return null;try{const e=JSON.parse(t);if(!e||'object'!=typeof e)return null;const o=Je(e.group),n=Ye(e.group??''),r=qe(e.index);return n||0!==r||o?{group:n,index:r,name:String(e.name??'').trim(),explicitEmptyGroup:o}:null}catch{return null}}(String(t||'').trim());if(!o)return e.live2dMotion.group='',void(e.live2dMotion.index=0);e.live2dMotion.group=''===o.group&&!0===o.explicitEmptyGroup?h:o.group,e.live2dMotion.index=o.index}const nt=(0,s.computed)(()=>{const e=new Set,t=[];for(const o of Fe.value){const n=Ye(o?.group),r=qe(o?.index),a=String(o?.name??'').trim(),i=Xe({group:n,index:r,name:a,explicitEmptyGroup:''===n});if(!i||e.has(i))continue;e.add(i);const s=`${n||'(空动作组)'}#${r}`,l=a||'(未命名动作)';t.push({key:`motion_${s}_${l}`.replace(/\s+/g,'_'),value:i,label:`${l}（动作 ${s}）`})}for(const o of We.value){const n=Ye(o?.name),r=Xe({group:n,index:0,explicitEmptyGroup:''===n});if(!r||e.has(r))continue;e.add(r);const a=n||'(空动作组)';t.push({key:`group_${a}_${o.count}`.replace(/\s+/g,'_'),value:r,label:`${a}（动作组 ${o.count}）`})}return t.sort((e,t)=>e.label.localeCompare(t.label,'zh-CN'))}),at=(0,s.computed)(()=>new Set(nt.value.map(e=>e.value))),it=(0,s.computed)(()=>{const e=Re.value.length,t=Fe.value.length,o=We.value.length;if(!go.model)return'当前未加载 Live2D 模型，加载后可刷新列表。';return`当前模型：表情 ${e} 个${0===e?'（该模型可能未提供独立 Expressions）':''}，动作 ${t} 个${0===t?'（未识别到 motions）':''}，动作组 ${o} 个。`}),st=(0,s.ref)(null),lt=(0,s.ref)(null),ct=(0,s.ref)(!1),dt=(0,s.ref)('默认'),At=(0,s.ref)('切换到“表情”后自动加载预览'),ut=(0,s.ref)(1.8);let pt=0,ft=0,gt={x:0,y:0,scale:1},bt=!1,yt={x:0,y:0},xt={x:0,y:0},Ct=null,wt=null;function Bt(e,t,o){return Math.max(t,Math.min(o,e))}function St(){const e=st.value,t=e?.getBoundingClientRect?.();return{width:Math.max(1,Math.floor(t?.width||e?.clientWidth||320)),height:Math.max(1,Math.floor(t?.height||e?.clientHeight||260))}}function kt(){if(!ct.value)return;const e=go.model;if(!e)return;const{width:t,height:o}=St(),n=Math.max(60,.45*t),r=Math.max(60,.45*o);pt=Bt(pt,-n,n),ft=Bt(ft,-r,r),ut.value=Bt(ut.value,.5,4);const a=gt.scale*ut.value;e.scale?.set&&e.scale.set(a),e.x=gt.x+pt,e.y=gt.y+ft;try{const e=Yt.app;e?.renderer&&e?.stage&&e.renderer.render(e.stage)}catch{}}function Et(){ut.value=1.8,pt=0,ft=0,kt()}function Vt(e){const t=e?.originalEvent||e;return t?.touches?.length?{x:t.touches[0].clientX,y:t.touches[0].clientY}:t?.changedTouches?.length?{x:t.changedTouches[0].clientX,y:t.changedTouches[0].clientY}:Number.isFinite(t?.clientX)&&Number.isFinite(t?.clientY)?{x:t.clientX,y:t.clientY}:null}function Mt(){try{wt?.disconnect()}catch{}finally{wt=null}}async function Tt(){return!!ct.value||(Ct||(Ct=(async()=>{await(0,s.nextTick)();const e=st.value;if(!e)return!1;if(!go.model)return At.value='当前未加载 Live2D 模型',!1;if(!Yt.container)return At.value='Live2D 舞台未就绪',!1;At.value='正在挂载预览...';if(!Yt.pushMount(e))return At.value='预览挂载失败',!1;ct.value=!0,function(){const e=lt.value;if(!e)return;if(e.__dpPreviewHandlers)return;const t=(window.parent??window).document,o=t=>{if(!ct.value)return;const o=Vt(t);o&&(bt=!0,yt=o,xt={x:pt,y:ft},e.style.cursor='grabbing','function'==typeof t.preventDefault&&t.preventDefault())},n=e=>{if(!bt)return;const t=Vt(e);t&&(pt=xt.x+(t.x-yt.x),ft=xt.y+(t.y-yt.y),kt(),'function'==typeof e.preventDefault&&e.preventDefault())},r=()=>{bt&&(bt=!1,e.style.cursor='grab')},a=e=>{if(!ct.value)return;e.preventDefault();const t=e.deltaY>0?-.1:.1;ut.value=Bt(ut.value+t,.5,4),kt()};e.style.cursor='grab',e.addEventListener('mousedown',o),e.addEventListener('touchstart',o,{passive:!1}),e.addEventListener('wheel',a,{passive:!1}),t.addEventListener('mousemove',n),t.addEventListener('touchmove',n,{passive:!1}),t.addEventListener('mouseup',r),t.addEventListener('touchend',r),t.addEventListener('touchcancel',r),e.__dpPreviewHandlers={onDown:o,onMove:n,onUp:r,onWheel:a}}(),function(){const e=st.value;if(e&&(Mt(),'undefined'!=typeof ResizeObserver))try{wt=new ResizeObserver(()=>{if(!ct.value)return;const{width:e,height:t}=St();Yt.resizePreview(e,t),kt()}),wt.observe(e)}catch{wt=null}}();const{width:t,height:o}=St();return Yt.resizePreview(t,o),go.mountToStage(t,o,1),function(){const e=go.model;if(!e)return;const t=Number(e.scale?.x);gt={x:Number(e.x)||0,y:Number(e.y)||0,scale:Number.isFinite(t)&&t>0?t:1}}(),Et(),fo(),At.value='预览就绪，可拖拽移动/滚轮缩放',!0})().finally(()=>{Ct=null}),Ct))}function Nt(){if(Mt(),function(){const e=lt.value;if(!e)return;const t=(window.parent??window).document,o=e.__dpPreviewHandlers;if(o){try{e.removeEventListener('mousedown',o.onDown),e.removeEventListener('touchstart',o.onDown),e.removeEventListener('wheel',o.onWheel),t.removeEventListener('mousemove',o.onMove),t.removeEventListener('touchmove',o.onMove),t.removeEventListener('mouseup',o.onUp),t.removeEventListener('touchend',o.onUp),t.removeEventListener('touchcancel',o.onUp)}catch{}e.__dpPreviewHandlers=null}}(),bt=!1,!ct.value)return;ct.value=!1;const e=Yt.popMount();e&&go.model&&go.mountToStage(e.width,e.height,1),At.value='切换到“表情”后自动加载预览'}function Pt(){xo(dt.value)}(0,s.watch)(()=>({visible:n.visible,section:i.value}),({visible:e,section:t})=>{e&&'expression'===t?(async()=>{await Tt()&&xo(dt.value)})():Nt()},{immediate:!0}),(0,s.onBeforeUnmount)(()=>{Nt()});const Lt=(0,s.ref)([]),Dt=(0,s.ref)(!1),$t=(0,s.ref)(''),Ut=(0,s.ref)(!1),It=(0,s.ref)('idle'),Wt=(0,s.ref)(''),jt=(0,s.ref)(!1),Gt=(0,s.ref)(!1),qt=(0,s.ref)(!1),Jt=(0,s.ref)(''),Ht={position:'fixed',inset:'0',width:'100vw',height:'100vh',minHeight:'100vh',zIndex:'10001',display:'flex',alignItems:'center',justifyContent:'center'},Xt={position:'relative',display:'flex',flexDirection:'column',width:'min(1080px, calc(100vw - 24px))',maxHeight:'calc(100vh - 24px)',minHeight:'280px'};function Kt(e){if(!Array.isArray(e))return[];const t=[];for(const o of e){if('string'==typeof o){const e=o.trim();e&&t.push(e);continue}if(o&&'object'==typeof o){const e=o.id,n=o.model,r=o.name,a=('string'==typeof e?e:'string'==typeof n?n:'string'==typeof r?r:'').trim();a&&t.push(a)}}return[...new Set(t)]}async function Qt(e){const t=window?.TavernHelper?.getModelList;if('function'==typeof t)try{const o=Kt(await t(e));if(o.length>0)return o}catch(e){console.warn(`[${l}] TavernHelper.getModelList 调用失败，改用 HTTP 回退`,e)}if('function'==typeof getModelList)try{const t=Kt(await getModelList(e));if(t.length>0)return t}catch(e){console.warn(`[${l}] getModelList 调用失败，改用 HTTP 回退`,e)}return async function(e){const t=String(e.apiurl||'').trim().replace(/\/+$/,'');if(!t)throw new Error('API URL 为空');const o={Accept:'application/json'};e.key&&(o.Authorization=`Bearer ${e.key}`);const n=async e=>fetch(`${t}${e}`,{method:'GET',headers:o,cache:'no-cache'});let r=await n('/v1/models');if(r.ok||404!==r.status&&405!==r.status||(r=await n('/models')),!r.ok)throw new Error(`模型列表请求失败 (HTTP ${r.status})`);const a=await r.json();return Kt(a.data??a.models??a)}(e)}async function Zt(){const e=A.value.apiConfig.url;if(e){Dt.value=!0,$t.value='',Lt.value=[];try{const t=await Qt({apiurl:e,key:A.value.apiConfig.apiKey||void 0});Lt.value=t,t.length>0&&!t.includes(A.value.apiConfig.model)&&(A.value.apiConfig.model=t[0])}catch(e){$t.value=`获取失败: ${e instanceof Error?e.message:String(e)}`}finally{Dt.value=!1}}}async function eo(){const e=A.value.apiConfig.url;if(e){Ut.value=!0,It.value='idle',Wt.value='';try{const t=await Qt({apiurl:e,key:A.value.apiConfig.apiKey||void 0});t&&t.length>=0?It.value='success':(It.value='fail',Wt.value='返回数据异常')}catch(e){It.value='fail',Wt.value=e instanceof Error?e.message:String(e)}finally{Ut.value=!1}}}function to(e){const t=Number(e||0);return!Number.isFinite(t)||t<=0?'0 B':t<1024?`${Math.round(t)} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1024/1024).toFixed(2)} MB`}function oo(e){const t=Number(e||0);if(!Number.isFinite(t)||t<=0)return'未知';try{return new Date(t).toLocaleString()}catch{return'未知'}}async function no(){try{const e=await Ft();F.value=e,e||A.value.modelPath!==m?e&&(R.value=`本地模型槽位就绪：${e.fileName}`):R.value='当前本地槽位为空，请先上传 ZIP 模型。'}catch(e){F.value=null,W.value=`读取本地模型失败: ${e instanceof Error?e.message:String(e)}`}}function ro(){W.value='',R.value='';const e=D.value;e&&(e.value='',e.click())}async function ao(e){const t=e.target,o=t?.files?.[0];if(o){U.value=!0,W.value='',R.value=`正在解析 ${o.name}...`;try{const e=await Dn.uploadZip(o);R.value=`上传成功：${e.fileName}`,await no(),A.value.modelPath=m,L.value=m,r('model-change',m),toastr.success('本地模型上传成功，已切换到本地模型')}catch(e){const t=e instanceof Error?e.message:String(e);W.value=`上传失败：${t}`,R.value='',toastr.error(`本地模型上传失败：${t}`)}finally{U.value=!1,t&&(t.value='')}}}async function io(){I.value=!0,W.value='';try{if(!await Ot())return R.value='当前没有可用的本地模型，请先上传 ZIP。',void toastr.warning('当前没有可用的本地模型，请先上传 ZIP');await no(),A.value.modelPath=m,L.value=m,R.value='已切换到本地模型。',r('model-change',m)}catch(e){W.value=`切换本地模型失败: ${e instanceof Error?e.message:String(e)}`}finally{I.value=!1}}async function so(){I.value=!0,W.value='';try{await async function(){const e=await Rt(),t=zt();return new Promise((o,n)=>{try{if(!e.objectStoreNames.contains(d))return void o();const r=e.transaction([d],'readwrite');r.objectStore(d).delete(t),r.oncomplete=()=>{try{console.log(`[${l}] 已删除本地 Live2D 模型槽位: ${t}`)}catch{}o()},r.onerror=()=>n(r.error??new Error('删除本地模型失败'))}catch(e){n(e)}})}(),F.value=null,R.value='已清除本地模型槽位。',A.value.modelPath===m&&(A.value.modelPath=w,L.value=w,r('model-change',w)),toastr.success('已清除本地模型')}catch(e){W.value=`清除失败: ${e instanceof Error?e.message:String(e)}`}finally{I.value=!1}}function lo(e){A.value.modelPath=e,L.value=e,P.value=!1,r('model-change',e)}function co(){let e=L.value.trim();if(!e)return;const t=e.match(/^https?:\/\/github\.com\/([^/]+\/[^/]+)\/blob\/(.+)$/);t&&(e=`https://raw.githubusercontent.com/${t[1]}/${t[2]}`,L.value=e),A.value.modelPath=e,r('model-change',e)}function Ao(){c.resetSettings()}function uo(){A.value.emotionConfigs=re();try{toastr.success('表情配置已重置为默认')}catch{}}function po(e,t){const o=t.target;o&&(e.aliases=function(e){return ne(String(e||'').split(/[,，\n\r]+/g).map(e=>e.trim()).filter(Boolean))}(o.value))}function fo(){Oe.value=!0;try{Re.value=go.getExpressions(),Fe.value=go.getMotions().map(e=>({name:e.name,group:e.group,index:e.index})).sort((e,t)=>e.name.localeCompare(t.name));const e=go.getMotionGroups();We.value=Object.entries(e).map(([e,t])=>({name:e,count:t})).sort((e,t)=>e.name.localeCompare(t.name));try{toastr.info('已刷新模型表情/动作列表')}catch{}}catch(e){console.warn(`[${l}] 刷新模型表情/动作列表失败:`,e),Re.value=[],Fe.value=[],We.value=[];try{toastr.error('刷新列表失败，请先确保模型已加载')}catch{}}finally{Oe.value=!1}}function bo(e=!1){const t=go.model;if(!t){try{toastr.warning('当前未加载模型，无法自动匹配')}catch{}return}let o=0;for(const n of A.value.emotionConfigs){const r=String(n.live2dExpression||'').trim();if(e||!r){const e=mo(t,n.tag);e&&(n.live2dExpression=e,o+=1)}const a=!1!==n.live2dMotion?.enabled,i=String(n.live2dMotion?.group||'').trim();if(a&&(e||!i)){const e=ho(t,n.tag);e&&(n.live2dMotion.group=e.group,n.live2dMotion.index=e.index,o+=1)}}try{e?toastr.success(o>0?`已自动匹配并覆盖 ${o} 项`:'未找到可覆盖的匹配结果'):toastr.success(o>0?`已自动匹配并填充 ${o} 项空白覆盖`:'未找到可填充的空白覆盖')}catch{}}function yo(){let e=0;for(const t of A.value.emotionConfigs){const o=!!String(t.live2dExpression||'').trim(),n=!!String(t.live2dMotion?.group||'').trim();o&&(t.live2dExpression='',e+=1),n&&(t.live2dMotion.group='',t.live2dMotion.index=0,e+=1)}try{toastr.info(e>0?`已清空 ${e} 项 Live2D 覆盖`:'当前没有需要清空的 Live2D 覆盖')}catch{}}async function xo(e){dt.value=e;if(!await Tt())return;const t=go.model;if(!t)return void(At.value='模型未就绪');kt();const o=A.value.emotionConfigs.find(t=>t.tag===e),n=mo(t,e,o?.live2dExpression);n&&go.playExpression(n);const r=ho(t,e,o?.live2dMotion);r&&go.playMotion(r.group,r.index);const a=n?`表情: ${n}`:'表情: (无匹配)',i=r?r.name?`动作: ${r.name} (${r.group||'(空动作组)'}#${r.index})`:`动作: ${r.group||'(空动作组)'}`:'动作: (无匹配)';if(At.value=`${e} | ${a} | ${i}`,!n&&!r)try{toastr.info('未匹配到可用的表情/动作（可尝试刷新列表或手动覆盖）')}catch{}}function vo(){if(function(e){try{localStorage.setItem(Ue(),String(e))}catch(e){console.error(`[${l}] 保存TTS启用状态失败:`,e)}}(ge.value),!ge.value)try{Eo.stop()}catch{}}async function Co(){ye.value=!0;try{be.value=await vt()}catch(e){console.warn(`[${l}] 获取 TTS 音色列表失败:`,e),be.value=[]}finally{ye.value=!1}}function wo(e){return String(e||'').replace(/\\/g,'/').trim()}function Bo(){A.value.gptSoVits.modelSwitchMode=ze(A.value.gptSoVits.modelSwitchMode)}function So(){const e=wo(A.value.gptSoVits.rootDir);A.value.gptSoVits.rootDir=e,A.value.gptSoVits.importPathPrefix=e}function _o(){const e=wo(A.value.gptSoVits.importPathPrefix);A.value.gptSoVits.importPathPrefix=e,A.value.gptSoVits.rootDir=e}function ko(e){if(!e)return null;const t=Array.isArray(e.refAudios)?e.refAudios:[],o=t.find(t=>String(t?.id||'').trim()===String(e.defaultRefId||'').trim())||t.find(t=>String(t?.path||'').trim()===String(e?.paths?.defaultRefAudioPath||'').trim())||t[0]||null,n=e?.params||{};return{name:String(e.name||'').trim(),desc:String(e.desc||'').trim(),refAudioPath:String(o?.path||e?.paths?.defaultRefAudioPath||'').trim(),promptText:String(o?.promptText||n.promptText||'').trim(),promptLang:String(o?.promptLang||n.promptLang||'zh').trim()||'zh',textLang:String(o?.textLang||n.textLang||'auto').trim()||'auto',gptWeightsPath:String(e?.paths?.gptWeightsPath||'').trim(),sovitsWeightsPath:String(e?.paths?.sovitsWeightsPath||'').trim(),modelSwitchMode:String(n.modelSwitchMode||A.value.gptSoVits.modelSwitchMode||'set_weights').trim(),setModelEndpoint:String(n.setModelEndpoint||A.value.gptSoVits.setModelEndpoint||'/set_model').trim(),strictWeightSwitch:!!(n.strictWeightSwitch??A.value.gptSoVits.strictWeightSwitch)}}function Vo(e){return(Array.isArray(e)?e:[]).map(ko).filter(Boolean).filter(e=>String(e?.name||'').trim())}function Mo(e){try{xe.value=JSON.stringify(e||[],null,2)}catch{xe.value='[]'}}function To(e){try{ve.value=JSON.stringify(e||[],null,2)}catch{ve.value='[]'}}function No(e,t){const o=Array.isArray(e)?e.slice():[],n=new Set(o.map(e=>String(e?.name||'').trim()).filter(Boolean));for(const e of Array.isArray(t)?t:[]){if(!e)continue;const t={...e},r=String(t.name||'新模型').trim()||'新模型';let a=r,i=2;for(;n.has(a);)a=`${r}_${i++}`;t.name=a,n.add(a),o.push(t)}return o}function Po(e){try{return JSON.parse(JSON.stringify(Array.isArray(e)?e:[]))}catch{return Array.isArray(e)?e.slice():[]}}function Lo(){return{id:`model_${Date.now().toString(36)}`,name:'新模型',enabled:!0,desc:'手动添加',paths:{gptWeightsPath:'',sovitsWeightsPath:'',defaultRefAudioPath:''},params:{promptText:'',promptLang:'zh',textLang:'zh',textSplitMethod:'cut5',speedFactor:1,mediaType:'wav',streamingMode:!1,modelSwitchMode:ze(A.value.gptSoVits.modelSwitchMode||'set_weights'),setModelEndpoint:String(A.value.gptSoVits.setModelEndpoint||'/set_model').trim()||'/set_model',strictWeightSwitch:!!A.value.gptSoVits.strictWeightSwitch},refAudios:[],defaultRefId:'',expressionRefMap:{}}}function Do(){const e=Ze(A.value.gptSoVits.models||[]);_e.value=Po(e)}function $o(){Do(),Se.value='',Xo(),we.value=!0}function Uo(){we.value=!1,Xo()}async function Io(e=''){const t=Ze(_e.value||[]),o=Vo(t);_e.value=Po(t),A.value.gptSoVits.models=t,A.value.gptSoVits.voices=o,Mo(t),To(o);const n=tt(ht());!A.value.ttsDefaultSpeaker&&n?.name&&(A.value.ttsDefaultSpeaker=n.name),await Co(),e&&toastr.success(e)}async function zo(){await Io(`GPT-SoVITS 模型列表已保存：${_e.value.length} 条`)}async function Ro(){await Io(`GPT-SoVITS 模型列表已保存：${_e.value.length} 条`),Uo()}function Wo(){const e=No(_e.value,[Lo()]);_e.value=Po(Ze(e)),toastr.success('已添加一条模型模板')}function Fo(e){const t=String(e||'').trim();return t?_e.value.findIndex(e=>String(e?.id||'').trim()===t):-1}function Oo(){ke.value?.click()}function jo(){Ee.value?.click()}async function Go(e){const t=e.target,o=t?.files?.[0];if(o)try{const e=await o.text(),t=JSON.parse(String(e||'[]'));if(!Array.isArray(t))return void toastr.error('导入失败：JSON 需为数组');const n=Ze(t),r=No(_e.value,n);_e.value=Po(Ze(r)),toastr.success(`已导入模型：${n.length} 条（请点击保存）`)}catch(e){console.warn(`[${l}] GPT-SoVITS 模型管理器 JSON 导入失败:`,e),toastr.error('导入失败：JSON 解析错误')}finally{t&&(t.value='')}}async function qo(e){const t=e.target,o=t?.files;if(o&&0!==o.length)try{const e=wo(A.value.gptSoVits.importPathPrefix||A.value.gptSoVits.rootDir||''),t=mt(o,e);if(!t||0===t.length)return void toastr.warning('未识别到可导入模型（至少需要参考音频）');const n=No(_e.value,t);_e.value=Po(Ze(n));const r=t.some(e=>{const t=String(e?.paths?.defaultRefAudioPath||'').trim();return t&&!rt(t)});let a=`已从文件夹导入模型：${t.length} 条（请点击保存）`;r&&!e&&(a+='（包含相对路径，建议填写路径前缀）'),toastr.success(a)}catch(e){console.warn(`[${l}] GPT-SoVITS 模型管理器文件夹导入失败:`,e),toastr.error('文件夹导入失败')}finally{t&&(t.value='')}}function Yo(){try{const e=Ze(_e.value||[]),t=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),o=URL.createObjectURL(t),n=document.createElement('a');n.href=o,n.download='gpt_sovits_models.json',n.click(),setTimeout(()=>URL.revokeObjectURL(o),1e3),toastr.success('已导出 gpt_sovits_models.json')}catch(e){console.warn(`[${l}] GPT-SoVITS 模型管理器导出失败:`,e),toastr.error('导出失败')}}function Jo(){const e=Ve.value;e&&(e.paths={gptWeightsPath:wo(e?.paths?.gptWeightsPath||''),sovitsWeightsPath:wo(e?.paths?.sovitsWeightsPath||''),defaultRefAudioPath:wo(e?.paths?.defaultRefAudioPath||'')},e.params={promptText:String(e?.params?.promptText||'').trim(),promptLang:String(e?.params?.promptLang||'zh').trim()||'zh',textLang:String(e?.params?.textLang||'auto').trim()||'auto',textSplitMethod:String(e?.params?.textSplitMethod||'cut5').trim()||'cut5',speedFactor:Number.isFinite(Number(e?.params?.speedFactor))?Number(e?.params?.speedFactor):1,mediaType:String(e?.params?.mediaType||'wav').trim()||'wav',streamingMode:!!e?.params?.streamingMode,modelSwitchMode:ze(e?.params?.modelSwitchMode||'set_weights'),setModelEndpoint:String(e?.params?.setModelEndpoint||'/set_model').trim()||'/set_model',strictWeightSwitch:!!e?.params?.strictWeightSwitch},e.refAudios=(Array.isArray(e.refAudios)?e.refAudios:[]).map((e,t)=>function(e,t){const o=String(e?.id||`ref_${t+1}`).trim()||`ref_${t+1}`;return{id:o,name:String(e?.name||o).trim()||o,path:wo(e?.path||''),promptText:String(e?.promptText||'').trim(),promptLang:String(e?.promptLang||'zh').trim()||'zh',textLang:String(e?.textLang||'auto').trim()||'auto'}}(e,t)),!e.defaultRefId&&e.refAudios.length>0&&(e.defaultRefId=e.refAudios[0].id),e.defaultRefId&&!e.refAudios.some(t=>t.id===e.defaultRefId)&&(e.defaultRefId=e.refAudios[0]?.id||''),e.expressionRefMap=e.expressionRefMap&&'object'==typeof e.expressionRefMap?e.expressionRefMap:{})}function Ho(e){const t=Fo(e);if(t<0)return;const o=_e.value[t];Ve.value=Po([o])[0]||null,Me.value=String(o?.id||'').trim(),Jo(),function(){const e=Ve.value;if(!e)return void(Te.value=[]);const t=[],o=e.expressionRefMap&&'object'==typeof e.expressionRefMap?e.expressionRefMap:{};Object.entries(o).forEach(([e,o])=>{const n=String(e||'').trim(),r=String(o||'').trim();n&&r&&t.push({expression:n,refId:r})}),Te.value=t}(),Be.value=!0}function Xo(){Be.value=!1,Ve.value=null,Me.value='',Te.value=[]}function Ko(){const e=Ve.value;if(!e)return;Jo();const t=new Set(e.refAudios.map(e=>String(e.id||'').trim()).filter(Boolean)),o=`ref_${e.refAudios.length+1}`;let n=o,r=2;for(;t.has(n);)n=`${o}_${r++}`;e.refAudios.push({id:n,name:`参考音频${e.refAudios.length+1}`,path:'',promptText:String(e.params.promptText||'').trim(),promptLang:String(e.params.promptLang||'zh').trim()||'zh',textLang:String(e.params.textLang||'auto').trim()||'auto'}),e.defaultRefId||(e.defaultRefId=n)}function Qo(){const e=Ve.value;if(!e)return;const t=String(e.defaultRefId||e.refAudios[0]?.id||'').trim();Te.value.push({expression:'',refId:t})}function Zo(){const e=Ve.value;if(!e)return;if(!String(e.name||'').trim())return void toastr.error('模型名称不能为空');Jo(),function(){const e=Ve.value;if(!e)return;const t=new Set(e.refAudios.map(e=>String(e?.id||'').trim()).filter(Boolean)),o={};for(const e of Te.value){const n=String(e?.expression||'').trim(),r=String(e?.refId||'').trim();n&&r&&t.has(r)&&(o[n]=r)}e.expressionRefMap=o}();const t=Fo(Me.value);if(t<0)return void toastr.error('保存失败：模型不存在');const o=_e.value.slice();o[t]=Po([e])[0]||e,_e.value=Po(Ze(o)),toastr.success('模型编辑已保存到草稿（请点击保存）'),Xo()}async function en(){if(!ge.value)return;const e=String(Ce.value||'').trim()||'你好，这是一段 TTS 配音测试。',t=function(){try{const e=SillyTavern?.getContext?.();if(null!=e?.characterId)return String(e.characterId)}catch{}return'default'}();let o=String(A.value.ttsDefaultSpeaker||'').trim();if(A.value.ttsProvider===Pe.GPT_SOVITS_V2){const e=ht(),t=e.find(e=>e.name===o)||null,n=!!String(t?.gptSoVits?.refAudioPath||'').trim(),r=tt(e),a=n?t:r,i=String(a?.name||'').trim();if(!i)return void toastr.error('请先配置至少一个可用音色（refAudioPath 不能为空）');o!==i&&(A.value.ttsDefaultSpeaker=i,o=i,toastr.info(`已自动切换试听音色为：${i}`))}else if(A.value.ttsProvider===Pe.EDGE_TTS_DIRECT&&!o){const e=be.value.length>0?be.value:await vt(),t=String(e[0]?.name||e[0]?.value||'').trim();if(!t)return void toastr.error('当前无可用 EdgeTTS 音色，请先刷新音色列表');A.value.ttsDefaultSpeaker=t,o=t}try{Eo.stop(),await Eo.speak({type:'dialogue',speaker:t,text:e,tts:o?{speaker:o}:void 0},`desktop_pet_tts_test_${Date.now()}`)}catch(e){console.warn(`[${l}] TTS 试听失败:`,e)}}function tn(){try{Eo.stop()}catch{}}function on(){const e=String(Jt.value||'').split(/[\n,]/).map(e=>String(e||'').trim()).filter(Boolean),t=Array.from(new Set(e));A.value.lipSyncManualParamIds=t,Jt.value=t.join('\n')}function nn(){on(),Uo(),r('close')}return(0,s.watch)(()=>n.visible,e=>{if(!e)return void Uo();p(),i.value='api',L.value=A.value.modelPath||'',Gt.value=!1,ge.value=_t(),R.value='',W.value='',Jt.value=Array.isArray(A.value.lipSyncManualParamIds)?A.value.lipSyncManualParamIds.join('\n'):'',A.value.gptSoVits.modelSwitchMode=ze(A.value.gptSoVits.modelSwitchMode);const t=wo(A.value.gptSoVits.importPathPrefix||A.value.gptSoVits.rootDir||'');A.value.gptSoVits.rootDir=t,A.value.gptSoVits.importPathPrefix=t,A.value.gptSoVits.setModelEndpoint=String(A.value.gptSoVits.setModelEndpoint||'/set_model').trim()||'/set_model',Array.isArray(A.value.gptSoVits.models)||(A.value.gptSoVits.models=[]),Array.isArray(A.value.gptSoVits.voices)||(A.value.gptSoVits.voices=[]);try{xe.value=JSON.stringify(A.value.gptSoVits?.models||[],null,2)}catch{xe.value='[]'}try{ve.value=JSON.stringify(A.value.gptSoVits?.voices||[],null,2)}catch{ve.value='[]'}Do(),Co(),pe(),no()},{immediate:!0}),(0,s.watch)(()=>A.value.ttsProvider,()=>{try{Eo._refreshProviderState()}catch{}Co()}),(0,s.watch)(()=>A.value.useDiceDatabaseReference,e=>{e&&pe()}),(t,o)=>{return(0,s.openBlock)(),(0,s.createElementBlock)('div',null,[e.visible?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'settings-overlay dp-settings-overlay',style:Ht,onClick:(0,s.withModifiers)(nn,['self'])},[(0,s.createElementVNode)('div',{class:'settings-panel dp-settings-panel',style:Xt},[(0,s.createElementVNode)('div',{class:'panel-header'},[o[85]||(o[85]=(0,s.createElementVNode)('div',{class:'header-title'},[(0,s.createElementVNode)('h3',null,'桌面宠物控制终端'),(0,s.createElementVNode)('p',null,'SYSTEM // SETTINGS')],-1)),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:nn},'CLOSE')]),(0,s.createElementVNode)('div',$n,[(0,s.createElementVNode)('aside',Un,[((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(a,e=>(0,s.createElementVNode)('button',{key:e.key,class:(0,s.normalizeClass)(['nav-btn',{active:i.value===e.key}]),type:'button',onClick:t=>i.value=e.key},[(0,s.createElementVNode)('span',zn,(0,s.toDisplayString)(e.index),1),(0,s.createElementVNode)('span',Rn,(0,s.toDisplayString)(e.label),1),(0,s.createElementVNode)('span',Wn,(0,s.toDisplayString)(e.en),1)],10,In)),64))]),(0,s.createElementVNode)('div',Fn,[(0,s.withDirectives)((0,s.createElementVNode)('section',On,[o[99]||(o[99]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'01'),(0,s.createElementVNode)('span',{class:'section-label'},'API 设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'API CONTROL')],-1)),(0,s.createElementVNode)('div',jn,[o[87]||(o[87]=(0,s.createElementVNode)('label',null,'API 模式',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[0]||(o[0]=e=>(0,s.unref)(A).apiMode=e)},[...o[86]||(o[86]=[(0,s.createElementVNode)('option',{value:'tavern'},'酒馆主 API',-1),(0,s.createElementVNode)('option',{value:'custom'},'自定义 API',-1)])],512),[[s.vModelSelect,(0,s.unref)(A).apiMode]])]),'custom'===(0,s.unref)(A).apiMode?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:0},[(0,s.createElementVNode)('div',Gn,[o[88]||(o[88]=(0,s.createElementVNode)('label',null,'API Source',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[1]||(o[1]=e=>(0,s.unref)(A).apiConfig.source=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(N),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.value,value:e.value},(0,s.toDisplayString)(e.label),9,qn))),128))],512),[[s.vModelSelect,(0,s.unref)(A).apiConfig.source]])]),(0,s.createElementVNode)('div',Yn,[o[89]||(o[89]=(0,s.createElementVNode)('label',null,'API URL',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[2]||(o[2]=e=>(0,s.unref)(A).apiConfig.url=e),placeholder:'https://api.openai.com/v1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.url]])]),(0,s.createElementVNode)('div',Jn,[o[90]||(o[90]=(0,s.createElementVNode)('label',null,'API Key',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'password','onUpdate:modelValue':o[3]||(o[3]=e=>(0,s.unref)(A).apiConfig.apiKey=e),placeholder:'sk-...'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.apiKey]])]),(0,s.createElementVNode)('div',Hn,[o[91]||(o[91]=(0,s.createElementVNode)('label',null,'模型',-1)),(0,s.createElementVNode)('div',Xn,[0===Lt.value.length?(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)('input',{key:0,type:'text','onUpdate:modelValue':o[4]||(o[4]=e=>(0,s.unref)(A).apiConfig.model=e),placeholder:'gpt-4o-mini'},null,512)),[[s.vModelText,(0,s.unref)(A).apiConfig.model]]):(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)('select',{key:1,'onUpdate:modelValue':o[5]||(o[5]=e=>(0,s.unref)(A).apiConfig.model=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(Lt.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,Kn))),128))],512)),[[s.vModelSelect,(0,s.unref)(A).apiConfig.model]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:Zt,disabled:!(0,s.unref)(A).apiConfig.url||Dt.value},(0,s.toDisplayString)(Dt.value?'获取中...':'获取模型'),9,Qn)]),$t.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Zn,(0,s.toDisplayString)($t.value),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('div',er,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',disabled:!(0,s.unref)(A).apiConfig.url||Ut.value,onClick:eo},(0,s.toDisplayString)(Ut.value?'测试中...':'测试连接'),9,tr),'success'===It.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',or,'连接成功')):(0,s.createCommentVNode)('v-if',!0),'fail'===It.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',nr,(0,s.toDisplayString)(Wt.value),1)):(0,s.createCommentVNode)('v-if',!0)])],64)):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',rr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[6]||(o[6]=e=>(0,s.unref)(A).apiConfig.usePresetSampling=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).apiConfig.usePresetSampling]]),o[92]||(o[92]=(0,s.createTextVNode)(' 跟随酒馆预设采样参数 ',-1))]),o[93]||(o[93]=(0,s.createElementVNode)('div',{class:'hint'},'启用后，采样参数将使用酒馆当前预设的值。',-1))]),(0,s.createElementVNode)('div',ar,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[7]||(o[7]=e=>(0,s.unref)(A).apiConfig.sendWorldInfo=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).apiConfig.sendWorldInfo]]),o[94]||(o[94]=(0,s.createTextVNode)(' 发送世界书（World Info） ',-1))]),o[95]||(o[95]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后不注入世界书提示词，默认关闭。',-1))]),(0,s.unref)(A).apiConfig.usePresetSampling?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createElementVNode)('div',ir,[(0,s.createElementVNode)('div',sr,[o[96]||(o[96]=(0,s.createElementVNode)('label',null,'Max Tokens',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[8]||(o[8]=e=>(0,s.unref)(A).apiConfig.max_tokens=e),min:'1',max:'4096'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.max_tokens,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',lr,[(0,s.createElementVNode)('label',null,'Temperature ('+(0,s.toDisplayString)(v.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[9]||(o[9]=e=>(0,s.unref)(A).apiConfig.temperature=e),min:'0',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.temperature,void 0,{number:!0}]])])]),(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[10]||(o[10]=e=>jt.value=!jt.value)},[(0,s.createElementVNode)('span',cr,(0,s.toDisplayString)(jt.value?'▼':'▶'),1),o[97]||(o[97]=(0,s.createTextVNode)(' 高级采样参数 ',-1))]),jt.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',dr,[(0,s.createElementVNode)('div',Ar,[(0,s.createElementVNode)('div',ur,[(0,s.createElementVNode)('label',null,'Frequency Penalty ('+(0,s.toDisplayString)(C.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[11]||(o[11]=e=>(0,s.unref)(A).apiConfig.frequency_penalty=e),min:'-2',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.frequency_penalty,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',pr,[(0,s.createElementVNode)('label',null,'Presence Penalty ('+(0,s.toDisplayString)(S.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[12]||(o[12]=e=>(0,s.unref)(A).apiConfig.presence_penalty=e),min:'-2',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.presence_penalty,void 0,{number:!0}]])])]),(0,s.createElementVNode)('div',mr,[(0,s.createElementVNode)('div',hr,[(0,s.createElementVNode)('label',null,'Top P ('+(0,s.toDisplayString)(k.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[13]||(o[13]=e=>(0,s.unref)(A).apiConfig.top_p=e),min:'0',max:'1',step:'0.01'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.top_p,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',fr,[o[98]||(o[98]=(0,s.createElementVNode)('label',null,'Top K',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[14]||(o[14]=e=>(0,s.unref)(A).apiConfig.top_k=e),min:'0',max:'500'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.top_k,void 0,{number:!0}]])])])])):(0,s.createCommentVNode)('v-if',!0)],64))],512),[[s.vShow,'api'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',gr,[o[109]||(o[109]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'02'),(0,s.createElementVNode)('span',{class:'section-label'},'Live2D 模型'),(0,s.createElementVNode)('span',{class:'section-sub'},'MODEL CONTROL')],-1)),(0,s.createElementVNode)('div',br,[o[100]||(o[100]=(0,s.createElementVNode)('label',null,'模型路径',-1)),(0,s.createElementVNode)('div',yr,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[15]||(o[15]=e=>L.value=e),placeholder:'输入 .model.json 或 .model3.json 的完整 URL',onKeydown:(0,s.withKeys)(co,['enter'])},null,544),[[s.vModelText,L.value]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:co,disabled:!L.value.trim()},' 加载 ',8,xr)])]),(0,s.createElementVNode)('div',vr,[o[101]||(o[101]=(0,s.createElementVNode)('label',null,'推荐模型',-1)),(0,s.createElementVNode)('div',Cr,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(V),e=>((0,s.openBlock)(),(0,s.createElementBlock)('button',{key:e.path,class:(0,s.normalizeClass)(['model-btn',{active:(0,s.unref)(A).modelPath===e.path}]),type:'button',onClick:t=>{return o=e.path,A.value.modelPath=o,L.value=o,void r('model-change',o);var o}},(0,s.toDisplayString)(e.name),11,wr))),128)),(0,s.createElementVNode)('button',{class:'model-btn browse-btn',type:'button',onClick:o[16]||(o[16]=e=>P.value=!0)},'浏览在线模型库')])]),(0,s.createElementVNode)('div',Br,[o[102]||(o[102]=(0,s.createElementVNode)('label',null,'本地 ZIP 模型（单槽覆盖）',-1)),(0,s.createElementVNode)('div',Sr,[(0,s.createElementVNode)('button',{class:'model-btn',type:'button',disabled:O.value,onClick:ro},(0,s.toDisplayString)(U.value?'上传解析中...':'上传 ZIP 模型'),9,_r),(0,s.createElementVNode)('button',{class:'model-btn',type:'button',disabled:O.value||!j.value,onClick:io},' 使用已上传模型 ',8,kr),(0,s.createElementVNode)('button',{class:'model-btn',type:'button',disabled:O.value||!j.value,onClick:so},' 清除已上传模型 ',8,Er)]),(0,s.createElementVNode)('input',{ref_key:'localModelFileInput',ref:D,class:'hidden-file-input',type:'file',accept:'.zip,application/zip',onChange:ao},null,544),(0,s.createElementVNode)('div',Vr,'上传成功后会自动切换到本地路径：'+(0,s.toDisplayString)((0,s.unref)(m)),1),R.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Mr,(0,s.toDisplayString)(R.value),1)):(0,s.createCommentVNode)('v-if',!0),W.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Tr,(0,s.toDisplayString)(W.value),1)):(0,s.createCommentVNode)('v-if',!0),F.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Nr,[(0,s.createElementVNode)('div',null,'文件：'+(0,s.toDisplayString)(F.value.fileName),1),(0,s.createElementVNode)('div',null,'版本：Cubism '+(0,s.toDisplayString)(F.value.cubismVersion??'未知'),1),(0,s.createElementVNode)('div',null,'Runtime：'+(0,s.toDisplayString)((n=F.value.runtimeType,'cubism5'===String(n||'').trim().toLowerCase()?'cubism5':'legacy')),1),(0,s.createElementVNode)('div',null,'上传时间：'+(0,s.toDisplayString)(oo(F.value.uploadTime)),1),(0,s.createElementVNode)('div',null,'文件大小：'+(0,s.toDisplayString)(to(F.value.fileSize)),1)])):((0,s.openBlock)(),(0,s.createElementBlock)('div',Pr,'当前没有已上传本地模型。'))]),(0,s.createElementVNode)('div',Lr,[(0,s.createElementVNode)('label',null,'宠物缩放 ('+(0,s.toDisplayString)(E.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[17]||(o[17]=e=>(0,s.unref)(A).petScale=e),min:'0.1',max:'3',step:'0.05'},null,512),[[s.vModelText,(0,s.unref)(A).petScale,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Dr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[18]||(o[18]=e=>(0,s.unref)(A).useCdn=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useCdn]]),o[103]||(o[103]=(0,s.createTextVNode)(' 使用 CDN 加速（jsDelivr） ',-1))]),o[104]||(o[104]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后将直接从 GitHub 原始地址加载，适用于 CDN 不可用时。',-1))]),(0,s.createElementVNode)('div',$r,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[19]||(o[19]=e=>(0,s.unref)(A).doubleTapRandomMotionEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).doubleTapRandomMotionEnabled]]),o[105]||(o[105]=(0,s.createTextVNode)(' 双击随机触发动作 ',-1))]),o[106]||(o[106]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后，双击仍会触发吐槽，但不再追加随机动作。',-1))]),(0,s.createElementVNode)('div',Ur,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[20]||(o[20]=e=>(0,s.unref)(A).gazeFollowMouseEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gazeFollowMouseEnabled]]),o[107]||(o[107]=(0,s.createTextVNode)(' 视线跟随鼠标 ',-1))]),o[108]||(o[108]=(0,s.createElementVNode)('div',{class:'hint'},'全页面范围生效；仅响应鼠标/触控笔，触屏手势不会驱动视线。',-1))])],512),[[s.vShow,'live2d'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',Ir,[o[133]||(o[133]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'03'),(0,s.createElementVNode)('span',{class:'section-label'},'吐槽设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'COMMENT SYSTEM')],-1)),(0,s.createElementVNode)('div',zr,[o[110]||(o[110]=(0,s.createElementVNode)('label',null,'吐槽风格',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[21]||(o[21]=e=>(0,s.unref)(A).commentStyle=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(M),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,Rr))),128))],512),[[s.vModelSelect,(0,s.unref)(A).commentStyle]])]),'自定义'===(0,s.unref)(A).commentStyle?((0,s.openBlock)(),(0,s.createElementBlock)('div',Wr,[o[111]||(o[111]=(0,s.createElementVNode)('label',null,'自定义提示词',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':o[22]||(o[22]=e=>(0,s.unref)(A).customPrompt=e),rows:'4',placeholder:'输入自定义的系统提示词...'},null,512),[[s.vModelText,(0,s.unref)(A).customPrompt]])])):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',Fr,[o[112]||(o[112]=(0,s.createElementVNode)('label',null,'角色名（留空则关闭角色视角）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[23]||(o[23]=e=>(0,s.unref)(A).roleplayName=e),placeholder:'例如：阿米娅'},null,512),[[s.vModelText,(0,s.unref)(A).roleplayName]]),o[113]||(o[113]=(0,s.createElementVNode)('div',{class:'hint'},'填写后，吐槽和手动聊天会以该角色视角发言。',-1))]),(0,s.createElementVNode)('div',Or,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[24]||(o[24]=e=>(0,s.unref)(A).roleplayIgnoreCommentStyle=e),disabled:!(0,s.unref)(A).roleplayName.trim()},null,8,jr),[[s.vModelCheckbox,(0,s.unref)(A).roleplayIgnoreCommentStyle]]),o[114]||(o[114]=(0,s.createTextVNode)(' 角色模式下忽略吐槽风格 ',-1))]),o[115]||(o[115]=(0,s.createElementVNode)('div',{class:'hint'},'开启后将不再套用风格提示词，仅按角色设定发言。',-1))]),(0,s.createElementVNode)('div',Gr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[25]||(o[25]=e=>(0,s.unref)(A).sendCharacterCardContent=e),disabled:!(0,s.unref)(A).roleplayName.trim()},null,8,qr),[[s.vModelCheckbox,(0,s.unref)(A).sendCharacterCardContent]]),o[116]||(o[116]=(0,s.createTextVNode)(' 发送角色卡内容（当前聊天角色） ',-1))]),o[117]||(o[117]=(0,s.createElementVNode)('div',{class:'hint'},'开启后会附带当前角色卡描述/性格/场景等内容。',-1))]),(0,s.createElementVNode)('div',Yr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[26]||(o[26]=e=>(0,s.unref)(A).autoTrigger=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).autoTrigger]]),o[118]||(o[118]=(0,s.createTextVNode)(' 启用自动触发 ',-1))])]),(0,s.unref)(A).autoTrigger?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createElementVNode)('div',Jr,[o[119]||(o[119]=(0,s.createElementVNode)('label',null,'触发时机',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[27]||(o[27]=e=>(0,s.unref)(A).commentTriggerMode=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(T),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.value,value:e.value},(0,s.toDisplayString)(e.label),9,Hr))),128))],512),[[s.vModelSelect,(0,s.unref)(A).commentTriggerMode]])]),(0,s.createElementVNode)('div',Xr,[(0,s.createElementVNode)('div',Kr,[o[120]||(o[120]=(0,s.createElementVNode)('label',null,'触发间隔（每 N 条消息）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[28]||(o[28]=e=>(0,s.unref)(A).triggerInterval=e),min:'1',max:'100'},null,512),[[s.vModelText,(0,s.unref)(A).triggerInterval,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Qr,[(0,s.createElementVNode)('label',null,'触发概率（'+(0,s.toDisplayString)((0,s.unref)(A).triggerProbability)+'%）',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[29]||(o[29]=e=>(0,s.unref)(A).triggerProbability=e),min:'0',max:'100'},null,512),[[s.vModelText,(0,s.unref)(A).triggerProbability,void 0,{number:!0}]])])])],64)):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',Zr,[o[121]||(o[121]=(0,s.createElementVNode)('label',null,'传给 LLM 的最近聊天条数',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[30]||(o[30]=e=>(0,s.unref)(A).maxChatContext=e),min:'1',max:'50'},null,512),[[s.vModelText,(0,s.unref)(A).maxChatContext,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',ea,[o[122]||(o[122]=(0,s.createElementVNode)('label',null,'气泡自动关闭时间（秒）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[31]||(o[31]=e=>(0,s.unref)(A).bubbleDuration=e),min:'-1',max:'600',step:'1'},null,512),[[s.vModelText,(0,s.unref)(A).bubbleDuration,void 0,{number:!0}]]),o[123]||(o[123]=(0,s.createElementVNode)('div',{class:'hint'},'默认 -1 不自动关闭；设置为 0 表示生成完成后立即关闭。',-1))]),(0,s.createElementVNode)('div',ta,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[32]||(o[32]=e=>(0,s.unref)(A).phoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).phoneMessageAutoRead]]),o[124]||(o[124]=(0,s.createTextVNode)(' 读【毛球点心铺】手机消息 ',-1))]),o[125]||(o[125]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 NPC 文本回复；需同时启用 TTS 配音与自动播放。',-1))]),(0,s.createElementVNode)('div',oa,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[33]||(o[33]=e=>(0,s.unref)(A).baibaiPhoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).baibaiPhoneMessageAutoRead]]),o[126]||(o[126]=(0,s.createTextVNode)(' 读【柏柏小手机】手机消息 ',-1))]),o[127]||(o[127]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 NPC 文本回复；需同时启用 TTS 配音与自动播放。',-1))]),(0,s.createElementVNode)('div',na,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[34]||(o[34]=e=>(0,s.unref)(A).useTamakoTodaySpecial=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useTamakoTodaySpecial]]),o[128]||(o[128]=(0,s.createTextVNode)(' 兼容 Tamako 今日特选 ',-1))]),o[129]||(o[129]=(0,s.createElementVNode)('div',{class:'hint'},'开启后会优先读取 Tamako Market 今日特选作为上下文。',-1))]),(0,s.createElementVNode)('div',ra,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[35]||(o[35]=e=>(0,s.unref)(A).useDiceDatabaseReference=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useDiceDatabaseReference]]),o[130]||(o[130]=(0,s.createTextVNode)(' 参考数据库（建议 + 点评） ',-1))]),o[131]||(o[131]=(0,s.createElementVNode)('div',{class:'hint'},'启用后会读取骰子数据库摘要作为参考内容。',-1))]),(0,s.unref)(A).useDiceDatabaseReference?((0,s.openBlock)(),(0,s.createElementBlock)('div',aa,[o[132]||(o[132]=(0,s.createElementVNode)('label',null,'可见数据库表（勾选后才会被引用）',-1)),(0,s.createElementVNode)('div',ia,[(0,s.createElementVNode)('div',sa,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:pe,disabled:Z.value},(0,s.toDisplayString)(Z.value?'刷新中...':'刷新表列表'),9,la)]),(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:me},'全选')])]),(0,s.createElementVNode)('div',ca,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:fe},'清空筛选'),(0,s.createElementVNode)('div',da,(0,s.toDisplayString)(ue.value),1)]),Q.value.length>0?((0,s.openBlock)(),(0,s.createElementBlock)('div',Aa,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(Q.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('label',{class:'dice-sheet-item',key:e},[(0,s.createElementVNode)('input',{type:'checkbox',checked:Ae(e),onChange:t=>function(e,t){const o=t?.target,n=!!o?.checked,r=Q.value,a=ce();let i=0===a.length?[...r]:[...a];n?i.includes(e)||i.push(e):i=i.filter(t=>t!==e),r.length>0&&i.length===r.length&&(i=[]),de(i)}(e,t)},null,40,ua),(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(e),1)]))),128))])):((0,s.openBlock)(),(0,s.createElementBlock)('div',pa,'未读取到表名，可先在骰子系统中完成一次数据库更新后再刷新。'))])):(0,s.createCommentVNode)('v-if',!0)],512),[[s.vShow,'comment'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',ma,[o[152]||(o[152]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'04'),(0,s.createElementVNode)('span',{class:'section-label'},'表情设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'EMOTION COT')],-1)),(0,s.createElementVNode)('div',ha,[(0,s.createElementVNode)('div',fa,[(0,s.createElementVNode)('div',ga,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[36]||(o[36]=e=>(0,s.unref)(A).emotionCotEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).emotionCotEnabled]]),o[134]||(o[134]=(0,s.createTextVNode)(' 启用表情 COT ',-1))]),o[135]||(o[135]=(0,s.createElementVNode)('div',{class:'hint'},[(0,s.createTextVNode)(' 开启后，LLM 将按 '),(0,s.createElementVNode)('code',null,'桌面宠物[表情|语气]: 正文'),(0,s.createTextVNode)(' 输出；气泡/TTS 会自动剥离前缀并联动 Live2D。 ')],-1)),(0,s.createElementVNode)('div',ba,'表情列表：'+(0,s.toDisplayString)((0,s.unref)(Ie).join('、')),1)]),(0,s.unref)(A).emotionCotEnabled?((0,s.openBlock)(),(0,s.createElementBlock)('div',ya,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[37]||(o[37]=e=>(0,s.unref)(A).emotionCotStripFromText=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).emotionCotStripFromText]]),o[136]||(o[136]=(0,s.createTextVNode)(' 从气泡/TTS 文本中剥离前缀 ',-1))]),o[137]||(o[137]=(0,s.createElementVNode)('div',{class:'hint'},'建议保持开启，否则会朗读包含前缀的完整文本。',-1))])):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',xa,[(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:uo},'重置为默认表情配置')]),(0,s.createElementVNode)('div',va,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:fo,disabled:Oe.value},(0,s.toDisplayString)(Oe.value?'刷新中...':'刷新模型表情/动作列表'),9,Ca)])]),(0,s.createElementVNode)('div',wa,[(0,s.createElementVNode)('div',Ba,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:o[38]||(o[38]=e=>bo(!1))},' 自动匹配（填充空白覆盖） ')]),(0,s.createElementVNode)('div',Sa,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:o[39]||(o[39]=e=>bo(!0))},' 自动匹配全部（覆盖） ')])]),(0,s.createElementVNode)('div',_a,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:yo},'清空 Live2D 覆盖'),(0,s.createElementVNode)('div',ka,(0,s.toDisplayString)(it.value),1)]),(0,s.createElementVNode)('div',Ea,[(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[40]||(o[40]=e=>Gt.value=!Gt.value)},[(0,s.createElementVNode)('span',Va,(0,s.toDisplayString)(Gt.value?'▼':'▶'),1),(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(Gt.value?'隐藏高级选项':'显示高级选项'),1)]),o[138]||(o[138]=(0,s.createElementVNode)('div',{class:'hint'},'高级选项包含：别名映射、TTS 默认语气、动作启用开关。',-1))]),(0,s.createElementVNode)('div',Ma,[o[142]||(o[142]=(0,s.createElementVNode)('div',{class:'emotion-map-head'},[(0,s.createElementVNode)('div',null,'标签'),(0,s.createElementVNode)('div',null,'→'),(0,s.createElementVNode)('div',null,'Live2D 表情（Expression）'),(0,s.createElementVNode)('div',null,'Live2D 动作（Motion）'),(0,s.createElementVNode)('div',null,'预览')],-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(A).emotionConfigs,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.tag,class:'emotion-map-row'},[(0,s.createElementVNode)('div',Ta,(0,s.toDisplayString)(e.tag),1),o[141]||(o[141]=(0,s.createElementVNode)('div',{class:'emotion-map-arrow'},'→',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t=>e.live2dExpression=t},[o[139]||(o[139]=(0,s.createElementVNode)('option',{value:''},'（自动匹配）',-1)),e.live2dExpression&&!Ge.value.has(e.live2dExpression)?((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:0,value:e.live2dExpression},(0,s.toDisplayString)(e.live2dExpression)+'（自定义） ',9,Pa)):(0,s.createCommentVNode)('v-if',!0),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(je.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,La))),128))],8,Na),[[s.vModelSelect,e.live2dExpression]]),(0,s.createElementVNode)('select',{value:Qe(e),disabled:!e.live2dMotion.enabled,onChange:t=>function(e,t){const o=t?.target;ot(e,o?.value||'')}(e,t)},[o[140]||(o[140]=(0,s.createElementVNode)('option',{value:''},'（自动匹配）',-1)),Qe(e)&&!at.value.has(Qe(e))?((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:0,value:Qe(e)},(0,s.toDisplayString)(et(e))+'（自定义） ',9,$a)):(0,s.createCommentVNode)('v-if',!0),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(nt.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.key,value:e.value},(0,s.toDisplayString)(e.label),9,Ua))),128))],40,Da),(0,s.createElementVNode)('button',{class:'btn btn-secondary emotion-map-preview-btn',type:'button',title:'预览动作',onClick:t=>xo(e.tag)},' ▶ ',8,Ia)]))),128))]),o[148]||(o[148]=(0,s.createElementVNode)('div',{class:'hint'},'左列绑定 Expressions，右列绑定 Motions（可填动作名或动作组名）。',-1)),Gt.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',za,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(A).emotionConfigs,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:`advanced_${e.tag}`,class:'emotion-advanced-item'},[(0,s.createElementVNode)('div',Ra,(0,s.toDisplayString)(e.tag)+' · 高级',1),(0,s.createElementVNode)('div',Wa,[(0,s.createElementVNode)('div',Fa,[o[143]||(o[143]=(0,s.createElementVNode)('label',null,'别名（raw tag → 规范表情）',-1)),(0,s.createElementVNode)('input',{type:'text',value:(e.aliases||[]).join(', '),onBlur:t=>po(e,t),placeholder:'逗号分隔，例如：开心, smile'},null,40,Oa),o[144]||(o[144]=(0,s.createElementVNode)('div',{class:'hint'},'当模型输出不在固定表情列表时，可用别名映射到本行规范表情。',-1))]),(0,s.createElementVNode)('div',ja,[o[145]||(o[145]=(0,s.createElementVNode)('label',null,'TTS 默认语气（可选）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.ttsContext=t,placeholder:'例如：轻松调侃地说'},null,8,Ga),[[s.vModelText,e.ttsContext]]),o[146]||(o[146]=(0,s.createElementVNode)('div',{class:'hint'},'当模型未输出 |语气 时，将把此处作为 contextTexts 传给 TTS。',-1))])]),(0,s.createElementVNode)('div',qa,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.live2dMotion.enabled=t},null,8,Ya),[[s.vModelCheckbox,e.live2dMotion.enabled]]),o[147]||(o[147]=(0,s.createTextVNode)(' 启用动作（关闭后该标签仅切换表情） ',-1))])])]))),128))])):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('div',Ja,[(0,s.createElementVNode)('div',Ha,[o[149]||(o[149]=(0,s.createElementVNode)('span',{class:'emotion-preview-title'},'模型预览',-1)),(0,s.createElementVNode)('span',Xa,'标签: '+(0,s.toDisplayString)(dt.value),1)]),(0,s.createElementVNode)('div',{class:'emotion-preview-canvas',ref_key:'live2dPreviewMountEl',ref:st},[(0,s.createElementVNode)('div',{class:'emotion-preview-interact',ref_key:'live2dPreviewInteractEl',ref:lt},null,512),(0,s.unref)(go).model?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('div',Ka,'加载模型后可预览'))],512),(0,s.createElementVNode)('div',Qa,[(0,s.createElementVNode)('div',Za,[o[150]||(o[150]=(0,s.createElementVNode)('span',{class:'zoom-label'},'缩放',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{class:'zoom-slider',type:'range',min:'0.5',max:'4',step:'0.05','onUpdate:modelValue':o[41]||(o[41]=e=>ut.value=e),onInput:kt},null,544),[[s.vModelText,ut.value,void 0,{number:!0}]]),(0,s.createElementVNode)('span',ei,(0,s.toDisplayString)(Math.round(100*ut.value))+'%',1)]),(0,s.createElementVNode)('div',{class:'emotion-preview-actions'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Et},'重置视图'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Pt},'重播')]),o[151]||(o[151]=(0,s.createElementVNode)('div',{class:'hint'},'提示：拖拽预览区可移动模型，滚轮可缩放。',-1)),(0,s.createElementVNode)('div',{class:'hint',title:At.value},(0,s.toDisplayString)(At.value),9,ti)])])])],512),[[s.vShow,'expression'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',oi,[o[185]||(o[185]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'05'),(0,s.createElementVNode)('span',{class:'section-label'},'TTS 配音'),(0,s.createElementVNode)('span',{class:'section-sub'},'VOICE CONTROL')],-1)),(0,s.createElementVNode)('div',ni,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[42]||(o[42]=e=>ge.value=e),onChange:vo},null,544),[[s.vModelCheckbox,ge.value]]),o[153]||(o[153]=(0,s.createTextVNode)(' 启用 TTS 配音 ',-1))]),o[154]||(o[154]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后不会自动朗读吐槽/手动聊天结果。',-1))]),(0,s.createElementVNode)('div',ri,[o[155]||(o[155]=(0,s.createElementVNode)('label',null,'TTS 引擎',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[43]||(o[43]=e=>(0,s.unref)(A).ttsProvider=e)},[(0,s.createElementVNode)('option',{value:(0,s.unref)(Pe).LITTLEWHITEBOX},'小白X（豆包火山）',8,ai),(0,s.createElementVNode)('option',{value:(0,s.unref)(Pe).GPT_SOVITS_V2},'GPT-SoVITS v2ProPlus',8,ii),(0,s.createElementVNode)('option',{value:(0,s.unref)(Pe).EDGE_TTS_DIRECT},'EdgeTTS（必须是Edge浏览器）',8,si)],512),[[s.vModelSelect,(0,s.unref)(A).ttsProvider]])]),(0,s.createElementVNode)('div',li,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[44]||(o[44]=e=>(0,s.unref)(A).ttsAutoPlay=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).ttsAutoPlay]]),o[156]||(o[156]=(0,s.createTextVNode)(' 自动播放（吐槽完成后朗读） ',-1))])]),(0,s.createElementVNode)('div',ci,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[45]||(o[45]=e=>(0,s.unref)(A).phoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).phoneMessageAutoRead]]),o[157]||(o[157]=(0,s.createTextVNode)(' 手机消息自动朗读（仅 NPC 文本回复） ',-1))]),o[158]||(o[158]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 sender=contact 且 type=text 的手机消息。',-1))]),(0,s.createElementVNode)('div',di,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[46]||(o[46]=e=>(0,s.unref)(A).baibaiPhoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).baibaiPhoneMessageAutoRead]]),o[159]||(o[159]=(0,s.createTextVNode)(' 柏柏小手机自动朗读（仅 NPC 文本回复） ',-1))]),o[160]||(o[160]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 qq.private / qq.group 中的 NPC 文本消息。',-1))]),(0,s.createElementVNode)('div',Ai,[o[162]||(o[162]=(0,s.createElementVNode)('label',null,'默认音色',-1)),(0,s.createElementVNode)('div',ui,[(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[47]||(o[47]=e=>(0,s.unref)(A).ttsDefaultSpeaker=e)},[o[161]||(o[161]=(0,s.createElementVNode)('option',{value:''},'（不指定）',-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(be.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.name,value:e.name},(0,s.toDisplayString)(e.name)+(0,s.toDisplayString)(e.desc?' ('+e.desc+')':''),9,pi))),128))],512),[[s.vModelSelect,(0,s.unref)(A).ttsDefaultSpeaker]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:Co,disabled:ye.value},(0,s.toDisplayString)(ye.value?'刷新中...':'刷新音色'),9,mi)]),(0,s.createElementVNode)('div',hi,(0,s.toDisplayString)(Le.value),1)]),(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[48]||(o[48]=e=>qt.value=!qt.value)},[(0,s.createElementVNode)('span',fi,(0,s.toDisplayString)(qt.value?'▼':'▶'),1),o[163]||(o[163]=(0,s.createTextVNode)(' 口型同步高级兜底 ',-1))]),qt.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',gi,[(0,s.createElementVNode)('div',bi,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[49]||(o[49]=e=>(0,s.unref)(A).lipSyncManualParamsEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).lipSyncManualParamsEnabled]]),o[164]||(o[164]=(0,s.createTextVNode)(' 启用手动嘴部参数 ',-1))]),o[165]||(o[165]=(0,s.createElementVNode)('div',{class:'hint'},'自动识别失败时，使用下面参数名覆盖（如 Param58 / Param61）。',-1))]),(0,s.createElementVNode)('div',yi,[o[166]||(o[166]=(0,s.createElementVNode)('label',null,'嘴部参数 ID（逗号或换行分隔）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':o[50]||(o[50]=e=>Jt.value=e),rows:'3',placeholder:'ParamMouthOpenY\nParam58',onBlur:on},null,544),[[s.vModelText,Jt.value]]),o[167]||(o[167]=(0,s.createElementVNode)('div',{class:'hint'},'保存时会自动去重、去空白。',-1))])])):(0,s.createCommentVNode)('v-if',!0),(0,s.unref)(A).ttsProvider===(0,s.unref)(Pe).GPT_SOVITS_V2?((0,s.openBlock)(),(0,s.createElementBlock)('div',xi,[(0,s.createElementVNode)('div',vi,[o[168]||(o[168]=(0,s.createElementVNode)('label',null,'API 地址',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[51]||(o[51]=e=>(0,s.unref)(A).gptSoVits.apiUrl=e),placeholder:'http://127.0.0.1:9880'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.apiUrl]])]),(0,s.createElementVNode)('div',Ci,[(0,s.createElementVNode)('div',wi,[o[169]||(o[169]=(0,s.createElementVNode)('label',null,'GPT-SoVITS 根目录',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[52]||(o[52]=e=>(0,s.unref)(A).gptSoVits.rootDir=e),placeholder:'D:/GPT-SoVITS',onChange:So},null,544),[[s.vModelText,(0,s.unref)(A).gptSoVits.rootDir]])]),(0,s.createElementVNode)('div',Bi,[o[170]||(o[170]=(0,s.createElementVNode)('label',null,'模型总目录 / 路径前缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[53]||(o[53]=e=>(0,s.unref)(A).gptSoVits.importPathPrefix=e),placeholder:'D:/模型总目录',onChange:_o},null,544),[[s.vModelText,(0,s.unref)(A).gptSoVits.importPathPrefix]])])]),(0,s.createElementVNode)('div',Si,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[54]||(o[54]=e=>(0,s.unref)(A).gptSoVits.useCorsProxy=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gptSoVits.useCorsProxy]]),o[171]||(o[171]=(0,s.createTextVNode)(' 使用酒馆代理（/proxy） ',-1))]),o[172]||(o[172]=(0,s.createElementVNode)('div',{class:'hint'},'局域网访问建议开启；修改 config 后需重启酒馆进程。',-1))]),(0,s.createElementVNode)('div',_i,[(0,s.createElementVNode)('div',ki,[o[173]||(o[173]=(0,s.createElementVNode)('label',null,'text_lang',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[55]||(o[55]=e=>(0,s.unref)(A).gptSoVits.textLang=e),placeholder:'auto/zh/en/ja...'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.textLang]])]),(0,s.createElementVNode)('div',Ei,[o[174]||(o[174]=(0,s.createElementVNode)('label',null,'切分策略',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[56]||(o[56]=e=>(0,s.unref)(A).gptSoVits.textSplitMethod=e),placeholder:'cut5'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.textSplitMethod]])])]),(0,s.createElementVNode)('div',Vi,[(0,s.createElementVNode)('div',Mi,[o[176]||(o[176]=(0,s.createElementVNode)('label',null,'media_type',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[57]||(o[57]=e=>(0,s.unref)(A).gptSoVits.mediaType=e)},[...o[175]||(o[175]=[(0,s.createElementVNode)('option',{value:'wav'},'wav',-1),(0,s.createElementVNode)('option',{value:'ogg'},'ogg',-1),(0,s.createElementVNode)('option',{value:'raw'},'raw',-1)])],512),[[s.vModelSelect,(0,s.unref)(A).gptSoVits.mediaType]])]),(0,s.createElementVNode)('div',Ti,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[58]||(o[58]=e=>(0,s.unref)(A).gptSoVits.streamingMode=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gptSoVits.streamingMode]]),o[177]||(o[177]=(0,s.createTextVNode)(' streaming_mode ',-1))])])]),(0,s.createElementVNode)('div',Ni,[(0,s.createElementVNode)('div',Pi,[o[178]||(o[178]=(0,s.createElementVNode)('label',null,'speed_factor',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[59]||(o[59]=e=>(0,s.unref)(A).gptSoVits.speedFactor=e),min:'0.5',max:'2',step:'0.05'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.speedFactor,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Li,[o[180]||(o[180]=(0,s.createElementVNode)('label',null,'模型切换方式',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[60]||(o[60]=e=>(0,s.unref)(A).gptSoVits.modelSwitchMode=e),onChange:Bo},[...o[179]||(o[179]=[(0,s.createElementVNode)('option',{value:'set_weights'},'set_weights（api_v2.py）',-1),(0,s.createElementVNode)('option',{value:'set_model'},'set_model（api.py）',-1),(0,s.createElementVNode)('option',{value:'none'},'不自动切模型',-1)])],544),[[s.vModelSelect,(0,s.unref)(A).gptSoVits.modelSwitchMode]])])]),Ne.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Di,[o[181]||(o[181]=(0,s.createElementVNode)('label',null,'set_model endpoint',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[61]||(o[61]=e=>(0,s.unref)(A).gptSoVits.setModelEndpoint=e),placeholder:'/set_model'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.setModelEndpoint]])])):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',$i,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[62]||(o[62]=e=>(0,s.unref)(A).gptSoVits.strictWeightSwitch=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gptSoVits.strictWeightSwitch]]),o[182]||(o[182]=(0,s.createTextVNode)(' strictWeightSwitch（切权重失败时中断播放） ',-1))])]),(0,s.createElementVNode)('div',Ui,[o[183]||(o[183]=(0,s.createElementVNode)('label',null,'模型管理（v0.9）',-1)),(0,s.createElementVNode)('div',Ii,(0,s.toDisplayString)(De.value),1),(0,s.createElementVNode)('div',zi,[(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:$o},'打开模型管理器')]),(0,s.createElementVNode)('div',Ri,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Co,disabled:ye.value},(0,s.toDisplayString)(ye.value?'刷新中...':'刷新音色列表'),9,Wi)])]),(0,s.createElementVNode)('div',Fi,[(0,s.createElementVNode)('div',Oi,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:en,disabled:!ge.value},'试听',8,ji)]),(0,s.createElementVNode)('div',Gi,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[63]||(o[63]=e=>Ce.value=e),placeholder:'试听文本'},null,512),[[s.vModelText,Ce.value]])])]),o[184]||(o[184]=(0,s.createElementVNode)('div',{class:'hint'},'已移除 JSON 手填入口，导入/导出/编辑请在“模型管理器”完成。',-1))])])):((0,s.openBlock)(),(0,s.createElementBlock)('div',qi,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:en,disabled:!ge.value},'试听',8,Yi),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[64]||(o[64]=e=>Ce.value=e),placeholder:'试听文本'},null,512),[[s.vModelText,Ce.value]])])),(0,s.createElementVNode)('div',{class:'form-group'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:tn},'停止')])],512),[[s.vShow,'tts'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',Ji,[...o[186]||(o[186]=[(0,s.createStaticVNode)('<h4 data-v-216a7ce1><span class="section-index" data-v-216a7ce1>06</span><span class="section-label" data-v-216a7ce1>关于</span><span class="section-sub" data-v-216a7ce1>ABOUT &amp; LICENSE</span></h4><div class="about-card" data-v-216a7ce1><div class="about-title" data-v-216a7ce1>插件发布地址</div><a class="about-link" href="https://discord.com/channels/1134557553011998840/1472242483806077061" target="_blank" rel="noopener noreferrer" data-v-216a7ce1> https://discord.com/channels/1134557553011998840/1472242483806077061 </a></div><div class="about-card" data-v-216a7ce1><div class="about-title" data-v-216a7ce1>版权与使用声明</div><ul class="about-list" data-v-216a7ce1><li data-v-216a7ce1> 本插件加载或展示的 Live2D 模型及配套素材，其版权归原作者或原项目方所有；请在使用前自行确认并遵守对应授权条款。 </li><li data-v-216a7ce1>除权利人另有授权外，插件及示例素材仅用于学习、研究与交流，不得用于商业用途或再分发。</li><li data-v-216a7ce1> 本项目采用 <a class="about-link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank" rel="noopener noreferrer" data-v-216a7ce1> CC BY-NC-SA 4.0 </a> 共享协议。使用、改编与传播时请遵守“署名-非商业性使用-相同方式共享”，并对第三方素材单独核验授权。 </li><li data-v-216a7ce1>使用本插件及其衍生内容时，必须遵守你所在地及适用司法辖区的法律法规。</li></ul></div>',3)])],512),[[s.vShow,'about'===i.value]])])]),(0,s.createElementVNode)('div',{class:'panel-footer'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Ao},'恢复默认'),(0,s.createElementVNode)('button',{class:'btn btn-primary',type:'button',onClick:nn},'确定')])])])):(0,s.createCommentVNode)('v-if',!0),we.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:1,class:'browser-overlay dp-browser-overlay gpt-model-overlay',style:Ht,onClick:(0,s.withModifiers)(Uo,['self'])},[(0,s.createElementVNode)('div',{class:'browser-dialog dp-browser-dialog gpt-model-dialog',style:Xt},[(0,s.createElementVNode)('div',{class:'browser-dialog-header gpt-model-header'},[o[187]||(o[187]=(0,s.createElementVNode)('h3',null,'GPT-SoVITS 模型管理（v0.9）',-1)),(0,s.createElementVNode)('div',{class:'gpt-model-header-actions'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Oo},'导入JSON'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:jo},'文件夹导入'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Yo},'导出JSON'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Wo},'添加模型'),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:Uo},'X')])]),(0,s.createElementVNode)('div',Hi,[(0,s.createElementVNode)('div',Xi,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[65]||(o[65]=e=>Se.value=e),placeholder:'按模型名 / 描述 / ID 搜索'},null,512),[[s.vModelText,Se.value]]),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:zo},'仅保存'),(0,s.createElementVNode)('button',{class:'btn btn-primary',type:'button',onClick:Ro},'保存并关闭')]),(0,s.createElementVNode)('input',{ref_key:'gptModelManagerImportJsonInputRef',ref:ke,type:'file',accept:'.json,application/json',style:{display:'none'},onChange:Go},null,544),(0,s.createElementVNode)('input',{ref_key:'gptModelManagerImportFolderInputRef',ref:Ee,type:'file',webkitdirectory:'',directory:'',multiple:'',style:{display:'none'},onChange:qo},null,544),0===$e.value.length?((0,s.openBlock)(),(0,s.createElementBlock)('div',Ki,' 当前没有模型，点击“添加模型”或“导入JSON/文件夹导入”创建。 ')):((0,s.openBlock)(),(0,s.createElementBlock)('div',Qi,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)($e.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.id,class:'gpt-model-card'},[(0,s.createElementVNode)('div',Zi,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t},null,8,es),[[s.vModelCheckbox,e.enabled]]),o[188]||(o[188]=(0,s.createTextVNode)(' 启用 ',-1))]),(0,s.createElementVNode)('span',ts,(0,s.toDisplayString)(e.id),1)]),(0,s.createElementVNode)('div',os,[(0,s.createElementVNode)('div',ns,[o[189]||(o[189]=(0,s.createElementVNode)('label',null,'模型名',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.name=t,placeholder:'新模型'},null,8,rs),[[s.vModelText,e.name]])]),(0,s.createElementVNode)('div',as,[o[190]||(o[190]=(0,s.createElementVNode)('label',null,'描述',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.desc=t,placeholder:'可选描述'},null,8,is),[[s.vModelText,e.desc]])])]),(0,s.createElementVNode)('div',ss,[(0,s.createElementVNode)('div',ls,[o[191]||(o[191]=(0,s.createElementVNode)('label',null,'GPT 权重',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.paths.gptWeightsPath=t,placeholder:'GPT_weights/xxx.ckpt'},null,8,cs),[[s.vModelText,e.paths.gptWeightsPath]])]),(0,s.createElementVNode)('div',ds,[o[192]||(o[192]=(0,s.createElementVNode)('label',null,'SoVITS 权重',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.paths.sovitsWeightsPath=t,placeholder:'SoVITS_weights/xxx.pth'},null,8,As),[[s.vModelText,e.paths.sovitsWeightsPath]])])]),(0,s.createElementVNode)('div',us,[(0,s.createElementVNode)('div',ps,[o[194]||(o[194]=(0,s.createElementVNode)('label',null,'默认参考音频 ID',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t=>e.defaultRefId=t},[o[193]||(o[193]=(0,s.createElementVNode)('option',{value:''},'未设置',-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(e.refAudios,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.id,value:e.id},(0,s.toDisplayString)(e.id)+'（'+(0,s.toDisplayString)(e.name||'未命名')+'） ',9,hs))),128))],8,ms),[[s.vModelSelect,e.defaultRefId]])]),(0,s.createElementVNode)('div',fs,[o[195]||(o[195]=(0,s.createElementVNode)('label',null,'默认参考音频路径',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.paths.defaultRefAudioPath=t,placeholder:'wavs/xxx.wav'},null,8,gs),[[s.vModelText,e.paths.defaultRefAudioPath]])])]),(0,s.createElementVNode)('div',bs,' 参考音频 '+(0,s.toDisplayString)(e.refAudios.length)+' 条，表情映射 '+(0,s.toDisplayString)(Object.keys(e.expressionRefMap||{}).length)+' 条 ',1),(0,s.createElementVNode)('div',ys,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:t=>Ho(e.id)},' 编辑参考音频/映射 ',8,xs),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:t=>function(e){const t=String(e?.name||'').trim();t?(A.value.ttsDefaultSpeaker=t,toastr.success(`已设默认音色：${t}`)):toastr.error('请先填写模型名称')}(e)},' 设为默认音色 ',8,vs),(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:t=>async function(e){const t=Fo(e);if(t<0)return;const o=_e.value[t],n=String(o?.name||'').trim();n?(A.value.ttsDefaultSpeaker=n,await Io(''),await en()):toastr.error('模型名称为空，无法试听')}(e.id)},' 保存并试听 ',8,Cs),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:t=>function(e){const t=Fo(e);if(t<0)return;const o=_e.value[t],n=Po([o])[0]||Lo();n.id=`${String(o?.id||'model').trim()||'model'}_${Date.now().toString(36)}`;const r=No(_e.value,[n]);_e.value=Po(Ze(r)),toastr.success('模型已复制')}(e.id)},'复制',8,ws),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:t=>function(e){const t=Fo(e);t<0||(_e.value.splice(t,1),Me.value===e&&Xo())}(e.id)},'删除',8,Bs)])]))),128))]))]),(0,s.createElementVNode)('div',{class:'panel-footer'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Uo},'取消'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:zo},'仅保存'),(0,s.createElementVNode)('button',{class:'btn btn-primary',type:'button',onClick:Ro},'保存并关闭')])])])):(0,s.createCommentVNode)('v-if',!0),Be.value&&Ve.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:2,class:'browser-overlay dp-browser-overlay gpt-model-overlay',style:Ht,onClick:(0,s.withModifiers)(Xo,['self'])},[(0,s.createElementVNode)('div',{class:'browser-dialog dp-browser-dialog gpt-model-editor-dialog',style:Xt},[(0,s.createElementVNode)('div',Ss,[(0,s.createElementVNode)('h3',null,'编辑模型：'+(0,s.toDisplayString)(Ve.value.name||Ve.value.id),1),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:Xo},'X')]),(0,s.createElementVNode)('div',_s,[(0,s.createElementVNode)('div',ks,[(0,s.createElementVNode)('div',Es,[o[196]||(o[196]=(0,s.createElementVNode)('label',null,'ID（保存后会自动规范化）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[66]||(o[66]=e=>Ve.value.id=e),placeholder:'model_xxx'},null,512),[[s.vModelText,Ve.value.id]])]),(0,s.createElementVNode)('div',Vs,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[67]||(o[67]=e=>Ve.value.enabled=e)},null,512),[[s.vModelCheckbox,Ve.value.enabled]]),o[197]||(o[197]=(0,s.createTextVNode)(' 启用该模型 ',-1))])])]),(0,s.createElementVNode)('div',Ms,[(0,s.createElementVNode)('div',Ts,[o[198]||(o[198]=(0,s.createElementVNode)('label',null,'模型名称',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[68]||(o[68]=e=>Ve.value.name=e),placeholder:'新模型'},null,512),[[s.vModelText,Ve.value.name]])]),(0,s.createElementVNode)('div',Ns,[o[199]||(o[199]=(0,s.createElementVNode)('label',null,'描述',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[69]||(o[69]=e=>Ve.value.desc=e),placeholder:'可选描述'},null,512),[[s.vModelText,Ve.value.desc]])])]),(0,s.createElementVNode)('div',Ps,[(0,s.createElementVNode)('div',Ls,[o[200]||(o[200]=(0,s.createElementVNode)('label',null,'GPT 权重路径',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[70]||(o[70]=e=>Ve.value.paths.gptWeightsPath=e),placeholder:'GPT_weights/xxx.ckpt'},null,512),[[s.vModelText,Ve.value.paths.gptWeightsPath]])]),(0,s.createElementVNode)('div',Ds,[o[201]||(o[201]=(0,s.createElementVNode)('label',null,'SoVITS 权重路径',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[71]||(o[71]=e=>Ve.value.paths.sovitsWeightsPath=e),placeholder:'SoVITS_weights/xxx.pth'},null,512),[[s.vModelText,Ve.value.paths.sovitsWeightsPath]])])]),(0,s.createElementVNode)('div',$s,[(0,s.createElementVNode)('div',Us,[o[202]||(o[202]=(0,s.createElementVNode)('label',null,'prompt_text（默认）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[72]||(o[72]=e=>Ve.value.params.promptText=e),placeholder:'参考文本'},null,512),[[s.vModelText,Ve.value.params.promptText]])]),(0,s.createElementVNode)('div',Is,[o[203]||(o[203]=(0,s.createElementVNode)('label',null,'prompt_lang（默认）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[73]||(o[73]=e=>Ve.value.params.promptLang=e),placeholder:'zh'},null,512),[[s.vModelText,Ve.value.params.promptLang]])])]),(0,s.createElementVNode)('div',zs,[(0,s.createElementVNode)('div',Rs,[o[204]||(o[204]=(0,s.createElementVNode)('label',null,'text_lang（默认）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[74]||(o[74]=e=>Ve.value.params.textLang=e),placeholder:'auto/zh/en/ja...'},null,512),[[s.vModelText,Ve.value.params.textLang]])]),(0,s.createElementVNode)('div',Ws,[o[205]||(o[205]=(0,s.createElementVNode)('label',null,'切分策略',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[75]||(o[75]=e=>Ve.value.params.textSplitMethod=e),placeholder:'cut5'},null,512),[[s.vModelText,Ve.value.params.textSplitMethod]])])]),(0,s.createElementVNode)('div',Fs,[(0,s.createElementVNode)('div',Os,[o[206]||(o[206]=(0,s.createElementVNode)('label',null,'speed_factor',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[76]||(o[76]=e=>Ve.value.params.speedFactor=e),min:'0.5',max:'2',step:'0.05'},null,512),[[s.vModelText,Ve.value.params.speedFactor,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',js,[o[208]||(o[208]=(0,s.createElementVNode)('label',null,'media_type',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[77]||(o[77]=e=>Ve.value.params.mediaType=e)},[...o[207]||(o[207]=[(0,s.createElementVNode)('option',{value:'wav'},'wav',-1),(0,s.createElementVNode)('option',{value:'ogg'},'ogg',-1),(0,s.createElementVNode)('option',{value:'raw'},'raw',-1)])],512),[[s.vModelSelect,Ve.value.params.mediaType]])])]),(0,s.createElementVNode)('div',Gs,[(0,s.createElementVNode)('div',qs,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[78]||(o[78]=e=>Ve.value.params.streamingMode=e)},null,512),[[s.vModelCheckbox,Ve.value.params.streamingMode]]),o[209]||(o[209]=(0,s.createTextVNode)(' streaming_mode ',-1))])]),(0,s.createElementVNode)('div',Ys,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[79]||(o[79]=e=>Ve.value.params.strictWeightSwitch=e)},null,512),[[s.vModelCheckbox,Ve.value.params.strictWeightSwitch]]),o[210]||(o[210]=(0,s.createTextVNode)(' strictWeightSwitch ',-1))])])]),(0,s.createElementVNode)('div',Js,[(0,s.createElementVNode)('div',Hs,[o[212]||(o[212]=(0,s.createElementVNode)('label',null,'切换模式',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[80]||(o[80]=e=>Ve.value.params.modelSwitchMode=e)},[...o[211]||(o[211]=[(0,s.createElementVNode)('option',{value:'set_weights'},'set_weights',-1),(0,s.createElementVNode)('option',{value:'set_model'},'set_model',-1),(0,s.createElementVNode)('option',{value:'none'},'none',-1)])],512),[[s.vModelSelect,Ve.value.params.modelSwitchMode]])]),(0,s.createElementVNode)('div',Xs,[o[213]||(o[213]=(0,s.createElementVNode)('label',null,'set_model endpoint',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[81]||(o[81]=e=>Ve.value.params.setModelEndpoint=e),placeholder:'/set_model'},null,512),[[s.vModelText,Ve.value.params.setModelEndpoint]])])]),(0,s.createElementVNode)('div',Ks,[o[220]||(o[220]=(0,s.createElementVNode)('label',null,'参考音频列表',-1)),(0,s.createElementVNode)('div',Qs,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(Ve.value.refAudios,(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:`${e.id||'ref'}_${t}`,class:'gpt-ref-item'},[(0,s.createElementVNode)('div',Zs,[(0,s.createElementVNode)('div',el,[o[214]||(o[214]=(0,s.createElementVNode)('label',null,'参考ID',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.id=t,placeholder:'ref_1'},null,8,tl),[[s.vModelText,e.id]])]),(0,s.createElementVNode)('div',ol,[o[215]||(o[215]=(0,s.createElementVNode)('label',null,'名称',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.name=t,placeholder:'默认'},null,8,nl),[[s.vModelText,e.name]])])]),(0,s.createElementVNode)('div',rl,[o[216]||(o[216]=(0,s.createElementVNode)('label',null,'音频路径',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.path=t,placeholder:'wavs/xxx.wav'},null,8,al),[[s.vModelText,e.path]])]),(0,s.createElementVNode)('div',il,[(0,s.createElementVNode)('div',sl,[o[217]||(o[217]=(0,s.createElementVNode)('label',null,'prompt_text',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.promptText=t,placeholder:'参考文本'},null,8,ll),[[s.vModelText,e.promptText]])]),(0,s.createElementVNode)('div',cl,[o[218]||(o[218]=(0,s.createElementVNode)('label',null,'prompt_lang',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.promptLang=t,placeholder:'zh'},null,8,dl),[[s.vModelText,e.promptLang]])])]),(0,s.createElementVNode)('div',Al,[(0,s.createElementVNode)('div',ul,[o[219]||(o[219]=(0,s.createElementVNode)('label',null,'text_lang',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.textLang=t,placeholder:'zh'},null,8,pl),[[s.vModelText,e.textLang]])]),(0,s.createElementVNode)('div',ml,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:t=>function(e){const t=Ve.value;if(!t)return;const o=String(e||'').trim();o&&(t.defaultRefId=o)}(e.id)},' 设为默认参考 ',8,hl),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:e=>function(e){const t=Ve.value;if(!t)return;if(e<0||e>=t.refAudios.length)return;const o=String(t.refAudios[e]?.id||'').trim();t.refAudios.splice(e,1),o&&t.defaultRefId===o&&(t.defaultRefId=t.refAudios[0]?.id||''),o&&(Te.value=Te.value.filter(e=>e.refId!==o))}(t)},' 删除 ',8,fl)])])]))),128))]),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Ko},'添加参考音频')]),(0,s.createElementVNode)('div',gl,[o[222]||(o[222]=(0,s.createElementVNode)('label',null,'表情映射（表情标签 -> 参考ID）',-1)),(0,s.createElementVNode)('div',bl,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(Te.value,(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:`expr_map_${t}`,class:'gpt-expression-map-row'},[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.expression=t,placeholder:'开心'},null,8,yl),[[s.vModelText,e.expression]]),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t=>e.refId=t},[o[221]||(o[221]=(0,s.createElementVNode)('option',{value:''},'请选择参考音频',-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(Ve.value.refAudios,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.id,value:e.id},(0,s.toDisplayString)(e.id)+'（'+(0,s.toDisplayString)(e.name||'未命名')+'） ',9,vl))),128))],8,xl),[[s.vModelSelect,e.refId]]),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:e=>{var o;(o=t)<0||o>=Te.value.length||Te.value.splice(o,1)}},' 删除 ',8,Cl)]))),128))]),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Qo},'添加映射')])]),(0,s.createElementVNode)('div',{class:'panel-footer'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Xo},'取消'),(0,s.createElementVNode)('button',{class:'btn btn-primary',type:'button',onClick:Zo},'保存当前模型')])])])):(0,s.createCommentVNode)('v-if',!0),P.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:3,class:'browser-overlay dp-browser-overlay',style:Ht,onClick:o[84]||(o[84]=(0,s.withModifiers)(e=>P.value=!1,['self']))},[(0,s.createElementVNode)('div',{class:'browser-dialog dp-browser-dialog',style:Xt},[(0,s.createElementVNode)('div',wl,[o[223]||(o[223]=(0,s.createElementVNode)('h3',null,'在线模型库',-1)),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:o[82]||(o[82]=e=>P.value=!1)},'X')]),(0,s.createElementVNode)('div',Bl,[(0,s.createVNode)(Ln,{'use-cdn':(0,s.unref)(A).useCdn,onCancel:o[83]||(o[83]=e=>P.value=!1),onLoadModel:lo},null,8,['use-cdn'])])])])):(0,s.createCommentVNode)('v-if',!0)]);var n}}});i(409);const _l=(0,Ho.A)(Sl,[['__scopeId','data-v-216a7ce1']]),kl={class:'browser-dialog'},El={class:'browser-dialog-header'},Vl={class:'browser-dialog-body'},Ml='__desktopPetOpenSettings_v2',Tl=(0,s.defineComponent)({__name:'PetContainer',setup(e){const t=he(),{settings:n}=o(t),r=jo(),{showSettings:a}=o(r),i=(0,s.ref)(''),l=(0,s.ref)(!0);let c=null,d=0,A=null,p=null,m=null,h=null,f=null,g=!1,b=null,y=null,x=null,v=null;const C=(0,s.ref)(!1),w=(0,s.ref)({x:0,y:0}),S=(0,s.ref)('left'),k=(0,s.ref)(!1);let E=!1,V=null,M=null,T=0;const N=new Set,P=[],L=[];let D=!1,U=!1,I=null;const R=[],W=new Set,F=[];function O(){try{return window.parent??window}catch{return window}}function j(){try{const e=SillyTavern?.getContext?.();if(null!=e?.characterId)return String(e.characterId)}catch{}return'default'}function G(){try{const e=O(),t=e?.extension_settings?.acsusPawsPuffs?.phone;if(t&&'object'==typeof t)return t}catch{}try{const e=window,t=e?.extension_settings?.acsusPawsPuffs?.phone;if(t&&'object'==typeof t)return t}catch{}return null}function q(e,t){const o=String(t||'').trim(),n=o.replace(/^chat_/,'').replace(/^tavern_/,'').trim()||'联系人';if('baibai'===e)return n;const r=G(),a=(Array.isArray(r?.contacts)?r.contacts:[]).find(e=>String(e?.id||'').trim()===o);return String(a?.name||'').trim()||n}function Y(e){const t=String(e?.sender||'').trim().toLowerCase(),o=String(e?.type||'text').trim().toLowerCase();return'contact'===t&&'text'===o}function J(e){return String(e??'').replace(/\s+/g,' ').trim()}function H(e){return'baibai'===e?!0===n.value.baibaiPhoneMessageAutoRead:!1!==n.value.phoneMessageAutoRead}function X(e){const t=J(e).toLowerCase();return!!t&&function(){const e=new Set,t=t=>{const o=J(t).toLowerCase();o&&e.add(o)};try{t(SillyTavern?.name1)}catch{}try{const e=SillyTavern?.getContext?.();t(e?.name1),t(e?.userName)}catch{}return t('user'),e}().has(t)}function K(e){const t=String(e||'').trim();if(!t)return[];const o=[],n=/'([^']*)'|"([^"]*)"/g;for(const e of t.matchAll(n)){const t=J(e[1]??e[2]??'');o.push(t)}return o.length>0?o:t.split(',').map(e=>J(e)).filter(e=>!!e)}function Q(e){const t=String(e??'');if(!t)return[];const o=t.match(/\[(.+?)-(.+?)\]/);if(!o){const e=J(t);return e?[e]:[]}const n=J(o[1]).toLowerCase();if('bqb'===n||'img'===n){const e=J(t.replace(o[0],''));return e?[e]:[]}return[]}function Z(e){switch(String(e?.type||'text').trim().toLowerCase()){case'text':{let t=J(e.content);return t=t.replace(/^\[约定计划(?:已完成|过程|内心印象|过程记录)?\]/,'').trim(),t}case'quote':return J(e.replyContent||e.content||'引用消息');case'emoji':return J(`表情 ${e.content||'消息'}`);case'image':case'image-real':case'image-fake':{const t=J(e.description||e.content||'');return t?`图片，${t}`:'图片消息'}case'redpacket':return`红包 ${J(e.amount||0)} 元`;case'transfer':{const t=J(e.amount||0),o=J(e.message||e.content||'');return o?`转账 ${t} 元，留言 ${o}`:`转账 ${t} 元`}case'video':return J(`视频 ${e.description||''}`)||'视频消息';case'file':return J(`文件 ${e.filename||''}`)||'文件消息';case'poke':return'戳了戳你';case'recalled':case'recalled-pending':return'撤回了一条消息';case'friend_request':case'friend_added':case'friend_deleted':return J(e.content||'');case'gift-membership':case'buy-membership':{const t=J(e.months||'');return J(`赠送${t?`${t}个月`:''}${String(e.membershipType||'').toUpperCase()||'会员'}`)}default:return J(e.content||e.description||'')}}function ee(e,t,o){const n=String(t||'').trim(),r=J(o?.id);if(r)return`${e}:${n}:${r}`;return`${e}:${n}:${J(o?.sender).toLowerCase()||'unknown'}:${J(o?.type).toLowerCase()||'text'}:${Number(o?.time||0)}:${J(o?.content||o?.replyContent||o?.description||o?.filename||'').slice(0,72)}`}function te(e){if(!e||N.has(e))return;if(N.add(e),P.push(e),P.length<=4e3)return;const t=P.shift();t&&N.delete(t)}function oe(e,t){const o=function(e){try{const t=O(),o=t?.SillyTavern?.eventTypes?.[e];if(o)return String(o)}catch{}try{const t=tavern_events?.[e];if(t)return String(t)}catch{}return null}(e);if(!o)return null;try{const e=O(),n=e?.SillyTavern?.eventSource;if(n&&'function'==typeof n.on)return n.on(o,t),{stop:()=>{try{'function'==typeof n.off?n.off(o,t):'function'==typeof n.removeListener&&n.removeListener(o,t)}catch{}}}}catch{}return'function'==typeof eventOn?eventOn(o,t):null}function ne(){W.clear(),F.length=0}function re(e){if(!Number.isFinite(e))return;if(W.has(e))return;if(W.add(e),F.push(e),F.length<=2e3)return;const t=F.shift();'number'==typeof t&&W.delete(t)}function ae(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'assistant',hide_state:'unhidden'});return Array.isArray(e)?e:[]}catch{return[]}}function se(e){const t=(o=e?.message,String(o??'').replace(/<think[ing]*?>[\s\S]*?<\/think[ing]*?>/gi,'').replace(/<!--[\s\S]*?-->/g,'').trim());var o;if(!t||!function(e){return/\bqq\.(?:private|group)\s*\(/i.test(String(e??''))}(t))return[];const n=Number(e?.message_id),r=[],a=t.matchAll(/([a-zA-Z]+\.[a-zA-Z]+)\(([\s\S]*?)\);/g);let i=0;for(const e of a){i++;const t=String(e[1]||'').trim().toLowerCase();if('qq.private'!==t&&'qq.group'!==t)continue;const o=K(String(e[2]||''));if(o.length<4)continue;const a=J(o[0])||'柏柏会话',s=J(o[1]);if(!s||X(s))continue;const l=Q(o[2]);if(0===l.length)continue;const c=J(o[3]),d=Number.isFinite(n)?String(n):'unknown';l.forEach((e,t)=>{const o=J(e);o&&r.push({contactId:a,message:{id:`baibai_${d}_${i}_${t}`,sender:'contact',type:'text',content:o,time:c||d}})})}return r}function le(){const e=ae();for(const t of e){const e=Number(t?.message_id);!Number.isFinite(e)||e<0||re(e)}}function de(){const e=ae();if(0!==e.length)for(const t of e){const e=Number(t?.message_id);if(!Number.isFinite(e)||e<0)continue;if(W.has(e))continue;re(e);const o=se(t);for(const e of o)pe(e.contactId,e.message,'baibai')}}async function ue(e=45e3){const t=Date.now();for(;Eo.isLoading||Eo.isPlaying;){if(Date.now()-t>e)return void Eo.stop();await new Promise(e=>{window.setTimeout(e,120)})}}function pe(e,t,o='acsus'){if(!t)return;if(!Y(t))return;const r=ee(o,e,t);if(N.has(r))return;te(r);const a=Number(t.time||0);'acsus'===o&&Number.isFinite(a)&&a>0&&T>0&&a+2<T||H(o)&&(L.push({source:o,contactId:e,message:t}),async function(){if(!D){D=!0;try{for(;L.length>0;){const e=L.shift();if(!e)continue;const t=_t(),o=!!n.value.ttsAutoPlay,r=H(e.source);if(!t||!o||!r)continue;const a=Z(e.message);if(!a)continue;const i=q(e.source,e.contactId),s=j(),l=String(n.value.ttsDefaultSpeaker||'').trim(),c={};l&&(c.speaker=l);const d='baibai'===e.source?'柏柏小手机':'毛球点心铺手机';c.context=`${d}·${i}`,await ue(45e3),await Eo.speak({type:'dialogue',speaker:s,text:a,tts:c},`desktop_pet_phone_${e.source}_${e.contactId}_${Date.now()}`)}}catch(e){Ae('手机消息自动朗读失败',e)}finally{D=!1}}}())}function me(e){const t=function(e){const t=G(),o=`chat_${String(e||'').trim()}`,n=t?.chats?.[o];return Array.isArray(n)?n:[]}(e);if(0===t.length)return;const o=[];for(let n=t.length-1;n>=0;n--){const r=t[n];if(!Y(r))continue;const a=ee('acsus',e,r);if(N.has(a))break;o.push(r)}o.reverse().forEach(t=>{pe(e,t)})}function fe(){if(E)return;T=Math.floor(Date.now()/1e3),function(){const e=G(),t=e?.chats;if(t&&'object'==typeof t)for(const[e,o]of Object.entries(t)){if(!Array.isArray(o))continue;const t=String(e||'').replace(/^chat_/,'').trim();if(t)for(const e of o){const o=e;Y(o)&&te(ee('acsus',t,o))}}}();const e=O().document??document;V=e=>{const t=e.detail||{},o=String(t.contactId||'').trim();o&&pe(o,t.message)},M=e=>{const t=e.detail||{},o=String(t.contactId||'').trim();o&&me(o)},e.addEventListener('phone-message-received',V),e.addEventListener('phone-ai-generation-complete',M),E=!0,ce('手机消息 TTS 桥接已启用')}function ge(){if(!E)return;const e=O().document??document;V&&e.removeEventListener('phone-message-received',V),M&&e.removeEventListener('phone-ai-generation-complete',M),V=null,M=null,L.length=0,D=!1,E=!1}function be(){U&&(R.forEach(e=>{e.stop()}),R.length=0,null!==I&&(window.clearInterval(I),I=null),ne(),U=!1)}function ye(){const e=!n.value.autoMotionLoop;n.value.autoMotionLoop=e,go.setAutoMotionLoopEnabled(e)}function xe(){const e=['毒舌吐槽','可爱卖萌','冷静分析','傲娇'],t=n.value.commentStyle,o=e.indexOf(t),r=e[(o>=0?o+1:0)%e.length];n.value.commentStyle=r;try{toastr.info(`已切换人设：${r}`)}catch{}}function ve(){C.value=!1,k.value=!0}function Ce(e){n.value.modelPath=e,k.value=!1,ze(e)}function we(e){zo.chat(e)}function Be(){C.value=!1,k.value=!1,r.closeSettings(),Re(),Te(!0),ge(),be(),Vo.destroy(),zo.destroy(),go.destroyModel(),Yt.destroy();try{toastr.info('桌面宠物已关闭')}catch{}}function Se(e){const t=_e(e);return{width:Math.max(1,Math.round(280*t)),height:Math.max(1,Math.round(360*t))}}function _e(e){const t='number'==typeof e?e:Number(e);return Number.isFinite(t)?Math.max(.1,Math.min(3,t)):B}function ke(){null!==A&&(window.clearTimeout(A),A=null)}function Ee(){null!==p&&(window.clearTimeout(p),p=null)}function Ve(){null!==m&&(window.clearTimeout(m),m=null)}function Me(){if(g)return;const e=O().document??document,t=e=>{var t;'mouse'!==(t=e.pointerType)&&'pen'!==t||function(e,t){if(!Number.isFinite(e)||!Number.isFinite(t))return;if(v={x:e,y:t},null!==x)return;const o=O();x=o.requestAnimationFrame(()=>{x=null;const e=v;v=null,e&&!1!==n.value.gazeFollowMouseEnabled&&(Yt.isPreviewMounted()||go.focusByClientPoint(e.x,e.y,!1))})}(e.clientX,e.clientY)};b=t,y=t,e.addEventListener('pointermove',b,{passive:!0}),e.addEventListener('pointerdown',y,{passive:!0}),g=!0}function Te(e=!0){!function(){if(null===x)return;const e=O();try{e.cancelAnimationFrame(x)}catch{}x=null}(),v=null;const t=O().document??document;b&&t.removeEventListener('pointermove',b),y&&t.removeEventListener('pointerdown',y),b=null,y=null,g=!1,e&&go.focusCenter(!0)}function Ne(){!1!==n.value.gazeFollowMouseEnabled?Me():Te(!0)}function Pe(e){Ve(),m=window.setTimeout(()=>{m=null,function(e){if(Yt.isPreviewMounted())return;const t=Se(n.value.petScale),o=e=>{Yt.resizeFloating(t.width,t.height);const o=O().document.getElementById('desktop-pet-stage');o&&(o.style.display='block',o.style.visibility='visible',o.style.opacity='1',o.style.zIndex='10000');const n=Yt.getStage();if(n&&n.children.length>0)return go.updateScale(t.width,t.height,1),void ce(`Viewport resize recovery synced model (${e})`);go.mountToStage(t.width,t.height,1),ce(`Viewport resize recovery remounted model (${e})`)};o(`${e}-pass1`),window.setTimeout(()=>{Yt.isPreviewMounted()||o(`${e}-pass2`)},220),Ue(`${e}-recover`)}(e)},160)}function Le(e){const t=Math.max(0,Math.min(100,Math.round(e.percent)));Yt.showLoadingProgress(t,e.message)}function De(e,t){Ae(e,t);try{toastr.error(e)}catch{}}async function $e(e){const t=++d;ke(),Le({percent:0,message:'准备加载模型'});const o=await go.loadModel(e,e=>{t===d&&Le(e)});return t!==d||(Le({percent:100,message:o?'模型加载完成':'模型加载失败'}),A=window.setTimeout(()=>{t===d&&(Yt.hideLoadingProgress(),A=null)},o?400:15e3)),o}function Ue(e){Ee(),p=window.setTimeout(()=>{try{const t=window.parent??window,o=t.document.getElementById('desktop-pet-stage'),n=o?.getBoundingClientRect?.(),r=n?`${Math.round(n.left)},${Math.round(n.top)} ${Math.round(n.width)}x${Math.round(n.height)}`:'none',a=String(t.PIXI?.VERSION||'').trim()||'none',i=!!t.PIXI?.live2d?.Live2DModel,s=!!go.model,l=Yt.getStage()?.children?.length??0,c=!!n&&n.width>10&&n.height>10&&n.bottom>0&&n.right>0&&n.top<(t.innerHeight||0)&&n.left<(t.innerWidth||0);if(c&&i&&s&&l>0)return void(p=null);if(o){const e=o.style.outline,t=o.style.background,n=o.style.zIndex;o.style.outline='2px dashed rgba(245, 158, 11, 0.95)',o.style.background='rgba(245, 158, 11, 0.08)',o.style.zIndex='2147483647',window.setTimeout(()=>{o?.ownerDocument?.documentElement?.contains(o)&&(o.style.outline=e,o.style.background=t,o.style.zIndex=n)},1e4)}const d=`桌面宠物未显示(${e}) stage=${!!o} rect=${r} visible=${c} pixi=${a} live2d=${i} model=${s} children=${l}`;try{toastr.warning(d)}catch{}}catch(e){De('桌面宠物状态检查失败',e)}finally{p=null}},2500)}async function Ie(){try{ce('桌面宠物初始化开始');const e=n.value;try{!function({getProxiedAudioUrl:e}){e&&(bo=e)}({getProxiedAudioUrl:e=>Eo._getProxiedAudioUrl(e)}),Eo.init()}catch(e){Ae('TTS 模块初始化失败（不影响模型显示）',e)}fe(),function(){if(U)return;ne(),le();const e=()=>{de()};['GENERATION_ENDED','MESSAGE_UPDATED','MESSAGE_SWIPED'].forEach(t=>{const o=oe(t,e);o&&R.push(o)});const t=oe('CHAT_CHANGED',()=>{ne(),le()});t&&R.push(t),0===R.length&&(I=window.setInterval(()=>{de()},1200)),U=!0,ce('柏柏小手机 TTS 桥接已启用')}(),zo.setCallback((e,t)=>{const o=Oo(e,{enabled:!!n.value.emotionCotEnabled,stripFromText:!1!==n.value.emotionCotStripFromText,configs:n.value.emotionConfigs});if(i.value=o.cleanText,l.value=t,!t)return;const r=String(o.cleanText||'').trim();if(!r)return;if(o.normalizedTag){(function(e){try{const t=go.model;if(!t)return!1;let o=!1;const r=ie(e,n.value.emotionConfigs),a=mo(t,e,r?.live2dExpression);a&&(go.playExpression(a),o=!0);const i=ho(t,e,r?.live2dMotion);return i&&(go.playMotion(i.group,i.index),o=!0),o}catch(e){return Ae('表情联动播放失败',e),!1}})(o.normalizedTag)||go.playRandomAnimation()}else go.playRandomAnimation();const a=_t(),s=!!n.value.ttsAutoPlay;if(ce(`生成完成，TTS检查: enabled=${a}, autoPlay=${s}, tag=${o.normalizedTag||'(none)'}, textLen=${r.length}`),!a)return;if(!s)return;const c=j(),d=String(n.value.ttsDefaultSpeaker||'').trim();let A=String(o.context||'').trim();if(!A&&o.normalizedTag){const e=ie(o.normalizedTag,n.value.emotionConfigs);A=String(e?.ttsContext||'').trim()}ce(`自动朗读: speaker=${c}, voice=${d||'默认'}, context=${A||'无'}`),(async()=>{try{Eo.stop();const e={};d&&(e.speaker=d),A&&(e.context=A),await Eo.speak({type:'dialogue',speaker:c,text:r,tts:Object.keys(e).length>0?e:void 0},`desktop_pet_comment_${Date.now()}`)}catch(e){Ae('自动朗读失败',e)}})()});if(!await go.init())return void De('Live2D SDK 初始化失败（可能是网络 CDN 不可用）');ce('Live2D SDK 初始化完成'),go.setAutoMotionLoopEnabled(e.autoMotionLoop);const t=_e(e.petScale);t!==e.petScale&&(n.value.petScale=t);const o=Se(t);if(!Yt.create({width:o.width,height:o.height,position:{x:e.petPosition.x,y:e.petPosition.y},scale:t,onPositionChange:(e,t)=>{n.value.petPosition={x:e,y:t}},onScaleChange:e=>{const t=_e(e);t!==n.value.petScale&&(n.value.petScale=t)},onTap:e=>{ce('单击宠物 -> 播放动作（不触发 LLM）'),go.playRandomAnimation()},onDoubleTap:e=>{const t=!1!==n.value.doubleTapRandomMotionEnabled;ce(t?'双击宠物 -> 触发吐槽 + 随机动作':'双击宠物 -> 触发吐槽'),Vo.manualTrigger(),t&&go.playRandomAnimation()},onLongPress:e=>{ce('长按宠物 -> 打开功能菜单'),function(e){try{navigator.vibrate&&navigator.vibrate(50)}catch{}const t=O();let o='right',n=e.clientX,r=e.clientY;try{const a=t.document.getElementById('desktop-pet-stage'),i=a?.getBoundingClientRect?.(),s=t.innerWidth||t.document.documentElement.clientWidth||0;i&&s>0?(o=i.left>s/2?'left':'right',n='left'===o?i.left-10:i.right+10,r=i.top+.5*i.height):s>0&&(o=e.clientX>s/2?'left':'right')}catch{}S.value=o,w.value={x:n,y:r},C.value=!0}(e)}}))return void De('Live2D 舞台创建失败（可能是 WebGL 不可用）');ce('Live2D 舞台创建完成');await $e(e.modelPath)?(go.mountToStage(o.width,o.height,1),ce('Live2D 模型挂载完成')):De('Live2D 模型加载失败（可在设置里更换模型或关闭 CDN）'),Vo.init({autoTrigger:e.autoTrigger,triggerInterval:e.triggerInterval,triggerProbability:e.triggerProbability,commentTriggerMode:e.commentTriggerMode},()=>{zo.generate()}),ce('桌面宠物初始化完成'),Ue('init')}catch(e){De('桌面宠物初始化异常，请打开控制台查看错误',e)}}async function ze(e){const t=String(e||'').trim(),o=t.length>0&&t.toLowerCase().startsWith(u.toLowerCase());if(o)try{if(!await Ot()){const e='未找到已上传本地模型，请先在设置中上传 ZIP 模型。';return ce(`模型切换中止: local model missing, path=${t}`),toastr.error(e),void Ue('model-change-local-missing')}}catch(e){const o=`检查本地模型失败: ${e instanceof Error?e.message:String(e)}`;return ce(`模型切换检查异常: path=${t}`,e),toastr.error(o),void Ue('model-change-local-check-error')}if(await $e(e)){const e=Se(n.value.petScale);go.mountToStage(e.width,e.height,1)}else if(o){const e='本地模型加载失败，请尝试重新上传 ZIP 或切换远程模型。';ce(`本地模型加载失败: path=${t}`),toastr.error(e)}Ue(o?'model-change-local':'model-change')}function Re(){i.value='',l.value=!0}return(0,s.watch)(a,e=>{ce(e?'设置面板已显示':'设置面板已关闭')}),function(){try{const e=window.parent??window,t=()=>{r.openSettings(),ce('通过全局函数打开设置面板')};e[Ml]=t,c=t}catch(e){De('注册全局设置打开函数失败',e)}}(),(0,s.watch)(()=>({autoTrigger:n.value.autoTrigger,triggerInterval:n.value.triggerInterval,triggerProbability:n.value.triggerProbability,commentTriggerMode:n.value.commentTriggerMode}),e=>{Vo.updateConfig(e)}),(0,s.watch)(()=>n.value.autoMotionLoop,e=>{go.setAutoMotionLoopEnabled(e)}),(0,s.watch)(()=>n.value.gazeFollowMouseEnabled,()=>{Ne()}),(0,s.watch)(()=>n.value.petScale,e=>{const t=_e(e);if(t!==e)return void(n.value.petScale=t);const o=Se(t);Yt.resizeFloating(o.width,o.height),Yt.isPreviewMounted()||go.updateScale(o.width,o.height,1)}),(0,s.onMounted)(()=>{!function(){const e=O();h=()=>{Pe('window-resize')};try{e.addEventListener('resize',h,{passive:!0})}catch(e){Ae('Failed to bind window.resize listener',e),h=null}const t=e.visualViewport;if(t){f=()=>{Pe('visual-viewport-resize')};try{t.addEventListener('resize',f,{passive:!0})}catch(e){Ae('Failed to bind visualViewport.resize listener',e),f=null}}}(),Ne(),Ie()}),(0,s.onUnmounted)(()=>{!function(){const e=O();if(h){try{e.removeEventListener('resize',h)}catch{}h=null}const t=e.visualViewport;if(t&&f){try{t.removeEventListener('resize',f)}catch{}f=null}}(),Te(!0),function(){try{const e=window.parent??window;c&&e[Ml]===c&&delete e[Ml]}catch{}finally{c=null}}(),ge(),be(),d++,ke(),Ee(),Ve(),Yt.hideLoadingProgress(),Vo.destroy(),zo.destroy();try{Eo.stop(),xo.cleanup()}catch{}go.destroyModel(),Yt.destroy()}),(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',null,[(0,s.createVNode)(Xo,{text:i.value,'is-done':l.value,'auto-close-delay-seconds':(0,s.unref)(n).bubbleDuration,onHidden:Re},null,8,['text','is-done','auto-close-delay-seconds']),(0,s.createVNode)(_l,{visible:(0,s.unref)(a),onClose:t[0]||(t[0]=e=>(0,s.unref)(r).closeSettings()),onModelChange:ze},null,8,['visible']),(0,s.createVNode)(an,{visible:C.value,x:w.value.x,y:w.value.y,placement:S.value,'motion-loop-enabled':(0,s.unref)(n).autoMotionLoop,'comment-style':(0,s.unref)(n).commentStyle,onClose:t[1]||(t[1]=e=>C.value=!1),onSendChat:we,onToggleMotionLoop:ye,onSwitchModel:ve,onSwitchPersona:xe,onCloseModel:Be},null,8,['visible','x','y','placement','motion-loop-enabled','comment-style']),k.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'browser-overlay',onClick:t[4]||(t[4]=(0,s.withModifiers)(e=>k.value=!1,['self']))},[(0,s.createElementVNode)('div',kl,[(0,s.createElementVNode)('div',El,[t[5]||(t[5]=(0,s.createElementVNode)('h3',null,'在线模型库',-1)),(0,s.createElementVNode)('button',{class:'close-btn',onClick:t[2]||(t[2]=e=>k.value=!1)},'×')]),(0,s.createElementVNode)('div',Vl,[(0,s.createVNode)(Ln,{'use-cdn':(0,s.unref)(n).useCdn,onCancel:t[3]||(t[3]=e=>k.value=!1),onLoadModel:Ce},null,8,['use-cdn'])])])])):(0,s.createCommentVNode)('v-if',!0)]))}});i(785);const Nl=(0,Ho.A)(Tl,[['__scopeId','data-v-f0a5fb30']]);function Pl(){$(`head > div[script_id="${getScriptId()}"]`).remove()}const Ll='20260215.04',Dl=new Set(['桌面宠物','桌面宠物设置']),$l='桌面宠物设置',Ul='__desktopPetOpenSettings_v2',Il=e(),zl=jo(Il),Rl='desktop-pet-settings-menu-container',Wl='desktop-pet-settings-menu-item',Fl='.desktopPetSettingsMenu';let Ol=null;function jl(){try{return window.parent?.document??document}catch{return document}}function Gl(e){const t=`click${Fl}`;$(e).off(t,`#${Wl}`),$(e).on(t,`#${Wl}`,e=>{!async function(e){e.stopPropagation(),ce('设置菜单被点击，尝试打开设置面板');const t=jl(),o=$('#extensionsMenu',t),n=$('#extensionsMenuButton',t);n.length>0&&o.is(':visible')&&(n.trigger('click'),await new Promise(e=>{window.setTimeout(e,120)}));const r=window.parent??window,a=r?.[Ul];'function'==typeof a?(a(),ce('已通过全局打开函数请求打开设置面板')):(zl.openSettings(),ce(`已通过 Pinia 请求打开设置面板 (showSettings=${String(zl.showSettings)})`));window.setTimeout(()=>{try{const e=t.querySelector('#desktop-pet-app .settings-overlay'),o=e?.getBoundingClientRect?.(),n=o?`${Math.round(o.left)},${Math.round(o.top)} ${Math.round(o.width)}x${Math.round(o.height)}`:'none',r=e?window.getComputedStyle(e):null;ce(`设置面板 DOM 检测: overlay=${!!e} rect=${n} ${r?`position=${r.position} display=${r.display} width=${r.width} height=${r.height}`:'style=none'}`)}catch(e){de('设置面板 DOM 检测失败',e)}},0)}(e)})}function ql(){const e=jl(),t=$('#extensionsMenu',e);if(0===t.length)return void(null===Ol&&(Ol=window.setTimeout(()=>{Ol=null,ql()},1e3)));Gl(e);if($(`#${Wl}`,e).length>0)return;const o=$(`<div class="extension_container interactable" id="${Rl}" tabindex="0"></div>`),n=$(`<div class="list-group-item flex-container flexGap5 interactable" id="${Wl}" title="打开${$l}"><div class="fa-fw fa-solid fa-paw extensionsMenuExtensionButton"></div><span>${$l}</span></div>`);o.append(n),t.append(o)}function Yl(){null!==Ol&&(window.clearTimeout(Ol),Ol=null);const e=jl(),t=`click${Fl}`;$(e).off(t,`#${Wl}`),$(`#${Rl}`,e).remove()}function Jl(){try{const e=jl();$('.qr--button.menu_button.interactable',e).filter((e,t)=>Dl.has(String($(t).text()||'').trim())).remove()}catch(e){de('清理旧菜单按钮失败',e)}}$(()=>{Pl(),$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo('head');try{ce(`入口开始初始化(${Ll})`),Jl(),window.setTimeout(()=>{Jl()},1200);try{const e=jl();$('#desktop-pet-app',e).remove()}catch{}const e=$('<div id="desktop-pet-app">').appendTo('body'),t=(0,s.createApp)(Nl);t.use(Il),t.config.errorHandler=(e,t,o)=>{Ae(`Vue error: ${o}`,e)},t.config.warnHandler=(e,t,o)=>{de(`Vue warn: ${e}${o?`\n${o}`:''}`)},t.mount(e[0]),ql(),toastr.success(`${l}加载成功(${Ll})`),ce(`入口初始化完成(${Ll})`);let o=SillyTavern.getCurrentChatId();eventOn(tavern_events.CHAT_CHANGED,e=>{o!==e&&(o=e,Vo.resetState())})}catch(e){Ae('入口初始化失败',e),toastr.error(`${l}初始化失败(${Ll})，请打开控制台查看报错`),$('#desktop-pet-app').remove()}}),$(window).on('pagehide',()=>{Jl(),Yl(),Pl(),$('#desktop-pet-app').remove(),$('#desktop-pet-stage').remove()});
//# sourceMappingURL=index.js.map