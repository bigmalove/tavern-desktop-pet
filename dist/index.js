import{createPinia as e,defineStore as t,storeToRefs as o}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var a={0:(e,t,o)=>{var n=o(407);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('078f2c0f',n,!1,{ssrId:!0})},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var o='',n=void 0!==t[5];return t[4]&&(o+='@supports ('.concat(t[4],') {')),t[2]&&(o+='@media '.concat(t[2],' {')),n&&(o+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),o+=e(t),n&&(o+='}'),t[2]&&(o+='}'),t[4]&&(o+='}'),o}).join('')},t.i=function(e,o,n,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var i={};if(n)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(i[l]=!0)}for(var c=0;c<e.length;c++){var A=[].concat(e[c]);n&&i[A[0]]||(void 0!==r&&(void 0===A[5]||(A[1]='@layer'.concat(A[5].length>0?' '.concat(A[5]):'',' {').concat(A[1],'}')),A[5]=r),o&&(A[2]?(A[1]='@media '.concat(A[2],' {').concat(A[1],'}'),A[2]=o):A[2]=o),a&&(A[4]?(A[1]='@supports ('.concat(A[4],') {').concat(A[1],'}'),A[4]=a):A[4]=''.concat(a)),t.push(A))}},t}},89:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.node-row[data-v-3a6a95ba]{display:flex;align-items:center;padding:5px 8px;cursor:pointer;border-bottom:1px solid hsla(0,0%,100%,.08);font-size:12px;gap:4px;-webkit-user-select:none;user-select:none;transition:background .14s}.node-row[data-v-3a6a95ba]:hover{background:rgba(255,225,0,.12)}.node-row.is-model .node-name[data-v-3a6a95ba]{color:#00dac2;font-weight:600}.node-row.is-selected[data-v-3a6a95ba]{background:rgba(255,225,0,.2)}.expand-icon[data-v-3a6a95ba]{width:14px;font-size:8px;color:#8d8d8d;transition:transform .2s;flex-shrink:0;text-align:center}.expand-icon.expanded[data-v-3a6a95ba]{transform:rotate(90deg)}.expand-icon.placeholder[data-v-3a6a95ba]{visibility:hidden}.node-icon[data-v-3a6a95ba]{font-size:13px;flex-shrink:0;line-height:1}.node-name[data-v-3a6a95ba]{color:#f1f1f1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.node-spinner[data-v-3a6a95ba]{display:inline-block;width:10px;height:10px;border:1.5px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin-3a6a95ba .8s linear infinite;flex-shrink:0;margin-left:4px}@keyframes spin-3a6a95ba{to{transform:rotate(360deg)}}.empty-hint[data-v-3a6a95ba]{font-size:11px;color:#8d8d8d;padding:4px 8px}.child-error[data-v-3a6a95ba]{font-size:11px;color:#ffb5af;padding:4px 8px}.child-error .retry-link[data-v-3a6a95ba]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.child-error .retry-link[data-v-3a6a95ba]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.child-error .retry-link[data-v-3a6a95ba]:disabled{opacity:.45;cursor:not-allowed}.child-error .retry-link[data-v-3a6a95ba]{height:22px;min-width:56px;padding:0 8px;margin-left:6px;font-size:10px;border-color:rgba(0,218,194,.55);color:#c5fff9;cursor:pointer}.child-error .retry-link[data-v-3a6a95ba]:hover{background:#00dac2;border-color:#00dac2;color:#000}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/TreeNode.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,2BAAU,YAAa,CAAA,kBAAmB,CAAA,eAAgB,CAAA,cAAe,CAAA,2CAA4C,CAAA,cAAe,CAAA,OAAQ,CAAA,wBAAiB,CAAjB,gBAAiB,CAAA,0BAA2B,CAAA,iCAAgB,8BAA+B,CAAA,+CAA8B,aAAc,CAAA,eAAgB,CAAA,uCAAsB,6BAA8B,CAAA,8BAAa,UAAW,CAAA,aAAc,CAAA,aAAc,CAAA,wBAAyB,CAAA,aAAc,CAAA,iBAAkB,CAAA,uCAAsB,uBAAwB,CAAA,0CAAyB,iBAAkB,CAAA,4BAAW,cAAe,CAAA,aAAc,CAAA,aAAc,CAAA,4BAAW,aAAc,CAAA,eAAgB,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,MAAO,CAAA,+BAAc,oBAAqB,CAAA,UAAW,CAAA,WAAY,CAAA,0BAA2B,CAAA,wBAAyB,CAAA,iBAAkB,CAAA,2CAAmC,CAAA,aAAc,CAAA,eAAgB,CAAA,yBAAgB,GAAG,wBAAyB,CAAC,CAAA,6BAAY,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,8BAAa,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,0CAAyB,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,+DAA8C,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,mDAAkC,WAAY,CAAA,kBAAmB,CAAA,0CAAyB,WAAY,CAAA,cAAe,CAAA,aAAc,CAAA,eAAgB,CAAA,cAAe,CAAA,gCAAiC,CAAA,aAAc,CAAA,cAAe,CAAA,gDAA+B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.node-row{display:flex;align-items:center;padding:5px 8px;cursor:pointer;border-bottom:1px solid hsla(0,0%,100%,.08);font-size:12px;gap:4px;user-select:none;transition:background .14s}.node-row:hover{background:rgba(255,225,0,.12)}.node-row.is-model .node-name{color:#00dac2;font-weight:600}.node-row.is-selected{background:rgba(255,225,0,.2)}.expand-icon{width:14px;font-size:8px;color:#8d8d8d;transition:transform .2s;flex-shrink:0;text-align:center}.expand-icon.expanded{transform:rotate(90deg)}.expand-icon.placeholder{visibility:hidden}.node-icon{font-size:13px;flex-shrink:0;line-height:1}.node-name{color:#f1f1f1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.node-spinner{display:inline-block;width:10px;height:10px;border:1.5px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;margin-left:4px}@keyframes spin{to{transform:rotate(360deg)}}.empty-hint{font-size:11px;color:#8d8d8d;padding:4px 8px}.child-error{font-size:11px;color:#ffb5af;padding:4px 8px}.child-error .retry-link{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.child-error .retry-link:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.child-error .retry-link:disabled{opacity:.45;cursor:not-allowed}.child-error .retry-link{height:22px;min-width:56px;padding:0 8px;margin-left:6px;font-size:10px;border-color:rgba(0,218,194,.55);color:#c5fff9;cursor:pointer}.child-error .retry-link:hover{background:#00dac2;border-color:#00dac2;color:#000}'],sourceRoot:''}]);const s=i},235:(e,t)=>{t.A=(e,t)=>{const o=e.__vccOpts||e;for(const[e,n]of t)o[e]=n;return o}},239:(e,t,o)=>{var n=o(798);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('1a91b8e4',n,!1,{ssrId:!0})},292:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.model-browser[data-v-7ee23a0a]{display:flex;flex-direction:column;height:100%;max-height:60vh;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.browser-header[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:space-between;padding:8px 0 10px;margin-bottom:10px;border-bottom:1px solid rgba(255,225,0,.35)}.browser-header .browser-title[data-v-7ee23a0a]{font-size:14px;font-family:"Oswald","Teko","Segoe UI",sans-serif;letter-spacing:.08em;color:#ffe100}.browser-header .browser-hint[data-v-7ee23a0a]{font-size:10px;color:#8d8d8d;letter-spacing:.08em}.search-box[data-v-7ee23a0a]{margin-bottom:10px}.search-box input[data-v-7ee23a0a]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.search-box input[data-v-7ee23a0a]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.search-box input[data-v-7ee23a0a]::placeholder{color:#8d8d8d}.search-box input[data-v-7ee23a0a]{color:#fff}.error-bar[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.4);margin-bottom:10px;font-size:12px;color:#ffc9c5}.error-bar .retry-btn[data-v-7ee23a0a]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.error-bar .retry-btn[data-v-7ee23a0a]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.error-bar .retry-btn[data-v-7ee23a0a]:disabled{opacity:.45;cursor:not-allowed}.error-bar .retry-btn[data-v-7ee23a0a]{min-width:72px;height:26px;padding:0 8px;font-size:11px;border-color:rgba(255,59,48,.6);color:#ffc9c5}.error-bar .retry-btn[data-v-7ee23a0a]:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.tree-container[data-v-7ee23a0a]{flex:1;overflow-y:auto;min-height:150px;padding:4px 0 6px;border:1px solid hsla(0,0%,100%,.12);background:rgba(0,0,0,.3)}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar{width:7px;height:7px}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-thumb{background:#555}.tree-container[data-v-7ee23a0a]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.tree-container[data-v-7ee23a0a]:empty{border-style:dashed}.loading-state[data-v-7ee23a0a]{display:flex;align-items:center;justify-content:center;padding:24px;color:#8d8d8d;font-size:13px;gap:8px}.spinner[data-v-7ee23a0a]{display:inline-block;width:14px;height:14px;border:2px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin-7ee23a0a .8s linear infinite}@keyframes spin-7ee23a0a{to{transform:rotate(360deg)}}.empty-state[data-v-7ee23a0a]{text-align:center;padding:24px;color:#8d8d8d;font-size:13px}.browser-footer[data-v-7ee23a0a]{border-top:1px solid hsla(0,0%,100%,.16);padding-top:12px;margin-top:10px}.browser-footer .selected-info[data-v-7ee23a0a]{font-size:12px;color:#d5d5d5;margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.browser-footer .selected-info .selected-path[data-v-7ee23a0a]{color:#ffe100;font-weight:600}.browser-footer .selected-info .no-selection[data-v-7ee23a0a]{color:#8d8d8d}.browser-footer .footer-actions[data-v-7ee23a0a]{display:flex;justify-content:flex-end;gap:8px}.btn[data-v-7ee23a0a]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn[data-v-7ee23a0a]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn[data-v-7ee23a0a]:disabled{opacity:.45;cursor:not-allowed}.btn[data-v-7ee23a0a]{min-width:90px;height:32px;padding:0 14px;font-size:12px}.btn[data-v-7ee23a0a]:disabled{opacity:.4;cursor:not-allowed}.btn.btn-primary[data-v-7ee23a0a]{background:#ffe100;color:#000;border-color:#ffe100}.btn.btn-primary[data-v-7ee23a0a]:hover:not(:disabled){background:#fff26e;border-color:#fff26e}.btn.btn-secondary[data-v-7ee23a0a]{background:rgba(0,218,194,.08);border-color:rgba(0,218,194,.55);color:#c5fff9}.btn.btn-secondary[data-v-7ee23a0a]:hover{background:#00dac2;border-color:#00dac2;color:#000}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/ModelBrowser.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,gCAAe,YAAa,CAAA,qBAAsB,CAAA,WAAY,CAAA,eAAgB,CAAA,UAAW,CAAA,gFAAiF,CAAA,iCAAgB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,kBAAmB,CAAA,kBAAmB,CAAA,2CAA4C,CAAA,gDAA+B,cAAe,CAAA,iDAAkD,CAAA,oBAAqB,CAAA,aAAc,CAAA,+CAA8B,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,kBAAmB,CAAA,mCAAkB,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,yCAAwB,oBAAqB,CAAA,8BAA+B,CAAA,gDAA+B,aAAc,CAAA,mCAAkB,UAAW,CAAA,4BAAW,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,OAAQ,CAAA,gBAAiB,CAAA,8BAA+B,CAAA,mCAAoC,CAAA,kBAAmB,CAAA,cAAe,CAAA,aAAc,CAAA,uCAAsB,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,4DAA2C,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,gDAA+B,WAAY,CAAA,kBAAmB,CAAA,uCAAsB,cAAe,CAAA,WAAY,CAAA,aAAc,CAAA,cAAe,CAAA,+BAAgC,CAAA,aAAc,CAAA,6CAA4B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,iCAAgB,MAAO,CAAA,eAAgB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,oCAAqC,CAAA,yBAA0B,CAAA,oDAAmC,SAAU,CAAA,UAAW,CAAA,0DAAyC,8BAA+B,CAAA,0DAAyC,eAAgB,CAAA,gEAA+C,kBAAmB,CAAA,uCAAsB,mBAAoB,CAAA,gCAAe,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,aAAc,CAAA,cAAe,CAAA,OAAQ,CAAA,0BAAS,oBAAqB,CAAA,UAAW,CAAA,WAAY,CAAA,wBAAyB,CAAA,wBAAyB,CAAA,iBAAkB,CAAA,2CAAmC,CAAA,yBAAgB,GAAG,wBAAyB,CAAC,CAAA,8BAAa,iBAAkB,CAAA,YAAa,CAAA,aAAc,CAAA,cAAe,CAAA,iCAAgB,wCAAyC,CAAA,gBAAiB,CAAA,eAAgB,CAAA,gDAA+B,cAAe,CAAA,aAAc,CAAA,iBAAkB,CAAA,eAAgB,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,+DAA8C,aAAc,CAAA,eAAgB,CAAA,8DAA6C,aAAc,CAAA,iDAAgC,YAAa,CAAA,wBAAyB,CAAA,OAAQ,CAAA,sBAAK,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,+BAAc,WAAY,CAAA,kBAAmB,CAAA,sBAAK,cAAe,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,+BAAc,UAAW,CAAA,kBAAmB,CAAA,kCAAiB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,uDAAsC,kBAAmB,CAAA,oBAAqB,CAAA,oCAAmB,8BAA+B,CAAA,gCAAiC,CAAA,aAAc,CAAA,0CAAyB,kBAAmB,CAAA,oBAAqB,CAAA,UAAW',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.model-browser{display:flex;flex-direction:column;height:100%;max-height:60vh;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.browser-header{display:flex;align-items:center;justify-content:space-between;padding:8px 0 10px;margin-bottom:10px;border-bottom:1px solid rgba(255,225,0,.35)}.browser-header .browser-title{font-size:14px;font-family:"Oswald","Teko","Segoe UI",sans-serif;letter-spacing:.08em;color:#ffe100}.browser-header .browser-hint{font-size:10px;color:#8d8d8d;letter-spacing:.08em}.search-box{margin-bottom:10px}.search-box input{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.search-box input:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.search-box input::placeholder{color:#8d8d8d}.search-box input{color:#fff}.error-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.4);margin-bottom:10px;font-size:12px;color:#ffc9c5}.error-bar .retry-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.error-bar .retry-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.error-bar .retry-btn:disabled{opacity:.45;cursor:not-allowed}.error-bar .retry-btn{min-width:72px;height:26px;padding:0 8px;font-size:11px;border-color:rgba(255,59,48,.6);color:#ffc9c5}.error-bar .retry-btn:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.tree-container{flex:1;overflow-y:auto;min-height:150px;padding:4px 0 6px;border:1px solid hsla(0,0%,100%,.12);background:rgba(0,0,0,.3)}.tree-container::-webkit-scrollbar{width:7px;height:7px}.tree-container::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.tree-container::-webkit-scrollbar-thumb{background:#555}.tree-container::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.tree-container:empty{border-style:dashed}.loading-state{display:flex;align-items:center;justify-content:center;padding:24px;color:#8d8d8d;font-size:13px;gap:8px}.spinner{display:inline-block;width:14px;height:14px;border:2px solid #4d4d4d;border-top-color:#00dac2;border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.empty-state{text-align:center;padding:24px;color:#8d8d8d;font-size:13px}.browser-footer{border-top:1px solid hsla(0,0%,100%,.16);padding-top:12px;margin-top:10px}.browser-footer .selected-info{font-size:12px;color:#d5d5d5;margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.browser-footer .selected-info .selected-path{color:#ffe100;font-weight:600}.browser-footer .selected-info .no-selection{color:#8d8d8d}.browser-footer .footer-actions{display:flex;justify-content:flex-end;gap:8px}.btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn:disabled{opacity:.45;cursor:not-allowed}.btn{min-width:90px;height:32px;padding:0 14px;font-size:12px}.btn:disabled{opacity:.4;cursor:not-allowed}.btn.btn-primary{background:#ffe100;color:#000;border-color:#ffe100}.btn.btn-primary:hover:not(:disabled){background:#fff26e;border-color:#fff26e}.btn.btn-secondary{background:rgba(0,218,194,.08);border-color:rgba(0,218,194,.55);color:#c5fff9}.btn.btn-secondary:hover{background:#00dac2;border-color:#00dac2;color:#000}'],sourceRoot:''}]);const s=i},355:(e,t,o)=>{var n=o(292);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('db518fdc',n,!1,{ssrId:!0})},407:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.menu-overlay[data-v-ff4f8948]{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center}.menu-cluster[data-v-ff4f8948]{position:fixed;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 16px);pointer-events:auto}.menu-cluster.is-left[data-v-ff4f8948]{flex-direction:row-reverse}.menu-panel[data-v-ff4f8948]{width:164px;padding:8px;background:#181818;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.menu-panel[data-v-ff4f8948]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.menu-panel[data-v-ff4f8948]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:20px 20px}.panel-top[data-v-ff4f8948]{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 8px;border-bottom:1px solid rgba(255,225,0,.35)}.panel-title[data-v-ff4f8948]{font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#ffe100;font-size:12px;letter-spacing:.12em}.icon-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.icon-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.icon-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.icon-btn[data-v-ff4f8948]{width:28px;height:24px;padding:0;font-size:16px;line-height:1}.command-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.command-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.command-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.command-btn[data-v-ff4f8948]{width:100%;min-height:52px;padding:8px 10px;margin-bottom:8px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx main" "idx sub";-moz-column-gap:8px;column-gap:8px;row-gap:2px}.command-btn[data-v-ff4f8948]:last-child{margin-bottom:0}.command-btn.active[data-v-ff4f8948]{background:#ffe100;color:#000;border-color:#ffe100}.command-btn.danger[data-v-ff4f8948]{border-color:rgba(255,59,48,.45);color:#ffc9c5}.command-btn.danger[data-v-ff4f8948]:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.command-index[data-v-ff4f8948]{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:16px;color:#00dac2}.command-main[data-v-ff4f8948]{grid-area:main;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;line-height:1}.command-sub[data-v-ff4f8948]{grid-area:sub;font-size:10px;color:#8d8d8d;text-transform:none}.chat-drawer[data-v-ff4f8948]{width:min(320px,100vw - 36px);max-height:min(68vh,420px);padding:12px;background:#262626;color:#fff;overflow:auto;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.chat-drawer[data-v-ff4f8948]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#00dac2;z-index:2}.chat-drawer[data-v-ff4f8948]{background-image:linear-gradient(rgba(255,255,255,0.024) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.024) 1px,transparent 1px);background-size:20px 20px}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar{width:7px;height:7px}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-thumb{background:#555}.chat-drawer[data-v-ff4f8948]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.drawer-head[data-v-ff4f8948]{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,218,194,.38)}.drawer-title[data-v-ff4f8948]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;letter-spacing:.12em;color:#00dac2}.drawer-close[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.drawer-close[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.drawer-close[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.drawer-close[data-v-ff4f8948]{width:26px;height:24px;padding:0;font-size:16px;line-height:1}.chat-input[data-v-ff4f8948]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.chat-input[data-v-ff4f8948]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.chat-input[data-v-ff4f8948]::placeholder{color:#8d8d8d}.chat-input[data-v-ff4f8948]{min-height:96px;resize:vertical;color:#fff}.drawer-actions[data-v-ff4f8948]{display:flex;justify-content:flex-end;margin-top:10px}.send-btn[data-v-ff4f8948]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.send-btn[data-v-ff4f8948]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.send-btn[data-v-ff4f8948]:disabled{opacity:.45;cursor:not-allowed}.send-btn[data-v-ff4f8948]{min-width:96px;height:34px}.drawer-hint[data-v-ff4f8948]{margin-top:8px;font-size:11px;color:#8d8d8d}.drawer-enter-active[data-v-ff4f8948],.drawer-leave-active[data-v-ff4f8948]{transition:opacity .16s ease,transform .16s ease}.drawer-enter-from[data-v-ff4f8948],.drawer-leave-to[data-v-ff4f8948]{opacity:0;transform:translateX(-8px)}.menu-cluster.is-left .drawer-enter-from[data-v-ff4f8948],.menu-cluster.is-left .drawer-leave-to[data-v-ff4f8948]{transform:translateX(8px)}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/FunctionMenu.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,+BAAc,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,+BAAc,cAAe,CAAA,YAAa,CAAA,kBAAmB,CAAA,QAAS,CAAA,4BAA6B,CAAA,mBAAoB,CAAA,uCAAsB,0BAA2B,CAAA,6BAAY,WAAY,CAAA,WAAY,CAAA,kBAAmB,CAAA,UAAW,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,qCAAoB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,6BAAY,8IAAwJ,CAAA,yBAA0B,CAAA,4BAAW,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,iBAAkB,CAAA,mBAAoB,CAAA,2CAA4C,CAAA,8BAAa,iDAAkD,CAAA,aAAc,CAAA,cAAe,CAAA,oBAAqB,CAAA,2BAAU,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,gDAA+B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,oCAAmB,WAAY,CAAA,kBAAmB,CAAA,2BAAU,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,8BAAa,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,mDAAkC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,uCAAsB,WAAY,CAAA,kBAAmB,CAAA,8BAAa,UAAW,CAAA,eAAgB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,eAAgB,CAAA,YAAa,CAAA,8BAA+B,CAAA,wCAAyC,CAAA,mBAAe,CAAf,cAAe,CAAA,WAAY,CAAA,yCAAwB,eAAgB,CAAA,qCAAoB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,gCAAiC,CAAA,aAAc,CAAA,2CAA0B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,gCAAe,aAAc,CAAA,iBAAkB,CAAA,iDAAkD,CAAA,cAAe,CAAA,aAAc,CAAA,+BAAc,cAAe,CAAA,iDAAkD,CAAA,cAAe,CAAA,aAAc,CAAA,8BAAa,aAAc,CAAA,cAAe,CAAA,aAAc,CAAA,mBAAoB,CAAA,8BAAa,6BAA8B,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,UAAW,CAAA,aAAc,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,sCAAqB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,8BAAa,gJAA0J,CAAA,yBAA0B,CAAA,iDAAgC,SAAU,CAAA,UAAW,CAAA,uDAAsC,8BAA+B,CAAA,uDAAsC,eAAgB,CAAA,6DAA4C,kBAAmB,CAAA,8BAAa,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,kBAAmB,CAAA,kBAAmB,CAAA,2CAA4C,CAAA,+BAAc,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,aAAc,CAAA,+BAAc,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,oDAAmC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,wCAAuB,WAAY,CAAA,kBAAmB,CAAA,+BAAc,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,6BAAY,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,mCAAkB,oBAAqB,CAAA,8BAA+B,CAAA,0CAAyB,aAAc,CAAA,6BAAY,eAAgB,CAAA,eAAgB,CAAA,UAAW,CAAA,iCAAgB,YAAa,CAAA,wBAAyB,CAAA,eAAgB,CAAA,2BAAU,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,gDAA+B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,oCAAmB,WAAY,CAAA,kBAAmB,CAAA,2BAAU,cAAe,CAAA,WAAY,CAAA,8BAAa,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,4EAA0C,gDAAiD,CAAA,sEAAoC,SAAU,CAAA,0BAA2B,CAAA,kHAAgF,yBAA0B',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.menu-overlay{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center}.menu-cluster{position:fixed;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 16px);pointer-events:auto}.menu-cluster.is-left{flex-direction:row-reverse}.menu-panel{width:164px;padding:8px;background:#181818;color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.menu-panel::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.menu-panel{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:20px 20px}.panel-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 4px 8px;border-bottom:1px solid rgba(255,225,0,.35)}.panel-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#ffe100;font-size:12px;letter-spacing:.12em}.icon-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.icon-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.icon-btn:disabled{opacity:.45;cursor:not-allowed}.icon-btn{width:28px;height:24px;padding:0;font-size:16px;line-height:1}.command-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.command-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.command-btn:disabled{opacity:.45;cursor:not-allowed}.command-btn{width:100%;min-height:52px;padding:8px 10px;margin-bottom:8px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx main" "idx sub";column-gap:8px;row-gap:2px}.command-btn:last-child{margin-bottom:0}.command-btn.active{background:#ffe100;color:#000;border-color:#ffe100}.command-btn.danger{border-color:rgba(255,59,48,.45);color:#ffc9c5}.command-btn.danger:hover{background:#ff3b30;border-color:#ff3b30;color:#fff}.command-index{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:16px;color:#00dac2}.command-main{grid-area:main;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;line-height:1}.command-sub{grid-area:sub;font-size:10px;color:#8d8d8d;text-transform:none}.chat-drawer{width:min(320px,100vw - 36px);max-height:min(68vh,420px);padding:12px;background:#262626;color:#fff;overflow:auto;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.chat-drawer::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#00dac2;z-index:2}.chat-drawer{background-image:linear-gradient(rgba(255, 255, 255, 0.024) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.024) 1px, transparent 1px);background-size:20px 20px}.chat-drawer::-webkit-scrollbar{width:7px;height:7px}.chat-drawer::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.chat-drawer::-webkit-scrollbar-thumb{background:#555}.chat-drawer::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.drawer-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,218,194,.38)}.drawer-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:12px;letter-spacing:.12em;color:#00dac2}.drawer-close{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.drawer-close:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.drawer-close:disabled{opacity:.45;cursor:not-allowed}.drawer-close{width:26px;height:24px;padding:0;font-size:16px;line-height:1}.chat-input{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.chat-input:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.chat-input::placeholder{color:#8d8d8d}.chat-input{min-height:96px;resize:vertical;color:#fff}.drawer-actions{display:flex;justify-content:flex-end;margin-top:10px}.send-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.send-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.send-btn:disabled{opacity:.45;cursor:not-allowed}.send-btn{min-width:96px;height:34px}.drawer-hint{margin-top:8px;font-size:11px;color:#8d8d8d}.drawer-enter-active,.drawer-leave-active{transition:opacity .16s ease,transform .16s ease}.drawer-enter-from,.drawer-leave-to{opacity:0;transform:translateX(-8px)}.menu-cluster.is-left .drawer-enter-from,.menu-cluster.is-left .drawer-leave-to{transform:translateX(8px)}'],sourceRoot:''}]);const s=i},424:(e,t,o)=>{function n(e,t){for(var o=[],n={},a=0;a<t.length;a++){var r=t[a],i=r[0],s={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};n[i]?n[i].parts.push(s):o.push(n[i]={id:i,parts:[s]})}return o}o.d(t,{A:()=>m});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},i=a&&(document.head||document.getElementsByTagName('head')[0]),s=null,l=0,c=!1,A=function(){},d=null,u='data-vue-ssr-id',p='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(e,t,o,a){c=o,d=a||{};var i=n(e,t);return h(i),function(t){for(var o=[],a=0;a<i.length;a++){var s=i[a];(l=r[s.id]).refs--,o.push(l)}t?h(i=n(e,t)):i=[];for(a=0;a<o.length;a++){var l;if(0===(l=o[a]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete r[l.id]}}}}function h(e){for(var t=0;t<e.length;t++){var o=e[t],n=r[o.id];if(n){n.refs++;for(var a=0;a<n.parts.length;a++)n.parts[a](o.parts[a]);for(;a<o.parts.length;a++)n.parts.push(g(o.parts[a]));n.parts.length>o.parts.length&&(n.parts.length=o.parts.length)}else{var i=[];for(a=0;a<o.parts.length;a++)i.push(g(o.parts[a]));r[o.id]={id:o.id,refs:1,parts:i}}}}function f(){var e=document.createElement('style');return e.type='text/css',i.appendChild(e),e}function g(e){var t,o,n=document.querySelector('style['+u+'~="'+e.id+'"]');if(n){if(c)return A;n.parentNode.removeChild(n)}if(p){var a=l++;n=s||(s=f()),t=y.bind(null,n,a,!1),o=y.bind(null,n,a,!0)}else n=f(),t=C.bind(null,n),o=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else o()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function y(e,t,o,n){var a=o?'':n.css;if(e.styleSheet)e.styleSheet.cssText=x(t,a);else{var r=document.createTextNode(a),i=e.childNodes;i[t]&&e.removeChild(i[t]),i.length?e.insertBefore(r,i[t]):e.appendChild(r)}}function C(e,t){var o=t.css,n=t.media,a=t.sourceMap;if(n&&e.setAttribute('media',n),d.ssrId&&e.setAttribute(u,t.id),a&&(o+='\n/*# sourceURL='+a.sources[0]+' */',o+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}},533:(e,t,o)=>{var n=o(570);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('17765326',n,!1,{ssrId:!0})},570:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.browser-overlay[data-v-104a329c]{position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog[data-v-104a329c]{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.browser-dialog[data-v-104a329c]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog[data-v-104a329c]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.browser-dialog-header[data-v-104a329c]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3[data-v-104a329c]{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn[data-v-104a329c]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn[data-v-104a329c]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn[data-v-104a329c]:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn[data-v-104a329c]{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body[data-v-104a329c]{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body[data-v-104a329c]::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body[data-v-104a329c]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body[data-v-104a329c]::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body[data-v-104a329c]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media (max-width:860px){.browser-overlay[data-v-104a329c]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog[data-v-104a329c]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}}@media (max-width:620px){.browser-overlay[data-v-104a329c]{align-items:stretch;padding:0}.browser-dialog[data-v-104a329c]{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none;border-left:none;border-right:none}.browser-dialog-header[data-v-104a329c]{padding:12px}.browser-dialog-body[data-v-104a329c]{padding:10px 12px 12px}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/PetContainer.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,kCAAiB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,yBAA0B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,6BAA8B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,wCAAuB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,2CAA4C,CAAA,0BAA2B,CAAA,2CAA0B,QAAS,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,mDAAkC,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,wEAAuD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4DAA2C,WAAY,CAAA,kBAAmB,CAAA,mDAAkC,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,aAAc,CAAA,cAAe,CAAA,sCAAqB,sBAAuB,CAAA,aAAc,CAAA,MAAO,CAAA,yDAAwC,SAAU,CAAA,UAAW,CAAA,+DAA8C,8BAA+B,CAAA,+DAA8C,eAAgB,CAAA,qEAAoD,kBAAmB,CAAA,yBAAyB,kCAAiB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAC,CAAA,yBAAyB,kCAAiB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,eAAgB,CAAA,cAAe,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,wCAAuB,YAAa,CAAA,sCAAqB,sBAAuB,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.browser-overlay{position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.browser-dialog::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.browser-dialog-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media(max-width: 860px){.browser-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}}@media(max-width: 620px){.browser-overlay{align-items:stretch;padding:0}.browser-dialog{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none;border-left:none;border-right:none}.browser-dialog-header{padding:12px}.browser-dialog-body{padding:10px 12px 12px}}'],sourceRoot:''}]);const s=i},678:(e,t,o)=>{var n=o(89);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('bd0944e8',n,!1,{ssrId:!0})},735:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.chat-bubble[data-v-98097aea]{position:fixed;transform:translate(-50%,-100%);max-width:320px;min-width:80px;animation:bubble-in-98097aea .22s ease-out;z-index:10004;pointer-events:none}.bubble-content[data-v-98097aea]{position:relative;background:rgba(14,14,14,.96);color:#fff;border:1px solid #ffe100;padding:9px 26px 10px 13px;clip-path:polygon(10px 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%,0 10px);font-size:12px;line-height:1.5;word-break:break-word;box-shadow:8px 8px 0 rgba(0,0,0,.56);font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;pointer-events:auto}.bubble-content[data-v-98097aea]::after{content:"";position:absolute;right:22px;bottom:-2px;width:30px;height:3px;background:#ffe100}.bubble-text[data-v-98097aea]{white-space:pre-wrap}.cursor[data-v-98097aea]{animation:blink-98097aea .64s infinite;margin-left:1px;color:#00dac2}.bubble-close[data-v-98097aea]{position:absolute;right:6px;top:5px;width:15px;height:15px;border:1px solid hsla(0,0%,100%,.3);background:hsla(0,0%,100%,.08);color:#fff;line-height:13px;text-align:center;cursor:pointer;font-size:10px;padding:0;font-family:"Oswald","Teko","Segoe UI",sans-serif}.bubble-close[data-v-98097aea]:hover{background:#ff3b30;border-color:#ff3b30}.bubble-arrow[data-v-98097aea]{width:11px;height:11px;background:rgba(14,14,14,.96);border-left:1px solid #ffe100;border-bottom:1px solid #ffe100;transform:rotate(-45deg);margin:0 auto;margin-top:-6px}@keyframes bubble-in-98097aea{from{opacity:0;transform:translateX(-50%) translateY(8px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}@keyframes blink-98097aea{0%,50%{opacity:1}51%,100%{opacity:0}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/ChatBubble.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,8BAAa,cAAe,CAAA,+BAAiC,CAAA,eAAgB,CAAA,cAAe,CAAA,0CAAkC,CAAA,aAAc,CAAA,mBAAoB,CAAA,iCAAgB,iBAAkB,CAAA,6BAA8B,CAAA,UAAW,CAAA,wBAAyB,CAAA,0BAA2B,CAAA,4FAAkG,CAAA,cAAe,CAAA,eAAgB,CAAA,qBAAsB,CAAA,oCAAqC,CAAA,gFAAiF,CAAA,mBAAoB,CAAA,wCAAuB,UAAW,CAAA,iBAAkB,CAAA,UAAW,CAAA,WAAY,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,8BAAa,oBAAqB,CAAA,yBAAQ,sCAA8B,CAAA,eAAgB,CAAA,aAAc,CAAA,+BAAc,iBAAkB,CAAA,SAAU,CAAA,OAAQ,CAAA,UAAW,CAAA,WAAY,CAAA,mCAAoC,CAAA,8BAA+B,CAAA,UAAW,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,cAAe,CAAA,cAAe,CAAA,SAAU,CAAA,iDAAkD,CAAA,qCAAoB,kBAAmB,CAAA,oBAAqB,CAAA,+BAAc,UAAW,CAAA,WAAY,CAAA,6BAA8B,CAAA,6BAA8B,CAAA,+BAAgC,CAAA,wBAAyB,CAAA,aAAc,CAAA,eAAgB,CAAA,8BAAqB,KAAK,SAAU,CAAA,qDAAsD,CAAA,GAAG,SAAU,CAAA,iDAAkD,CAAC,CAAA,0BAAiB,OAAO,SAAU,CAAA,SAAS,SAAU,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.chat-bubble{position:fixed;transform:translate(-50%, -100%);max-width:320px;min-width:80px;animation:bubble-in .22s ease-out;z-index:10004;pointer-events:none}.bubble-content{position:relative;background:rgba(14,14,14,.96);color:#fff;border:1px solid #ffe100;padding:9px 26px 10px 13px;clip-path:polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);font-size:12px;line-height:1.5;word-break:break-word;box-shadow:8px 8px 0 rgba(0,0,0,.56);font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;pointer-events:auto}.bubble-content::after{content:"";position:absolute;right:22px;bottom:-2px;width:30px;height:3px;background:#ffe100}.bubble-text{white-space:pre-wrap}.cursor{animation:blink .64s infinite;margin-left:1px;color:#00dac2}.bubble-close{position:absolute;right:6px;top:5px;width:15px;height:15px;border:1px solid hsla(0,0%,100%,.3);background:hsla(0,0%,100%,.08);color:#fff;line-height:13px;text-align:center;cursor:pointer;font-size:10px;padding:0;font-family:"Oswald","Teko","Segoe UI",sans-serif}.bubble-close:hover{background:#ff3b30;border-color:#ff3b30}.bubble-arrow{width:11px;height:11px;background:rgba(14,14,14,.96);border-left:1px solid #ffe100;border-bottom:1px solid #ffe100;transform:rotate(-45deg);margin:0 auto;margin-top:-6px}@keyframes bubble-in{from{opacity:0;transform:translateX(-50%) translateY(8px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}'],sourceRoot:''}]);const s=i},790:e=>{e.exports=function(e){var t=e[1],o=e[3];if(!o)return t;if('function'==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(o)))),a='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(n),r='/*# '.concat(a,' */');return[t].concat([r]).join('\n')}return[t].join('\n')}},798:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var n=o(790),a=o.n(n),r=o(54),i=o.n(r)()(a());i.push([e.id,'@import url(https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap);']),i.push([e.id,'/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */.settings-overlay[data-v-7941402e]{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.settings-panel[data-v-7941402e]{width:min(1080px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.settings-panel[data-v-7941402e]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.settings-panel[data-v-7941402e]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.panel-header[data-v-7941402e]{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 18px;border-bottom:2px solid #ffe100;background:rgba(0,0,0,.32)}.header-title[data-v-7941402e]{min-width:0}.header-title h3[data-v-7941402e]{margin:0;font-size:20px;line-height:1;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase}.header-title p[data-v-7941402e]{margin:4px 0 0;font-size:10px;color:#8d8d8d;letter-spacing:.14em;text-transform:uppercase}.close-btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.close-btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.close-btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.close-btn[data-v-7941402e]{min-width:88px;height:32px;padding:0 10px;font-size:12px}.panel-main[data-v-7941402e]{flex:1;min-height:0;display:grid;grid-template-columns:220px 1fr}.panel-nav[data-v-7941402e]{border-right:1px solid hsla(0,0%,100%,.16);padding:12px;overflow:auto}.panel-nav[data-v-7941402e]::-webkit-scrollbar{width:7px;height:7px}.panel-nav[data-v-7941402e]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav[data-v-7941402e]::-webkit-scrollbar-thumb{background:#555}.panel-nav[data-v-7941402e]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.nav-btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.nav-btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.nav-btn[data-v-7941402e]{width:100%;min-height:62px;padding:10px 12px;margin-bottom:10px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx label" "idx sub";-moz-column-gap:8px;column-gap:8px;row-gap:2px}.nav-btn[data-v-7941402e]:last-child{margin-bottom:0}.nav-btn.active[data-v-7941402e]{background:#ffe100;color:#000;border-color:#ffe100}.nav-index[data-v-7941402e]{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#00dac2;font-size:18px}.nav-label[data-v-7941402e]{grid-area:label;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px;letter-spacing:.05em}.nav-sub[data-v-7941402e]{grid-area:sub;font-size:10px;color:#8d8d8d;letter-spacing:.06em}.panel-body[data-v-7941402e]{padding:14px 18px 16px;overflow:auto}.panel-body[data-v-7941402e]::-webkit-scrollbar{width:7px;height:7px}.panel-body[data-v-7941402e]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-body[data-v-7941402e]::-webkit-scrollbar-thumb{background:#555}.panel-body[data-v-7941402e]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.setting-section[data-v-7941402e]{max-width:740px}.setting-section h4[data-v-7941402e]{margin:0 0 12px;display:inline-flex;align-items:center;gap:8px;padding:4px 12px;background:#0f0f0f;border-left:4px solid #ffe100;transform:skewX(-14deg)}.setting-section h4[data-v-7941402e]>*{transform:skewX(14deg)}.section-index[data-v-7941402e]{color:#00dac2;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px}.section-label[data-v-7941402e]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:14px;letter-spacing:.04em}.section-sub[data-v-7941402e]{font-size:10px;color:#8d8d8d;letter-spacing:.06em}.form-group[data-v-7941402e]{margin-bottom:12px}.form-group>label[data-v-7941402e]{display:block;margin-bottom:5px;font-size:12px;color:#d5d5d5;line-height:1.35}.form-group>label>input[type=checkbox][data-v-7941402e]{margin-right:8px;accent-color:#00dac2}.form-group input[type=text][data-v-7941402e],.form-group input[type=password][data-v-7941402e],.form-group input[type=number][data-v-7941402e],.form-group select[data-v-7941402e],.form-group textarea[data-v-7941402e]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.form-group input[type=text][data-v-7941402e]:focus,.form-group input[type=password][data-v-7941402e]:focus,.form-group input[type=number][data-v-7941402e]:focus,.form-group select[data-v-7941402e]:focus,.form-group textarea[data-v-7941402e]:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.form-group input[type=text][data-v-7941402e]::placeholder,.form-group input[type=password][data-v-7941402e]::placeholder,.form-group input[type=number][data-v-7941402e]::placeholder,.form-group select[data-v-7941402e]::placeholder,.form-group textarea[data-v-7941402e]::placeholder{color:#8d8d8d}.form-group textarea[data-v-7941402e]{resize:vertical;min-height:86px;font-family:"JetBrains Mono","Consolas","Courier New",monospace;color:#fff}.form-group select[data-v-7941402e]{color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.form-group select option[data-v-7941402e]{background:#101010;color:#fff}.form-group input[type=range][data-v-7941402e]{width:100%;-webkit-appearance:none;appearance:none;height:4px;border:none;background:#4a4a4a;border-radius:0;padding:0;margin:7px 0 4px}.form-group input[type=range][data-v-7941402e]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#ffe100;border:2px solid #000;transform:rotate(45deg)}.form-group input[type=range][data-v-7941402e]::-moz-range-thumb{width:12px;height:12px;border:2px solid #000;border-radius:0;background:#ffe100;transform:rotate(45deg)}.form-group input[type=range][data-v-7941402e]::-moz-range-track{height:4px;background:#4a4a4a;border:none}.form-group input[type=checkbox][data-v-7941402e]{accent-color:#00dac2}.form-group .hint[data-v-7941402e]{margin-top:4px;font-size:11px;color:#8d8d8d}.hint-error[data-v-7941402e]{color:#ff3b30 !important}.form-row[data-v-7941402e]{display:flex;gap:12px;align-items:flex-start}.form-row .half[data-v-7941402e]{flex:1;min-width:0}.dice-sheet-list[data-v-7941402e]{margin-top:6px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}.dice-sheet-item[data-v-7941402e]{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.04);font-size:12px;color:#e8e8e8;line-height:1.35}.dice-sheet-item input[type=checkbox][data-v-7941402e]{margin:0}.input-with-btn[data-v-7941402e]{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch}.input-with-btn .input-btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.input-with-btn .input-btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.input-with-btn .input-btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.input-with-btn .input-btn[data-v-7941402e]{min-width:84px;padding:0 12px;font-size:11px;white-space:nowrap}.model-list[data-v-7941402e]{display:flex;flex-wrap:wrap;gap:8px}.model-btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.model-btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.model-btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.model-btn[data-v-7941402e]{min-height:30px;padding:0 12px;font-size:12px;text-transform:none;letter-spacing:.03em}.model-btn.active[data-v-7941402e]{background:#ffe100;border-color:#ffe100;color:#000}.model-btn.browse-btn[data-v-7941402e]{border-color:rgba(0,218,194,.55);color:#b2fff6}.model-btn.browse-btn[data-v-7941402e]:hover{background:#00dac2;border-color:#00dac2;color:#000}.emotion-layout[data-v-7941402e]{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:14px;align-items:start}.emotion-configs[data-v-7941402e]{min-width:0}.emotion-preview-panel[data-v-7941402e]{position:sticky;top:10px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 12px;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:18px 18px}.emotion-preview-header[data-v-7941402e]{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}.emotion-preview-title[data-v-7941402e]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#00dac2}.emotion-preview-tag[data-v-7941402e]{font-size:12px;color:hsla(0,0%,100%,.78)}.emotion-preview-canvas[data-v-7941402e]{position:relative;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden;background:rgba(15,23,42,.95);border:1px solid hsla(0,0%,100%,.18)}.emotion-preview-interact[data-v-7941402e]{position:absolute;inset:0;z-index:3}.emotion-preview-empty[data-v-7941402e]{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;z-index:4;pointer-events:none;color:hsla(0,0%,100%,.78);font-size:12px}.emotion-preview-controls[data-v-7941402e]{margin-top:10px;display:flex;flex-direction:column;gap:8px}.emotion-zoom-row[data-v-7941402e]{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}.zoom-label[data-v-7941402e]{font-size:12px;color:hsla(0,0%,100%,.78)}.zoom-value[data-v-7941402e]{font-size:12px;color:#ffe100;font-variant-numeric:tabular-nums}.emotion-preview-actions[data-v-7941402e]{display:flex;gap:8px}.emotion-tag[data-v-7941402e]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100;text-transform:uppercase}.emotion-map-table[data-v-7941402e]{margin-top:4px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.22);max-height:none;overflow:visible;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:20px 20px}.emotion-map-head[data-v-7941402e],.emotion-map-row[data-v-7941402e]{display:grid;grid-template-columns:72px 22px minmax(0,1fr) minmax(0,1fr) 52px;gap:10px;align-items:center}.emotion-map-head[data-v-7941402e]{position:sticky;top:0;z-index:2;padding:8px 10px;font-size:10px;color:hsla(0,0%,100%,.68);letter-spacing:.03em;background:rgba(2,8,20,.92);border-bottom:1px solid hsla(0,0%,100%,.2)}.emotion-map-row[data-v-7941402e]{padding:10px;border-bottom:1px solid hsla(0,0%,100%,.12)}.emotion-map-row[data-v-7941402e]:nth-child(odd){background:hsla(0,0%,100%,.02)}.emotion-map-tag[data-v-7941402e]{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100}.emotion-map-arrow[data-v-7941402e]{text-align:center;color:hsla(0,0%,100%,.78);font-size:18px;line-height:1}.emotion-map-preview-btn[data-v-7941402e]{min-width:0;width:44px;height:32px;padding:0;font-size:14px;line-height:1}.emotion-map-row select[data-v-7941402e]{width:100%;min-width:0;text-overflow:ellipsis;white-space:nowrap}.emotion-advanced-list[data-v-7941402e]{margin-top:10px;display:flex;flex-direction:column;gap:10px}.emotion-advanced-item[data-v-7941402e]{border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 2px;background-image:linear-gradient(rgba(255,255,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.025) 1px,transparent 1px);background-size:18px 18px}.emotion-advanced-title[data-v-7941402e]{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:hsla(0,0%,100%,.85)}.advanced-toggle[data-v-7941402e]{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.04);font-size:11px;color:#d5d5d5;cursor:pointer;-webkit-user-select:none;user-select:none;clip-path:polygon(0 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%)}.advanced-toggle[data-v-7941402e]:hover{border-color:rgba(255,225,0,.65);color:#ffe100}.advanced-toggle .toggle-icon[data-v-7941402e]{width:12px;text-align:center;color:#00dac2}.advanced-params[data-v-7941402e]{margin-top:8px;padding-top:10px;border-top:1px dashed hsla(0,0%,100%,.2)}.about-card[data-v-7941402e]{margin-bottom:12px;padding:10px 12px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.26);background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:18px 18px}.about-title[data-v-7941402e]{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:#ffe100}.about-link[data-v-7941402e]{color:#00dac2;word-break:break-all;text-decoration:underline}.about-list[data-v-7941402e]{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.5;color:#d5d5d5}.status-badge[data-v-7941402e]{margin-left:8px;font-size:12px}.status-success[data-v-7941402e]{color:#00dac2}.status-fail[data-v-7941402e]{color:#ff9c94}.panel-footer[data-v-7941402e]{display:flex;justify-content:flex-end;gap:10px;padding:12px 18px 14px;border-top:1px solid hsla(0,0%,100%,.18);background:rgba(0,0,0,.36)}.btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.btn[data-v-7941402e]{min-width:100px;height:34px;padding:0 14px;font-size:12px}.btn-primary[data-v-7941402e]{background:#ffe100;color:#000;border-color:#ffe100}.btn-secondary[data-v-7941402e]{background:hsla(0,0%,100%,.06);border-color:hsla(0,0%,100%,.3)}.btn-test[data-v-7941402e]{min-width:96px;background:rgba(0,218,194,.1);border-color:rgba(0,218,194,.6);color:#bcfff7}.btn-test[data-v-7941402e]:hover:not(:disabled){background:#00dac2;border-color:#00dac2;color:#000}.browser-overlay[data-v-7941402e]{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog[data-v-7941402e]{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%)}.browser-dialog[data-v-7941402e]::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog[data-v-7941402e]{background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:22px 22px}.browser-dialog-header[data-v-7941402e]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3[data-v-7941402e]{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn[data-v-7941402e]{-webkit-appearance:none;appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn[data-v-7941402e]:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn[data-v-7941402e]:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn[data-v-7941402e]{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body[data-v-7941402e]{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body[data-v-7941402e]::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body[data-v-7941402e]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body[data-v-7941402e]::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body[data-v-7941402e]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media (max-width:860px){.settings-overlay[data-v-7941402e]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.settings-panel[data-v-7941402e]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.settings-panel[data-v-7941402e]::before{width:40px}.panel-main[data-v-7941402e]{grid-template-columns:1fr;grid-template-rows:auto 1fr;min-height:0}.panel-nav[data-v-7941402e]{border-right:none;border-bottom:1px solid hsla(0,0%,100%,.16);display:flex;gap:6px;padding:8px 10px;overflow-x:auto;overflow-y:hidden}.panel-nav[data-v-7941402e]::-webkit-scrollbar{width:7px;height:7px}.panel-nav[data-v-7941402e]::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav[data-v-7941402e]::-webkit-scrollbar-thumb{background:#555}.panel-nav[data-v-7941402e]::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn[data-v-7941402e]{flex:0 0 auto;width:150px;min-height:42px;padding:6px 10px;margin-bottom:0;grid-template-areas:"idx label";grid-template-columns:auto 1fr;row-gap:0;align-items:center}.panel-body[data-v-7941402e]{min-height:0}.nav-index[data-v-7941402e]{font-size:16px}.nav-label[data-v-7941402e]{font-size:12px}.nav-sub[data-v-7941402e]{display:none}.browser-overlay[data-v-7941402e]{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog[data-v-7941402e]{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.emotion-layout[data-v-7941402e]{grid-template-columns:1fr}.emotion-preview-panel[data-v-7941402e]{order:-1;position:sticky;top:8px;z-index:8;margin-bottom:8px;padding:8px 10px 10px;background:rgba(0,0,0,.9)}.emotion-preview-header[data-v-7941402e]{margin-bottom:6px}.emotion-preview-canvas[data-v-7941402e]{aspect-ratio:16/9;max-height:210px}.emotion-preview-controls[data-v-7941402e]{margin-top:8px;gap:6px}.emotion-map-head[data-v-7941402e]{position:static}.emotion-preview-controls .hint[data-v-7941402e]{display:none}}@media (max-width:620px){.settings-overlay[data-v-7941402e]{align-items:stretch;padding:0}.settings-panel[data-v-7941402e]{width:100vw;max-height:100dvh;border-left:none;border-right:none;box-shadow:none}.panel-header[data-v-7941402e]{padding:10px 12px}.header-title h3[data-v-7941402e]{font-size:15px;letter-spacing:.06em}.header-title p[data-v-7941402e]{display:none}.panel-nav[data-v-7941402e]{padding:6px 8px}.nav-btn[data-v-7941402e]{width:126px;min-height:38px;padding:5px 8px}.nav-index[data-v-7941402e]{font-size:14px}.nav-label[data-v-7941402e]{font-size:11px;letter-spacing:.04em}.close-btn[data-v-7941402e]{min-width:66px;height:28px;padding:0 8px;font-size:11px}.panel-footer[data-v-7941402e]{padding:10px 12px calc(10px + env(safe-area-inset-bottom))}.panel-body[data-v-7941402e]{padding:8px 10px}.form-row[data-v-7941402e]{flex-direction:column;gap:0}.input-with-btn[data-v-7941402e]{grid-template-columns:1fr}.btn[data-v-7941402e]{min-width:86px}.emotion-preview-panel[data-v-7941402e]{top:6px;padding:8px}.emotion-preview-canvas[data-v-7941402e]{max-height:180px}.emotion-map-head[data-v-7941402e],.emotion-map-row[data-v-7941402e]{grid-template-columns:56px 16px minmax(0,1fr) minmax(0,1fr) 42px;gap:6px}.emotion-map-row[data-v-7941402e]{padding:8px}.emotion-map-arrow[data-v-7941402e]{font-size:14px}.emotion-map-preview-btn[data-v-7941402e]{width:38px;height:30px;font-size:12px}.browser-overlay[data-v-7941402e]{align-items:stretch;padding:0}.browser-dialog[data-v-7941402e]{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.browser-dialog-header[data-v-7941402e]{padding:12px}.browser-dialog-body[data-v-7941402e]{padding:10px 12px 12px}}','',{version:3,sources:['<no source>','webpack://./初始模板/脚本/酒馆桌面宠物/ui/SettingsPanel.vue'],names:[],mappings:'AAAA,iEAAA,CCAwH,mCAAkB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,0BAA2B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,8BAA+B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,+BAAc,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,+BAAgC,CAAA,0BAA2B,CAAA,+BAAc,WAAY,CAAA,kCAAiB,QAAS,CAAA,cAAe,CAAA,aAAc,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,iCAAgB,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,4BAAW,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iDAAgC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,WAAY,CAAA,kBAAmB,CAAA,4BAAW,cAAe,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,6BAAY,MAAO,CAAA,YAAa,CAAA,YAAa,CAAA,+BAAgC,CAAA,4BAAW,0CAA2C,CAAA,YAAa,CAAA,aAAc,CAAA,+CAA8B,SAAU,CAAA,UAAW,CAAA,qDAAoC,8BAA+B,CAAA,qDAAoC,eAAgB,CAAA,2DAA0C,kBAAmB,CAAA,0BAAS,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,+CAA8B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,mCAAkB,WAAY,CAAA,kBAAmB,CAAA,0BAAS,UAAW,CAAA,eAAgB,CAAA,iBAAkB,CAAA,kBAAmB,CAAA,eAAgB,CAAA,YAAa,CAAA,8BAA+B,CAAA,yCAA0C,CAAA,mBAAe,CAAf,cAAe,CAAA,WAAY,CAAA,qCAAoB,eAAgB,CAAA,iCAAgB,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4BAAW,aAAc,CAAA,iBAAkB,CAAA,iDAAkD,CAAA,aAAc,CAAA,cAAe,CAAA,4BAAW,eAAgB,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,0BAAS,aAAc,CAAA,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,sBAAuB,CAAA,aAAc,CAAA,gDAA+B,SAAU,CAAA,UAAW,CAAA,sDAAqC,8BAA+B,CAAA,sDAAqC,eAAgB,CAAA,4DAA2C,kBAAmB,CAAA,kCAAiB,eAAgB,CAAA,qCAAoB,eAAgB,CAAA,mBAAoB,CAAA,kBAAmB,CAAA,OAAQ,CAAA,gBAAiB,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,uBAAwB,CAAA,uCAAsB,sBAAuB,CAAA,gCAAe,aAAc,CAAA,iDAAkD,CAAA,cAAe,CAAA,gCAAe,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,8BAAa,cAAe,CAAA,aAAc,CAAA,oBAAqB,CAAA,6BAAY,kBAAmB,CAAA,mCAAkB,aAAc,CAAA,iBAAkB,CAAA,cAAe,CAAA,aAAc,CAAA,gBAAiB,CAAA,wDAAuC,gBAAiB,CAAA,oBAAqB,CAAA,0NAAqI,UAAW,CAAA,qBAAsB,CAAA,gBAAiB,CAAA,wBAAyB,CAAA,+BAAgC,CAAA,eAAgB,CAAA,0BAA2B,CAAA,aAAc,CAAA,+DAAgE,CAAA,cAAe,CAAA,YAAa,CAAA,sDAAuD,CAAA,wPAAmK,oBAAqB,CAAA,8BAA+B,CAAA,2RAAsM,aAAc,CAAA,sCAAqB,eAAgB,CAAA,eAAgB,CAAA,+DAAgE,CAAA,UAAW,CAAA,oCAAmB,UAAW,CAAA,gFAAiF,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,+CAA8B,UAAW,CAAA,uBAAgB,CAAhB,eAAgB,CAAA,UAAW,CAAA,WAAY,CAAA,kBAAmB,CAAA,eAAgB,CAAA,SAAU,CAAA,gBAAiB,CAAA,qEAAoD,uBAAwB,CAAA,UAAW,CAAA,WAAY,CAAA,kBAAmB,CAAA,qBAAsB,CAAA,uBAAwB,CAAA,iEAAgD,UAAW,CAAA,WAAY,CAAA,qBAAsB,CAAA,eAAgB,CAAA,kBAAmB,CAAA,uBAAwB,CAAA,iEAAgD,UAAW,CAAA,kBAAmB,CAAA,WAAY,CAAA,kDAAiC,oBAAqB,CAAA,mCAAkB,cAAe,CAAA,cAAe,CAAA,aAAc,CAAA,6BAAY,wBAAyB,CAAA,2BAAU,YAAa,CAAA,QAAS,CAAA,sBAAuB,CAAA,iCAAgB,MAAO,CAAA,WAAY,CAAA,kCAAiB,cAAe,CAAA,YAAa,CAAA,wDAA2D,CAAA,OAAQ,CAAA,kCAAiB,YAAa,CAAA,kBAAmB,CAAA,OAAQ,CAAA,eAAgB,CAAA,oCAAqC,CAAA,8BAA+B,CAAA,cAAe,CAAA,aAAc,CAAA,gBAAiB,CAAA,uDAAsC,QAAS,CAAA,iCAAgB,YAAa,CAAA,8BAA+B,CAAA,OAAQ,CAAA,mBAAoB,CAAA,4CAA2B,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iEAAgD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qDAAoC,WAAY,CAAA,kBAAmB,CAAA,4CAA2B,cAAe,CAAA,cAAe,CAAA,cAAe,CAAA,kBAAmB,CAAA,6BAAY,YAAa,CAAA,cAAe,CAAA,OAAQ,CAAA,4BAAW,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,iDAAgC,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,qCAAoB,WAAY,CAAA,kBAAmB,CAAA,4BAAW,eAAgB,CAAA,cAAe,CAAA,cAAe,CAAA,mBAAoB,CAAA,oBAAqB,CAAA,mCAAkB,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,uCAAsB,gCAAiC,CAAA,aAAc,CAAA,6CAA4B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,iCAAgB,YAAa,CAAA,yCAA2C,CAAA,QAAS,CAAA,iBAAkB,CAAA,kCAAiB,WAAY,CAAA,wCAAuB,eAAgB,CAAA,QAAS,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,sBAAuB,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,yCAAwB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,kBAAmB,CAAA,wCAAuB,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,sCAAqB,cAAe,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,UAAW,CAAA,gBAAiB,CAAA,kBAAmB,CAAA,eAAgB,CAAA,6BAA8B,CAAA,oCAAqC,CAAA,2CAA0B,iBAAkB,CAAA,OAAQ,CAAA,SAAU,CAAA,wCAAuB,iBAAkB,CAAA,OAAQ,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,iBAAkB,CAAA,SAAU,CAAA,mBAAoB,CAAA,yBAA0B,CAAA,cAAe,CAAA,2CAA0B,eAAgB,CAAA,YAAa,CAAA,qBAAsB,CAAA,OAAQ,CAAA,mCAAkB,YAAa,CAAA,mCAAoC,CAAA,QAAS,CAAA,kBAAmB,CAAA,6BAAY,cAAe,CAAA,yBAA0B,CAAA,6BAAY,cAAe,CAAA,aAAc,CAAA,iCAAkC,CAAA,0CAAyB,YAAa,CAAA,OAAQ,CAAA,8BAAa,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,wBAAyB,CAAA,oCAAmB,cAAe,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,eAAgB,CAAA,gBAAiB,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,qEAAmC,YAAa,CAAA,gEAAmE,CAAA,QAAS,CAAA,kBAAmB,CAAA,mCAAkB,eAAgB,CAAA,KAAM,CAAA,SAAU,CAAA,gBAAiB,CAAA,cAAe,CAAA,yBAA0B,CAAA,oBAAqB,CAAA,2BAA4B,CAAA,0CAA2C,CAAA,kCAAiB,YAAa,CAAA,2CAA4C,CAAA,iDAAgC,8BAA+B,CAAA,kCAAiB,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,aAAc,CAAA,oCAAmB,iBAAkB,CAAA,yBAA0B,CAAA,cAAe,CAAA,aAAc,CAAA,0CAAyB,WAAY,CAAA,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,cAAe,CAAA,aAAc,CAAA,yCAAwB,UAAW,CAAA,WAAY,CAAA,sBAAuB,CAAA,kBAAmB,CAAA,wCAAuB,eAAgB,CAAA,YAAa,CAAA,qBAAsB,CAAA,QAAS,CAAA,wCAAuB,oCAAqC,CAAA,0BAA2B,CAAA,qBAAsB,CAAA,gJAA0J,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,cAAe,CAAA,oBAAqB,CAAA,yBAA0B,CAAA,kCAAiB,mBAAoB,CAAA,kBAAmB,CAAA,OAAQ,CAAA,gBAAiB,CAAA,mCAAoC,CAAA,8BAA+B,CAAA,cAAe,CAAA,aAAc,CAAA,cAAe,CAAA,wBAAiB,CAAjB,gBAAiB,CAAA,gFAAqF,CAAA,wCAAuB,gCAAiC,CAAA,aAAc,CAAA,+CAA8B,UAAW,CAAA,iBAAkB,CAAA,aAAc,CAAA,kCAAiB,cAAe,CAAA,gBAAiB,CAAA,wCAAyC,CAAA,6BAAY,kBAAmB,CAAA,iBAAkB,CAAA,oCAAqC,CAAA,0BAA2B,CAAA,8IAAwJ,CAAA,yBAA0B,CAAA,8BAAa,iBAAkB,CAAA,cAAe,CAAA,oBAAqB,CAAA,aAAc,CAAA,6BAAY,aAAc,CAAA,oBAAqB,CAAA,yBAA0B,CAAA,6BAAY,QAAS,CAAA,iBAAkB,CAAA,YAAa,CAAA,qBAAsB,CAAA,OAAQ,CAAA,cAAe,CAAA,eAAgB,CAAA,aAAc,CAAA,+BAAc,eAAgB,CAAA,cAAe,CAAA,iCAAgB,aAAc,CAAA,8BAAa,aAAc,CAAA,+BAAc,YAAa,CAAA,wBAAyB,CAAA,QAAS,CAAA,sBAAuB,CAAA,wCAAyC,CAAA,0BAA2B,CAAA,sBAAK,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,2CAA0B,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,+BAAc,WAAY,CAAA,kBAAmB,CAAA,sBAAK,eAAgB,CAAA,WAAY,CAAA,cAAe,CAAA,cAAe,CAAA,8BAAa,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,gCAAe,8BAA+B,CAAA,+BAAgC,CAAA,2BAAU,cAAe,CAAA,6BAA8B,CAAA,+BAAgC,CAAA,aAAc,CAAA,gDAA+B,kBAAmB,CAAA,oBAAqB,CAAA,UAAW,CAAA,kCAAiB,cAAe,CAAA,OAAQ,CAAA,aAAc,CAAA,yBAA0B,CAAA,YAAa,CAAA,kBAAmB,CAAA,sBAAuB,CAAA,YAAa,CAAA,qBAAsB,CAAA,aAAc,CAAA,iCAAgB,6BAA8B,CAAA,8BAA+B,CAAA,YAAa,CAAA,qBAAsB,CAAA,eAAgB,CAAA,UAAW,CAAA,kBAAmB,CAAA,gFAAiF,CAAA,iBAAkB,CAAA,wBAAyB,CAAA,sCAAuC,CAAA,kFAAuF,CAAA,yCAAwB,UAAW,CAAA,iBAAkB,CAAA,KAAM,CAAA,MAAO,CAAA,UAAW,CAAA,UAAW,CAAA,kBAAmB,CAAA,SAAU,CAAA,iCAAgB,8IAAwJ,CAAA,yBAA0B,CAAA,wCAAuB,YAAa,CAAA,kBAAmB,CAAA,6BAA8B,CAAA,QAAS,CAAA,iBAAkB,CAAA,2CAA4C,CAAA,0BAA2B,CAAA,2CAA0B,QAAS,CAAA,iDAAkD,CAAA,cAAe,CAAA,oBAAqB,CAAA,mDAAkC,uBAAgB,CAAhB,eAAgB,CAAA,oCAAqC,CAAA,wBAAyB,CAAA,UAAW,CAAA,iDAAkD,CAAA,eAAgB,CAAA,oBAAqB,CAAA,wBAAyB,CAAA,cAAe,CAAA,kFAAuF,CAAA,sEAAuE,CAAA,wEAAuD,kBAAmB,CAAA,UAAW,CAAA,oBAAqB,CAAA,4DAA2C,WAAY,CAAA,kBAAmB,CAAA,mDAAkC,UAAW,CAAA,WAAY,CAAA,SAAU,CAAA,aAAc,CAAA,cAAe,CAAA,sCAAqB,sBAAuB,CAAA,aAAc,CAAA,MAAO,CAAA,yDAAwC,SAAU,CAAA,UAAW,CAAA,+DAA8C,8BAA+B,CAAA,+DAA8C,eAAgB,CAAA,qEAAoD,kBAAmB,CAAA,yBAAyB,mCAAkB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAA,yCAAwB,UAAW,CAAA,6BAAY,yBAA0B,CAAA,2BAA4B,CAAA,YAAa,CAAA,4BAAW,iBAAkB,CAAA,2CAA4C,CAAA,YAAa,CAAA,OAAQ,CAAA,gBAAiB,CAAA,eAAgB,CAAA,iBAAkB,CAAA,+CAA8B,SAAU,CAAA,UAAW,CAAA,qDAAoC,8BAA+B,CAAA,qDAAoC,eAAgB,CAAA,2DAA0C,kBAAmB,CAAA,0BAAS,aAAc,CAAA,WAAY,CAAA,eAAgB,CAAA,gBAAiB,CAAA,eAAgB,CAAA,+BAAgC,CAAA,8BAA+B,CAAA,SAAU,CAAA,kBAAmB,CAAA,6BAAY,YAAa,CAAA,4BAAW,cAAe,CAAA,4BAAW,cAAe,CAAA,0BAAS,YAAa,CAAA,kCAAiB,sBAAuB,CAAA,wFAAyF,CAAA,iCAAgB,UAAW,CAAA,uFAAwF,CAAA,cAAe,CAAA,wCAAyC,CAAA,iCAAgB,yBAA0B,CAAA,wCAAuB,QAAS,CAAA,eAAgB,CAAA,OAAQ,CAAA,SAAU,CAAA,iBAAkB,CAAA,qBAAsB,CAAA,yBAA0B,CAAA,yCAAwB,iBAAkB,CAAA,yCAAwB,iBAAkB,CAAA,gBAAiB,CAAA,2CAA0B,cAAe,CAAA,OAAQ,CAAA,mCAAkB,eAAgB,CAAA,iDAAgC,YAAa,CAAC,CAAA,yBAAyB,mCAAkB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,gBAAiB,CAAA,iBAAkB,CAAA,eAAgB,CAAA,+BAAc,iBAAkB,CAAA,kCAAiB,cAAe,CAAA,oBAAqB,CAAA,iCAAgB,YAAa,CAAA,4BAAW,eAAgB,CAAA,0BAAS,WAAY,CAAA,eAAgB,CAAA,eAAgB,CAAA,4BAAW,cAAe,CAAA,4BAAW,cAAe,CAAA,oBAAqB,CAAA,4BAAW,cAAe,CAAA,WAAY,CAAA,aAAc,CAAA,cAAe,CAAA,+BAAc,0DAA2D,CAAA,6BAAY,gBAAiB,CAAA,2BAAU,qBAAsB,CAAA,KAAM,CAAA,iCAAgB,yBAA0B,CAAA,sBAAK,cAAe,CAAA,wCAAuB,OAAQ,CAAA,WAAY,CAAA,yCAAwB,gBAAiB,CAAA,qEAAmC,gEAAmE,CAAA,OAAQ,CAAA,kCAAiB,WAAY,CAAA,oCAAmB,cAAe,CAAA,0CAAyB,UAAW,CAAA,WAAY,CAAA,cAAe,CAAA,kCAAiB,mBAAoB,CAAA,SAAU,CAAA,iCAAgB,WAAY,CAAA,iBAAkB,CAAA,eAAgB,CAAA,cAAe,CAAA,wCAAuB,YAAa,CAAA,sCAAqB,sBAAuB,CAAC',sourcesContent:[null,'@import"https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Teko:wght@500;600;700&display=swap";.settings-overlay{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.settings-panel{width:min(1080px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.settings-panel::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.settings-panel{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.panel-header{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 18px;border-bottom:2px solid #ffe100;background:rgba(0,0,0,.32)}.header-title{min-width:0}.header-title h3{margin:0;font-size:20px;line-height:1;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase}.header-title p{margin:4px 0 0;font-size:10px;color:#8d8d8d;letter-spacing:.14em;text-transform:uppercase}.close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.close-btn:disabled{opacity:.45;cursor:not-allowed}.close-btn{min-width:88px;height:32px;padding:0 10px;font-size:12px}.panel-main{flex:1;min-height:0;display:grid;grid-template-columns:220px 1fr}.panel-nav{border-right:1px solid hsla(0,0%,100%,.16);padding:12px;overflow:auto}.panel-nav::-webkit-scrollbar{width:7px;height:7px}.panel-nav::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav::-webkit-scrollbar-thumb{background:#555}.panel-nav::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.nav-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.nav-btn:disabled{opacity:.45;cursor:not-allowed}.nav-btn{width:100%;min-height:62px;padding:10px 12px;margin-bottom:10px;text-align:left;display:grid;grid-template-columns:auto 1fr;grid-template-areas:"idx label" "idx sub";column-gap:8px;row-gap:2px}.nav-btn:last-child{margin-bottom:0}.nav-btn.active{background:#ffe100;color:#000;border-color:#ffe100}.nav-index{grid-area:idx;align-self:center;font-family:"Oswald","Teko","Segoe UI",sans-serif;color:#00dac2;font-size:18px}.nav-label{grid-area:label;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px;letter-spacing:.05em}.nav-sub{grid-area:sub;font-size:10px;color:#8d8d8d;letter-spacing:.06em}.panel-body{padding:14px 18px 16px;overflow:auto}.panel-body::-webkit-scrollbar{width:7px;height:7px}.panel-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-body::-webkit-scrollbar-thumb{background:#555}.panel-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.setting-section{max-width:740px}.setting-section h4{margin:0 0 12px;display:inline-flex;align-items:center;gap:8px;padding:4px 12px;background:#0f0f0f;border-left:4px solid #ffe100;transform:skewX(-14deg)}.setting-section h4>*{transform:skewX(14deg)}.section-index{color:#00dac2;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:13px}.section-label{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:14px;letter-spacing:.04em}.section-sub{font-size:10px;color:#8d8d8d;letter-spacing:.06em}.form-group{margin-bottom:12px}.form-group>label{display:block;margin-bottom:5px;font-size:12px;color:#d5d5d5;line-height:1.35}.form-group>label>input[type=checkbox]{margin-right:8px;accent-color:#00dac2}.form-group input[type=text],.form-group input[type=password],.form-group input[type=number],.form-group select,.form-group textarea{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid #3b3b3b;border-bottom:2px solid #585858;border-radius:0;background:rgba(0,0,0,.56);color:#ffe100;font-family:"JetBrains Mono","Consolas","Courier New",monospace;font-size:13px;outline:none;transition:border-color .18s ease,background .18s ease}.form-group input[type=text]:focus,.form-group input[type=password]:focus,.form-group input[type=number]:focus,.form-group select:focus,.form-group textarea:focus{border-color:#ffe100;background:rgba(255,225,0,.08)}.form-group input[type=text]::placeholder,.form-group input[type=password]::placeholder,.form-group input[type=number]::placeholder,.form-group select::placeholder,.form-group textarea::placeholder{color:#8d8d8d}.form-group textarea{resize:vertical;min-height:86px;font-family:"JetBrains Mono","Consolas","Courier New",monospace;color:#fff}.form-group select{color:#fff;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif}.form-group select option{background:#101010;color:#fff}.form-group input[type=range]{width:100%;appearance:none;height:4px;border:none;background:#4a4a4a;border-radius:0;padding:0;margin:7px 0 4px}.form-group input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#ffe100;border:2px solid #000;transform:rotate(45deg)}.form-group input[type=range]::-moz-range-thumb{width:12px;height:12px;border:2px solid #000;border-radius:0;background:#ffe100;transform:rotate(45deg)}.form-group input[type=range]::-moz-range-track{height:4px;background:#4a4a4a;border:none}.form-group input[type=checkbox]{accent-color:#00dac2}.form-group .hint{margin-top:4px;font-size:11px;color:#8d8d8d}.hint-error{color:#ff3b30 !important}.form-row{display:flex;gap:12px;align-items:flex-start}.form-row .half{flex:1;min-width:0}.dice-sheet-list{margin-top:6px;display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:8px}.dice-sheet-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid hsla(0,0%,100%,.18);background:hsla(0,0%,100%,.04);font-size:12px;color:#e8e8e8;line-height:1.35}.dice-sheet-item input[type=checkbox]{margin:0}.input-with-btn{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch}.input-with-btn .input-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.input-with-btn .input-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.input-with-btn .input-btn:disabled{opacity:.45;cursor:not-allowed}.input-with-btn .input-btn{min-width:84px;padding:0 12px;font-size:11px;white-space:nowrap}.model-list{display:flex;flex-wrap:wrap;gap:8px}.model-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.model-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.model-btn:disabled{opacity:.45;cursor:not-allowed}.model-btn{min-height:30px;padding:0 12px;font-size:12px;text-transform:none;letter-spacing:.03em}.model-btn.active{background:#ffe100;border-color:#ffe100;color:#000}.model-btn.browse-btn{border-color:rgba(0,218,194,.55);color:#b2fff6}.model-btn.browse-btn:hover{background:#00dac2;border-color:#00dac2;color:#000}.emotion-layout{display:grid;grid-template-columns:minmax(0, 1fr) 340px;gap:14px;align-items:start}.emotion-configs{min-width:0}.emotion-preview-panel{position:sticky;top:10px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 12px;background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:18px 18px}.emotion-preview-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}.emotion-preview-title{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#00dac2}.emotion-preview-tag{font-size:12px;color:hsla(0,0%,100%,.78)}.emotion-preview-canvas{position:relative;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden;background:rgba(15,23,42,.95);border:1px solid hsla(0,0%,100%,.18)}.emotion-preview-interact{position:absolute;inset:0;z-index:3}.emotion-preview-empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;z-index:4;pointer-events:none;color:hsla(0,0%,100%,.78);font-size:12px}.emotion-preview-controls{margin-top:10px;display:flex;flex-direction:column;gap:8px}.emotion-zoom-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}.zoom-label{font-size:12px;color:hsla(0,0%,100%,.78)}.zoom-value{font-size:12px;color:#ffe100;font-variant-numeric:tabular-nums}.emotion-preview-actions{display:flex;gap:8px}.emotion-tag{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100;text-transform:uppercase}.emotion-map-table{margin-top:4px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.22);max-height:none;overflow:visible;background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:20px 20px}.emotion-map-head,.emotion-map-row{display:grid;grid-template-columns:72px 22px minmax(0, 1fr) minmax(0, 1fr) 52px;gap:10px;align-items:center}.emotion-map-head{position:sticky;top:0;z-index:2;padding:8px 10px;font-size:10px;color:hsla(0,0%,100%,.68);letter-spacing:.03em;background:rgba(2,8,20,.92);border-bottom:1px solid hsla(0,0%,100%,.2)}.emotion-map-row{padding:10px;border-bottom:1px solid hsla(0,0%,100%,.12)}.emotion-map-row:nth-child(odd){background:hsla(0,0%,100%,.02)}.emotion-map-tag{font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:700;letter-spacing:.08em;color:#ffe100}.emotion-map-arrow{text-align:center;color:hsla(0,0%,100%,.78);font-size:18px;line-height:1}.emotion-map-preview-btn{min-width:0;width:44px;height:32px;padding:0;font-size:14px;line-height:1}.emotion-map-row select{width:100%;min-width:0;text-overflow:ellipsis;white-space:nowrap}.emotion-advanced-list{margin-top:10px;display:flex;flex-direction:column;gap:10px}.emotion-advanced-item{border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.28);padding:10px 12px 2px;background-image:linear-gradient(rgba(255, 255, 255, 0.025) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.025) 1px, transparent 1px);background-size:18px 18px}.emotion-advanced-title{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:hsla(0,0%,100%,.85)}.advanced-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.04);font-size:11px;color:#d5d5d5;cursor:pointer;user-select:none;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%)}.advanced-toggle:hover{border-color:rgba(255,225,0,.65);color:#ffe100}.advanced-toggle .toggle-icon{width:12px;text-align:center;color:#00dac2}.advanced-params{margin-top:8px;padding-top:10px;border-top:1px dashed hsla(0,0%,100%,.2)}.about-card{margin-bottom:12px;padding:10px 12px;border:1px solid hsla(0,0%,100%,.16);background:rgba(0,0,0,.26);background-image:linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);background-size:18px 18px}.about-title{margin-bottom:8px;font-size:12px;letter-spacing:.06em;color:#ffe100}.about-link{color:#00dac2;word-break:break-all;text-decoration:underline}.about-list{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:8px;font-size:12px;line-height:1.5;color:#d5d5d5}.status-badge{margin-left:8px;font-size:12px}.status-success{color:#00dac2}.status-fail{color:#ff9c94}.panel-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 18px 14px;border-top:1px solid hsla(0,0%,100%,.18);background:rgba(0,0,0,.36)}.btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.btn:disabled{opacity:.45;cursor:not-allowed}.btn{min-width:100px;height:34px;padding:0 14px;font-size:12px}.btn-primary{background:#ffe100;color:#000;border-color:#ffe100}.btn-secondary{background:hsla(0,0%,100%,.06);border-color:hsla(0,0%,100%,.3)}.btn-test{min-width:96px;background:rgba(0,218,194,.1);border-color:rgba(0,218,194,.6);color:#bcfff7}.btn-test:hover:not(:disabled){background:#00dac2;border-color:#00dac2;color:#000}.browser-overlay{position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;overflow:auto}.browser-dialog{width:min(980px,100vw - 24px);max-height:calc(100dvh - 24px);display:flex;flex-direction:column;overflow:hidden;color:#fff;background:#181818;font-family:"Source Han Sans SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;position:relative;border:1px solid #3b3b3b;box-shadow:10px 10px 0 rgba(0,0,0,.62);clip-path:polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)}.browser-dialog::before{content:"";position:absolute;top:0;left:0;width:56px;height:2px;background:#ffe100;z-index:2}.browser-dialog{background-image:linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);background-size:22px 22px}.browser-dialog-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid rgba(255,225,0,.36);background:rgba(0,0,0,.28)}.browser-dialog-header h3{margin:0;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-size:15px;letter-spacing:.08em}.browser-dialog-header .close-btn{appearance:none;border:1px solid hsla(0,0%,100%,.24);background:rgba(0,0,0,0);color:#fff;font-family:"Oswald","Teko","Segoe UI",sans-serif;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);transition:background .18s ease,color .18s ease,border-color .18s ease}.browser-dialog-header .close-btn:hover:not(:disabled){background:#ffe100;color:#000;border-color:#ffe100}.browser-dialog-header .close-btn:disabled{opacity:.45;cursor:not-allowed}.browser-dialog-header .close-btn{width:34px;height:28px;padding:0;line-height:1;font-size:16px}.browser-dialog-body{padding:14px 18px 16px;overflow:auto;flex:1}.browser-dialog-body::-webkit-scrollbar{width:7px;height:7px}.browser-dialog-body::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.browser-dialog-body::-webkit-scrollbar-thumb{background:#555}.browser-dialog-body::-webkit-scrollbar-thumb:hover{background:#6f6f6f}@media(max-width: 860px){.settings-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.settings-panel{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.settings-panel::before{width:40px}.panel-main{grid-template-columns:1fr;grid-template-rows:auto 1fr;min-height:0}.panel-nav{border-right:none;border-bottom:1px solid hsla(0,0%,100%,.16);display:flex;gap:6px;padding:8px 10px;overflow-x:auto;overflow-y:hidden}.panel-nav::-webkit-scrollbar{width:7px;height:7px}.panel-nav::-webkit-scrollbar-track{background:hsla(0,0%,100%,.04)}.panel-nav::-webkit-scrollbar-thumb{background:#555}.panel-nav::-webkit-scrollbar-thumb:hover{background:#6f6f6f}.nav-btn{flex:0 0 auto;width:150px;min-height:42px;padding:6px 10px;margin-bottom:0;grid-template-areas:"idx label";grid-template-columns:auto 1fr;row-gap:0;align-items:center}.panel-body{min-height:0}.nav-index{font-size:16px}.nav-label{font-size:12px}.nav-sub{display:none}.browser-overlay{align-items:flex-start;padding:calc(env(safe-area-inset-top) + 6px) 6px calc(env(safe-area-inset-bottom) + 6px)}.browser-dialog{width:100%;max-height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);clip-path:none;box-shadow:0 0 0 1px hsla(0,0%,100%,.15)}.emotion-layout{grid-template-columns:1fr}.emotion-preview-panel{order:-1;position:sticky;top:8px;z-index:8;margin-bottom:8px;padding:8px 10px 10px;background:rgba(0,0,0,.9)}.emotion-preview-header{margin-bottom:6px}.emotion-preview-canvas{aspect-ratio:16/9;max-height:210px}.emotion-preview-controls{margin-top:8px;gap:6px}.emotion-map-head{position:static}.emotion-preview-controls .hint{display:none}}@media(max-width: 620px){.settings-overlay{align-items:stretch;padding:0}.settings-panel{width:100vw;max-height:100dvh;border-left:none;border-right:none;box-shadow:none}.panel-header{padding:10px 12px}.header-title h3{font-size:15px;letter-spacing:.06em}.header-title p{display:none}.panel-nav{padding:6px 8px}.nav-btn{width:126px;min-height:38px;padding:5px 8px}.nav-index{font-size:14px}.nav-label{font-size:11px;letter-spacing:.04em}.close-btn{min-width:66px;height:28px;padding:0 8px;font-size:11px}.panel-footer{padding:10px 12px calc(10px + env(safe-area-inset-bottom))}.panel-body{padding:8px 10px}.form-row{flex-direction:column;gap:0}.input-with-btn{grid-template-columns:1fr}.btn{min-width:86px}.emotion-preview-panel{top:6px;padding:8px}.emotion-preview-canvas{max-height:180px}.emotion-map-head,.emotion-map-row{grid-template-columns:56px 16px minmax(0, 1fr) minmax(0, 1fr) 42px;gap:6px}.emotion-map-row{padding:8px}.emotion-map-arrow{font-size:14px}.emotion-map-preview-btn{width:38px;height:30px;font-size:12px}.browser-overlay{align-items:stretch;padding:0}.browser-dialog{width:100vw;max-height:100dvh;box-shadow:none;clip-path:none}.browser-dialog-header{padding:12px}.browser-dialog-body{padding:10px 12px 12px}}'],sourceRoot:''}]);const s=i},908:(e,t,o)=>{var n=o(735);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,o(424).A)('266a4174',n,!1,{ssrId:!0})}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var o=r[e]={id:e,exports:{}};return a[e](o,o.exports,i),o.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var o in t)i.o(t,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const s=Vue,l='酒馆桌面宠物',c='https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js',A='https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',d='https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js',u='https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js',p=[{name:'Haru (Cubism 4)',path:'haru/haru_greeter_t03.model3.json'},{name:'Shizuku (Cubism 2)',path:'shizuku/shizuku.model.json'}],m=['毒舌吐槽','可爱卖萌','冷静分析','傲娇','自定义'],h=[{value:'user',label:'用户发送后评论'},{value:'ai',label:'AI回复后评论'},{value:'both',label:'同时评论'}],f=['默认','微笑','生气','难过','惊讶','嘲讽','害羞','思考','大笑','搞怪'],g=[{value:'openai',label:'OpenAI (兼容)'},{value:'claude',label:'Claude'},{value:'makersuite',label:'Google Gemini'},{value:'openrouter',label:'OpenRouter'}],b='https://cdn.jsdelivr.net/gh/Eikanya/Live2d-model@master/',x='https://raw.githubusercontent.com/Eikanya/Live2d-model/master/',y='shizuku/shizuku.model.json',C=.3,v={x:-1,y:-1},w=!0,B=!0,k=!0,S='ai',E='毒舌吐槽',T='',M=!1,N=!1,V=!0,P=3,D=60,I=10,U=!1,L=!1,W=!0,F=!1,O=150,R=.9,j=0,q=0,Y=1,G=0,H=-1,J=z;function X(e){return!!e&&'object'==typeof e&&!Array.isArray(e)}const K=new Set(f);function Q(e){const t=String(e||'').trim();return t&&K.has(t)?t:null}const Z={默认:['普通','normal','default','neutral','idle','base'],微笑:['开心','笑','smile','happy','joy','glad'],生气:['愤怒','angry','mad','rage'],难过:['伤心','sad','cry','sorrow','upset'],惊讶:['震惊','surprised','shock','amazed','wow'],嘲讽:['轻蔑','smirk','mock','sneer','tease','sarcastic'],害羞:['脸红','shy','blush','embarrassed','bashful'],思考:['疑惑','think','ponder','confused','wonder','curious'],大笑:['笑死','laugh','lol','haha','giggle','rofl'],搞怪:['调皮','wink','playful','silly','mischievous','fun']};function ee(e){const t=[],o=new Set;for(const n of Array.isArray(e)?e:[]){const e=String(n||'').trim();if(!e)continue;const a=e.toLowerCase();o.has(a)||(o.add(a),t.push(e))}return t}function te(){return f.map(e=>({tag:e,aliases:[...Z[e]??[]],ttsContext:'',live2dExpression:'',live2dMotion:{enabled:!0,group:'',index:0}}))}function oe(e){const t=new Map;for(const o of Array.isArray(e)?e:[]){if(!X(o))continue;const e=Q(o.tag);if(!e)continue;if(t.has(e))continue;const n=X(o.live2dMotion)?o.live2dMotion:{},a=!1!==n.enabled,r=String(n.group||'').trim(),i=Number(n.index),s=Number.isFinite(i)?Math.max(0,Math.floor(i)):0,l={tag:e,aliases:ee(Array.isArray(o.aliases)?o.aliases.map(e=>String(e||'').trim()).filter(Boolean):[]),ttsContext:String(o.ttsContext||'').trim(),live2dExpression:String(o.live2dExpression||'').trim(),live2dMotion:{enabled:a,group:r,index:s}};t.set(e,l)}const o=te();for(const e of o)t.has(e.tag)||t.set(e.tag,e);return f.map(e=>t.get(e)).map(e=>({tag:e.tag,aliases:ee(e.aliases),ttsContext:String(e.ttsContext||'').trim(),live2dExpression:String(e.live2dExpression||'').trim(),live2dMotion:{enabled:!1!==e.live2dMotion?.enabled,group:String(e.live2dMotion?.group||'').trim(),index:Number.isFinite(e.live2dMotion?.index)?Math.max(0,Math.floor(e.live2dMotion.index)):0}}))}function ne(e,t){for(const o of Array.isArray(t)?t:[])if(o?.tag===e)return o;return null}function ae(e,t){const o=String(e||'').trim();if(!o)return null;const n=Q(o);if(n)return n;const a=o.toLowerCase();for(const e of Array.isArray(t)?t:[]){const t=Array.isArray(e?.aliases)?e.aliases:[];for(const o of t)if(String(o||'').trim().toLowerCase()===a){const t=Q(e.tag);if(t)return t}}return null}function re(){try{const e=window.parent??window;if(e.console)return e.console}catch{}return console}function ie(...e){re().log(`[${l}]`,...e)}function se(...e){re().warn(`[${l}]`,...e)}function le(...e){re().error(`[${l}]`,...e)}function ce(e,t){if(!e||'object'!=typeof e)return;if(0===t.length)return;let o=e;for(let e=0;e<t.length-1;e++){const n=t[e];if(!o||'object'!=typeof o)return;o=o[n]}const n=t[t.length-1];o&&'object'==typeof o&&(Array.isArray(o)&&'number'==typeof n?o[n]=void 0:delete o[n])}function Ae(e){const t=(o=e)&&'object'==typeof o&&!Array.isArray(o)?e:{};var o;const a=de.safeParse(t);if(a.success)return a.data;const r=n(t);for(const e of a.error.issues)ce(r,e.path);const i=de.safeParse(r);return i.success?(se('检测到非法设置，已自动修正为默认值',a.error.issues),i.data):(le('设置解析失败，已回退默认值',a.error),de.parse({}))}const de=J.z.object({apiMode:J.z.enum(['custom','tavern']).default('tavern'),apiConfig:J.z.object({url:J.z.string().default(''),apiKey:J.z.string().default(''),model:J.z.string().default('gpt-4o-mini'),source:J.z.string().default('openai'),max_tokens:J.z.number().min(1).max(4096).default(O),temperature:J.z.number().min(0).max(2).default(R),frequency_penalty:J.z.number().min(-2).max(2).default(j),presence_penalty:J.z.number().min(-2).max(2).default(q),top_p:J.z.number().min(0).max(1).default(Y),top_k:J.z.number().min(0).max(500).default(G),usePresetSampling:J.z.boolean().default(!1),sendWorldInfo:J.z.boolean().default(!1)}).default({}),modelPath:J.z.string().default(y),useCdn:J.z.boolean().default(!0),petPosition:J.z.object({x:J.z.number().default(v.x),y:J.z.number().default(v.y)}).default({}),petScale:J.z.number().min(.1).max(3).default(C),autoMotionLoop:J.z.boolean().default(w),doubleTapRandomMotionEnabled:J.z.boolean().default(B),gazeFollowMouseEnabled:J.z.boolean().default(k),commentStyle:J.z.enum(m).default(E),commentTriggerMode:J.z.enum(['user','ai','both']).default(S),customPrompt:J.z.string().default(''),roleplayName:J.z.string().default(T),roleplayIgnoreCommentStyle:J.z.boolean().default(M),sendCharacterCardContent:J.z.boolean().default(N),autoTrigger:J.z.boolean().default(V),triggerInterval:J.z.number().min(1).max(100).default(P),triggerProbability:J.z.number().min(0).max(100).default(D),maxChatContext:J.z.number().min(1).max(50).default(I),bubbleDuration:J.z.number().min(-1).max(6e5).default(H),useTamakoTodaySpecial:J.z.boolean().default(U),useDiceDatabaseReference:J.z.boolean().default(L),diceReferenceVisibleSheets:J.z.array(J.z.string()).default([]),emotionCotEnabled:J.z.boolean().default(!0),emotionCotStripFromText:J.z.boolean().default(!0),emotionConfigs:J.z.array(J.z.object({tag:J.z.enum(f).default('榛樿'),aliases:J.z.array(J.z.string()).default([]),ttsContext:J.z.string().default(''),live2dExpression:J.z.string().default(''),live2dMotion:J.z.object({enabled:J.z.boolean().default(!0),group:J.z.string().default(''),index:J.z.number().min(0).max(999).default(0)}).default({})}).default({})).default([]),ttsProvider:J.z.enum(['littlewhitebox','gpt_sovits_v2','edge_tts_direct']).default('littlewhitebox'),ttsAutoPlay:J.z.boolean().default(!0),phoneMessageAutoRead:J.z.boolean().default(W),baibaiPhoneMessageAutoRead:J.z.boolean().default(F),ttsDefaultSpeaker:J.z.string().default(''),lipSyncManualParamsEnabled:J.z.boolean().default(!1),lipSyncManualParamIds:J.z.array(J.z.string()).default([]),gptSoVits:J.z.object({apiUrl:J.z.string().default('http://127.0.0.1:9880'),endpoint:J.z.string().default('/tts'),useCorsProxy:J.z.boolean().default(!0),mediaType:J.z.enum(['wav','ogg','raw']).default('wav'),streamingMode:J.z.boolean().default(!0),textLang:J.z.string().default('auto'),textSplitMethod:J.z.string().default('cut5'),speedFactor:J.z.number().min(.1).max(3).default(1),strictWeightSwitch:J.z.boolean().default(!1),probeOnAudioError:J.z.boolean().default(!1),modelSwitchMode:J.z.enum(['none','set_model','set_weights']).default('set_weights'),setModelEndpoint:J.z.string().default('/set_model'),importPathPrefix:J.z.string().default(''),voices:J.z.array(J.z.object({name:J.z.string().default(''),desc:J.z.string().default(''),refAudioPath:J.z.string().default(''),promptText:J.z.string().default(''),promptLang:J.z.string().default(''),textLang:J.z.string().default(''),gptWeightsPath:J.z.string().default(''),sovitsWeightsPath:J.z.string().default(''),modelSwitchMode:J.z.enum(['none','set_model','set_weights']).default('set_weights'),setModelEndpoint:J.z.string().default('/set_model')}).default({})).default([])}).default({})}).default({}),ue=t('desktop-pet-settings',()=>{const e=Ae(getVariables({type:'script',script_id:getScriptId()}));(e.modelPath.includes('live2d-widget-model/')||e.modelPath.includes('Live2D/Samples/'))&&(e.modelPath=y),e.emotionConfigs=oe(e.emotionConfigs);const t=Number(e.bubbleDuration);if(Number.isFinite(t)){const o=t>600?t/1e3:t;e.bubbleDuration=Math.round(Math.max(-1,Math.min(600,o)))}else e.bubbleDuration=H;const o=(0,s.ref)(e);return(0,s.watchEffect)(()=>{replaceVariables(n(o.value),{type:'script',script_id:getScriptId()})}),{settings:o,updateSettings:function(e){o.value=de.parse({...n(o.value),...e}),o.value.emotionConfigs=oe(o.value.emotionConfigs)},resetSettings:function(){const e=de.parse({});e.emotionConfigs=oe(e.emotionConfigs),o.value=e}}}),pe='speech.platform.bing.com/consumer/speech/synthesize/readaloud',me='6A5AA1D4EAFF4E9FB37E23D68491D6F4',he=`wss://${pe}/edge/v1?TrustedClientToken=${me}`,fe=`https://${pe}/voices/list?trustedclienttoken=${me}`;let ge=0;const be=[{shortName:'zh-CN-XiaoxiaoNeural',locale:'zh-CN',gender:'Female'},{shortName:'zh-CN-YunxiNeural',locale:'zh-CN',gender:'Male'},{shortName:'zh-CN-YunyangNeural',locale:'zh-CN',gender:'Male'},{shortName:'zh-CN-XiaoyiNeural',locale:'zh-CN',gender:'Female'},{shortName:'en-US-JennyNeural',locale:'en-US',gender:'Female'},{shortName:'en-US-AriaNeural',locale:'en-US',gender:'Female'},{shortName:'en-US-GuyNeural',locale:'en-US',gender:'Male'},{shortName:'ja-JP-NanamiNeural',locale:'ja-JP',gender:'Female'},{shortName:'ja-JP-KeitaNeural',locale:'ja-JP',gender:'Male'}];function xe(e='Aborted'){try{return new DOMException(e,'AbortError')}catch{const t=new Error(e);return t.name='AbortError',t}}function ye(){const e=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(e);else for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e[6]=15&e[6]|64,e[8]=63&e[8]|128,Array.from(e,e=>e.toString(16).padStart(2,'0')).join('')}function Ce(e){let t='';for(let o=0;o<e.length;o++){const n=e.charCodeAt(o);t+=n>=0&&n<=8||11===n||12===n||n>=14&&n<=31?' ':e[o]}return t}function ve(e){return'string'==typeof e?e.trim():String(e.value||e.name||'').trim()}async function we(e){const t=(new TextEncoder).encode(e),o=globalThis.crypto?.subtle;if(o?.digest)try{const e=await o.digest('SHA-256',t);return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,'0')).join('').toUpperCase()}catch{}return function(e){const t=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),o=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),n=e.length+1,a=64*Math.ceil((n+8)/64),r=new Uint8Array(a);r.set(e),r[e.length]=128;const i=8*e.length,s=Math.floor(i/4294967296),l=i>>>0;r[a-8]=s>>>24&255,r[a-7]=s>>>16&255,r[a-6]=s>>>8&255,r[a-5]=255&s,r[a-4]=l>>>24&255,r[a-3]=l>>>16&255,r[a-2]=l>>>8&255,r[a-1]=255&l;const c=new Uint32Array(64);for(let e=0;e<r.length;e+=64){for(let t=0;t<16;t++){const o=e+4*t;c[t]=(r[o]<<24|r[o+1]<<16|r[o+2]<<8|r[o+3])>>>0}for(let e=16;e<64;e++){const t=Be(c[e-15],7)^Be(c[e-15],18)^c[e-15]>>>3,o=Be(c[e-2],17)^Be(c[e-2],19)^c[e-2]>>>10;c[e]=c[e-16]+t+c[e-7]+o>>>0}let n=o[0],a=o[1],i=o[2],s=o[3],l=o[4],A=o[5],d=o[6],u=o[7];for(let e=0;e<64;e++){const o=u+(Be(l,6)^Be(l,11)^Be(l,25))+(l&A^~l&d)+t[e]+c[e]>>>0,r=n&a^n&i^a&i;u=d,d=A,A=l,l=s+o>>>0,s=i,i=a,a=n,n=o+((Be(n,2)^Be(n,13)^Be(n,22))+r>>>0)>>>0}o[0]=o[0]+n>>>0,o[1]=o[1]+a>>>0,o[2]=o[2]+i>>>0,o[3]=o[3]+s>>>0,o[4]=o[4]+l>>>0,o[5]=o[5]+A>>>0,o[6]=o[6]+d>>>0,o[7]=o[7]+u>>>0}return Array.from(o).map(e=>e.toString(16).padStart(8,'0')).join('').toUpperCase()}(t)}function Be(e,t){return(e>>>t|e<<32-t)>>>0}async function ke(){try{let e=Date.now()/1e3+ge;e+=11644473600,e-=e%300,e*=1e7;return{security:{secMsGec:await we(`${e.toFixed(0)}${me}`),secMsGecVersion:'1-143.0.3537.57'},error:''}}catch(e){return{security:null,error:e instanceof Error?e.message:String(e)}}}function Se(e){const t=String(e.ShortName||'').trim();if(!t)return null;const o=String(e.Locale||'').trim(),n=String(e.Gender||'').trim();return{name:t,value:t,source:'edge_tts_direct',resourceId:null,desc:[String(e.FriendlyName||'').trim(),o,n].filter(Boolean).join(' | ')||'EdgeTTS Direct'}}async function _e(e){const t=await fetch(e,{headers:{Accept:'*/*','Accept-Language':'en-US,en;q=0.9'}}),o=function(e){const t=e.headers.get('date')||e.headers.get('Date');if(!t)return null;const o=new Date(t).getTime();return Number.isFinite(o)?o/1e3:null}(t);if(null!==o){const e=Date.now()/1e3+ge;ge+=o-e}if(!t.ok)throw new Error(`EdgeTTS voices request failed (HTTP ${t.status})`);const n=await t.json();if(!Array.isArray(n))throw new Error('EdgeTTS voices response is not an array');return function(e){const t=new Set,o=[];for(const n of e){const e=String(n.value||n.name||'').trim().toLowerCase();e&&!t.has(e)&&(t.add(e),o.push(n))}return o.sort((e,t)=>e.name.localeCompare(t.name))}(n.map(Se).filter(Boolean))}function Ee(){return be.map(e=>({name:e.shortName,value:e.shortName,source:'edge_tts_direct',resourceId:null,desc:`${e.locale} | ${e.gender}`}))}async function Te(e,t,o,n,a,r){const i=Number.isFinite(n.timeoutMs)?Math.max(3e3,Number(n.timeoutMs)):25e3;return new Promise((s,l)=>{let c=!1,A=null,d=null;const u=[];let p=!1,m=!1,h=0,f='',g=!1;const b=e=>{c||(c=!0,null!==d&&window.clearTimeout(d),A&&(A.onopen=null,A.onmessage=null,A.onerror=null,A.onclose=null),n.onSocket?.(null),n.signal&&n.signal.removeEventListener('abort',y),e())},x=e=>{b(()=>l(e instanceof Error?e:new Error(String(e))))},y=()=>{try{A?.close(1e3,'abort')}catch{}x(xe('EdgeTTS direct synthesis aborted'))};n.signal?.aborted?x(xe('EdgeTTS direct synthesis aborted')):(n.signal&&n.signal.addEventListener('abort',y,{once:!0}),A=new WebSocket(e),A.binaryType='arraybuffer',n.onSocket?.(A),d=window.setTimeout(()=>{try{A?.close(1013,'timeout')}catch{}x(new Error(`EdgeTTS direct websocket timeout (${r})`))},i),A.onopen=()=>{m=!0;const e=function(e='utc_string'){const t=new Date;return'iso_compact'===e?t.toISOString().replace(/[-:.]/g,'').slice(0,-1):t.toUTCString().replace('GMT','GMT+0000 (Coordinated Universal Time)')}(a);A?.send(function(e){return`X-Timestamp:${e}\r\nContent-Type:application/json; charset=utf-8\r\nPath:speech.config\r\n\r\n{"context":{"synthesis":{"audio":{"metadataoptions":{"sentenceBoundaryEnabled":"false","wordBoundaryEnabled":"true"},"outputFormat":"audio-24khz-48kbitrate-mono-mp3"}}}}\r\n`}(e)),A?.send(function(e,t,o){return`X-RequestId:${e}\r\nContent-Type:application/ssml+xml\r\nX-Timestamp:${t}Z\r\nPath:ssml\r\n\r\n${o}`}(ye(),e,function(e,t){const o=ve(t),n=function(e){return e.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;')}(Ce(String(e||'')));return`<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='en-US'><voice name='${o}'><prosody pitch='+0Hz' rate='+0%' volume='+0%'>${n}</prosody></voice></speak>`}(t,o)))},A.onmessage=e=>{if(c)return;if('string'==typeof e.data){const t=function(e){const t=e.indexOf('\r\n\r\n'),o=t>=0?e.slice(0,t):e,n={};for(const e of o.split('\r\n')){const t=e.indexOf(':');t<=0||(n[e.slice(0,t)]=e.slice(t+1).trim())}return n}(e.data);if('turn.end'===String(t.Path||t.path||'').toLowerCase())try{A?.close(1e3,'turn.end')}catch{}return}(async()=>{const t=e.data;let o=null;if(t instanceof ArrayBuffer?o=new Uint8Array(t):ArrayBuffer.isView(t)?o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof Blob&&(o=new Uint8Array(await t.arrayBuffer())),!o||o.length<2)return;const{headers:n,payload:a}=function(e){if(e.length<2)return{headers:{},payload:new Uint8Array(0)};const t=e[0]<<8|e[1];if(t<=0||t+2>e.length)return{headers:{},payload:e.slice(2)};const o={},n=e.slice(2,t+2),a=(new TextDecoder).decode(n);for(const e of a.split('\r\n')){const t=e.indexOf(':');t<=0||(o[e.slice(0,t)]=e.slice(t+1).trim())}return{headers:o,payload:e.slice(t+2)}}(o);if('audio'!==String(n.Path||n.path||'').toLowerCase())return;const r=String(n['Content-Type']||n['content-type']||'').toLowerCase();r&&!r.startsWith('audio/')||a.length>0&&u.push(a)})().catch(x)},A.onerror=()=>{p=!0},A.onclose=e=>{if(h=e.code,f=String(e.reason||'').trim(),g=!!e.wasClean,c)return;if(n.signal?.aborted)return void x(xe('EdgeTTS direct synthesis aborted'));if(u.length<=0)return void x(new Error(`No audio frame received from EdgeTTS direct websocket (${r}; code=${h}, clean=${g}, opened=${m}, errorEvent=${p}, reason=${f||'n/a'})`));const t=function(e){if(0===e.length)return new Uint8Array(0);if(1===e.length)return e[0];const t=e.reduce((e,t)=>e+t.length,0),o=new Uint8Array(t);let n=0;for(const t of e)o.set(t,n),n+=t.length;return o}(u),o=new Blob([t],{type:'audio/mpeg'});b(()=>s(o))})})}const Me={LITTLEWHITEBOX:'littlewhitebox',GPT_SOVITS_V2:'gpt_sovits_v2',EDGE_TTS_DIRECT:'edge_tts_direct'};function Ne(){try{return window.parent??window}catch{return window}}function Ve(){try{if('function'==typeof getScriptId){const e=String(getScriptId()??'').trim();if(e)return e}}catch{}return l}function Pe(){return`${Ve()}_tts_enabled`}function De(){return`${Ve()}_char_tts_voice`}function $e(e){const t=String(e||'').trim().toLowerCase();return'none'===t||'off'===t||'disabled'===t?'none':'set_model'===t||'model'===t?'set_model':'set_weights'}function Ie(e){const t=String(e||'').trim();return t?t.startsWith('/')?t:`/${t}`:'/set_model'}function Ue(){try{return ue().settings.ttsProvider||Me.LITTLEWHITEBOX}catch{return Me.LITTLEWHITEBOX}}function Le(){const e={apiUrl:'http://127.0.0.1:9880',endpoint:'/tts',useCorsProxy:!0,mediaType:'wav',streamingMode:!1,textLang:'auto',textSplitMethod:'cut5',speedFactor:1,strictWeightSwitch:!1,probeOnAudioError:!1,modelSwitchMode:'set_weights',setModelEndpoint:'/set_model',importPathPrefix:'',voices:[]};try{const t=ue().settings.gptSoVits||{};return Object.assign(Object.assign({},e),t,{modelSwitchMode:$e(t.modelSwitchMode||e.modelSwitchMode),setModelEndpoint:Ie(t.setModelEndpoint||e.setModelEndpoint),voices:Array.isArray(t.voices)?t.voices:e.voices})}catch{return e}}function ze(e){if(!e)return null;const t=e?.gptSoVits||{},o=String(e.name||e.voice||e.speaker||t.name||'').trim();if(!o)return null;const n=String(e.refAudioPath||e.ref_audio_path||e.ref_audio||e.ref||t.refAudioPath||'').trim(),a=String(e.promptText||e.prompt_text||t.promptText||'').trim(),r=String(e.promptLang||e.prompt_lang||t.promptLang||'').trim(),i=String(e.textLang||e.text_lang||t.textLang||'').trim(),s=String(e.gptWeightsPath||e.gpt_weights_path||e.gptPath||e.gpt||t.gptWeightsPath||'').trim(),l=String(e.sovitsWeightsPath||e.sovits_weights_path||e.sovitsPath||e.sovits||t.sovitsWeightsPath||'').trim(),c=$e(e.modelSwitchMode||e.model_switch_mode||t.modelSwitchMode||''),A=Ie(e.setModelEndpoint||e.set_model_endpoint||t.setModelEndpoint||'/set_model'),d=String(e.desc||e.description||'').trim();return{name:o,value:o,source:Me.GPT_SOVITS_V2,resourceId:null,desc:d||'GPT-SoVITS',gptSoVits:{refAudioPath:n,promptText:a,promptLang:r,textLang:i,gptWeightsPath:s,sovitsWeightsPath:l,modelSwitchMode:c,setModelEndpoint:A}}}function We(e,t=null){const o=ze(e);if(!o)return null;const n=o.gptSoVits||{},a=t||Le(),r=String(e?.desc||e?.description||'').trim();return{name:o.name,desc:r,refAudioPath:String(n.refAudioPath||'').trim(),promptText:String(n.promptText||'').trim(),promptLang:String(n.promptLang||'').trim(),textLang:String(n.textLang||'').trim(),gptWeightsPath:String(n.gptWeightsPath||'').trim(),sovitsWeightsPath:String(n.sovitsWeightsPath||'').trim(),modelSwitchMode:$e(n.modelSwitchMode||a.modelSwitchMode),setModelEndpoint:Ie(n.setModelEndpoint||a.setModelEndpoint)}}function Fe(e){const t=We(e);return!!String(t?.refAudioPath||'').trim()}function Oe(e){for(const t of Array.isArray(e)?e:[])if(Fe(t))return t;return null}function Re(){try{const e=Le();return(Array.isArray(e.voices)?e.voices:[]).map(ze).filter(Boolean)}catch{return[]}}let je=null,qe=0;let Ye=null,Ge=0;async function He(){const e=Date.now();if(Ye&&e-Ge<=12e4)return Ye;try{const t=await async function(){const e=await ke(),t=e.security,o=[];t&&o.push(`${fe}&Sec-MS-GEC=${encodeURIComponent(t.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(t.secMsGecVersion)}`),o.push(fe);let n=null;for(const e of o)try{const t=await _e(e);if(t.length>0)return t;n=new Error('EdgeTTS voices response is empty')}catch(e){n=e}if(!t&&e.error){const t=n instanceof Error?n.message:String(n||'unknown');throw new Error(`EdgeTTS voices request failed. security-unavailable: ${e.error}; last: ${t}`)}throw n instanceof Error?n:new Error('EdgeTTS voices request failed')}();if(t.length>0)return Ye=t,Ge=e,t}catch(e){console.warn(`[${l}] EdgeTTS 直连音色拉取失败，使用本地兜底:`,e)}const t=Ee();return Ye=t,Ge=e,t}async function Je(){const e=Ue();if(e===Me.GPT_SOVITS_V2)return async function(){const e=Le();return(Array.isArray(e.voices)?e.voices:[]).map(ze).filter(Boolean)}();if(e===Me.EDGE_TTS_DIRECT)return He();const t=Date.now();if(!je||t-qe>5e3){const e=await async function(){try{const e=await fetch('/user/files/LittleWhiteBox_TTS.json',{cache:'no-cache'});if(!e.ok)return null;const t=await e.json();return t?.volc?.mySpeakers||null}catch(e){return console.log(`[${l}] 获取 LittleWhiteBox TTS 配置失败:`,e),null}}();if(e&&e.length>0)return je=e.map(e=>({name:e.name,value:e.value,source:e.source||(Xe(e.value)?'free':'auth'),resourceId:e.resourceId||Qe(e.value),desc:Ze(e.value)})),qe=t,je}else if(je)return je;const o=Ne(),n=o?.xiaobaixTts||window?.xiaobaixTts;if(n?.getConfig){const e=n.getConfig(),t=e?.volc?.mySpeakers||[];if(t.length>0)return t.map(e=>({name:e.name,value:e.value,source:e.source||(Xe(e.value)?'free':'auth'),resourceId:e.resourceId||Qe(e.value),desc:Ze(e.value)}))}const a=o?.XB_TTS_VOICE_DATA||window?.XB_TTS_VOICE_DATA;return Array.isArray(a)&&a.length>0?a.slice(0,20).map(e=>({name:e.name,value:e.value,source:Ke(e.value),resourceId:Qe(e.value),desc:e.scene||'预设音色'})):[{name:'桃夭',value:'female_1',source:'free',resourceId:null,desc:'温柔少女(免费)'},{name:'夜枭',value:'male_1',source:'free',resourceId:null,desc:'沉稳男声(免费)'},{name:'霜华',value:'female_2',source:'free',resourceId:null,desc:'清冷女声(免费)'},{name:'顾姐',value:'female_3',source:'free',resourceId:null,desc:'成熟御姐(免费)'},{name:'苏菲',value:'female_4',source:'free',resourceId:null,desc:'元气少女(免费)'},{name:'嘉欣',value:'female_5',source:'free',resourceId:null,desc:'甜美声线(免费)'},{name:'青梅',value:'female_6',source:'free',resourceId:null,desc:'邻家女孩(免费)'},{name:'可莉',value:'female_7',source:'free',resourceId:null,desc:'活泼萝莉(免费)'},{name:'君泽',value:'male_2',source:'free',resourceId:null,desc:'儒雅公子(免费)'},{name:'沐阳',value:'male_3',source:'free',resourceId:null,desc:'阳光少年(免费)'},{name:'梓辛',value:'male_4',source:'free',resourceId:null,desc:'磁性低音(免费)'}]}function Xe(e){return['female_1','female_2','female_3','female_4','female_5','female_6','female_7','male_1','male_2','male_3','male_4'].includes(e)}function Ke(e){return Xe(e)?'free':'auth'}function Qe(e){const t=(e||'').toLowerCase();return t.startsWith('icl_')||t.startsWith('s_')?'seed-icl-2.0':t.startsWith('saturn_')||t.startsWith('uranus_')||t.includes('_saturn_')||t.includes('_uranus_')?'seed-tts-2.0':'seed-tts-1.0'}function Ze(e){return{female_1:'温柔少女(免费)',female_2:'清冷女声(免费)',female_3:'成熟御姐(免费)',female_4:'元气少女(免费)',female_5:'甜美声线(免费)',female_6:'邻家女孩(免费)',female_7:'活泼萝莉(免费)',male_1:'沉稳男声(免费)',male_2:'儒雅公子(免费)',male_3:'阳光少年(免费)',male_4:'磁性低音(免费)'}[e]||'自定义音色'}try{Object.defineProperty(Ne(),'TTS_VOICE_LIST',{get:function(){const e=Ue();if(e===Me.GPT_SOVITS_V2)return Re();if(e===Me.EDGE_TTS_DIRECT)return Ye&&Ye.length>0?Ye:Ee();if(je)return je;const t=Ne(),o=t?.xiaobaixTts||window?.xiaobaixTts;if(o?.getConfig){const e=o.getConfig(),t=e?.volc?.mySpeakers||[];if(t.length>0)return t.map(e=>({name:e.name,value:e.value,source:e.source||(Xe(e.value)?'free':'auth'),resourceId:e.resourceId||Qe(e.value),desc:Ze(e.value)}))}const n=t?.XB_TTS_VOICE_DATA||window?.XB_TTS_VOICE_DATA;return Array.isArray(n)&&n.length>0?n.slice(0,20).map(e=>({name:e.name,value:e.value,source:Ke(e.value),resourceId:Qe(e.value),desc:e.scene||'预设音色'})):[{name:'桃夭',value:'female_1',source:'free',resourceId:null,desc:'温柔少女(免费)'},{name:'夜枭',value:'male_1',source:'free',resourceId:null,desc:'沉稳男声(免费)'},{name:'霜华',value:'female_2',source:'free',resourceId:null,desc:'清冷女声(免费)'},{name:'顾姐',value:'female_3',source:'free',resourceId:null,desc:'成熟御姐(免费)'},{name:'苏菲',value:'female_4',source:'free',resourceId:null,desc:'元气少女(免费)'},{name:'嘉欣',value:'female_5',source:'free',resourceId:null,desc:'甜美声线(免费)'},{name:'青梅',value:'female_6',source:'free',resourceId:null,desc:'邻家女孩(免费)'},{name:'可莉',value:'female_7',source:'free',resourceId:null,desc:'活泼萝莉(免费)'},{name:'君泽',value:'male_2',source:'free',resourceId:null,desc:'儒雅公子(免费)'},{name:'沐阳',value:'male_3',source:'free',resourceId:null,desc:'阳光少年(免费)'},{name:'梓辛',value:'male_4',source:'free',resourceId:null,desc:'磁性低音(免费)'}]},configurable:!0})}catch{}function et(){try{const e=localStorage.getItem(Pe());return null===e||'true'===e}catch{return!0}}const tt={_READY_MARK:'__desktopPetLive2dLoaderReady_v2',_RUNTIME_KEY:'__desktopPetLive2dRuntime_v2',_JSDELIVR_HOSTS:['cdn.jsdelivr.net','fastly.jsdelivr.net','testingcf.jsdelivr.net','gcore.jsdelivr.net'],isLoaded:!1,loadPromise:null,async load(){const e=window.parent??window;if(this.isLoaded){if(this._getRuntime(e))return!0;se('检测到 Live2D runtime 已失效，准备重新加载 SDK（可能被其他插件覆盖 PIXI）'),this.isLoaded=!1,this.loadPromise=null}return this._getRuntime(e)?(this.isLoaded=!0,e[this._READY_MARK]=!0,this.loadPromise=null,!0):(this.loadPromise||(this.loadPromise=this._doLoad()),this.loadPromise)},getRuntime(e){const t=e??window.parent??window;return this._getRuntime(t)},getPixi(e){return this.getRuntime(e)?.pixi??null},_getRuntime(e){const t=e[this._RUNTIME_KEY];if(!t||'object'!=typeof t)return null;const o=t.pixi,n=t.live2dModel;if(!o||!n)return null;return 6!==this._getPixiMajorVersion(o)||e.PIXI!==o||o?.live2d?.Live2DModel!==n?null:t},_setRuntime(e){const t=e.PIXI,o=t?.live2d?.Live2DModel;if(6!==this._getPixiMajorVersion(t)||!o)return null;const n={pixi:t,live2dModel:o,pixiVersion:String(t?.VERSION||'unknown'),loadedAt:Date.now()};return e[this._RUNTIME_KEY]=n,n},async _doLoad(){const e=window.parent??window;try{if(this._getRuntime(e))return this.isLoaded=!0,e[this._READY_MARK]=!0,this.loadPromise=null,!0;const t=e.PIXI,o=this._getPixiMajorVersion(t);if(t&&6===o||(t&&null!==o&&6!==o&&se('检测到已存在的 PIXI 版本不兼容，将尝试覆盖加载 PIXI v6',{detected:t.VERSION??'unknown'}),ie('加载 PIXI.js...'),await this._loadScriptWithFallback(c,e,'PIXI.js'),ie('PIXI.js 加载完成')),e.window.PIXI||(e.window.PIXI=e.PIXI),!this._hasValidCubism4Core(e)){e.Live2DCubismCore&&se('检测到 Cubism 4 Core 全局对象异常，尝试重新加载'),ie('加载 Cubism 4 Core...');try{await this._loadScriptWithFallback(A,e,'Cubism 4 Core',2e4),ie('Cubism 4 Core 加载完成')}catch(e){se('Cubism 4 Core 加载失败，部分模型可能不可用',e)}}if(!e.Live2D){ie('加载 Cubism 2 Core...');try{await this._loadScriptWithFallback(d,e,'Cubism 2 Core',2e4),ie('Cubism 2 Core 加载完成')}catch(e){se('Cubism 2 Core 加载失败，旧模型可能不可用',e)}}ie('加载 pixi-live2d-display...'),await this._loadScriptWithFallback(u,e,'pixi-live2d-display',25e3),await new Promise(e=>setTimeout(e,120));const n=this._setRuntime(e);if(!n)throw new Error('pixi-live2d-display 加载完成但未建立桌面宠物专属运行时');return this.isLoaded=!0,e[this._READY_MARK]=!0,this.loadPromise=null,ie('Live2D SDK 全部加载完成',{pixi:n.pixiVersion}),!0}catch(t){return le('Live2D SDK 加载失败:',t),e[this._READY_MARK]=!1,e[this._RUNTIME_KEY]=null,this.isLoaded=!1,this.loadPromise=null,!1}},_getPixiMajorVersion(e){if(!e||'object'!=typeof e)return null;const t=String(e.VERSION||'').trim();if(!t)return null;const o=t.split('.')[0],n=Number.parseInt(o,10);return Number.isFinite(n)?n:null},_buildUrlCandidates(e){const t=String(e||'').trim();if(!t)return[];const o=[],n=e=>{const t=String(e||'').trim();t&&(o.includes(t)||o.push(t))};let a;n(t);try{a=new URL(t)}catch{return o}if(a.hostname.toLowerCase().endsWith('jsdelivr.net')){for(const e of this._JSDELIVR_HOSTS)try{const o=new URL(t);o.hostname=e,n(o.toString())}catch{}if(a.pathname.startsWith('/npm/'))try{const e=new URL(t);e.hostname='unpkg.com',e.pathname=a.pathname.replace(/^\/npm\//,'/'),n(e.toString())}catch{}if(a.pathname.startsWith('/gh/')){const e=a.pathname.slice(4).split('/').filter(Boolean);if(e.length>=3){const t=e[0],o=e[1],r=e.slice(2).join('/');if(t&&o&&r){const[e,i]=o.split('@'),s=`${a.search||''}${a.hash||''}`;i?n(`https://raw.githubusercontent.com/${t}/${e}/${i}/${r}${s}`):(n(`https://raw.githubusercontent.com/${t}/${e}/master/${r}${s}`),n(`https://raw.githubusercontent.com/${t}/${e}/main/${r}${s}`))}}}}return o},_hasValidCubism4Core(e){const t=e.Live2DCubismCore;if(!t||'object'!=typeof t)return!1;const o='function'==typeof t.Version,n='function'==typeof t.Moc||'object'==typeof t.Moc,a='object'==typeof t.Utils;return o||n||a},_loadScriptBySrc:(e,t,o=15e3)=>new Promise((n,a)=>{let r=null;try{const i=t.document,s=i.createElement('script');s.src=e,s.async=!0,s.dataset.desktopPetSdk='true';const l=()=>{s.onload=null,s.onerror=null,null!==r&&(t.clearTimeout(r),r=null)};s.onload=()=>{l(),n()},s.onerror=()=>{l(),a(new Error(`脚本加载失败: ${e}`))},r=t.setTimeout(()=>{l(),a(new Error(`脚本加载超时 (${o}ms): ${e}`))},o),i.head.appendChild(s)}catch(e){null!==r&&t.clearTimeout(r),a(e)}}),async _loadScriptWithFallback(e,t,o,n=15e3){const a=this._buildUrlCandidates(e);let r=null;for(let e=0;e<a.length;e++){const i=a[e];try{return e>0&&se(`${o} 主地址加载失败，尝试备用地址:`,i),await this._loadScriptBySrc(i,t,n),i}catch(e){r=e}}throw r instanceof Error?r:new Error(`${o} 加载失败`)}},ot={longPressDelay:500,doubleClickWindow:300,moveThreshold:8};class nt{element;config;onGesture;isDraggingCheck;state='idle';startPos={x:0,y:0};longPressTimer=null;doubleClickTimer=null;longPressFired=!1;moved=!1;activePointerId=null;destroyed=!1;boundPointerDown;boundPointerMove;boundPointerUp;boundContextMenu;constructor(e,t,o,n=()=>!1){this.element=e,this.config={...ot,moveThreshold:'ontouchstart'in window||navigator.maxTouchPoints>0?12:8,...t},this.onGesture=o,this.isDraggingCheck=n,this.boundPointerDown=this.handlePointerDown.bind(this),this.boundPointerMove=this.handlePointerMove.bind(this),this.boundPointerUp=this.handlePointerUp.bind(this),this.boundContextMenu=e=>e.preventDefault(),e.addEventListener('pointerdown',this.boundPointerDown),e.addEventListener('pointermove',this.boundPointerMove),e.addEventListener('pointerup',this.boundPointerUp),e.addEventListener('pointercancel',this.boundPointerUp),e.addEventListener('contextmenu',this.boundContextMenu)}destroy(){this.destroyed=!0,this.clearAllTimers(),this.element.removeEventListener('pointerdown',this.boundPointerDown),this.element.removeEventListener('pointermove',this.boundPointerMove),this.element.removeEventListener('pointerup',this.boundPointerUp),this.element.removeEventListener('pointercancel',this.boundPointerUp),this.element.removeEventListener('contextmenu',this.boundContextMenu)}handlePointerDown(e){this.destroyed||('touch'!==e.pointerType||!1!==e.isPrimary?null!==this.activePointerId&&e.pointerId!==this.activePointerId||(this.activePointerId=e.pointerId,this.startPos={x:e.clientX,y:e.clientY},this.longPressFired=!1,this.moved=!1,'wait-double'!==this.state&&(this.state='pending',this.clearLongPressTimer(),this.longPressTimer=window.setTimeout(()=>{'pending'!==this.state||this.moved||this.isDraggingCheck()||(this.longPressFired=!0,this.state='idle',this.onGesture({type:'long-press',clientX:this.startPos.x,clientY:this.startPos.y}))},this.config.longPressDelay))):this.resetState())}handlePointerMove(e){if(this.destroyed||'pending'!==this.state)return;if(this.activePointerId!==e.pointerId)return;const t=e.clientX-this.startPos.x,o=e.clientY-this.startPos.y;Math.sqrt(t*t+o*o)>this.config.moveThreshold&&(this.moved=!0,this.clearLongPressTimer(),this.state='idle')}handlePointerUp(e){if(!this.destroyed&&this.activePointerId===e.pointerId)if(this.activePointerId=null,this.clearLongPressTimer(),this.moved||this.isDraggingCheck())this.state='idle';else if(this.longPressFired)this.state='idle';else{if('wait-double'===this.state)return this.clearDoubleClickTimer(),this.state='idle',void this.onGesture({type:'double-tap',clientX:e.clientX,clientY:e.clientY});if('pending'===this.state&&!this.moved){this.state='wait-double';const t=e.clientX,o=e.clientY;this.doubleClickTimer=window.setTimeout(()=>{this.state='idle',this.onGesture({type:'tap',clientX:t,clientY:o})},this.config.doubleClickWindow)}}}resetState(){this.activePointerId=null,this.longPressFired=!1,this.moved=!1,this.state='idle',this.clearAllTimers()}clearLongPressTimer(){null!==this.longPressTimer&&(window.clearTimeout(this.longPressTimer),this.longPressTimer=null)}clearDoubleClickTimer(){null!==this.doubleClickTimer&&(window.clearTimeout(this.doubleClickTimer),this.doubleClickTimer=null)}clearAllTimers(){this.clearLongPressTimer(),this.clearDoubleClickTimer()}}const at={app:null,canvas:null,glContext:null,container:null,mountStack:[],mountMode:'floating',_pendingFloatingResize:null,loadingOverlay:null,loadingText:null,loadingBarFill:null,interactionLayer:null,gestureRecognizer:null,_dragClass:'desktop-pet-dragging',_minVisiblePx:48,_interactionPaddingPx:14,_alphaHitThreshold:10,_maxPixelScanSamples:36e4,_onPositionChange:null,_boundWindowResize:null,_interactionSyncTimer:null,_pixelReadBuffer:null,_lastClampLogAt:0,_clampPosition(e,t,o,n,a=0){const r=this._top(),i=r.innerWidth||r.document.documentElement.clientWidth||o,s=r.innerHeight||r.document.documentElement.clientHeight||n,l=Number.isFinite(o)&&o>0?o:i,c=Number.isFinite(n)&&n>0?n:s,A=Math.max(0,Math.min(a,l,i)),d=Math.max(0,Math.min(a,c,s)),u=Math.min(0,-l+A),p=Math.min(0,-c+d),m=Math.max(0,i-A),h=Math.max(0,s-d),f=Number.isFinite(e)?e:0,g=Number.isFinite(t)?t:0,b=Math.min(Math.max(f,u),m),x=Math.min(Math.max(g,p),h);return{x:b,y:x,clamped:b!==f||x!==g}},_shouldClampCurrentPosition(){if(!this.container)return!1;if('preview'===this.mountMode)return!1;const e='auto'===this.container.style.right||'auto'===this.container.style.bottom,t=!!this.container.style.left||!!this.container.style.top;return e||t},_getContainerRectSize(e){const t=this.container?.getBoundingClientRect?.();return{width:t?.width&&t.width>0?t.width:e.width,height:t?.height&&t.height>0?t.height:e.height}},_isRectFullyOutsideViewport(e){const t=this._top(),o=t.innerWidth||t.document.documentElement.clientWidth||0,n=t.innerHeight||t.document.documentElement.clientHeight||0;return!(o<=0||n<=0)&&(e.right<=0||e.bottom<=0||e.left>=o||e.top>=n)},_getVisibleAreaRatio(e,t,o){const n=Number.isFinite(e.width)?e.width:0,a=Number.isFinite(e.height)?e.height:0;if(n<=0||a<=0)return 1;if(t<=0||o<=0)return 1;const r=Math.max(0,e.left),i=Math.max(0,e.top),s=Math.min(t,e.right),l=Math.min(o,e.bottom),c=Math.max(0,s-r)*Math.max(0,l-i),A=n*a;return A<=0?1:Math.max(0,Math.min(1,c/A))},_clampPositionByAxis(e,t,o,n){const a=Number.isFinite(t)&&t>0?t:o,r=Number.isFinite(o)&&o>0?o:a,i=Math.max(0,Math.min(n,a,r)),s=Math.min(0,-a+i),l=Math.max(0,r-i),c=Number.isFinite(e)?e:0;return Math.min(Math.max(c,s),l)},_clampContainerToViewport(e,t){if(!this.container)return;const o=this.container.getBoundingClientRect(),n=this._getContainerRectSize(e),a=this._top(),r=a.innerWidth||a.document.documentElement.clientWidth||n.width,i=a.innerHeight||a.document.documentElement.clientHeight||n.height,s=this._shouldClampCurrentPosition(),l=this._isRectFullyOutsideViewport(o),c=this._getVisibleAreaRatio(o,r,i),A=t.includes('resize'),d=(l||A)&&c<.72;if(!s&&!l&&!d)return;const u=d?Math.min(n.width,r):Math.max(0,Math.min(this._minVisiblePx,n.width,r)),p=d?Math.min(n.height,i):Math.max(0,Math.min(this._minVisiblePx,n.height,i)),m=this._clampPositionByAxis(o.left,n.width,r,u),h=this._clampPositionByAxis(o.top,n.height,i,p);if(!(Math.abs(m-o.left)>.5||Math.abs(h-o.top)>.5))return;this.container.style.left=`${m}px`,this.container.style.top=`${h}px`,this.container.style.right='auto',this.container.style.bottom='auto';const f=Date.now();f-this._lastClampLogAt>600&&(this._lastClampLogAt=f,ie(`窗口变化触发位置修正(${t})`,{from:{x:o.left,y:o.top},to:{x:m,y:h},fullyOutside:l,visibleRatio:c,forceFullVisible:d})),this._onPositionChange?.(m,h)},_bindWindowResize(e){const t=this._top();this._unbindWindowResize(),this._boundWindowResize=()=>{this._clampContainerToViewport(e,'window-resize')};try{t.addEventListener('resize',this._boundWindowResize,{passive:!0})}catch(e){se('绑定 window.resize 监听失败',e),this._boundWindowResize=null}},_unbindWindowResize(){const e=this._top();if(this._boundWindowResize)try{e.removeEventListener('resize',this._boundWindowResize)}catch{}finally{this._boundWindowResize=null}},_top:()=>window.parent??window,_getPIXI(){const e=this._top();return tt.getPixi(e)},_measureOpaqueBoundsFromCanvas(e,t){const o=this.glContext;if(!o)return null;const n=o.drawingBufferWidth,a=o.drawingBufferHeight;if(n<=0||a<=0)return null;const r=n*a*4;this._pixelReadBuffer&&this._pixelReadBuffer.length===r||(this._pixelReadBuffer=new Uint8Array(r));const i=this._pixelReadBuffer;try{o.readPixels(0,0,n,a,o.RGBA,o.UNSIGNED_BYTE,i)}catch{return null}const s=Math.max(1,Math.floor(Math.sqrt(n*a/this._maxPixelScanSamples))),l=Math.max(0,Math.min(255,this._alphaHitThreshold));let c=n,A=a,d=-1,u=-1;for(let e=0;e<a;e+=s){const t=e*n*4;for(let o=0;o<n;o+=s){i[t+4*o+3]<=l||(o<c&&(c=o),e<A&&(A=e),o>d&&(d=o),e>u&&(u=e))}}if(d<0||u<0)return null;s>1&&(d=Math.min(n-1,d+s),u=Math.min(a-1,u+s));const p=e/n,m=t/a,h=Math.max(0,Math.floor(c*p)),f=Math.min(Math.ceil(e),Math.ceil((d+1)*p)),g=Math.max(0,Math.floor(t-(u+1)*m)),b=f-h,x=Math.min(Math.ceil(t),Math.ceil(t-A*m))-g;return b<8||x<8?null:{left:h,top:g,width:b,height:x}},_syncInteractionLayerBounds(){if(!this.container||!this.interactionLayer)return;const e=this.interactionLayer,t=this.container,o=()=>{e.style.left='0px',e.style.top='0px',e.style.width='100%',e.style.height='100%',e.style.pointerEvents='none',e.style.cursor='default'};if('preview'===this.mountMode)return void o();const n=t.getBoundingClientRect(),a=n.width>0?n.width:Number.parseFloat(String(t.style.width||'').replace('px','')),r=n.height>0?n.height:Number.parseFloat(String(t.style.height||'').replace('px',''));if(!Number.isFinite(a)||!Number.isFinite(r)||a<=0||r<=0)return;const i=(t,o,n,i)=>{const s=Math.max(0,this._interactionPaddingPx),l=Math.max(0,Math.floor(t-s)),c=Math.max(0,Math.floor(o-s)),A=Math.min(Math.ceil(a),Math.ceil(t+n+s))-l,d=Math.min(Math.ceil(r),Math.ceil(o+i+s))-c;return!(A<16||d<16)&&(e.style.left=`${l}px`,e.style.top=`${c}px`,e.style.width=`${A}px`,e.style.height=`${d}px`,e.style.pointerEvents='auto',e.style.cursor='pointer',!0)},s=this.app?.stage?.children?.[0];if(!s)return void o();const l=this._measureOpaqueBoundsFromCanvas(a,r);if(l){if(!(l.width>=.95*a&&l.height>=.95*r)&&i(l.left,l.top,l.width,l.height))return}if('function'==typeof s.getBounds)try{const e=s.getBounds(),t=Number(e?.x),o=Number(e?.y),n=Number(e?.width),l=Number(e?.height);if(Number.isFinite(t)&&Number.isFinite(o)&&Number.isFinite(n)&&Number.isFinite(l)&&n>0&&l>0){if(!(n>=.95*a&&l>=.95*r)&&i(t,o,n,l))return}}catch{}const c=Math.max(80,Math.round(.62*a)),A=Math.max(120,Math.round(.88*r));i(Math.max(0,Math.round((a-c)/2)),Math.max(0,Math.round(r-A)),c,A)||o()},_startInteractionSyncTimer(){this._stopInteractionSyncTimer(),this._syncInteractionLayerBounds(),this._interactionSyncTimer=window.setInterval(()=>{this._syncInteractionLayerBounds()},250)},_stopInteractionSyncTimer(){null!==this._interactionSyncTimer&&(window.clearInterval(this._interactionSyncTimer),this._interactionSyncTimer=null)},_enablePointerDrag(e,t){if(!this.container)return;const o=this._top(),n=this.container,a=this.interactionLayer??n,r=t.onPositionChange,i={pointerId:null,startClientX:0,startClientY:0,startLeft:0,startTop:0,dragging:!1,touchPointerIds:new Set},s=()=>{const e=n.getBoundingClientRect();return{width:e.width>0?e.width:t.width,height:e.height>0?e.height:t.height}},l=()=>{i.pointerId=null,i.dragging=!1,e.removeClass(this._dragClass)};a.addEventListener('pointerdown',e=>{if(0!==e.button)return;if('touch'===e.pointerType&&(i.touchPointerIds.add(e.pointerId),i.touchPointerIds.size>1))return void l();if(null!==i.pointerId)return;i.pointerId=e.pointerId,i.startClientX=e.clientX,i.startClientY=e.clientY;const{left:t,top:o}=(()=>{const e=n.getBoundingClientRect();return{left:e.left,top:e.top}})();i.startLeft=t,i.startTop=o;try{a.setPointerCapture(e.pointerId)}catch{}}),a.addEventListener('pointermove',t=>{if(null===i.pointerId||t.pointerId!==i.pointerId)return;if('touch'===t.pointerType&&i.touchPointerIds.size>1)return void l();const o=t.clientX-i.startClientX,a=t.clientY-i.startClientY,r=Math.sqrt(o*o+a*a);if(!i.dragging){if(r<8)return;i.dragging=!0,e.addClass(this._dragClass),n.style.left=`${i.startLeft}px`,n.style.top=`${i.startTop}px`,n.style.right='auto',n.style.bottom='auto'}const c=this._clampPosition(i.startLeft+o,i.startTop+a,s().width,s().height,this._minVisiblePx);n.style.left=`${c.x}px`,n.style.top=`${c.y}px`,n.style.right='auto',n.style.bottom='auto',t.preventDefault()},{passive:!1});const c=e=>{if('touch'===e.pointerType&&i.touchPointerIds.delete(e.pointerId),null===i.pointerId||e.pointerId!==i.pointerId)return;const t=i.dragging;if(l(),!t)return;const c=parseFloat(n.style.left||'0'),A=parseFloat(n.style.top||'0'),d=s(),u=this._clampPosition(c,A,d.width,d.height,this._minVisiblePx);n.style.left=`${u.x}px`,n.style.top=`${u.y}px`,n.style.right='auto',n.style.bottom='auto',this._onPositionChange=r??this._onPositionChange,this._onPositionChange?.(u.x,u.y);try{a.releasePointerCapture(e.pointerId)}catch{}try{o.getSelection?.()?.removeAllRanges?.()}catch{}};a.addEventListener('pointerup',c),a.addEventListener('pointercancel',c)},_ensureLoadingOverlay(){if(!this.container)return!1;const e=this.loadingOverlay;if(!!e&&!!e.ownerDocument?.documentElement?.contains(e))return!0;this.hideLoadingProgress();const t=this.container.ownerDocument,o=t.createElement('div');o.style.cssText='\n      position: absolute;\n      left: 8px;\n      right: 8px;\n      bottom: 8px;\n      padding: 8px 10px;\n      border-radius: 8px;\n      background: rgba(15, 23, 42, 0.72);\n      backdrop-filter: blur(3px);\n      pointer-events: none;\n      z-index: 5;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);\n      color: #e2e8f0;\n      font-size: 12px;\n      line-height: 1.4;\n    ';const n=t.createElement('div');n.style.cssText='margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;',n.textContent='姝ｅ湪鍔犺浇妯″瀷 (0%)';const a=t.createElement('div');a.style.cssText='width: 100%; height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.35); overflow: hidden;';const r=t.createElement('div');return r.style.cssText='height: 100%; width: 0%; border-radius: 999px; background: linear-gradient(90deg, #60a5fa, #22d3ee); transition: width 0.2s ease;',a.appendChild(r),o.appendChild(n),o.appendChild(a),this.container.appendChild(o),this.loadingOverlay=o,this.loadingText=n,this.loadingBarFill=r,!0},showLoadingProgress(e,t){if(!this._ensureLoadingOverlay())return;const o=Math.max(0,Math.min(100,Math.round(e)));this.loadingText&&(this.loadingText.textContent=`${t} (${o}%)`),this.loadingBarFill&&(this.loadingBarFill.style.width=`${o}%`)},hideLoadingProgress(){if(this.loadingOverlay)try{this.loadingOverlay.remove()}catch(e){se('Failed to remove loading progress overlay',e)}this.loadingOverlay=null,this.loadingText=null,this.loadingBarFill=null},create(e){const t=this._top(),o=this._getPIXI();if(!o)return se('PIXI 尚未就绪，无法创建舞台'),!1;this.destroy(),this._onPositionChange=e.onPositionChange??null,this._bindWindowResize({width:e.width,height:e.height});const n=t.document.getElementById('desktop-pet-stage');n&&n.remove(),this.container=t.document.createElement('div'),this.container.id='desktop-pet-stage',this.container.style.cssText=`\n      position: fixed;\n      right: 20px;\n      bottom: 20px;\n      width: ${e.width}px;\n      height: ${e.height}px;\n      overflow: hidden;\n      z-index: 10000;\n      pointer-events: none;\n      cursor: default;\n      touch-action: none;\n    `;if(Number.isFinite(e.position.x)&&Number.isFinite(e.position.y)&&!(-1===e.position.x&&-1===e.position.y)){const t=this._clampPosition(e.position.x,e.position.y,e.width,e.height,this._minVisiblePx);this.container.style.left=`${t.x}px`,this.container.style.top=`${t.y}px`,this.container.style.right='auto',this.container.style.bottom='auto',t.clamped&&(ie('检测到宠物位置超出可视区域，已自动修正',{from:e.position,to:{x:t.x,y:t.y}}),e.onPositionChange?.(t.x,t.y))}t.document.body.appendChild(this.container),this.canvas=t.document.createElement('canvas'),this.canvas.style.cssText='width: 100%; height: 100%; pointer-events: none;',this.container.appendChild(this.canvas),this.interactionLayer=t.document.createElement('div'),this.interactionLayer.className='desktop-pet-interaction-layer',this.interactionLayer.style.cssText='\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: auto;\n      cursor: pointer;\n      touch-action: none;\n      z-index: 4;\n    ',this.container.appendChild(this.interactionLayer);const a=t.devicePixelRatio||1;this.canvas.width=Math.floor(e.width*a),this.canvas.height=Math.floor(e.height*a);const r=this.canvas.getContext('webgl2',{alpha:!0,antialias:!0,stencil:!0,depth:!0,preserveDrawingBuffer:!0,premultipliedAlpha:!0})||this.canvas.getContext('webgl',{alpha:!0,antialias:!0,stencil:!0,depth:!0,preserveDrawingBuffer:!0,premultipliedAlpha:!0});if(!r)return se('WebGL is unavailable'),!1;this.glContext=r,this._pixelReadBuffer=null;try{const e=r.getContextAttributes?.();e&&!1===e.stencil&&se('Current WebGL context has no stencil buffer; mask rendering may be abnormal')}catch{}this.app=new o.Application({view:this.canvas,context:r,backgroundAlpha:0,autoStart:!0,width:e.width,height:e.height,resolution:a,autoDensity:!0,antialias:!0});const i=$(this.container),s=i.draggable;if('function'==typeof s)try{i.draggable({handle:'.desktop-pet-interaction-layer',start:(e,t)=>{i.addClass(this._dragClass);const o=this.container?.getBoundingClientRect?.();o&&(this.container.style.left=`${o.left}px`,this.container.style.top=`${o.top}px`,this.container.style.right='auto',this.container.style.bottom='auto',t?.position&&(t.position.left=o.left,t.position.top=o.top))},drag:(t,o)=>{const n=this.container?.getBoundingClientRect?.(),a=n?.width&&n.width>0?n.width:e.width,r=n?.height&&n.height>0?n.height:e.height,i=this._clampPosition(o.position.left,o.position.top,a,r,this._minVisiblePx);o.position.left=i.x,o.position.top=i.y},stop:(t,o)=>{i.removeClass(this._dragClass);const n=this.container?.getBoundingClientRect?.(),a=n?.width&&n.width>0?n.width:e.width,r=n?.height&&n.height>0?n.height:e.height,s=this._clampPosition(o.position.left,o.position.top,a,r,this._minVisiblePx);this.container.style.left=`${s.x}px`,this.container.style.top=`${s.y}px`,this.container.style.right='auto',this.container.style.bottom='auto',this._onPositionChange?.(s.x,s.y)}})}catch(t){se('Failed to initialize jQueryUI draggable, fallback to native pointer drag',t),this._enablePointerDrag(i,{width:e.width,height:e.height,onPositionChange:e.onPositionChange})}else se('jQueryUI draggable not found, fallback to native pointer drag'),this._enablePointerDrag(i,{width:e.width,height:e.height,onPositionChange:e.onPositionChange});const l=this.interactionLayer??this.container;let c=Number.isFinite(e.scale)?e.scale:1,A=!1,d=0,u=c;const p=new Map,m=t=>{const o=Math.max(.1,Math.min(3,t));Math.abs(o-c)<.002||(c=o,e.scale=o,e.onScaleChange?.(o))},h=()=>{if(p.size<2)return 0;const e=Array.from(p.values()),t=e[0],o=e[1],n=t.x-o.x,a=t.y-o.y;return Math.sqrt(n*n+a*a)},f=e=>{if('function'==typeof s)try{i.draggable(e?'enable':'disable')}catch{}},g=e=>{if('touch'===e.pointerType){if(p.delete(e.pointerId),p.size>=2){const e=h();return void(e>0&&(d=e,u=c))}d=0,u=c,A&&(A=!1,f(!0))}};return l.addEventListener('pointerdown',e=>{if('touch'!==e.pointerType)return;if(p.set(e.pointerId,{x:e.clientX,y:e.clientY}),p.size<2)return;const t=h();t<=0||(A||(A=!0,f(!1)),d=t,u=c,e.preventDefault())},{passive:!1}),l.addEventListener('pointermove',e=>{if('touch'!==e.pointerType)return;if(!p.has(e.pointerId))return;if(p.set(e.pointerId,{x:e.clientX,y:e.clientY}),!A||p.size<2)return;const t=h();if(t<=0||d<=0)return;m(u*(t/d)),e.preventDefault()},{passive:!1}),l.addEventListener('pointerup',g),l.addEventListener('pointercancel',g),l.addEventListener('wheel',e=>{e.preventDefault();const t=e.deltaY>0?-.05:.05;m(c+t)},{passive:!1}),this.gestureRecognizer=new nt(l,{},t=>{switch(t.type){case'tap':e.onTap?.(t);break;case'double-tap':e.onDoubleTap?.(t);break;case'long-press':e.onLongPress?.(t)}},()=>A||i.hasClass('ui-draggable-dragging')||i.hasClass(this._dragClass)),this._startInteractionSyncTimer(),ie('Live2D 舞台创建完成'),!0},getStage(){return this.app?.stage},isPreviewMounted(){return'preview'===this.mountMode},pushMount(e){if(!this.container||!this.app||!this.canvas)return!1;if(!e||!e.isConnected)return!1;const t=this._top(),o=this.container.getBoundingClientRect?.(),n=o?.width&&o.width>0?Math.round(o.width):Number(String(this.container.style.width||'').replace('px',''))||1,a=o?.height&&o.height>0?Math.round(o.height):Number(String(this.container.style.height||'').replace('px',''))||1;this.mountStack.push({parent:this.container.parentNode,nextSibling:this.container.nextSibling,styleText:this.container.style.cssText,width:n,height:a,onPositionChange:this._onPositionChange});try{'static'===t.getComputedStyle(e).position&&(e.style.position='relative')}catch{}this._onPositionChange=null,this._unbindWindowResize();try{e.appendChild(this.container)}catch{return!1}this.mountMode='preview',this.container.style.cssText='\n      position: absolute;\n      inset: 0;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      z-index: 1;\n      pointer-events: none;\n      cursor: default;\n      touch-action: none;\n    ',this.interactionLayer&&(this.interactionLayer.style.left='0px',this.interactionLayer.style.top='0px',this.interactionLayer.style.width='100%',this.interactionLayer.style.height='100%',this.interactionLayer.style.pointerEvents='none',this.interactionLayer.style.cursor='default');try{const e=$(this.container);'function'==typeof e.draggable&&e.draggable('disable')}catch{}return!0},popMount(){if(!this.container||!this.app||!this.canvas)return null;const e=this.mountStack.pop();if(!e)return null;try{const t=e.parent;t?e.nextSibling&&e.nextSibling.parentNode===t?t.insertBefore(this.container,e.nextSibling):t.appendChild(this.container):this._top().document.body.appendChild(this.container)}catch{}this.container.style.cssText=e.styleText,this._onPositionChange=e.onPositionChange,this.mountMode=this.mountStack.length>0?'preview':'floating',this._syncInteractionLayerBounds();try{const e=$(this.container);'function'==typeof e.draggable&&e.draggable('enable')}catch{}this._bindWindowResize({width:e.width,height:e.height});const t=this._pendingFloatingResize??{width:e.width,height:e.height};return this._pendingFloatingResize=null,this.resize(t.width,t.height),t},resizeFloating(e,t){if('preview'!==this.mountMode){if(this.container&&(this.container.style.width=`${e}px`,this.container.style.height=`${t}px`,this._clampContainerToViewport({width:e,height:t},'stage-resize'),this._syncInteractionLayerBounds()),this.app)try{this.app.renderer.resize(e,t)}catch(e){se('renderer.resize 失败',e)}}else this._pendingFloatingResize={width:e,height:t}},resizePreview(e,t){if('preview'===this.mountMode&&this.app)try{this.app.renderer.resize(e,t),this._syncInteractionLayerBounds()}catch(e){se('renderer.resize 失败',e)}},resize(e,t){this.resizeFloating(e,t)},destroy(){if(this.hideLoadingProgress(),this._unbindWindowResize(),this._stopInteractionSyncTimer(),this.mountStack=[],this.mountMode='floating',this._pendingFloatingResize=null,this.gestureRecognizer&&(this.gestureRecognizer.destroy(),this.gestureRecognizer=null),this.app){try{this.app.destroy(!0)}catch(e){se('Failed to destroy PIXI Application',e)}this.app=null}if(this.container){try{this.container.remove()}catch(e){se('舞台容器移除失败',e)}this.container=null}this.interactionLayer=null,this.canvas=null,this.glContext=null,this._pixelReadBuffer=null}},rt={默认:{expressions:['normal','default','neutral','idle','base'],motions:['idle','normal','wait','default','stand']},微笑:{expressions:['smile','happy','joy','glad','pleased'],motions:['happy','smile','joy','weixiao','xiao','微笑']},生气:{expressions:['angry','anger','mad','rage','annoyed'],motions:['angry','rage','mad','shengqi','duqi','生气']},难过:{expressions:['sad','sorrow','cry','upset','depressed'],motions:['sad','cry','sorrow','nanguo','leiw','难过']},惊讶:{expressions:['surprised','shock','amazed','wow','astonished'],motions:['surprised','shock','amazed','jingya','jingxi','惊讶']},嘲讽:{expressions:['smirk','mock','sneer','tease','sarcastic'],motions:['mock','tease','tiaoxi','嘲讽']},害羞:{expressions:['shy','blush','embarrassed','bashful','timid'],motions:['shy','embarrassed','blush','haixiu','shame','害羞']},思考:{expressions:['think','ponder','confused','wonder','curious'],motions:['think','ponder','wonder','sikao','思考']},大笑:{expressions:['laugh','lol','haha','giggle','rofl'],motions:['laugh','giggle','haha','daxiao','oowarai','大笑']},搞怪:{expressions:['playful','wink','silly','fun','mischievous'],motions:['playful','wink','fun','gaoguai','silly','搞怪']}};function it(e,t,o){const n=String(o??'').trim();n&&!t.has(n)&&(t.add(n),e.push(n))}function st(e,t,o){const n=String(o??''),a=n.trim();if(!a&&''!==n)return;const r=a||'';t.has(r)||(t.add(r),e.push(r))}function lt(e,t,o){const n=String(o.group??''),a=Number.isFinite(o.index)?Math.max(0,Math.floor(o.index)):0,r=String(o.name??'').trim();if(!r)return;const i=`${n}#${a}#${r.toLowerCase()}`;t.has(i)||(t.add(i),e.push({group:n,index:a,name:r}))}function ct(e){const t=String(e??'').trim();if(!t)return'';const o=t.split('#')[0].split('?')[0],n=o.split('/').pop()||o;let a=n;try{a=decodeURIComponent(n)}catch{}return a.replace(/\.exp3\.json$/i,'').replace(/\.motion3\.json$/i,'').replace(/\.mtn$/i,'').replace(/\.json$/i,'').trim()}function At(e,t=''){if('string'==typeof e)return ct(e)||e.trim();if(!e||'object'!=typeof e)return t;const o=e,n=o.Name||o.name||o.Id||o.id||'';if(String(n??'').trim())return String(n).trim();const a=ct(o.File||o.file||o.Path||o.path||'');return a||t}function dt(e){const t=[],o=new Set,n=e=>{e&&'object'==typeof e&&(o.has(e)||(o.add(e),t.push(e)))},a=e?.internalModel?.motionManager,r=e?.internalModel?.settings;return n(r),n(r?.json),n(r?.rawSettings),n(r?.modelJson),n(a?.settings),n(a?.settings?.json),n(a?.settings?.rawSettings),n(a?.settings?.modelJson),t}function ut(e){const t=String(e??'').trim().toLowerCase();return!!t&&(/\.exp3\.json($|[?#])/.test(t)||/\.exp\.json($|[?#])/.test(t)||/\.exp($|[?#])/.test(t))}function pt(e){const t=String(e??'').trim().toLowerCase();return!!t&&(/\.motion3\.json($|[?#])/.test(t)||/\.mtn($|[?#])/.test(t))}function mt(e){if('string'==typeof e)return pt(e);if(!e||'object'!=typeof e)return!1;const t=e;if(pt(t.File||t.file||t.Path||t.path||''))return!0;const o=t.Sound||t.sound||'';return!('string'!=typeof o||!o.trim())}function ht(e){let t=0;for(const o of e)mt(o)&&t++;return t>0?t:e.length}function ft(e,t,o){const n=String(t??''),a=n.trim();if(!a&&''!==n)return;const r=a||'',i=Number(o),s=Number.isFinite(i)&&i>0?Math.max(1,Math.floor(i)):1,l=e[r];e[r]=Number.isFinite(l)&&l>0?Math.max(l,s):s}function gt(e,t,o,n){if(Array.isArray(o))return void((o,n)=>{for(let a=0;a<o.length;a++){const r=At(o[a],`${n}_${a+1}`);it(e,t,r)}})(o,n);if(!o||'object'!=typeof o)return;let a=0;for(const[r,i]of Object.entries(o)){const o=ct(r)||String(r||'').trim()||`${n}_${a+1}`,s=At(i,o);it(e,t,s||o),a++}}function bt(e){const t=[],o=new Set,n=new Set,a=(e,r='')=>{if(null==e)return;if('string'==typeof e){const n=e.trim();if(!n)return;return void((ut(n)||/exp|expression/.test(r))&&it(t,o,ct(n)||n))}if(Array.isArray(e)){for(let n=0;n<e.length;n++){const i=e[n],s=`${r||'expression'}_${n+1}`;if('string'!=typeof i){if(i&&'object'==typeof i){const e=At(i,s),n=i,a=n.File||n.file||n.Path||n.path||'';(/exp|expression/.test(r)||ut(a))&&it(t,o,e||s)}a(i,r)}else(ut(i)||/exp|expression/.test(r))&&it(t,o,ct(i)||i)}return}if('object'!=typeof e)return;if(n.has(e))return;n.add(e);const i=e,s=i,l=s.File||s.file||s.Path||s.path||'';ut(l)&&it(t,o,At(i,ct(l)));for(const[e,n]of Object.entries(i)){const i=String(e||'').trim();if(!i)continue;const s=i.toLowerCase(),l=s.includes('expression')||s.includes('expr')||'exp'===s,c=l?'expression':r;if('string'==typeof n){const e=n.trim();if(!e)continue;if(ut(e)||l||/exp|expression/.test(r)){const n=ct(i)||i,a=At({Name:n,File:e},n);it(t,o,a||n)}continue}if(Array.isArray(n))(l||/exp|expression/.test(r))&&gt(t,o,n,ct(i)||'expression'),a(n,c);else if(n&&'object'==typeof n){if(l){const e=ct(i)||i;it(t,o,At(n,e))}a(n,c)}}};return a(e,''),t}function xt(e){const t={},o=new Set,n=(e,a='',r='')=>{if(null==e)return;if(Array.isArray(e)){const o=ht(e);(''===a||a)&&o>0&&('motion'===r||e.some(e=>mt(e)))&&ft(t,a,o);for(const t of e)t&&'object'==typeof t&&n(t,a,r);return}if('object'!=typeof e)return;if(o.has(e))return;o.add(e);const i=e;for(const[e,o]of Object.entries(i)){const i=String(e??''),s=i.trim()||'';if(!s&&''!==i)continue;const l=s.toLowerCase(),c=l.includes('motions')||l.includes('motion')||l.includes('anim')||l.includes('mtn'),A=c?'motion':r;if(Array.isArray(o)){const e=ht(o);e>0&&('motion'===A||o.some(e=>mt(e)))&&ft(t,s,e),n(o,s,A);continue}if('string'!=typeof o){if(o&&'object'==typeof o){if(c){const e=o;for(const[o,n]of Object.entries(e)){const e=String(o??''),a=e.trim()||'';if(!a&&''!==e)continue;if(!Array.isArray(n))continue;const r=ht(n);r>0&&ft(t,a,r)}}n(o,s,A)}}else pt(o)&&a&&ft(t,a,1)}};return n(e,'',''),t}function yt(e,t,o){if(!o)return;const n=(o,n)=>{for(let a=0;a<n.length;a++){const r=n[a];if(!mt(r))continue;const i=At(r,`motion_${a+1}`);lt(e,t,{group:o,index:a,name:i})}};if(Array.isArray(o))n('',o);else if('object'==typeof o)for(const[e,t]of Object.entries(o)){const o=String(e??''),a=o.trim();if(!a&&''!==o)continue;const r=a||'';Array.isArray(t)&&n(r,t)}}function Ct(e){const t=[],o=new Set,n=e?.internalModel?.motionManager;yt(t,o,n?.definitions);const a=dt(e);for(const e of a)yt(t,o,e?.motions),yt(t,o,e?.Motions),yt(t,o,e?.FileReferences?.Motions);return t}function vt(e){const t=[],o=new Set,n=e?.internalModel?.motionManager?.expressionManager;gt(t,o,n?.definitions,'definition'),gt(t,o,n?.expressions,'expression');for(const e of bt(n?.definitions))it(t,o,e);for(const e of bt(n?.expressions))it(t,o,e);const a=dt(e);for(const e of a){gt(t,o,e?.expressions,'settings_expr'),gt(t,o,e?.Expressions,'settings_expr'),gt(t,o,e?.FileReferences?.Expressions,'file_ref_expr');for(const n of bt(e))it(t,o,n)}const r=e?.internalModel?.settings;if(r&&'object'==typeof r&&'function'==typeof r.getExpressionCount){let e=0;try{e=Number(r.getExpressionCount())||0}catch{}e=Math.max(0,Math.min(e,1e3));for(let n=0;n<e;n++){let e='';if('function'==typeof r.getExpressionName)try{e=String(r.getExpressionName(n)??'').trim()}catch{}if(!e&&'function'==typeof r.getExpressionFile)try{e=ct(r.getExpressionFile(n))}catch{}it(t,o,e||`expression_${n+1}`)}}return t}function wt(e){const t=[],o=new Set,n=e?.internalModel?.motionManager,a=e=>{if(e&&'object'==typeof e)for(const n of Object.keys(e))st(t,o,n)};a(n?.motionGroups),a(n?.groups),a(n?.definitions);for(const[e]of Object.entries(xt(n?.definitions)))st(t,o,e);const r=dt(e);for(const e of r){a(e?.motions),a(e?.Motions),a(e?.FileReferences?.Motions);for(const[n]of Object.entries(xt(e)))st(t,o,n)}const i=e?.internalModel?.settings;if(i&&'object'==typeof i){const e=i;if('function'==typeof e.getMotionGroupCount&&'function'==typeof e.getMotionGroupName){let n=0;try{n=Number(e.getMotionGroupCount())||0}catch{}n=Math.max(0,Math.min(n,1e3));for(let a=0;a<n;a++)try{st(t,o,String(e.getMotionGroupName(a)??''))}catch{}}else if('function'==typeof e.getMotionGroupNames)try{const n=e.getMotionGroupNames();if(Array.isArray(n))for(const e of n)st(t,o,e)}catch{}}return t}function Bt(e,t,o){const n=String(o||'').trim();if(n)return n;const a=rt[t],r=a?.expressions||[String(t||'').toLowerCase()],i=vt(e);if(!i.length)return null;for(const e of r){const t=String(e||'').toLowerCase(),o=i.find(e=>String(e||'').toLowerCase()===t);if(o)return o}for(const e of r){const t=String(e||'').toLowerCase();for(const e of i){const o=String(e||'').toLowerCase();if(o.includes(t)||t.includes(o))return e}}return null}function kt(e,t,o){if(o&&!1===o.enabled)return null;const n=String(o?.group||'').trim(),a=Number(o?.index),r=Number.isFinite(a)?Math.max(0,Math.floor(a)):0;if(n){const t=Ct(e),o=wt(e),a=n.toLowerCase(),i=t.find(e=>String(e.group||'').trim().toLowerCase()===a&&e.index===r);if(i)return{group:i.group,index:i.index,name:i.name};const s=o.find(e=>String(e||'').trim().toLowerCase()===a);if(void 0!==s){const e=t.find(e=>String(e.group||'').trim()===s&&e.index===r);if(e)return{group:e.group,index:e.index,name:e.name};const o=t.find(e=>String(e.group||'').trim()===s);return o?{group:o.group,index:o.index,name:o.name}:{group:s,index:r}}const l=t.find(e=>e.name.toLowerCase()===a&&e.index===r)||t.find(e=>e.name.toLowerCase()===a);if(l)return{group:l.group,index:l.index,name:l.name};const c=t.find(e=>{const t=e.name.toLowerCase();return t.includes(a)||a.includes(t)});if(c)return{group:c.group,index:c.index,name:c.name};const A=o.find(e=>{const t=String(e||'').trim().toLowerCase();return!!t&&(t.includes(a)||a.includes(t))});if(void 0!==A){const e=t.find(e=>String(e.group||'').trim()===A&&e.index===r);if(e)return{group:e.group,index:e.index,name:e.name};const o=t.find(e=>String(e.group||'').trim()===A);return o?{group:o.group,index:o.index,name:o.name}:{group:A,index:r}}return null}const i=rt[t];if(!i?.motions?.length)return null;const s=wt(e);if(!s.length)return null;for(const e of i.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=s.find(e=>String(e||'').trim().toLowerCase()===t);if(o)return{group:o,index:0}}for(const e of i.motions){const t=String(e||'').toLowerCase();if(t)for(const e of s){const o=String(e||'').toLowerCase();if(o&&(o.includes(t)||t.includes(o)))return{group:e,index:0}}}const l=Ct(e);if(!l.length)return null;for(const e of i.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=l.find(e=>e.name.toLowerCase()===t);if(o)return{group:o.group,index:o.index,name:o.name}}for(const e of i.motions){const t=String(e||'').trim().toLowerCase();if(!t)continue;const o=l.find(e=>{const o=e.name.toLowerCase();return o.includes(t)||t.includes(o)});if(o)return{group:o.group,index:o.index,name:o.name}}return null}const St='__desktopPetLive2dTickerV1',_t={_JSDELIVR_HOSTS:['cdn.jsdelivr.net','fastly.jsdelivr.net','testingcf.jsdelivr.net','gcore.jsdelivr.net'],_runtime:null,model:null,isReady:!1,modelBaseWidth:null,modelBaseHeight:null,modelBaseBounds:null,_lastModelJson:null,_lastModelJsonSourceUrl:'',_autoMotionTimer:null,autoMotionLoopEnabled:!0,_mouthParamCore:null,_mouthParamIds:[],_mouthParamIndexes:[],_mouthParamRangeMins:[],_mouthParamRangeMaxs:[],_mouthParamWarned:!1,_mouthCurrentValue:0,_lipSyncActive:!1,_inModelUpdate:!1,_writeMaskCore:null,_writeMaskRestore:null,_updateHookModel:null,_updateHookRestore:null,_manualMouthParamEnabled:!1,_manualMouthParamIds:[],_manualMouthParamIdSet:new Set,_top:()=>window.parent??window,_getPIXI(){const e=tt.getPixi(this._top());return e||(this._runtime?.pixi??null)},_encodePathSegment(e){if('string'!=typeof e||!e)return e;let t=e;try{t=decodeURIComponent(e)}catch{return e}const o=/[A-Za-z0-9\-._~!$&'()*+,;=:@]/;let n='';for(const e of t)n+=o.test(e)?e:encodeURIComponent(e);return n},_normalizeRemoteUrl(e){const t=String(e||'').trim();if(!t)return t;try{const e=new URL(t);return e.pathname=e.pathname.split('/').map(e=>this._encodePathSegment(e)).join('/'),e.toString()}catch{return t}},_normalizeResourceRef(e){const t=String(e||'').trim();if(!t)return t;const o=t.replace(/#/g,'%23').replace(/\\/g,'/'),n=o.indexOf('?'),a=n>=0?o.slice(0,n):o,r=n>=0?o.slice(n):'';return`${a.split('/').map(e=>this._encodePathSegment(e)).join('/')}${r.replace(/#/g,'%23')}`},_getMirrorEikanyaModelUrl(e){const t=String(e||'').trim();return t?t.startsWith(b)?`${x}${t.slice(56)}`:t.startsWith(x)?`${b}${t.slice(62)}`:null:null},_expandJsDelivrHosts(e){const t=String(e||'').trim();if(!t)return[];let o;try{o=new URL(t)}catch{return[]}if(!o.hostname.toLowerCase().endsWith('jsdelivr.net'))return[];const n=[];for(const e of this._JSDELIVR_HOSTS)try{const o=new URL(t);o.hostname=e,n.push(o.toString())}catch{}return n},_convertJsDelivrGhToRawCandidates(e){const t=String(e||'').trim();if(!t)return[];let o;try{o=new URL(t)}catch{return[]}if(!o.hostname.toLowerCase().endsWith('jsdelivr.net'))return[];if(!o.pathname.startsWith('/gh/'))return[];const n=o.pathname.slice(4).split('/').filter(Boolean);if(n.length<2)return[];const a=n[0],r=n[1],i=n.slice(2).join('/');if(!a||!r||!i)return[];const[s,l]=r.split('@'),c=`${o.search||''}${o.hash||''}`;return l?[`https://raw.githubusercontent.com/${a}/${s}/${l}/${i}${c}`]:[`https://raw.githubusercontent.com/${a}/${s}/master/${i}${c}`,`https://raw.githubusercontent.com/${a}/${s}/main/${i}${c}`]},_buildModelUrlCandidates(e){const t=[],o=e=>{const o=this._normalizeRemoteUrl(e);o&&(t.includes(o)||t.push(o))};o(e);const n=this._getMirrorEikanyaModelUrl(e);n&&o(n);const a=[],r=e=>{const t=this._normalizeRemoteUrl(e);t&&(a.includes(t)||a.push(t))};for(const e of t){r(e);for(const t of this._expandJsDelivrHosts(e))r(t);for(const t of this._convertJsDelivrGhToRawCandidates(e))r(t)}return a},async _createModelWithTimeout(e,t,o=3e4){let n=null;try{const a=new Promise((e,t)=>{n=window.setTimeout(()=>{t(new Error(`模型实例化超时 (${o}ms)`))},o)});return await Promise.race([e.from(t,{autoUpdate:!1,autoInteract:!1}),a])}finally{null!==n&&window.clearTimeout(n)}},async _fetchWithTimeout(e,t,o=12e3){if('undefined'==typeof AbortController)return fetch(e,t);const n=new AbortController,a=window.setTimeout(()=>n.abort(),o);try{return await fetch(e,{...t,signal:n.signal})}catch(t){if('AbortError'===t?.name)throw new Error(`请求超时 (${o}ms): ${e}`);throw t}finally{window.clearTimeout(a)}},_toPositiveNumber(e,t){const o='number'==typeof e?e:Number(e);return Number.isFinite(o)&&o>0?o:t},_toScale(e,t=1){const o='number'==typeof e?e:Number(e);return!Number.isFinite(o)||o<=0?t:Math.min(20,Math.max(.01,o))},_readModelBaseBounds(e){if(!e||'function'!=typeof e.getLocalBounds)return null;try{const t=e.getLocalBounds();if(!t)return null;const o=Number(t.width),n=Number(t.height);if(!Number.isFinite(o)||!Number.isFinite(n)||o<=0||n<=0)return null;const a=Number.isFinite(Number(t.x))?Number(t.x):0;return{x:a,y:Number.isFinite(Number(t.y))?Number(t.y):0,width:o,height:n}}catch{return null}},_resolveModelBaseBounds(){if(this.modelBaseBounds)return this.modelBaseBounds;const e=this._readModelBaseBounds(this.model);return e?(this.modelBaseBounds=e,this.modelBaseWidth=e.width,this.modelBaseHeight=e.height,e):{x:0,y:0,width:this._toPositiveNumber(this.modelBaseWidth,500),height:this._toPositiveNumber(this.modelBaseHeight,800)}},_applyStageTransform(e,t,o){if(!this.model)return null;const n=this._toPositiveNumber(e,280),a=this._toPositiveNumber(t,360),r=this._resolveModelBaseBounds(),i=this._toPositiveNumber(r.width,500),s=this._toPositiveNumber(r.height,800),l=.9*Math.min(n/i,a/s),c=this._toScale(l*this._toScale(o,1),.3);return this.model.visible=!0,this.model.alpha=1,this.model.scale.set(c),this.model.anchor?.set?(this.model.anchor.set(.5,1),this.model.x=n/2,this.model.y=a):this.model.pivot?.set?(this.model.pivot.set(r.x+i/2,r.y+s),this.model.x=n/2,this.model.y=a):(this.model.x=n/2,this.model.y=a/2),{finalScale:c,stageWidth:n,stageHeight:a,modelWidth:i,modelHeight:s}},_normalizeLegacyCubism2Settings(e){if(!e||e.FileReferences)return;const t=e.textures||e.Textures;if(Array.isArray(t))return;if(!t||'object'!=typeof t)return;const o=Object.entries(t).filter(e=>Array.isArray(e[1])&&e[1].length>0);if(0===o.length)return;const n=[e.config?.texture,e.config?.textureId,e.config?.skin,e.config?.modelId,e.config?.defaultTexture,e.config?.defaultSkin].map(e=>null==e?'':String(e).trim()).filter(Boolean);let a=o[0];for(const e of n){const t=o.find(([t])=>t===e);if(t){a=t;break}}const r=a[1].map(e=>{const t=String(e||'').trim();return t?/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)||t.startsWith('/')||t.includes('/')?t:`textures/${t}`:t});e.textures=r,e.Textures=r,ie('检测到非标准 Cubism2 贴图结构，已自动转换',{key:a[0],textureCount:r.length})},_clearAutoMotionLoop(){null!==this._autoMotionTimer&&(window.clearInterval(this._autoMotionTimer),this._autoMotionTimer=null)},_stopCurrentMotion(e='manual'){const t=this.model;if(!t)return;let o=!1;const n=(e,t)=>{if(e&&'function'==typeof e[t])try{e[t](),o=!0}catch{}},a=t?.internalModel?.motionManager,r=t?.internalModel?.animator,i=t?.internalModel;n(t,'stopMotions'),n(a,'stopAllMotions'),n(a,'stopAllMotion'),n(a,'stopMotion'),n(a,'stop'),n(r,'stopAllMotions'),n(r,'stopAllMotion'),n(r,'stop'),n(i,'stopAllMotions'),o&&ie('已停止当前动作',{reason:e})},_refreshManualMouthParams(){let e=!1;const t=[];try{const o=ue().settings;e=!!o?.lipSyncManualParamsEnabled;const n=Array.isArray(o?.lipSyncManualParamIds)?o.lipSyncManualParamIds:[],a=new Set;for(const e of n){const o=String(e||'').trim();if(!o)continue;const n=o.toLowerCase();a.has(n)||(a.add(n),t.push(o))}}catch{}this._manualMouthParamEnabled=e,this._manualMouthParamIds=t,this._manualMouthParamIdSet=new Set(t.map(e=>e.toLowerCase()))},_setLipSyncActive(e){const t=!!e;if(this._lipSyncActive!==t){if(this._lipSyncActive=t,t){this._refreshManualMouthParams();const e=this.model,t=e?.internalModel?.coreModel;e&&this._ensureLipSyncHooks(e),t&&this._installCoreWriteMask(t)}ie(`LipSync active=${t}`)}},setAutoMotionLoopEnabled(e){this.autoMotionLoopEnabled=Boolean(e),this.model?this.autoMotionLoopEnabled?this._startAutoMotionLoop():(this._clearAutoMotionLoop(),this._stopCurrentMotion('auto-motion-disabled')):this._clearAutoMotionLoop()},_pickDefaultMotionGroup(e){const t=Object.keys(e).filter(t=>e[t]>0);if(0===t.length)return null;const o=['idle','home','stand','normal','default','main','loop','wait'];for(const e of t){const t=e.toLowerCase();if(o.some(e=>t.includes(e)))return e}return t.includes('')?'':null},_startAutoMotionLoop(){if(this._clearAutoMotionLoop(),!this.model)return;const e=this.getMotionGroups(),t=this._pickDefaultMotionGroup(e),o=Object.keys(e).filter(t=>e[t]>0);if(0===o.length)return void ie('当前模型未提供动作组，将保持静态显示');const n=()=>{if(!this.model)return;const e=this.getMotionGroups();if(null!==t){const o=e[t]??0;if(o<=0)return;const n=Math.floor(Math.random()*o);return void this.playMotion(t,n)}const o=Object.keys(e).filter(t=>e[t]>0);if(0===o.length)return;const n=o[Math.floor(Math.random()*o.length)],a=e[n];if(a<=0)return;const r=Math.floor(Math.random()*a);this.playMotion(n,r)};n(),this._autoMotionTimer=window.setInterval(n,1e4),ie('已启动自动动作循环',null!==t?{mode:'preferred-group',group:t||'(empty)',intervalMs:1e4}:{mode:'random-all-groups',groupCount:o.length,intervalMs:1e4})},_stripJsonComments(e){let t='',o=!1,n='"',a=!1,r=!1,i=!1;for(let s=0;s<e.length;s++){const l=e[s],c=s+1<e.length?e[s+1]:'';r?'\n'===l&&(r=!1,t+=l):i?'*'===l&&'/'===c&&(i=!1,s++):o?(t+=l,a?a=!1:'\\'===l?a=!0:l===n&&(o=!1)):'/'!==l||'/'!==c?'/'!==l||'*'!==c?('"'!==l&&'\''!==l||(o=!0,n=l),t+=l):(i=!0,s++):(r=!0,s++)}return t},_tryParseModelJson(e){const t=String(e??'').replace(/^\uFEFF/,'').trim();if(!t)return null;try{return JSON.parse(t)}catch{}let o=this._stripJsonComments(t);o=o.replace(/,\s*([}\]])/g,'$1'),o=o.replace(/}(\s*){/g,'},$1{'),o=o.replace(/](\s*){/g,'],$1{'),o=o.replace(/([}\]0-9"'])(\s*)(?="[^"]+"\s*:)/g,'$1,$2');try{return JSON.parse(o)}catch{return null}},_buildModelJsonCandidates(e){const t=[e],o=e=>{e&&(t.includes(e)||t.push(e))};return o(e.replace(/\/model\.json(?=([?#].*)?$)/i,'/model.model.json')),o(e.replace(/\/model3\.json(?=([?#].*)?$)/i,'/model.model3.json')),t},async _fetchModelJsonCandidate(e,t){const o=t?this._getProxiedUrl(e):e,n=await this._fetchWithTimeout(o,{method:'GET',cache:'no-store'},12e3);if(!n.ok)return null;const a=await n.text(),r=this._tryParseModelJson(a);return r?{modelJson:r,sourceUrl:e,useProxy:t}:null},_getProxiedUrl(e){const t=this._top(),o=String(e||'').trim();if(!o)return o;if(o.toLowerCase().includes('/proxy?url='))return o;if('function'==typeof t.getCorsProxyUrl)try{const e=t.getCorsProxyUrl(o);if('string'==typeof e&&e)return e}catch(e){}if('function'==typeof t.enableCorsProxy)try{const e=t.enableCorsProxy(o);if('string'==typeof e&&e)return e}catch(e){}if(t.corsProxy?.getProxyUrl)try{const e=t.corsProxy.getProxyUrl(o);if('string'==typeof e&&e)return e}catch(e){}const n=t.location?.origin;return n?`${n}/proxy?url=${encodeURIComponent(o)}`:o},async init(){if(this.isReady){const e=tt.getRuntime(this._top());if(e)return this._runtime=e,!0;this.isReady=!1}if(!await tt.load())return le('SDK 加载失败，无法初始化 Live2DManager'),!1;let e=tt.getRuntime(this._top()),t=30;for(;!e&&t>0;)await new Promise(e=>setTimeout(e,100)),e=tt.getRuntime(this._top()),t--;if(!e?.pixi||!e?.live2dModel)return le('桌面宠物 Live2D runtime 未就绪'),!1;try{const t=e.pixi,o=e.live2dModel;if('function'!=typeof o?.registerTicker)throw new Error('Live2DModel.registerTicker 不可用');return o[St]!==t.Ticker?(o.registerTicker(t.Ticker),o[St]=t.Ticker,ie('Live2D ticker 注册完成')):ie('Live2D ticker 已注册，跳过重复注册'),this._runtime=e,this.isReady=!0,ie('Live2DManager 初始化完成'),!0}catch(e){return le('Live2DManager 初始化失败',e),!1}},async loadModel(e,t){let o=0;const n=(e,n)=>{t&&(o=Math.max(o,Math.round(e)),t({percent:Math.max(0,Math.min(100,o)),message:n}))};if(n(2,'准备加载模型'),!this.isReady){n(8,'初始化 Live2D 引擎');if(!await this.init())return n(100,'Live2D 引擎初始化失败'),!1}const a=tt.getRuntime(this._top())??this._runtime,r=a?.pixi??this._getPIXI(),i=a?.live2dModel??r?.live2d?.Live2DModel;if(!r||!i)return n(100,'Live2D 运行时缺失'),le('Live2D 运行时缺失，无法加载模型'),!1;let s;n(12,'解析模型地址'),s=e.startsWith('http://')||e.startsWith('https://')?e:`https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/${e}`,s=this._normalizeRemoteUrl(s);try{ie('开始加载模型:',e),n(18,'清理旧模型'),this.destroyModel();const t=this._buildModelUrlCandidates(s);let o=null,a=!1,r=s,l=null;for(let e=0;e<t.length;e++){const s=t[e];let c=null,A=!1;const d=t.length>1?` (${e+1}/${t.length})`:'',u=24+Math.floor(e/t.length*38);try{e>0&&ie('主地址加载失败，尝试镜像地址:',s),n(u,`下载模型配置${d}`);const p=await this._buildRemoteModelDataUrl(s);n(u+12,`实例化模型${d}`);try{c=await this._createModelWithTimeout(i,p)}catch(e){se('首次实例化模型失败，尝试强制代理资源重试',e),n(u+16,`实例化失败，代理重试${d}`);const t=await this._buildRemoteModelDataUrl(s,!0);c=await this._createModelWithTimeout(i,t),ie('强制代理资源重试后模型实例化成功')}if(n(u+22,`加载模型纹理${d}`),A=await this._waitForTextures(c,(e,t)=>{if(t<=0)return;const o=Math.max(0,Math.min(1,e/t));n(u+22+14*o,`加载模型纹理 ${e}/${t}${d}`)}),!A){se('纹理未完全加载，尝试通过代理重试模型资源'),n(u+36,`纹理补载重试${d}`);try{const e=await this._buildRemoteModelDataUrl(s,!0),t=await this._createModelWithTimeout(i,e);if(await this._waitForTextures(t,(e,t)=>{if(t<=0)return;const o=Math.max(0,Math.min(1,e/t));n(u+36+8*o,`代理纹理补载 ${e}/${t}${d}`)})){try{c.destroy()}catch{}c=t,A=!0,ie('代理重试后纹理加载成功')}else{se('代理重试后纹理仍未完全加载，继续使用首次加载结果');try{t.destroy()}catch{}}}catch(e){se('代理重试加载失败，继续使用首次加载结果',e)}}if(!A){if(e<t.length-1)throw se('纹理仍未完全加载，将尝试备用地址:',s),n(u+44,`纹理加载失败，切换备用地址${d}`),new Error('纹理加载失败，尝试备用地址');se('纹理仍未完全加载，且已无备用地址可尝试，模型可能不可见')}o=c,a=A,r=s,l=null;break}catch(o){l=o,se(`模型地址尝试失败 (${e+1}/${t.length})`,s,o);try{c?.destroy?.()}catch{}}}if(!o)throw l instanceof Error?l:new Error('模型加载失败');this.model=o;const c=this._readModelBaseBounds(o);return c?(this.modelBaseBounds=c,this.modelBaseWidth=c.width,this.modelBaseHeight=c.height):(this.modelBaseBounds=null,this.modelBaseWidth=o.width>0?o.width:500,this.modelBaseHeight=o.height>0?o.height:800),n(95,'整理模型数据'),ie('模型表情统计',this.getExpressions()),ie('模型动作组统计',this.getMotionGroups()),a||se('模型已挂载，但纹理可能未完全可用'),r!==s&&ie('模型已通过镜像地址加载:',r),n(100,'模型加载完成'),ie('模型加载成功'),!0}catch(e){return n(100,'模型加载失败'),le('模型加载失败:',e),!1}},async _buildRemoteModelDataUrl(e,t=!1){const o=this._buildModelJsonCandidates(e);let n=null,a=e,r=!1;for(const e of o){try{const t=await this._fetchModelJsonCandidate(e,!1);if(t){n=t.modelJson,a=t.sourceUrl,r=!1;break}}catch(t){se('直连获取模型 JSON 失败，尝试代理：',e,t)}try{const t=await this._fetchModelJsonCandidate(e,!0);if(t){n=t.modelJson,a=t.sourceUrl,r=!0;break}}catch(t){se('代理获取模型 JSON 失败：',e,t)}}if(!n)throw new Error('模型 JSON 解析失败');a!==e&&ie('主模型 JSON 解析失败，已回退到:',a);const i=JSON.parse(JSON.stringify(n));this._normalizeLegacyCubism2Settings(i);const s=e=>{if('string'!=typeof e)return e;const o=e.trim();if(!o)return e;const n=this._normalizeResourceRef(o),i=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(n)?this._normalizeRemoteUrl(n):this._normalizeRemoteUrl(new URL(n,a).toString());return(r||t)&&(i.startsWith('http://')||i.startsWith('https://'))?this._getProxiedUrl(i):i};if(i?.FileReferences){const e=i.FileReferences;for(const t of Object.keys(e))'string'==typeof e[t]&&(e[t]=s(e[t]));if('string'==typeof e.Moc&&(e.Moc=s(e.Moc)),Array.isArray(e.Textures)&&(e.Textures=e.Textures.map(s)),'string'==typeof e.Physics&&(e.Physics=s(e.Physics)),'string'==typeof e.Pose&&(e.Pose=s(e.Pose)),'string'==typeof e.UserData&&(e.UserData=s(e.UserData)),e.Motions&&'object'==typeof e.Motions)for(const t of Object.keys(e.Motions)){const o=e.Motions[t];if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.File&&(e.File=s(e.File)),'string'==typeof e.Sound&&(e.Sound=s(e.Sound)))}if(Array.isArray(e.Expressions))for(const t of e.Expressions)t&&'object'==typeof t&&'string'==typeof t.File&&(t.File=s(t.File))}else{'string'==typeof i.model?i.model=s(i.model):'string'==typeof i.Model&&(i.Model=s(i.Model));const e=i.textures||i.Textures;if(Array.isArray(e))for(let t=0;t<e.length;t++)'string'==typeof e[t]&&(e[t]=s(e[t]));'string'==typeof i.physics&&(i.physics=s(i.physics)),'string'==typeof i.Physics&&(i.Physics=s(i.Physics)),'string'==typeof i.pose&&(i.pose=s(i.pose)),'string'==typeof i.Pose&&(i.Pose=s(i.Pose));const t=i.motions||i.Motions;if(t&&'object'==typeof t)for(const e of Object.keys(t)){const o=t[e];if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.file&&(e.file=s(e.file)),'string'==typeof e.File&&(e.File=s(e.File)),'string'==typeof e.sound&&(e.sound=s(e.sound)),'string'==typeof e.Sound&&(e.Sound=s(e.Sound)))}const o=i.expressions||i.Expressions;if(Array.isArray(o))for(const e of o)e&&'object'==typeof e&&('string'==typeof e.file&&(e.file=s(e.file)),'string'==typeof e.File&&(e.File=s(e.File)))}this._lastModelJson=i,this._lastModelJsonSourceUrl=a;const l=JSON.stringify(i);return`data:application/json;base64,${btoa(unescape(encodeURIComponent(l)))}`},mountToStage(e,t,o){if(!this.model)return;const n=at.getStage();if(!n)return;for(;n.children.length>0;)n.removeChildAt(0);const a=this._applyStageTransform(e,t,o);if(a){n.addChild(this.model);try{'autoUpdate'in this.model&&(this.model.autoUpdate=!0)}catch{}ie('模型已挂载到舞台',{stageWidth:a.stageWidth,stageHeight:a.stageHeight,scale:a.finalScale,modelWidth:a.modelWidth,modelHeight:a.modelHeight}),this.autoMotionLoopEnabled?this._startAutoMotionLoop():this._clearAutoMotionLoop()}},updateScale(e,t,o){this.model&&this._applyStageTransform(e,t,o)},_getModelBaseSize(){if(this.modelBaseBounds)return{width:this.modelBaseBounds.width,height:this.modelBaseBounds.height};if(this.modelBaseWidth&&this.modelBaseHeight)return{width:this.modelBaseWidth,height:this.modelBaseHeight};if(!this.model)return{width:500,height:800};const e=this.model.scale?.x||1,t=this.model.scale?.y||1;return{width:this.model.width>0&&0!==e?this.model.width/e:500,height:this.model.height>0&&0!==t?this.model.height/t:800}},getExpressions(){if(!this.model)return[];try{const e=vt(this.model);if(e.length>0)return e;const t=this._lastModelJson;if(t){const e=bt(t);if(e.length>0)return e}return[]}catch(e){return se('获取表情列表失败',e),[]}},getMotionGroups(){const e={};if(!this.model)return e;const t=t=>{if(t&&'object'==typeof t)for(const[o,n]of Object.entries(t)){const t=String(o??''),a=t.trim();if(!a&&''!==t)continue;const r=a||'',i=Number(n),s=Number.isFinite(i)&&i>0?Math.max(1,Math.floor(i)):1,l=e[r];e[r]=Number.isFinite(l)&&l>0?Math.max(l,s):s}},o=this.model?.internalModel?.motionManager,n=o?.definitions;if(n&&'object'==typeof n)for(const[t,o]of Object.entries(n))Array.isArray(o)&&(e[t]=o.length);try{const t=wt(this.model);for(const o of t)Object.prototype.hasOwnProperty.call(e,o)?(!Number.isFinite(e[o])||e[o]<=0)&&(e[o]=1):e[o]=1}catch(e){se('获取动作组列表失败',e)}try{t(xt(this.model?.internalModel?.settings)),t(xt(this.model?.internalModel?.motionManager?.settings))}catch(e){se('动作组运行时补充解析失败',e)}try{const e=this._lastModelJson;e&&t(xt(e))}catch(e){se('动作组兜底解析失败',e)}return e},getMotions(){if(!this.model)return[];try{const e=[],t=new Set,o=o=>{for(const n of Array.isArray(o)?o:[]){const o=String(n?.group??''),a=Number(n?.index),r=Number.isFinite(a)?Math.max(0,Math.floor(a)):0,i=String(n?.name??'').trim();if(!i)continue;const s=`${o}#${r}#${i.toLowerCase()}`;t.has(s)||(t.add(s),e.push({group:o,index:r,name:i}))}};o(Ct(this.model));const n=this._lastModelJson;if(n){const e=n,t=e?.FileReferences?.Motions??e?.Motions??e?.motions??null;t&&o(Ct({internalModel:{motionManager:{definitions:t},settings:n}}))}return e}catch(e){return se('获取动作列表失败',e),[]}},playExpression(e){if(this.model)try{if(e)this.model.expression(e);else{const e=this.getExpressions();if(e.length>0){const t=Math.floor(Math.random()*e.length);this.model.expression(e[t])}}}catch(e){se('播放表情失败:',e)}},playMotion(e,t){if(this.model)try{const o=(e,t)=>{try{return void this.model.motion(e,t)}catch(o){const n=this.model?.internalModel?.motionManager;if('function'==typeof n?.startMotion)return void n.startMotion(e,t,3);if('function'==typeof n?.startRandomMotion)return void n.startRandomMotion(e,3);throw o}};if('string'==typeof e)o(e,t??0);else{const e=this.getMotionGroups(),t=Object.keys(e);if(t.length>0){const n=t[Math.floor(Math.random()*t.length)],a=e[n];o(n,Math.floor(Math.random()*a))}}}catch(e){se('播放动作失败:',e)}},playRandomAnimation(){this.playExpression(),this.playMotion()},focusByClientPoint(e,t,o=!1){const n=this.model;if(n&&Number.isFinite(e)&&Number.isFinite(t)){try{if('function'==typeof n.focus)return void n.focus(e,t,o)}catch{return}try{const a=n?.internalModel?.focusController;if(!a||'function'!=typeof a.focus)return;const r=at.container?.getBoundingClientRect?.();if(!r||r.width<=0||r.height<=0)return;const i=(e-r.left)/r.width*2-1,s=(t-r.top)/r.height*2-1;a.focus(Math.max(-1,Math.min(1,i)),Math.max(-1,Math.min(1,-s)),o)}catch{}}},focusCenter(e=!0){const t=this.model;if(!t)return;const o=at.container?.getBoundingClientRect?.();if(o&&o.width>0&&o.height>0)this.focusByClientPoint(o.left+o.width/2,o.top+o.height/2,e);else try{const o=t?.internalModel?.focusController;if(!o||'function'!=typeof o.focus)return;o.focus(0,0,e)}catch{}},setMouthOpen(e,t){const o=this.model;if(!o?.internalModel?.coreModel)return!1;const n=o.internalModel.coreModel,a=Math.max(0,Math.min(1,t));this._mouthCurrentValue=a;const r=this._top(),i='[酒馆桌面宠物] LipSync参数';this._ensureLipSyncHooks(o),this._installCoreWriteMask(n);const s=(e,t)=>{let o=Number.NaN,a=Number.NaN;const r=e=>{const t=Number(e);return Number.isFinite(t)?t:Number.NaN};if(Number.isFinite(t)&&t>=0){try{'function'==typeof n.getParameterMinimumValue&&(o=r(n.getParameterMinimumValue(t)))}catch{}try{'function'==typeof n.getParameterMaximumValue&&(a=r(n.getParameterMaximumValue(t)))}catch{}}if(!Number.isFinite(o))try{'function'==typeof n.getParamMin&&(o=r(n.getParamMin(e)))}catch{}if(!Number.isFinite(a))try{'function'==typeof n.getParamMax&&(a=r(n.getParamMax(e)))}catch{}return Number.isFinite(o)||(o=0),(!Number.isFinite(a)||a<=o)&&(a=1),{min:o,max:a}},l=(e,t)=>{const{min:o,max:n}=s(e,t);return o<0&&n>0?a*n:o+(n-o)*a},c=e=>{try{if('function'==typeof n.getParameterIndex)return n.getParameterIndex(e)}catch{}try{if('function'==typeof n.getParamIndex)return n.getParamIndex(e)}catch{}return-1},A=e=>{const t=c(e),o=l(e,t);try{if('function'==typeof n.setParameterValueById)return n.setParameterValueById(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValueById)return n.addParameterValueById(e,o,1),!0}catch{}try{if('function'==typeof n.setParamFloat)return n.setParamFloat(e,o,1),!0}catch{}try{if('function'==typeof n.addParamFloat)return n.addParamFloat(e,o,1),!0}catch{}return!1},d=e=>{if(!Number.isFinite(e)||e<0)return!1;const t=(()=>{try{if('function'==typeof n.getParameterId)return String(n.getParameterId(e)||'')}catch{}return''})(),o=l(t||`__idx_${e}`,e);try{if('function'==typeof n.setParameterValueByIndex)return n.setParameterValueByIndex(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValueByIndex)return n.addParameterValueByIndex(e,o,1),!0}catch{}try{if('function'==typeof n.setParameterValue)return n.setParameterValue(e,o,1),!0}catch{}try{if('function'==typeof n.addParameterValue)return n.addParameterValue(e,o,1),!0}catch{}return!1},u=['ParamMouthOpenY','PARAM_MOUTH_OPEN_Y','ParamMouthOpen','ParamA','Param58','Param61','Param_Mouth_Open','mouth_open'];let p=!1;if(this._manualMouthParamEnabled&&this._manualMouthParamIds.length>0)for(const e of this._manualMouthParamIds){const t=c(e);A(e)&&(p=!0),d(t)&&(p=!0)}const m=new Set;for(const e of u){if(m.has(e))continue;m.add(e);const t=c(e);t>=0&&(A(e)&&(p=!0),d(t)&&(p=!0))}if(p)return!0;if(this._mouthParamCore!==n){this._mouthParamCore=n,this._mouthParamIds=[],this._mouthParamIndexes=[],this._mouthParamRangeMins=[],this._mouthParamRangeMaxs=[],this._mouthParamWarned=!1;try{if('function'==typeof n.getParameterCount&&'function'==typeof n.getParameterId){const e=Number(n.getParameterCount())||0,t=[];for(let o=0;o<e;o++){const e=String(n.getParameterId(o)||''),a=e.toLowerCase(),r=s(e,o);a.includes('mouth')||a.includes('lip')||'ParamA'===e?(this._mouthParamIds.push(e),this._mouthParamIndexes.push(o),this._mouthParamRangeMins.push(r.min),this._mouthParamRangeMaxs.push(r.max)):/^param\d+$/i.test(e)&&r.max>=8&&r.min>=-1&&t.push({id:e,idx:o,min:r.min,max:r.max})}if(0===this._mouthParamIds.length&&t.length>0){t.sort((e,t)=>t.max-e.max);const e=t.slice(0,3);for(const t of e)this._mouthParamIds.push(t.id),this._mouthParamIndexes.push(t.idx),this._mouthParamRangeMins.push(t.min),this._mouthParamRangeMaxs.push(t.max);try{r?.console?.log?.(`${i}: 使用数字参数回退`,e)}catch{}}}}catch{}}for(let e=0;e<this._mouthParamIds.length;e++){const t=this._mouthParamIds[e],o=this._mouthParamIndexes[e]??-1;A(t)&&(p=!0),d(o)&&(p=!0)}if(p)return!0;if(!this._mouthParamWarned){this._mouthParamWarned=!0;const e=`${i}: 未找到可用口型参数`;try{r?.console?.warn?.(e,{presetCandidates:u,scannedIds:this._mouthParamIds})}catch{}}return!1},_isMouthParam(e,t){if('number'==typeof e){if(this._mouthParamIndexes.includes(e))return!0;try{if('function'==typeof t?.getParameterId){const o=String(t.getParameterId(e)||'').trim();if(o)return this._isMouthParam(o,t)}}catch{}return!1}const o=String(e||'').trim().toLowerCase();return!!o&&(!!(this._manualMouthParamEnabled&&this._manualMouthParamIdSet.size>0&&this._manualMouthParamIdSet.has(o))||(!!['parammouthopeny','param_mouth_open_y','parammouthopen','parama','param58','param61','param_mouth_open','mouth_open'].includes(o)||this._mouthParamIds.some(e=>String(e||'').trim().toLowerCase()===o)))},_installCoreWriteMask(e){if(!e)return;if(this._writeMaskCore===e)return;if(this._writeMaskRestore){try{this._writeMaskRestore()}catch{}this._writeMaskCore=null,this._writeMaskRestore=null}const t=[],o=['setParameterValueById','addParameterValueById','setParamFloat','addParamFloat','setParameterValueByIndex','addParameterValueByIndex','setParameterValue','addParameterValue'],n=(e,t)=>{if(!Array.isArray(t)||0===t.length)return null;const o=t[0];return e.includes('ById')||'setParamFloat'===e||'addParamFloat'===e?'string'==typeof o?o:null:e.includes('ByIndex')?'number'==typeof o?o:null:'setParameterValue'!==e&&'addParameterValue'!==e||'number'!=typeof o&&'string'!=typeof o?null:o};for(const a of o){const o=e?.[a];'function'==typeof o&&(t.push({method:a,raw:o}),e[a]=(...t)=>{const r=n(a,t);if(!(null!==r&&this._lipSyncActive&&this._inModelUpdate&&this._isMouthParam(r,e)))return o.apply(e,t)})}this._writeMaskCore=e,this._writeMaskRestore=()=>{for(const o of t)try{e[o.method]=o.raw}catch{}}},_ensureLipSyncHooks(e){if(!e)return;if(this._updateHookModel===e)return;if(this._updateHookRestore){try{this._updateHookRestore()}catch{}this._updateHookRestore=null,this._updateHookModel=null}const t=e?.internalModel,o=t?.update;if('function'!=typeof o)return;const n=o.bind(t),a=this;t.update=function(...t){let o;a._inModelUpdate=!0;try{o=n(...t)}finally{if(a._inModelUpdate=!1,a._lipSyncActive)try{a._applyMouthValueToModel(e)}catch{}}return o},this._updateHookModel=e,this._updateHookRestore=()=>{try{t.update=o}catch{}}},_applyMouthValueToModel(e){if(!e?.internalModel?.coreModel)return!1;const t=Math.max(0,Math.min(1,this._mouthCurrentValue||0)),o=this._mouthCurrentValue;this._mouthCurrentValue=t;const n=this.setMouthOpen('__mouth_hook__',t);return this._mouthCurrentValue=o,n},_getMouthParamSource(){return this._manualMouthParamEnabled&&this._manualMouthParamIdSet.size>0?'manual':'auto'},getLipSyncDebugInfo(){this._refreshManualMouthParams();const e=this._getMouthParamSource(),t='manual'===e?this._manualMouthParamIdSet.size:this._mouthParamIds.length;return{lipSyncOverride:this._lipSyncActive?'active':'inactive',mouthParamsSource:e,mouthParamsCount:t}},destroyModel(){if(this._clearAutoMotionLoop(),this._lipSyncActive=!1,this._inModelUpdate=!1,this.model){try{this.model.parent&&this.model.parent.removeChild(this.model),this.model.destroy()}catch(e){se('模型销毁失败',e)}this.model=null}if(this._mouthParamCore=null,this._mouthParamIds=[],this._mouthParamIndexes=[],this._mouthParamRangeMins=[],this._mouthParamRangeMaxs=[],this._mouthParamWarned=!1,this._mouthCurrentValue=0,this._writeMaskRestore)try{this._writeMaskRestore()}catch{}if(this._writeMaskCore=null,this._writeMaskRestore=null,this._updateHookRestore)try{this._updateHookRestore()}catch{}this._updateHookModel=null,this._updateHookRestore=null,this._manualMouthParamEnabled=!1,this._manualMouthParamIds=[],this._manualMouthParamIdSet.clear(),this.modelBaseWidth=null,this.modelBaseHeight=null,this.modelBaseBounds=null,this._lastModelJson=null,this._lastModelJsonSourceUrl=''},_waitForTextures:async(e,t)=>new Promise(o=>{let n=0;const a=()=>{if(n++,n>80){const n=e.internalModel,a=n?.textures||n?._textures||[],r=Array.isArray(a)?a:[],i=r.filter(e=>!!e?.baseTexture?.valid).length;return t?.(i,r.length),se(`纹理加载等待超时 (${i}/${r.length})，模型可能不可见`),void o(!1)}const r=e.internalModel;if(!r)return void setTimeout(a,100);const i=r.textures||r._textures||[];if(0===i.length)return t?.(1,1),void o(!0);const s=i.filter(e=>!!e&&(!e.baseTexture||e.baseTexture.valid)).length;t?.(s,i.length);i.every(e=>!!e&&(!e.baseTexture||e.baseTexture.valid))?o(!0):setTimeout(a,100)};a()})};let Et=null;function Tt(){try{return window.parent??window}catch{return window}}const Mt={audioContext:null,analyser:null,dataArray:null,source:null,animationFrameId:null,currentCharacterId:null,lastVolume:0,connectedAudioElements:new WeakSet,_proxyAudio:null,_proxyAudioCleanup:null,config:{fftSize:256,smoothingFactor:.5,sensitivity:2.5,minThreshold:.01},init(){if(this.audioContext)return void('suspended'===this.audioContext.state&&this.audioContext.resume().then(()=>{console.log(`[${l}] LipSync: AudioContext 已恢复`)}));const e=Tt(),t=e.AudioContext||e.webkitAudioContext;t?(this.audioContext=new t,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.config.fftSize,this.analyser.smoothingTimeConstant=this.config.smoothingFactor,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),console.log(`[${l}] LipSyncManager 初始化完成`)):console.warn(`[${l}] LipSync: 浏览器不支持 Web Audio API`)},_getProxiedAudioUrl(e){if(Et)return Et(e);const t=Tt();if('function'==typeof t.getCorsProxyUrl)try{const o=t.getCorsProxyUrl(e);return console.log(`[${l}] LipSync: 使用 getCorsProxyUrl 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: getCorsProxyUrl 失败`,e)}if('function'==typeof t.enableCorsProxy)try{const o=t.enableCorsProxy(e);if('string'==typeof o&&o)return console.log(`[${l}] LipSync: 使用 enableCorsProxy 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: enableCorsProxy 失败`,e)}if(t.corsProxy?.getProxyUrl)try{const o=t.corsProxy.getProxyUrl(e);return console.log(`[${l}] LipSync: 使用 corsProxy.getProxyUrl 代理音频`),o}catch(e){console.warn(`[${l}] LipSync: corsProxy.getProxyUrl 失败`,e)}if(t.location){const o=t.location.origin;return console.log(`[${l}] LipSync: 使用默认代理端点 /proxy`),`${o}/proxy?url=${encodeURIComponent(e)}`}return e},connectAudio(e){if(!e)return!1;if(this.connectedAudioElements.has(e))return this.init(),'suspended'===this.audioContext?.state&&this.audioContext.resume(),!0;if(this.init(),!this.audioContext||!this.analyser)return!1;'suspended'===this.audioContext.state&&this.audioContext.resume().catch(e=>console.warn('AudioContext resume failed:',e));try{if(this.source)try{this.source.disconnect()}catch{}const t=Tt();let o=e;const n=e.src||'',a=n.includes('127.0.0.1')||n.includes('localhost'),r=n.startsWith('data:'),i=n.startsWith('blob:');let s=!1;try{const e=t.location?.origin||window.location.origin;s=new URL(n,e).origin===e}catch{}if(!(a||r||i||s)){console.log(`[${l}] LipSync: 检测到跨域音频，尝试使用代理`);const t=this._getProxiedAudioUrl(n);if(t&&t!==n){o=new Audio(t),o.crossOrigin='anonymous',console.log(`[${l}] LipSync: 创建代理音频元素`,t.substring(0,50)+'...'),o.currentTime=e.currentTime,o.volume=.001,e.paused||o.play().catch(e=>{console.warn(`[${l}] LipSync: 代理音频播放失败`,e)});const n=()=>{this._proxyAudio&&this._proxyAudio.paused&&(this._proxyAudio.currentTime=e.currentTime,this._proxyAudio.play().catch(()=>{}))},a=()=>{this._proxyAudio&&this._proxyAudio.pause()},r=()=>{this._proxyAudio&&(this._proxyAudio.currentTime=e.currentTime)};e.addEventListener('play',n),e.addEventListener('playing',n),e.addEventListener('pause',a),e.addEventListener('ended',a),e.addEventListener('seeked',r),this._proxyAudio=o,this._proxyAudioCleanup=()=>{e.removeEventListener('play',n),e.removeEventListener('playing',n),e.removeEventListener('pause',a),e.removeEventListener('ended',a),e.removeEventListener('seeked',r)}}}return console.log(`[${l}] LipSync: 连接音频源`,o.src?.substring(0,50)+'...'),this.source=this.audioContext.createMediaElementSource(o),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.connectedAudioElements.add(e),!0}catch(e){return console.warn(`[${l}] LipSync: 连接失败 (可能是跨域或已被其他 Source 连接)`,e),!1}},getVolume(){if(!this.analyser||!this.dataArray)return 0;this.analyser.getByteFrequencyData(this.dataArray);let e=0;const t=Math.floor(.75*this.dataArray.length);for(let o=0;o<t;o++)e+=this.dataArray[o];const o=e/t/255;return Math.min(1,o*this.config.sensitivity)},async startSync(e){if(this.stopSync(),this.currentCharacterId=e,_t._setLipSyncActive(!0),'suspended'===this.audioContext?.state)try{await this.audioContext.resume(),console.log(`[${l}] LipSync: AudioContext 已恢复`)}catch(e){console.warn(`[${l}] LipSync: AudioContext 恢复失败`,e)}console.log(`[${l}] LipSync: 开始口型同步 - characterId=${e}, AudioContext.state=${this.audioContext?.state}`);let t=0;const o=()=>{if(!this.currentCharacterId)return;let e=this.getVolume();e<this.config.minThreshold&&(e=0),e=.4*this.lastVolume+.6*e,this.lastVolume=e,t++,t%30==0&&console.log(`[${l}] LipSync: 音量=${e.toFixed(3)}, rawData[0]=${this.dataArray?.[0]}`),_t.setMouthOpen(this.currentCharacterId,e),this.animationFrameId=requestAnimationFrame(o)};o()},stopSync(){if(this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentCharacterId&&_t.setMouthOpen(this.currentCharacterId,0),this.currentCharacterId=null,this.lastVolume=0,_t._setLipSyncActive(!1),this._proxyAudioCleanup){try{this._proxyAudioCleanup()}catch{}this._proxyAudioCleanup=null}if(this._proxyAudio){try{this._proxyAudio.pause(),this._proxyAudio.src=''}catch{}this._proxyAudio=null}},cleanup(){if(this.stopSync(),this.source){try{this.source.disconnect()}catch{}this.source=null}}};function Nt(){try{return window.parent??window}catch{return window}}function Vt(){try{return ue().settings}catch{return{}}}let Pt=null;function Dt(e){if(Pt)Pt(e);else{try{const t=Nt(),o=t?.toastr||window?.toastr;if(o?.info)return void o.info(e)}catch{}console.log(`[${l}]`,e)}}function $t(e,t=160){const o=String(e||'');return o.length<=t?o:`${o.slice(0,t)}...`}function It(e,t=''){if(404!==e)return!1;const o=String(t||'').toLowerCase();return o.includes('not found')||o.includes('/proxy')||o.includes('cannot get')}function Ut(){return!!_t.model}const Lt={enabled:!0,provider:Me.LITTLEWHITEBOX,autoPlay:!0,isPlaying:!1,isLoading:!1,currentAudio:null,currentSegmentId:null,littleWhiteBox:null,xiaobaixTts:null,_gptSoVitsResolvedProxyRoute:'',_gptSoVitsActiveWeights:{gpt:'',sovits:''},_gptSoVitsWeightSwitchUnavailable:!1,_gptSoVitsWeightSwitchWarned:!1,_gptSoVitsProxyWarned:!1,_gptSoVitsFetchController:null,_edgeDirectFetchController:null,_edgeDirectSocket:null,_edgeDirectObjectUrl:'',_refreshProviderState(){const e=Ue();this.provider=e,this.autoPlay=!1!==Vt()?.ttsAutoPlay;const t=Nt();return e===Me.LITTLEWHITEBOX?(this.xiaobaixTts=null,this.littleWhiteBox=null,t?.xiaobaixTts?(this.xiaobaixTts=t.xiaobaixTts,console.log(`[${l}] TTSManager: 已连接到 xiaobaixTts`)):t?.LittleWhiteBox&&(this.littleWhiteBox=t.LittleWhiteBox,console.log(`[${l}] TTSManager: 已连接到 LittleWhiteBox`)),this.xiaobaixTts||this.littleWhiteBox?(this.enabled=!0,!0):(console.warn(`[${l}] TTSManager: 未找到 xiaobaixTts/LittleWhiteBox，将禁用TTS`),this.enabled=!1,!1)):(this.enabled=!0,!0)},_onPlaybackEnded(e='unknown'){this._cleanupEdgeDirectResources(),console.log(`[${l}] TTS: 播放结束 - reason=${e}`),this.isPlaying=!1,this.isLoading=!1,this.currentAudio=null,this.currentSegmentId=null,this.hideLoadingIndicator(),Mt.stopSync()},init(){this._refreshProviderState();try{const e=Nt(),t=e?.jQuery||e?.$;t&&t(e).on('tts_complete tts_end',()=>{this._onPlaybackEnded('littlewhitebox_event')})}catch{}},showLoadingIndicator(){try{const e=Nt();e.document.getElementById('desktop-pet-stage')?.classList.add('desktop-pet-tts-active')}catch{}},hideLoadingIndicator(){try{const e=Nt();e.document.getElementById('desktop-pet-stage')?.classList.remove('desktop-pet-tts-active')}catch{}},_abortGptSoVitsFetch(e='manual'){if(this._gptSoVitsFetchController){try{this._gptSoVitsFetchController.abort(e)}catch{}this._gptSoVitsFetchController=null}},_cleanupEdgeDirectResources(){if(this._edgeDirectFetchController){try{this._edgeDirectFetchController.abort('cleanup')}catch{}this._edgeDirectFetchController=null}if(this._edgeDirectSocket){try{this._edgeDirectSocket.close(1e3,'cleanup')}catch{}this._edgeDirectSocket=null}if(this._edgeDirectObjectUrl){try{URL.revokeObjectURL(this._edgeDirectObjectUrl)}catch{}this._edgeDirectObjectUrl=''}},stop(){if(this.isPlaying||this.isLoading||this._edgeDirectSocket||this._edgeDirectFetchController||this._edgeDirectObjectUrl){this._abortGptSoVitsFetch('stop'),this._cleanupEdgeDirectResources(),console.log(`[${l}] TTS: 中止当前播放`);try{if(this.currentAudio&&'function'==typeof this.currentAudio.pause){try{this.currentAudio.pause()}catch{}try{this.currentAudio.src='','function'==typeof this.currentAudio.load&&this.currentAudio.load()}catch{}}if(this.xiaobaixTts&&this.xiaobaixTts.player){const e=this.xiaobaixTts.player;'function'==typeof e._stopCurrent&&e._stopCurrent(),'function'==typeof e.clear&&(e.clear(),console.log(`[${l}] TTS: 已清空播放队列`))}else this.xiaobaixTts&&'function'==typeof this.xiaobaixTts.stop?this.xiaobaixTts.stop():this.littleWhiteBox&&'function'==typeof this.littleWhiteBox.stop&&this.littleWhiteBox.stop()}catch(e){console.warn(`[${l}] TTS: 停止播放失败`,e)}this.isPlaying=!1,this.isLoading=!1,this.currentAudio=null,this.currentSegmentId=null,this.hideLoadingIndicator(),Mt.stopSync()}},_getCurrentAudioElement(){if(this.currentAudio)return this.currentAudio;if(this.xiaobaixTts?.player?.currentAudio)return this.xiaobaixTts.player.currentAudio;if(this.xiaobaixTts?.player?.audio)return this.xiaobaixTts.player.audio;if(this.xiaobaixTts?.player?.audioElements?.length>0)return this.xiaobaixTts.player.audioElements[0];if(this.xiaobaixTts?.audio)return this.xiaobaixTts.audio;const e=Nt(),t=e.document.querySelectorAll('audio');for(const e of t)if(e.src&&!e.paused)return e;const o=e.document.querySelector('audio[src]');return o||null},_getPreferredAudioElement(){return this.currentAudio?this.currentAudio:this.xiaobaixTts?.player?.currentAudio?this.xiaobaixTts.player.currentAudio:this.xiaobaixTts?.player?.audio?this.xiaobaixTts.player.audio:this.xiaobaixTts?.player?.audioElements?.length>0?this.xiaobaixTts.player.audioElements[0]:this.xiaobaixTts?.audio?this.xiaobaixTts.audio:null},_isProxyUrl(e){const t=function(e){try{return new URL(String(e||''))}catch{return null}}(e);return!!t&&/^\/proxy(\/|\?|$)/i.test(t.pathname)},_buildGptSoVitsProxyUrl(e,t){const o=String(t||'').trim();if(!o)return'';const n=encodeURIComponent(o),a=window.location?.origin||'';switch(e){case'proxy_path_relative':return`/proxy/${n}`;case'proxy_path_origin':return a?`${a}/proxy/${n}`:'';case'proxy_query_relative':return`/proxy?url=${n}`;case'proxy_query_origin':return a?`${a}/proxy?url=${n}`:'';default:return''}},_rememberProxyRoute(e,t){e&&this._gptSoVitsResolvedProxyRoute!==e&&(this._gptSoVitsResolvedProxyRoute=e,console.log(`[${l}] GPT-SoVITS 浠ｇ悊璺敱宸查攣瀹? ${e} -> ${$t(t,96)}`))},_getProxiedAudioUrl(e){const t=String(e||'').trim();if(!t)return t;if(this._isProxyUrl(t))return t;const o=Nt();if('function'==typeof o.getCorsProxyUrl)try{const e=o.getCorsProxyUrl(t);if('string'==typeof e&&e)return e}catch{}if('function'==typeof o.enableCorsProxy)try{const e=o.enableCorsProxy(t);if('string'==typeof e&&e)return e}catch{}if(o.corsProxy?.getProxyUrl)try{const e=o.corsProxy.getProxyUrl(t);if('string'==typeof e&&e)return e}catch{}const n=String(this._gptSoVitsResolvedProxyRoute||'').trim();if(n){const e=this._buildGptSoVitsProxyUrl(n,t);if(e)return e}return this._buildGptSoVitsProxyUrl('proxy_path_relative',t)||this._buildGptSoVitsProxyUrl('proxy_query_relative',t)||t},_buildGptSoVitsTtsUrl(e,t){const o=Le(),n=String(o.apiUrl||'').replace(/\/$/,''),a=String(o.endpoint||'/tts').trim(),r=a.startsWith('/')?a:`/${a}`;if(!n)return'';try{const a=new URL(n+r),i=t?.gptSoVits||{},s=String(i.textLang||o.textLang||'auto').trim()||'auto',l=String(i.promptLang||'zh').trim()||'zh',c=String(i.refAudioPath||'').trim(),A=String(i.promptText||'').trim();return a.searchParams.set('text',e),a.searchParams.set('text_lang',s),a.searchParams.set('ref_audio_path',c),a.searchParams.set('prompt_lang',l),a.searchParams.set('prompt_text',A),o.textSplitMethod&&a.searchParams.set('text_split_method',String(o.textSplitMethod)),o.mediaType&&a.searchParams.set('media_type',String(o.mediaType)),a.searchParams.set('streaming_mode',o.streamingMode?'true':'false'),o.speedFactor&&a.searchParams.set('speed_factor',String(o.speedFactor)),a.toString()}catch(e){return console.warn(`[${l}] GPT-SoVITS: 生成URL失败`,e),''}},async _requestGptSoVitsApi(e,t,o={},n=void 0){const a=Le(),r=String(a.apiUrl||'').replace(/\/$/,''),i=String(t||'').trim()||'/',s=i.startsWith('/')?i:`/${i}`;if(!r)throw new Error('GPT-SoVITS API 地址为空');const l=new URL(r+s);Object.entries(o||{}).forEach(([e,t])=>{null!=t&&''!==t&&l.searchParams.set(String(e),String(t))});const c=l.toString(),A=[];if(a.useCorsProxy){const e=String(this._gptSoVitsResolvedProxyRoute||'').trim(),t=new Set,o=(e,o)=>{o&&!t.has(o)&&(t.add(o),A.push({route:e,url:o}))};e&&o(e,this._buildGptSoVitsProxyUrl(e,c)),o('proxy_path_relative',this._buildGptSoVitsProxyUrl('proxy_path_relative',c)),o('proxy_path_origin',this._buildGptSoVitsProxyUrl('proxy_path_origin',c)),o('proxy_query_relative',this._buildGptSoVitsProxyUrl('proxy_query_relative',c)),o('proxy_query_origin',this._buildGptSoVitsProxyUrl('proxy_query_origin',c)),o('direct',c)}else A.push({route:'direct',url:c});const d=[];for(const t of A){const o=new AbortController;this._gptSoVitsFetchController=o;try{const a={method:e,mode:'cors',credentials:'omit',signal:o.signal,headers:{}};void 0!==n&&(a.headers['Content-Type']='application/json',a.body=JSON.stringify(n));const r=await fetch(t.url,a),i=await r.text();if(r.ok)return'direct'!==t.route&&this._rememberProxyRoute(t.route,t.url),{text:i,status:r.status,url:t.url,route:t.route};if('direct'!==t.route&&It(r.status,i)){d.push(`${t.route}:HTTP${r.status}(proxy-not-found)`);continue}d.push(`${t.route}:HTTP${r.status}:${$t(i,120)}`)}catch(e){const o=e?.message||String(e);d.push(`${t.route}:${o}`)}finally{this._gptSoVitsFetchController===o&&(this._gptSoVitsFetchController=null)}}throw new Error(`${e} ${s} 失败 -> ${d.join(' | ')}`)},async _fetchGptSoVitsApi(e,t={}){const{text:o}=await this._requestGptSoVitsApi('GET',e,t);return o},async _postGptSoVitsApi(e,t={}){const{text:o}=await this._requestGptSoVitsApi('POST',e,{},t);return o},async _setGptSoVitsWeights(e,t){const o='gpt'===e?'gpt':'sovits',n=String(t||'').trim();if(!n)return;const a=`/set_${o}_weights`;await this._fetchGptSoVitsApi(a,{weights_path:n})},async _setGptSoVitsModelPair(e,t,o=''){const n=Le(),a=String(o||n.setModelEndpoint||'/set_model').trim()||'/set_model';try{return void await this._postGptSoVitsApi(a,{gpt_model_path:String(e||'').trim(),sovits_model_path:String(t||'').trim()})}catch{await this._fetchGptSoVitsApi(a,{gpt_model_path:String(e||'').trim(),sovits_model_path:String(t||'').trim()})}},async _ensureGptSoVitsWeights(e){const t=Le(),o=e?.gptSoVits||{},n=String(o.gptWeightsPath||'').trim(),a=String(o.sovitsWeightsPath||'').trim();let r=$e(o.modelSwitchMode||t.modelSwitchMode);const i=String(o.setModelEndpoint||t.setModelEndpoint||'/set_model').trim()||'/set_model';if('none'===r)return!0;if(!n&&!a)return!0;if(this._gptSoVitsWeightSwitchUnavailable)return!1;if('set_model'===r)if(n&&a)try{return await this._setGptSoVitsModelPair(n,a,i),this._gptSoVitsActiveWeights.gpt=n,this._gptSoVitsActiveWeights.sovits=a,!0}catch(e){console.warn(`[${l}] GPT-SoVITS: set_model 失败，回退 set_weights`,e),r='set_weights'}else r='set_weights';if('set_weights'===r)try{return n&&n!==this._gptSoVitsActiveWeights.gpt&&(await this._setGptSoVitsWeights('gpt',n),this._gptSoVitsActiveWeights.gpt=n),a&&a!==this._gptSoVitsActiveWeights.sovits&&(await this._setGptSoVitsWeights('sovits',a),this._gptSoVitsActiveWeights.sovits=a),!0}catch(e){return this._gptSoVitsWeightSwitchWarned||(this._gptSoVitsWeightSwitchWarned=!0,Dt('GPT-SoVITS 切换权重失败，请检查 /proxy 下 set_* 接口')),console.warn(`[${l}] GPT-SoVITS: set_weights 失败`,e),!1}return!0},async _speakWithGptSoVits(e,t,o){const n=Le(),a=o?.gptSoVits||{};if(!n.apiUrl)return Dt('GPT-SoVITS: 请先在设置中填写 API 地址'),!1;if(!String(a.refAudioPath||'').trim())return Dt('GPT-SoVITS: 当前音色缺少 refAudioPath'),!1;await this._ensureGptSoVitsWeights(o);const r=this._buildGptSoVitsTtsUrl(e.text,o);if(!r)return Dt('GPT-SoVITS: 无法生成请求URL'),!1;const i=n.useCorsProxy?this._getProxiedAudioUrl(r):r,s=new Audio;s.crossOrigin='anonymous',s.src=i,this.currentAudio=s,this.currentSegmentId=t;const c=()=>{this.currentAudio===s&&this._onPlaybackEnded('gpt_sovits_audio_ended')};s.addEventListener('ended',c,{once:!0}),s.addEventListener('error',e=>{console.warn(`[${l}] GPT-SoVITS: audio error`,e),!this._gptSoVitsProxyWarned&&n.useCorsProxy?(this._gptSoVitsProxyWarned=!0,Dt('GPT-SoVITS 代理失败，请检查 /proxy 路由和 CORS 设置')):Dt('GPT-SoVITS 播放失败（请检查地址/代理/CORS）'),c()},{once:!0});try{await s.play()}catch(e){return console.warn(`[${l}] GPT-SoVITS: play() 失败`,e),Dt('GPT-SoVITS 播放被浏览器拦截（需要用户交互）'),c(),!1}if(this.isPlaying=!0,Ut()){const t=e.speaker||'pet';console.log(`[${l}] TTS: 检查口型同步: hasLive2D=true, speaker=${t}`),this._startLipSyncOnPlay(t)}else console.log(`[${l}] TTS: Live2D 未就绪，跳过口型同步`);return!0},async _speakWithEdgeDirect(e,t,o){if(!String(o.value||o.name||'').trim())return Dt('EdgeTTS 直连：无可用音色'),!1;this._cleanupEdgeDirectResources();const n=new AbortController;let a;this._edgeDirectFetchController=n;try{a=await async function(e,t,o={}){const n=Ce(String(e||'')).trim();if(!n)throw new Error('EdgeTTS text is empty');const a=ve(t);if(!a)throw new Error('EdgeTTS voice is empty');const r=await ke(),i=r.security,s=[];i&&(s.push({socketUrl:`${he}&Sec-MS-GEC=${encodeURIComponent(i.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(i.secMsGecVersion)}&ConnectionId=${ye()}`,timestampMode:'utc_string',label:'with-sec/utc'}),s.push({socketUrl:`${he}&Sec-MS-GEC=${encodeURIComponent(i.secMsGec)}&Sec-MS-GEC-Version=${encodeURIComponent(i.secMsGecVersion)}&ConnectionId=${ye()}`,timestampMode:'iso_compact',label:'with-sec/iso'}));const l=`${he}&ConnectionId=${ye()}`;s.push({socketUrl:l,timestampMode:'utc_string',label:'plain/utc'}),s.push({socketUrl:l,timestampMode:'iso_compact',label:'plain/iso'});let c=null;const A=[];for(const e of s)try{return await Te(e.socketUrl,n,a,o,e.timestampMode,e.label)}catch(t){c=t;const n=t instanceof Error?t.message:String(t);if(A.push(`${e.label}: ${n}`),o.signal?.aborted)throw xe('EdgeTTS direct synthesis aborted')}if(A.length>0){const e=String(globalThis.navigator?.userAgent||''),t=/Edg\//i.test(e),o=A.every(e=>/opened=false/.test(e)),n=!t&&o,a=!i&&r.error?` security-unavailable=${r.error};`:'';throw new Error(`EdgeTTS direct synthesis failed.${a}${n?' likely-cause=ua-not-edg;':''} ${A.join(' | ')}`)}throw c instanceof Error?c:new Error('EdgeTTS direct synthesis failed')}(e.text,o,{signal:n.signal,onSocket:e=>{this._edgeDirectSocket=e}})}catch(e){if(!('AbortError'===e?.name)){const t=$t(e?.message||String(e),180),o=/likely-cause=ua-not-edg/i.test(t)?'（当前浏览器不是 Edge，微软接口通常会拒绝握手；请改用 Edge 浏览器重试）':/1006|403|websocket/i.test(t)?'（可能是浏览器 CSP/网络策略拦截了 wss 连接；也可切换 Edge 浏览器复测）':'';console.warn(`[${l}] EdgeTTS 直连合成失败:`,e),Dt(`EdgeTTS 直连失败：${t}${o}`)}return!1}finally{this._edgeDirectFetchController===n&&(this._edgeDirectFetchController=null),this._edgeDirectSocket=null}if(!a||a.size<=0)return Dt('EdgeTTS 直连未返回音频数据'),!1;const r=URL.createObjectURL(a);this._edgeDirectObjectUrl=r;const i=new Audio;i.crossOrigin='anonymous',i.src=r,this.currentAudio=i,this.currentSegmentId=t;const s=()=>{this.currentAudio===i&&this._onPlaybackEnded('edge_direct_audio_ended')};i.addEventListener('ended',s,{once:!0}),i.addEventListener('error',e=>{console.warn(`[${l}] EdgeTTS 直连播放失败:`,e),Dt('EdgeTTS 直连播放失败，可切换 Edge 浏览器复测'),s()},{once:!0});try{await i.play()}catch(e){return console.warn(`[${l}] EdgeTTS 直连 play() 失败:`,e),Dt('EdgeTTS 播放被浏览器拦截，请先进行一次页面交互'),s(),!1}if(this.isPlaying=!0,Ut()){const t=e.speaker||'pet';this._startLipSyncOnPlay(t)}return!0},_startLipSyncWhenModelReady(e,t=5e3){const o=Date.now(),n=()=>{Ut()?this._startLipSyncOnPlay(e,t):Date.now()-o<t?setTimeout(n,120):console.warn(`[${l}] LipSync: 模型加载超时，放弃口型同步 - characterId=${e}`)};n()},async _waitForModelReadyBeforeTTS(e,t=5e3){const o=Date.now();for(;Date.now()-o<t;){if(Ut())return!0;await new Promise(e=>setTimeout(e,120))}return console.warn(`[${l}] TTS: 等待模型就绪超时，仍继续请求TTS`),!1},_startLipSyncOnPlay(e,t=5e3){console.log(`[${l}] LipSync: _startLipSyncOnPlay 被调用 - characterId=${e}`);const o=Date.now();let n=!1;const a=()=>{const r=this._getPreferredAudioElement(),i=r||this._getCurrentAudioElement();if(console.log(`[${l}] LipSync: 获取音频元素 -`,i?`src=${i.src?.substring(0,50)}... paused=${i.paused} currentTime=${i.currentTime}`:'null'),!i)return void(Date.now()-o<t&&!n?setTimeout(a,100):n||console.warn(`[${l}] LipSync: 超时未找到音频元素`));if(!i.paused)return console.log(`[${l}] LipSync: 音频已在播放，立即启动口型同步`),n=!0,void this._bindLipSyncToAudio(i,e);if(!r)return void(Date.now()-o<t&&!n?setTimeout(a,100):n||(console.warn(`[${l}] LipSync: 等待播放超时，尝试强制启动`),i.src&&this._bindLipSyncToAudio(i,e)));console.log(`[${l}] LipSync: 等待音频播放...`);const s=()=>{n||(n=!0,console.log(`[${l}] LipSync: 音频开始播放，启动口型同步`),this._bindLipSyncToAudio(i,e))};i.addEventListener('playing',s,{once:!0}),i.addEventListener('play',s,{once:!0});const c=()=>{n||i.currentTime>0&&!i.paused&&(console.log(`[${l}] LipSync: timeupdate 触发，启动口型同步`),s())};i.addEventListener('timeupdate',c),setTimeout(()=>{i.removeEventListener('playing',s),i.removeEventListener('play',s),i.removeEventListener('timeupdate',c),n||(console.warn(`[${l}] LipSync: 等待播放超时，尝试强制启动`),i.src&&this._bindLipSyncToAudio(i,e))},t)};a()},_bindLipSyncToAudio(e,t){Mt.connectAudio(e)&&Mt.startSync(t);const o=()=>{console.log(`[${l}] LipSync: 音频结束/暂停，停止口型同步`),Mt.stopSync(),e.removeEventListener('ended',o),e.removeEventListener('pause',o)};e.addEventListener('ended',o,{once:!0}),e.addEventListener('pause',o,{once:!0})},async speak(e,t){if(!e||'dialogue'!==e.type)return void(e&&'narration'===e.type&&console.log(`[${l}] TTS: 跳过旁白 - ${e.text.substring(0,30)}...`));if(!e.text)return;const o=Ue();if(o===this.provider&&this.enabled||this._refreshProviderState(),!this.enabled)return;const n=Vt(),a=e.tts||{},r=function(e){try{return JSON.parse(localStorage.getItem(De())||'{}')[e]||null}catch{return null}}(e.speaker);let i=a.speaker||r||n.ttsDefaultSpeaker;i||(i=o===Me.GPT_SOVITS_V2?e.speaker||'':'桃夭'),i||(i='桃夭');const s=a.context||'',c=await async function(e){if(!e)return null;const t=await Je();let o=t.find(t=>t.name===e);if(o)return o;if(o=t.find(t=>t.value===e),o)return o;const n=Ue(),a=n===Me.GPT_SOVITS_V2&&Oe(t)||t[0];return a?(console.warn(`[${l}] 未找到音色 "${e}"，使用默认: ${a.name}`),a):null}(String(i||''));if(!c)return console.error(`[${l}] TTS播放失败: 无法解析音色 "${i}" (provider=${o})`),void(o===Me.GPT_SOVITS_V2&&Dt('GPT-SoVITS: 请先在设置中配置音色列表'));if(console.log(`[${l}] TTS播放: provider=${o}, voiceName=${i}, context=${s||'无'}, text=${e.text.substring(0,30)}...`),Ut())try{const e=_t.getLipSyncDebugInfo();console.log(`[${l}] TTS口型策略: lipSyncOverride=active, mouthParamsSource=${e.mouthParamsSource}, count=${e.mouthParamsCount}`)}catch{}this.isLoading=!0,this.showLoadingIndicator();try{if(await this._waitForModelReadyBeforeTTS(e.speaker),o===Me.GPT_SOVITS_V2)return void await this._speakWithGptSoVits(e,t,c);if(o===Me.EDGE_TTS_DIRECT)return void await this._speakWithEdgeDirect(e,t,c);const n=c.value,a=Qe(n);if(this.xiaobaixTts&&'function'==typeof this.xiaobaixTts.speak)return await this.xiaobaixTts.speak(e.text,{speaker:n,resourceId:a,contextTexts:s?[s]:[]}),this.isPlaying=!0,this.currentSegmentId=t,void(Ut()&&this._startLipSyncOnPlay(e.speaker||'pet'));if(this.littleWhiteBox&&'function'==typeof this.littleWhiteBox.callGenerate)return await this.littleWhiteBox.callGenerate({message:e.text,speaker:n,resourceId:a,contextTexts:s?[s]:[]}),this.isPlaying=!0,this.currentSegmentId=t,void(Ut()&&this._startLipSyncOnPlay(e.speaker||'pet'));console.warn(`[${l}] TTS: 未找到可用的 TTS 接口，请确保 LittleWhiteBox 插件已安装并启用`)}catch(e){console.error(`[${l}] TTS播放失败:`,e)}finally{this.isLoading=!1,this.hideLoadingIndicator()}}},zt={messageCount:0,ignoreNextCount:0,_onTrigger:null,_stops:[],_lastUserSignalAt:0,_config:{autoTrigger:!0,triggerInterval:3,triggerProbability:60,commentTriggerMode:'ai'},init(e,t){this._config={...e},this._onTrigger=t,this._lastUserSignalAt=0;const o=this._bindEvent('MESSAGE_SENT',e=>{ie('检测到用户发送消息(MESSAGE_SENT)'),this._recordUserSignal('message_sent')});o&&this._stops.push(o);const n=this._bindEvent('USER_MESSAGE_RENDERED',e=>{ie('检测到用户消息渲染(USER_MESSAGE_RENDERED)'),this._recordUserSignal('user_message_rendered')});n&&this._stops.push(n);const a=this._bindEvent('GENERATION_AFTER_COMMANDS',(e,t,o)=>{o||t?.quiet_prompt||(ie('检测到用户发送消息(GENERATION_AFTER_COMMANDS)'),this._recordUserSignal('generation_after_commands'))});a&&this._stops.push(a);const r=this._bindEvent('GENERATION_STARTED',(e,t,o)=>{});r&&this._stops.push(r);const i=this._bindEvent('GENERATION_ENDED',e=>{this.ignoreNextCount>0?this.ignoreNextCount--:this._handleTriggerCount('ai')});i&&this._stops.push(i),ie(`聊天监听器初始化完成(mode=${this._config.commentTriggerMode}, interval=${this._config.triggerInterval}, prob=${this._config.triggerProbability})`)},_resolveEventName(e){try{const t=window.parent??window,o=t?.SillyTavern?.eventTypes?.[e];if(o)return String(o)}catch{}try{const t=tavern_events?.[e];if(t)return String(t)}catch{}return null},_bindEvent(e,t){const o=this._resolveEventName(e);if(!o)return se(`未找到可用事件: ${e}`),null;try{const n=window.parent??window,a=n?.SillyTavern?.eventSource;if(a&&'function'==typeof a.on)return a.on(o,t),ie(`事件监听已绑定(${e} -> ${o}, via eventSource)`),{stop:()=>{try{'function'==typeof a.off&&a.off(o,t)}catch{}}}}catch{}if('function'==typeof eventOn){const n=eventOn(o,t);return ie(`事件监听已绑定(${e} -> ${o}, via eventOn)`),n}return se(`事件系统不可用，无法监听: ${e}`),null},updateConfig(e){this._config={...e}},_shouldCountBySource(e){const t=this._config.commentTriggerMode;return'both'===t||t===e},_recordUserSignal(e){const t=Date.now();t-this._lastUserSignalAt<800?ie(`用户信号已去重(${e})`):(this._lastUserSignalAt=t,this._handleTriggerCount('user'))},_handleTriggerCount(e){this._shouldCountBySource(e)&&(this.messageCount++,ie(`消息计数(${e}): ${this.messageCount}`),this._checkAutoTrigger())},_checkAutoTrigger(){if(!this._config.autoTrigger||!this._onTrigger)return;if(this.messageCount<this._config.triggerInterval)return;const e=100*Math.random();e>this._config.triggerProbability?ie(`概率不满足(${e.toFixed(1)} > ${this._config.triggerProbability})`):(this.messageCount=0,ie('自动触发吐槽'),this._onTrigger())},manualTrigger(){this._onTrigger&&(ie('手动触发吐槽'),this._onTrigger())},resetState(){this.messageCount=0,this.ignoreNextCount=0,this._lastUserSignalAt=0,ie('聊天监听状态已重置')},markSelfGeneration(){this.ignoreNextCount++},destroy(){for(const e of this._stops)e.stop();this._stops=[],this._onTrigger=null,this.messageCount=0,this.ignoreNextCount=0,this._lastUserSignalAt=0}},Wt={毒舌吐槽:{systemPrompt:'你是一个毒舌桌面宠物，你的任务是对聊天内容进行犀利点评。\n你说话一针见血、辛辣但不恶毒，像个嘴硬但有趣的损友。\n注意：你的吐槽要幽默有梗，不要真的伤人。',responseFormat:'用1-2句话进行犀利吐槽，不超过50字。'},可爱卖萌:{systemPrompt:'你是一个超级可爱的桌面宠物，你的任务是用软萌的语气对聊天内容做出反应。\n你说话带颜文字，语气温柔可爱，像一个黏人的小动物。',responseFormat:'用1-2句话做出可爱反应，不超过50字。多用颜文字如(≧▽≦)、(｡>﹏<｡)、✧(≖ ◡ ≖✿)等。'},冷静分析:{systemPrompt:'你是一个冷静理性的桌面宠物，你的任务是对聊天内容进行客观简短的分析。\n你说话条理清晰、一针见血，像个沉稳的旁观者。',responseFormat:'用1-2句话进行简短分析，不超过50字。语气冷静客观。'},傲娇:{systemPrompt:'你是一个傲娇的桌面宠物，你的任务是对聊天内容做出口是心非的评论。\n你嘴上说着不在意，但其实很关心聊天的内容。经常用"才、才不是"、"别误会了"之类的说法。',responseFormat:'用1-2句话进行傲娇评论，不超过50字。要体现口是心非的反差。'}};function Ft(e,t){if('自定义'===e&&t)return{systemPrompt:t,responseFormat:'用1-2句简短的话做出评论，不超过50字。'};const o=Wt[e]??Wt['毒舌吐槽'];return{systemPrompt:o.systemPrompt,responseFormat:o.responseFormat}}function Ot(e){return`${e}\n\n【表情COT输出格式（必须严格遵守）】\n- 格式：桌面宠物[表情|语气]: 正文\n- 表情只能从以下列表中选择 1 个：${f.join('、')}\n- 语气可省略；如填写请用简短中文短语（例如“轻松调侃地说”）\n- 只输出一行，不要输出多余内容（不要 Markdown/多段/额外括号）`}function Rt(e){const t=String(e?.roleName||'').trim();if(!t)return'';const o=['【角色视角要求】',`- 你必须以“${t}”的第一人称视角发言。`,'- 语气、态度、措辞要贴合该角色，不要跳出角色。','- 不要提及你是 AI、语言模型或桌面宠物。'],n=String(e?.characterCardContent||'').trim();return n&&(o.push('【角色卡内容（参考）】'),o.push(n)),o.join('\n')}function jt(e){return!!String(e?.roleName||'').trim()&&!0===e?.ignoreCommentStyle}function qt(e){return e.map(e=>`${e.name}(${e.role}): ${String(e.message??'')}`).join('\n')}function Yt(e){return String(e?.referenceText||'').trim()}function Gt(e){const t=Yt(e);return t?`【数据库参考】\n以下内容来自数据库，请将其作为“参考信息”结合当前对话理解，不要逐字复述。\n${t}`:''}function Ht(e,t){return Yt(t)?`${e}\n并在回复中做到：先给一句点评，再给 1 条具体建议。`:e}const Jt={isGenerating:!1,_onComment:null,_streamStop:null,_latestStreamText:'',setCallback(e){this._onComment=e},async generate(){if(this.isGenerating)return void ie('已有生成任务进行中，跳过');this.isGenerating=!0,ie('开始生成吐槽');let e=!1;try{this._onComment?.('',!1);const t=ue().settings;let o=this._getChatContext(t.maxChatContext);if(t.useTamakoTodaySpecial){const e=this._getTamakoTodaySpecialContent();e?(o=[...o,{role:'system',name:'玉子市场今日特选',message:e}],ie(`已注入玉子市场“今日特选”上下文（${e.length} 字）`)):ie('已启用玉子市场兼容，但未读取到“今日特选”，回退到聊天记录')}if(0===o.length)return void ie('没有可用的聊天记录，跳过吐槽');const n=this._resolveRoleplayOptions({roleName:t.roleplayName,ignoreCommentStyle:!!t.roleplayIgnoreCommentStyle,sendCharacterCardContent:!!t.sendCharacterCardContent}),a=this._resolveDiceReferenceOptions(!!t.useDiceDatabaseReference,t.diceReferenceVisibleSheets),{system:r,user:i}=function(e,t,o,n=!1,a,r){const i=jt(a),{systemPrompt:s,responseFormat:l}=i?{systemPrompt:'你需要严格按照角色设定进行发言。',responseFormat:'用1-2句简短的话做出评论，不超过50字。'}:Ft(e,t),c=Ht(l,r),A=n?Ot(c):c,d=Rt(a),u=Gt(r),p=qt(o),m=[s];return d&&m.push(d),u&&m.push(u),m.push(`回复格式要求：${A}`),{system:m.join('\n\n'),user:`以下是最近的聊天记录，请对最新内容做出评论：\n\n${p}`}}(t.commentStyle,t.customPrompt,o,!!t.emotionCotEnabled,n,a);let s;this._latestStreamText='','custom'===t.apiMode&&t.apiConfig.url?s=await this._generateCustom(r,i,t.apiConfig):(zt.markSelfGeneration(),s=await this._generateTavern(r,i,t.apiConfig.max_tokens,t.apiConfig.temperature,!!t.apiConfig.sendWorldInfo));const l=String(s||'').trim()||String(this._latestStreamText||'').trim();l?(this._onComment?.(l,!0),e=!0):se('吐槽生成结果为空')}catch(e){le('吐槽生成失败:',e)}finally{e||this._onComment?.('',!0),this.isGenerating=!1}},async chat(e){const t=String(e||'').trim();if(!t)return;if(this.isGenerating)return void ie('已有生成任务进行中，跳过');this.isGenerating=!0,ie('开始手动聊天生成');let o=!1;try{this._onComment?.('',!1);const e=ue().settings,n=this._getChatContext(e.maxChatContext),a=this._resolveRoleplayOptions({roleName:e.roleplayName,ignoreCommentStyle:!!e.roleplayIgnoreCommentStyle,sendCharacterCardContent:!!e.sendCharacterCardContent}),r=this._resolveDiceReferenceOptions(!!e.useDiceDatabaseReference,e.diceReferenceVisibleSheets),{system:i,user:s}=function(e,t,o,n,a=!1,r,i){const s=jt(r),{systemPrompt:l}=s?{systemPrompt:'你需要严格按照角色设定进行发言。'}:Ft(e,t),c=Ht(s?'用1-3句话回复用户，不超过80字。':function(e){switch(e){case'可爱卖萌':return'用1-3句话回复用户，不超过80字。多用颜文字如(≧▽≦)、(｡>﹏<｡)、✧(≖ ◡ ≖✿)等。';case'冷静分析':return'用1-3句话回复用户，不超过80字。语气冷静客观。';case'傲娇':return'用1-3句话回复用户，不超过80字。要体现口是心非的反差。';case'毒舌吐槽':return'用1-3句话回复用户，不超过80字。可以适度毒舌但不要伤人。';default:return'用1-3句话回复用户，不超过80字。'}}(e),i),A=a?Ot(c):c,d=Rt(r),u=Gt(i),p=String(r?.roleName||'').trim(),m=qt(o),h=String(n||'').trim(),f=[l];return d&&f.push(d),u&&f.push(u),f.push(`回复格式要求：${A}`),f.push(p?'你现在需要保持该角色设定与用户聊天。':'你现在需要以桌面宠物的身份与用户聊天。'),{system:f.join('\n\n'),user:`以下是最近的聊天记录（仅供参考，不要逐字复述）：\n\n${m||'(无)'}\n\n用户对你说：\n${h}\n\n请直接回复用户：`}}(e.commentStyle,e.customPrompt,n,t,!!e.emotionCotEnabled,a,r);let l;this._latestStreamText='','custom'===e.apiMode&&e.apiConfig.url?l=await this._generateCustom(i,s,e.apiConfig):(zt.markSelfGeneration(),l=await this._generateTavern(i,s,e.apiConfig.max_tokens,e.apiConfig.temperature,!!e.apiConfig.sendWorldInfo));const c=String(l||'').trim()||String(this._latestStreamText||'').trim();c?(this._onComment?.(c,!0),o=!0):se('手动聊天生成结果为空')}catch(e){le('聊天生成失败:',e)}finally{o||this._onComment?.('',!0),this.isGenerating=!1}},async _generateTavern(e,t,o,n,a){this._setupStreamListener();const r=a?['world_info_before',{role:'system',content:e},'world_info_after',{role:'user',content:t}]:[{role:'system',content:e},{role:'user',content:t}];try{return await generateRaw({should_silence:!0,should_stream:!0,ordered_prompts:r,custom_api:void 0})}finally{this._cleanupStreamListener()}},async _generateCustom(e,t,o){const n=String(o.url||'').trim(),a=String(o.apiKey||'').trim(),r=String(o.model||'').trim().replace(/^models\//,'');if(!n)throw new Error('自定义 API URL 不能为空。');if(!r)throw new Error('自定义 API 模型不能为空，请先在设置中填写或选择模型。');const i=!!o.usePresetSampling,s=!!o.sendWorldInfo,l=[{role:'system',content:e},{role:'user',content:t}],c=e=>{const t={messages:l,model:r,stream:!1,chat_completion_source:'custom',custom_prompt_post_processing:s?'strict':'none',reverse_proxy:n,custom_url:n,custom_include_headers:a?`Authorization: Bearer ${a}`:''};return i||'minimal'===e||(t.max_tokens=o.max_tokens,t.temperature=o.temperature,t.top_p=o.top_p),i||'full'!==e||(t.frequency_penalty=o.frequency_penalty,t.presence_penalty=o.presence_penalty,t.top_k=o.top_k),t},A=async e=>{const t=await fetch('/api/backends/chat-completions/generate',{method:'POST',headers:{...SillyTavern.getRequestHeaders(),'Content-Type':'application/json'},body:JSON.stringify(c(e))});if(!t.ok){const e=await t.text(),o=new Error(`API请求失败: ${t.status} ${e||t.statusText}`);throw o.status=t.status,o}const o=await t.json();if(o?.choices?.[0]?.message?.content)return String(o.choices[0].message.content).trim();if('string'==typeof o?.content)return o.content.trim();if('string'==typeof o?.text)return o.text.trim();const n='object'==typeof o?JSON.stringify(o):String(o);throw new Error(`API调用返回无效响应: ${n}`)},d=['full','safe','minimal'];let u=null;for(let e=0;e<d.length;e++){const t=d[e];try{return e>0&&se(`自定义 API 参数回退重试：${t}`),await A(t)}catch(o){u=o;const n=o?.status,a=o instanceof Error?o.message:String(o);if(!((422===n||/\b422\b/.test(a))&&e<d.length-1))throw o;se(`自定义 API 返回 422，准备继续回退参数：${t} -> ${d[e+1]}`)}}throw u instanceof Error?u:new Error(String(u))},_setupStreamListener(){this._cleanupStreamListener(),this._streamStop=eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY,e=>{this._latestStreamText=String(e||''),this._onComment?.(e,!1)})},_cleanupStreamListener(){this._streamStop&&(this._streamStop.stop(),this._streamStop=null)},_getChatContext(e){try{const t=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'unhidden'}),o=Array.isArray(t)?t:[],n=Number.isFinite(e)&&e>0?Math.floor(e):20;return o.slice(-n).map(e=>({role:e.role,name:e.name,message:e.message}))}catch(e){return se('获取聊天记录失败:',e),[]}},_resolveRoleplayOptions(e){const t=String(e.roleName||'').trim();if(!t)return;const o={roleName:t,ignoreCommentStyle:!0===e.ignoreCommentStyle};if(e.sendCharacterCardContent){const e=this._getCurrentCharacterCardContent();e?o.characterCardContent=e:ie('角色卡内容开关已开启，但未读取到可用角色卡文本')}return o},_resolveDiceReferenceOptions(e,t){if(!e)return;const o=this._normalizeDiceVisibleSheetNames(t),n=this._getDiceDatabaseReferenceContent(o);if(n)return ie(`已注入数据库参考（${n.length} 字）`),{referenceText:n};ie('数据库参考已启用，但未读取到可用数据')},_getDiceDatabaseReferenceContent(e){const t=this._getDiceDatabaseDataFromApi();if(t){const o=this._summarizeDiceDatabasePayload(t,'AutoCardUpdaterAPI.exportTableAsJson',e);if(o)return o}const o=this._getDiceDatabaseDataFromChatContext();return o?this._summarizeDiceDatabasePayload(o,'聊天楼层 TavernDB_ACU_* 字段',e):''},_getDiceDatabaseDataFromApi(){try{const e=window.parent??window,t=e?.AutoCardUpdaterAPI;return t&&'function'==typeof t.exportTableAsJson?this._normalizeDiceDatabasePayload(t.exportTableAsJson()):null}catch(e){return se('读取数据库 API 失败:',e),null}},_getDiceDatabaseDataFromChatContext(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'all'}),t=Array.isArray(e)?e:[];for(let e=t.length-1;e>=0;e--){const o=this._pickDiceDatabasePayloadFromMessage(t[e]);if(o)return o}}catch(e){se('从聊天记录回退读取数据库失败:',e)}return null},_pickDiceDatabasePayloadFromMessage(e){if(!e||'object'!=typeof e)return null;const t=[e.TavernDB_ACU_IndependentData,e.TavernDB_ACU_Data,e.TavernDB_ACU_SummaryData,e.data?.TavernDB_ACU_IndependentData,e.data?.TavernDB_ACU_Data,e.data?.TavernDB_ACU_SummaryData];for(const e of t){const t=this._normalizeDiceDatabasePayload(e);if(t)return t}const o=[e.TavernDB_ACU_IsolatedData,e.data?.TavernDB_ACU_IsolatedData];for(const e of o){const t=this._pickDiceDatabasePayloadFromIsolatedData(e);if(t)return t}return null},_pickDiceDatabasePayloadFromIsolatedData(e){const t=this._parseMaybeJsonRecord(e);if(!t)return null;const o=Object.keys(t);for(let e=o.length-1;e>=0;e--){const n=this._parseMaybeJsonRecord(t[o[e]]);if(!n)continue;const a=this._normalizeDiceDatabasePayload(n.independentData);if(a)return a}return null},_normalizeDiceDatabasePayload(e){const t=this._parseMaybeJsonRecord(e);if(!t)return null;if(this._isDiceDatabasePayload(t))return t;const o=this._parseMaybeJsonRecord(t.independentData);return o&&this._isDiceDatabasePayload(o)?o:null},_parseMaybeJsonRecord(e){if('string'==typeof e){const t=e.trim();if(!t)return null;try{return this._parseMaybeJsonRecord(JSON.parse(t))}catch{return null}}return!e||'object'!=typeof e||Array.isArray(e)?null:e},_isDiceDatabasePayload:e=>Object.keys(e).some(e=>e.startsWith('sheet_')),_summarizeDiceDatabasePayload(e,t,o){const n=new Set(o.map(e=>this._normalizeReferenceText(e)).filter(e=>!!e)),a=Object.keys(e).filter(e=>e.startsWith('sheet_')).map(t=>this._parseMaybeJsonRecord(e[t])).filter(e=>!!e).map(e=>{const t=this._normalizeReferenceText(e.name||'');return{name:t,priority:this._getDiceSheetPriority(t),text:this._buildDiceSheetSummary(e)}}).filter(e=>!!e.text).filter(e=>0===n.size||n.has(e.name)).sort((e,t)=>e.priority-t.priority||e.name.localeCompare(t.name,'zh-CN')).slice(0,8);if(0===a.length)return'';const r=[`来源：${t}`,'以下为数据库摘要（仅供参考）：'];for(const e of a){const t=`- ${e.text}`;if(`${r.join('\n')}\n${t}`.length>1800)break;r.push(t)}return r.join('\n')},_normalizeDiceVisibleSheetNames(e){if(!Array.isArray(e))return[];const t=[],o=new Set;for(const n of e){const e=this._normalizeReferenceText(n);e&&(o.has(e)||(o.add(e),t.push(e)))}return t},_getDiceSheetPriority:e=>({总结表:0,总体大纲:1,任务与事件表:2,重要人物表:3,全局数据表:4,选项表:5}[e]??99),_buildDiceSheetSummary(e){const t=this._normalizeReferenceText(e.name||'')||'未命名表',o=(Array.isArray(e.content)?e.content:[]).filter(e=>Array.isArray(e));if(0===o.length)return'';const n=(Array.isArray(o[0])?o[0]:[]).map((e,t)=>this._normalizeReferenceText(e)||`字段${t}`),a=o.slice(1).filter(e=>e.some((e,t)=>t>0&&!!this._normalizeReferenceText(e)));if(0===a.length)return`${t}: 暂无有效记录`;const r=a.slice(-2).map(e=>this._formatDiceSheetRow(n,e)).filter(e=>!!e);return 0===r.length?`${t}: 有记录`:`${t}: ${r.join(' | ')}`},_formatDiceSheetRow(e,t){const o=[];for(let n=1;n<t.length;n++){const a=this._normalizeReferenceText(t[n]);if(!a)continue;const r=e[n]||`字段${n}`;if(o.push(`${r}: ${this._truncateReferenceText(a,56)}`),o.length>=3)break}if(o.length>0)return o.join('；');const n=t.map(e=>this._normalizeReferenceText(e)).find(e=>!!e)||'';return this._truncateReferenceText(n,90)},_normalizeReferenceText:e=>String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/\s{2,}/g,' ').trim(),_truncateReferenceText:(e,t)=>e.length<=t?e:`${e.slice(0,Math.max(0,t-1))}…`,_getCurrentCharacterCardContent(){try{const e=SillyTavern?.getContext?.();if(!e)return'';const t=Array.isArray(e.characters)?e.characters:[];if(0===t.length)return'';const o=e.characterId;let n=null;if(null!=o){const e=String(o).trim(),a=Number(e);Number.isFinite(a)&&a>=0&&a<t.length&&(n=t[a])}if(!n){const o=String(e.name2||'').trim();o&&(n=t.find(e=>String(e?.name||'').trim()===o)||null)}if(n||1!==t.length||(n=t[0]),!n)return'';const a=[['角色名',n.name],['角色描述',n.description??n.data?.description],['角色性格',n.personality??n.data?.personality],['场景设定',n.scenario??n.data?.scenario],['开场白',n.first_mes??n.data?.first_mes],['示例对话',n.mes_example??n.data?.mes_example],['系统提示',n.data?.system_prompt],['历史后提示',n.data?.post_history_instructions]];return a.map(([e,t])=>{const o=this._normalizeCharacterCardField(t);return o?`${e}: ${o}`:''}).filter(e=>!!e).join('\n')}catch(e){return se('读取角色卡内容失败:',e),''}},_normalizeCharacterCardField:e=>String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim(),_getTamakoTodaySpecialContent(){try{const e=(window.parent??window).document??document,t='#tamako-market-window .tamako-content[data-content="current"]';if(e.querySelector(`${t} .tamako-empty .message`))return'';const o=e.querySelector(`${t} .tamako-plot-content`),n=this._sanitizeTamakoText(o?.innerText||o?.textContent||'');if(n)return n;const a=e.querySelector(`${t} iframe.tamako-beautifier-frame`),r=this._readTamakoPayloadFromIframe(a),i=this._extractTamakoTextFromPayload(r);if(i)return i;const s=e.querySelector(t);return this._sanitizeTamakoText(s?.innerText||s?.textContent||'')}catch(e){return se('读取玉子市场“今日特选”失败:',e),''}},_readTamakoPayloadFromIframe(e){if(!e)return null;const t=String(e.name||'').trim();if(!t.startsWith('TAMAKO_DATA:'))return null;try{return JSON.parse(t.slice(12))}catch(e){return se('解析玉子市场美化器 payload 失败:',e),null}},_extractTamakoTextFromPayload(e){if(!e||'object'!=typeof e)return'';const t=this._getTamakoCaptureTags(),o=e.tags&&'object'==typeof e.tags?e.tags:{},n=[];for(const e of t){const t=this._sanitizeTamakoText(o[e]);t&&n.push(t)}if(n.length>0)return n.join('\n\n');const a=String(e.raw||'');return a?this._extractTamakoTagText(a,t):''},_getTamakoCaptureTags(){try{const e=SillyTavern?.getContext?.(),t=e?.extensionSettings?.TamakoMarket?.captureTags;if(Array.isArray(t)){const e=t.map(e=>String(e||'').trim()).filter(e=>!!e);if(e.length>0)return e}}catch{}return['recall','scene_direction']},_extractTamakoTagText(e,t){const o=[];for(const n of t){const t=String(n||'').trim();if(!t)continue;const a=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),r=new RegExp(`<${a}(?:\\s[^>]*)?>([\\s\\S]*?)<\\/${a}>`,'gi');let i;for(;null!==(i=r.exec(e));){const e=this._sanitizeTamakoText(i[1]||'');e&&o.push(e)}}return o.join('\n\n')},_sanitizeTamakoText(e){const t=String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();return t?/^(空空如也~|等待中\.\.\.|暂无内容|正在搜寻\.\.\.|扫描中\.\.\.|请稍等\.\.\.)$/.test(t)?'':t:''},destroy(){this._cleanupStreamListener(),this._onComment=null,this._latestStreamText='',this.isGenerating=!1}},Xt=/<(think|thinking)>[\s\S]*?<\/\1>/gi,Kt=/<(think|thinking)>[\s\S]*$/gi;function Qt(e){const t=String(e||'').trim();if(!t)return{rawTag:'',context:null};const o=t.split('|'),n=(o[0]||'').trim(),a=(o[1]||'').trim();return{rawTag:(n.split(',')[0]||'').trim(),context:a||null}}function Zt(e,t){const o=function(e){return String(e||'').replace(Xt,'').replace(Kt,'')}(e);if(!t.enabled)return{cleanText:o,rawTag:null,normalizedTag:null,context:null};if(function(e){const t=String(e||'').trimStart();if(!t)return!1;if(t.startsWith('[')){const e=t.indexOf(']');return-1===e||!t.slice(e+1).trim()}const o=t.indexOf('[');if(o>0&&o<30){const e=t.indexOf(']',o+1);if(-1===e)return!0;const n=t.slice(e+1);return!/^\s*[:：]/.test(n)||!n.replace(/^\s*[:：]\s*/,'').trim()}return!1}(o))return{cleanText:'',rawTag:null,normalizedTag:null,context:null};const n=o.match(/^\s*([^\[\]\n\r]{1,40})\s*\[([^\]]+)\]\s*[:：]\s*([\s\S]*)$/);if(n){const e=n[2]||'',a=n[3]||'',{rawTag:r,context:i}=Qt(e),s=ae(r,t.configs);return{cleanText:s&&t.stripFromText?a.trimStart():o,rawTag:r||null,normalizedTag:s,context:i}}const a=o.match(/^\s*\[([^\]]+)\]\s*([\s\S]*)$/);if(a){const e=a[1]||'',n=a[2]||'',{rawTag:r,context:i}=Qt(e),s=ae(r,t.configs);return{cleanText:s&&t.stripFromText?n.trimStart():o,rawTag:r||null,normalizedTag:s,context:i}}return{cleanText:o,rawTag:null,normalizedTag:null,context:null}}const eo=t('desktop-pet-ui',()=>{const e=(0,s.ref)(!1);return{showSettings:e,openSettings:function(){e.value=!0},closeSettings:function(){e.value=!1}}}),to={class:'bubble-content'},oo={class:'bubble-text'},no={key:1,class:'cursor'},ao=(0,s.defineComponent)({__name:'ChatBubble',props:{text:{},isDone:{type:Boolean},autoCloseDelaySeconds:{}},emits:['hidden'],setup(e,{emit:t}){const o=e,n=t,a=(0,s.ref)(!1),r=(0,s.ref)(''),i=(0,s.ref)({}),l=['。。。','。。','。','。。'];let c=null,A=null,d=null,u=0;function p(e){const t='number'==typeof e?e:Number(e);return Number.isFinite(t)?t:null}function m(){try{const e=function(){try{return window.parent??window}catch{return window}}(),t=e.document.getElementById('desktop-pet-stage'),o=t?.getBoundingClientRect?.(),n=e.innerWidth||e.document.documentElement.clientWidth||0,a=e.innerHeight||e.document.documentElement.clientHeight||0;if(o&&o.width>0&&o.height>0){const e=function(e){const t=_t.model;if(!t||'function'!=typeof t.getBounds)return null;try{const o=t.getBounds?.(),n=p(o?.x),a=p(o?.y),r=p(o?.width),i=p(o?.height);return null===n||null===a||null===r||null===i||r<=0||i<=0?null:{x:e.left+n+r/2,y:e.top+a+.2*i}}catch{return null}}(o),t=o.left+o.width/2,r=o.top+.22*o.height,s=e?.x??t,l=(e?.y??r)-12,c=Math.max(8,Math.min(s,Math.max(8,n-8))),A=Math.max(8,Math.min(l,Math.max(8,a-8)));return void(i.value={left:`${Math.round(c)}px`,top:`${Math.round(A)}px`})}i.value={left:`${Math.round(.5*n)}px`,top:`${Math.round(Math.max(8,.2*a))}px`}}catch{i.value={left:'50vw',top:'20vh'}}}function h(){f(),m(),c=setInterval(m,100)}function f(){c&&(clearInterval(c),c=null)}function g(){A&&(clearInterval(A),A=null)}function b(){d&&(clearTimeout(d),d=null)}function x(){if(b(),!o.isDone)return;if(!String(o.text||'').trim())return;const e=function(){const e='number'==typeof o.autoCloseDelaySeconds?o.autoCloseDelaySeconds:Number(o.autoCloseDelaySeconds??Number.NaN);if(!Number.isFinite(e))return-1;const t=Math.round(e);return t<0?t:1e3*t}();e<0||(d=setTimeout(()=>{d=null,y()},e))}function y(){a.value=!1,r.value='',g(),f(),b(),n('hidden')}return(0,s.watch)([()=>o.text,()=>o.isDone,()=>o.autoCloseDelaySeconds],function(){const e=String(o.text||'');return e?(a.value=!0,r.value=e,g(),h(),void x()):o.isDone?(a.value=!1,r.value='',g(),f(),void b()):(a.value=!0,A||(u=0,r.value=l[u],A=setInterval(()=>{u=(u+1)%l.length,r.value=l[u]},340)),h(),void b())},{immediate:!0}),(0,s.onUnmounted)(()=>{g(),f(),b()}),(t,o)=>a.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'chat-bubble',style:(0,s.normalizeStyle)(i.value)},[(0,s.createElementVNode)('div',to,[e.isDone?((0,s.openBlock)(),(0,s.createElementBlock)('button',{key:0,type:'button',class:'bubble-close','aria-label':'关闭聊天气泡',onClick:y},' × ')):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('span',oo,(0,s.toDisplayString)(r.value),1),e.isDone?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('span',no,'|'))]),o[0]||(o[0]=(0,s.createElementVNode)('div',{class:'bubble-arrow'},null,-1))],4)):(0,s.createCommentVNode)('v-if',!0)}});i(908);var ro=i(235);const io=(0,ro.A)(ao,[['__scopeId','data-v-98097aea']]),so={class:'menu-panel'},lo={class:'command-sub'},co={class:'command-sub'},Ao={key:0,class:'chat-drawer'},uo={class:'drawer-head'},po={class:'drawer-actions'},mo=['disabled'],ho=(0,s.defineComponent)({__name:'FunctionMenu',props:{visible:{type:Boolean},x:{},y:{},placement:{},motionLoopEnabled:{type:Boolean},commentStyle:{}},emits:['close','send-chat','toggle-motion-loop','switch-model','switch-persona','close-model'],setup(e,{emit:t}){const o=e,n=t,a=(0,s.ref)(null),r=(0,s.ref)(null),i=(0,s.ref)(''),l=(0,s.ref)(!1),c=(0,s.ref)(0),A=(0,s.ref)(0);function d(){try{return window.parent??window}catch{return window}}const u=(0,s.computed)(()=>'left'===o.placement?'translate(-100%, -50%)':'translate(0, -50%)'),p=(0,s.computed)(()=>({left:`${c.value}px`,top:`${A.value}px`,transform:u.value}));function m(){const e=a.value;if(!e)return;const t=d(),o=t.innerWidth||t.document.documentElement.clientWidth||0,n=t.innerHeight||t.document.documentElement.clientHeight||0,r=e.getBoundingClientRect();o>0&&(r.left<8?c.value+=8-r.left:r.right>o-8&&(c.value-=r.right-(o-8))),n>0&&(r.top<8?A.value+=8-r.top:r.bottom>n-8&&(A.value-=r.bottom-(n-8)))}function h(){l.value=!1,n('close')}function f(){const e=i.value.trim();e&&(n('send-chat',e),i.value='')}function g(){l.value=!0,(0,s.nextTick)(()=>{m(),r.value?.focus(),r.value?.select()})}function b(e){if('Escape'===e.key)return e.preventDefault(),void h();'Enter'!==e.key||e.shiftKey||(e.preventDefault(),f())}const x=e=>{o.visible&&'Escape'===e.key&&(e.preventDefault(),h())};(0,s.watch)(()=>o.visible,async e=>{e?(c.value=Number.isFinite(o.x)?o.x:0,A.value=Number.isFinite(o.y)?o.y:0,l.value=!1,await(0,s.nextTick)(),m()):l.value=!1},{immediate:!0}),(0,s.watch)(()=>[o.x,o.y,o.placement,l.value],async()=>{o.visible&&(c.value=Number.isFinite(o.x)?o.x:0,A.value=Number.isFinite(o.y)?o.y:0,await(0,s.nextTick)(),m())});try{d().addEventListener('keydown',x)}catch{}return(0,s.onUnmounted)(()=>{try{d().removeEventListener('keydown',x)}catch{}}),(t,o)=>e.visible?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'menu-overlay',onClick:(0,s.withModifiers)(h,['self'])},[(0,s.createElementVNode)('div',{ref_key:'menuEl',ref:a,class:(0,s.normalizeClass)(['menu-cluster',[`is-${e.placement}`,{'chat-open':l.value}]]),style:(0,s.normalizeStyle)(p.value),onClick:o[6]||(o[6]=(0,s.withModifiers)(()=>{},['stop']))},[(0,s.createElementVNode)('div',so,[(0,s.createElementVNode)('div',{class:'panel-top'},[o[7]||(o[7]=(0,s.createElementVNode)('span',{class:'panel-title'},'TACTICAL',-1)),(0,s.createElementVNode)('button',{class:'icon-btn',type:'button',onClick:h},'×')]),(0,s.createElementVNode)('button',{class:(0,s.normalizeClass)(['command-btn',{active:l.value}]),type:'button',onClick:g},[...o[8]||(o[8]=[(0,s.createElementVNode)('span',{class:'command-index'},'01',-1),(0,s.createElementVNode)('span',{class:'command-main'},'CHAT',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'MESSAGE LINK',-1)])],2),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[0]||(o[0]=e=>t.$emit('toggle-motion-loop'))},[o[9]||(o[9]=(0,s.createElementVNode)('span',{class:'command-index'},'02',-1)),o[10]||(o[10]=(0,s.createElementVNode)('span',{class:'command-main'},'MOTION',-1)),(0,s.createElementVNode)('span',lo,(0,s.toDisplayString)(e.motionLoopEnabled?'ON':'OFF'),1)]),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[1]||(o[1]=e=>t.$emit('switch-model'))},[...o[11]||(o[11]=[(0,s.createElementVNode)('span',{class:'command-index'},'03',-1),(0,s.createElementVNode)('span',{class:'command-main'},'MODEL',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'SWITCH',-1)])]),(0,s.createElementVNode)('button',{class:'command-btn',type:'button',onClick:o[2]||(o[2]=e=>t.$emit('switch-persona'))},[o[12]||(o[12]=(0,s.createElementVNode)('span',{class:'command-index'},'04',-1)),o[13]||(o[13]=(0,s.createElementVNode)('span',{class:'command-main'},'PERSONA',-1)),(0,s.createElementVNode)('span',co,(0,s.toDisplayString)(e.commentStyle),1)]),(0,s.createElementVNode)('button',{class:'command-btn danger',type:'button',onClick:o[3]||(o[3]=e=>t.$emit('close-model'))},[...o[14]||(o[14]=[(0,s.createElementVNode)('span',{class:'command-index'},'05',-1),(0,s.createElementVNode)('span',{class:'command-main'},'CLOSE',-1),(0,s.createElementVNode)('span',{class:'command-sub'},'MODEL OFF',-1)])])]),(0,s.createVNode)(s.Transition,{name:'drawer'},{default:(0,s.withCtx)(()=>[l.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Ao,[(0,s.createElementVNode)('div',uo,[o[15]||(o[15]=(0,s.createElementVNode)('span',{class:'drawer-title'},'MESSAGE LINK',-1)),(0,s.createElementVNode)('button',{class:'drawer-close',type:'button',onClick:o[4]||(o[4]=e=>l.value=!1)},'×')]),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{ref_key:'inputEl',ref:r,'onUpdate:modelValue':o[5]||(o[5]=e=>i.value=e),class:'chat-input',rows:'4',placeholder:'输入内容... (Enter 发送 / Shift+Enter 换行)',onKeydown:b},null,544),[[s.vModelText,i.value]]),(0,s.createElementVNode)('div',po,[(0,s.createElementVNode)('button',{class:'send-btn',type:'button',disabled:!i.value.trim(),onClick:f},' SEND ',8,mo)]),o[16]||(o[16]=(0,s.createElementVNode)('div',{class:'drawer-hint'},'系统会读取最近聊天上下文。',-1))])):(0,s.createCommentVNode)('v-if',!0)]),_:1})],6)])):(0,s.createCommentVNode)('v-if',!0)}});i(0);const fo=(0,ro.A)(ho,[['__scopeId','data-v-ff4f8948']]),go=new Map;function bo(e){const t=e.toLowerCase();return'model.json'===t||'model3.json'===t||t.endsWith('.model.json')||t.endsWith('.model3.json')}const xo=['.zip','.rar','.7z','.md','.txt','.png','.jpg','.jpeg','.gif','.bmp','.psd','.webp','.mp3','.wav','.ogg','.mp4','.mtn'];function yo(e){if('dir'===e.type)return!0;if(bo(e.name))return!0;const t=e.name.toLowerCase();for(const e of xo)if(t.endsWith(e))return!1;return bo(e.name)}async function Co(e){const t=go.get(e);if(t)return t;const o=`https://api.github.com/repos/Eikanya/Live2d-model/contents/${e}`;let n;try{const e=await fetch(o,{headers:{Accept:'application/vnd.github.v3+json'}});if(403===e.status){const t=e.headers.get('X-RateLimit-Remaining'),o=e.headers.get('X-RateLimit-Reset'),n=o?new Date(1e3*parseInt(o)):null;throw new vo(t,n)}if(!e.ok)throw new Error(`HTTP ${e.status}`);n=await e.json()}catch(e){if(e instanceof vo)throw e;const t=_t._getProxiedUrl(o),a=await fetch(t,{headers:{Accept:'application/vnd.github.v3+json'}});if(403===a.status)throw new vo(null,null);if(!a.ok)throw new Error(`获取目录失败: HTTP ${a.status}`);n=await a.json()}if(!Array.isArray(n))throw new Error('GitHub API 返回非数组数据');const a=n.map(e=>({name:e.name,path:e.path,type:'dir'===e.type?'dir':'file',isModel:'file'===e.type&&bo(e.name)})).filter(yo).sort((e,t)=>e.type!==t.type?'dir'===e.type?-1:1:e.name.localeCompare(t.name));return go.set(e,a),a}class vo extends Error{remaining;resetDate;constructor(e,t){super(`GitHub API 已达到请求限制，请在 ${t?t.toLocaleTimeString():'未知'} 后重试`),this.name='RateLimitError',this.remaining=e,this.resetDate=t}}const wo={class:'tree-node'},Bo={key:1,class:'expand-icon placeholder'},ko={class:'node-icon'},So=['title'],_o={key:2,class:'node-spinner'},Eo=(0,s.defineComponent)({__name:'TreeNode',props:{entry:{},depth:{},searchQuery:{}},emits:['select-model'],setup(e,{emit:t}){const o=e,n=t,a=(0,s.ref)(!1),r=(0,s.ref)([]),i=(0,s.ref)(!1),l=(0,s.ref)(!1),c=(0,s.ref)(''),A=(0,s.ref)(!1),d=(0,s.computed)(()=>{if(!o.searchQuery.trim())return r.value;const e=o.searchQuery.toLowerCase();return r.value.filter(t=>t.name.toLowerCase().includes(e)||'dir'===t.type)});async function u(){i.value=!0,c.value='';try{r.value=await Co(o.entry.path),l.value=!0}catch(e){c.value=e instanceof vo?e.message:`加载失败: ${e.message||'网络错误'}`}finally{i.value=!1}}function p(){'dir'===o.entry.type?(a.value=!a.value,a.value&&!l.value&&u()):o.entry.isModel&&(A.value=!0,n('select-model',o.entry.path))}return(t,o)=>{const n=(0,s.resolveComponent)('TreeNode',!0);return(0,s.openBlock)(),(0,s.createElementBlock)('div',wo,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['node-row',{'is-model':e.entry.isModel,'is-selected':A.value}]),style:(0,s.normalizeStyle)({paddingLeft:16*e.depth+'px'}),onClick:p},[(0,s.createCommentVNode)(' 展开/折叠箭头（仅目录） '),'dir'===e.entry.type?((0,s.openBlock)(),(0,s.createElementBlock)('span',{key:0,class:(0,s.normalizeClass)(['expand-icon',{expanded:a.value}])},' ▶ ',2)):((0,s.openBlock)(),(0,s.createElementBlock)('span',Bo)),(0,s.createCommentVNode)(' 图标 '),(0,s.createElementVNode)('span',ko,['dir'===e.entry.type?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:0},[(0,s.createTextVNode)('📁')],64)):e.entry.isModel?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createTextVNode)('⭐')],64)):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:2},[(0,s.createTextVNode)('📄')],64))]),(0,s.createCommentVNode)(' 名称 '),(0,s.createElementVNode)('span',{class:'node-name',title:e.entry.path},(0,s.toDisplayString)(e.entry.name),9,So),(0,s.createCommentVNode)(' 加载指示器 '),i.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',_o)):(0,s.createCommentVNode)('v-if',!0)],6),(0,s.createCommentVNode)(' 子节点 '),a.value&&r.value.length>0?((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,{key:0},(0,s.renderList)(d.value,a=>((0,s.openBlock)(),(0,s.createBlock)(n,{key:a.path,entry:a,depth:e.depth+1,'search-query':e.searchQuery,onSelectModel:o[0]||(o[0]=e=>t.$emit('select-model',e))},null,8,['entry','depth','search-query']))),128)):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 子目录为空 '),a.value&&!i.value&&0===r.value.length&&l.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:1,class:'empty-hint',style:(0,s.normalizeStyle)({paddingLeft:16*(e.depth+1)+8+'px'})},' 暂无模型文件 ',4)):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 子目录加载错误 '),a.value&&c.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:2,class:'child-error',style:(0,s.normalizeStyle)({paddingLeft:16*(e.depth+1)+8+'px'})},[(0,s.createTextVNode)((0,s.toDisplayString)(c.value)+' ',1),(0,s.createElementVNode)('button',{class:'retry-link',onClick:(0,s.withModifiers)(u,['stop'])},'重试')],4)):(0,s.createCommentVNode)('v-if',!0)])}}});i(678);const To=(0,ro.A)(Eo,[['__scopeId','data-v-3a6a95ba']]),Mo={class:'model-browser'},No={class:'search-box'},Vo={key:0,class:'error-bar'},Po={class:'tree-container'},Do={key:0,class:'loading-state'},$o={key:0,class:'empty-state'},Io={class:'browser-footer'},Uo={key:0,class:'selected-info'},Lo={class:'selected-path'},zo={key:1,class:'selected-info'},Wo={class:'footer-actions'},Fo=['disabled'],Oo=(0,s.defineComponent)({__name:'ModelBrowser',props:{useCdn:{type:Boolean}},emits:['cancel','load-model'],setup(e,{emit:t}){const o=e,n=t,a=(0,s.ref)([]),r=(0,s.ref)(!1),i=(0,s.ref)(''),l=(0,s.ref)(''),c=(0,s.ref)(''),A=(0,s.computed)(()=>{if(!c.value)return'';const e=c.value.split('/');return e[e.length-1]}),d=(0,s.computed)(()=>{if(!l.value.trim())return a.value;const e=l.value.toLowerCase();return a.value.filter(t=>t.name.toLowerCase().includes(e))});function u(e){c.value=e}function p(){if(!c.value)return;const e=function(e,t=!0){const o=e.split('/').map(e=>encodeURIComponent(e)).join('/');return`${t?b:x}${o}`}(c.value,o.useCdn);n('load-model',e)}async function m(){r.value=!0,i.value='';try{a.value=await Co('')}catch(e){i.value=e instanceof vo?e.message:`加载失败: ${e.message||'网络错误'}`}finally{r.value=!1}}return m(),(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',Mo,[t[5]||(t[5]=(0,s.createElementVNode)('div',{class:'browser-header'},[(0,s.createElementVNode)('span',{class:'browser-title'},'在线模型库'),(0,s.createElementVNode)('span',{class:'browser-hint'},'Eikanya/Live2d-model')],-1)),(0,s.createCommentVNode)(' 搜索框 '),(0,s.createElementVNode)('div',No,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t[0]||(t[0]=e=>l.value=e),placeholder:'搜索已加载的目录...'},null,512),[[s.vModelText,l.value]])]),(0,s.createCommentVNode)(' 错误提示 '),i.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Vo,[(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(i.value),1),(0,s.createElementVNode)('button',{class:'retry-btn',onClick:m},'重试')])):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 树形列表 '),(0,s.createElementVNode)('div',Po,[r.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Do,[...t[2]||(t[2]=[(0,s.createElementVNode)('span',{class:'spinner'},null,-1),(0,s.createTextVNode)(' 加载中... ',-1)])])):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(d.value,e=>((0,s.openBlock)(),(0,s.createBlock)(To,{key:e.path,entry:e,depth:0,'search-query':l.value,onSelectModel:u},null,8,['entry','search-query']))),128)),0!==a.value.length||r.value?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('div',$o,' 该目录下暂无内容 '))],64))]),(0,s.createCommentVNode)(' 已选模型 & 操作 '),(0,s.createElementVNode)('div',Io,[c.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Uo,[t[3]||(t[3]=(0,s.createTextVNode)(' 已选: ',-1)),(0,s.createElementVNode)('span',Lo,(0,s.toDisplayString)(A.value),1)])):((0,s.openBlock)(),(0,s.createElementBlock)('div',zo,[...t[4]||(t[4]=[(0,s.createElementVNode)('span',{class:'no-selection'},'请选择一个模型文件',-1)])])),(0,s.createElementVNode)('div',Wo,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',onClick:t[1]||(t[1]=t=>e.$emit('cancel'))},'取消'),(0,s.createElementVNode)('button',{class:'btn btn-primary',disabled:!c.value,onClick:p},' 确认加载 ',8,Fo)])])]))}});i(355);const Ro=(0,ro.A)(Oo,[['__scopeId','data-v-7ee23a0a']]),jo={class:'panel-main'},qo={class:'panel-nav'},Yo=['onClick'],Go={class:'nav-index'},Ho={class:'nav-label'},Jo={class:'nav-sub'},Xo={class:'panel-body'},Ko={class:'setting-section'},Qo={class:'form-group'},Zo={class:'form-group'},en=['value'],tn={class:'form-group'},on={class:'form-group'},nn={class:'form-group'},an={class:'input-with-btn'},rn=['value'],sn=['disabled'],ln={key:0,class:'hint hint-error'},cn={class:'form-group'},An=['disabled'],dn={key:0,class:'status-badge status-success'},un={key:1,class:'status-badge status-fail'},pn={class:'form-group'},mn={class:'form-group'},hn={class:'form-row'},fn={class:'form-group half'},gn={class:'form-group half'},bn={class:'toggle-icon'},xn={key:0,class:'advanced-params'},yn={class:'form-row'},Cn={class:'form-group half'},vn={class:'form-group half'},wn={class:'form-row'},Bn={class:'form-group half'},kn={class:'form-group half'},Sn={class:'setting-section'},_n={class:'form-group'},En={class:'input-with-btn'},Tn=['disabled'],Mn={class:'form-group'},Nn={class:'model-list'},Vn=['onClick'],Pn={class:'form-group'},Dn={class:'form-group'},$n={class:'form-group'},In={class:'form-group'},Un={class:'setting-section'},Ln={class:'form-group'},zn=['value'],Wn={key:0,class:'form-group'},Fn={class:'form-group'},On={class:'form-group'},Rn=['disabled'],jn={class:'form-group'},qn=['disabled'],Yn={class:'form-group'},Gn={class:'form-group'},Hn=['value'],Jn={class:'form-row'},Xn={class:'form-group half'},Kn={class:'form-group half'},Qn={class:'form-group'},Zn={class:'form-group'},ea={class:'form-group'},ta={class:'form-group'},oa={class:'form-group'},na={class:'form-group'},aa={key:2,class:'form-group'},ra={class:'form-row'},ia={class:'form-group half'},sa=['disabled'],la={class:'form-group'},ca={class:'hint'},Aa={key:0,class:'dice-sheet-list'},da=['checked','onChange'],ua={key:1,class:'hint'},pa={class:'setting-section'},ma={class:'emotion-layout'},ha={class:'emotion-configs'},fa={class:'form-group'},ga={class:'hint'},ba={key:0,class:'form-group'},xa={class:'form-row'},ya={class:'form-group half'},Ca=['disabled'],va={class:'form-row'},wa={class:'form-group half'},Ba={class:'form-group half'},ka={class:'form-group'},Sa={class:'hint'},_a={class:'form-group'},Ea={class:'toggle-icon'},Ta={class:'emotion-map-table'},Ma={class:'emotion-map-tag'},Na=['onUpdate:modelValue'],Va=['value'],Pa=['value'],Da=['value','disabled','onChange'],$a=['value'],Ia=['value'],Ua=['onClick'],La={key:1,class:'emotion-advanced-list'},za={class:'emotion-advanced-title'},Wa={class:'form-row'},Fa={class:'form-group half'},Oa=['value','onBlur'],Ra={class:'form-group half'},ja=['onUpdate:modelValue'],qa={class:'form-group'},Ya=['onUpdate:modelValue'],Ga={class:'emotion-preview-panel'},Ha={class:'emotion-preview-header'},Ja={class:'emotion-preview-tag'},Xa={key:0,class:'emotion-preview-empty'},Ka={class:'emotion-preview-controls'},Qa={class:'emotion-zoom-row'},Za={class:'zoom-value'},er=['title'],tr={class:'setting-section'},or={class:'form-group'},nr={class:'form-group'},ar=['value'],rr=['value'],ir=['value'],sr={class:'form-group'},lr={class:'form-group'},cr={class:'form-group'},Ar={class:'form-group'},dr={class:'input-with-btn'},ur=['value'],pr=['disabled'],mr={class:'hint'},hr={class:'toggle-icon'},fr={key:0,class:'advanced-params'},gr={class:'form-group'},br={class:'form-group'},xr={key:1,class:'advanced-params'},yr={class:'form-group'},Cr={class:'form-group'},vr={class:'form-row'},wr={class:'form-group half'},Br={class:'form-group half'},kr={class:'form-row'},Sr={class:'form-group half'},_r={class:'form-group half'},Er={class:'form-group'},Tr={class:'form-group'},Mr={class:'form-row'},Nr={class:'form-group half'},Vr=['disabled'],Pr={key:2,class:'form-group'},Dr=['disabled'],$r={class:'setting-section'},Ir={class:'browser-dialog-header'},Ur={class:'browser-dialog-body'},Lr=(0,s.defineComponent)({__name:'SettingsPanel',props:{visible:{type:Boolean}},emits:['close','model-change'],setup(e,{emit:t}){const n=e,a=t,r=[{key:'api',index:'01',label:'API 设置',en:'API CONTROL'},{key:'live2d',index:'02',label:'Live2D',en:'MODEL CONTROL'},{key:'comment',index:'03',label:'吐槽',en:'COMMENT SYSTEM'},{key:'expression',index:'04',label:'表情',en:'EMOTION COT'},{key:'tts',index:'05',label:'TTS',en:'VOICE CONTROL'},{key:'about',index:'06',label:'关于',en:'ABOUT & LICENSE'}],i=(0,s.ref)('api'),c=ue(),{settings:A}=o(c);function d(e,t,o,n){const a='number'==typeof e?e:Number(e);return Number.isFinite(a)?Ge(a,o,n):t}function u(){A.value.apiConfig&&'object'==typeof A.value.apiConfig||(A.value.apiConfig={url:'',apiKey:'',model:'gpt-4o-mini',source:'openai',max_tokens:O,temperature:R,frequency_penalty:j,presence_penalty:q,top_p:Y,top_k:G,usePresetSampling:!1,sendWorldInfo:!1});const e=A.value.apiConfig;e.max_tokens=Math.round(d(e.max_tokens,O,1,4096)),e.temperature=d(e.temperature,R,0,2),e.frequency_penalty=d(e.frequency_penalty,j,-2,2),e.presence_penalty=d(e.presence_penalty,q,-2,2),e.top_p=d(e.top_p,Y,0,1),e.top_k=Math.round(d(e.top_k,G,0,500)),'string'!=typeof e.url&&(e.url=String(e.url??'')),'string'!=typeof e.apiKey&&(e.apiKey=String(e.apiKey??'')),'string'!=typeof e.model&&(e.model=String(e.model??'gpt-4o-mini')),'string'!=typeof e.source&&(e.source=String(e.source??'openai')),e.usePresetSampling=!0===e.usePresetSampling,e.sendWorldInfo=!0===e.sendWorldInfo,A.value.petScale=d(A.value.petScale,C,.1,3);const t='number'==typeof A.value.bubbleDuration?A.value.bubbleDuration:Number(A.value.bubbleDuration??Number.NaN),o=Number.isFinite(t)&&t>600?t/1e3:t;A.value.bubbleDuration=Math.round(d(o,H,-1,600))}const b=(0,s.computed)(()=>d(A.value.apiConfig?.temperature,R,0,2).toFixed(1)),x=(0,s.computed)(()=>d(A.value.apiConfig?.frequency_penalty,j,-2,2).toFixed(1)),y=(0,s.computed)(()=>d(A.value.apiConfig?.presence_penalty,q,-2,2).toFixed(1)),v=(0,s.computed)(()=>d(A.value.apiConfig?.top_p,Y,0,1).toFixed(2)),w=(0,s.computed)(()=>d(A.value.petScale,C,.1,3).toFixed(2));u();const B=p,k=m,S=h,E=g,T=(0,s.ref)(!1),M=(0,s.ref)(A.value.modelPath||''),N=(0,s.ref)([]),V=(0,s.ref)(!1);function P(e){return String(e??'').replace(/\u00a0/g,' ').replace(/\r\n/g,'\n').replace(/\n+/g,' ').replace(/\s{2,}/g,' ').trim()}function D(e){const t=new Set,o=[];for(const n of e){const e=P(n);e&&(t.has(e)||(t.add(e),o.push(e)))}return o}function I(e){if('string'==typeof e){const t=e.trim();if(!t)return null;try{return I(JSON.parse(t))}catch{return null}}return!e||'object'!=typeof e||Array.isArray(e)?null:e}function U(e){return Object.keys(e).some(e=>e.startsWith('sheet_'))}function L(e){const t=I(e);if(!t)return[];let o=t;if(!U(o)){const e=I(o.independentData);if(!e||!U(e))return[];o=e}return D(Object.keys(o).filter(e=>e.startsWith('sheet_')).map(e=>{const t=I(o?.[e]);return t?.name??''}))}function W(e){const t=I(e);if(!t)return null;const o=Object.keys(t);for(let e=o.length-1;e>=0;e--){const n=I(t[o[e]]);if(!n)continue;const a=I(n.independentData);if(a&&U(a))return a}return null}function F(e){if(!e||'object'!=typeof e)return null;const t=[e.TavernDB_ACU_IndependentData,e.TavernDB_ACU_Data,e.TavernDB_ACU_SummaryData,e.data?.TavernDB_ACU_IndependentData,e.data?.TavernDB_ACU_Data,e.data?.TavernDB_ACU_SummaryData];for(const e of t){const t=I(e);if(!t)continue;if(U(t))return t;const o=I(t.independentData);if(o&&U(o))return o}const o=[e.TavernDB_ACU_IsolatedData,e.data?.TavernDB_ACU_IsolatedData];for(const e of o){const t=W(e);if(t)return t}return null}function J(){return D((Array.isArray(A.value.diceReferenceVisibleSheets)?A.value.diceReferenceVisibleSheets:[]).map(e=>String(e??'')))}function X(e){A.value.diceReferenceVisibleSheets=D(e)}function K(e){const t=J();return 0===t.length||t.includes(e)}const Q=(0,s.computed)(()=>{const e=N.value.length,t=J();return e<=0?'暂无可用表名。':0===t.length?`当前：全部可见（${e}/${e}）`:`当前：已勾选 ${t.length}/${e}`});function Z(){V.value=!0;try{const e=function(){try{const e=window.parent??window,t=e?.AutoCardUpdaterAPI;return t&&'function'==typeof t.exportTableAsJson?L(t.exportTableAsJson()):[]}catch{return[]}}(),t=e.length>0?[]:function(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'all',hide_state:'all'}),t=Array.isArray(e)?e:[];for(let e=t.length-1;e>=0;e--){const o=F(t[e]);if(!o)continue;const n=L(o);if(n.length>0)return n}}catch{}return[]}(),o=J();N.value=D([...e,...t,...o])}finally{V.value=!1}}function oe(){X([])}function ne(){X([])}const ae=(0,s.ref)(et()),re=(0,s.ref)([]),ie=(0,s.ref)(!1),se=(0,s.ref)(''),le=(0,s.ref)('你好，这是一段 TTS 配音测试。'),ce=(0,s.computed)(()=>`${A.value.ttsProvider===Me.GPT_SOVITS_V2?'GPT-SoVITS：建议把音色 name 设为角色名。':A.value.ttsProvider===Me.EDGE_TTS_DIRECT?'EdgeTTS（直连）：前端直连，不需要插件；失败时可切换 Edge 浏览器复测。':'LittleWhiteBox：未指定/未绑定时使用此默认音色。'}${0===re.value.length?'（当前音色列表为空）':''}`),Ae=f,de=(0,s.ref)([]),pe=(0,s.ref)([]),me=(0,s.ref)([]),he=(0,s.ref)(!1),fe=(0,s.computed)(()=>{const e=new Set,t=[];for(const o of de.value){const n=String(o??'').trim();n&&(e.has(n)||(e.add(n),t.push(n)))}return t.sort((e,t)=>e.localeCompare(t))}),ge=(0,s.computed)(()=>new Set(fe.value));function be(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.floor(t)):0}function xe(e){return{group:String(e.group??'').trim(),index:be(e.index),name:String(e.name??'').trim()}}function ye(e){const t=xe(e);return t.group?JSON.stringify(t):''}function Ce(e){const t=String(e?.live2dMotion?.group||'').trim();if(!t)return null;const o=be(e?.live2dMotion?.index),n=me.value.find(e=>{const n=String(e?.group??'').trim(),a=be(e?.index);return n===t&&a===o});if(n)return xe({group:n.group,index:n.index,name:n.name});const a=t.toLowerCase(),r=me.value.find(e=>{const t=String(e?.name??'').trim().toLowerCase(),n=be(e?.index);return t===a&&n===o})||me.value.find(e=>String(e?.name??'').trim().toLowerCase()===a);return xe(r?{group:r.group,index:r.index,name:r.name}:{group:t,index:o})}function ve(e){const t=Ce(e);return t?ye(t):''}function we(e){const t=Ce(e);if(!t)return'';if(t.name){const e=t.group?`${t.group}#${t.index}`:`#${t.index}`;return`${t.name}（动作 ${e}）`}return`${t.group||'(空动作组)'}#${t.index}`}function Be(e,t){const o=function(e){const t=String(e||'').trim();if(!t)return null;try{const e=JSON.parse(t);if(!e||'object'!=typeof e)return null;const o=String(e.group??'').trim();return o?{group:o,index:be(e.index),name:String(e.name??'').trim()}:null}catch{return null}}(String(t||'').trim());if(!o)return e.live2dMotion.group='',void(e.live2dMotion.index=0);e.live2dMotion.group=o.group,e.live2dMotion.index=o.index}const ke=(0,s.computed)(()=>{const e=new Set,t=[];for(const o of me.value){const n=String(o?.group??'').trim();if(!n)continue;const a=be(o?.index),r=String(o?.name??'').trim(),i=ye({group:n,index:a,name:r});if(!i||e.has(i))continue;e.add(i);const s=`${n}#${a}`,l=r||'(未命名动作)';t.push({key:`motion_${s}_${l}`.replace(/\s+/g,'_'),value:i,label:`${l}（动作 ${s}）`})}for(const o of pe.value){const n=String(o?.name??'').trim();if(!n)continue;const a=ye({group:n,index:0});a&&!e.has(a)&&(e.add(a),t.push({key:`group_${n}_${o.count}`.replace(/\s+/g,'_'),value:a,label:`${n}（动作组 ${o.count}）`}))}return t.sort((e,t)=>e.label.localeCompare(t.label,'zh-CN'))}),Se=(0,s.computed)(()=>new Set(ke.value.map(e=>e.value))),_e=(0,s.computed)(()=>{const e=de.value.length,t=me.value.length,o=pe.value.length;if(!_t.model)return'当前未加载 Live2D 模型，加载后可刷新列表。';return`当前模型：表情 ${e} 个${0===e?'（该模型可能未提供独立 Expressions）':''}，动作 ${t} 个${0===t?'（未识别到 motions）':''}，动作组 ${o} 个。`}),Ee=(0,s.ref)(null),Te=(0,s.ref)(null),Ne=(0,s.ref)(!1),Ve=(0,s.ref)('默认'),De=(0,s.ref)('切换到“表情”后自动加载预览'),$e=(0,s.ref)(1.8);let Ie=0,Ue=0,Le={x:0,y:0,scale:1},ze=!1,Fe={x:0,y:0},je={x:0,y:0},qe=null,Ye=null;function Ge(e,t,o){return Math.max(t,Math.min(o,e))}function He(){const e=Ee.value,t=e?.getBoundingClientRect?.();return{width:Math.max(1,Math.floor(t?.width||e?.clientWidth||320)),height:Math.max(1,Math.floor(t?.height||e?.clientHeight||260))}}function Xe(){if(!Ne.value)return;const e=_t.model;if(!e)return;const{width:t,height:o}=He(),n=Math.max(60,.45*t),a=Math.max(60,.45*o);Ie=Ge(Ie,-n,n),Ue=Ge(Ue,-a,a),$e.value=Ge($e.value,.5,4);const r=Le.scale*$e.value;e.scale?.set&&e.scale.set(r),e.x=Le.x+Ie,e.y=Le.y+Ue;try{const e=at.app;e?.renderer&&e?.stage&&e.renderer.render(e.stage)}catch{}}function Ke(){$e.value=1.8,Ie=0,Ue=0,Xe()}function Qe(e){const t=e?.originalEvent||e;return t?.touches?.length?{x:t.touches[0].clientX,y:t.touches[0].clientY}:t?.changedTouches?.length?{x:t.changedTouches[0].clientX,y:t.changedTouches[0].clientY}:Number.isFinite(t?.clientX)&&Number.isFinite(t?.clientY)?{x:t.clientX,y:t.clientY}:null}function Ze(){try{Ye?.disconnect()}catch{}finally{Ye=null}}async function tt(){return!!Ne.value||(qe||(qe=(async()=>{await(0,s.nextTick)();const e=Ee.value;if(!e)return!1;if(!_t.model)return De.value='当前未加载 Live2D 模型',!1;if(!at.container)return De.value='Live2D 舞台未就绪',!1;De.value='正在挂载预览...';if(!at.pushMount(e))return De.value='预览挂载失败',!1;Ne.value=!0,function(){const e=Te.value;if(!e)return;if(e.__dpPreviewHandlers)return;const t=(window.parent??window).document,o=t=>{if(!Ne.value)return;const o=Qe(t);o&&(ze=!0,Fe=o,je={x:Ie,y:Ue},e.style.cursor='grabbing','function'==typeof t.preventDefault&&t.preventDefault())},n=e=>{if(!ze)return;const t=Qe(e);t&&(Ie=je.x+(t.x-Fe.x),Ue=je.y+(t.y-Fe.y),Xe(),'function'==typeof e.preventDefault&&e.preventDefault())},a=()=>{ze&&(ze=!1,e.style.cursor='grab')},r=e=>{if(!Ne.value)return;e.preventDefault();const t=e.deltaY>0?-.1:.1;$e.value=Ge($e.value+t,.5,4),Xe()};e.style.cursor='grab',e.addEventListener('mousedown',o),e.addEventListener('touchstart',o,{passive:!1}),e.addEventListener('wheel',r,{passive:!1}),t.addEventListener('mousemove',n),t.addEventListener('touchmove',n,{passive:!1}),t.addEventListener('mouseup',a),t.addEventListener('touchend',a),t.addEventListener('touchcancel',a),e.__dpPreviewHandlers={onDown:o,onMove:n,onUp:a,onWheel:r}}(),function(){const e=Ee.value;if(e&&(Ze(),'undefined'!=typeof ResizeObserver))try{Ye=new ResizeObserver(()=>{if(!Ne.value)return;const{width:e,height:t}=He();at.resizePreview(e,t),Xe()}),Ye.observe(e)}catch{Ye=null}}();const{width:t,height:o}=He();return at.resizePreview(t,o),_t.mountToStage(t,o,1),function(){const e=_t.model;if(!e)return;const t=Number(e.scale?.x);Le={x:Number(e.x)||0,y:Number(e.y)||0,scale:Number.isFinite(t)&&t>0?t:1}}(),Ke(),Tt(),De.value='预览就绪，可拖拽移动/滚轮缩放',!0})().finally(()=>{qe=null}),qe))}function ot(){if(Ze(),function(){const e=Te.value;if(!e)return;const t=(window.parent??window).document,o=e.__dpPreviewHandlers;if(o){try{e.removeEventListener('mousedown',o.onDown),e.removeEventListener('touchstart',o.onDown),e.removeEventListener('wheel',o.onWheel),t.removeEventListener('mousemove',o.onMove),t.removeEventListener('touchmove',o.onMove),t.removeEventListener('mouseup',o.onUp),t.removeEventListener('touchend',o.onUp),t.removeEventListener('touchcancel',o.onUp)}catch{}e.__dpPreviewHandlers=null}}(),ze=!1,!Ne.value)return;Ne.value=!1;const e=at.popMount();e&&_t.model&&_t.mountToStage(e.width,e.height,1),De.value='切换到“表情”后自动加载预览'}function nt(){Vt(Ve.value)}(0,s.watch)(()=>({visible:n.visible,section:i.value}),({visible:e,section:t})=>{e&&'expression'===t?(async()=>{await tt()&&Vt(Ve.value)})():ot()},{immediate:!0}),(0,s.onBeforeUnmount)(()=>{ot()});const rt=(0,s.ref)([]),it=(0,s.ref)(!1),st=(0,s.ref)(''),lt=(0,s.ref)(!1),ct=(0,s.ref)('idle'),At=(0,s.ref)(''),dt=(0,s.ref)(!1),ut=(0,s.ref)(!1),pt=(0,s.ref)(!1),mt=(0,s.ref)(''),ht={position:'fixed',inset:'0',width:'100vw',height:'100vh',minHeight:'100vh',zIndex:'10001',display:'flex',alignItems:'center',justifyContent:'center'},ft={position:'relative',display:'flex',flexDirection:'column',width:'min(1080px, calc(100vw - 24px))',maxHeight:'calc(100vh - 24px)',minHeight:'280px'};function gt(e){if(!Array.isArray(e))return[];const t=[];for(const o of e){if('string'==typeof o){const e=o.trim();e&&t.push(e);continue}if(o&&'object'==typeof o){const e=o.id,n=o.model,a=o.name,r=('string'==typeof e?e:'string'==typeof n?n:'string'==typeof a?a:'').trim();r&&t.push(r)}}return[...new Set(t)]}async function bt(e){const t=window?.TavernHelper?.getModelList;if('function'==typeof t)try{const o=gt(await t(e));if(o.length>0)return o}catch(e){console.warn(`[${l}] TavernHelper.getModelList 调用失败，改用 HTTP 回退`,e)}if('function'==typeof getModelList)try{const t=gt(await getModelList(e));if(t.length>0)return t}catch(e){console.warn(`[${l}] getModelList 调用失败，改用 HTTP 回退`,e)}return async function(e){const t=String(e.apiurl||'').trim().replace(/\/+$/,'');if(!t)throw new Error('API URL 为空');const o={Accept:'application/json'};e.key&&(o.Authorization=`Bearer ${e.key}`);const n=async e=>fetch(`${t}${e}`,{method:'GET',headers:o,cache:'no-cache'});let a=await n('/v1/models');if(a.ok||404!==a.status&&405!==a.status||(a=await n('/models')),!a.ok)throw new Error(`模型列表请求失败 (HTTP ${a.status})`);const r=await a.json();return gt(r.data??r.models??r)}(e)}async function xt(){const e=A.value.apiConfig.url;if(e){it.value=!0,st.value='',rt.value=[];try{const t=await bt({apiurl:e,key:A.value.apiConfig.apiKey||void 0});rt.value=t,t.length>0&&!t.includes(A.value.apiConfig.model)&&(A.value.apiConfig.model=t[0])}catch(e){st.value=`获取失败: ${e instanceof Error?e.message:String(e)}`}finally{it.value=!1}}}async function yt(){const e=A.value.apiConfig.url;if(e){lt.value=!0,ct.value='idle',At.value='';try{const t=await bt({apiurl:e,key:A.value.apiConfig.apiKey||void 0});t&&t.length>=0?ct.value='success':(ct.value='fail',At.value='返回数据异常')}catch(e){ct.value='fail',At.value=e instanceof Error?e.message:String(e)}finally{lt.value=!1}}}function Ct(e){A.value.modelPath=e,M.value=e,T.value=!1,a('model-change',e)}function vt(){let e=M.value.trim();if(!e)return;const t=e.match(/^https?:\/\/github\.com\/([^/]+\/[^/]+)\/blob\/(.+)$/);t&&(e=`https://raw.githubusercontent.com/${t[1]}/${t[2]}`,M.value=e),A.value.modelPath=e,a('model-change',e)}function wt(){c.resetSettings()}function St(){A.value.emotionConfigs=te();try{toastr.success('表情配置已重置为默认')}catch{}}function Et(e,t){const o=t.target;o&&(e.aliases=function(e){return ee(String(e||'').split(/[,，\n\r]+/g).map(e=>e.trim()).filter(Boolean))}(o.value))}function Tt(){he.value=!0;try{de.value=_t.getExpressions(),me.value=_t.getMotions().map(e=>({name:e.name,group:e.group,index:e.index})).sort((e,t)=>e.name.localeCompare(t.name));const e=_t.getMotionGroups();pe.value=Object.entries(e).map(([e,t])=>({name:e,count:t})).sort((e,t)=>e.name.localeCompare(t.name));try{toastr.info('已刷新模型表情/动作列表')}catch{}}catch(e){console.warn(`[${l}] 刷新模型表情/动作列表失败:`,e),de.value=[],me.value=[],pe.value=[];try{toastr.error('刷新列表失败，请先确保模型已加载')}catch{}}finally{he.value=!1}}function Mt(e=!1){const t=_t.model;if(!t){try{toastr.warning('当前未加载模型，无法自动匹配')}catch{}return}let o=0;for(const n of A.value.emotionConfigs){const a=String(n.live2dExpression||'').trim();if(e||!a){const e=Bt(t,n.tag);e&&(n.live2dExpression=e,o+=1)}const r=!1!==n.live2dMotion?.enabled,i=String(n.live2dMotion?.group||'').trim();if(r&&(e||!i)){const e=kt(t,n.tag);e&&(n.live2dMotion.group=e.group,n.live2dMotion.index=e.index,o+=1)}}try{e?toastr.success(o>0?`已自动匹配并覆盖 ${o} 项`:'未找到可覆盖的匹配结果'):toastr.success(o>0?`已自动匹配并填充 ${o} 项空白覆盖`:'未找到可填充的空白覆盖')}catch{}}function Nt(){let e=0;for(const t of A.value.emotionConfigs){const o=!!String(t.live2dExpression||'').trim(),n=!!String(t.live2dMotion?.group||'').trim();o&&(t.live2dExpression='',e+=1),n&&(t.live2dMotion.group='',t.live2dMotion.index=0,e+=1)}try{toastr.info(e>0?`已清空 ${e} 项 Live2D 覆盖`:'当前没有需要清空的 Live2D 覆盖')}catch{}}async function Vt(e){Ve.value=e;if(!await tt())return;const t=_t.model;if(!t)return void(De.value='模型未就绪');Xe();const o=A.value.emotionConfigs.find(t=>t.tag===e),n=Bt(t,e,o?.live2dExpression);n&&_t.playExpression(n);const a=kt(t,e,o?.live2dMotion);a&&_t.playMotion(a.group,a.index);const r=n?`表情: ${n}`:'表情: (无匹配)',i=a?a.name?`动作: ${a.name} (${a.group||'(空动作组)'}#${a.index})`:`动作: ${a.group||'(空动作组)'}`:'动作: (无匹配)';if(De.value=`${e} | ${r} | ${i}`,!n&&!a)try{toastr.info('未匹配到可用的表情/动作（可尝试刷新列表或手动覆盖）')}catch{}}function Pt(){if(function(e){try{localStorage.setItem(Pe(),String(e))}catch(e){console.error(`[${l}] 保存TTS启用状态失败:`,e)}}(ae.value),!ae.value)try{Lt.stop()}catch{}}async function Dt(){ie.value=!0;try{re.value=await Je()}catch(e){console.warn(`[${l}] 获取 TTS 音色列表失败:`,e),re.value=[]}finally{ie.value=!1}}function $t(){let e=null;try{e=JSON.parse(se.value||'[]')}catch{return void toastr.error('音色列表 JSON 解析失败')}if(!Array.isArray(e))return void toastr.error('音色列表必须是数组');const t=function(e,t=null){const o=[];let n=0,a=0;for(const r of Array.isArray(e)?e:[]){const e=We(r,t);e?(e.refAudioPath||(a+=1),o.push(e)):n+=1}return{voices:o,ignoredCount:n,missingRefCount:a}}(e);A.value.gptSoVits.voices=t.voices;const o=Oe(Re());!A.value.ttsDefaultSpeaker&&o?.name&&(A.value.ttsDefaultSpeaker=o.name),Dt();let n=`GPT-SoVITS 音色列表已保存：${t.voices.length} 条`;t.ignoredCount>0&&(n+=`（忽略无效条目 ${t.ignoredCount} 条）`),t.missingRefCount>0&&(n+=`（${t.missingRefCount} 条缺 refAudioPath）`),toastr.success(n)}async function It(){if(!ae.value)return;const e=String(le.value||'').trim()||'你好，这是一段 TTS 配音测试。',t=function(){try{const e=SillyTavern?.getContext?.();if(null!=e?.characterId)return String(e.characterId)}catch{}return'default'}();let o=String(A.value.ttsDefaultSpeaker||'').trim();if(A.value.ttsProvider===Me.GPT_SOVITS_V2){const e=Re(),t=e.find(e=>e.name===o)||null,n=!!String(t?.gptSoVits?.refAudioPath||'').trim(),a=Oe(e),r=n?t:a,i=String(r?.name||'').trim();if(!i)return void toastr.error('请先配置至少一个可用音色（refAudioPath 不能为空）');o!==i&&(A.value.ttsDefaultSpeaker=i,o=i,toastr.info(`已自动切换试听音色为：${i}`))}else if(A.value.ttsProvider===Me.EDGE_TTS_DIRECT&&!o){const e=re.value.length>0?re.value:await Je(),t=String(e[0]?.name||e[0]?.value||'').trim();if(!t)return void toastr.error('当前无可用 EdgeTTS 音色，请先刷新音色列表');A.value.ttsDefaultSpeaker=t,o=t}try{Lt.stop(),await Lt.speak({type:'dialogue',speaker:t,text:e,tts:o?{speaker:o}:void 0},`desktop_pet_tts_test_${Date.now()}`)}catch(e){console.warn(`[${l}] TTS 试听失败:`,e)}}function Ut(){try{Lt.stop()}catch{}}function zt(){const e=String(mt.value||'').split(/[\n,]/).map(e=>String(e||'').trim()).filter(Boolean),t=Array.from(new Set(e));A.value.lipSyncManualParamIds=t,mt.value=t.join('\n')}function Wt(){zt(),a('close')}return(0,s.watch)(()=>n.visible,e=>{if(e){u(),i.value='api',ut.value=!1,ae.value=et(),mt.value=Array.isArray(A.value.lipSyncManualParamIds)?A.value.lipSyncManualParamIds.join('\n'):'';try{se.value=JSON.stringify(A.value.gptSoVits?.voices||[],null,2)}catch{se.value='[]'}Dt(),Z()}},{immediate:!0}),(0,s.watch)(()=>A.value.ttsProvider,()=>{try{Lt._refreshProviderState()}catch{}Dt()}),(0,s.watch)(()=>A.value.useDiceDatabaseReference,e=>{e&&Z()}),(t,o)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',null,[e.visible?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'settings-overlay dp-settings-overlay',style:ht,onClick:(0,s.withModifiers)(Wt,['self'])},[(0,s.createElementVNode)('div',{class:'settings-panel dp-settings-panel',style:ft},[(0,s.createElementVNode)('div',{class:'panel-header'},[o[64]||(o[64]=(0,s.createElementVNode)('div',{class:'header-title'},[(0,s.createElementVNode)('h3',null,'桌面宠物控制终端'),(0,s.createElementVNode)('p',null,'SYSTEM // SETTINGS')],-1)),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:Wt},'CLOSE')]),(0,s.createElementVNode)('div',jo,[(0,s.createElementVNode)('aside',qo,[((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(r,e=>(0,s.createElementVNode)('button',{key:e.key,class:(0,s.normalizeClass)(['nav-btn',{active:i.value===e.key}]),type:'button',onClick:t=>i.value=e.key},[(0,s.createElementVNode)('span',Go,(0,s.toDisplayString)(e.index),1),(0,s.createElementVNode)('span',Ho,(0,s.toDisplayString)(e.label),1),(0,s.createElementVNode)('span',Jo,(0,s.toDisplayString)(e.en),1)],10,Yo)),64))]),(0,s.createElementVNode)('div',Xo,[(0,s.withDirectives)((0,s.createElementVNode)('section',Ko,[o[78]||(o[78]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'01'),(0,s.createElementVNode)('span',{class:'section-label'},'API 设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'API CONTROL')],-1)),(0,s.createElementVNode)('div',Qo,[o[66]||(o[66]=(0,s.createElementVNode)('label',null,'API 模式',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[0]||(o[0]=e=>(0,s.unref)(A).apiMode=e)},[...o[65]||(o[65]=[(0,s.createElementVNode)('option',{value:'tavern'},'酒馆主 API',-1),(0,s.createElementVNode)('option',{value:'custom'},'自定义 API',-1)])],512),[[s.vModelSelect,(0,s.unref)(A).apiMode]])]),'custom'===(0,s.unref)(A).apiMode?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:0},[(0,s.createElementVNode)('div',Zo,[o[67]||(o[67]=(0,s.createElementVNode)('label',null,'API Source',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[1]||(o[1]=e=>(0,s.unref)(A).apiConfig.source=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(E),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.value,value:e.value},(0,s.toDisplayString)(e.label),9,en))),128))],512),[[s.vModelSelect,(0,s.unref)(A).apiConfig.source]])]),(0,s.createElementVNode)('div',tn,[o[68]||(o[68]=(0,s.createElementVNode)('label',null,'API URL',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[2]||(o[2]=e=>(0,s.unref)(A).apiConfig.url=e),placeholder:'https://api.openai.com/v1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.url]])]),(0,s.createElementVNode)('div',on,[o[69]||(o[69]=(0,s.createElementVNode)('label',null,'API Key',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'password','onUpdate:modelValue':o[3]||(o[3]=e=>(0,s.unref)(A).apiConfig.apiKey=e),placeholder:'sk-...'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.apiKey]])]),(0,s.createElementVNode)('div',nn,[o[70]||(o[70]=(0,s.createElementVNode)('label',null,'模型',-1)),(0,s.createElementVNode)('div',an,[0===rt.value.length?(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)('input',{key:0,type:'text','onUpdate:modelValue':o[4]||(o[4]=e=>(0,s.unref)(A).apiConfig.model=e),placeholder:'gpt-4o-mini'},null,512)),[[s.vModelText,(0,s.unref)(A).apiConfig.model]]):(0,s.withDirectives)(((0,s.openBlock)(),(0,s.createElementBlock)('select',{key:1,'onUpdate:modelValue':o[5]||(o[5]=e=>(0,s.unref)(A).apiConfig.model=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(rt.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,rn))),128))],512)),[[s.vModelSelect,(0,s.unref)(A).apiConfig.model]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:xt,disabled:!(0,s.unref)(A).apiConfig.url||it.value},(0,s.toDisplayString)(it.value?'获取中...':'获取模型'),9,sn)]),st.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',ln,(0,s.toDisplayString)(st.value),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('div',cn,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',disabled:!(0,s.unref)(A).apiConfig.url||lt.value,onClick:yt},(0,s.toDisplayString)(lt.value?'测试中...':'测试连接'),9,An),'success'===ct.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',dn,'连接成功')):(0,s.createCommentVNode)('v-if',!0),'fail'===ct.value?((0,s.openBlock)(),(0,s.createElementBlock)('span',un,(0,s.toDisplayString)(At.value),1)):(0,s.createCommentVNode)('v-if',!0)])],64)):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',pn,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[6]||(o[6]=e=>(0,s.unref)(A).apiConfig.usePresetSampling=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).apiConfig.usePresetSampling]]),o[71]||(o[71]=(0,s.createTextVNode)(' 跟随酒馆预设采样参数 ',-1))]),o[72]||(o[72]=(0,s.createElementVNode)('div',{class:'hint'},'启用后，采样参数将使用酒馆当前预设的值。',-1))]),(0,s.createElementVNode)('div',mn,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[7]||(o[7]=e=>(0,s.unref)(A).apiConfig.sendWorldInfo=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).apiConfig.sendWorldInfo]]),o[73]||(o[73]=(0,s.createTextVNode)(' 发送世界书（World Info） ',-1))]),o[74]||(o[74]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后不注入世界书提示词，默认关闭。',-1))]),(0,s.unref)(A).apiConfig.usePresetSampling?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createElementVNode)('div',hn,[(0,s.createElementVNode)('div',fn,[o[75]||(o[75]=(0,s.createElementVNode)('label',null,'Max Tokens',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[8]||(o[8]=e=>(0,s.unref)(A).apiConfig.max_tokens=e),min:'1',max:'4096'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.max_tokens,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',gn,[(0,s.createElementVNode)('label',null,'Temperature ('+(0,s.toDisplayString)(b.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[9]||(o[9]=e=>(0,s.unref)(A).apiConfig.temperature=e),min:'0',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.temperature,void 0,{number:!0}]])])]),(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[10]||(o[10]=e=>dt.value=!dt.value)},[(0,s.createElementVNode)('span',bn,(0,s.toDisplayString)(dt.value?'▼':'▶'),1),o[76]||(o[76]=(0,s.createTextVNode)(' 高级采样参数 ',-1))]),dt.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',xn,[(0,s.createElementVNode)('div',yn,[(0,s.createElementVNode)('div',Cn,[(0,s.createElementVNode)('label',null,'Frequency Penalty ('+(0,s.toDisplayString)(x.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[11]||(o[11]=e=>(0,s.unref)(A).apiConfig.frequency_penalty=e),min:'-2',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.frequency_penalty,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',vn,[(0,s.createElementVNode)('label',null,'Presence Penalty ('+(0,s.toDisplayString)(y.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[12]||(o[12]=e=>(0,s.unref)(A).apiConfig.presence_penalty=e),min:'-2',max:'2',step:'0.1'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.presence_penalty,void 0,{number:!0}]])])]),(0,s.createElementVNode)('div',wn,[(0,s.createElementVNode)('div',Bn,[(0,s.createElementVNode)('label',null,'Top P ('+(0,s.toDisplayString)(v.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[13]||(o[13]=e=>(0,s.unref)(A).apiConfig.top_p=e),min:'0',max:'1',step:'0.01'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.top_p,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',kn,[o[77]||(o[77]=(0,s.createElementVNode)('label',null,'Top K',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[14]||(o[14]=e=>(0,s.unref)(A).apiConfig.top_k=e),min:'0',max:'500'},null,512),[[s.vModelText,(0,s.unref)(A).apiConfig.top_k,void 0,{number:!0}]])])])])):(0,s.createCommentVNode)('v-if',!0)],64))],512),[[s.vShow,'api'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',Sn,[o[87]||(o[87]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'02'),(0,s.createElementVNode)('span',{class:'section-label'},'Live2D 模型'),(0,s.createElementVNode)('span',{class:'section-sub'},'MODEL CONTROL')],-1)),(0,s.createElementVNode)('div',_n,[o[79]||(o[79]=(0,s.createElementVNode)('label',null,'模型路径',-1)),(0,s.createElementVNode)('div',En,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[15]||(o[15]=e=>M.value=e),placeholder:'输入 .model.json 或 .model3.json 的完整 URL',onKeydown:(0,s.withKeys)(vt,['enter'])},null,544),[[s.vModelText,M.value]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:vt,disabled:!M.value.trim()},' 加载 ',8,Tn)])]),(0,s.createElementVNode)('div',Mn,[o[80]||(o[80]=(0,s.createElementVNode)('label',null,'推荐模型',-1)),(0,s.createElementVNode)('div',Nn,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(B),e=>((0,s.openBlock)(),(0,s.createElementBlock)('button',{key:e.path,class:(0,s.normalizeClass)(['model-btn',{active:(0,s.unref)(A).modelPath===e.path}]),type:'button',onClick:t=>{return o=e.path,A.value.modelPath=o,M.value=o,void a('model-change',o);var o}},(0,s.toDisplayString)(e.name),11,Vn))),128)),(0,s.createElementVNode)('button',{class:'model-btn browse-btn',type:'button',onClick:o[16]||(o[16]=e=>T.value=!0)},'浏览在线模型库')])]),(0,s.createElementVNode)('div',Pn,[(0,s.createElementVNode)('label',null,'宠物缩放 ('+(0,s.toDisplayString)(w.value)+')',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[17]||(o[17]=e=>(0,s.unref)(A).petScale=e),min:'0.1',max:'3',step:'0.05'},null,512),[[s.vModelText,(0,s.unref)(A).petScale,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Dn,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[18]||(o[18]=e=>(0,s.unref)(A).useCdn=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useCdn]]),o[81]||(o[81]=(0,s.createTextVNode)(' 使用 CDN 加速（jsDelivr） ',-1))]),o[82]||(o[82]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后将直接从 GitHub 原始地址加载，适用于 CDN 不可用时。',-1))]),(0,s.createElementVNode)('div',$n,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[19]||(o[19]=e=>(0,s.unref)(A).doubleTapRandomMotionEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).doubleTapRandomMotionEnabled]]),o[83]||(o[83]=(0,s.createTextVNode)(' 双击随机触发动作 ',-1))]),o[84]||(o[84]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后，双击仍会触发吐槽，但不再追加随机动作。',-1))]),(0,s.createElementVNode)('div',In,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[20]||(o[20]=e=>(0,s.unref)(A).gazeFollowMouseEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gazeFollowMouseEnabled]]),o[85]||(o[85]=(0,s.createTextVNode)(' 视线跟随鼠标 ',-1))]),o[86]||(o[86]=(0,s.createElementVNode)('div',{class:'hint'},'全页面范围生效；仅响应鼠标/触控笔，触屏手势不会驱动视线。',-1))])],512),[[s.vShow,'live2d'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',Un,[o[111]||(o[111]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'03'),(0,s.createElementVNode)('span',{class:'section-label'},'吐槽设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'COMMENT SYSTEM')],-1)),(0,s.createElementVNode)('div',Ln,[o[88]||(o[88]=(0,s.createElementVNode)('label',null,'吐槽风格',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[21]||(o[21]=e=>(0,s.unref)(A).commentStyle=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(k),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,zn))),128))],512),[[s.vModelSelect,(0,s.unref)(A).commentStyle]])]),'自定义'===(0,s.unref)(A).commentStyle?((0,s.openBlock)(),(0,s.createElementBlock)('div',Wn,[o[89]||(o[89]=(0,s.createElementVNode)('label',null,'自定义提示词',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':o[22]||(o[22]=e=>(0,s.unref)(A).customPrompt=e),rows:'4',placeholder:'输入自定义的系统提示词...'},null,512),[[s.vModelText,(0,s.unref)(A).customPrompt]])])):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',Fn,[o[90]||(o[90]=(0,s.createElementVNode)('label',null,'角色名（留空则关闭角色视角）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[23]||(o[23]=e=>(0,s.unref)(A).roleplayName=e),placeholder:'例如：阿米娅'},null,512),[[s.vModelText,(0,s.unref)(A).roleplayName]]),o[91]||(o[91]=(0,s.createElementVNode)('div',{class:'hint'},'填写后，吐槽和手动聊天会以该角色视角发言。',-1))]),(0,s.createElementVNode)('div',On,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[24]||(o[24]=e=>(0,s.unref)(A).roleplayIgnoreCommentStyle=e),disabled:!(0,s.unref)(A).roleplayName.trim()},null,8,Rn),[[s.vModelCheckbox,(0,s.unref)(A).roleplayIgnoreCommentStyle]]),o[92]||(o[92]=(0,s.createTextVNode)(' 角色模式下忽略吐槽风格 ',-1))]),o[93]||(o[93]=(0,s.createElementVNode)('div',{class:'hint'},'开启后将不再套用风格提示词，仅按角色设定发言。',-1))]),(0,s.createElementVNode)('div',jn,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[25]||(o[25]=e=>(0,s.unref)(A).sendCharacterCardContent=e),disabled:!(0,s.unref)(A).roleplayName.trim()},null,8,qn),[[s.vModelCheckbox,(0,s.unref)(A).sendCharacterCardContent]]),o[94]||(o[94]=(0,s.createTextVNode)(' 发送角色卡内容（当前聊天角色） ',-1))]),o[95]||(o[95]=(0,s.createElementVNode)('div',{class:'hint'},'开启后会附带当前角色卡描述/性格/场景等内容。',-1))]),(0,s.createElementVNode)('div',Yn,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[26]||(o[26]=e=>(0,s.unref)(A).autoTrigger=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).autoTrigger]]),o[96]||(o[96]=(0,s.createTextVNode)(' 启用自动触发 ',-1))])]),(0,s.unref)(A).autoTrigger?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createElementVNode)('div',Gn,[o[97]||(o[97]=(0,s.createElementVNode)('label',null,'触发时机',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[27]||(o[27]=e=>(0,s.unref)(A).commentTriggerMode=e)},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(S),e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.value,value:e.value},(0,s.toDisplayString)(e.label),9,Hn))),128))],512),[[s.vModelSelect,(0,s.unref)(A).commentTriggerMode]])]),(0,s.createElementVNode)('div',Jn,[(0,s.createElementVNode)('div',Xn,[o[98]||(o[98]=(0,s.createElementVNode)('label',null,'触发间隔（每 N 条消息）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[28]||(o[28]=e=>(0,s.unref)(A).triggerInterval=e),min:'1',max:'100'},null,512),[[s.vModelText,(0,s.unref)(A).triggerInterval,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Kn,[(0,s.createElementVNode)('label',null,'触发概率（'+(0,s.toDisplayString)((0,s.unref)(A).triggerProbability)+'%）',1),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'range','onUpdate:modelValue':o[29]||(o[29]=e=>(0,s.unref)(A).triggerProbability=e),min:'0',max:'100'},null,512),[[s.vModelText,(0,s.unref)(A).triggerProbability,void 0,{number:!0}]])])])],64)):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',Qn,[o[99]||(o[99]=(0,s.createElementVNode)('label',null,'传给 LLM 的最近聊天条数',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[30]||(o[30]=e=>(0,s.unref)(A).maxChatContext=e),min:'1',max:'50'},null,512),[[s.vModelText,(0,s.unref)(A).maxChatContext,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Zn,[o[100]||(o[100]=(0,s.createElementVNode)('label',null,'气泡自动关闭时间（秒）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[31]||(o[31]=e=>(0,s.unref)(A).bubbleDuration=e),min:'-1',max:'600',step:'1'},null,512),[[s.vModelText,(0,s.unref)(A).bubbleDuration,void 0,{number:!0}]]),o[101]||(o[101]=(0,s.createElementVNode)('div',{class:'hint'},'默认 -1 不自动关闭；设置为 0 表示生成完成后立即关闭。',-1))]),(0,s.createElementVNode)('div',ea,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[32]||(o[32]=e=>(0,s.unref)(A).phoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).phoneMessageAutoRead]]),o[102]||(o[102]=(0,s.createTextVNode)(' 读【毛球点心铺】手机消息 ',-1))]),o[103]||(o[103]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 NPC 文本回复；需同时启用 TTS 配音与自动播放。',-1))]),(0,s.createElementVNode)('div',ta,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[33]||(o[33]=e=>(0,s.unref)(A).baibaiPhoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).baibaiPhoneMessageAutoRead]]),o[104]||(o[104]=(0,s.createTextVNode)(' 读【柏柏小手机】手机消息 ',-1))]),o[105]||(o[105]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 NPC 文本回复；需同时启用 TTS 配音与自动播放。',-1))]),(0,s.createElementVNode)('div',oa,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[34]||(o[34]=e=>(0,s.unref)(A).useTamakoTodaySpecial=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useTamakoTodaySpecial]]),o[106]||(o[106]=(0,s.createTextVNode)(' 兼容 Tamako 今日特选 ',-1))]),o[107]||(o[107]=(0,s.createElementVNode)('div',{class:'hint'},'开启后会优先读取 Tamako Market 今日特选作为上下文。',-1))]),(0,s.createElementVNode)('div',na,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[35]||(o[35]=e=>(0,s.unref)(A).useDiceDatabaseReference=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).useDiceDatabaseReference]]),o[108]||(o[108]=(0,s.createTextVNode)(' 参考数据库（建议 + 点评） ',-1))]),o[109]||(o[109]=(0,s.createElementVNode)('div',{class:'hint'},'启用后会读取骰子数据库摘要作为参考内容。',-1))]),(0,s.unref)(A).useDiceDatabaseReference?((0,s.openBlock)(),(0,s.createElementBlock)('div',aa,[o[110]||(o[110]=(0,s.createElementVNode)('label',null,'可见数据库表（勾选后才会被引用）',-1)),(0,s.createElementVNode)('div',ra,[(0,s.createElementVNode)('div',ia,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:Z,disabled:V.value},(0,s.toDisplayString)(V.value?'刷新中...':'刷新表列表'),9,sa)]),(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:oe},'全选')])]),(0,s.createElementVNode)('div',la,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:ne},'清空筛选'),(0,s.createElementVNode)('div',ca,(0,s.toDisplayString)(Q.value),1)]),N.value.length>0?((0,s.openBlock)(),(0,s.createElementBlock)('div',Aa,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(N.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('label',{class:'dice-sheet-item',key:e},[(0,s.createElementVNode)('input',{type:'checkbox',checked:K(e),onChange:t=>function(e,t){const o=t?.target,n=!!o?.checked,a=N.value,r=J();let i=0===r.length?[...a]:[...r];n?i.includes(e)||i.push(e):i=i.filter(t=>t!==e),a.length>0&&i.length===a.length&&(i=[]),X(i)}(e,t)},null,40,da),(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(e),1)]))),128))])):((0,s.openBlock)(),(0,s.createElementBlock)('div',ua,'未读取到表名，可先在骰子系统中完成一次数据库更新后再刷新。'))])):(0,s.createCommentVNode)('v-if',!0)],512),[[s.vShow,'comment'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',pa,[o[130]||(o[130]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'04'),(0,s.createElementVNode)('span',{class:'section-label'},'表情设置'),(0,s.createElementVNode)('span',{class:'section-sub'},'EMOTION COT')],-1)),(0,s.createElementVNode)('div',ma,[(0,s.createElementVNode)('div',ha,[(0,s.createElementVNode)('div',fa,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[36]||(o[36]=e=>(0,s.unref)(A).emotionCotEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).emotionCotEnabled]]),o[112]||(o[112]=(0,s.createTextVNode)(' 启用表情 COT ',-1))]),o[113]||(o[113]=(0,s.createElementVNode)('div',{class:'hint'},[(0,s.createTextVNode)(' 开启后，LLM 将按 '),(0,s.createElementVNode)('code',null,'桌面宠物[表情|语气]: 正文'),(0,s.createTextVNode)(' 输出；气泡/TTS 会自动剥离前缀并联动 Live2D。 ')],-1)),(0,s.createElementVNode)('div',ga,'表情列表：'+(0,s.toDisplayString)((0,s.unref)(Ae).join('、')),1)]),(0,s.unref)(A).emotionCotEnabled?((0,s.openBlock)(),(0,s.createElementBlock)('div',ba,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[37]||(o[37]=e=>(0,s.unref)(A).emotionCotStripFromText=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).emotionCotStripFromText]]),o[114]||(o[114]=(0,s.createTextVNode)(' 从气泡/TTS 文本中剥离前缀 ',-1))]),o[115]||(o[115]=(0,s.createElementVNode)('div',{class:'hint'},'建议保持开启，否则会朗读包含前缀的完整文本。',-1))])):(0,s.createCommentVNode)('v-if',!0),(0,s.createElementVNode)('div',xa,[(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:St},'重置为默认表情配置')]),(0,s.createElementVNode)('div',ya,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:Tt,disabled:he.value},(0,s.toDisplayString)(he.value?'刷新中...':'刷新模型表情/动作列表'),9,Ca)])]),(0,s.createElementVNode)('div',va,[(0,s.createElementVNode)('div',wa,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:o[38]||(o[38]=e=>Mt(!1))},' 自动匹配（填充空白覆盖） ')]),(0,s.createElementVNode)('div',Ba,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:o[39]||(o[39]=e=>Mt(!0))},' 自动匹配全部（覆盖） ')])]),(0,s.createElementVNode)('div',ka,[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Nt},'清空 Live2D 覆盖'),(0,s.createElementVNode)('div',Sa,(0,s.toDisplayString)(_e.value),1)]),(0,s.createElementVNode)('div',_a,[(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[40]||(o[40]=e=>ut.value=!ut.value)},[(0,s.createElementVNode)('span',Ea,(0,s.toDisplayString)(ut.value?'▼':'▶'),1),(0,s.createElementVNode)('span',null,(0,s.toDisplayString)(ut.value?'隐藏高级选项':'显示高级选项'),1)]),o[116]||(o[116]=(0,s.createElementVNode)('div',{class:'hint'},'高级选项包含：别名映射、TTS 默认语气、动作启用开关。',-1))]),(0,s.createElementVNode)('div',Ta,[o[120]||(o[120]=(0,s.createElementVNode)('div',{class:'emotion-map-head'},[(0,s.createElementVNode)('div',null,'标签'),(0,s.createElementVNode)('div',null,'→'),(0,s.createElementVNode)('div',null,'Live2D 表情（Expression）'),(0,s.createElementVNode)('div',null,'Live2D 动作（Motion）'),(0,s.createElementVNode)('div',null,'预览')],-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(A).emotionConfigs,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.tag,class:'emotion-map-row'},[(0,s.createElementVNode)('div',Ma,(0,s.toDisplayString)(e.tag),1),o[119]||(o[119]=(0,s.createElementVNode)('div',{class:'emotion-map-arrow'},'→',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t=>e.live2dExpression=t},[o[117]||(o[117]=(0,s.createElementVNode)('option',{value:''},'（自动匹配）',-1)),e.live2dExpression&&!ge.value.has(e.live2dExpression)?((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:0,value:e.live2dExpression},(0,s.toDisplayString)(e.live2dExpression)+'（自定义） ',9,Va)):(0,s.createCommentVNode)('v-if',!0),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(fe.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,Pa))),128))],8,Na),[[s.vModelSelect,e.live2dExpression]]),(0,s.createElementVNode)('select',{value:ve(e),disabled:!e.live2dMotion.enabled,onChange:t=>function(e,t){const o=t?.target;Be(e,o?.value||'')}(e,t)},[o[118]||(o[118]=(0,s.createElementVNode)('option',{value:''},'（自动匹配）',-1)),ve(e)&&!Se.value.has(ve(e))?((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:0,value:ve(e)},(0,s.toDisplayString)(we(e))+'（自定义） ',9,$a)):(0,s.createCommentVNode)('v-if',!0),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(ke.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.key,value:e.value},(0,s.toDisplayString)(e.label),9,Ia))),128))],40,Da),(0,s.createElementVNode)('button',{class:'btn btn-secondary emotion-map-preview-btn',type:'button',title:'预览动作',onClick:t=>Vt(e.tag)},' ▶ ',8,Ua)]))),128))]),o[126]||(o[126]=(0,s.createElementVNode)('div',{class:'hint'},'左列绑定 Expressions，右列绑定 Motions（可填动作名或动作组名）。',-1)),ut.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',La,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(A).emotionConfigs,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:`advanced_${e.tag}`,class:'emotion-advanced-item'},[(0,s.createElementVNode)('div',za,(0,s.toDisplayString)(e.tag)+' · 高级',1),(0,s.createElementVNode)('div',Wa,[(0,s.createElementVNode)('div',Fa,[o[121]||(o[121]=(0,s.createElementVNode)('label',null,'别名（raw tag → 规范表情）',-1)),(0,s.createElementVNode)('input',{type:'text',value:(e.aliases||[]).join(', '),onBlur:t=>Et(e,t),placeholder:'逗号分隔，例如：开心, smile'},null,40,Oa),o[122]||(o[122]=(0,s.createElementVNode)('div',{class:'hint'},'当模型输出不在固定表情列表时，可用别名映射到本行规范表情。',-1))]),(0,s.createElementVNode)('div',Ra,[o[123]||(o[123]=(0,s.createElementVNode)('label',null,'TTS 默认语气（可选）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.ttsContext=t,placeholder:'例如：轻松调侃地说'},null,8,ja),[[s.vModelText,e.ttsContext]]),o[124]||(o[124]=(0,s.createElementVNode)('div',{class:'hint'},'当模型未输出 |语气 时，将把此处作为 contextTexts 传给 TTS。',-1))])]),(0,s.createElementVNode)('div',qa,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.live2dMotion.enabled=t},null,8,Ya),[[s.vModelCheckbox,e.live2dMotion.enabled]]),o[125]||(o[125]=(0,s.createTextVNode)(' 启用动作（关闭后该标签仅切换表情） ',-1))])])]))),128))])):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('div',Ga,[(0,s.createElementVNode)('div',Ha,[o[127]||(o[127]=(0,s.createElementVNode)('span',{class:'emotion-preview-title'},'模型预览',-1)),(0,s.createElementVNode)('span',Ja,'标签: '+(0,s.toDisplayString)(Ve.value),1)]),(0,s.createElementVNode)('div',{class:'emotion-preview-canvas',ref_key:'live2dPreviewMountEl',ref:Ee},[(0,s.createElementVNode)('div',{class:'emotion-preview-interact',ref_key:'live2dPreviewInteractEl',ref:Te},null,512),(0,s.unref)(_t).model?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('div',Xa,'加载模型后可预览'))],512),(0,s.createElementVNode)('div',Ka,[(0,s.createElementVNode)('div',Qa,[o[128]||(o[128]=(0,s.createElementVNode)('span',{class:'zoom-label'},'缩放',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{class:'zoom-slider',type:'range',min:'0.5',max:'4',step:'0.05','onUpdate:modelValue':o[41]||(o[41]=e=>$e.value=e),onInput:Xe},null,544),[[s.vModelText,$e.value,void 0,{number:!0}]]),(0,s.createElementVNode)('span',Za,(0,s.toDisplayString)(Math.round(100*$e.value))+'%',1)]),(0,s.createElementVNode)('div',{class:'emotion-preview-actions'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Ke},'重置视图'),(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:nt},'重播')]),o[129]||(o[129]=(0,s.createElementVNode)('div',{class:'hint'},'提示：拖拽预览区可移动模型，滚轮可缩放。',-1)),(0,s.createElementVNode)('div',{class:'hint',title:De.value},(0,s.toDisplayString)(De.value),9,er)])])])],512),[[s.vShow,'expression'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',tr,[o[155]||(o[155]=(0,s.createElementVNode)('h4',null,[(0,s.createElementVNode)('span',{class:'section-index'},'05'),(0,s.createElementVNode)('span',{class:'section-label'},'TTS 配音'),(0,s.createElementVNode)('span',{class:'section-sub'},'VOICE CONTROL')],-1)),(0,s.createElementVNode)('div',or,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[42]||(o[42]=e=>ae.value=e),onChange:Pt},null,544),[[s.vModelCheckbox,ae.value]]),o[131]||(o[131]=(0,s.createTextVNode)(' 启用 TTS 配音 ',-1))]),o[132]||(o[132]=(0,s.createElementVNode)('div',{class:'hint'},'关闭后不会自动朗读吐槽/手动聊天结果。',-1))]),(0,s.createElementVNode)('div',nr,[o[133]||(o[133]=(0,s.createElementVNode)('label',null,'TTS 引擎',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[43]||(o[43]=e=>(0,s.unref)(A).ttsProvider=e)},[(0,s.createElementVNode)('option',{value:(0,s.unref)(Me).LITTLEWHITEBOX},'小白X（豆包火山）',8,ar),(0,s.createElementVNode)('option',{value:(0,s.unref)(Me).GPT_SOVITS_V2},'GPT-SoVITS v2ProPlus',8,rr),(0,s.createElementVNode)('option',{value:(0,s.unref)(Me).EDGE_TTS_DIRECT},'EdgeTTS（必须是Edge浏览器）',8,ir)],512),[[s.vModelSelect,(0,s.unref)(A).ttsProvider]])]),(0,s.createElementVNode)('div',sr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[44]||(o[44]=e=>(0,s.unref)(A).ttsAutoPlay=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).ttsAutoPlay]]),o[134]||(o[134]=(0,s.createTextVNode)(' 自动播放（吐槽完成后朗读） ',-1))])]),(0,s.createElementVNode)('div',lr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[45]||(o[45]=e=>(0,s.unref)(A).phoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).phoneMessageAutoRead]]),o[135]||(o[135]=(0,s.createTextVNode)(' 手机消息自动朗读（仅 NPC 文本回复） ',-1))]),o[136]||(o[136]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 sender=contact 且 type=text 的手机消息。',-1))]),(0,s.createElementVNode)('div',cr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[46]||(o[46]=e=>(0,s.unref)(A).baibaiPhoneMessageAutoRead=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).baibaiPhoneMessageAutoRead]]),o[137]||(o[137]=(0,s.createTextVNode)(' 柏柏小手机自动朗读（仅 NPC 文本回复） ',-1))]),o[138]||(o[138]=(0,s.createElementVNode)('div',{class:'hint'},'仅朗读 qq.private / qq.group 中的 NPC 文本消息。',-1))]),(0,s.createElementVNode)('div',Ar,[o[140]||(o[140]=(0,s.createElementVNode)('label',null,'默认音色',-1)),(0,s.createElementVNode)('div',dr,[(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[47]||(o[47]=e=>(0,s.unref)(A).ttsDefaultSpeaker=e)},[o[139]||(o[139]=(0,s.createElementVNode)('option',{value:''},'（不指定）',-1)),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(re.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.name,value:e.name},(0,s.toDisplayString)(e.name)+(0,s.toDisplayString)(e.desc?' ('+e.desc+')':''),9,ur))),128))],512),[[s.vModelSelect,(0,s.unref)(A).ttsDefaultSpeaker]]),(0,s.createElementVNode)('button',{class:'input-btn',type:'button',onClick:Dt,disabled:ie.value},(0,s.toDisplayString)(ie.value?'刷新中...':'刷新音色'),9,pr)]),(0,s.createElementVNode)('div',mr,(0,s.toDisplayString)(ce.value),1)]),(0,s.createElementVNode)('div',{class:'advanced-toggle',onClick:o[48]||(o[48]=e=>pt.value=!pt.value)},[(0,s.createElementVNode)('span',hr,(0,s.toDisplayString)(pt.value?'▼':'▶'),1),o[141]||(o[141]=(0,s.createTextVNode)(' 口型同步高级兜底 ',-1))]),pt.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',fr,[(0,s.createElementVNode)('div',gr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[49]||(o[49]=e=>(0,s.unref)(A).lipSyncManualParamsEnabled=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).lipSyncManualParamsEnabled]]),o[142]||(o[142]=(0,s.createTextVNode)(' 启用手动嘴部参数 ',-1))]),o[143]||(o[143]=(0,s.createElementVNode)('div',{class:'hint'},'自动识别失败时，使用下面参数名覆盖（如 Param58 / Param61）。',-1))]),(0,s.createElementVNode)('div',br,[o[144]||(o[144]=(0,s.createElementVNode)('label',null,'嘴部参数 ID（逗号或换行分隔）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':o[50]||(o[50]=e=>mt.value=e),rows:'3',placeholder:'ParamMouthOpenY\nParam58',onBlur:zt},null,544),[[s.vModelText,mt.value]]),o[145]||(o[145]=(0,s.createElementVNode)('div',{class:'hint'},'保存时会自动去重、去空白。',-1))])])):(0,s.createCommentVNode)('v-if',!0),(0,s.unref)(A).ttsProvider===(0,s.unref)(Me).GPT_SOVITS_V2?((0,s.openBlock)(),(0,s.createElementBlock)('div',xr,[(0,s.createElementVNode)('div',yr,[o[146]||(o[146]=(0,s.createElementVNode)('label',null,'API 地址',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[51]||(o[51]=e=>(0,s.unref)(A).gptSoVits.apiUrl=e),placeholder:'http://127.0.0.1:9880'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.apiUrl]])]),(0,s.createElementVNode)('div',Cr,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[52]||(o[52]=e=>(0,s.unref)(A).gptSoVits.useCorsProxy=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gptSoVits.useCorsProxy]]),o[147]||(o[147]=(0,s.createTextVNode)(' 使用酒馆代理（/proxy） ',-1))])]),(0,s.createElementVNode)('div',vr,[(0,s.createElementVNode)('div',wr,[o[148]||(o[148]=(0,s.createElementVNode)('label',null,'text_lang',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[53]||(o[53]=e=>(0,s.unref)(A).gptSoVits.textLang=e),placeholder:'auto/zh/en/ja...'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.textLang]])]),(0,s.createElementVNode)('div',Br,[o[149]||(o[149]=(0,s.createElementVNode)('label',null,'切分策略',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[54]||(o[54]=e=>(0,s.unref)(A).gptSoVits.textSplitMethod=e),placeholder:'cut5'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.textSplitMethod]])])]),(0,s.createElementVNode)('div',kr,[(0,s.createElementVNode)('div',Sr,[o[151]||(o[151]=(0,s.createElementVNode)('label',null,'media_type',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[55]||(o[55]=e=>(0,s.unref)(A).gptSoVits.mediaType=e)},[...o[150]||(o[150]=[(0,s.createElementVNode)('option',{value:'wav'},'wav',-1),(0,s.createElementVNode)('option',{value:'ogg'},'ogg',-1),(0,s.createElementVNode)('option',{value:'raw'},'raw',-1)])],512),[[s.vModelSelect,(0,s.unref)(A).gptSoVits.mediaType]])]),(0,s.createElementVNode)('div',_r,[(0,s.createElementVNode)('label',null,[(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':o[56]||(o[56]=e=>(0,s.unref)(A).gptSoVits.streamingMode=e)},null,512),[[s.vModelCheckbox,(0,s.unref)(A).gptSoVits.streamingMode]]),o[152]||(o[152]=(0,s.createTextVNode)(' streaming_mode ',-1))])])]),(0,s.createElementVNode)('div',Er,[o[153]||(o[153]=(0,s.createElementVNode)('label',null,'speed_factor',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'number','onUpdate:modelValue':o[57]||(o[57]=e=>(0,s.unref)(A).gptSoVits.speedFactor=e),min:'0.5',max:'2',step:'0.05'},null,512),[[s.vModelText,(0,s.unref)(A).gptSoVits.speedFactor,void 0,{number:!0}]])]),(0,s.createElementVNode)('div',Tr,[o[154]||(o[154]=(0,s.createElementVNode)('label',null,'音色列表（JSON）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':o[58]||(o[58]=e=>se.value=e),rows:'6',placeholder:'[{"name":"示例音色","refAudioPath":"wavs/xxx.wav","promptText":"示例参考文本","promptLang":"zh"}]'},null,512),[[s.vModelText,se.value]]),(0,s.createElementVNode)('div',Mr,[(0,s.createElementVNode)('div',{class:'form-group half'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:$t},'保存音色列表')]),(0,s.createElementVNode)('div',Nr,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:It,disabled:!ae.value},'试听',8,Vr)])]),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[59]||(o[59]=e=>le.value=e),placeholder:'试听文本'},null,512),[[s.vModelText,le.value]])])])):((0,s.openBlock)(),(0,s.createElementBlock)('div',Pr,[(0,s.createElementVNode)('button',{class:'btn btn-test',type:'button',onClick:It,disabled:!ae.value},'试听',8,Dr),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'text','onUpdate:modelValue':o[60]||(o[60]=e=>le.value=e),placeholder:'试听文本'},null,512),[[s.vModelText,le.value]])])),(0,s.createElementVNode)('div',{class:'form-group'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:Ut},'停止')])],512),[[s.vShow,'tts'===i.value]]),(0,s.withDirectives)((0,s.createElementVNode)('section',$r,[...o[156]||(o[156]=[(0,s.createStaticVNode)('<h4 data-v-7941402e><span class="section-index" data-v-7941402e>06</span><span class="section-label" data-v-7941402e>关于</span><span class="section-sub" data-v-7941402e>ABOUT &amp; LICENSE</span></h4><div class="about-card" data-v-7941402e><div class="about-title" data-v-7941402e>插件发布地址</div><a class="about-link" href="https://discord.com/channels/1134557553011998840/1472242483806077061" target="_blank" rel="noopener noreferrer" data-v-7941402e> https://discord.com/channels/1134557553011998840/1472242483806077061 </a></div><div class="about-card" data-v-7941402e><div class="about-title" data-v-7941402e>版权与使用声明</div><ul class="about-list" data-v-7941402e><li data-v-7941402e> 本插件加载或展示的 Live2D 模型及配套素材，其版权归原作者或原项目方所有；请在使用前自行确认并遵守对应授权条款。 </li><li data-v-7941402e>除权利人另有授权外，插件及示例素材仅用于学习、研究与交流，不得用于商业用途或再分发。</li><li data-v-7941402e> 本项目采用 <a class="about-link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank" rel="noopener noreferrer" data-v-7941402e> CC BY-NC-SA 4.0 </a> 共享协议。使用、改编与传播时请遵守“署名-非商业性使用-相同方式共享”，并对第三方素材单独核验授权。 </li><li data-v-7941402e>使用本插件及其衍生内容时，必须遵守你所在地及适用司法辖区的法律法规。</li></ul></div>',3)])],512),[[s.vShow,'about'===i.value]])])]),(0,s.createElementVNode)('div',{class:'panel-footer'},[(0,s.createElementVNode)('button',{class:'btn btn-secondary',type:'button',onClick:wt},'恢复默认'),(0,s.createElementVNode)('button',{class:'btn btn-primary',type:'button',onClick:Wt},'确定')])])])):(0,s.createCommentVNode)('v-if',!0),T.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:1,class:'browser-overlay dp-browser-overlay',style:ht,onClick:o[63]||(o[63]=(0,s.withModifiers)(e=>T.value=!1,['self']))},[(0,s.createElementVNode)('div',{class:'browser-dialog dp-browser-dialog',style:ft},[(0,s.createElementVNode)('div',Ir,[o[157]||(o[157]=(0,s.createElementVNode)('h3',null,'在线模型库',-1)),(0,s.createElementVNode)('button',{class:'close-btn',type:'button',onClick:o[61]||(o[61]=e=>T.value=!1)},'X')]),(0,s.createElementVNode)('div',Ur,[(0,s.createVNode)(Ro,{'use-cdn':(0,s.unref)(A).useCdn,onCancel:o[62]||(o[62]=e=>T.value=!1),onLoadModel:Ct},null,8,['use-cdn'])])])])):(0,s.createCommentVNode)('v-if',!0)]))}});i(239);const zr=(0,ro.A)(Lr,[['__scopeId','data-v-7941402e']]),Wr={class:'browser-dialog'},Fr={class:'browser-dialog-header'},Or={class:'browser-dialog-body'},Rr='__desktopPetOpenSettings_v2',jr=(0,s.defineComponent)({__name:'PetContainer',setup(e){const t=ue(),{settings:n}=o(t),a=eo(),{showSettings:r}=o(a),i=(0,s.ref)(''),l=(0,s.ref)(!0);let c=null,A=0,d=null,u=null,p=null,m=null,h=null,f=!1,g=null,b=null,x=null,y=null;const v=(0,s.ref)(!1),w=(0,s.ref)({x:0,y:0}),B=(0,s.ref)('left'),k=(0,s.ref)(!1);let S=!1,E=null,T=null,M=0;const N=new Set,V=[],P=[];let D=!1,I=!1,U=null;const L=[],W=new Set,F=[];function O(){try{return window.parent??window}catch{return window}}function R(){try{const e=SillyTavern?.getContext?.();if(null!=e?.characterId)return String(e.characterId)}catch{}return'default'}function j(){try{const e=O(),t=e?.extension_settings?.acsusPawsPuffs?.phone;if(t&&'object'==typeof t)return t}catch{}try{const e=window,t=e?.extension_settings?.acsusPawsPuffs?.phone;if(t&&'object'==typeof t)return t}catch{}return null}function q(e,t){const o=String(t||'').trim(),n=o.replace(/^chat_/,'').replace(/^tavern_/,'').trim()||'联系人';if('baibai'===e)return n;const a=j(),r=(Array.isArray(a?.contacts)?a.contacts:[]).find(e=>String(e?.id||'').trim()===o);return String(r?.name||'').trim()||n}function Y(e){const t=String(e?.sender||'').trim().toLowerCase(),o=String(e?.type||'text').trim().toLowerCase();return'contact'===t&&'text'===o}function G(e){return String(e??'').replace(/\s+/g,' ').trim()}function H(e){return'baibai'===e?!0===n.value.baibaiPhoneMessageAutoRead:!1!==n.value.phoneMessageAutoRead}function J(e){const t=G(e).toLowerCase();return!!t&&function(){const e=new Set,t=t=>{const o=G(t).toLowerCase();o&&e.add(o)};try{t(SillyTavern?.name1)}catch{}try{const e=SillyTavern?.getContext?.();t(e?.name1),t(e?.userName)}catch{}return t('user'),e}().has(t)}function X(e){const t=String(e||'').trim();if(!t)return[];const o=[],n=/'([^']*)'|"([^"]*)"/g;for(const e of t.matchAll(n)){const t=G(e[1]??e[2]??'');o.push(t)}return o.length>0?o:t.split(',').map(e=>G(e)).filter(e=>!!e)}function K(e){const t=String(e??'');if(!t)return[];const o=t.match(/\[(.+?)-(.+?)\]/);if(!o){const e=G(t);return e?[e]:[]}const n=G(o[1]).toLowerCase();if('bqb'===n||'img'===n){const e=G(t.replace(o[0],''));return e?[e]:[]}return[]}function Q(e){switch(String(e?.type||'text').trim().toLowerCase()){case'text':{let t=G(e.content);return t=t.replace(/^\[约定计划(?:已完成|过程|内心印象|过程记录)?\]/,'').trim(),t}case'quote':return G(e.replyContent||e.content||'引用消息');case'emoji':return G(`表情 ${e.content||'消息'}`);case'image':case'image-real':case'image-fake':{const t=G(e.description||e.content||'');return t?`图片，${t}`:'图片消息'}case'redpacket':return`红包 ${G(e.amount||0)} 元`;case'transfer':{const t=G(e.amount||0),o=G(e.message||e.content||'');return o?`转账 ${t} 元，留言 ${o}`:`转账 ${t} 元`}case'video':return G(`视频 ${e.description||''}`)||'视频消息';case'file':return G(`文件 ${e.filename||''}`)||'文件消息';case'poke':return'戳了戳你';case'recalled':case'recalled-pending':return'撤回了一条消息';case'friend_request':case'friend_added':case'friend_deleted':return G(e.content||'');case'gift-membership':case'buy-membership':{const t=G(e.months||'');return G(`赠送${t?`${t}个月`:''}${String(e.membershipType||'').toUpperCase()||'会员'}`)}default:return G(e.content||e.description||'')}}function Z(e,t,o){const n=String(t||'').trim(),a=G(o?.id);if(a)return`${e}:${n}:${a}`;return`${e}:${n}:${G(o?.sender).toLowerCase()||'unknown'}:${G(o?.type).toLowerCase()||'text'}:${Number(o?.time||0)}:${G(o?.content||o?.replyContent||o?.description||o?.filename||'').slice(0,72)}`}function ee(e){if(!e||N.has(e))return;if(N.add(e),V.push(e),V.length<=4e3)return;const t=V.shift();t&&N.delete(t)}function te(e,t){const o=function(e){try{const t=O(),o=t?.SillyTavern?.eventTypes?.[e];if(o)return String(o)}catch{}try{const t=tavern_events?.[e];if(t)return String(t)}catch{}return null}(e);if(!o)return null;try{const e=O(),n=e?.SillyTavern?.eventSource;if(n&&'function'==typeof n.on)return n.on(o,t),{stop:()=>{try{'function'==typeof n.off?n.off(o,t):'function'==typeof n.removeListener&&n.removeListener(o,t)}catch{}}}}catch{}return'function'==typeof eventOn?eventOn(o,t):null}function oe(){W.clear(),F.length=0}function ae(e){if(!Number.isFinite(e))return;if(W.has(e))return;if(W.add(e),F.push(e),F.length<=2e3)return;const t=F.shift();'number'==typeof t&&W.delete(t)}function re(){try{const e=getChatMessages('0-{{lastMessageId}}',{role:'assistant',hide_state:'unhidden'});return Array.isArray(e)?e:[]}catch{return[]}}function se(e){const t=(o=e?.message,String(o??'').replace(/<think[ing]*?>[\s\S]*?<\/think[ing]*?>/gi,'').replace(/<!--[\s\S]*?-->/g,'').trim());var o;if(!t||!function(e){return/\bqq\.(?:private|group)\s*\(/i.test(String(e??''))}(t))return[];const n=Number(e?.message_id),a=[],r=t.matchAll(/([a-zA-Z]+\.[a-zA-Z]+)\(([\s\S]*?)\);/g);let i=0;for(const e of r){i++;const t=String(e[1]||'').trim().toLowerCase();if('qq.private'!==t&&'qq.group'!==t)continue;const o=X(String(e[2]||''));if(o.length<4)continue;const r=G(o[0])||'柏柏会话',s=G(o[1]);if(!s||J(s))continue;const l=K(o[2]);if(0===l.length)continue;const c=G(o[3]),A=Number.isFinite(n)?String(n):'unknown';l.forEach((e,t)=>{const o=G(e);o&&a.push({contactId:r,message:{id:`baibai_${A}_${i}_${t}`,sender:'contact',type:'text',content:o,time:c||A}})})}return a}function ce(){const e=re();for(const t of e){const e=Number(t?.message_id);!Number.isFinite(e)||e<0||ae(e)}}function Ae(){const e=re();if(0!==e.length)for(const t of e){const e=Number(t?.message_id);if(!Number.isFinite(e)||e<0)continue;if(W.has(e))continue;ae(e);const o=se(t);for(const e of o)pe(e.contactId,e.message,'baibai')}}async function de(e=45e3){const t=Date.now();for(;Lt.isLoading||Lt.isPlaying;){if(Date.now()-t>e)return void Lt.stop();await new Promise(e=>{window.setTimeout(e,120)})}}function pe(e,t,o='acsus'){if(!t)return;if(!Y(t))return;const a=Z(o,e,t);if(N.has(a))return;ee(a);const r=Number(t.time||0);'acsus'===o&&Number.isFinite(r)&&r>0&&M>0&&r+2<M||H(o)&&(P.push({source:o,contactId:e,message:t}),async function(){if(!D){D=!0;try{for(;P.length>0;){const e=P.shift();if(!e)continue;const t=et(),o=!!n.value.ttsAutoPlay,a=H(e.source);if(!t||!o||!a)continue;const r=Q(e.message);if(!r)continue;const i=q(e.source,e.contactId),s=R(),l=String(n.value.ttsDefaultSpeaker||'').trim(),c={};l&&(c.speaker=l);const A='baibai'===e.source?'柏柏小手机':'毛球点心铺手机';c.context=`${A}·${i}`,await de(45e3),await Lt.speak({type:'dialogue',speaker:s,text:r,tts:c},`desktop_pet_phone_${e.source}_${e.contactId}_${Date.now()}`)}}catch(e){le('手机消息自动朗读失败',e)}finally{D=!1}}}())}function me(e){const t=function(e){const t=j(),o=`chat_${String(e||'').trim()}`,n=t?.chats?.[o];return Array.isArray(n)?n:[]}(e);if(0===t.length)return;const o=[];for(let n=t.length-1;n>=0;n--){const a=t[n];if(!Y(a))continue;const r=Z('acsus',e,a);if(N.has(r))break;o.push(a)}o.reverse().forEach(t=>{pe(e,t)})}function he(){if(S)return;M=Math.floor(Date.now()/1e3),function(){const e=j(),t=e?.chats;if(t&&'object'==typeof t)for(const[e,o]of Object.entries(t)){if(!Array.isArray(o))continue;const t=String(e||'').replace(/^chat_/,'').trim();if(t)for(const e of o){const o=e;Y(o)&&ee(Z('acsus',t,o))}}}();const e=O().document??document;E=e=>{const t=e.detail||{},o=String(t.contactId||'').trim();o&&pe(o,t.message)},T=e=>{const t=e.detail||{},o=String(t.contactId||'').trim();o&&me(o)},e.addEventListener('phone-message-received',E),e.addEventListener('phone-ai-generation-complete',T),S=!0,ie('手机消息 TTS 桥接已启用')}function fe(){if(!S)return;const e=O().document??document;E&&e.removeEventListener('phone-message-received',E),T&&e.removeEventListener('phone-ai-generation-complete',T),E=null,T=null,P.length=0,D=!1,S=!1}function ge(){I&&(L.forEach(e=>{e.stop()}),L.length=0,null!==U&&(window.clearInterval(U),U=null),oe(),I=!1)}function be(){const e=!n.value.autoMotionLoop;n.value.autoMotionLoop=e,_t.setAutoMotionLoopEnabled(e)}function xe(){const e=['毒舌吐槽','可爱卖萌','冷静分析','傲娇'],t=n.value.commentStyle,o=e.indexOf(t),a=e[(o>=0?o+1:0)%e.length];n.value.commentStyle=a;try{toastr.info(`已切换人设：${a}`)}catch{}}function ye(){v.value=!1,k.value=!0}function Ce(e){n.value.modelPath=e,k.value=!1,Le(e)}function ve(e){Jt.chat(e)}function we(){v.value=!1,k.value=!1,a.closeSettings(),ze(),Me(!0),fe(),ge(),zt.destroy(),Jt.destroy(),_t.destroyModel(),at.destroy();try{toastr.info('桌面宠物已关闭')}catch{}}function Be(e){const t=ke(e);return{width:Math.max(1,Math.round(280*t)),height:Math.max(1,Math.round(360*t))}}function ke(e){const t='number'==typeof e?e:Number(e);return Number.isFinite(t)?Math.max(.1,Math.min(3,t)):C}function Se(){null!==d&&(window.clearTimeout(d),d=null)}function _e(){null!==u&&(window.clearTimeout(u),u=null)}function Ee(){null!==p&&(window.clearTimeout(p),p=null)}function Te(){if(f)return;const e=O().document??document,t=e=>{var t;'mouse'!==(t=e.pointerType)&&'pen'!==t||function(e,t){if(!Number.isFinite(e)||!Number.isFinite(t))return;if(y={x:e,y:t},null!==x)return;const o=O();x=o.requestAnimationFrame(()=>{x=null;const e=y;y=null,e&&!1!==n.value.gazeFollowMouseEnabled&&(at.isPreviewMounted()||_t.focusByClientPoint(e.x,e.y,!1))})}(e.clientX,e.clientY)};g=t,b=t,e.addEventListener('pointermove',g,{passive:!0}),e.addEventListener('pointerdown',b,{passive:!0}),f=!0}function Me(e=!0){!function(){if(null===x)return;const e=O();try{e.cancelAnimationFrame(x)}catch{}x=null}(),y=null;const t=O().document??document;g&&t.removeEventListener('pointermove',g),b&&t.removeEventListener('pointerdown',b),g=null,b=null,f=!1,e&&_t.focusCenter(!0)}function Ne(){!1!==n.value.gazeFollowMouseEnabled?Te():Me(!0)}function Ve(e){Ee(),p=window.setTimeout(()=>{p=null,function(e){if(at.isPreviewMounted())return;const t=Be(n.value.petScale),o=e=>{at.resizeFloating(t.width,t.height);const o=O().document.getElementById('desktop-pet-stage');o&&(o.style.display='block',o.style.visibility='visible',o.style.opacity='1',o.style.zIndex='10000');const n=at.getStage();if(n&&n.children.length>0)return _t.updateScale(t.width,t.height,1),void ie(`Viewport resize recovery synced model (${e})`);_t.mountToStage(t.width,t.height,1),ie(`Viewport resize recovery remounted model (${e})`)};o(`${e}-pass1`),window.setTimeout(()=>{at.isPreviewMounted()||o(`${e}-pass2`)},220),Ie(`${e}-recover`)}(e)},160)}function Pe(e){const t=Math.max(0,Math.min(100,Math.round(e.percent)));at.showLoadingProgress(t,e.message)}function De(e,t){le(e,t);try{toastr.error(e)}catch{}}async function $e(e){const t=++A;Se(),Pe({percent:0,message:'准备加载模型'});const o=await _t.loadModel(e,e=>{t===A&&Pe(e)});return t!==A||(Pe({percent:100,message:o?'模型加载完成':'模型加载失败'}),d=window.setTimeout(()=>{t===A&&(at.hideLoadingProgress(),d=null)},o?400:15e3)),o}function Ie(e){_e(),u=window.setTimeout(()=>{try{const t=window.parent??window,o=t.document.getElementById('desktop-pet-stage'),n=o?.getBoundingClientRect?.(),a=n?`${Math.round(n.left)},${Math.round(n.top)} ${Math.round(n.width)}x${Math.round(n.height)}`:'none',r=String(t.PIXI?.VERSION||'').trim()||'none',i=!!t.PIXI?.live2d?.Live2DModel,s=!!_t.model,l=at.getStage()?.children?.length??0,c=!!n&&n.width>10&&n.height>10&&n.bottom>0&&n.right>0&&n.top<(t.innerHeight||0)&&n.left<(t.innerWidth||0);if(c&&i&&s&&l>0)return void(u=null);if(o){const e=o.style.outline,t=o.style.background,n=o.style.zIndex;o.style.outline='2px dashed rgba(245, 158, 11, 0.95)',o.style.background='rgba(245, 158, 11, 0.08)',o.style.zIndex='2147483647',window.setTimeout(()=>{o?.ownerDocument?.documentElement?.contains(o)&&(o.style.outline=e,o.style.background=t,o.style.zIndex=n)},1e4)}const A=`桌面宠物未显示(${e}) stage=${!!o} rect=${a} visible=${c} pixi=${r} live2d=${i} model=${s} children=${l}`;try{toastr.warning(A)}catch{}}catch(e){De('桌面宠物状态检查失败',e)}finally{u=null}},2500)}async function Ue(){try{ie('桌面宠物初始化开始');const e=n.value;try{!function({getProxiedAudioUrl:e}){e&&(Et=e)}({getProxiedAudioUrl:e=>Lt._getProxiedAudioUrl(e)}),Lt.init()}catch(e){le('TTS 模块初始化失败（不影响模型显示）',e)}he(),function(){if(I)return;oe(),ce();const e=()=>{Ae()};['GENERATION_ENDED','MESSAGE_UPDATED','MESSAGE_SWIPED'].forEach(t=>{const o=te(t,e);o&&L.push(o)});const t=te('CHAT_CHANGED',()=>{oe(),ce()});t&&L.push(t),0===L.length&&(U=window.setInterval(()=>{Ae()},1200)),I=!0,ie('柏柏小手机 TTS 桥接已启用')}(),Jt.setCallback((e,t)=>{const o=Zt(e,{enabled:!!n.value.emotionCotEnabled,stripFromText:!1!==n.value.emotionCotStripFromText,configs:n.value.emotionConfigs});if(i.value=o.cleanText,l.value=t,!t)return;const a=String(o.cleanText||'').trim();if(!a)return;if(o.normalizedTag){(function(e){try{const t=_t.model;if(!t)return!1;let o=!1;const a=ne(e,n.value.emotionConfigs),r=Bt(t,e,a?.live2dExpression);r&&(_t.playExpression(r),o=!0);const i=kt(t,e,a?.live2dMotion);return i&&(_t.playMotion(i.group,i.index),o=!0),o}catch(e){return le('表情联动播放失败',e),!1}})(o.normalizedTag)||_t.playRandomAnimation()}else _t.playRandomAnimation();const r=et(),s=!!n.value.ttsAutoPlay;if(ie(`生成完成，TTS检查: enabled=${r}, autoPlay=${s}, tag=${o.normalizedTag||'(none)'}, textLen=${a.length}`),!r)return;if(!s)return;const c=R(),A=String(n.value.ttsDefaultSpeaker||'').trim();let d=String(o.context||'').trim();if(!d&&o.normalizedTag){const e=ne(o.normalizedTag,n.value.emotionConfigs);d=String(e?.ttsContext||'').trim()}ie(`自动朗读: speaker=${c}, voice=${A||'默认'}, context=${d||'无'}`),(async()=>{try{Lt.stop();const e={};A&&(e.speaker=A),d&&(e.context=d),await Lt.speak({type:'dialogue',speaker:c,text:a,tts:Object.keys(e).length>0?e:void 0},`desktop_pet_comment_${Date.now()}`)}catch(e){le('自动朗读失败',e)}})()});if(!await _t.init())return void De('Live2D SDK 初始化失败（可能是网络 CDN 不可用）');ie('Live2D SDK 初始化完成'),_t.setAutoMotionLoopEnabled(e.autoMotionLoop);const t=ke(e.petScale);t!==e.petScale&&(n.value.petScale=t);const o=Be(t);if(!at.create({width:o.width,height:o.height,position:{x:e.petPosition.x,y:e.petPosition.y},scale:t,onPositionChange:(e,t)=>{n.value.petPosition={x:e,y:t}},onScaleChange:e=>{const t=ke(e);t!==n.value.petScale&&(n.value.petScale=t)},onTap:e=>{ie('单击宠物 -> 播放动作（不触发 LLM）'),_t.playRandomAnimation()},onDoubleTap:e=>{const t=!1!==n.value.doubleTapRandomMotionEnabled;ie(t?'双击宠物 -> 触发吐槽 + 随机动作':'双击宠物 -> 触发吐槽'),zt.manualTrigger(),t&&_t.playRandomAnimation()},onLongPress:e=>{ie('长按宠物 -> 打开功能菜单'),function(e){try{navigator.vibrate&&navigator.vibrate(50)}catch{}const t=O();let o='right',n=e.clientX,a=e.clientY;try{const r=t.document.getElementById('desktop-pet-stage'),i=r?.getBoundingClientRect?.(),s=t.innerWidth||t.document.documentElement.clientWidth||0;i&&s>0?(o=i.left>s/2?'left':'right',n='left'===o?i.left-10:i.right+10,a=i.top+.5*i.height):s>0&&(o=e.clientX>s/2?'left':'right')}catch{}B.value=o,w.value={x:n,y:a},v.value=!0}(e)}}))return void De('Live2D 舞台创建失败（可能是 WebGL 不可用）');ie('Live2D 舞台创建完成');await $e(e.modelPath)?(_t.mountToStage(o.width,o.height,1),ie('Live2D 模型挂载完成')):De('Live2D 模型加载失败（可在设置里更换模型或关闭 CDN）'),zt.init({autoTrigger:e.autoTrigger,triggerInterval:e.triggerInterval,triggerProbability:e.triggerProbability,commentTriggerMode:e.commentTriggerMode},()=>{Jt.generate()}),ie('桌面宠物初始化完成'),Ie('init')}catch(e){De('桌面宠物初始化异常，请打开控制台查看错误',e)}}async function Le(e){if(await $e(e)){const e=Be(n.value.petScale);_t.mountToStage(e.width,e.height,1)}Ie('model-change')}function ze(){i.value='',l.value=!0}return(0,s.watch)(r,e=>{ie(e?'设置面板已显示':'设置面板已关闭')}),function(){try{const e=window.parent??window,t=()=>{a.openSettings(),ie('通过全局函数打开设置面板')};e[Rr]=t,c=t}catch(e){De('注册全局设置打开函数失败',e)}}(),(0,s.watch)(()=>({autoTrigger:n.value.autoTrigger,triggerInterval:n.value.triggerInterval,triggerProbability:n.value.triggerProbability,commentTriggerMode:n.value.commentTriggerMode}),e=>{zt.updateConfig(e)}),(0,s.watch)(()=>n.value.autoMotionLoop,e=>{_t.setAutoMotionLoopEnabled(e)}),(0,s.watch)(()=>n.value.gazeFollowMouseEnabled,()=>{Ne()}),(0,s.watch)(()=>n.value.petScale,e=>{const t=ke(e);if(t!==e)return void(n.value.petScale=t);const o=Be(t);at.resizeFloating(o.width,o.height),at.isPreviewMounted()||_t.updateScale(o.width,o.height,1)}),(0,s.onMounted)(()=>{!function(){const e=O();m=()=>{Ve('window-resize')};try{e.addEventListener('resize',m,{passive:!0})}catch(e){le('Failed to bind window.resize listener',e),m=null}const t=e.visualViewport;if(t){h=()=>{Ve('visual-viewport-resize')};try{t.addEventListener('resize',h,{passive:!0})}catch(e){le('Failed to bind visualViewport.resize listener',e),h=null}}}(),Ne(),Ue()}),(0,s.onUnmounted)(()=>{!function(){const e=O();if(m){try{e.removeEventListener('resize',m)}catch{}m=null}const t=e.visualViewport;if(t&&h){try{t.removeEventListener('resize',h)}catch{}h=null}}(),Me(!0),function(){try{const e=window.parent??window;c&&e[Rr]===c&&delete e[Rr]}catch{}finally{c=null}}(),fe(),ge(),A++,Se(),_e(),Ee(),at.hideLoadingProgress(),zt.destroy(),Jt.destroy();try{Lt.stop(),Mt.cleanup()}catch{}_t.destroyModel(),at.destroy()}),(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',null,[(0,s.createVNode)(io,{text:i.value,'is-done':l.value,'auto-close-delay-seconds':(0,s.unref)(n).bubbleDuration,onHidden:ze},null,8,['text','is-done','auto-close-delay-seconds']),(0,s.createVNode)(zr,{visible:(0,s.unref)(r),onClose:t[0]||(t[0]=e=>(0,s.unref)(a).closeSettings()),onModelChange:Le},null,8,['visible']),(0,s.createVNode)(fo,{visible:v.value,x:w.value.x,y:w.value.y,placement:B.value,'motion-loop-enabled':(0,s.unref)(n).autoMotionLoop,'comment-style':(0,s.unref)(n).commentStyle,onClose:t[1]||(t[1]=e=>v.value=!1),onSendChat:ve,onToggleMotionLoop:be,onSwitchModel:ye,onSwitchPersona:xe,onCloseModel:we},null,8,['visible','x','y','placement','motion-loop-enabled','comment-style']),k.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'browser-overlay',onClick:t[4]||(t[4]=(0,s.withModifiers)(e=>k.value=!1,['self']))},[(0,s.createElementVNode)('div',Wr,[(0,s.createElementVNode)('div',Fr,[t[5]||(t[5]=(0,s.createElementVNode)('h3',null,'在线模型库',-1)),(0,s.createElementVNode)('button',{class:'close-btn',onClick:t[2]||(t[2]=e=>k.value=!1)},'×')]),(0,s.createElementVNode)('div',Or,[(0,s.createVNode)(Ro,{'use-cdn':(0,s.unref)(n).useCdn,onCancel:t[3]||(t[3]=e=>k.value=!1),onLoadModel:Ce},null,8,['use-cdn'])])])])):(0,s.createCommentVNode)('v-if',!0)]))}});i(533);const qr=(0,ro.A)(jr,[['__scopeId','data-v-104a329c']]);function Yr(){$(`head > div[script_id="${getScriptId()}"]`).remove()}const Gr='20260215.04',Hr=new Set(['桌面宠物','桌面宠物设置']),Jr='桌面宠物设置',Xr='__desktopPetOpenSettings_v2',Kr=e(),Qr=eo(Kr),Zr='desktop-pet-settings-menu-container',ei='desktop-pet-settings-menu-item',ti='.desktopPetSettingsMenu';let oi=null;function ni(){try{return window.parent?.document??document}catch{return document}}function ai(e){const t=`click${ti}`;$(e).off(t,`#${ei}`),$(e).on(t,`#${ei}`,e=>{!async function(e){e.stopPropagation(),ie('设置菜单被点击，尝试打开设置面板');const t=ni(),o=$('#extensionsMenu',t),n=$('#extensionsMenuButton',t);n.length>0&&o.is(':visible')&&(n.trigger('click'),await new Promise(e=>{window.setTimeout(e,120)}));const a=window.parent??window,r=a?.[Xr];'function'==typeof r?(r(),ie('已通过全局打开函数请求打开设置面板')):(Qr.openSettings(),ie(`已通过 Pinia 请求打开设置面板 (showSettings=${String(Qr.showSettings)})`));window.setTimeout(()=>{try{const e=t.querySelector('#desktop-pet-app .settings-overlay'),o=e?.getBoundingClientRect?.(),n=o?`${Math.round(o.left)},${Math.round(o.top)} ${Math.round(o.width)}x${Math.round(o.height)}`:'none',a=e?window.getComputedStyle(e):null;ie(`设置面板 DOM 检测: overlay=${!!e} rect=${n} ${a?`position=${a.position} display=${a.display} width=${a.width} height=${a.height}`:'style=none'}`)}catch(e){se('设置面板 DOM 检测失败',e)}},0)}(e)})}function ri(){const e=ni(),t=$('#extensionsMenu',e);if(0===t.length)return void(null===oi&&(oi=window.setTimeout(()=>{oi=null,ri()},1e3)));ai(e);if($(`#${ei}`,e).length>0)return;const o=$(`<div class="extension_container interactable" id="${Zr}" tabindex="0"></div>`),n=$(`<div class="list-group-item flex-container flexGap5 interactable" id="${ei}" title="打开${Jr}"><div class="fa-fw fa-solid fa-paw extensionsMenuExtensionButton"></div><span>${Jr}</span></div>`);o.append(n),t.append(o)}function ii(){null!==oi&&(window.clearTimeout(oi),oi=null);const e=ni(),t=`click${ti}`;$(e).off(t,`#${ei}`),$(`#${Zr}`,e).remove()}function si(){try{const e=ni();$('.qr--button.menu_button.interactable',e).filter((e,t)=>Hr.has(String($(t).text()||'').trim())).remove()}catch(e){se('清理旧菜单按钮失败',e)}}$(()=>{Yr(),$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo('head');try{ie(`入口开始初始化(${Gr})`),si(),window.setTimeout(()=>{si()},1200);try{const e=ni();$('#desktop-pet-app',e).remove()}catch{}const e=$('<div id="desktop-pet-app">').appendTo('body'),t=(0,s.createApp)(qr);t.use(Kr),t.config.errorHandler=(e,t,o)=>{le(`Vue error: ${o}`,e)},t.config.warnHandler=(e,t,o)=>{se(`Vue warn: ${e}${o?`\n${o}`:''}`)},t.mount(e[0]),ri(),toastr.success(`${l}加载成功(${Gr})`),ie(`入口初始化完成(${Gr})`);let o=SillyTavern.getCurrentChatId();eventOn(tavern_events.CHAT_CHANGED,e=>{o!==e&&(o=e,zt.resetState())})}catch(e){le('入口初始化失败',e),toastr.error(`${l}初始化失败(${Gr})，请打开控制台查看报错`),$('#desktop-pet-app').remove()}}),$(window).on('pagehide',()=>{si(),ii(),Yr(),$('#desktop-pet-app').remove(),$('#desktop-pet-stage').remove()});
//# sourceMappingURL=index.js.map